<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Sistema de Gestão Financeira Familiar - Controle simplificado e eficiente">
  <title>FinSmart</title>
  
  <!-- Fontes Poppins e Montserrat via Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Scripts CDN: Chart.js 4 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <!-- Scripts CDN: Firebase v9 compat -->
  <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-auth-compat.js"></script>
  
  <style>
    /* Design-tokens em :root */
    :root {
      /* Cores base - Tema Claro */
      --color-background: #F8FAFC;
      --color-surface: #FFFFFF;
      --color-surface-variant: #F1F5F9;
      --color-on-surface: #0F172A;
      --color-on-surface-variant: #64748B;
      --color-outline: #E2E8F0;
      
      /* Cores primárias */
      --color-primary: #2563EB; /* Azul */
      --color-primary-light: #60A5FA;
      --color-primary-dark: #1E40AF;
      --color-on-primary: #FFFFFF;
      
      /* Cores secundárias */
      --color-secondary: #10B981; /* Verde */
      --color-secondary-light: #34D399;
      --color-secondary-dark: #059669;
      --color-on-secondary: #FFFFFF;
      
      /* Cores terciárias */
      --color-tertiary: #8B5CF6; /* Violeta */
      --color-tertiary-light: #A78BFA;
      --color-tertiary-dark: #7C3AED;
      --color-on-tertiary: #FFFFFF;
      
      /* Cores semânticas */
      --color-success: #22C55E;
      --color-success-light: #4ADE80;
      --color-on-success: #FFFFFF;
      
      --color-warning: #F59E0B;
      --color-warning-light: #FBBF24;
      --color-on-warning: #1E293B;
      
      --color-error: #EF4444;
      --color-error-light: #F87171;
      --color-on-error: #FFFFFF;
      
      --color-info: #3B82F6;
      --color-info-light: #60A5FA;
      --color-on-info: #FFFFFF;
      
      /* Cores para receitas e despesas */
      --color-income: #22C55E;
      --color-income-light: #86EFAC;
      --color-income-ultra-light: rgba(34, 197, 94, 0.1);
      --color-income-transparent: rgba(34, 197, 94, 0.7);
      
      --color-expense: #EF4444;
      --color-expense-light: #FCA5A5;
      --color-expense-ultra-light: rgba(239, 68, 68, 0.1);
      --color-expense-transparent: rgba(239, 68, 68, 0.7);
      
      /* Cores de cartões */
      --color-card-invoice: #8B5CF6;
      --color-card-invoice-light: rgba(139, 92, 246, 0.2);
      
      /* Visualização de Dados - Paleta 10 cores */
      --chart-color-1: #2563EB;
      --chart-color-2: #10B981;
      --chart-color-3: #F59E0B;
      --chart-color-4: #8B5CF6;
      --chart-color-5: #EC4899;
      --chart-color-6: #0EA5E9;
      --chart-color-7: #F97316;
      --chart-color-8: #14B8A6;
      --chart-color-9: #6366F1;
      --chart-color-10: #DC2626;
      
      /* Tipografia */
      --font-family: 'Poppins', sans-serif;
      --font-family-numbers: 'Montserrat', sans-serif;
      --font-size-xs: 0.75rem;   /* 12px */
      --font-size-sm: 0.875rem;  /* 14px */
      --font-size-md: 1rem;      /* 16px */
      --font-size-lg: 1.125rem;  /* 18px */
      --font-size-xl: 1.25rem;   /* 20px */
      --font-size-2xl: 1.5rem;   /* 24px */
      --font-size-3xl: 1.875rem; /* 30px */
      --font-size-4xl: 2.25rem;  /* 36px */
      
      --font-weight-light: 300;
      --font-weight-regular: 400;
      --font-weight-medium: 500;
      --font-weight-semibold: 600;
      --font-weight-bold: 700;
      
      /* Espaçamento */
      --spacing-xs: 0.25rem;  /* 4px */
      --spacing-sm: 0.5rem;   /* 8px */
      --spacing-md: 1rem;     /* 16px */
      --spacing-lg: 1.5rem;   /* 24px */
      --spacing-xl: 2rem;     /* 32px */
      --spacing-2xl: 2.5rem;  /* 40px */
      --spacing-3xl: 3rem;    /* 48px */
      
      /* Bordas e raios */
      --radius-sm: 0.25rem;   /* 4px */
      --radius-md: 0.5rem;    /* 8px */
      --radius-lg: 0.75rem;   /* 12px */
      --radius-xl: 1rem;      /* 16px */
      --radius-2xl: 1.5rem;   /* 24px */
      --radius-full: 9999px;
      
      /* Sombras */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      
      /* Transições */
      --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-normal: 250ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 400ms cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Tema escuro */
    [data-theme="dark"] {
      --color-background: #0F172A;
      --color-surface: #1E293B;
      --color-surface-variant: #334155;
      --color-on-surface: #F8FAFC;
      --color-on-surface-variant: #94A3B8;
      --color-outline: #475569;
      
      /* Ajustes de cores para modo escuro */
      --color-primary: #3B82F6;
      --color-primary-light: #60A5FA;
      --color-primary-dark: #2563EB;
      
      --color-secondary: #34D399;
      --color-secondary-light: #6EE7B7;
      --color-secondary-dark: #10B981;
      
      --color-tertiary: #A78BFA;
      --color-tertiary-light: #C4B5FD;
      --color-tertiary-dark: #8B5CF6;
      
      /* Sombras para modo escuro */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.2);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.15);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.15);
    }
    
    /* Reset básico */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html, body {
      height: 100%;
      font-family: var(--font-family);
      background-color: var(--color-background);
      color: var(--color-on-surface);
      font-size: var(--font-size-md);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      transition: background-color var(--transition-normal), color var(--transition-normal);
    }
    
    img, picture, video, canvas, svg {
      display: block;
      max-width: 100%;
    }
    
    input, button, textarea, select {
      font: inherit;
      color: inherit;
      border: 1px solid var(--color-outline);
      background-color: var(--color-surface);
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-md);
      transition: all var(--transition-fast);
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px var(--color-primary-light);
    }
    
    input[type="date"] {
      padding-right: var(--spacing-md);
    }
    
    [data-theme="light"] input[type="date"] {
      color-scheme: light;
    }
    
    [data-theme="dark"] input[type="date"] {
      color-scheme: dark;
    }
    
    input[disabled] {
      background-color: var(--color-surface-variant);
      cursor: not-allowed;
      opacity: 0.7;
    }
    
    button {
      cursor: pointer;
      border: 1px solid transparent;
      transition: all var(--transition-fast);
      position: relative;
      overflow: hidden;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    
    button::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 5px;
      height: 5px;
      background: rgba(255, 255, 255, 0.5);
      opacity: 0;
      border-radius: 100%;
      transform: scale(1, 1) translate(-50%, -50%);
      transform-origin: 50% 50%;
    }
    
    button:active::after {
      animation: ripple 0.5s ease-out;
    }
    
    @keyframes ripple {
      0% {
        transform: scale(0, 0);
        opacity: 0.7;
      }
      100% {
        transform: scale(300, 300);
        opacity: 0;
      }
    }
    
    a {
      color: var(--color-primary);
      text-decoration: none;
      transition: color var(--transition-fast);
    }
    
    a:hover {
      color: var(--color-primary-dark);
      text-decoration: none;
    }
    
    table {
      border-collapse: collapse;
      width: 100%;
    }

    /* Layout principal */
    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: var(--spacing-md);
    }
  
    /* Header */
    .header {
      display: flex;
      flex-wrap: wrap; 
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-md) 0;
      margin-bottom: var(--spacing-lg);
      border-bottom: 1px solid var(--color-outline);
      position: sticky;
      top: 0;
      background-color: var(--color-background);
      backdrop-filter: blur(10px);
      z-index: 100;
      box-shadow: var(--shadow-sm);
    }
    
    .header-filters, .header-actions {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
      align-items: center;
    }
    
    .app-title {
      font-size: var(--font-size-2xl);
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--spacing-md);
      font-family: var(--font-family);
      color: var(--color-primary);
      letter-spacing: -0.025em;
    }
    
    .hero {
      padding: var(--spacing-xl) 0;
      margin-bottom: var(--spacing-lg);
      position: relative;
      overflow: hidden;
      border-radius: var(--radius-xl);
      background-color: var(--color-surface);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--color-outline);
      padding: var(--spacing-xl);
    }
    
    .hero::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, 
        rgba(37, 99, 235, 0.05) 0%, 
        rgba(255, 255, 255, 0) 50%),
        linear-gradient(45deg, 
        rgba(16, 185, 129, 0.05) 0%, 
        rgba(255, 255, 255, 0) 50%);
      z-index: -1;
    }
    
    .hero-title {
      font-size: var(--font-size-3xl);
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--spacing-sm);
      background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      font-family: var(--font-family);
      letter-spacing: -0.025em;
    }
    
    .hero-subtitle {
      font-size: var(--font-size-lg);
      color: var(--color-on-surface-variant);
      margin-bottom: var(--spacing-md);
      max-width: 700px;
    }
    
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-xl);
    }
    
    .kpi-card {
      background-color: var(--color-surface);
      padding: var(--spacing-lg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-outline);
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow-md);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
      display: flex;
      flex-direction: column;
    }
    
    .kpi-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }
    
    .kpi-title {
      font-size: var(--font-size-sm);
      color: var(--color-on-surface-variant);
      margin-bottom: var(--spacing-xs);
      font-weight: var(--font-weight-medium);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .kpi-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-medium);
      background-color: var(--color-surface-variant);
    }
    
    .kpi-badge-up {
      background-color: rgba(34, 197, 94, 0.15);
      color: var(--color-success);
    }
    
    .kpi-badge-down {
      background-color: rgba(239, 68, 68, 0.15);
      color: var(--color-error);
    }
    
    .kpi-value {
      font-size: var(--font-size-2xl);
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--spacing-xs);
      font-family: var(--font-family-numbers);
      letter-spacing: -0.025em;
    }
    
    .kpi-subtitle {
      font-size: var(--font-size-xs);
      color: var(--color-on-surface-variant);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }
    
    .kpi-progress {
      margin-top: var(--spacing-sm);
      width: 100%;
      background-color: var(--color-surface-variant);
      height: 4px;
      border-radius: var(--radius-full);
      overflow: hidden;
    }
    
    .kpi-progress-bar {
      height: 100%;
      border-radius: var(--radius-full);
    }
    
    .kpi-income { 
      border-left: 4px solid var(--color-income);
    }
    
    .kpi-income .kpi-progress-bar {
      background-color: var(--color-income);
    }
    
    .kpi-expense { 
      border-left: 4px solid var(--color-expense);
    }
    
    .kpi-expense .kpi-progress-bar {
      background-color: var(--color-expense);
    }
    
    .kpi-balance { 
      border-left: 4px solid var(--color-primary);
    }
    
    .kpi-balance .kpi-progress-bar {
      background-color: var(--color-primary);
    }
    
    .kpi-card-invoice { 
      border-left: 4px solid var(--color-card-invoice);
    }
    
    .kpi-card-invoice .kpi-progress-bar {
      background-color: var(--color-card-invoice);
    }
    
    .insights-banner-container {
      margin-bottom: var(--spacing-xl);
    }
    
    .insight-banner {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-md) var(--spacing-lg);
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-md);
      background-color: var(--color-surface);
      box-shadow: var(--shadow-md);
      position: relative;
      overflow: hidden;
      border: 1px solid var(--color-outline);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    }
    
    .insight-banner:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .insight-icon { 
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      border-radius: var(--radius-lg);
      background-color: var(--color-surface-variant);
      color: var(--color-on-surface-variant);
      flex-shrink: 0;
    }
    
    .insight-content { 
      flex: 1; 
    }
    
    .insight-title { 
      font-weight: var(--font-weight-medium);
      margin-bottom: var(--spacing-xs);
      position: relative;
      z-index: 2;
    }
    
    .insight-danger { 
      border-left: 4px solid var(--color-error);
    }
    
    .insight-danger .insight-icon {
      color: var(--color-on-error);
      background-color: var(--color-error);
    }
    
    .insight-warning { 
      border-left: 4px solid var(--color-warning);
    }
    
    .insight-warning .insight-icon {
      color: var(--color-on-warning);
      background-color: var(--color-warning);
    }
    
    .insight-info { 
      border-left: 4px solid var(--color-info);
    }
    
    .insight-info .insight-icon {
      color: var(--color-on-info);
      background-color: var(--color-info);
    }
    
    .insight-success { 
      border-left: 4px solid var(--color-success);
    }
    
    .insight-success .insight-icon {
      color: var(--color-on-success);
      background-color: var(--color-success);
    }
    
    .charts-container { 
      margin-bottom: var(--spacing-xl);
    }
    
    .charts-title { 
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-semibold);
      margin-bottom: var(--spacing-md);
      position: relative;
      color: var(--color-on-surface);
      padding-bottom: var(--spacing-xs);
      border-bottom: 2px solid var(--color-outline);
    }
    
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
    }
    
    .chart-container {
      height: 400px; 
      border-radius: var(--radius-lg); 
      background-color: var(--color-surface);
      padding: var(--spacing-lg);
      border: 1px solid var(--color-outline);
      display: flex; 
      flex-direction: column;
      box-shadow: var(--shadow-md);
      position: relative;
      overflow: hidden;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    }
    
    .chart-container:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }
    
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
    }
    
    .chart-title {
      font-weight: var(--font-weight-semibold);
      font-size: var(--font-size-lg);
      color: var(--color-on-surface);
      margin: 0;
    }
    
    .chart-actions {
      display: flex;
      gap: var(--spacing-xs);
    }
    
    .chart-filter-button {
      padding: var(--spacing-xs) var(--spacing-sm);
      background-color: var(--color-surface-variant);
      border: 1px solid var(--color-outline);
      border-radius: var(--radius-md);
      font-size: var(--font-size-xs);
      color: var(--color-on-surface-variant);
      font-weight: var(--font-weight-medium);
    }
    
    .chart-filter-button.active {
      background-color: var(--color-primary);
      color: var(--color-on-primary);
      border-color: var(--color-primary);
    }
    
    .chart-wrapper {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex: 1;
    }
    
    .chart-tooltip {
      position: fixed;
      opacity: 0;
      visibility: hidden;
      background: rgba(30, 41, 59, 0.95);
      color: #ffffff;
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      font-size: var(--font-size-sm);
      pointer-events: none;
      z-index: 9999;
      box-shadow: var(--shadow-lg);
      max-width: 280px;
      backdrop-filter: blur(8px);
      border: 1px solid rgba(99, 102, 241, 0.3);
      transition: opacity 0.2s, transform 0.2s;
      transform: translateY(10px);
    }
    
    [data-theme="light"] .chart-tooltip {
      background: rgba(255, 255, 255, 0.95);
      color: var(--color-on-surface);
      border: 1px solid rgba(99, 102, 241, 0.3);
      box-shadow: var(--shadow-lg);
    }
    
    .chart-tooltip.visible {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    
    .chart-tooltip-title {
      font-weight: var(--font-weight-semibold);
      margin-bottom: var(--spacing-xs);
      font-size: var(--font-size-md);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding-bottom: var(--spacing-xs);
    }
    
    [data-theme="light"] .chart-tooltip-title {
      border-bottom: 1px solid rgba(15, 23, 42, 0.1);
    }
    
    .chart-tooltip-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--spacing-xs);
    }
    
    .chart-tooltip-color {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 2px;
      margin-right: var(--spacing-xs);
    }
    
    .chart-tooltip-label {
      display: flex;
      align-items: center;
      font-weight: var(--font-weight-medium);
    }
    
    .chart-tooltip-value {
      font-weight: var(--font-weight-semibold);
      font-family: var(--font-family-numbers);
    }
    
    .chart-tooltip-percent {
      font-size: var(--font-size-xs);
      color: var(--color-on-surface-variant);
      margin-top: var(--spacing-xs);
      text-align: right;
    }
    
    .chart-tooltip-percent.positive {
      color: var(--color-success);
    }
    
    .chart-tooltip-percent.negative {
      color: var(--color-error);
    }
    
    .annual-chart-container {
      position: relative;
      grid-column: 1 / -1;
    }
    
    .chart-legend {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: var(--spacing-md);
      margin-top: var(--spacing-sm);
    }
    
    .chart-legend-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      font-size: var(--font-size-sm);
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-md);
      background-color: var(--color-surface-variant);
      cursor: pointer;
      transition: opacity var(--transition-fast), transform var(--transition-fast);
    }
    
    .chart-legend-item:hover {
      transform: translateY(-2px);
    }
    
    .chart-legend-item.inactive {
      opacity: 0.5;
    }
    
    .chart-legend-color {
      width: 12px;
      height: 12px;
      border-radius: 2px;
      background-color: var(--color-primary);
    }
    
    .limit-container {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      z-index: 2;
    }
    
    .limit-display {
      text-align: center;
      border-radius: 50%;
      width: 120px;
      height: 120px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(4px);
      border: 2px solid var(--color-primary);
      box-shadow: var(--shadow-lg), 
                  inset 0 0 20px rgba(59, 130, 246, 0.2);
    }
    
    [data-theme="dark"] .limit-display {
      background: rgba(30, 41, 59, 0.9);
      border: 2px solid var(--color-primary);
      box-shadow: var(--shadow-lg), 
                  inset 0 0 20px rgba(59, 130, 246, 0.2);
    }
    
    .limit-value {
      font-size: 32px;
      font-weight: var(--font-weight-bold);
      color: var(--color-on-surface);
      line-height: 1;
      margin-bottom: 4px;
      font-family: var(--font-family-numbers);
    }
    
    .limit-label {
      font-size: 14px;
      color: var(--color-on-surface-variant);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .commitments {
      margin-bottom: var(--spacing-xl);
      background-color: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      border: 1px solid var(--color-outline);
      box-shadow: var(--shadow-md);
      position: relative;
      overflow: hidden;
    }
    
    .commitments-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
      cursor: pointer;
      padding: var(--spacing-sm);
      border-radius: var(--radius-md);
      position: relative;
      z-index: 1;
    }
    
    .commitments-header:hover { 
      background-color: var(--color-surface-variant);
    }
    
    .commitments-header h3 { 
      font-weight: var(--font-weight-semibold);
      font-size: var(--font-size-lg); 
      color: var(--color-on-surface);
      margin: 0;
    }
    
    .commitments-content { 
      overflow: hidden;
      transition: max-height var(--transition-normal);
      max-height: 0;
      position: relative;
      z-index: 1;
    }
    
    .commitment-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-sm);
      background-color: var(--color-surface-variant);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
      position: relative;
      overflow: hidden;
      border: 1px solid var(--color-outline);
    }
    
    .commitment-item:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .commitment-progress { 
      width: 100%;
      height: 8px;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: var(--radius-full);
      overflow: hidden;
      position: relative;
      margin-top: var(--spacing-xs);
    }
    
    [data-theme="light"] .commitment-progress {
      background-color: rgba(0, 0, 0, 0.05);
    }
    
    .commitment-progress-bar { 
      height: 100%;
      border-radius: var(--radius-full);
      position: relative;
    }
    
    .commitment-progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, 
                  rgba(255, 255, 255, 0.1), 
                  rgba(255, 255, 255, 0.3), 
                  rgba(255, 255, 255, 0.1));
      animation: shimmer 2s infinite linear;
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    .transactions-container { 
      margin-bottom: var(--spacing-xl); 
    }
    
    .card-transacoes {
      background-color: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      border: 1px solid var(--color-outline);
      box-shadow: var(--shadow-md);
      position: relative;
      overflow: hidden;
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
      position: relative;
      z-index: 1;
    }
    
    .card-title { 
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-semibold);
      margin: 0;
      color: var(--color-on-surface);
      position: relative;
      padding-bottom: var(--spacing-xs);
      border-bottom: 2px solid var(--color-primary);
    }
    
    .filters { 
      display: flex;
      gap: var(--spacing-sm);
      flex-wrap: wrap;
      position: relative;
      z-index: 1;
    }
    
    .transactions-table-container {
      overflow-x: auto; 
      border: 1px solid var(--color-outline);
      border-radius: var(--radius-lg);
      background-color: var(--color-surface);
      position: relative;
      z-index: 1;
    }
    
    .transactions-table { width: 100%; }
    
    .transactions-table th, .transactions-table td {
      padding: var(--spacing-md);
      text-align: left; 
      border-bottom: 1px solid var(--color-outline);
      white-space: nowrap;
    }
    
    .transactions-table th {
      font-weight: var(--font-weight-medium);
      color: var(--color-on-surface-variant);
      background-color: var(--color-surface-variant);
      cursor: pointer;
      text-align: center;
      text-transform: uppercase;
      font-size: var(--font-size-xs);
      letter-spacing: 0.05em;
      position: relative;
    }
    
    .transactions-table th.sortable {
      position: relative;
      padding-right: calc(var(--spacing-md) + 16px);
    }
    
    .transactions-table th.sortable::after {
      content: '';
      position: absolute;
      right: var(--spacing-sm);
      top: 50%;
      transform: translateY(-50%);
      width: 0; 
      height: 0; 
      border-left: 4px solid transparent;
      border-right: 4px solid transparent;
      border-bottom: 4px solid var(--color-on-surface-variant);
      opacity: 0.3;
    }
    
    .transactions-table th.sortable.sorted-asc::after {
      opacity: 1;
    }
    
    .transactions-table th.sortable.sorted-desc::after {
      transform: translateY(-50%) rotate(180deg);
      opacity: 1;
    }
    
    .transactions-table th.sortable:hover { 
      background-color: rgba(37, 99, 235, 0.1);
    }
    
    .transactions-table tr:hover { 
      background-color: rgba(16, 185, 129, 0.05);
    }
    
    .transactions-table td .transaction-name-cell { 
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      white-space: normal; 
      word-break: break-word;
    }
    
    .transaction-icon {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      width: 40px;
      height: 40px;
      border-radius: var(--radius-md);
      background-color: var(--color-surface-variant);
      font-size: 1.2rem; 
      flex-shrink: 0;
      box-shadow: var(--shadow-sm);
    }
    
    .actions-cell { 
      display: flex;
      gap: var(--spacing-xs);
      justify-content: flex-end;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-xs);
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-md); 
      font-weight: var(--font-weight-medium);
      white-space: nowrap;
      min-height: 40px;
      border: 1px solid transparent;
      position: relative;
      overflow: hidden;
      z-index: 1;
      box-shadow: var(--shadow-sm);
      transition: all var(--transition-fast);
    }
    
    .btn:focus {
      outline: none;
      box-shadow: 0 0 0 3px var(--color-primary-light);
    }
    
    .btn:hover { 
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .btn:active {
      transform: translateY(0);
      box-shadow: var(--shadow-sm);
    }
    
    .header-actions .btn {
      min-width: 120px;
    }
    
    .header-actions .btn.btn-icon { 
      min-width: auto;
      width: 40px;
      padding: 0;
    }

    .btn-primary { 
      background-color: var(--color-primary);
      color: var(--color-on-primary);
      border-color: var(--color-primary);
    }
    
    .btn-primary:hover {
      background-color: var(--color-primary-dark);
      border-color: var(--color-primary-dark);
    }
    
    .btn-success { 
      background-color: var(--color-success);
      color: var(--color-on-success);
      border-color: var(--color-success);
    }
    
    .btn-success:hover {
      background-color: var(--color-success-light);
      border-color: var(--color-success-light);
    }
    
    .btn-danger { 
      background-color: var(--color-error);
      color: var(--color-on-error);
      border-color: var(--color-error);
    }
    
    .btn-danger:hover {
      background-color: var(--color-error-light);
      border-color: var(--color-error-light);
    }
    
    .btn-outline {
      border: 1px solid var(--color-outline);
      background-color: transparent;
      color: var(--color-on-surface);
    }
    
    .btn-outline:hover { 
      background-color: var(--color-surface-variant);
      border-color: var(--color-primary);
      color: var(--color-primary);
    }
    
    .btn-icon { 
      width: 40px;
      height: 40px;
      padding: 0;
      border-radius: var(--radius-md);
      flex-shrink: 0;
    }
    
    .btn-sm {
      min-height: 32px;
      padding: var(--spacing-xs) var(--spacing-sm);
      font-size: var(--font-size-sm);
    }
    
    .select-wrapper { 
      position: relative;
      display: inline-block;
    }
    
    .select {
      appearance: none;
      -webkit-appearance: none;
      padding-right: var(--spacing-xl); 
      cursor: pointer;
      background-color: var(--color-surface); 
      border: 1px solid var(--color-outline);
      width: 100%; 
      min-width: 150px; 
      border-radius: var(--radius-md);
      transition: all var(--transition-fast);
      box-shadow: var(--shadow-sm);
    }
    
    .select:hover {
      box-shadow: var(--shadow-md);
      border-color: var(--color-primary-light);
    }
    
    .select:focus {
      box-shadow: 0 0 0 3px var(--color-primary-light);
      border-color: var(--color-primary);
    }
    
    .select-icon {
      position: absolute;
      right: var(--spacing-sm);
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      color: var(--color-on-surface-variant);
    }
    
    .card {
      background-color: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      border: 1px solid var(--color-outline);
      box-shadow: var(--shadow-md);
      position: relative;
      overflow: hidden;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-full);
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-medium);
      line-height: 1;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .badge-success { 
      background-color: rgba(34, 197, 94, 0.1);
      color: var(--color-success);
      border: 1px solid rgba(34, 197, 94, 0.2);
    }
    
    .badge-warning { 
      background-color: rgba(245, 158, 11, 0.1);
      color: var(--color-warning);
      border: 1px solid rgba(245, 158, 11, 0.2);
    }
    
    .badge-danger { 
      background-color: rgba(239, 68, 68, 0.1);
      color: var(--color-error);
      border: 1px solid rgba(239, 68, 68, 0.2);
    }
    
    .badge-info { 
      background-color: rgba(59, 130, 246, 0.1);
      color: var(--color-info); 
      border: 1px solid rgba(59, 130, 246, 0.2);
    }
    
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      display: none; 
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: opacity var(--transition-normal);
    }
    
    .modal-backdrop.active { 
      display: flex;
      opacity: 1;
      animation: fadeIn 0.3s forwards;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal {
      width: 90%;
      max-width: 500px;
      background-color: var(--color-surface);
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-outline);
      display: flex;
      flex-direction: column;
      max-height: 90vh;
      box-shadow: var(--shadow-xl);
      position: relative;
      overflow: hidden;
      animation: modalSlideIn 0.3s forwards;
    }
    
    @keyframes modalSlideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-md) var(--spacing-lg);
      border-bottom: 1px solid var(--color-outline);
      position: relative;
      z-index: 1;
    }
    
    .modal-title { 
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-semibold);
      color: var(--color-primary);
      margin: 0;
    }
    
    .modal-close {
      font-size: var(--font-size-xl);
      color: var(--color-on-surface-variant);
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-md);
      transition: all var(--transition-fast);
      box-shadow: none;
    }
    
    .modal-close:hover { 
      background-color: var(--color-surface-variant);
      color: var(--color-on-surface);
    }
    
    .modal-body { 
      padding: var(--spacing-lg);
      overflow-y: auto;
      position: relative;
      z-index: 1;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: var(--spacing-sm);
      padding: var(--spacing-md) var(--spacing-lg);
      border-top: 1px solid var(--color-outline);
      background-color: var(--color-surface); 
      position: relative;
      z-index: 1;
    }
    
    .toast-container {
      position: fixed;
      top: var(--spacing-lg);
      right: var(--spacing-lg);
      z-index: 2000;
      width: auto;
      max-width: 350px;
    }
    
    .toast {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      background-color: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: var(--spacing-md) var(--spacing-lg);
      margin-bottom: var(--spacing-sm);
      border: 1px solid var(--color-outline);
      box-shadow: var(--shadow-lg); 
      opacity: 0;
      transform: translateX(100%);
      transition: opacity var(--transition-normal), transform var(--transition-normal);
      position: relative;
      overflow: hidden;
    }
    
    .toast::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 4px;
      background: var(--color-primary);
    }
    
    .toast.show { 
      opacity: 1;
      transform: translateX(0);
    }
    
    .toast-icon { 
      font-size: 1.5rem;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-md);
      flex-shrink: 0;
    }
    
    .toast-content { flex: 1; }
    
    .toast-close { 
      font-size: var(--font-size-lg);
      color: var(--color-on-surface-variant);
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
      transition: color var(--transition-fast);
      margin-left: var(--spacing-sm);
    }
    
    .toast-close:hover {
      color: var(--color-on-surface);
    }
    
    .toast-success::before { background: var(--color-success); }
    .toast-success .toast-icon { color: var(--color-on-success); background-color: var(--color-success); }
    
    .toast-error::before { background: var(--color-error); }
    .toast-error .toast-icon { color: var(--color-on-error); background-color: var(--color-error); }
    
    .toast-warning::before { background: var(--color-warning); }
    .toast-warning .toast-icon { color: var(--color-on-warning); background-color: var(--color-warning); }
    
    .toast-info::before { background: var(--color-info); }
    .toast-info .toast-icon { color: var(--color-on-info); background-color: var(--color-info); }
    
    .form-group { 
      margin-bottom: var(--spacing-md);
      position: relative;
    }
    
    .form-label {
      display: block;
      font-size: var(--font-size-sm);
      color: var(--color-on-surface-variant);
      margin-bottom: var(--spacing-xs);
      font-weight: var(--font-weight-medium);
    }
    
    .form-control { 
      width: 100%;
      background-color: var(--color-surface);
      transition: all var(--transition-fast);
      border: 1px solid var(--color-outline);
      box-shadow: var(--shadow-sm);
    }
    
    .form-control:hover {
      box-shadow: var(--shadow-md);
      border-color: var(--color-primary-light);
    }
    
    .form-control:focus {
      box-shadow: 0 0 0 3px var(--color-primary-light);
      border-color: var(--color-primary);
    }
    
    .radio-group, .checkbox-group {
      display: flex;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-md);
      flex-wrap: wrap;
    }
    
    .radio-wrapper, .checkbox-wrapper { 
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      position: relative;
    }
    
    .radio, .checkbox { 
      width: 18px;
      height: 18px;
      accent-color: var(--color-primary);
      cursor: pointer;
    }
    
    .radio-label, .checkbox-label { 
      cursor: pointer;
      font-weight: normal;
      color: var(--color-on-surface);
    }
    
    .theme-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px; 
      height: 40px; 
      border-radius: var(--radius-md);
      cursor: pointer;
      background-color: var(--color-surface);
      border: 1px solid var(--color-outline);
      transition: all var(--transition-fast);
      box-shadow: var(--shadow-sm);
    }
    
    .theme-toggle:hover { 
      background-color: var(--color-surface-variant);
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }
    
    .theme-toggle:active {
      transform: translateY(0);
      box-shadow: var(--shadow-sm);
    }
    
    .theme-toggle .icon-sun, .theme-toggle .icon-moon { 
      width: 24px; 
      height: 24px; 
      color: var(--color-on-surface);
      transition: transform var(--transition-normal);
    }
    
    [data-theme="light"] .theme-toggle .icon-moon { display: none; }
    [data-theme="dark"] .theme-toggle .icon-sun { display: none; }
    
    .investment-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: var(--spacing-lg);
      margin-bottom: var(--spacing-xl);
    }
    
    .investment-card { 
      display: flex;
      flex-direction: column;
      background-color: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: var(--spacing-lg);
      border: 1px solid var(--color-outline);
      box-shadow: var(--shadow-md);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
      position: relative;
      overflow: hidden;
    }
    
    .investment-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
    }
    
    .investment-card-header { 
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--spacing-md);
      position: relative;
      z-index: 1;
    }
    
    .investment-card-title { 
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-semibold);
      margin: 0;
      color: var(--color-primary);
    }
    
    .investment-card-body { 
      flex: 1;
      margin-bottom: var(--spacing-md);
      position: relative;
      z-index: 1;
    }
    
    .investment-card-footer { 
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: auto;
      position: relative;
      z-index: 1;
    }
    
    .investment-progress { margin-top: var(--spacing-md); }
    
    .investment-progress-bar { 
      height: 8px;
      background-color: var(--color-surface-variant);
      border-radius: var(--radius-full);
      overflow: hidden;
      margin-bottom: var(--spacing-xs);
    }
    
    .investment-progress-fill { 
      height: 100%;
      background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
      border-radius: var(--radius-full);
      position: relative;
      overflow: hidden;
    }
    
    .investment-progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, 
                  rgba(255, 255, 255, 0.1), 
                  rgba(255, 255, 255, 0.3), 
                  rgba(255, 255, 255, 0.1));
      animation: progressShimmer 2s infinite linear;
    }
    
    @keyframes progressShimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    .investment-progress-text { 
      display: flex;
      justify-content: space-between;
      font-size: var(--font-size-sm);
      color: var(--color-on-surface-variant);
    }
    
    .investment-detail-header {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }
    
    .investment-detail-stat { 
      background-color: var(--color-surface-variant);
      border-radius: var(--radius-lg);
      padding: var(--spacing-md);
      border: 1px solid var(--color-outline);
      position: relative;
      overflow: hidden;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    }
    
    .investment-detail-stat:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .investment-detail-title { 
      font-size: var(--font-size-sm);
      color: var(--color-on-surface-variant);
      margin-bottom: var(--spacing-xs);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      position: relative;
      z-index: 1;
    }
    
    .investment-detail-value { 
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-semibold);
      font-family: var(--font-family-numbers);
      position: relative;
      z-index: 1;
      color: var(--color-on-surface);
    }
    
    .investment-history-table th, .investment-history-table td { 
      padding: var(--spacing-md);
      border-bottom: 1px solid var(--color-outline);
    }
    
    .investment-history-table th { 
      background-color: var(--color-surface-variant);
      font-weight: var(--font-weight-medium);
      text-transform: uppercase;
      font-size: var(--font-size-xs);
      letter-spacing: 0.05em;
      color: var(--color-on-surface-variant);
    }

    .categories-container { padding: var(--spacing-lg); }
    
    .nav-tabs {
      display: flex;
      list-style: none;
      padding: 0;
      margin: 0 0 var(--spacing-lg) 0;
      border-bottom: 1px solid var(--color-outline);
      flex-wrap: wrap;
      gap: var(--spacing-xs);
    }
    
    .nav-item { margin-bottom: -1px; }
    
    .nav-link {
      display: inline-block;
      padding: var(--spacing-sm) var(--spacing-md);
      border: 1px solid transparent;
      border-bottom: 2px solid transparent;
      font-weight: var(--font-weight-medium);
      color: var(--color-on-surface-variant);
      border-radius: var(--radius-md) var(--radius-md) 0 0;
      transition: all var(--transition-fast);
      position: relative;
      overflow: hidden;
    }
    
    .nav-link::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      width: 0;
      height: 2px;
      background: var(--color-primary);
      transition: width var(--transition-normal), left var(--transition-normal);
    }
    
    .nav-link:hover { 
      color: var(--color-primary);
      background-color: rgba(59, 130, 246, 0.05);
    }
    
    .nav-link:hover::before {
      width: 100%;
      left: 0;
    }
    
    .nav-link.active {
      color: var(--color-primary);
      background-color: rgba(59, 130, 246, 0.05);
      border-color: var(--color-outline);
      border-bottom-color: var(--color-primary);
    }
    
    .nav-link.active::before {
      width: 100%;
      left: 0;
    }
    
    .tab-content { padding: var(--spacing-md) 0; }
    
    .tab-pane { display: none; }
    
    .tab-pane.active.show { 
      display: block;
      animation: fadeIn var(--transition-normal);
    }
    
    .category-list { margin-bottom: var(--spacing-lg); }
    
    .category-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-md);
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-sm);
      border: 1px solid var(--color-outline);
      background-color: var(--color-surface);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
      position: relative;
      overflow: hidden;
    }
    
    .category-item:hover { 
      background-color: var(--color-surface-variant);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .category-item-content { 
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      position: relative;
      z-index: 1;
    }
    
    .category-item-icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-md);
      background-color: var(--color-primary);
      box-shadow: var(--shadow-sm);
      font-size: 1.2rem;
      color: var(--color-on-primary);
    }
    
    .category-item-actions { 
      display: flex;
      gap: var(--spacing-xs);
      position: relative;
      z-index: 1;
    }
    
    .add-category-form {
      display: flex;
      align-items: flex-end;
      gap: var(--spacing-sm);
      flex-wrap: wrap;
      background-color: var(--color-surface-variant);
      padding: var(--spacing-lg);
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-outline);
      margin-top: var(--spacing-lg);
      position: relative;
      overflow: hidden;
    }
    
    .add-category-form .form-control {
      flex-grow: 1;
      position: relative;
      z-index: 1;
    }
    
    .add-category-form .btn {
      flex-shrink: 0;
      position: relative;
      z-index: 1;
    }

    .custom-icon-input { 
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
      position: relative;
      z-index: 1;
    }
    
    .custom-icon-preview {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: var(--color-primary);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
      font-size: 1.2rem;
      color: var(--color-on-primary);
      position: relative;
      overflow: hidden;
    }
    
    @media (max-width: 768px) {
      .header { flex-direction: column; align-items: stretch; }
      .header-filters { width: 100%; justify-content: center; margin-bottom: var(--spacing-md); }
      .header-actions { width: 100%; justify-content: center; }
      .hero-title { font-size: var(--font-size-2xl); }
      .charts-grid { grid-template-columns: 1fr; } 
      .add-category-form { flex-direction: column; align-items: stretch; }
      .add-category-form .form-control, .add-category-form .btn { width: 100%; }
    }
    
    @media (max-width: 576px) {
      .kpi-grid { grid-template-columns: 1fr; }
      .header-filters { flex-direction: column; align-items: stretch; }
      .header-filters .select-wrapper { width: 100%; }
      .header-actions { 
        flex-direction: row; 
        flex-wrap: wrap; 
        justify-content: center; 
        gap: var(--spacing-sm);
      }
      .header-actions .btn { 
        flex-grow: 1; 
        min-width: calc(50% - var(--spacing-sm)); 
      }
      .modal { width: 95%; }
      .filters .select-wrapper { width: 100%; } 
    }
  </style>
</head>
<body>
  <!-- SVG Sprite de ícones (Heroicons) -->
  <svg style="display: none;">
    <!-- Ícones de navegação -->
    <symbol id="icon-home" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
    </symbol>
    <symbol id="icon-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
    </symbol>
    <symbol id="icon-calendar" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
    </symbol>
    <symbol id="icon-chart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
    </symbol>
    <symbol id="icon-credit-card" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
    </symbol>
    
    <!-- Ícones de ações -->
    <symbol id="icon-edit" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
    </symbol>
    <symbol id="icon-trash" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
    </symbol>
    <symbol id="icon-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
    </symbol>
    <symbol id="icon-x" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
    </symbol>
    <symbol id="icon-chevron-down" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
    </symbol>
    <symbol id="icon-chevron-up" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" />
    </symbol>
    <symbol id="icon-arrow-left" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
    </symbol>
    
    <!-- Ícones tema claro/escuro -->
    <symbol id="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
    </symbol>
    <symbol id="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
    </symbol>
    
    <!-- Ícones para categorias -->
    <symbol id="icon-shopping" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
    </symbol>
    <symbol id="icon-food" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
    </symbol>
    <symbol id="icon-home-category" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
    </symbol>
    <symbol id="icon-bill" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
    </symbol>
    <symbol id="icon-default" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </symbol>
    <symbol id="icon-money" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </symbol>
    
    <!-- Ícones para alertas -->
    <symbol id="icon-alert" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
    </symbol>
    <symbol id="icon-info" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </symbol>
    <symbol id="icon-settings" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
      <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
    </symbol>
    
    <!-- Ícones para ordenação -->
    <symbol id="icon-sort-asc" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" />
    </symbol>
    <symbol id="icon-sort-desc" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
    </symbol>
    
    <!-- Ícones analíticos -->
    <symbol id="icon-analytics" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
    </symbol>
    <symbol id="icon-trending-up" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
    </symbol>
    <symbol id="icon-trending-down" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6" />
    </symbol>
    <symbol id="icon-filter" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
    </symbol>
  </svg>

  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="header-filters">
        <div class="select-date-container" style="display: flex; gap: var(--spacing-sm);">
          <div class="select-wrapper">
            <select id="yearSelect" class="select">
              <!-- Options will be populated by JS -->
            </select>
            <svg class="select-icon" width="16" height="16">
              <use href="#icon-chevron-down"></use>
            </svg>
          </div>
          
          <div class="select-wrapper">
            <select id="monthSelect" class="select">
              <option value="0">Janeiro</option>
              <option value="1">Fevereiro</option>
              <option value="2">Março</option>
              <option value="3">Abril</option>
              <option value="4">Maio</option>
              <option value="5">Junho</option>
              <option value="6">Julho</option>
              <option value="7">Agosto</option>
              <option value="8">Setembro</option>
              <option value="9">Outubro</option>
              <option value="10">Novembro</option>
              <option value="11">Dezembro</option>
            </select>
            <svg class="select-icon" width="16" height="16">
              <use href="#icon-chevron-down"></use>
            </svg>
          </div>
        </div>
      </div>
      
      <div class="header-actions">
        <button id="newIncomeBtn" class="btn btn-success">
          <svg width="16" height="16" style="margin-right: var(--spacing-xs);">
            <use href="#icon-plus"></use>
          </svg>
          Nova Receita
        </button>
        
        <button id="newExpenseBtn" class="btn btn-danger">
          <svg width="16" height="16" style="margin-right: var(--spacing-xs);">
            <use href="#icon-plus"></use>
          </svg>
          Nova Despesa
        </button>
        
        <button id="cardsBtn" class="btn btn-outline">
          <svg width="16" height="16" style="margin-right: var(--spacing-xs);">
            <use href="#icon-credit-card"></use>
          </svg>
          Cartões
        </button>
        
        <button id="categoriesBtn" class="btn btn-outline">
          <svg width="16" height="16" style="margin-right: var(--spacing-xs);">
            <use href="#icon-settings"></use>
          </svg>
          Categorias
        </button>
        
        <button id="investmentsBtn" class="btn btn-outline">
          <svg width="16" height="16" style="margin-right: var(--spacing-xs);">
            <use href="#icon-chart"></use>
          </svg>
          Investimentos
        </button>

        <div id="themeToggle" class="theme-toggle" role="button" aria-label="Alternar tema">
          <svg class="icon-sun" width="20" height="20"> 
            <use href="#icon-sun"></use>
          </svg>
          <svg class="icon-moon" width="20" height="20">
            <use href="#icon-moon"></use>
          </svg>
        </div>
      </div>
    </header>
    
    <section class="hero">
      <h1 class="hero-title">Wagner. Bárbara. Joaquim.</h1>
      <p class="hero-subtitle">Porque o futuro que sonhamos começa com o que fazemos hoje.</p>
    </section>
    
    <div class="kpi-grid">
      <div class="kpi-card kpi-balance">
        <div class="kpi-title">
          Saldo Real (Caixa)
          <span class="kpi-badge kpi-badge-up">+3.2%</span>
        </div>
        <div class="kpi-value" id="balanceValue">R$ 0,00</div>
        <div class="kpi-subtitle">
          <svg width="16" height="16">
            <use href="#icon-info"></use>
          </svg>
          <span>Saldo comprometido: R$ 0,00</span>
        </div>
        <div class="kpi-progress">
          <div class="kpi-progress-bar" style="width: 65%"></div>
        </div>
      </div>
      
      <div class="kpi-card kpi-income">
        <div class="kpi-title">
          Receitas
          <span class="kpi-badge kpi-badge-up">+5.8%</span>
        </div>
        <div class="kpi-value" id="incomeValue">R$ 0,00</div>
        <div class="kpi-subtitle">
          <span id="incomeReceivedValue">R$ 0,00 recebidos</span> /
          <span id="incomePendingValue">R$ 0,00 pendentes</span>
        </div>
        <div class="kpi-progress">
          <div class="kpi-progress-bar" style="width: 75%"></div>
        </div>
      </div>
      
      <div class="kpi-card kpi-expense">
        <div class="kpi-title">
          Despesas
          <span class="kpi-badge kpi-badge-down">+2.1%</span>
        </div>
        <div class="kpi-value" id="expenseValue">R$ 0,00</div>
        <div class="kpi-subtitle">
          <span id="expensePaidValue">R$ 0,00 pagos</span> /
          <span id="expensePendingValue">R$ 0,00 pendentes</span>
        </div>
        <div class="kpi-progress">
          <div class="kpi-progress-bar" style="width: 60%"></div>
        </div>
      </div>
      
      <div class="kpi-card kpi-card-invoice">
        <div class="kpi-title">
          Fatura do Mês
          <span class="kpi-badge kpi-badge-warning">42%</span>
        </div>
        <div class="kpi-value" id="invoiceValue">R$ 0,00</div>
        <div class="kpi-subtitle">
          <svg width="16" height="16">
            <use href="#icon-credit-card"></use>
          </svg>
          <span>Vencimento: <span id="invoiceDueDate">--/--/----</span></span>
        </div>
        <div class="kpi-progress">
          <div class="kpi-progress-bar" style="width: 42%"></div>
        </div>
      </div>
    </div>
    
    <div class="insights-banner-container" id="insightsBannerContainer">
      <!-- Insights serão inseridos aqui dinamicamente -->
    </div>
    
    <!-- Bloco de gráficos -->
    <section class="charts-container">
      <h2 class="charts-title">Resumo Financeiro</h2>
      <div class="charts-grid">
        <div class="chart-container">
          <div class="chart-header">
            <h3 class="chart-title">Despesas por Categoria</h3>
            <div class="chart-actions">
              <button class="chart-filter-button active">Mês</button>
              <button class="chart-filter-button">Trimestre</button>
              <button class="chart-filter-button">Ano</button>
            </div>
          </div>
          <div class="chart-wrapper">
            <canvas id="categoryExpensesChart"></canvas>
          </div>
        </div>
        <div class="chart-container">
          <div class="chart-header">
            <h3 class="chart-title">Uso do Limite (Cartões)</h3>
            <div class="chart-actions">
              <button class="chart-filter-button active">Todos</button>
              <button class="chart-filter-button">Principais</button>
            </div>
          </div>
          <div class="chart-wrapper">
            <canvas id="cardUsageDonutChart"></canvas>
            <div class="limit-container">
              <div class="limit-display">
                <div class="limit-value">0%</div>
                <div class="limit-label">utilizado</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="charts-grid">
        <div class="chart-container">
          <div class="chart-header">
            <h3 class="chart-title">Despesas Fixas vs Variáveis</h3>
            <div class="chart-actions">
              <button class="chart-filter-button active">Mês</button>
              <button class="chart-filter-button">Anual</button>
            </div>
          </div>
          <div class="chart-wrapper">
            <canvas id="fixedVsVariableChart"></canvas>
          </div>
        </div>
        <div class="chart-container">
          <div class="chart-header">
            <h3 class="chart-title">Despesas por Pessoa</h3>
            <div class="chart-actions">
              <button class="chart-filter-button active">Valor</button>
              <button class="chart-filter-button">Percentual</button>
            </div>
          </div>
          <div class="chart-wrapper">
            <canvas id="personAnalysisChart"></canvas>
          </div>
        </div>
      </div>
    </section>

    <div class="chart-container annual-chart-container"> 
      <div class="chart-header">
        <h3 class="chart-title">Receitas x Despesas (12 meses)</h3>
        <div class="chart-actions">
          <button class="chart-filter-button active">Valor</button>
          <button class="chart-filter-button">Saldo</button>
          <button class="chart-filter-button">Tendência</button>
        </div>
      </div>
      <div class="chart-wrapper">
        <canvas id="annualBars"></canvas>
      </div>
      <div class="chart-legend">
        <div class="chart-legend-item">
          <span class="chart-legend-color" style="background-color: var(--color-income);"></span>
          <span>Receitas</span>
        </div>
        <div class="chart-legend-item">
          <span class="chart-legend-color" style="background-color: var(--color-expense);"></span>
          <span>Despesas</span>
        </div>
      </div>
    </div>

    <!-- Tooltip global para os gráficos -->
    <div class="chart-tooltip" id="tooltip"></div>
    
    <div class="commitments">
      <div class="commitments-header active" id="commitmentsHeader">
        <h3>Compromissos Longos</h3>
        <svg width="20" height="20" id="commitmentToggleIcon">
            <use href="#icon-chevron-up"></use>
        </svg>
      </div>
      <div class="commitments-content" id="commitmentsContent" style="max-height: 500px;"> 
        <!-- Compromissos serão inseridos aqui dinamicamente -->
      </div>
    </div>
    
    <section class="transactions-container">
      <div class="card-transacoes">
        <div class="card-header">
          <h3 class="card-title">Transações</h3>
          <div class="filters transaction-filters" id="transaction-filters">
            <!-- Filtros serão inseridos aqui dinamicamente -->
          </div>
        </div>
        
        <div class="transactions-table-container">
          <table class="transactions-table" id="transactionsTable">
            <thead>
              <tr>
                <th class="sortable" data-sort="name">Nome</th>
                <th class="sortable" data-sort="person">Pessoa</th>
                <th class="sortable" data-sort="date">Data</th>
                <th class="sortable" data-sort="dueDate">Vencimento</th>
                <th class="sortable" data-sort="amount">Valor</th>
                <th class="sortable" data-sort="status">Status</th>
                <th class="sortable" data-sort="paymentMethod">Pagamento</th>
                <th>Pago?</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="transactionsTableBody">
              <!-- Transações serão inseridas aqui dinamicamente -->
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <!-- Modais -->
  <!-- Modal de Nova Receita -->
  <div class="modal-backdrop" id="incomeModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Nova Receita</h2>
        <button class="modal-close" id="closeIncomeModal" aria-label="Fechar">
          <svg width="24" height="24">
            <use href="#icon-x"></use>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="incomeForm">
          <div class="form-group">
            <label class="form-label" for="incomeName">Nome</label>
            <input type="text" class="form-control" id="incomeName" placeholder="Nome da receita">
          </div>
          <div class="form-group">
            <label class="form-label" for="incomeAmount">Valor</label>
            <input type="number" class="form-control" id="incomeAmount" placeholder="0,00" min="0" step="0.01">
          </div>
          <div class="form-group">
            <label class="form-label" for="incomeCategory">Categoria</label>
            <div class="select-wrapper">
              <select class="select" id="incomeCategory"></select>
              <svg class="select-icon" width="16" height="16"><use href="#icon-chevron-down"></use></svg>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" for="incomeDate">Data de Lançamento</label>
            <input type="date" class="form-control" id="incomeDate">
          </div>
          <div class="form-group">
            <label class="form-label" for="incomePaymentMethod">Forma de Recebimento</label>
            <div class="select-wrapper">
              <select class="select" id="incomePaymentMethod"></select>
              <svg class="select-icon" width="16" height="16"><use href="#icon-chevron-down"></use></svg>
            </div>
          </div>
          <div class="form-group checkbox-wrapper">
            <input type="checkbox" class="checkbox" id="incomeIsRecurrent">
            <label class="checkbox-label" for="incomeIsRecurrent">Receita Recorrente</label>
          </div>
          <div class="form-group" id="incomeRecurrenceGroup" style="display: none;">
            <label class="form-label" for="incomeInstallments">Quantidade de Parcelas</label>
            <input type="number" class="form-control" id="incomeInstallments" min="2" value="2">
          </div>
          <div class="form-group" id="incomeStatusGroup">
            <label class="form-label">Status</label>
            <div class="radio-group">
              <div class="radio-wrapper">
                <input type="radio" class="radio" id="incomeStatusReceived" name="incomeStatus" value="received" checked>
                <label class="radio-label" for="incomeStatusReceived">Recebido</label>
              </div>
              <div class="radio-wrapper">
                <input type="radio" class="radio" id="incomeStatusPending" name="incomeStatus" value="pending">
                <label class="radio-label" for="incomeStatusPending">A Receber</label>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" for="incomeNotes">Observação (opcional)</label>
            <textarea class="form-control" id="incomeNotes" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="cancelIncomeBtn">Cancelar</button>
        <button class="btn btn-success" id="saveIncomeBtn">Salvar Receita</button>
      </div>
    </div>
  </div>

 <!-- Modal de Nova Despesa -->
 <div class="modal-backdrop" id="expenseModal">
   <div class="modal">
     <div class="modal-header">
       <h2 class="modal-title">Nova Despesa</h2>
       <button class="modal-close" id="closeExpenseModal" aria-label="Fechar">
         <svg width="24" height="24"><use href="#icon-x"></use></svg>
       </button>
     </div>
     <div class="modal-body">
       <form id="expenseForm">
         <div class="form-group">
           <label class="form-label" for="expenseName">Nome</label>
           <input type="text" class="form-control" id="expenseName" placeholder="Nome da despesa">
         </div>
         <div class="form-group">
           <label class="form-label" for="expenseAmount">Valor</label>
           <input type="number" class="form-control" id="expenseAmount" placeholder="0,00" min="0" step="0.01">
         </div>
         <div class="form-group">
           <label class="form-label" for="expensePaymentMethod">Forma de Pagamento</label>
           <div class="select-wrapper">
             <select class="select" id="expensePaymentMethod"></select>
             <svg class="select-icon" width="16" height="16"><use href="#icon-chevron-down"></use></svg>
           </div>
         </div>
         <div class="form-group" id="creditCardGroup" style="display: none;">
           <label class="form-label" for="expenseCreditCard">Cartão de Crédito</label>
           <div class="select-wrapper">
             <select class="select" id="expenseCreditCard"></select>
             <svg class="select-icon" width="16" height="16"><use href="#icon-chevron-down"></use></svg>
           </div>
         </div>
         <div class="form-group">
           <label class="form-label" for="expenseCategory">Categoria</label>
           <div class="select-wrapper">
             <select class="select" id="expenseCategory"></select>
             <svg class="select-icon" width="16" height="16"><use href="#icon-chevron-down"></use></svg>
           </div>
         </div>
         <div class="form-group">
           <label class="form-label" for="expensePerson">Pessoa</label>
           <div class="select-wrapper">
             <select class="select" id="expensePerson"></select>
             <svg class="select-icon" width="16" height="16"><use href="#icon-chevron-down"></use></svg>
           </div>
         </div>
         <div class="form-group">
           <label class="form-label">Tipo de Despesa</label>
           <div class="radio-group">
             <div class="radio-wrapper">
               <input type="radio" class="radio" id="expenseTypeFixed" name="expenseType" value="fixed" required>
               <label class="radio-label" for="expenseTypeFixed">Fixa</label>
             </div>
             <div class="radio-wrapper">
               <input type="radio" class="radio" id="expenseTypeVariable" name="expenseType" value="variable" required>
               <label class="radio-label" for="expenseTypeVariable">Variável</label>
             </div>
           </div>
         </div>
         <div class="form-group">
           <label class="form-label" for="expenseDate">Data de Lançamento</label>
           <input type="date" class="form-control" id="expenseDate">
         </div>
         <div class="form-group" id="expenseDueDateGroup">
           <label class="form-label" for="expenseDueDate">Data de Vencimento</label>
           <input type="date" class="form-control" id="expenseDueDate">
         </div>
         <div class="form-group checkbox-wrapper">
           <input type="checkbox" class="checkbox" id="expenseIsRecurrent">
           <label class="checkbox-label" for="expenseIsRecurrent">Despesa Recorrente</label>
         </div>
         <div class="form-group" id="expenseRecurrenceGroup" style="display: none;">
           <label class="form-label" for="expenseInstallments">Quantidade de Parcelas</label>
           <input type="number" class="form-control" id="expenseInstallments" min="2" value="2">
         </div>
         <div class="form-group" id="expenseStatusGroup">
           <label class="form-label">Status</label>
           <div class="radio-group">
             <div class="radio-wrapper">
               <input type="radio" class="radio" id="expenseStatusPaid" name="expenseStatus" value="paid">
               <label class="radio-label" for="expenseStatusPaid">Pago</label>
             </div>
             <div class="radio-wrapper">
               <input type="radio" class="radio" id="expenseStatusPending" name="expenseStatus" value="pending" checked>
               <label class="radio-label" for="expenseStatusPending">Pendente</label>
             </div>
             <div class="radio-wrapper">
               <input type="radio" class="radio" id="expenseStatusScheduled" name="expenseStatus" value="scheduled">
               <label class="radio-label" for="expenseStatusScheduled">Agendado</label>
             </div>
           </div>
         </div>
         <div class="form-group" id="scheduledDateGroup" style="display: none;">
           <label class="form-label" for="expenseScheduledDate">Data de Agendamento</label>
           <input type="date" class="form-control" id="expenseScheduledDate">
         </div>
         <div class="form-group">
           <label class="form-label" for="expenseNotes">Observação (opcional)</label>
           <textarea class="form-control" id="expenseNotes" rows="3"></textarea>
         </div>
       </form>
     </div>
     <div class="modal-footer">
       <button class="btn btn-outline" id="cancelExpenseBtn">Cancelar</button>
       <button class="btn btn-danger" id="saveExpenseBtn">Salvar Despesa</button>
     </div>
   </div>
 </div>

 <!-- Modal de Edição de Transação -->
 <div class="modal-backdrop" id="editModal">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title" id="editModalTitle">Editar Transação</h2>
      <button class="modal-close" id="closeEditModal" aria-label="Fechar">
        <svg width="24" height="24"><use href="#icon-x"></use></svg>
      </button>
    </div>
    <div class="modal-body">
      <form id="editForm">
        <input type="hidden" id="editTransactionId">
        <input type="hidden" id="editTransactionType">
        <div class="form-group">
          <label class="form-label" for="editName">Nome</label>
          <input type="text" class="form-control" id="editName">
        </div>
        <div class="form-group">
          <label class="form-label" for="editAmount">Valor</label>
          <input type="number" class="form-control" id="editAmount" min="0" step="0.01">
        </div>
        <div class="form-group">
          <label class="form-label" for="editCategory">Categoria</label>
          <div class="select-wrapper">
            <select class="select" id="editCategory" data-type=""></select>
            <svg class="select-icon" width="16" height="16"><use href="#icon-chevron-down"></use></svg>
          </div>
        </div>
        <div class="form-group" id="editPersonGroup">
          <label class="form-label" for="editPerson">Pessoa</label>
          <div class="select-wrapper">
            <select class="select" id="editPerson"></select>
            <svg class="select-icon" width="16" height="16"><use href="#icon-chevron-down"></use></svg>
          </div>
        </div>
        <div class="form-group" id="editExpenseTypeGroup" style="display: none;">
          <label class="form-label">Tipo de Despesa</label>
          <div class="radio-group">
            <div class="radio-wrapper">
              <input type="radio" class="radio" id="editExpenseTypeFixed" name="editExpenseType" value="fixed">
              <label class="radio-label" for="editExpenseTypeFixed">Fixa</label>
            </div>
            <div class="radio-wrapper">
              <input type="radio" class="radio" id="editExpenseTypeVariable" name="editExpenseType" value="variable">
              <label class="radio-label" for="editExpenseTypeVariable">Variável</label>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label" for="editDate">Data de Lançamento</label>
          <input type="date" class="form-control" id="editDate">
        </div>
        <div class="form-group" id="editDueDateGroup">
          <label class="form-label" for="editDueDate">Data de Vencimento</label>
          <input type="date" class="form-control" id="editDueDate">
        </div>
        <div class="form-group">
          <label class="form-label" for="editPaymentMethod">Forma de Pagamento</label>
          <div class="select-wrapper">
            <select class="select" id="editPaymentMethod"></select>
            <svg class="select-icon" width="16" height="16"><use href="#icon-chevron-down"></use></svg>
          </div>
        </div>
        <div class="form-group" id="editCreditCardGroup" style="display: none;">
          <label class="form-label" for="editCreditCard">Cartão de Crédito</label>
          <div class="select-wrapper">
            <select class="select" id="editCreditCard"></select>
            <svg class="select-icon" width="16" height="16"><use href="#icon-chevron-down"></use></svg>
          </div>
        </div>
        <div class="form-group checkbox-wrapper">
          <input type="checkbox" class="checkbox" id="editIsRecurrent">
          <label class="checkbox-label" for="editIsRecurrent">Transação Recorrente</label>
        </div>
        <div class="form-group" id="editRecurrenceGroup" style="display: none;">
          <label class="form-label" for="editInstallments">Quantidade de Parcelas</label>
          <input type="number" class="form-control" id="editInstallments" min="2" value="2">
        </div>
        <div class="form-group" id="editStatusOuterGroup"> 
          <label class="form-label">Status</label>
          <div class="radio-group" id="editStatusGroup">
            <!-- Opções de status serão inseridas dinamicamente -->
          </div>
        </div>
        <div class="form-group" id="editScheduledDateGroup" style="display: none;">
          <label class="form-label" for="editScheduledDate">Data de Agendamento</label>
          <input type="date" class="form-control" id="editScheduledDate">
        </div>
        <div class="form-group">
          <label class="form-label" for="editNotes">Observação (opcional)</label>
          <textarea class="form-control" id="editNotes" rows="3"></textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="cancelEditBtn">Cancelar</button>
      <button class="btn btn-primary" id="saveEditBtn">Salvar Alterações</button>
    </div>
  </div>
 </div>

 <!-- Modal de Cartões -->
 <div class="modal-backdrop" id="cardsListModal">
  <div class="modal" style="max-width: 600px;">
    <div class="modal-header">
      <h2 class="modal-title">Cartões</h2>
      <button class="modal-close" id="closeCardsListModal" aria-label="Fechar">
        <svg width="24" height="24"><use href="#icon-x"></use></svg>
      </button>
    </div>
    <div class="modal-body">
      <div id="cardsList">
        <!-- Cards serão inseridos aqui dinamicamente -->
      </div>
      <button class="btn btn-primary" id="newCardBtn" style="margin-top: var(--spacing-md);">
        <svg width="16" height="16" style="margin-right: var(--spacing-xs);"><use href="#icon-plus"></use></svg>
        Novo Cartão
      </button>
    </div>
  </div>
 </div>

 <!-- Modal de Novo Cartão -->
 <div class="modal-backdrop" id="newCardModal">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title">Novo Cartão</h2>
      <button class="modal-close" id="closeNewCardModal" aria-label="Fechar">
        <svg width="24" height="24"><use href="#icon-x"></use></svg>
      </button>
    </div>
    <div class="modal-body">
      <form id="cardForm">
        <div class="form-group">
          <label class="form-label" for="cardName">Nome do Cartão</label>
          <input type="text" class="form-control" id="cardName" placeholder="Ex: Nubank">
        </div>
        <div class="form-group">
          <label class="form-label" for="cardLimit">Limite Total</label>
          <input type="number" class="form-control" id="cardLimit" placeholder="0,00" min="0" step="0.01">
        </div>
        <div class="form-group">
          <label class="form-label" for="cardClosingDay">Dia de Fechamento</label>
          <input type="number" class="form-control" id="cardClosingDay" placeholder="1-31" min="1" max="31">
        </div>
        <div class="form-group">
          <label class="form-label" for="cardDueDay">Dia de Vencimento</label>
          <input type="number" class="form-control" id="cardDueDay" placeholder="1-31" min="1" max="31">
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="cancelCardBtn">Cancelar</button>
      <button class="btn btn-primary" id="saveCardBtn">Salvar Cartão</button>
    </div>
  </div>
 </div>

 <!-- Modal de Fatura do Cartão -->
 <div class="modal-backdrop" id="cardInvoiceModal">
  <div class="modal" style="max-width: 700px;">
    <div class="modal-header">
      <h2 class="modal-title" id="cardInvoiceTitle">Fatura do Cartão</h2>
      <button class="modal-close" id="closeCardInvoiceModal" aria-label="Fechar">
        <svg width="24" height="24"><use href="#icon-x"></use></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="card" style="margin-bottom: var(--spacing-md);">
        <div id="cardInvoiceDetails">
          <!-- Detalhes da fatura serão inseridos aqui dinamicamente -->
        </div>
      </div>
      <h3>Despesas desta Fatura</h3>
      <div class="transactions-table-container">
        <table class="transactions-table" id="cardInvoiceTable">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Data</th>
              <th>Valor</th>
              <th>Pago?</th>
            </tr>
          </thead>
          <tbody id="cardInvoiceTableBody">
            <!-- Despesas da fatura serão inseridas aqui dinamicamente -->
          </tbody>
        </table>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="backToCardsBtn">Voltar</button>
      <button class="btn btn-primary" id="payInvoiceBtn">Pagar Fatura</button>
    </div>
  </div>
 </div>

 <!-- Modal de Confirmação de Exclusão -->
 <div class="modal-backdrop" id="deleteConfirmModal">
  <div class="modal" style="max-width: 400px;">
    <div class="modal-header">
      <h2 class="modal-title">
        <svg width="24" height="24" style="vertical-align: middle; margin-right: 8px;"><use href="#icon-alert"></use></svg>
        Confirmar Exclusão
      </h2>
      <button class="modal-close" id="closeDeleteConfirmModal" aria-label="Fechar">
        <svg width="24" height="24"><use href="#icon-x"></use></svg>
      </button>
    </div>
    <div class="modal-body">
      <p>Você deseja realmente excluir esta transação? Esta ação é irreversível.</p>
      <div id="recurrenceDeleteOptions" style="display: none; margin-top: var(--spacing-md);">
        <p><strong>Esta é uma transação recorrente. O que deseja fazer?</strong></p>
        <div class="radio-group" style="flex-direction: column; gap: var(--spacing-sm);">
          <div class="radio-wrapper">
            <input type="radio" class="radio" id="deleteSingle" name="deleteOption" value="single" checked>
            <label class="radio-label" for="deleteSingle">Excluir apenas esta parcela</label>
          </div>
          <div class="radio-wrapper">
            <input type="radio" class="radio" id="deleteAllFuture" name="deleteOption" value="future">
            <label class="radio-label" for="deleteAllFuture">Excluir esta e todas as parcelas futuras</label>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="cancelDeleteBtn">Cancelar</button>
      <button class="btn btn-danger" id="confirmDeleteBtn">Excluir</button>
    </div>
  </div>
 </div>

 <!-- Modal de Confirmação de Pagamento de Fatura -->
 <div class="modal-backdrop" id="payInvoiceConfirmModal">
  <div class="modal" style="max-width: 400px;">
    <div class="modal-header">
      <h2 class="modal-title">
        <svg width="24" height="24" style="vertical-align: middle; margin-right: 8px;"><use href="#icon-credit-card"></use></svg>
        Pagar Fatura do Cartão
      </h2>
      <button class="modal-close" id="closePayInvoiceConfirmModal" aria-label="Fechar">
        <svg width="24" height="24"><use href="#icon-x"></use></svg>
      </button>
    </div>
    <div class="modal-body">
      <p>Confirmar pagamento de todas as despesas desta fatura?</p>
      <p style="margin-top: var(--spacing-xs);">Total: <strong id="invoiceConfirmAmount">R$ 0,00</strong></p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="cancelPayInvoiceBtn">Cancelar</button>
      <button class="btn btn-primary" id="confirmPayInvoiceBtn">Pagar</button>
    </div>
  </div>
 </div>

 <!-- Modal de Categorias -->
 <div class="modal-backdrop" id="categoriesModal">
  <div class="modal" style="max-width: 600px;">
    <div class="modal-header">
      <h2 class="modal-title">Gerenciar Categorias</h2>
      <button class="modal-close" id="closeCategoriesModal" aria-label="Fechar">
        <svg width="24" height="24"><use href="#icon-x"></use></svg>
      </button>
    </div>
    <div class="modal-body categories-container">
      <ul class="nav-tabs" id="categoryTabs" role="tablist">
        <li class="nav-item"><a class="nav-link active" id="income-cat-tab" data-toggle="tab" href="#income-cat" role="tab">Receitas</a></li>
        <li class="nav-item"><a class="nav-link" id="expense-cat-tab" data-toggle="tab" href="#expense-cat" role="tab">Despesas</a></li>
        <li class="nav-item"><a class="nav-link" id="payment-methods-tab" data-toggle="tab" href="#payment-methods" role="tab">Pagamentos</a></li>
        <li class="nav-item"><a class="nav-link" id="people-tab" data-toggle="tab" href="#people" role="tab">Pessoas</a></li>
        <li class="nav-item"><a class="nav-link" id="investment-cat-tab" data-toggle="tab" href="#investment-cat" role="tab">Investimentos</a></li>
      </ul>
      <div class="tab-content" id="categoryTabContent">
        <div class="tab-pane fade show active" id="income-cat" role="tabpanel">
          <div class="category-list" id="incomeCategoriesList"></div>
          <form class="add-category-form">
            <div class="custom-icon-input"><div class="custom-icon-preview" id="newIncomeCategoryIconPreview">💰</div><input type="text" class="form-control" id="newIncomeCategoryIconInput" placeholder="Ícone"></div>
            <input type="text" class="form-control" id="newIncomeCategoryInput" placeholder="Nova categoria de receita">
            <button type="button" class="btn btn-primary" id="addIncomeCategoryBtn">Adicionar</button>
          </form>
        </div>
        <div class="tab-pane fade" id="expense-cat" role="tabpanel">
          <div class="category-list" id="expenseCategoriesList"></div>
          <form class="add-category-form">
            <div class="custom-icon-input"><div class="custom-icon-preview" id="newExpenseCategoryIconPreview">🛍️</div><input type="text" class="form-control" id="newExpenseCategoryIconInput" placeholder="Ícone"></div>
            <input type="text" class="form-control" id="newExpenseCategoryInput" placeholder="Nova categoria de despesa">
            <button type="button" class="btn btn-primary" id="addExpenseCategoryBtn">Adicionar</button>
          </form>
        </div>
        <div class="tab-pane fade" id="payment-methods" role="tabpanel">
          <div class="category-list" id="paymentMethodsList"></div>
          <form class="add-category-form">
            <div class="custom-icon-input"><div class="custom-icon-preview" id="newPaymentMethodIconPreview">💳</div><input type="text" class="form-control" id="newPaymentMethodIconInput" placeholder="Ícone"></div>
            <input type="text" class="form-control" id="newPaymentMethodInput" placeholder="Nova forma de pagamento">
            <button type="button" class="btn btn-primary" id="addPaymentMethodBtn">Adicionar</button>
          </form>
        </div>
        <div class="tab-pane fade" id="people" role="tabpanel">
          <div class="category-list" id="peopleList"></div>
          <form class="add-category-form">
            <div class="custom-icon-input"><div class="custom-icon-preview" id="newPersonIconPreview">👤</div><input type="text" class="form-control" id="newPersonIconInput" placeholder="Ícone"></div>
            <input type="text" class="form-control" id="newPersonInput" placeholder="Nome da pessoa">
            <button type="button" class="btn btn-primary" id="addPersonBtn">Adicionar</button>
          </form>
        </div>
        <div class="tab-pane fade" id="investment-cat" role="tabpanel">
          <div class="category-list" id="investmentCategoriesList"></div>
          <form class="add-category-form">
            <div class="custom-icon-input"><div class="custom-icon-preview" id="newInvestmentCategoryIconPreview">📈</div><input type="text" class="form-control" id="newInvestmentCategoryIconInput" placeholder="Ícone"></div>
            <input type="text" class="form-control" id="newInvestmentCategoryInput" placeholder="Nova categoria de investimento">
            <button type="button" class="btn btn-primary" id="addInvestmentCategoryBtn">Adicionar</button>
          </form>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="closeCategoriesBtn">Fechar</button>
    </div>
  </div>
 </div>

<!-- Modal de Edição de Categoria/Item -->
 <div class="modal-backdrop" id="editCategoryModal">
  <div class="modal" style="max-width: 400px;">
    <div class="modal-header">
      <h2 class="modal-title" id="editCategoryTitle">Editar Item</h2>
      <button class="modal-close" id="closeEditCategoryModal" aria-label="Fechar">
        <svg width="24" height="24"><use href="#icon-x"></use></svg>
      </button>
    </div>
    <div class="modal-body">
      <form id="editCategoryForm">
        <input type="hidden" id="editCategoryId">
        <input type="hidden" id="editCategoryType">
        <div class="form-group">
          <label class="form-label">Ícone</label>
          <div class="custom-icon-input">
            <div class="custom-icon-preview" id="editCategoryIconPreview">ℹ️</div>
            <input type="text" class="form-control" id="editCategoryIconInput" placeholder="Emoji ou ícone">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label" for="editCategoryName">Nome</label>
          <input type="text" class="form-control" id="editCategoryName" placeholder="Nome">
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="cancelEditCategoryBtn">Cancelar</button>
      <button class="btn btn-primary" id="saveEditCategoryBtn">Salvar</button>
    </div>
  </div>
 </div>

 <!-- Modal Principal de Investimentos -->
 <div class="modal-backdrop" id="investmentsModal">
  <div class="modal" style="max-width: 900px;">
    <div class="modal-header">
      <h2 class="modal-title">Investimentos</h2>
      <button class="modal-close" id="closeInvestmentsModal" aria-label="Fechar">
        <svg width="24" height="24"><use href="#icon-x"></use></svg>
      </button>
    </div>
    <div class="modal-body">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
        <h3>Seus Investimentos</h3>
        <button class="btn btn-primary" id="newInvestmentBtn">
          <svg width="16" height="16" style="margin-right: var(--spacing-xs);"><use href="#icon-plus"></use></svg>
          Novo Investimento
        </button>
      </div>
      <div class="investment-grid" id="investmentsGrid">
        <!-- Cards de investimentos -->
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="closeInvestmentsBtn">Fechar</button>
    </div>
  </div>
 </div>

 <!-- Modal para Detalhe do Investimento -->
 <div class="modal-backdrop" id="investmentDetailModal">
  <div class="modal" style="max-width: 800px;">
    <div class="modal-header">
      <h2 class="modal-title" id="investmentDetailTitle" style="display: flex; align-items: center; gap: var(--spacing-sm);">
        <button class="btn btn-icon btn-outline" id="backToInvestmentsBtn" aria-label="Voltar">
          <svg width="16" height="16"><use href="#icon-arrow-left"></use></svg>
        </button>
        <span id="investmentDetailName">Nome do Investimento</span>
      </h2>
      <button class="modal-close" id="closeInvestmentDetailModal" aria-label="Fechar">
        <svg width="24" height="24"><use href="#icon-x"></use></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="investment-detail">
        <div class="investment-detail-header">
          <div class="investment-detail-stat"><div class="investment-detail-title">Guardado</div><div class="investment-detail-value" id="investmentDetailSaved">R$ 0,00</div></div>
          <div class="investment-detail-stat"><div class="investment-detail-title">Meta</div><div class="investment-detail-value" id="investmentDetailGoal">R$ 0,00</div></div>
          <div class="investment-detail-stat"><div class="investment-detail-title">Progresso</div><div class="investment-detail-value" id="investmentDetailProgress">0%</div></div>
        </div>
        <div style="margin-bottom: var(--spacing-md);">
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: var(--spacing-sm);">
            <div><div class="investment-detail-title">Categoria</div><div id="investmentDetailCategory">Viagem</div></div>
            <div><div class="investment-detail-title">Criado em</div><div id="investmentDetailCreatedAt">01/01/2025</div></div>
            <div><div class="investment-detail-title">Objetivo</div><div id="investmentDetailTarget">Julho de 2026</div></div>
          </div>
          <div style="margin-top: var(--spacing-sm);"><div class="investment-detail-title">Observação</div><div id="investmentDetailNotes">-</div></div>
        </div>
      </div>
      <div class="investment-history">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm);">
          <h3 class="investment-history-title">Histórico de Aportes</h3>
          <button class="btn btn-primary" id="addInvestmentContributionBtn">
            <svg width="16" height="16" style="margin-right: var(--spacing-xs);"><use href="#icon-plus"></use></svg>
            Adicionar Aporte
          </button>
        </div>
        <div class="transactions-table-container">
            <table class="investment-history-table">
            <thead><tr><th>Data</th><th>Valor</th><th>Descrição</th><th>Ações</th></tr></thead>
            <tbody id="investmentHistoryTableBody"></tbody>
            </table>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger" id="deleteInvestmentBtn">Excluir Investimento</button>
      <button class="btn btn-primary" id="editInvestmentBtn">Editar Investimento</button>
    </div>
  </div>
 </div>

 <!-- Modal de Novo Investimento -->
 <div class="modal-backdrop" id="newInvestmentModal">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title" id="newInvestmentModalTitle">Novo Investimento</h2>
      <button class="modal-close" id="closeNewInvestmentModal" aria-label="Fechar">
        <svg width="24" height="24"><use href="#icon-x"></use></svg>
      </button>
    </div>
    <div class="modal-body">
      <form id="investmentForm">
        <div class="form-group"><label class="form-label" for="investmentName">Nome do objetivo</label><input type="text" class="form-control" id="investmentName" placeholder="Ex: Viagem em Família"></div>
        <div class="form-group"><label class="form-label" for="investmentAmount">Valor inicial</label><input type="number" class="form-control" id="investmentAmount" placeholder="0,00" min="0" step="0.01"></div>
        <div class="form-group"><label class="form-label" for="investmentGoal">Meta final (opcional)</label><input type="number" class="form-control" id="investmentGoal" placeholder="0,00" min="0" step="0.01"></div>
        <div class="form-group">
          <label class="form-label" for="investmentCategory">Tipo/Categoria</label>
          <div class="select-wrapper">
            <select class="select" id="investmentCategorySelect"></select> 
            <svg class="select-icon" width="16" height="16"><use href="#icon-chevron-down"></use></svg>
          </div>
        </div>
        <div class="form-group"><label class="form-label" for="investmentTargetDate">Data-alvo (opcional)</label><input type="date" class="form-control" id="investmentTargetDate"></div>
        <div class="form-group"><label class="form-label" for="investmentNotes">Observações (opcional)</label><textarea class="form-control" id="investmentNotes" rows="3"></textarea></div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="cancelInvestmentBtn">Cancelar</button>
      <button class="btn btn-primary" id="saveInvestmentBtn">Salvar Investimento</button>
    </div>
  </div>
 </div>

 <!-- Modal para Adicionar Aporte -->
 <div class="modal-backdrop" id="newContributionModal">
  <div class="modal" style="max-width: 400px;">
    <div class="modal-header">
      <h2 class="modal-title" id="newContributionModalTitle">Adicionar Novo Valor</h2>
      <button class="modal-close" id="closeNewContributionModal" aria-label="Fechar">
        <svg width="24" height="24"><use href="#icon-x"></use></svg>
      </button>
    </div>
    <div class="modal-body">
      <form id="contributionForm">
        <input type="hidden" id="contributionInvestmentId">
        <div class="form-group"><label class="form-label" for="contributionAmount">Valor</label><input type="number" class="form-control" id="contributionAmount" placeholder="0,00" min="0" step="0.01" required></div>
        <div class="form-group"><label class="form-label" for="contributionDate">Data</label><input type="date" class="form-control" id="contributionDate" required></div>
        <div class="form-group"><label class="form-label" for="contributionDescription">Descrição</label><input type="text" class="form-control" id="contributionDescription" placeholder="Ex: Depósito mensal"></div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="cancelContributionBtn">Cancelar</button>
      <button class="btn btn-primary" id="saveContributionBtn">Adicionar</button>
    </div>
  </div>
 </div>

 <!-- Modal para detalhes de contas vencidas/a vencer -->
 <div class="modal-backdrop" id="dueTransactionsModal">
  <div class="modal" style="max-width: 700px;">
    <div class="modal-header">
      <h2 class="modal-title" id="dueTransactionsModalTitle">
        <svg width="24" height="24" style="vertical-align: middle; margin-right: 8px;" id="dueTransactionsModalIcon"><use href="#icon-alert"></use></svg>
        <span id="dueTransactionsModalTitleText">Contas</span>
      </h2>
      <button class="modal-close" id="closeDueTransactionsModal" aria-label="Fechar">
        <svg width="24" height="24"><use href="#icon-x"></use></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="transactions-table-container">
        <table class="transactions-table" id="dueTransactionsTable">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Categoria</th>
              <th>Vencimento</th>
              <th>Valor</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="dueTransactionsTableBody"></tbody>
        </table>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="closeDueTransactionsBtn">Fechar</button>
      <button class="btn btn-primary" id="payAllDueBtn" style="display:none;">Pagar Todas</button>
    </div>
  </div>
 </div>

 <div class="toast-container" id="toastContainer"></div>

 <script>
  
  const $ = selector => document.querySelector(selector);
  const $$ = selector => Array.from(document.querySelectorAll(selector));

  const state = {
    year: new Date().getFullYear(),
    month: new Date().getMonth(),
    transactions: [],
    cards: [],
    filteredTransactions: [],
    insights: [],
    sortColumn: 'dueDate', 
    sortDirection: 'asc', 
    filters: {
      category: '',
      status: '',
      paymentMethod: '',
      person: '',
      transactionType: '' 
    },
    categories: {
      income: [
        { id: 'salario', name: 'Salário', icon: '💰', type: 'income' },
        { id: 'investimentos_income', name: 'Rend. Investimentos', icon: '📈', type: 'income' },
        { id: 'freelance', name: 'Freelance', icon: '💻', type: 'income' },
        { id: 'presente', name: 'Presente', icon: '🎁', type: 'income' },
        { id: 'outros_income', name: 'Outros', icon: 'ℹ️', type: 'income' }
      ],
      expense: [
        { id: 'alimentacao', name: 'Alimentação', icon: '🍔', type: 'expense' },
        { id: 'moradia', name: 'Moradia', icon: '🏠', type: 'expense' },
        { id: 'transporte', name: 'Transporte', icon: '🚗', type: 'expense' },
        { id: 'saude', name: 'Saúde', icon: '⚕️', type: 'expense' },
        { id: 'educacao', name: 'Educação', icon: '📚', type: 'expense' },
        { id: 'lazer', name: 'Lazer', icon: '🎮', type: 'expense' },
        { id: 'compras', name: 'Compras', icon: '🛍️', type: 'expense' },
        { id: 'contas', name: 'Contas e serviços', icon: '📝', type: 'expense' },
        { id: 'impostos', name: 'Impostos', icon: '💸', type: 'expense' },
        { id: 'outros_expense', name: 'Outros', icon: 'ℹ️', type: 'expense' }
      ],
      investment: [
        { id: 'viagem', name: 'Viagem', icon: '✈️', type: 'investment' },
        { id: 'emergencia', name: 'Emergência', icon: '🚨', type: 'investment' },
        { id: 'filho', name: 'Filho', icon: '👶', type: 'investment' },
        { id: 'tesouro', name: 'Tesouro Direto', icon: '🏛️', type: 'investment' },
        { id: 'acoes', name: 'Ações', icon: '📊', type: 'investment' },
        { id: 'outro_investment', name: 'Outro', icon: '💰', type: 'investment' }
      ]
    },
    paymentMethods: [
      { id: 'dinheiro', name: 'Dinheiro', icon: '💵' },
      { id: 'pix', name: 'Pix', icon: '⚡' },
      { id: 'debito', name: 'Débito', icon: '💳' },
      { id: 'debito_conta', name: 'Débito em Conta', icon: '🏦' },
      { id: 'transferencia', name: 'Transferência Bancária', icon: '🔄' },
      { id: 'boleto', name: 'Boleto', icon: '📄' },
      { id: 'credito', name: 'Cartão de Crédito', icon: '💳' }
    ],
    people: [
      { id: 'familia', name: 'Família', icon: '👨‍👩‍👧‍👦' },
      { id: 'wagner', name: 'Wagner', icon: '👨‍💻' },
      { id: 'barbara', name: 'Bárbara', icon: '👩‍🎨' },
      { id: 'joaquim', name: 'Joaquim', icon: '👶' }
    ],
    investments: [],
    investmentContributions: [],
    currentTransaction: null,
    currentCard: null,
    currentCategory: null,
    currentInvestment: null,
    currentContribution: null,
    themePreference: 'light'
  };

  const formatCurrency = value => {
    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
  };

  const parseLocalDateString = (dateInput) => {
    if (dateInput instanceof Date && !isNaN(dateInput)) return new Date(Date.UTC(dateInput.getFullYear(), dateInput.getMonth(), dateInput.getDate()));
    if (typeof dateInput === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateInput)) {
      const [year, month, day] = dateInput.split('-').map(Number);
      return new Date(Date.UTC(year, month - 1, day)); 
    }
    return null;
  };
  
  const formatDate = (date, options = {}) => {
    const dateObj = parseLocalDateString(date);
    if (!dateObj) return '--/--/----';
    return dateObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', timeZone: 'UTC', ...options });
  };

  const localDateToISOString = (date) => {
    if (!date) return null;
    const d = date instanceof Date ? date : parseLocalDateString(date);
    if (!d) return null;
    const year = d.getUTCFullYear();
    const month = String(d.getUTCMonth() + 1).padStart(2, '0');
    const day = String(d.getUTCDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  };

  // Funções auxiliares para gráficos modernos
  const showTooltip = (chart, content, event) => {
    const tooltip = $('#tooltip');
    if (!tooltip) return; // Adicionado para segurança
    tooltip.innerHTML = content;
    tooltip.classList.add('visible');
    
    const x = event.clientX;
    const y = event.clientY;
    
    const tooltipWidth = tooltip.offsetWidth;
    const tooltipHeight = tooltip.offsetHeight;
    
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    
    let left = x + 10;
    let top = y + 10;
    
    if (left + tooltipWidth > viewportWidth) {
      left = x - tooltipWidth - 10;
    }
    
    if (top + tooltipHeight > viewportHeight) {
      top = y - tooltipHeight - 10;
    }
    
    left = Math.max(10, left);
    top = Math.max(10, top);
    
    tooltip.style.left = `${left}px`;
    tooltip.style.top = `${top}px`;
  };

  const hideTooltip = () => {
    const tooltip = $('#tooltip');
    if (!tooltip) return; // Adicionado para segurança
    tooltip.classList.remove('visible');
  };

  const updateChartColors = () => {
    const isDarkTheme = document.documentElement.getAttribute('data-theme') === 'dark';
    const textColor = getComputedStyle(document.documentElement).getPropertyValue('--color-on-surface-variant').trim();
    const gridColor = isDarkTheme ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.05)';
    
    // Paleta de cores profissional moderna
    const chartColorsVibrant = [
      '#2563EB', '#10B981', '#F59E0B', '#8B5CF6', '#EC4899', 
      '#0EA5E9', '#F97316', '#14B8A6', '#6366F1', '#DC2626'
    ];
    
    // Cores com gradientes
    const createGradient = (ctx, colorStart, colorEnd) => {
      if (!ctx || !ctx.canvas) return colorStart; // Fallback se o contexto não estiver pronto
      const gradient = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
      gradient.addColorStop(0, colorStart);
      gradient.addColorStop(1, colorEnd);
      return gradient;
    };
    
    const incomeColor = getComputedStyle(document.documentElement).getPropertyValue('--color-income').trim();
    const expenseColor = getComputedStyle(document.documentElement).getPropertyValue('--color-expense').trim();
    
    // Configurações globais
    Chart.defaults.font.family = getComputedStyle(document.documentElement).getPropertyValue('--font-family').trim();
    Chart.defaults.color = textColor;
    Chart.defaults.borderColor = isDarkTheme ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
    Chart.defaults.plugins.tooltip.enabled = false; 
    Chart.defaults.elements.bar.borderRadius = 6;
    Chart.defaults.elements.line.tension = 0.4; 
    Chart.defaults.plugins.legend.display = false; 
    Chart.defaults.layout.padding = { top: 25, bottom: 35, left: 25, right: 25 };
    
    const getCtx = (chartInstance) => chartInstance.ctx;
    
    if (categoryExpensesChart) {
      const ctx = getCtx(categoryExpensesChart);
      categoryExpensesChart.data.datasets[0].backgroundColor = categoryExpensesChart.data.labels.map((_, i) => {
        const color = chartColorsVibrant[i % chartColorsVibrant.length];
        const lighterColor = isDarkTheme 
          ? color.replace(')', ', 0.6)').replace('rgb', 'rgba')
          : color.replace(')', ', 0.8)').replace('rgb', 'rgba');
        return createGradient(ctx, color, lighterColor);
      });
      categoryExpensesChart.data.datasets[0].borderColor = 'transparent';
      categoryExpensesChart.data.datasets[0].borderWidth = 0;
      categoryExpensesChart.data.datasets[0].borderRadius = 8;
      
      categoryExpensesChart.options.scales.y.ticks.color = textColor;
      categoryExpensesChart.options.scales.y.grid.color = gridColor;
      categoryExpensesChart.options.scales.y.ticks.padding = 10;
      categoryExpensesChart.options.scales.y.ticks.callback = function(value) {
        return formatCurrency(value);
      };
      
      categoryExpensesChart.options.scales.x.ticks.color = textColor;
      categoryExpensesChart.options.scales.x.grid.color = 'transparent';
      categoryExpensesChart.options.scales.x.ticks.padding = 10;
      
      categoryExpensesChart.update();
    }
    
    if (cardUsageDonutChart) {
      const usedColor = '#EF4444'; 
      const availableColor = '#22C55E'; 
      const baseColor = isDarkTheme ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)';
      
      cardUsageDonutChart.data.datasets[0].backgroundColor = [usedColor, availableColor, baseColor];
      cardUsageDonutChart.data.datasets[0].borderColor = isDarkTheme ? '#334155' : '#FFFFFF';
      cardUsageDonutChart.data.datasets[0].borderWidth = 3;
      cardUsageDonutChart.data.datasets[0].borderRadius = 5;
      cardUsageDonutChart.options.cutout = '65%';
      
      if (cardUsageDonutChart.data.datasets[0].data[0] !== undefined) {
        const used = cardUsageDonutChart.data.datasets[0].data[0];
        const totalForPercentage = cardUsageDonutChart.data.datasets[0].data.slice(0, 2).reduce((acc, val) => acc + val, 0); // Considera apenas usado + disponível para %
        
        if (totalForPercentage > 0) {
          const usedPercentage = Math.round((used / totalForPercentage) * 100);
          if ($('.limit-value')) $('.limit-value').textContent = `${usedPercentage}%`;
          
          if ($('.limit-value')) {
              if (usedPercentage > 80) {
                $('.limit-value').style.color = '#EF4444';
              } else if (usedPercentage > 60) {
                $('.limit-value').style.color = '#F59E0B';
              } else {
                $('.limit-value').style.color = getComputedStyle(document.documentElement).getPropertyValue('--color-on-surface').trim();
              }
          }
        } else {
             if ($('.limit-value')) {
                $('.limit-value').textContent = `0%`;
                $('.limit-value').style.color = getComputedStyle(document.documentElement).getPropertyValue('--color-on-surface').trim();
             }
        }
      }
      cardUsageDonutChart.update();
    }
    
    if (fixedVsVariableChart) {
      const fixedColor = '#2563EB'; 
      const variableColor = '#10B981'; 
      
      fixedVsVariableChart.data.datasets[0].backgroundColor = [fixedColor, variableColor];
      fixedVsVariableChart.data.datasets[0].borderColor = isDarkTheme ? '#334155' : '#FFFFFF';
      fixedVsVariableChart.data.datasets[0].borderWidth = 3;
      
      fixedVsVariableChart.update();
    }
    
    if (personAnalysisChart) {
      const ctx = getCtx(personAnalysisChart);
      personAnalysisChart.data.datasets[0].backgroundColor = personAnalysisChart.data.labels.map((_, i) => {
        const baseColor = chartColorsVibrant[i % chartColorsVibrant.length];
        return createGradient(ctx, baseColor, baseColor.replace(')', ', 0.7)').replace('rgb', 'rgba'));
      });
      personAnalysisChart.data.datasets[0].borderColor = 'transparent';
      personAnalysisChart.data.datasets[0].borderWidth = 0;
      personAnalysisChart.data.datasets[0].borderRadius = 8;
      
      personAnalysisChart.options.scales.x.ticks.color = textColor;
      personAnalysisChart.options.scales.x.grid.color = gridColor;
      personAnalysisChart.options.scales.x.ticks.padding = 10;
      personAnalysisChart.options.scales.x.ticks.callback = function(value) {
        return formatCurrency(value);
      };
      
      personAnalysisChart.options.scales.y.ticks.color = textColor;
      personAnalysisChart.options.scales.y.grid.color = 'transparent';
      personAnalysisChart.options.scales.y.ticks.padding = 10;
      
      personAnalysisChart.update();
    }
    
    if (annualBarsChart) {
      const ctx = getCtx(annualBarsChart);
      
      const incomeGradient = createGradient(ctx, 
        incomeColor, 
        incomeColor.replace(')', ', 0.7)').replace('rgb', 'rgba')
      );
      
      const expenseGradient = createGradient(ctx, 
        expenseColor, 
        expenseColor.replace(')', ', 0.7)').replace('rgb', 'rgba')
      );
      
      annualBarsChart.data.datasets[0].backgroundColor = incomeGradient;
      annualBarsChart.data.datasets[0].borderColor = 'transparent';
      annualBarsChart.data.datasets[0].borderWidth = 0;
      annualBarsChart.data.datasets[0].borderRadius = 6;
      
      annualBarsChart.data.datasets[1].backgroundColor = expenseGradient;
      annualBarsChart.data.datasets[1].borderColor = 'transparent';
      annualBarsChart.data.datasets[1].borderWidth = 0;
      annualBarsChart.data.datasets[1].borderRadius = 6;
      
      annualBarsChart.options.scales.y.ticks.color = textColor;
      annualBarsChart.options.scales.y.grid.color = gridColor;
      annualBarsChart.options.scales.y.ticks.padding = 10;
      annualBarsChart.options.scales.y.ticks.callback = function(value) {
        return formatCurrency(value);
      };
      
      annualBarsChart.options.scales.x.ticks.color = textColor;
      annualBarsChart.options.scales.x.grid.color = 'transparent';
      annualBarsChart.options.scales.x.ticks.padding = 10;
      
      annualBarsChart.update();
    }
    
    const legendItems = $$('.chart-legend-item');
    legendItems.forEach(item => {
      if (isDarkTheme) {
        item.style.backgroundColor = 'rgba(46, 46, 54, 0.9)';
      } else {
        item.style.backgroundColor = 'rgba(241, 245, 249, 0.9)';
      }
      // Atualizar a cor do span.chart-legend-color também se necessário
      const colorSpan = item.querySelector('.chart-legend-color');
      if (colorSpan) {
          if (item.textContent.includes('Receitas')) {
              colorSpan.style.backgroundColor = 'var(--color-income)';
          } else if (item.textContent.includes('Despesas')) {
              colorSpan.style.backgroundColor = 'var(--color-expense)';
          }
      }
    });
  };


  const toggleTheme = () => {
    const newTheme = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', newTheme);
    state.themePreference = newTheme;
    localStorage.setItem('themePreference', newTheme);
    updateChartColors();
  };

  const initTheme = () => {
    const savedTheme = localStorage.getItem('themePreference') || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    document.documentElement.setAttribute('data-theme', savedTheme);
    state.themePreference = savedTheme;
    $('#themeToggle').addEventListener('click', toggleTheme);
  };

    const firebaseConfig = {
      apiKey: "AIzaSyD9Q0TO8JVj9XN8gANWFndbRQ6QMUVkURs",
      authDomain: "sistema-financeiro-teste.firebaseapp.com",
      projectId: "sistema-financeiro-teste",
      storageBucket: "sistema-financeiro-teste.firebasestorage.app",
      messagingSenderId: "177026780096",
      appId: "1:177026780096:web:c1fcf41675036b2f3f9625"
    };

  let db;
  try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    db.enablePersistence({experimentalForceOwningTab: true}).catch(err => console.warn('Firebase persistence error:', err.code));
    console.log('Firebase inicializado.');
  } catch (error) {
    console.error('Erro Firebase:', error);
    showToast('Erro de conexão com o Firebase.', 'error');
    db = { collection: () => ({ get: () => Promise.resolve({ docs: [], empty: true }), doc: () => ({ get: () => Promise.resolve({ exists: false, data: () => ({}) }), set: () => Promise.resolve(), update: () => Promise.resolve(), delete: () => Promise.resolve() }), add: () => Promise.resolve({ id: 'temp-id' }) }) };
  }

  const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

  const showToast = (message, type = 'success') => {
    const container = $('#toastContainer');
    if (!container) return;
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    let iconName = type === 'success' ? 'icon-check' : type === 'error' ? 'icon-x' : type === 'warning' ? 'icon-alert' : 'icon-info';
    toast.innerHTML = `<div class="toast-icon"><svg width="24" height="24"><use href="#${iconName}"></use></svg></div><div class="toast-content">${message}</div><button class="toast-close" aria-label="Fechar"><svg width="16" height="16"><use href="#icon-x"></use></svg></button>`;
    container.appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 10);
    toast.querySelector('.toast-close').addEventListener('click', () => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    });
    setTimeout(() => {
      if (toast.parentNode) {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }
    }, 5000);
  };

  const openModal = modalId => {
    const modal = $(`#${modalId}`);
    if (modal) {
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }
  };
  const closeModal = modalId => {
    const modal = $(`#${modalId}`);
    if (modal) {
      modal.classList.remove('active');
      if (!$$('.modal-backdrop.active').length) { 
        document.body.style.overflow = '';
      }
    }
  };
  const closeAllModals = () => {
    $$('.modal-backdrop.active').forEach(modal => closeModal(modal.id));
  };

  const setDateInputValue = (inputId, date) => {
    const input = $(`#${inputId}`);
    if (input) input.value = localDateToISOString(date);
  };
  const getDateInputValue = inputId => {
    const input = $(`#${inputId}`);
    return input && input.value ? parseLocalDateString(input.value) : null;
  };

  const updateYearOptions = () => {
    const yearSelect = $('#yearSelect');
    if (yearSelect) {
      yearSelect.innerHTML = '';
      const currentYear = new Date().getFullYear();
      for (let year = currentYear - 2; year <= currentYear + 5; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        option.selected = year === state.year;
        yearSelect.appendChild(option);
      }
    }
  };

  const calcularVencimentoReal = (dataCompraInput, cartao) => {
    if (!dataCompraInput || !cartao || !cartao.closingDay || !cartao.dueDay) return null;
    
    const compraDate = parseLocalDateString(dataCompraInput);
    if (!compraDate) return null;

    const compraDay = compraDate.getUTCDate();
    let mesFechamentoFatura = compraDate.getUTCMonth(); 
    let anoFechamentoFatura = compraDate.getUTCFullYear();

    if (compraDay > cartao.closingDay) {
        mesFechamentoFatura++;
        if (mesFechamentoFatura > 11) {
            mesFechamentoFatura = 0;
            anoFechamentoFatura++;
        }
    }

    let mesVencimentoFinal = mesFechamentoFatura;
    let anoVencimentoFinal = anoFechamentoFatura;

    if (cartao.dueDay < cartao.closingDay) {
        mesVencimentoFinal++;
        if (mesVencimentoFinal > 11) {
            mesVencimentoFinal = 0;
            anoVencimentoFinal++;
        }
    }
    return new Date(Date.UTC(anoVencimentoFinal, mesVencimentoFinal, cartao.dueDay));
  };
  
  const calcularMelhorDiaCompras = (cartao) => {
    if (!cartao || !cartao.closingDay) return null;
    const dataFechamentoNoMesAtual = new Date(Date.UTC(state.year, state.month, cartao.closingDay));
    const dataMelhorDia = new Date(dataFechamentoNoMesAtual);
    dataMelhorDia.setUTCDate(dataFechamentoNoMesAtual.getUTCDate() + 1);
    return dataMelhorDia.getUTCDate();
  };

  const handleStatusField = (formPrefix) => {
    const paymentMethodEl = $(`#${formPrefix}PaymentMethod`);
    const isRecurrentEl = $(`#${formPrefix}IsRecurrent`);
    const statusGroupEl = $(`#${formPrefix}StatusGroup`);
    const statusPendingRadio = $(`#${formPrefix}StatusPending`); 

    if (!paymentMethodEl || !statusGroupEl || !statusPendingRadio) return;
    
    const isCreditCard = paymentMethodEl.value === 'credito';
    const isRecurrent = isRecurrentEl ? isRecurrentEl.checked : false;

    if (isCreditCard || (isRecurrent && formPrefix.includes('expense'))) { 
        statusGroupEl.style.display = 'none';
        statusPendingRadio.checked = true;
    } else if (isRecurrent && formPrefix.includes('income')) { 
        statusGroupEl.style.display = 'none';
        statusPendingRadio.checked = true; 
    } else {
        statusGroupEl.style.display = 'block'; 
    }
  };

  async function updateCardLimits(cardId, transactionAmount, operation, oldTransactionAmount = 0) {
    const card = state.cards.find(c => c.id === cardId);
    if (!card) return;

    let amountChange = 0;
    if (operation === 'add') {
        amountChange = transactionAmount;
    } else if (operation === 'subtract') {
        amountChange = -transactionAmount;
    } else if (operation === 'update') {
        amountChange = transactionAmount - oldTransactionAmount;
    }

    card.currentInvoice = (card.currentInvoice || 0) + amountChange;
    card.currentInvoice = Math.max(0, card.currentInvoice); 
    card.availableLimit = card.limit - card.currentInvoice;

    try {
        await db.collection('cards').doc(card.id).update({
            currentInvoice: card.currentInvoice, 
            availableLimit: card.availableLimit
        });
    } catch (error) {
        console.error("Error updating card limits in DB:", error);
        showToast('Erro ao atualizar limite do cartão.', 'error');
    }
    updateCreditCardSelects();
  }


  const loadCategoriesAndPaymentMethods = async () => {
    try {
      const collectionsToLoad = [
        { name: 'categories', stateKey: 'categories', defaultKey: true, typeField: 'type' },
        { name: 'paymentMethods', stateKey: 'paymentMethods', defaultKey: false },
        { name: 'people', stateKey: 'people', defaultKey: false }
      ];

      for (const coll of collectionsToLoad) {
        const snapshot = await db.collection(coll.name).get();
        if (!snapshot.empty) {
          if (coll.defaultKey) { 
            state[coll.stateKey].income = [];
            state[coll.stateKey].expense = [];
            state[coll.stateKey].investment = [];
            snapshot.docs.forEach(doc => {
              const item = { id: doc.id, ...doc.data() };
              if (item[coll.typeField] === 'income') state[coll.stateKey].income.push(item);
              else if (item[coll.typeField] === 'expense') state[coll.stateKey].expense.push(item);
              else if (item[coll.typeField] === 'investment') state[coll.stateKey].investment.push(item);
            });
          } else {
            state[coll.stateKey] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          }
        } else if (state[coll.stateKey]) { 
          const batch = db.batch();
          if (coll.defaultKey) {
            Object.values(state[coll.stateKey]).flat().forEach(item => {
              const docRef = db.collection(coll.name).doc(item.id);
              batch.set(docRef, item); 
            });
          } else {
            state[coll.stateKey].forEach(item => {
              const docRef = db.collection(coll.name).doc(item.id);
              batch.set(docRef, item);
            });
          }
          await batch.commit();
        }
      }
      updateAllSelectsAndLists();
    } catch (error) {
      console.error('Erro ao carregar dados iniciais:', error);
      showToast('Erro ao carregar dados. Tente novamente.', 'error');
    }
  };
  
  const updateAllSelectsAndLists = () => {
    updateCategorySelects();
    updatePaymentMethodSelects();
    updatePeopleSelects();
    updateInvestmentCategorySelects(); 
    renderCategoriesList(); 
    renderPaymentMethodsList();
    renderInvestmentCategoriesList();
    updatePeopleList();
  };

  const updateCategorySelects = () => {
    const populateSelect = (selectEl, categories) => {
      if (selectEl) {
        const currentValue = selectEl.value;
        selectEl.innerHTML = '<option value="">Selecione...</option>';
        categories.forEach(category => {
          const option = document.createElement('option');
          option.value = category.id;
          option.textContent = `${category.icon || ''} ${category.name}`; 
          selectEl.appendChild(option);
        });
        if (categories.find(c => c.id === currentValue)) {
            selectEl.value = currentValue;
        }
      }
    };
    populateSelect($('#incomeCategory'), state.categories.income);
    populateSelect($('#expenseCategory'), state.categories.expense);
    
    const editCategorySelect = $('#editCategory');
    if (editCategorySelect && state.currentTransaction) {
        const categories = state.currentTransaction.type === 'income' ? state.categories.income : state.categories.expense;
        populateSelect(editCategorySelect, categories);
        editCategorySelect.value = state.currentTransaction.category;
    }
  };

  const updatePaymentMethodSelects = () => {
    const selects = [$('#incomePaymentMethod'), $('#expensePaymentMethod'), $('#editPaymentMethod')];
    selects.forEach(selectEl => {
      if (selectEl) {
        const currentValue = selectEl.value;
        selectEl.innerHTML = '<option value="">Selecione...</option>';
        state.paymentMethods.forEach(method => {
          const option = document.createElement('option');
          option.value = method.id;
          option.textContent = `${method.icon || ''} ${method.name}`;
          selectEl.appendChild(option);
        });
         if (state.paymentMethods.find(m => m.id === currentValue)) {
            selectEl.value = currentValue;
        }
      }
    });
  };

  const updatePeopleSelects = () => {
    const selects = [$('#expensePerson'), $('#editPerson')];
    selects.forEach(selectEl => {
      if (selectEl) {
        const currentValue = selectEl.value;
        selectEl.innerHTML = '<option value="">Ninguém</option>'; 
        state.people.forEach(person => {
          const option = document.createElement('option');
          option.value = person.id;
          option.textContent = `${person.icon || ''} ${person.name}`;
          selectEl.appendChild(option);
        });
        if (state.people.find(p => p.id === currentValue)) {
            selectEl.value = currentValue;
        }
      }
    });
  };

  const updateInvestmentCategorySelects = () => {
    const selectEl = $('#investmentCategorySelect'); 
    if (selectEl) {
        const currentValue = selectEl.value;
        selectEl.innerHTML = '<option value="">Selecione...</option>';
        state.categories.investment.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = `${category.icon || ''} ${category.name}`;
            selectEl.appendChild(option);
        });
        if (state.categories.investment.find(c => c.id === currentValue)) {
            selectEl.value = currentValue;
        }
    }
  };


  const loadCards = async () => {
    try {
      const snapshot = await db.collection('cards').get();
      state.cards = snapshot.docs.map(doc => {
          const card = { id: doc.id, ...doc.data() };
          card.currentInvoice = card.currentInvoice || 0; 
          card.availableLimit = card.limit - card.currentInvoice;
          return card;
      });
      updateCardsList();
      updateCreditCardSelects();
    } catch (error) {
      console.error('Erro ao carregar cartões:', error);
      showToast('Erro ao carregar cartões.', 'error');
    }
  };

  const addCard = async (cardData) => {
    try {
      const card = {
        ...cardData,
        currentInvoice: 0, 
        availableLimit: cardData.limit, 
        createdAt: localDateToISOString(new Date())
      };
      const docRef = await db.collection('cards').add(card);
      card.id = docRef.id;
      state.cards.push(card);
      await fullUIRefresh(); 
      showToast('Cartão adicionado!', 'success');
    } catch (error) {
      console.error('Erro ao adicionar cartão:', error);
      showToast('Erro ao adicionar cartão.', 'error');
    }
  };

  const updateCard = async (cardId, updates) => {
    try {
      if (updates.limit !== undefined) {
        const card = state.cards.find(c => c.id === cardId);
        if (card) {
            updates.availableLimit = updates.limit - (card.currentInvoice || 0);
        }
      }
      await db.collection('cards').doc(cardId).update(updates);
      const index = state.cards.findIndex(c => c.id === cardId);
      if (index !== -1) state.cards[index] = { ...state.cards[index], ...updates };
      await fullUIRefresh(); 
      showToast('Cartão atualizado!', 'success');
    } catch (error) {
      console.error('Erro ao atualizar cartão:', error);
      showToast('Erro ao atualizar cartão.', 'error');
    }
  };

  const deleteCard = async (cardId) => {
    try {
      if (!confirm('Tem certeza que deseja excluir este cartão? Transações associadas não serão alteradas, mas perderão o vínculo com este cartão.')) return;

      await db.collection('cards').doc(cardId).delete();
      state.cards = state.cards.filter(c => c.id !== cardId);
      const batch = db.batch();
      let changed = false;
      state.transactions.forEach(t => {
        if (t.creditCardId === cardId) {
            batch.update(db.collection('transactions').doc(t.id), { creditCardId: null, creditCardName: null });
            t.creditCardId = null; t.creditCardName = null;
            changed = true;
        }
      });
      if (changed) await batch.commit();

      await fullUIRefresh(); 
      showToast('Cartão excluído!', 'success');
    } catch (error) {
      console.error('Erro ao excluir cartão:', error);
      showToast('Erro ao excluir cartão.', 'error');
    }
  };

  const payCardInvoice = async (cardId) => {
    try {
      const card = state.cards.find(c => c.id === cardId);
      if (!card) return;

      const faturaVencimentoRef = new Date(Date.UTC(state.year, state.month, card.dueDay));
      const { previousClosing, currentClosingDate } = getInvoicePeriod(card, faturaVencimentoRef);

      const batch = db.batch();
      let totalFaturaPagaEsteMes = 0;

      state.transactions.forEach(t => {
        if (t.type === 'expense' && t.paymentMethod === 'credito' && t.creditCardId === cardId) {
          const dataCompra = parseLocalDateString(t.date);
          if (dataCompra >= previousClosing && dataCompra < currentClosingDate && t.status !== 'paid') {
            const docRef = db.collection('transactions').doc(t.id);
            batch.update(docRef, { status: 'paid' });
            t.status = 'paid'; 
            totalFaturaPagaEsteMes += parseFloat(t.amount);
          }
        }
      });
      
      if (totalFaturaPagaEsteMes > 0) {
        card.currentInvoice = Math.max(0, (card.currentInvoice || 0) - totalFaturaPagaEsteMes);
        card.availableLimit = card.limit - card.currentInvoice;
        batch.update(db.collection('cards').doc(card.id), {
            currentInvoice: card.currentInvoice,
            availableLimit: card.availableLimit
        });
      }
      
      await batch.commit();
      await fullUIRefresh(); 
      closeModal('payInvoiceConfirmModal');
      showToast('Fatura paga com sucesso!', 'success');
    } catch (error) {
      console.error('Erro ao pagar fatura:', error);
      showToast('Erro ao pagar fatura.', 'error');
    }
  };

  const updateCreditCardSelects = () => {
    const selects = [$('#expenseCreditCard'), $('#editCreditCard')];
    selects.forEach(selectEl => {
      if (selectEl) {
        const currentValue = selectEl.value;
        selectEl.innerHTML = '';
        if (state.cards.length === 0) {
          selectEl.innerHTML = '<option value="" disabled selected>Nenhum cartão</option>';
        } else {
          selectEl.innerHTML = '<option value="">Selecione o cartão...</option>';
          state.cards.forEach(card => {
            const option = document.createElement('option');
            option.value = card.id;
            option.textContent = `${card.name} (Disp: ${formatCurrency(card.availableLimit)})`;
            selectEl.appendChild(option);
          });
        }
        if (state.cards.find(c => c.id === currentValue)) {
            selectEl.value = currentValue;
        }
      }
    });
  };
  
  const loadInvestments = async () => {
    try {
      const [invSnapshot, contribSnapshot] = await Promise.all([
        db.collection('investments').get(),
        db.collection('investmentContributions').get()
      ]);
      state.investments = invSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      state.investmentContributions = contribSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderInvestmentCards();
    } catch (error) {
      console.error('Erro ao carregar investimentos:', error);
      showToast('Erro ao carregar investimentos.', 'error');
    }
  };

  const renderInvestmentCards = () => {
    const grid = $('#investmentsGrid');
    if (!grid) return;
    grid.innerHTML = '';
    if (state.investments.length === 0) {
      grid.innerHTML = '<p style="text-align: center; padding: var(--spacing-md);">Nenhum investimento.</p>';
      return;
    }
    state.investments.forEach(inv => {
      const contributions = state.investmentContributions.filter(c => c.investmentId === inv.id);
      const totalContributed = contributions.reduce((sum, c) => sum + parseFloat(c.amount), 0) + parseFloat(inv.amount || 0);
      const category = state.categories.investment.find(c => c.id === inv.category);
      const hasGoal = inv.goal && parseFloat(inv.goal) > 0;
      const progress = hasGoal ? Math.min(100, (totalContributed / parseFloat(inv.goal)) * 100) : 0;

      const cardEl = document.createElement('div');
      cardEl.className = 'investment-card'; 
      cardEl.dataset.id = inv.id;
      cardEl.innerHTML = `
        <div class="investment-card-header">
          <h3 class="investment-card-title">${inv.name}</h3>
          <span class="badge" style="font-size: var(--font-size-xs);">${category ? `${category.icon} ${category.name}` : 'N/A'}</span>
        </div>
        <div class="investment-card-body">
          <div>Guardado: <strong>${formatCurrency(totalContributed)}</strong></div>
          ${hasGoal ? `<div>Meta: <strong>${formatCurrency(inv.goal)}</strong></div>` : ''}
          ${hasGoal ? `
            <div class="investment-progress">
              <div class="investment-progress-bar"><div class="investment-progress-fill" style="width: ${progress.toFixed(0)}%;"></div></div>
              <div class="investment-progress-text"><span>${progress.toFixed(0)}%</span> ${inv.targetDate ? `<span>Até: ${formatDate(inv.targetDate)}</span>` : ''}</div>
            </div>` : ''}
        </div>
        <div class="investment-card-footer">
          <small>Criado em: ${formatDate(inv.createdAt)}</small>
          <div>
            <button class="btn btn-icon btn-outline edit-investment-btn" aria-label="Editar"><svg width="16" height="16"><use href="#icon-edit"></use></svg></button>
            <button class="btn btn-icon btn-outline delete-investment-btn" aria-label="Excluir"><svg width="16" height="16"><use href="#icon-trash"></use></svg></button>
          </div>
        </div>`;
      cardEl.addEventListener('click', (e) => {
        if (!e.target.closest('.edit-investment-btn') && !e.target.closest('.delete-investment-btn')) {
          openInvestmentDetail(inv.id);
        }
      });
      grid.appendChild(cardEl);
    });
    $$('#investmentsGrid .edit-investment-btn').forEach(btn => btn.addEventListener('click', (e) => {
        e.stopPropagation(); openEditInvestmentModal(e.currentTarget.closest('.investment-card').dataset.id);
    }));
    $$('#investmentsGrid .delete-investment-btn').forEach(btn => btn.addEventListener('click', (e) => {
        e.stopPropagation(); if (confirm('Excluir este investimento e todos os aportes?')) deleteInvestment(e.currentTarget.closest('.investment-card').dataset.id);
    }));
  };
  
  const openInvestmentDetail = (investmentId) => {
    const investment = state.investments.find(i => i.id === investmentId);
    if (!investment) return;
    state.currentInvestment = investment;
    const contributions = state.investmentContributions.filter(c => c.investmentId === investment.id);
    const totalContributed = contributions.reduce((sum, c) => sum + parseFloat(c.amount), 0) + parseFloat(investment.amount || 0);
    const category = state.categories.investment.find(c => c.id === investment.category);
    const hasGoal = investment.goal && parseFloat(investment.goal) > 0;
    const progress = hasGoal ? Math.min(100, (totalContributed / parseFloat(investment.goal)) * 100) : 0;

    $('#investmentDetailName').textContent = investment.name;
    $('#investmentDetailSaved').textContent = formatCurrency(totalContributed);
    $('#investmentDetailGoal').textContent = hasGoal ? formatCurrency(investment.goal) : 'N/A';
    $('#investmentDetailProgress').textContent = hasGoal ? `${progress.toFixed(0)}%` : 'N/A';
    $('#investmentDetailCategory').textContent = category ? `${category.icon} ${category.name}` : 'N/A';
    $('#investmentDetailCreatedAt').textContent = formatDate(investment.createdAt);
    $('#investmentDetailTarget').textContent = investment.targetDate ? formatDate(investment.targetDate) : 'N/A';
    $('#investmentDetailNotes').textContent = investment.notes || '-';
    renderInvestmentContributions(investmentId);
    closeModal('investmentsModal');
    openModal('investmentDetailModal');
  };

  const renderInvestmentContributions = (investmentId) => {
    const tableBody = $('#investmentHistoryTableBody');
    if (!tableBody) return;
    tableBody.innerHTML = '';
    const investment = state.investments.find(i => i.id === investmentId);
    let allContributions = [];
    if (investment && parseFloat(investment.amount) > 0) {
        allContributions.push({ id: 'initial', date: investment.createdAt, amount: investment.amount, description: 'Depósito inicial', isInitial: true });
    }
    allContributions = allContributions.concat(state.investmentContributions.filter(c => c.investmentId === investmentId));
    allContributions.sort((a, b) => parseLocalDateString(b.date) - parseLocalDateString(a.date));

    if (allContributions.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhum aporte.</td></tr>';
      return;
    }
    allContributions.forEach(c => {
      const row = tableBody.insertRow();
      row.innerHTML = `
        <td>${formatDate(c.date)}</td>
        <td>${formatCurrency(c.amount)}</td>
        <td>${c.description || '-'}</td>
        <td class="actions-cell">
          ${c.isInitial ? '-' : `
            <button class="btn btn-icon btn-outline edit-contribution-btn" data-id="${c.id}" aria-label="Editar"><svg width="16" height="16"><use href="#icon-edit"></use></svg></button>
            <button class="btn btn-icon btn-outline delete-contribution-btn" data-id="${c.id}" aria-label="Excluir"><svg width="16" height="16"><use href="#icon-trash"></use></svg></button>
          `}
        </td>`;
    });
    $$('#investmentHistoryTableBody .edit-contribution-btn').forEach(btn => btn.addEventListener('click', (e) => openEditContributionModal(e.currentTarget.dataset.id)));
    $$('#investmentHistoryTableBody .delete-contribution-btn').forEach(btn => btn.addEventListener('click', (e) => { if (confirm('Excluir este aporte?')) deleteContribution(e.currentTarget.dataset.id); }));
  };

  const addInvestment = async (data) => {
    try {
      const investment = { ...data, createdAt: localDateToISOString(new Date()) };
      const docRef = await db.collection('investments').add(investment);
      investment.id = docRef.id;
      state.investments.push(investment);
      await fullUIRefresh(); 
      showToast('Investimento adicionado!', 'success');
      return investment;
    } catch (e) { console.error(e); showToast('Erro ao adicionar investimento.', 'error'); return null; }
  };
  const updateInvestment = async (id, data) => {
    try {
      await db.collection('investments').doc(id).update(data);
      const index = state.investments.findIndex(i => i.id === id);
      if (index !== -1) state.investments[index] = { ...state.investments[index], ...data };
      await fullUIRefresh(); 
      showToast('Investimento atualizado!', 'success'); return true;
    } catch (e) { console.error(e); showToast('Erro ao atualizar investimento.', 'error'); return false; }
  };
  const deleteInvestment = async (id) => {
    try {
      const batch = db.batch();
      batch.delete(db.collection('investments').doc(id));
      state.investmentContributions.filter(c => c.investmentId === id).forEach(c => batch.delete(db.collection('investmentContributions').doc(c.id)));
      await batch.commit();
      state.investments = state.investments.filter(i => i.id !== id);
      state.investmentContributions = state.investmentContributions.filter(c => c.investmentId !== id);
      await fullUIRefresh(); 
      if ($('#investmentDetailModal').classList.contains('active') && state.currentInvestment?.id === id) {
        closeModal('investmentDetailModal');
        openModal('investmentsModal');
      }
      showToast('Investimento excluído!', 'success');
    } catch (e) { console.error(e); showToast('Erro ao excluir investimento.', 'error'); }
  };
  const addContribution = async (data) => {
    try {
      const contribution = { ...data, createdAt: localDateToISOString(new Date()) };
      const docRef = await db.collection('investmentContributions').add(contribution);
      contribution.id = docRef.id;
      state.investmentContributions.push(contribution);
      await fullUIRefresh(); 
      if ($('#investmentDetailModal').classList.contains('active') && state.currentInvestment?.id === data.investmentId) {
        renderInvestmentContributions(data.investmentId); 
        openInvestmentDetail(data.investmentId); 
      }
      showToast('Aporte adicionado!', 'success'); return contribution;
    } catch (e) { console.error(e); showToast('Erro ao adicionar aporte.', 'error'); return null; }
  };
  const updateContribution = async (id, data) => {
    try {
      await db.collection('investmentContributions').doc(id).update(data);
      const index = state.investmentContributions.findIndex(c => c.id === id);
      if (index !== -1) state.investmentContributions[index] = { ...state.investmentContributions[index], ...data };
      await fullUIRefresh(); 
      if ($('#investmentDetailModal').classList.contains('active') && state.currentInvestment?.id === data.investmentId) {
        renderInvestmentContributions(data.investmentId);
        openInvestmentDetail(data.investmentId);
      }
      showToast('Aporte atualizado!', 'success'); return true;
    } catch (e) { console.error(e); showToast('Erro ao atualizar aporte.', 'error'); return false; }
  };
  const deleteContribution = async (id) => {
    try {
      const contribToDelete = state.investmentContributions.find(c => c.id === id);
      if (!contribToDelete) return;
      await db.collection('investmentContributions').doc(id).delete();
      state.investmentContributions = state.investmentContributions.filter(c => c.id !== id);
      await fullUIRefresh(); 
      if ($('#investmentDetailModal').classList.contains('active') && state.currentInvestment?.id === contribToDelete.investmentId) {
        renderInvestmentContributions(contribToDelete.investmentId);
        openInvestmentDetail(contribToDelete.investmentId);
      }
      showToast('Aporte excluído!', 'success');
    } catch (e) { console.error(e); showToast('Erro ao excluir aporte.', 'error'); }
  };

  const openNewInvestmentModal = () => {
    $('#investmentForm').reset();
    setDateInputValue('investmentTargetDate', new Date());
    $('#newInvestmentModalTitle').textContent = 'Novo Investimento';
    $('#saveInvestmentBtn').textContent = 'Salvar Investimento';
    $('#saveInvestmentBtn').dataset.action = 'add';
    $('#saveInvestmentBtn').removeAttribute('data-id');
    updateInvestmentCategorySelects(); 
    closeModal('investmentsModal'); 
    openModal('newInvestmentModal');
  };
  const openEditInvestmentModal = (id) => {
    const inv = state.investments.find(i => i.id === id);
    if (!inv) return;
    state.currentInvestment = inv;
    $('#investmentName').value = inv.name;
    $('#investmentAmount').value = inv.amount || 0;
    $('#investmentGoal').value = inv.goal || '';
    updateInvestmentCategorySelects(); 
    $('#investmentCategorySelect').value = inv.category || '';
    if (inv.targetDate) setDateInputValue('investmentTargetDate', inv.targetDate); else $('#investmentTargetDate').value = '';
    $('#investmentNotes').value = inv.notes || '';
    $('#newInvestmentModalTitle').textContent = 'Editar Investimento';
    $('#saveInvestmentBtn').textContent = 'Atualizar Investimento';
    $('#saveInvestmentBtn').dataset.action = 'update';
    $('#saveInvestmentBtn').dataset.id = id;
    closeModal('investmentDetailModal'); 
    openModal('newInvestmentModal');
  };
  const openNewContributionModal = () => {
    $('#contributionForm').reset();
    setDateInputValue('contributionDate', new Date());
    $('#contributionInvestmentId').value = state.currentInvestment?.id || '';
    $('#newContributionModalTitle').textContent = 'Adicionar Novo Valor';
    $('#saveContributionBtn').textContent = 'Adicionar';
    $('#saveContributionBtn').dataset.action = 'add';
    $('#saveContributionBtn').removeAttribute('data-id');
    openModal('newContributionModal');
  };
  const openEditContributionModal = (id) => {
    const contrib = state.investmentContributions.find(c => c.id === id);
    if (!contrib) return;
    state.currentContribution = contrib;
    $('#contributionInvestmentId').value = contrib.investmentId;
    $('#contributionAmount').value = contrib.amount;
    setDateInputValue('contributionDate', contrib.date);
    $('#contributionDescription').value = contrib.description || '';
    $('#newContributionModalTitle').textContent = 'Editar Aporte';
    $('#saveContributionBtn').textContent = 'Atualizar';
    $('#saveContributionBtn').dataset.action = 'update';
    $('#saveContributionBtn').dataset.id = id;
    openModal('newContributionModal');
  };

  const loadTransactions = async () => {
    try {
      const snapshot = await db.collection('transactions').get();
      state.transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      await fullUIRefresh(); 
    } catch (error) {
      console.error('Erro ao carregar transações:', error);
      showToast('Erro ao carregar transações.', 'error');
    }
  };

  const getInvoicePeriod = (card, invoiceDueDateRef) => {
    const refDate = parseLocalDateString(invoiceDueDateRef);
    if (!refDate || !card) return { previousClosing: null, currentClosingDate: null };

    let closingDay = card.closingDay;
    let dueDay = card.dueDay;

    let currentClosingYear = refDate.getUTCFullYear();
    let currentClosingMonth = refDate.getUTCMonth(); 

    if (dueDay >= closingDay) {
        currentClosingMonth--;
        if (currentClosingMonth < 0) {
            currentClosingMonth = 11;
            currentClosingYear--;
        }
    }
    const currentClosingDate = new Date(Date.UTC(currentClosingYear, currentClosingMonth, closingDay));
    
    let previousClosingMonth = currentClosingMonth - 1;
    let previousClosingYear = currentClosingYear;
    if (previousClosingMonth < 0) {
        previousClosingMonth = 11;
        previousClosingYear--;
    }
    const previousClosing = new Date(Date.UTC(previousClosingYear, previousClosingMonth, closingDay));
    
    return { previousClosing, currentClosingDate }; 
  };


  const filterTransactionsByMonth = () => {
    state.filteredTransactions = state.transactions.filter(transaction => {
        const transactionLaunchDate = parseLocalDateString(transaction.date); 
        if (!transactionLaunchDate) return false;

        let effectiveDateForFilter = transactionLaunchDate;

        if (transaction.type === 'expense') { 
            if (transaction.paymentMethod === 'credito' && transaction.creditCardId) {
                const card = state.cards.find(c => c.id === transaction.creditCardId);
                if (card) {
                    const realDueDate = calcularVencimentoReal(transactionLaunchDate, card);
                    if (realDueDate) effectiveDateForFilter = realDueDate;
                }
            } else if (transaction.dueDate) { 
                const explicitDueDate = parseLocalDateString(transaction.dueDate);
                if (explicitDueDate) effectiveDateForFilter = explicitDueDate;
            }
        }
        
        return effectiveDateForFilter.getUTCMonth() === state.month && 
               effectiveDateForFilter.getUTCFullYear() === state.year;
    });
  };


  const updateMonthYearTitle = () => {
    // O título agora é implícito pelos selects de ano/mês
  };

  const updateKPIs = () => {
    filterTransactionsByMonth(); 
    const currentMonthTransactions = state.filteredTransactions;

    const totalIncome = currentMonthTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount), 0);
    const totalExpense = currentMonthTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount), 0);
    const incomeReceived = currentMonthTransactions.filter(t => t.type === 'income' && t.status === 'received').reduce((sum, t) => sum + parseFloat(t.amount), 0);
    const incomePending = totalIncome - incomeReceived;
    const expensePaid = currentMonthTransactions.filter(t => t.type === 'expense' && t.status === 'paid').reduce((sum, t) => sum + parseFloat(t.amount), 0);
    const expensePending = totalExpense - expensePaid;

    const saldoReal = incomeReceived - expensePaid;
    const saldoComprometido = totalIncome - totalExpense;

    $('#incomeValue').textContent = formatCurrency(totalIncome);
    $('#expenseValue').textContent = formatCurrency(totalExpense); 
    $('#balanceValue').textContent = formatCurrency(saldoReal);
    if($('.kpi-balance .kpi-subtitle span')) $('.kpi-balance .kpi-subtitle span').textContent = `Saldo comprometido: ${formatCurrency(saldoComprometido)}`;
    $('#incomeReceivedValue').textContent = `${formatCurrency(incomeReceived)} recebidos`;
    $('#incomePendingValue').textContent = `${formatCurrency(incomePending)} pendentes`;
    $('#expensePaidValue').textContent = `${formatCurrency(expensePaid)} pagos`;
    $('#expensePendingValue').textContent = `${formatCurrency(expensePending)} pendentes`;

    let totalCardDueThisMonth = 0; 
    let earliestCardDueDateThisMonth = null; 

    state.transactions.forEach(t => {
        if (t.type === 'expense' && t.paymentMethod === 'credito') {
            const effectiveDueDate = getEffectiveDueDateForSort(t); 
            if (effectiveDueDate &&
                effectiveDueDate.getUTCMonth() === state.month &&
                effectiveDueDate.getUTCFullYear() === state.year) {
                totalCardDueThisMonth += parseFloat(t.amount);
                if (!earliestCardDueDateThisMonth || effectiveDueDate < earliestCardDueDateThisMonth) {
                    earliestCardDueDateThisMonth = effectiveDueDate;
                }
            }
        }
    });
    $('#invoiceValue').textContent = formatCurrency(totalCardDueThisMonth); 
    $('#invoiceDueDate').textContent = earliestCardDueDateThisMonth ? formatDate(earliestCardDueDateThisMonth) : '--/--/----';
  };

  const updateCardsList = () => {
    const listEl = $('#cardsList');
    if (!listEl) return;
    listEl.innerHTML = '';
    if (state.cards.length === 0) {
      listEl.innerHTML = '<p style="text-align: center;">Nenhum cartão cadastrado.</p>';
      return;
    }
    state.cards.forEach(card => {
        const cardEl = document.createElement('div');
        cardEl.className = 'card'; 
        cardEl.style.marginBottom = 'var(--spacing-md)';
        
        const faturaVencimentoNoMesSelecionado = new Date(Date.UTC(state.year, state.month, card.dueDay));
        const { previousClosing, currentClosingDate } = getInvoicePeriod(card, faturaVencimentoNoMesSelecionado);

        let currentInvoiceAmountForMonth = 0;
        if (previousClosing && currentClosingDate) {
            const currentInvoiceTransactions = state.transactions.filter(t => {
                const tLaunchDate = parseLocalDateString(t.date);
                return t.type === 'expense' &&
                       t.paymentMethod === 'credito' &&
                       t.creditCardId === card.id &&
                       tLaunchDate >= previousClosing &&
                       tLaunchDate < currentClosingDate;
            });
            currentInvoiceAmountForMonth = currentInvoiceTransactions.reduce((sum, t) => sum + parseFloat(t.amount), 0);
        }

        const limitPercentage = card.limit > 0 ? ((card.limit - card.availableLimit) / card.limit) * 100 : 0;
        const melhorDia = calcularMelhorDiaCompras(card);
        const nomeMesFatura = new Date(state.year, state.month).toLocaleDateString('pt-BR', {month: 'long'});


        cardEl.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm);">
                <h3>${card.name}</h3>
                <div>
                    <button class="btn btn-icon btn-outline edit-card-btn" data-id="${card.id}" aria-label="Editar"><svg width="16" height="16"><use href="#icon-edit"></use></svg></button>
                    <button class="btn btn-icon btn-outline delete-card-btn" data-id="${card.id}" aria-label="Excluir"><svg width="16" height="16"><use href="#icon-trash"></use></svg></button>
                </div>
            </div>
            <div>Limite: ${formatCurrency(card.limit)} | Disponível: ${formatCurrency(card.availableLimit)}</div>
            <div class="commitment-progress" style="margin: var(--spacing-xs) 0;">
                <div class="commitment-progress-bar" style="width: ${limitPercentage.toFixed(0)}%; background-color: ${limitPercentage > 80 ? 'var(--color-error)' : 'var(--color-primary)'};"></div>
            </div>
            <div><small>Sua Fatura fecha: dia ${card.closingDay} | Vencimento: dia ${card.dueDay}</small></div>
            <div><small>Fatura de ${nomeMesFatura}: ${formatCurrency(currentInvoiceAmountForMonth)}</small></div>
            ${melhorDia ? `<div><small style="color: var(--color-info);">Melhor dia p/ compra: dia ${melhorDia}</small></div>` : ''}
            <button class="btn btn-primary view-invoice-btn" data-id="${card.id}" style="margin-top: var(--spacing-sm);">Ver Fatura de ${new Date(state.year, state.month).toLocaleDateString('pt-BR', {month: 'short'})}</button>
        `;
        listEl.appendChild(cardEl);
    });
    $$('#cardsList .edit-card-btn').forEach(btn => btn.addEventListener('click', e => {
        const cardToEdit = state.cards.find(c => c.id === e.currentTarget.dataset.id);
        if(cardToEdit) openEditCardModal(cardToEdit);
    }));
    $$('#cardsList .delete-card-btn').forEach(btn => btn.addEventListener('click', e => deleteCard(e.currentTarget.dataset.id)));
    $$('#cardsList .view-invoice-btn').forEach(btn => btn.addEventListener('click', e => openCardInvoice(e.currentTarget.dataset.id)));
  };

  const openCardInvoice = (cardId) => {
    const card = state.cards.find(c => c.id === cardId);
    if (!card) return;
    state.currentCard = card; 

    const faturaVencimentoNoMesSelecionado = new Date(Date.UTC(state.year, state.month, card.dueDay));

    $('#cardInvoiceTitle').textContent = `Fatura ${card.name} - Venc. ${formatDate(faturaVencimentoNoMesSelecionado)}`;

    let currentInvoiceSum = 0;
    const invoiceTransactions = state.transactions.filter(t => {
        if (t.type === 'expense' && t.paymentMethod === 'credito' && t.creditCardId === cardId) {
            const effectiveDueDate = getEffectiveDueDateForSort(t); 
            return effectiveDueDate &&
                   effectiveDueDate.getUTCMonth() === state.month &&
                   effectiveDueDate.getUTCFullYear() === state.year;
        }
        return false; 
    }).sort((a,b) => parseLocalDateString(a.date) - parseLocalDateString(b.date)); 

    currentInvoiceSum = invoiceTransactions.reduce((sum, t) => sum + parseFloat(t.amount), 0);

    const { previousClosing, currentClosingDate } = getInvoicePeriod(card, faturaVencimentoNoMesSelecionado);
    let endOfPurchasePeriod = null;
    if (currentClosingDate) {
        endOfPurchasePeriod = new Date(currentClosingDate.getTime());
        endOfPurchasePeriod.setUTCDate(currentClosingDate.getUTCDate() - 1);
    }

    $('#cardInvoiceDetails').innerHTML = `
        <p><strong>Período de Compras (Referência):</strong> ${previousClosing ? formatDate(previousClosing) : 'N/A'} - ${endOfPurchasePeriod ? formatDate(endOfPurchasePeriod) : 'N/A'}</p>
        <p><strong>Vencimento desta Fatura:</strong> ${formatDate(faturaVencimentoNoMesSelecionado)}</p>
        <p><strong>Limite Total:</strong> ${formatCurrency(card.limit)} | <strong>Disponível:</strong> ${formatCurrency(card.availableLimit)}</p>
        <p><strong>Valor desta Fatura:</strong> <span id="currentInvoiceValueDisplay">${formatCurrency(currentInvoiceSum)}</span></p>
    `;

    const tableBody = $('#cardInvoiceTableBody');
    tableBody.innerHTML = '';

    if (invoiceTransactions.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhuma despesa nesta fatura.</td></tr>';
    } else {
      invoiceTransactions.forEach(t => {
        const row = tableBody.insertRow();
        row.innerHTML = `
          <td>${t.name} ${t.isRecurrent && t.installments > 1 ? `(${t.installmentNumber}/${t.installments})` : ''}</td>
          <td>${formatDate(t.date)}</td>
          <td>${formatCurrency(t.amount)}</td>
          <td>
            <div class="checkbox-wrapper">
              <input type="checkbox" class="checkbox invoice-paid-checkbox" id="invoice-paid-${t.id}"
                     data-id="${t.id}" ${t.status === 'paid' ? 'checked' : ''}>
              <label class="checkbox-label" for="invoice-paid-${t.id}"></label>
            </div>
          </td>`;
      });
      $$('.invoice-paid-checkbox').forEach(cb => cb.addEventListener('change', async (e) => {
          await updateTransactionStatus(e.target.dataset.id, e.target.checked ? 'paid' : 'pending');
          openCardInvoice(cardId);
      }));
    }
    $('#invoiceConfirmAmount').textContent = formatCurrency(currentInvoiceSum);
    closeModal('cardsListModal'); 
    openModal('cardInvoiceModal');
  };

  let categoryExpensesChart, cardUsageDonutChart, annualBarsChart, fixedVsVariableChart, personAnalysisChart;
  
  const createCharts = () => {
    const configCategoryExpenses = {
      type: 'bar',
      data: { 
        labels: [],
        datasets: [{
          data: [],
          label: 'Valor',
          borderRadius: 8,
          maxBarThickness: 50
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animations: {
          tension: {
            duration: 1000,
            easing: 'easeOutQuad',
            from: 0.8,
            to: 0.2,
            loop: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              drawBorder: false,
              color: 'rgba(200, 200, 200, 0.08)'
            },
            ticks: {
              padding: 10,
              callback: function(value) {
                return formatCurrency(value);
              }
            }
          },
          x: {
            grid: {
              display: false
            },
            ticks: {
              padding: 10
            }
          }
        },
        plugins: {
          legend: {
            display: false
          }
        },
        onHover: (event, elements) => {
          event.native.target.style.cursor = elements.length ? 'pointer' : 'default';
        }
      }
    };
    
    const configCardUsage = {
      type: 'doughnut',
      data: {
        labels: ['Utilizado', 'Disponível', 'Total'], // 'Total' é para a seção base no mockup
        datasets: [{
          data: [0, 0, 0], 
          borderWidth: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '65%',
        rotation: -90,
        circumference: 360,
        plugins: {
          legend: {
            display: false
          }
        },
        animation: {
          animateScale: true,
          animateRotate: true,
          duration: 1200
        },
        onHover: (event, elements) => {
          event.native.target.style.cursor = elements.length ? 'pointer' : 'default';
        }
      }
    };
    
    const configFixedVsVariable = {
      type: 'pie',
      data: {
        labels: ['Fixas', 'Variáveis'],
        datasets: [{
          data: [],
          borderWidth: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false
          }
        },
        animation: {
          animateScale: true,
          animateRotate: true,
          duration: 1200
        },
        onHover: (event, elements) => {
          event.native.target.style.cursor = elements.length ? 'pointer' : 'default';
        }
      }
    };
    
    const configPersonAnalysis = {
      type: 'bar',
      data: {
        labels: [],
        datasets: [{
          data: [],
          label: 'Valor',
          borderRadius: 8,
          maxBarThickness: 40
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            beginAtZero: true,
            grid: {
              drawBorder: false,
              color: 'rgba(200, 200, 200, 0.08)'
            },
            ticks: {
              padding: 10,
              callback: function(value) {
                return formatCurrency(value);
              }
            }
          },
          y: {
            grid: {
              display: false
            },
            ticks: {
              padding: 10
            }
          }
        },
        plugins: {
          legend: {
            display: false
          }
        },
        animation: {
          delay: (context) => context.dataIndex * 100,
          duration: 800,
          easing: 'easeOutQuad'
        },
        onHover: (event, elements) => {
          event.native.target.style.cursor = elements.length ? 'pointer' : 'default';
        }
      }
    };
    
    const configAnnualBars = {
      type: 'bar',
      data: {
        labels: [],
        datasets: [
          {
            label: 'Receitas',
            data: [],
            borderRadius: 6,
            maxBarThickness: 20
          },
          {
            label: 'Despesas',
            data: [],
            borderRadius: 6,
            maxBarThickness: 20
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            stacked: false,
            grid: {
              drawBorder: false,
              color: 'rgba(200, 200, 200, 0.1)'
            },
            ticks: {
              padding: 10,
              callback: function(value) {
                return formatCurrency(value);
              }
            }
          },
          x: {
            grid: {
              display: false
            },
            stacked: false,
            ticks: {
              padding: 10
            }
          }
        },
        interaction: {
          mode: 'index',
          intersect: false,
        },
        plugins: {
          legend: {
            display: false 
          }
        },
        animation: {
          delay: (context) => context.dataIndex * 80,
          duration: 1000,
          easing: 'easeOutQuad'
        },
        onHover: (event, elements) => {
          event.native.target.style.cursor = elements.length ? 'pointer' : 'default';
        }
      }
    };
    
    if ($('#categoryExpensesChart')) categoryExpensesChart = new Chart($('#categoryExpensesChart').getContext('2d'), configCategoryExpenses);
    if ($('#cardUsageDonutChart')) cardUsageDonutChart = new Chart($('#cardUsageDonutChart').getContext('2d'), configCardUsage);
    if ($('#fixedVsVariableChart')) fixedVsVariableChart = new Chart($('#fixedVsVariableChart').getContext('2d'), configFixedVsVariable);
    if ($('#personAnalysisChart')) personAnalysisChart = new Chart($('#personAnalysisChart').getContext('2d'), configPersonAnalysis);
    if ($('#annualBars')) annualBarsChart = new Chart($('#annualBars').getContext('2d'), configAnnualBars);
    
    if ($('#categoryExpensesChart')) {
      $('#categoryExpensesChart').addEventListener('mousemove', (e) => {
        const points = categoryExpensesChart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, false);
        if (points.length) {
          const index = points[0].index;
          const value = categoryExpensesChart.data.datasets[0].data[index];
          const label = categoryExpensesChart.data.labels[index];
          const tooltipContent = `
            <div class="chart-tooltip-title">${label}</div>
            <div class="chart-tooltip-item">
              <div class="chart-tooltip-label">Valor:</div>
              <div class="chart-tooltip-value">${formatCurrency(value)}</div>
            </div>
            <div class="chart-tooltip-percent">Representa 15.2% do total</div>`;
          showTooltip(categoryExpensesChart, tooltipContent, e);
        } else {
          hideTooltip();
        }
      });
      $('#categoryExpensesChart').addEventListener('mouseout', hideTooltip);
    }
    
    if ($('#cardUsageDonutChart')) {
      $('#cardUsageDonutChart').addEventListener('mousemove', (e) => {
        const points = cardUsageDonutChart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, false);
        if (points.length) {
          const index = points[0].index;
          const value = cardUsageDonutChart.data.datasets[0].data[index];
          const label = cardUsageDonutChart.data.labels[index];
          
          const totalForPercentage = cardUsageDonutChart.data.datasets[0].data.slice(0, 2).reduce((a, b) => a + b, 0); // Usado + Disponível
          const percentage = totalForPercentage > 0 ? ((value / totalForPercentage) * 100).toFixed(1) : 0;
          
          let tooltipContent = `
            <div class="chart-tooltip-title">${label}</div>
            <div class="chart-tooltip-item">
              <div class="chart-tooltip-label">Valor:</div>
              <div class="chart-tooltip-value">${formatCurrency(value)}</div>
            </div>`;
          
          if (index < 2) { 
            tooltipContent += `<div class="chart-tooltip-percent">${percentage}% do limite</div>`;
          }
          
          showTooltip(cardUsageDonutChart, tooltipContent, e);
        } else {
          hideTooltip();
        }
      });
      $('#cardUsageDonutChart').addEventListener('mouseout', hideTooltip);
    }
    
    if ($('#fixedVsVariableChart')) {
      $('#fixedVsVariableChart').addEventListener('mousemove', (e) => {
        const points = fixedVsVariableChart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, false);
        if (points.length) {
          const index = points[0].index;
          const value = fixedVsVariableChart.data.datasets[0].data[index];
          const label = fixedVsVariableChart.data.labels[index];
          
          const total = fixedVsVariableChart.data.datasets[0].data.reduce((a, b) => a + b, 0);
          const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
          
          const tooltipContent = `
            <div class="chart-tooltip-title">${label}</div>
            <div class="chart-tooltip-item">
              <div class="chart-tooltip-label">Valor:</div>
              <div class="chart-tooltip-value">${formatCurrency(value)}</div>
            </div>
            <div class="chart-tooltip-percent">${percentage}% do total</div>`;
          
          showTooltip(fixedVsVariableChart, tooltipContent, e);
        } else {
          hideTooltip();
        }
      });
      $('#fixedVsVariableChart').addEventListener('mouseout', hideTooltip);
    }
    
    if ($('#personAnalysisChart')) {
      $('#personAnalysisChart').addEventListener('mousemove', (e) => {
        const points = personAnalysisChart.getElementsAtEventForMode(e, 'nearest', { intersect: true }, false);
        if (points.length) {
          const index = points[0].index;
          const value = personAnalysisChart.data.datasets[0].data[index];
          const label = personAnalysisChart.data.labels[index];
          
          const totalExpenses = personAnalysisChart.data.datasets[0].data.reduce((a, b) => a + b, 0);
          const percentage = totalExpenses > 0 ? ((value / totalExpenses) * 100).toFixed(1) : 0;
          const percentChange = Math.random() < 0.5 ? -5.2 : 7.8; // Simulação
          const percentClass = percentChange >= 0 ? 'positive' : 'negative';
          const percentPrefix = percentChange >= 0 ? '+' : '';
          
          const tooltipContent = `
            <div class="chart-tooltip-title">${label}</div>
            <div class="chart-tooltip-item">
              <div class="chart-tooltip-label">Total:</div>
              <div class="chart-tooltip-value">${formatCurrency(value)}</div>
            </div>
            <div class="chart-tooltip-item">
              <div class="chart-tooltip-label">Percentual:</div>
              <div class="chart-tooltip-value">${percentage}%</div>
            </div>
            <div class="chart-tooltip-percent ${percentClass}">${percentPrefix}${percentChange}% desde o mês anterior</div>`;
          
          showTooltip(personAnalysisChart, tooltipContent, e);
        } else {
          hideTooltip();
        }
      });
      $('#personAnalysisChart').addEventListener('mouseout', hideTooltip);
    }
    
    if ($('#annualBars')) {
      $('#annualBars').addEventListener('mousemove', (e) => {
        const points = annualBarsChart.getElementsAtEventForMode(e, 'index', { intersect: false }, false);
        if (points.length) {
          const index = points[0].index;
          const income = annualBarsChart.data.datasets[0].data[index] || 0;
          const expense = annualBarsChart.data.datasets[1].data[index] || 0;
          const month = annualBarsChart.data.labels[index];
          const balance = income - expense;
          const balanceClass = balance >= 0 ? 'positive' : 'negative';
          
          const tooltipContent = `
            <div class="chart-tooltip-title">${month}</div>
            <div class="chart-tooltip-item">
              <div class="chart-tooltip-label">
                <span class="chart-tooltip-color" style="background-color: var(--color-income);"></span>
                Receitas:
              </div>
              <div class="chart-tooltip-value">${formatCurrency(income)}</div>
            </div>
            <div class="chart-tooltip-item">
              <div class="chart-tooltip-label">
                <span class="chart-tooltip-color" style="background-color: var(--color-expense);"></span>
                Despesas:
              </div>
              <div class="chart-tooltip-value">${formatCurrency(expense)}</div>
            </div>
            <div class="chart-tooltip-item">
              <div class="chart-tooltip-label">Saldo:</div>
              <div class="chart-tooltip-value" style="color: ${balance >= 0 ? 'var(--color-success)' : 'var(--color-error)'}">
                ${formatCurrency(balance)}
              </div>
            </div>
            <div class="chart-tooltip-percent ${balanceClass}">
              ${balance >= 0 ? 'Superávit' : 'Déficit'} de ${Math.abs((balance / income * 100).toFixed(1))}%
            </div>`;
          
          showTooltip(annualBarsChart, tooltipContent, e);
        } else {
          hideTooltip();
        }
      });
      $('#annualBars').addEventListener('mouseout', hideTooltip);
      
    }
    updateChartColors();
  };

  const updateCharts = () => {
    if (!categoryExpensesChart) createCharts(); // Garante que os gráficos sejam criados na primeira chamada
    const currentMonthTransactions = state.filteredTransactions;

    // 1. Atualiza o gráfico de despesas por categoria
    const expenseCategories = currentMonthTransactions
      .filter(t => t.type === 'expense')
      .reduce((acc, t) => {
        const catName = state.categories.expense.find(c => c.id === t.category)?.name || t.categoryName || 'Outros';
        const catIcon = state.categories.expense.find(c => c.id === t.category)?.icon || '';
        const displayName = catIcon ? `${catIcon} ${catName}` : catName;
        acc[displayName] = (acc[displayName] || 0) + parseFloat(t.amount);
        return acc;
      }, {});
      
    const sortedCategories = Object.entries(expenseCategories)
      .sort((a, b) => b[1] - a[1])
      .reduce((r, [k, v]) => ({ ...r, [k]: v }), {});
      
    categoryExpensesChart.data.labels = Object.keys(sortedCategories);
    categoryExpensesChart.data.datasets[0].data = Object.values(sortedCategories);
    
    categoryExpensesChart.options.animation = {
      y: { duration: 1000, from: 0 },
      x: { delay: (context) => context.dataIndex * 100 }
    };
    categoryExpensesChart.update();
    
    // 2. Atualiza o gráfico de uso do cartão de crédito
    const totalLimitAllCards = state.cards.reduce((sum, c) => sum + parseFloat(c.limit || 0), 0);
    const totalAvailableAllCards = state.cards.reduce((sum, c) => sum + parseFloat(c.availableLimit || 0), 0);
    const totalUsedAllCards = totalLimitAllCards - totalAvailableAllCards;
    
    if (cardUsageDonutChart) {
      if (totalLimitAllCards > 0) {
        cardUsageDonutChart.data.labels = ['Utilizado', 'Disponível', 'Fundo']; // Label 'Fundo' para a seção base
        cardUsageDonutChart.data.datasets[0].data = [
          totalUsedAllCards, 
          totalAvailableAllCards,
          Math.max(0.01, totalLimitAllCards * 0.05) // Pequeno valor para a seção base, nunca zero para evitar problemas
        ];
        
        const percentUsed = totalLimitAllCards > 0 ? Math.round((totalUsedAllCards / totalLimitAllCards) * 100) : 0;
        if($('.limit-value')) $('.limit-value').textContent = `${percentUsed}%`;
        
        if($('.limit-value')) {
            if (percentUsed > 80) {
            $('.limit-value').style.color = '#EF4444';
            } else if (percentUsed > 60) {
            $('.limit-value').style.color = '#F59E0B';
            } else {
            $('.limit-value').style.color = getComputedStyle(document.documentElement).getPropertyValue('--color-on-surface').trim();
            }
        }
      } else {
        cardUsageDonutChart.data.labels = ['Nenhum Limite'];
        cardUsageDonutChart.data.datasets[0].data = [1]; // Dado placeholder
        if ($('.limit-value')) {
          $('.limit-value').textContent = `0%`;
          $('.limit-value').style.color = getComputedStyle(document.documentElement).getPropertyValue('--color-on-surface').trim();
        }
      }
      cardUsageDonutChart.options.animation = { animateRotate: true, animateScale: true, duration: 1000 };
      cardUsageDonutChart.update();
    }
    
    // 3. Atualiza o gráfico de despesas fixas vs variáveis
    const fixed = currentMonthTransactions
      .filter(t => t.type === 'expense' && t.isFixed === 'fixed')
      .reduce((s, t) => s + parseFloat(t.amount), 0);
      
    const variable = currentMonthTransactions
      .filter(t => t.type === 'expense' && t.isFixed === 'variable')
      .reduce((s, t) => s + parseFloat(t.amount), 0);
      
    fixedVsVariableChart.data.datasets[0].data = [fixed, variable];
    fixedVsVariableChart.options.animation = { animateRotate: true, animateScale: true, duration: 1000 };
    fixedVsVariableChart.update();
    
    // 4. Atualiza o gráfico de despesas por pessoa
    const personExpenses = currentMonthTransactions
      .filter(t => t.type === 'expense' && t.person)
      .reduce((acc, t) => {
        const person = state.people.find(p => p.id === t.person);
        const personName = person ? `${person.icon || ''} ${person.name}` : 'Não atribuído';
        acc[personName] = (acc[personName] || 0) + parseFloat(t.amount);
        return acc;
      }, {});
      
    const sortedPersons = Object.entries(personExpenses)
      .sort((a, b) => b[1] - a[1])
      .reduce((r, [k, v]) => ({ ...r, [k]: v }), {});
      
    personAnalysisChart.data.labels = Object.keys(sortedPersons);
    personAnalysisChart.data.datasets[0].data = Object.values(sortedPersons);
    personAnalysisChart.options.animation = {
      x: { duration: 1000, from: 0 },
      y: { delay: (context) => context.dataIndex * 100 }
    };
    personAnalysisChart.update();
    
    // 5. Atualiza o gráfico anual de receitas x despesas
    const annualData = Array(12).fill(null).map(() => ({ income: 0, expense: 0 }));
    const todayForAnnual = new Date(Date.UTC(state.year, state.month, 1));
    
    state.transactions.forEach(t => {
      const tLaunchDate = parseLocalDateString(t.date);
      if (!tLaunchDate) return;
      
      let effectiveDateForAnnualChart = tLaunchDate;
      
      if (t.type === 'expense') {
        if (t.paymentMethod === 'credito' && t.creditCardId) {
          const card = state.cards.find(c => c.id === t.creditCardId);
          if (card) {
            const realDueDate = calcularVencimentoReal(tLaunchDate, card);
            if (realDueDate) effectiveDateForAnnualChart = realDueDate;
          }
        } else if (t.dueDate) {
          const explicitDueDate = parseLocalDateString(t.dueDate);
          if (explicitDueDate) effectiveDateForAnnualChart = explicitDueDate;
        }
      }
      
      const monthDiff = (todayForAnnual.getUTCFullYear() - effectiveDateForAnnualChart.getUTCFullYear()) * 12 + 
                      (todayForAnnual.getUTCMonth() - effectiveDateForAnnualChart.getUTCMonth());
      
      if (monthDiff >= 0 && monthDiff < 12) {
        const indexInAnnualArray = 11 - monthDiff;
        if (t.type === 'income') annualData[indexInAnnualArray].income += parseFloat(t.amount);
        else if (t.type === 'expense') annualData[indexInAnnualArray].expense += parseFloat(t.amount);
      }
    });
    
    annualBarsChart.data.labels = Array(12).fill(null).map((_, i) => {
      const d = new Date(todayForAnnual);
      d.setUTCMonth(todayForAnnual.getUTCMonth() - (11 - i));
      return d.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit', timeZone: 'UTC' });
    });
    
    annualBarsChart.data.datasets[0].data = annualData.map(d => d.income);
    annualBarsChart.data.datasets[1].data = annualData.map(d => d.expense);
    annualBarsChart.options.animation = {
      y: { duration: 1000, easing: 'easeOutQuad', from: 0 },
      delay: (context) => context.dataIndex * 100
    };
    annualBarsChart.update();
    
    updateChartColors(); // ESSENCIAL: Chama para aplicar cores/gradientes aos gráficos atualizados 
  };

  const toggleCommitments = () => {
    const content = $('#commitmentsContent');
    const icon = $('#commitmentToggleIcon use');
    if (!content || !icon) return;
    if (content.style.maxHeight && content.style.maxHeight !== '0px') {
      content.style.maxHeight = '0px';
      icon.setAttribute('href', '#icon-chevron-down');
    } else {
      content.style.maxHeight = content.scrollHeight + 'px';
      icon.setAttribute('href', '#icon-chevron-up');
    }
  };

  const generateInsights = () => {
    const container = $('#insightsBannerContainer');
    if (!container) return;
    container.innerHTML = '';
    state.insights = [];
    const today = new Date(); today.setUTCHours(0,0,0,0); 

    const overdue = state.transactions.filter(t => {
        if (t.type !== 'expense' || t.status === 'paid') return false;
        
        let effectiveDueDate = null;
        if (t.paymentMethod === 'credito' && t.creditCardId) {
            const card = state.cards.find(c => c.id === t.creditCardId);
            const launchDate = parseLocalDateString(t.date);
            if (card && launchDate) effectiveDueDate = calcularVencimentoReal(launchDate, card);
        } else if (t.dueDate) {
            effectiveDueDate = parseLocalDateString(t.dueDate);
        }
        
        if (!effectiveDueDate) return false;
        
        return effectiveDueDate < today;
    });

    if (overdue.length > 0) {
      state.insights.push({ id: 'overdue', level: 'danger', icon: 'icon-alert', message: `Você tem ${overdue.length} conta(s) vencida(s).`, actionText: 'Ver Detalhes', action: () => openDueTransactionsModal(overdue, 'Contas Vencidas', 'danger') });
    }

    const upcomingDateLimit = new Date(today); upcomingDateLimit.setUTCDate(today.getUTCDate() + 5);
    const upcoming = state.transactions.filter(t => {
        if (t.type !== 'expense' || t.status === 'paid') return false;
        
        let effectiveDueDate = null;
        if (t.paymentMethod === 'credito' && t.creditCardId) {
            const card = state.cards.find(c => c.id === t.creditCardId);
            const launchDate = parseLocalDateString(t.date);
            if (card && launchDate) effectiveDueDate = calcularVencimentoReal(launchDate, card);
        } else if (t.dueDate) {
            effectiveDueDate = parseLocalDateString(t.dueDate);
        }
        if (!effectiveDueDate) return false;

        return effectiveDueDate >= today && effectiveDueDate <= upcomingDateLimit;
    });
    if (upcoming.length > 0) {
      state.insights.push({ id: 'upcoming', level: 'warning', icon: 'icon-calendar', message: `Você tem ${upcoming.length} conta(s) a vencer nos próximos 5 dias.`, actionText: 'Ver Detalhes', action: () => openDueTransactionsModal(upcoming, 'Contas a Vencer', 'warning') }); 
    }
    
    state.cards.filter(c => c.availableLimit < (c.limit * 0.2)).forEach(c => {
        state.insights.push({ id: `low-limit-${c.id}`, level: 'warning', icon: 'icon-credit-card', message: `Limite baixo no cartão ${c.name}.`, actionText: 'Ver Cartão', action: () => { closeModal('insightsBannerContainer'); openModal('cardsListModal'); openCardInvoice(c.id); } });
    });

    state.insights.forEach(insight => {
      const el = document.createElement('div');
      el.className = `insight-banner insight-${insight.level}`;
      el.innerHTML = `<div class="insight-icon"><svg width="24" height="24"><use href="#${insight.icon}"></use></svg></div><div class="insight-content"><div class="insight-title">${insight.message}</div></div><button class="btn btn-outline insight-action" data-id="${insight.id}">${insight.actionText}</button>`;
      container.appendChild(el);
    });
    $$('.insight-action').forEach(btn => btn.addEventListener('click', e => {
      const insight = state.insights.find(i => i.id === e.currentTarget.dataset.id);
      if (insight && insight.action) insight.action();
    }));
  };
  
  const openDueTransactionsModal = (transactions, title, type) => {
    $('#dueTransactionsModalTitleText').textContent = title;
    const iconEl = $('#dueTransactionsModalIcon use');
    iconEl.setAttribute('href', type === 'danger' ? '#icon-alert' : '#icon-calendar');
    
    const tableBody = $('#dueTransactionsTableBody');
    tableBody.innerHTML = '';
    if (transactions.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Nenhuma conta encontrada.</td></tr>`;
    } else {
      transactions.sort((a,b) => {
        let dueDateA_effective = null;
        if (a.paymentMethod === 'credito' && a.creditCardId) {
            const cardA = state.cards.find(c=>c.id===a.creditCardId);
            if(cardA) dueDateA_effective = calcularVencimentoReal(parseLocalDateString(a.date), cardA);
        } else if (a.dueDate) {
            dueDateA_effective = parseLocalDateString(a.dueDate);
        }

        let dueDateB_effective = null;
        if (b.paymentMethod === 'credito' && b.creditCardId) {
            const cardB = state.cards.find(c=>c.id===b.creditCardId);
            if(cardB) dueDateB_effective = calcularVencimentoReal(parseLocalDateString(b.date), cardB);
        } else if (b.dueDate) {
            dueDateB_effective = parseLocalDateString(b.dueDate);
        }
        
        if (!dueDateA_effective && !dueDateB_effective) return 0;
        if (!dueDateA_effective) return 1;
        if (!dueDateB_effective) return -1;
        return dueDateA_effective - dueDateB_effective;

      }).forEach(t => {
        const cat = state.categories.expense.find(c => c.id === t.category);
        let effectiveDueDateForDisplay = null;
        if (t.paymentMethod === 'credito' && t.creditCardId) {
            const card = state.cards.find(c=>c.id===t.creditCardId);
            const launchDate = parseLocalDateString(t.date);
            if(card && launchDate) effectiveDueDateForDisplay = calcularVencimentoReal(launchDate, card);
        } else if (t.dueDate) {
            effectiveDueDateForDisplay = parseLocalDateString(t.dueDate);
        }

        const row = tableBody.insertRow();
        row.innerHTML = `
          <td>${t.name}</td>
          <td>${cat ? `${cat.icon} ${cat.name}` : (t.categoryName || t.category)}</td>
          <td>${effectiveDueDateForDisplay ? formatDate(effectiveDueDateForDisplay) : formatDate(t.date)}</td>
          <td>${formatCurrency(t.amount)}</td>
          <td class="actions-cell">
            <button class="btn btn-success btn-sm mark-paid-due-transaction" data-id="${t.id}">
              <svg width="16" height="16"><use href="#icon-check"></use></svg>
            </button>
            <button class="btn btn-outline btn-sm edit-due-transaction" data-id="${t.id}">
              <svg width="16" height="16"><use href="#icon-edit"></use></svg>
            </button>
          </td>`;
      });
      $$('.mark-paid-due-transaction').forEach(btn => btn.addEventListener('click', e => updateTransactionStatus(e.currentTarget.dataset.id, 'paid')));
      $$('.edit-due-transaction').forEach(btn => btn.addEventListener('click', e => openEditModal(e.currentTarget.dataset.id)));
    }

    $('#payAllDueBtn').style.display = type === 'danger' ? 'none' : 'block';
    openModal('dueTransactionsModal');
  };

  const renderCommitments = () => {
    const container = $('#commitmentsContent');
    if (!container) return;
    container.innerHTML = '';

    const fixedExpenses = state.transactions.filter(t => 
      t.type === 'expense' && t.isFixed === 'fixed' && t.status !== 'paid' &&
      ((t.recurrenceMasterId && t.recurrenceMasterId !== t.id) || t.isRecurrent)
    ).sort((a, b) => parseFloat(b.amount) - parseFloat(a.amount));

    const installmentTransactions = state.transactions.filter(t => 
      t.isRecurrent && t.installments && t.installments > 1 && t.installmentNumber < t.installments
    ).sort((a, b) => {
      if (a.recurrenceMasterId !== b.recurrenceMasterId) return a.recurrenceMasterId - b.recurrenceMasterId;
      return parseFloat(b.amount) - parseFloat(a.amount);
    });

    if (fixedExpenses.length === 0 && installmentTransactions.length === 0) {
      container.innerHTML = '<p style="text-align: center; padding: var(--spacing-md);">Nenhum compromisso futuro.</p>';
      return;
    }

    // Agrupar transações por master ID para mostrar parcelas
    const installmentGroups = {};
    installmentTransactions.forEach(t => {
      const masterId = t.recurrenceMasterId || t.id;
      if (!installmentGroups[masterId]) {
        installmentGroups[masterId] = {
          name: t.name.replace(/ \([0-9]+\/[0-9]+\)$/, ''),
          total: 0,
          count: 0,
          totalInstallments: t.installments,
          paidInstallments: t.installmentNumber - 1,
          amount: parseFloat(t.amount),
          transactions: []
        };
      }
      installmentGroups[masterId].total += parseFloat(t.amount);
      installmentGroups[masterId].count++;
      installmentGroups[masterId].transactions.push(t);
    });

    if (fixedExpenses.length > 0) {
      const fixedExpensesDiv = document.createElement('div');
      fixedExpensesDiv.className = 'card';
      fixedExpensesDiv.style.marginBottom = 'var(--spacing-md)';
      fixedExpensesDiv.innerHTML = `<h3 style="margin-bottom: var(--spacing-md);">Despesas Fixas</h3>`;
      
      const fixedList = document.createElement('div');
      fixedList.className = 'commitment-items';
      fixedExpenses.forEach(t => {
        const cat = state.categories.expense.find(c => c.id === t.category);
        const itemDiv = document.createElement('div');
        itemDiv.className = 'commitment-item';
        itemDiv.innerHTML = `
          <div class="category-item-icon" style="background-color: var(--color-expense);">${cat ? cat.icon : '💸'}</div>
          <div style="flex-grow: 1;">
            <div style="display: flex; justify-content: space-between;">
              <div><strong>${t.name}</strong></div>
              <div><strong>${formatCurrency(t.amount)}</strong> / mês</div>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <div>${cat ? cat.name : 'Sem categoria'}</div>
              <div>
                <button class="btn btn-outline btn-sm edit-commitment-btn" data-id="${t.id}">
                  <svg width="16" height="16"><use href="#icon-edit"></use></svg> Editar
                </button>
              </div>
            </div>
          </div>
        `;
        fixedList.appendChild(itemDiv);
      });
      fixedExpensesDiv.appendChild(fixedList);
      container.appendChild(fixedExpensesDiv);
    }

    if (Object.keys(installmentGroups).length > 0) {
      const installmentsDiv = document.createElement('div');
      installmentsDiv.className = 'card';
      installmentsDiv.style.marginBottom = 'var(--spacing-md)';
      installmentsDiv.innerHTML = `<h3 style="margin-bottom: var(--spacing-md);">Parcelas a Vencer</h3>`;
      
      const installmentsList = document.createElement('div');
      installmentsList.className = 'commitment-items';
      Object.values(installmentGroups).forEach(group => {
        const firstTransaction = group.transactions[0];
        const cat = state.categories.expense.find(c => c.id === firstTransaction.category);
        const progress = (group.paidInstallments / group.totalInstallments) * 100;
        
        const itemDiv = document.createElement('div');
        itemDiv.className = 'commitment-item';
        itemDiv.innerHTML = `
          <div class="category-item-icon" style="background-color: var(--color-card-invoice);">${cat ? cat.icon : '💳'}</div>
          <div style="flex-grow: 1;">
            <div style="display: flex; justify-content: space-between;">
              <div><strong>${group.name}</strong></div>
              <div><strong>${formatCurrency(group.total)}</strong> restante</div>
            </div>
            <div>${group.paidInstallments}/${group.totalInstallments} parcelas pagas</div>
            <div class="commitment-progress">
              <div class="commitment-progress-bar" style="background-color: var(--color-card-invoice); width: ${progress}%;"></div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: var(--spacing-xs);">
              <div>${cat ? cat.name : 'Sem categoria'}</div>
              <div>
                <button class="btn btn-outline btn-sm view-installments-btn" data-id="${firstTransaction.recurrenceMasterId || firstTransaction.id}">
                  <svg width="16" height="16"><use href="#icon-calendar"></use></svg> Detalhes
                </button>
              </div>
            </div>
          </div>
        `;
        installmentsList.appendChild(itemDiv);
      });
      installmentsDiv.appendChild(installmentsList);
      container.appendChild(installmentsDiv);
    }

    $$('.edit-commitment-btn').forEach(btn => 
      btn.addEventListener('click', e => openEditModal(e.currentTarget.dataset.id))
    );
    
    $$('.view-installments-btn').forEach(btn => 
      btn.addEventListener('click', e => {
        const masterId = e.currentTarget.dataset.id;
        const transactions = state.transactions.filter(t => 
          (t.recurrenceMasterId && t.recurrenceMasterId === masterId) || 
          (t.id === masterId && t.isRecurrent)
        );
        openInstallmentsModal(transactions);
      })
    );
  };

  const openInstallmentsModal = (transactions) => {
    $('#dueTransactionsModalTitleText').textContent = 'Parcelas';
    const iconEl = $('#dueTransactionsModalIcon use');
    iconEl.setAttribute('href', '#icon-calendar');
    
    const tableBody = $('#dueTransactionsTableBody');
    tableBody.innerHTML = '';
    
    if (!transactions || transactions.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Nenhuma parcela encontrada.</td></tr>`;
    } else {
      // Organizando por número da parcela
      transactions.sort((a, b) => {
        // Por número de parcela
        return (a.installmentNumber || 0) - (b.installmentNumber || 0);
      }).forEach(t => {
        const cat = state.categories.expense.find(c => c.id === t.category);
        let effectiveDueDateForDisplay = null;
        if (t.paymentMethod === 'credito' && t.creditCardId) {
          const card = state.cards.find(c => c.id === t.creditCardId);
          const launchDate = parseLocalDateString(t.date);
          if (card && launchDate) effectiveDueDateForDisplay = calcularVencimentoReal(launchDate, card);
        } else if (t.dueDate) {
          effectiveDueDateForDisplay = parseLocalDateString(t.dueDate);
        }

        const row = tableBody.insertRow();
        row.classList.toggle('transaction-paid', t.status === 'paid');
        row.innerHTML = `
          <td>${t.name}</td>
          <td>${cat ? `${cat.icon} ${cat.name}` : (t.categoryName || 'Sem categoria')}</td>
          <td>${effectiveDueDateForDisplay ? formatDate(effectiveDueDateForDisplay) : formatDate(t.date)}</td>
          <td>${formatCurrency(t.amount)}</td>
          <td class="actions-cell">
            ${t.status !== 'paid' ? `
              <button class="btn btn-success btn-sm mark-paid-due-transaction" data-id="${t.id}">
                <svg width="16" height="16"><use href="#icon-check"></use></svg>
              </button>
            ` : `
              <span class="badge badge-success">Pago</span>
            `}
            <button class="btn btn-outline btn-sm edit-due-transaction" data-id="${t.id}">
              <svg width="16" height="16"><use href="#icon-edit"></use></svg>
            </button>
          </td>`;
      });
      $$('.mark-paid-due-transaction').forEach(btn => 
        btn.addEventListener('click', e => updateTransactionStatus(e.currentTarget.dataset.id, 'paid'))
      );
      $$('.edit-due-transaction').forEach(btn => 
        btn.addEventListener('click', e => openEditModal(e.currentTarget.dataset.id))
      );
    }

    $('#payAllDueBtn').style.display = 'none';
    openModal('dueTransactionsModal');
  };

  const updateFilters = () => {
    // Só aplicamos os filtros na lista de transações, não no cálculo de KPIs
    // Criar cópias separadas
    state.filteredTransactions = [...state.filteredTransactions];
    
    // Aplicar os filtros extras 
    if (state.filters.category && state.filters.category !== '') {
      state.filteredTransactions = state.filteredTransactions.filter(t => t.category === state.filters.category);
    }
    
    if (state.filters.status && state.filters.status !== '') {
      state.filteredTransactions = state.filteredTransactions.filter(t => t.status === state.filters.status);
    }
    
    if (state.filters.paymentMethod && state.filters.paymentMethod !== '') {
      state.filteredTransactions = state.filteredTransactions.filter(t => t.paymentMethod === state.filters.paymentMethod);
    }
    
    if (state.filters.person && state.filters.person !== '') {
      state.filteredTransactions = state.filteredTransactions.filter(t => t.person === state.filters.person);
    }
    
    if (state.filters.transactionType && state.filters.transactionType !== '') {
      state.filteredTransactions = state.filteredTransactions.filter(t => t.type === state.filters.transactionType);
    }
  };

  const getEffectiveDueDateForSort = (transaction) => {
    if (transaction.type === 'expense') {
      if (transaction.paymentMethod === 'credito' && transaction.creditCardId) {
        const card = state.cards.find(c => c.id === transaction.creditCardId);
        if (card) {
          const date = parseLocalDateString(transaction.date);
          if (date) return calcularVencimentoReal(date, card);
        }
      } else if (transaction.dueDate) {
        return parseLocalDateString(transaction.dueDate);
      }
    }
    return parseLocalDateString(transaction.date);
  };

  const sortTransactions = () => {
    state.filteredTransactions.sort((a, b) => {
      let valueA, valueB;
      
      switch (state.sortColumn) {
        case 'name':
          valueA = a.name?.toLowerCase() || '';
          valueB = b.name?.toLowerCase() || '';
          break;
        
        case 'amount':
          valueA = parseFloat(a.amount) || 0;
          valueB = parseFloat(b.amount) || 0;
          break;
          
        case 'category':
          const catA = state.categories[a.type]?.find(c => c.id === a.category)?.name || '';
          const catB = state.categories[b.type]?.find(c => c.id === b.category)?.name || '';
          valueA = catA.toLowerCase();
          valueB = catB.toLowerCase();
          break;
          
        case 'status':
          valueA = a.status || '';
          valueB = b.status || '';
          break;
          
        case 'date':
          valueA = parseLocalDateString(a.date) || new Date(0);
          valueB = parseLocalDateString(b.date) || new Date(0);
          break;
          
        case 'dueDate':
          valueA = getEffectiveDueDateForSort(a) || parseLocalDateString(a.date) || new Date(0);
          valueB = getEffectiveDueDateForSort(b) || parseLocalDateString(b.date) || new Date(0);
          break;
          
        case 'paymentMethod':
          const methodA = state.paymentMethods.find(m => m.id === a.paymentMethod)?.name || '';
          const methodB = state.paymentMethods.find(m => m.id === b.paymentMethod)?.name || '';
          valueA = methodA.toLowerCase();
          valueB = methodB.toLowerCase();
          break;
          
        case 'person':
          const personA = state.people.find(p => p.id === a.person)?.name || '';
          const personB = state.people.find(p => p.id === b.person)?.name || '';
          valueA = personA.toLowerCase();
          valueB = personB.toLowerCase();
          break;
        
        default:
          valueA = a[state.sortColumn] || '';
          valueB = b[state.sortColumn] || '';
          break;
      }
      
      let comparison = 0;
      if (valueA < valueB) comparison = -1;
      if (valueA > valueB) comparison = 1;
      
      return state.sortDirection === 'asc' ? comparison : -comparison;
    });
  };

  const updateTransactionsList = () => {
    const table = $('#transactionsTableBody');
    if (!table) return;
    
    updateFilters();
    sortTransactions();
    
    table.innerHTML = '';
    
    if (state.filteredTransactions.length === 0) {
      table.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: var(--spacing-lg);">Nenhuma transação encontrada para este mês.</td></tr>';
      return;
    }
    
    state.filteredTransactions.forEach(transaction => {
      const row = table.insertRow();
      
      // Células de dados transacionais
      const nameCell = row.insertCell();
      const personCell = row.insertCell();
      const dateCell = row.insertCell();
      const dueDateCell = row.insertCell();
      const amountCell = row.insertCell();
      const statusCell = row.insertCell();
      const paymentCell = row.insertCell();
      const paidCell = row.insertCell();
      const actionsCell = row.insertCell();
      
      // Formatação e conteúdo das células
      
      // Célula de nome com ícone de categoria
      const category = state.categories[transaction.type]?.find(c => c.id === transaction.category);
      nameCell.innerHTML = `<div class="transaction-name-cell"><div class="transaction-icon" style="background-color: var(--color-${transaction.type});color:var(--color-on-${transaction.type});">${category?.icon || '?'}</div>${transaction.name}${transaction.installments > 1 ? ` (${transaction.installmentNumber}/${transaction.installments})` : ''}</div>`;
      
      // Pessoa responsável
      const person = state.people.find(p => p.id === transaction.person);
      personCell.textContent = person ? `${person.icon} ${person.name}` : '-';
      
      // Data de lançamento
      dateCell.textContent = formatDate(transaction.date);
      
      // Data de vencimento (para despesas)
      let effectiveDueDateForDisplay = null;
      if (transaction.type === 'expense') {
        if (transaction.paymentMethod === 'credito' && transaction.creditCardId) {
          const card = state.cards.find(c => c.id === transaction.creditCardId);
          const launchDate = parseLocalDateString(transaction.date);
          if (card && launchDate) 
            effectiveDueDateForDisplay = calcularVencimentoReal(launchDate, card);
        } else if (transaction.dueDate) {
          effectiveDueDateForDisplay = parseLocalDateString(transaction.dueDate);
        }
      }
      dueDateCell.textContent = effectiveDueDateForDisplay ? formatDate(effectiveDueDateForDisplay) : '-';
      
      // Valor com cor baseada no tipo (receita/despesa)
      amountCell.innerHTML = `<span style="color: var(--color-${transaction.type});">${formatCurrency(transaction.amount)}</span>`;
      amountCell.style.textAlign = 'right';
      
      // Status com badge colorido
      let statusBadge = '';
      if (transaction.type === 'income') {
        if (transaction.status === 'received') {
          statusBadge = '<span class="badge badge-success">Recebido</span>';
        } else {
          statusBadge = '<span class="badge badge-warning">A Receber</span>';
        }
      } else { // expense
        if (transaction.status === 'paid') {
          statusBadge = '<span class="badge badge-success">Pago</span>';
        } else if (transaction.status === 'scheduled') {
          statusBadge = '<span class="badge badge-info">Agendado</span>';
        } else {
          // Verificar se está vencido
          const today = new Date(); today.setUTCHours(0,0,0,0);
          const dueDate = effectiveDueDateForDisplay;
          
          if (dueDate && dueDate < today) {
            statusBadge = '<span class="badge badge-danger">Vencido</span>';
          } else {
            statusBadge = '<span class="badge badge-warning">Pendente</span>';
          }
        }
      }
      statusCell.innerHTML = statusBadge;
      statusCell.style.textAlign = 'center';
      
      // Método de pagamento
      const paymentMethod = state.paymentMethods.find(m => m.id === transaction.paymentMethod);
      if (transaction.paymentMethod === 'credito' && transaction.creditCardId) {
        const card = state.cards.find(c => c.id === transaction.creditCardId);
        paymentCell.innerHTML = `${paymentMethod?.icon || ''} ${card ? card.name : 'Cartão'}`;
      } else {
        paymentCell.innerHTML = paymentMethod ? `${paymentMethod.icon} ${paymentMethod.name}` : '-';
      }
      
      // Checkbox de pagamento
      if (transaction.type === 'expense' && transaction.status !== 'paid') {
        paidCell.innerHTML = `
          <div class="checkbox-wrapper" style="justify-content: center;">
            <input type="checkbox" class="checkbox mark-paid-checkbox" id="mark-paid-${transaction.id}" data-id="${transaction.id}">
            <label class="checkbox-label" for="mark-paid-${transaction.id}"></label>
          </div>`;
      } else if (transaction.type === 'income' && transaction.status !== 'received') {
        paidCell.innerHTML = `
          <div class="checkbox-wrapper" style="justify-content: center;">
            <input type="checkbox" class="checkbox mark-received-checkbox" id="mark-received-${transaction.id}" data-id="${transaction.id}">
            <label class="checkbox-label" for="mark-received-${transaction.id}"></label>
          </div>`;
      } else {
        paidCell.innerHTML = `<div style="text-align: center;">✓</div>`;
      }
      
      // Botões de ação
      actionsCell.className = 'actions-cell';
      actionsCell.innerHTML = `
        <button class="btn btn-icon btn-outline edit-transaction-btn" data-id="${transaction.id}" aria-label="Editar">
          <svg width="16" height="16"><use href="#icon-edit"></use></svg>
        </button>
        <button class="btn btn-icon btn-outline delete-transaction-btn" data-id="${transaction.id}" aria-label="Excluir" ${transaction.isRecurrent ? 'data-recurrent="true"' : ''}>
          <svg width="16" height="16"><use href="#icon-trash"></use></svg>
        </button>`;
    });
    
    attachTransactionListeners();
  };

  const attachTransactionListeners = () => {
    // Adicionar event listeners às checkboxes de marcar como pago/recebido
    $$('.mark-paid-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', e => {
        updateTransactionStatus(e.target.dataset.id, e.target.checked ? 'paid' : 'pending');
      });
    });
    
    $$('.mark-received-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', e => {
        updateTransactionStatus(e.target.dataset.id, e.target.checked ? 'received' : 'pending');
      });
    });
    
    // Adicionar event listeners aos botões de editar e excluir
    $$('.edit-transaction-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        openEditModal(e.currentTarget.dataset.id);
      });
    });
    
    $$('.delete-transaction-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        const transactionId = e.currentTarget.dataset.id;
        const isRecurrent = e.currentTarget.hasAttribute('data-recurrent');
        
        if (isRecurrent) {
          $('#recurrenceDeleteOptions').style.display = 'block';
        } else {
          $('#recurrenceDeleteOptions').style.display = 'none';
        }
        
        state.currentTransaction = state.transactions.find(t => t.id === transactionId);
        $('#confirmDeleteBtn').dataset.id = transactionId;
        openModal('deleteConfirmModal');
      });
    });
    
    // Adicionar event listeners aos headers para ordenação
    $$('#transactionsTable th.sortable').forEach(th => {
      th.addEventListener('click', e => {
        const column = e.currentTarget.dataset.sort;
        
        // Se clicar na mesma coluna, alterna a direção
        if (state.sortColumn === column) {
          state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          state.sortColumn = column;
          state.sortDirection = 'asc';
        }
        
        // Atualiza as classes visuais
        $$('#transactionsTable th').forEach(header => {
          header.classList.remove('sorted-asc', 'sorted-desc');
        });
        
        e.currentTarget.classList.add(`sorted-${state.sortDirection}`);
        
        // Reordena e atualiza a lista
        updateTransactionsList();
      });
    });
  };

  const createTransactionFilters = () => {
    const filtersContainer = $('#transaction-filters');
    if (!filtersContainer) return;
    
    filtersContainer.innerHTML = '';
    
    const typeFilter = document.createElement('div');
    typeFilter.className = 'select-wrapper';
    typeFilter.innerHTML = `
      <select id="typeFilter" class="select">
        <option value="">Todos os Tipos</option>
        <option value="income">Receitas</option>
        <option value="expense">Despesas</option>
      </select>
      <svg class="select-icon" width="16" height="16"><use href="#icon-chevron-down"></use></svg>`;
    filtersContainer.appendChild(typeFilter);
    
    const statusFilter = document.createElement('div');
    statusFilter.className = 'select-wrapper';
    statusFilter.innerHTML = `
      <select id="statusFilter" class="select">
        <option value="">Todos os Status</option>
        <option value="paid">Pagos</option>
        <option value="pending">Pendentes</option>
        <option value="received">Recebidos</option>
        <option value="scheduled">Agendados</option>
      </select>
      <svg class="select-icon" width="16" height="16"><use href="#icon-chevron-down"></use></svg>`;
    filtersContainer.appendChild(statusFilter);
    
    const categoryFilter = document.createElement('div');
    categoryFilter.className = 'select-wrapper';
    categoryFilter.innerHTML = `
      <select id="categoryFilter" class="select">
        <option value="">Todas as Categorias</option>
      </select>
      <svg class="select-icon" width="16" height="16"><use href="#icon-chevron-down"></use></svg>`;
    filtersContainer.appendChild(categoryFilter);
    
    const paymentMethodFilter = document.createElement('div');
    paymentMethodFilter.className = 'select-wrapper';
    paymentMethodFilter.innerHTML = `
      <select id="paymentMethodFilter" class="select">
        <option value="">Todos os Métodos</option>
      </select>
      <svg class="select-icon" width="16" height="16"><use href="#icon-chevron-down"></use></svg>`;
    filtersContainer.appendChild(paymentMethodFilter);
    
    const personFilter = document.createElement('div');
    personFilter.className = 'select-wrapper';
    personFilter.innerHTML = `
      <select id="personFilter" class="select">
        <option value="">Todas as Pessoas</option>
      </select>
      <svg class="select-icon" width="16" height="16"><use href="#icon-chevron-down"></use></svg>`;
    filtersContainer.appendChild(personFilter);
    
    // Preencher as opções dos filtros com dados dinâmicos
    const categorySelect = $('#categoryFilter');
    if (categorySelect) {
      // Adicionar categorias de receita e despesa ao filtro
      [].concat(state.categories.income, state.categories.expense).forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.id;
        option.textContent = `${cat.icon} ${cat.name}`;
        categorySelect.appendChild(option);
      });
    }
    
    const paymentMethodSelect = $('#paymentMethodFilter');
    if (paymentMethodSelect) {
      state.paymentMethods.forEach(method => {
        const option = document.createElement('option');
        option.value = method.id;
        option.textContent = `${method.icon} ${method.name}`;
        paymentMethodSelect.appendChild(option);
      });
    }
    
    const personSelect = $('#personFilter');
    if (personSelect) {
      state.people.forEach(person => {
        const option = document.createElement('option');
        option.value = person.id;
        option.textContent = `${person.icon} ${person.name}`;
        personSelect.appendChild(option);
      });
    }
    
    // Adicionar listeners para atualizar os filtros ao mudar
    $('#typeFilter').addEventListener('change', e => {
      state.filters.transactionType = e.target.value;
      updateTransactionsList();
    });
    
    $('#statusFilter').addEventListener('change', e => {
      state.filters.status = e.target.value;
      updateTransactionsList();
    });
    
    $('#categoryFilter').addEventListener('change', e => {
      state.filters.category = e.target.value;
      updateTransactionsList();
    });
    
    $('#paymentMethodFilter').addEventListener('change', e => {
      state.filters.paymentMethod = e.target.value;
      updateTransactionsList();
    });
    
    $('#personFilter').addEventListener('change', e => {
      state.filters.person = e.target.value;
      updateTransactionsList();
    });
  };

  const openNewIncomeModal = () => {
    $('#incomeForm').reset(); 
    const today = new Date();
    setDateInputValue('incomeDate', today);
    
    // Mostra os campos relevantes
    $('#incomeRecurrenceGroup').style.display = 'none';
    $('#incomeStatusGroup').style.display = 'block';
    
    // Reseta os checkboxes e radios para valores padrão
    $('#incomeIsRecurrent').checked = false;
    $('#incomeStatusReceived').checked = true;
    
    // Atualiza os selects com categorias, métodos de pagamento
    updateCategorySelects();
    updatePaymentMethodSelects();
    
    openModal('incomeModal');
  };
  
  const openNewExpenseModal = () => {
    $('#expenseForm').reset(); 
    const today = new Date();
    setDateInputValue('expenseDate', today);
    setDateInputValue('expenseDueDate', today);
    
    // Mostra e esconde campos específicos
    $('#expenseCreditCard').value = '';
    $('#creditCardGroup').style.display = 'none';
    $('#expenseRecurrenceGroup').style.display = 'none';
    $('#scheduledDateGroup').style.display = 'none';
    $('#expenseDueDateGroup').style.display = 'block';
    $('#expenseStatusGroup').style.display = 'block';
    
    // Reseta os checkboxes e radios para valores padrão
    $('#expenseIsRecurrent').checked = false;
    $('#expenseStatusPending').checked = true;
    
    // Define os tipos de despesa como não marcados inicialmente
    $('#expenseTypeFixed').checked = false;
    $('#expenseTypeVariable').checked = false;
    
    // Atualiza os selects com categorias, métodos de pagamento, etc.
    updateCategorySelects();
    updatePaymentMethodSelects();
    updatePeopleSelects();
    updateCreditCardSelects();
    
    openModal('expenseModal');
  };
  
  const openEditModal = (transactionId) => {
    const transaction = state.transactions.find(t => t.id === transactionId);
    if (!transaction) return;
    
    state.currentTransaction = transaction;
    
    $('#editForm').reset();
    $('#editTransactionId').value = transaction.id;
    $('#editTransactionType').value = transaction.type;
    $('#editName').value = transaction.name;
    $('#editAmount').value = transaction.amount;
    
    // Define os campos de data
    setDateInputValue('editDate', transaction.date);
    if (transaction.dueDate) setDateInputValue('editDueDate', transaction.dueDate);
    
    // Configurar o select de categoria
    $('#editCategory').dataset.type = transaction.type;
    updateCategorySelects();
    
    // Configurar outros campos com base no tipo da transação
    if (transaction.type === 'expense') {
      $('#editPersonGroup').style.display = 'block';
      $('#editDueDateGroup').style.display = 'block';
      $('#editExpenseTypeGroup').style.display = 'block';
      
      // Define o tipo de despesa selecionado
      if (transaction.isFixed === 'fixed') {
        $('#editExpenseTypeFixed').checked = true;
      } else if (transaction.isFixed === 'variable') {
        $('#editExpenseTypeVariable').checked = true;
      }
      
      // Preenche o select de pessoa
      updatePeopleSelects();
      $('#editPerson').value = transaction.person || '';
    } else {
      $('#editPersonGroup').style.display = 'none';
      $('#editDueDateGroup').style.display = 'none';
      $('#editExpenseTypeGroup').style.display = 'none';
    }
    
    // Configurar select de método de pagamento
    updatePaymentMethodSelects();
    $('#editPaymentMethod').value = transaction.paymentMethod || '';
    
    // Opções específicas para cartão de crédito
    $('#editCreditCardGroup').style.display = transaction.paymentMethod === 'credito' ? 'block' : 'none';
    if (transaction.paymentMethod === 'credito') {
      updateCreditCardSelects();
      $('#editCreditCard').value = transaction.creditCardId || '';
    }
    
    // Opções de parcelas
    $('#editIsRecurrent').checked = transaction.isRecurrent || false;
    $('#editRecurrenceGroup').style.display = transaction.isRecurrent ? 'block' : 'none';
    $('#editInstallments').value = transaction.installments || 2;
    
    // Configurar opções de status com base no tipo
    const statusGroup = $('#editStatusGroup');
    statusGroup.innerHTML = ''; 
    
    if (transaction.type === 'income') {
      statusGroup.innerHTML = `
        <div class="radio-wrapper">
          <input type="radio" class="radio" id="editStatusReceived" name="editStatus" value="received" ${transaction.status === 'received' ? 'checked' : ''}>
          <label class="radio-label" for="editStatusReceived">Recebido</label>
        </div>
        <div class="radio-wrapper">
          <input type="radio" class="radio" id="editStatusPending" name="editStatus" value="pending" ${transaction.status === 'pending' ? 'checked' : ''}>
          <label class="radio-label" for="editStatusPending">A Receber</label>
        </div>`;
    } else { // expense
      statusGroup.innerHTML = `
        <div class="radio-wrapper">
          <input type="radio" class="radio" id="editStatusPaid" name="editStatus" value="paid" ${transaction.status === 'paid' ? 'checked' : ''}>
          <label class="radio-label" for="editStatusPaid">Pago</label>
        </div>
        <div class="radio-wrapper">
          <input type="radio" class="radio" id="editStatusPending" name="editStatus" value="pending" ${transaction.status === 'pending' ? 'checked' : ''}>
          <label class="radio-label" for="editStatusPending">Pendente</label>
        </div>
        <div class="radio-wrapper">
          <input type="radio" class="radio" id="editStatusScheduled" name="editStatus" value="scheduled" ${transaction.status === 'scheduled' ? 'checked' : ''}>
          <label class="radio-label" for="editStatusScheduled">Agendado</label>
        </div>`;
    }
    
    // Configurar campo de data de agendamento
    $('#editScheduledDateGroup').style.display = transaction.status === 'scheduled' ? 'block' : 'none';
    if (transaction.scheduledDate) setDateInputValue('editScheduledDate', transaction.scheduledDate);
    
    // Configurar observações
    $('#editNotes').value = transaction.notes || '';
    
    // Configurar título do modal
    $('#editModalTitle').textContent = transaction.type === 'income' ? 'Editar Receita' : 'Editar Despesa';
    
    // Adicionar listener para campo de status agendado
    const updateScheduledDateField = () => {
      const isScheduled = $('#editStatusScheduled')?.checked || false;
      $('#editScheduledDateGroup').style.display = isScheduled ? 'block' : 'none';
      if (isScheduled && !$('#editScheduledDate').value) {
        setDateInputValue('editScheduledDate', new Date());
      }
    };
    
    $$('input[name="editStatus"]').forEach(radio => radio.addEventListener('change', updateScheduledDateField));
    
    // Adicionar listener para método de pagamento (cartão de crédito)
    $('#editPaymentMethod').addEventListener('change', function() {
      const isCredit = this.value === 'credito';
      $('#editCreditCardGroup').style.display = isCredit ? 'block' : 'none';
      // Se for crédito, esconder o status para transações recorrentes
      handleEditStatusVisibility();
    });
    
    const handleEditStatusVisibility = () => {
      const isCredit = $('#editPaymentMethod').value === 'credito';
      const isRecurrent = $('#editIsRecurrent').checked;
      
      if ((isCredit || isRecurrent) && transaction.type === 'expense') {
        $('#editStatusOuterGroup').style.display = 'none';
      } else {
        $('#editStatusOuterGroup').style.display = 'block';
      }
    };
    
    $('#editIsRecurrent').addEventListener('change', function() {
      $('#editRecurrenceGroup').style.display = this.checked ? 'block' : 'none';
      handleEditStatusVisibility();
    });
    
    // Inicializar a visibilidade do status
    handleEditStatusVisibility();
    
    openModal('editModal');
  };
  
  const openEditCardModal = (card) => {
    $('#cardForm').reset();
    $('#newCardModalTitle').textContent = 'Editar Cartão';
    $('#saveCardBtn').textContent = 'Atualizar Cartão';
    $('#saveCardBtn').dataset.action = 'update';
    $('#saveCardBtn').dataset.id = card.id;
    
    $('#cardName').value = card.name;
    $('#cardLimit').value = card.limit;
    $('#cardClosingDay').value = card.closingDay;
    $('#cardDueDay').value = card.dueDay;
    
    openModal('newCardModal');
  };

  const renderCategoriesList = () => {
    const incomeCategoriesList = $('#incomeCategoriesList');
    const expenseCategoriesList = $('#expenseCategoriesList');
    
    if (incomeCategoriesList) {
      incomeCategoriesList.innerHTML = '';
      state.categories.income.forEach(category => {
        const item = document.createElement('div');
        item.className = 'category-item';
        item.innerHTML = `
          <div class="category-item-content">
            <div class="category-item-icon" style="background-color: var(--color-income);">${category.icon}</div>
            <div>${category.name}</div>
          </div>
          <div class="category-item-actions">
            <button class="btn btn-icon btn-outline edit-category-btn" data-id="${category.id}" data-type="income">
              <svg width="16" height="16"><use href="#icon-edit"></use></svg>
            </button>
            <button class="btn btn-icon btn-outline delete-category-btn" data-id="${category.id}" data-type="income">
              <svg width="16" height="16"><use href="#icon-trash"></use></svg>
            </button>
          </div>
        `;
        incomeCategoriesList.appendChild(item);
      });
    }
    
    if (expenseCategoriesList) {
      expenseCategoriesList.innerHTML = '';
      state.categories.expense.forEach(category => {
        const item = document.createElement('div');
        item.className = 'category-item';
        item.innerHTML = `
          <div class="category-item-content">
            <div class="category-item-icon" style="background-color: var(--color-expense);">${category.icon}</div>
            <div>${category.name}</div>
          </div>
          <div class="category-item-actions">
            <button class="btn btn-icon btn-outline edit-category-btn" data-id="${category.id}" data-type="expense">
              <svg width="16" height="16"><use href="#icon-edit"></use></svg>
            </button>
            <button class="btn btn-icon btn-outline delete-category-btn" data-id="${category.id}" data-type="expense">
              <svg width="16" height="16"><use href="#icon-trash"></use></svg>
            </button>
          </div>
        `;
        expenseCategoriesList.appendChild(item);
      });
    }
    
    $$('.edit-category-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        const categoryId = e.currentTarget.dataset.id;
        const categoryType = e.currentTarget.dataset.type;
        const category = state.categories[categoryType].find(c => c.id === categoryId);
        if (category) {
          $('#editCategoryId').value = category.id;
          $('#editCategoryType').value = categoryType;
          $('#editCategoryName').value = category.name;
          $('#editCategoryIconInput').value = category.icon;
          $('#editCategoryIconPreview').textContent = category.icon;
          $('#editCategoryTitle').textContent = `Editar Categoria de ${categoryType === 'income' ? 'Receita' : 'Despesa'}`;
          openModal('editCategoryModal');
        }
      });
    });
    
    $$('.delete-category-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        const categoryId = e.currentTarget.dataset.id;
        const categoryType = e.currentTarget.dataset.type;
        deleteCategory(categoryId, categoryType);
      });
    });
  };

  const renderPaymentMethodsList = () => {
    const list = $('#paymentMethodsList');
    if (!list) return;
    
    list.innerHTML = '';
    state.paymentMethods.forEach(method => {
      const item = document.createElement('div');
      item.className = 'category-item';
      item.innerHTML = `
        <div class="category-item-content">
          <div class="category-item-icon" style="background-color: var(--color-primary);">${method.icon}</div>
          <div>${method.name}</div>
        </div>
        <div class="category-item-actions">
          <button class="btn btn-icon btn-outline edit-payment-method-btn" data-id="${method.id}">
            <svg width="16" height="16"><use href="#icon-edit"></use></svg>
          </button>
          <button class="btn btn-icon btn-outline delete-payment-method-btn" data-id="${method.id}">
            <svg width="16" height="16"><use href="#icon-trash"></use></svg>
          </button>
        </div>
      `;
      list.appendChild(item);
    });
    
    $$('.edit-payment-method-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        const methodId = e.currentTarget.dataset.id;
        const method = state.paymentMethods.find(m => m.id === methodId);
        if (method) {
          $('#editCategoryId').value = method.id;
          $('#editCategoryType').value = 'paymentMethod';
          $('#editCategoryName').value = method.name;
          $('#editCategoryIconInput').value = method.icon;
          $('#editCategoryIconPreview').textContent = method.icon;
          $('#editCategoryTitle').textContent = 'Editar Forma de Pagamento';
          openModal('editCategoryModal');
        }
      });
    });
    
    $$('.delete-payment-method-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        const methodId = e.currentTarget.dataset.id;
        deletePaymentMethod(methodId);
      });
    });
  };

  const updatePeopleList = () => {
    const peopleList = $('#peopleList');
    if (!peopleList) return;
    
    peopleList.innerHTML = '';
    state.people.forEach(person => {
      const item = document.createElement('div');
      item.className = 'category-item';
      item.innerHTML = `
        <div class="category-item-content">
          <div class="category-item-icon" style="background-color: var(--color-tertiary);">${person.icon}</div>
          <div>${person.name}</div>
        </div>
        <div class="category-item-actions">
          <button class="btn btn-icon btn-outline edit-person-btn" data-id="${person.id}">
            <svg width="16" height="16"><use href="#icon-edit"></use></svg>
          </button>
          <button class="btn btn-icon btn-outline delete-person-btn" data-id="${person.id}">
            <svg width="16" height="16"><use href="#icon-trash"></use></svg>
          </button>
        </div>
      `;
      peopleList.appendChild(item);
    });
    
    $$('.edit-person-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        const personId = e.currentTarget.dataset.id;
        const person = state.people.find(p => p.id === personId);
        if (person) {
          $('#editCategoryId').value = person.id;
          $('#editCategoryType').value = 'person';
          $('#editCategoryName').value = person.name;
          $('#editCategoryIconInput').value = person.icon;
          $('#editCategoryIconPreview').textContent = person.icon;
          $('#editCategoryTitle').textContent = 'Editar Pessoa';
          openModal('editCategoryModal');
        }
      });
    });
    
    $$('.delete-person-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        const personId = e.currentTarget.dataset.id;
        deletePerson(personId);
      });
    });
  };

  const renderInvestmentCategoriesList = () => {
    const list = $('#investmentCategoriesList');
    if (!list) return;
    
    list.innerHTML = '';
    state.categories.investment.forEach(category => {
      const item = document.createElement('div');
      item.className = 'category-item';
      item.innerHTML = `
        <div class="category-item-content">
          <div class="category-item-icon" style="background-color: var(--color-secondary);">${category.icon}</div>
          <div>${category.name}</div>
        </div>
        <div class="category-item-actions">
          <button class="btn btn-icon btn-outline edit-investment-category-btn" data-id="${category.id}">
            <svg width="16" height="16"><use href="#icon-edit"></use></svg>
          </button>
          <button class="btn btn-icon btn-outline delete-investment-category-btn" data-id="${category.id}">
            <svg width="16" height="16"><use href="#icon-trash"></use></svg>
          </button>
        </div>
      `;
      list.appendChild(item);
    });
    
    $$('.edit-investment-category-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        const categoryId = e.currentTarget.dataset.id;
        const category = state.categories.investment.find(c => c.id === categoryId);
        if (category) {
          $('#editCategoryId').value = category.id;
          $('#editCategoryType').value = 'investment';
          $('#editCategoryName').value = category.name;
          $('#editCategoryIconInput').value = category.icon;
          $('#editCategoryIconPreview').textContent = category.icon;
          $('#editCategoryTitle').textContent = 'Editar Categoria de Investimento';
          openModal('editCategoryModal');
        }
      });
    });
    
    $$('.delete-investment-category-btn').forEach(btn => {
      btn.addEventListener('click', e => {
        const categoryId = e.currentTarget.dataset.id;
        deleteCategory(categoryId, 'investment');
      });
    });
  };

  // Funções de CRUD
  const addTransaction = async (data) => {
    try {
      data.id = generateId();
      
      // Se for uma transação recorrente, gera as parcelas
      if (data.isRecurrent && data.installments && data.installments > 1) {
        const batch = db.batch();
        const transactions = [];
        const recurrenceMasterId = data.id;
        
        for (let i = 0; i < data.installments; i++) {
          const installmentTransaction = { ...data };
          installmentTransaction.id = i === 0 ? recurrenceMasterId : generateId();
          installmentTransaction.installmentNumber = i + 1;
          installmentTransaction.recurrenceMasterId = recurrenceMasterId;
          
          // Para meses subsequentes
          if (i > 0) {
            const date = parseLocalDateString(data.date);
            if (date) {
              date.setUTCMonth(date.getUTCMonth() + i);
              installmentTransaction.date = localDateToISOString(date);
            }
            
            if (data.dueDate) {
              const dueDate = parseLocalDateString(data.dueDate);
              if (dueDate) {
                dueDate.setUTCMonth(dueDate.getUTCMonth() + i);
                installmentTransaction.dueDate = localDateToISOString(dueDate);
              }
            }
            
            // Nome com número da parcela
            installmentTransaction.name = `${data.name} (${i+1}/${data.installments})`;
          }
          
          const docRef = db.collection('transactions').doc(installmentTransaction.id);
          batch.set(docRef, installmentTransaction);
          transactions.push(installmentTransaction);
        }
        
        await batch.commit();
        state.transactions = state.transactions.concat(transactions);
        
        // Se for cartão de crédito, atualiza o limite disponível apenas para primeira parcela
        if (data.paymentMethod === 'credito' && data.creditCardId) {
          await updateCardLimits(data.creditCardId, parseFloat(data.amount), 'add');
        }
      } else {
        // Transação simples
        await db.collection('transactions').doc(data.id).set(data);
        state.transactions.push(data);
        
        // Se for cartão de crédito, atualiza o limite disponível
        if (data.paymentMethod === 'credito' && data.creditCardId) {
          await updateCardLimits(data.creditCardId, parseFloat(data.amount), 'add');
        }
      }
      
      await fullUIRefresh();
      showToast(`${data.type === 'income' ? 'Receita' : 'Despesa'} adicionada com sucesso!`, 'success');
      return true;
    } catch (error) {
      console.error('Erro ao adicionar transação:', error);
      showToast('Erro ao salvar. Tente novamente.', 'error');
      return false;
    }
  };

  const updateTransaction = async (id, updates) => {
    try {
      const transaction = state.transactions.find(t => t.id === id);
      if (!transaction) throw new Error('Transação não encontrada');
      
      const oldAmount = parseFloat(transaction.amount);
      const newAmount = parseFloat(updates.amount);
      
      // Atualiza o cartão se necessário (mudanças de valor ou cartão)
      if (transaction.paymentMethod === 'credito' && transaction.creditCardId) {
        // Subtrai o valor antigo do limite usado
        await updateCardLimits(transaction.creditCardId, oldAmount, 'subtract');
      }
      
      if (updates.paymentMethod === 'credito' && updates.creditCardId) {
        // Adiciona o novo valor ao limite usado
        await updateCardLimits(updates.creditCardId, newAmount, 'add');
      }
      
      // Atualiza a transação no Firestore e no estado local
      await db.collection('transactions').doc(id).update(updates);
      const index = state.transactions.findIndex(t => t.id === id);
      if (index !== -1) {
        state.transactions[index] = { ...transaction, ...updates };
      }
      
      // Se esta transação for parte de uma série recorrente, pergunta se quer atualizar futuras
      if ((updates.updateFuture || updates.updateAllFuture) && 
          (transaction.isRecurrent || transaction.recurrenceMasterId) && 
          transaction.installments > 1) {
        
        const isFirstInstallment = !transaction.recurrenceMasterId || transaction.recurrenceMasterId === transaction.id;
        const masterId = transaction.recurrenceMasterId || transaction.id;
        
        // Encontra todas as transações futuras da mesma série
        const batch = db.batch();
        let futureUpdated = 0;
        
        state.transactions.forEach(t => {
          if (t.recurrenceMasterId === masterId || (isFirstInstallment && t.id === masterId)) {
            // Atualiza apenas futuras ou todas menos a atual
            const shouldUpdate = (updates.updateFuture && t.installmentNumber > transaction.installmentNumber) || 
                                 (updates.updateAllFuture && t.id !== transaction.id);
            
            if (shouldUpdate) {
              const futureUpdates = { ...updates };
              delete futureUpdates.updateFuture;
              delete futureUpdates.updateAllFuture;
              
              // Preserva data e vencimento específicos de cada parcela 
              delete futureUpdates.date;
              delete futureUpdates.dueDate;
              
              // Preserva numeração da parcela, master ID
              delete futureUpdates.installmentNumber;
              delete futureUpdates.recurrenceMasterId;
              
              // Mantém nome com número da parcela
              futureUpdates.name = `${updates.name.split('(')[0].trim()} (${t.installmentNumber}/${t.installments})`;
              
              // Atualiza no Firestore
              batch.update(db.collection('transactions').doc(t.id), futureUpdates);
              
              // Atualiza no estado local
              const idx = state.transactions.findIndex(tx => tx.id === t.id);
              if (idx !== -1) {
                state.transactions[idx] = { ...t, ...futureUpdates };
              }
              
              futureUpdated++;
            }
          }
        });
        
        if (futureUpdated > 0) {
          await batch.commit();
          showToast(`${futureUpdated} parcelas futuras atualizadas`, 'info');
        }
      }
      
      await fullUIRefresh();
      showToast('Transação atualizada com sucesso!', 'success');
      return true;
    } catch (error) {
      console.error('Erro ao atualizar transação:', error);
      showToast('Erro ao atualizar. Tente novamente.', 'error');
      return false;
    }
  };

  const updateTransactionStatus = async (id, newStatus) => {
    try {
      const transaction = state.transactions.find(t => t.id === id);
      if (!transaction) return false;
      
      // Ajuste rápido apenas para o status
      await db.collection('transactions').doc(id).update({ status: newStatus });
      
      // Atualiza no estado local
      transaction.status = newStatus;
      
      await fullUIRefresh();
      const successMessage = transaction.type === 'income' 
        ? (newStatus === 'received' ? 'Receita marcada como recebida' : 'Receita marcada como pendente')
        : (newStatus === 'paid' ? 'Despesa marcada como paga' : 'Despesa marcada como pendente');
      
      showToast(successMessage, 'success');
      return true;
    } catch (error) {
      console.error('Erro ao atualizar status:', error);
      showToast('Erro ao atualizar status. Tente novamente.', 'error');
      return false;
    }
  };

  const deleteTransaction = async (id, deleteOption = 'single') => {
    try {
      const transaction = state.transactions.find(t => t.id === id);
      if (!transaction) throw new Error('Transação não encontrada');
      
      // Se for cartão de crédito, atualiza o limite usado
      if (transaction.paymentMethod === 'credito' && transaction.creditCardId && transaction.status !== 'paid') {
        await updateCardLimits(transaction.creditCardId, parseFloat(transaction.amount), 'subtract');
      }
      
      if (deleteOption === 'single') {
        // Exclui apenas a transação atual
        await db.collection('transactions').doc(id).delete();
        state.transactions = state.transactions.filter(t => t.id !== id);
      } else if (deleteOption === 'future' && 
                (transaction.isRecurrent || transaction.recurrenceMasterId) &&
                transaction.installments > 1) {
        
        // Exclui esta e todas as futuras
        const masterId = transaction.recurrenceMasterId || transaction.id;
        const currentInstallment = transaction.installmentNumber || 1;
        
        const batch = db.batch();
        const idsToDelete = [];
        
        // Encontra todas as transações a excluir
        state.transactions.forEach(t => {
          if ((t.recurrenceMasterId === masterId || t.id === masterId) && 
              (t.installmentNumber >= currentInstallment || t.id === id)) {
            batch.delete(db.collection('transactions').doc(t.id));
            idsToDelete.push(t.id);
            
            // Atualizar limite do cartão se necessário
            if (t.paymentMethod === 'credito' && t.creditCardId && t.status !== 'paid' && t.id !== id) {
              // Já atualizamos o da transação principal acima
              updateCardLimits(t.creditCardId, parseFloat(t.amount), 'subtract');
            }
          }
        });
        
        await batch.commit();
        state.transactions = state.transactions.filter(t => !idsToDelete.includes(t.id));
      }
      
      await fullUIRefresh();
      showToast('Transação excluída com sucesso!', 'success');
      return true;
    } catch (error) {
      console.error('Erro ao excluir transação:', error);
      showToast('Erro ao excluir. Tente novamente.', 'error');
      return false;
    }
  };

  // Funções para manipulação de categorias e itens de lista
  const addCategory = async (categoryData, type) => {
    try {
      const category = { ...categoryData, id: generateId(), type: type };
      await db.collection('categories').doc(category.id).set(category);
      state.categories[type].push(category);
      updateAllSelectsAndLists();
      showToast('Categoria adicionada com sucesso!', 'success');
      return true;
    } catch (error) {
      console.error('Erro ao adicionar categoria:', error);
      showToast('Erro ao adicionar categoria. Tente novamente.', 'error');
      return false;
    }
  };

  const updateCategory = async (id, updates, type) => {
    try {
      await db.collection('categories').doc(id).update(updates);
      const index = state.categories[type].findIndex(c => c.id === id);
      if (index !== -1) {
        state.categories[type][index] = { ...state.categories[type][index], ...updates };
      }
      
      // Atualiza nome da categoria em transações existentes
      const batch = db.batch();
      let updatedCount = 0;
      
      state.transactions.forEach(t => {
        if (t.category === id) {
          batch.update(db.collection('transactions').doc(t.id), { categoryName: updates.name });
          t.categoryName = updates.name;
          updatedCount++;
        }
      });
      
      if (updatedCount > 0) {
        await batch.commit();
      }
      
      updateAllSelectsAndLists();
      showToast('Categoria atualizada com sucesso!', 'success');
      return true;
    } catch (error) {
      console.error('Erro ao atualizar categoria:', error);
      showToast('Erro ao atualizar categoria. Tente novamente.', 'error');
      return false;
    }
  };

  const deleteCategory = async (id, type) => {
    try {
      // Verifica se há transações usando esta categoria
      const transactionsWithCategory = state.transactions.filter(t => t.category === id);
      
      if (transactionsWithCategory.length > 0) {
        const confirmDelete = confirm(
          `Esta categoria está sendo usada em ${transactionsWithCategory.length} transações. Ao excluí-la, essas transações permanecerão com a referência à categoria, mas o nome será mantido. Deseja continuar?`
        );
        
        if (!confirmDelete) return false;
        
        // Atualiza as transações para manter o nome da categoria
        const category = state.categories[type].find(c => c.id === id);
        if (category) {
          const batch = db.batch();
          
          transactionsWithCategory.forEach(t => {
            batch.update(db.collection('transactions').doc(t.id), { categoryName: category.name });
            const idx = state.transactions.findIndex(tx => tx.id === t.id);
            if (idx !== -1) {
              state.transactions[idx].categoryName = category.name;
            }
          });
          
          await batch.commit();
        }
      }
      
      // Exclui a categoria
      await db.collection('categories').doc(id).delete();
      state.categories[type] = state.categories[type].filter(c => c.id !== id);
      
      updateAllSelectsAndLists();
      showToast('Categoria excluída com sucesso!', 'success');
      return true;
    } catch (error) {
      console.error('Erro ao excluir categoria:', error);
      showToast('Erro ao excluir categoria. Tente novamente.', 'error');
      return false;
    }
  };

  const addPaymentMethod = async (methodData) => {
    try {
      const method = { ...methodData, id: generateId() };
      await db.collection('paymentMethods').doc(method.id).set(method);
      state.paymentMethods.push(method);
      updateAllSelectsAndLists();
      showToast('Forma de pagamento adicionada com sucesso!', 'success');
      return true;
    } catch (error) {
      console.error('Erro ao adicionar forma de pagamento:', error);
      showToast('Erro ao adicionar forma de pagamento. Tente novamente.', 'error');
      return false;
    }
  };

  const updatePaymentMethod = async (id, updates) => {
    try {
      await db.collection('paymentMethods').doc(id).update(updates);
      const index = state.paymentMethods.findIndex(m => m.id === id);
      if (index !== -1) {
        state.paymentMethods[index] = { ...state.paymentMethods[index], ...updates };
      }
      
      // Atualizar nome do método de pagamento em transações existentes
      const batch = db.batch();
      let updatedCount = 0;
      
      state.transactions.forEach(t => {
        if (t.paymentMethod === id) {
          batch.update(db.collection('transactions').doc(t.id), { paymentMethodName: updates.name });
          t.paymentMethodName = updates.name;
          updatedCount++;
        }
      });
      
      if (updatedCount > 0) {
        await batch.commit();
      }
      
      updateAllSelectsAndLists();
      showToast('Forma de pagamento atualizada com sucesso!', 'success');
      return true;
    } catch (error) {
      console.error('Erro ao atualizar forma de pagamento:', error);
      showToast('Erro ao atualizar forma de pagamento. Tente novamente.', 'error');
      return false;
    }
  };

  const deletePaymentMethod = async (id) => {
    try {
      // Verifica se há transações usando este método de pagamento
      const transactionsWithMethod = state.transactions.filter(t => t.paymentMethod === id);
      
      if (transactionsWithMethod.length > 0) {
        const confirmDelete = confirm(
          `Esta forma de pagamento está sendo usada em ${transactionsWithMethod.length} transações. Ao excluí-la, essas transações permanecerão com a referência ao método, mas o nome será mantido. Deseja continuar?`
        );
        
        if (!confirmDelete) return false;
        
        // Atualiza as transações para manter o nome do método
        const method = state.paymentMethods.find(m => m.id === id);
        if (method) {
          const batch = db.batch();
          
          transactionsWithMethod.forEach(t => {
            batch.update(db.collection('transactions').doc(t.id), { paymentMethodName: method.name });
            const idx = state.transactions.findIndex(tx => tx.id === t.id);
            if (idx !== -1) {
              state.transactions[idx].paymentMethodName = method.name;
            }
          });
          
          await batch.commit();
        }
      }
      
      // Exclui o método de pagamento
      await db.collection('paymentMethods').doc(id).delete();
      state.paymentMethods = state.paymentMethods.filter(m => m.id !== id);
      
      updateAllSelectsAndLists();
      showToast('Forma de pagamento excluída com sucesso!', 'success');
      return true;
    } catch (error) {
      console.error('Erro ao excluir forma de pagamento:', error);
      showToast('Erro ao excluir forma de pagamento. Tente novamente.', 'error');
      return false;
    }
  };

  const addPerson = async (personData) => {
    try {
      const person = { ...personData, id: generateId() };
      await db.collection('people').doc(person.id).set(person);
      state.people.push(person);
      updateAllSelectsAndLists();
      showToast('Pessoa adicionada com sucesso!', 'success');
      return true;
    } catch (error) {
      console.error('Erro ao adicionar pessoa:', error);
      showToast('Erro ao adicionar pessoa. Tente novamente.', 'error');
      return false;
    }
  };

  const updatePerson = async (id, updates) => {
    try {
      await db.collection('people').doc(id).update(updates);
      const index = state.people.findIndex(p => p.id === id);
      if (index !== -1) {
        state.people[index] = { ...state.people[index], ...updates };
      }
      
      // Atualizar nome da pessoa em transações existentes
      const batch = db.batch();
      let updatedCount = 0;
      
      state.transactions.forEach(t => {
        if (t.person === id) {
          batch.update(db.collection('transactions').doc(t.id), { personName: updates.name });
          t.personName = updates.name;
          updatedCount++;
        }
      });
      
      if (updatedCount > 0) {
        await batch.commit();
      }
      
      updateAllSelectsAndLists();
      showToast('Pessoa atualizada com sucesso!', 'success');
      return true;
    } catch (error) {
      console.error('Erro ao atualizar pessoa:', error);
      showToast('Erro ao atualizar pessoa. Tente novamente.', 'error');
      return false;
    }
  };

  const deletePerson = async (id) => {
    try {
      // Verifica se há transações usando esta pessoa
      const transactionsWithPerson = state.transactions.filter(t => t.person === id);
      
      if (transactionsWithPerson.length > 0) {
        const confirmDelete = confirm(
          `Esta pessoa está associada a ${transactionsWithPerson.length} transações. Ao excluí-la, essas transações permanecerão com a referência à pessoa, mas o nome será mantido. Deseja continuar?`
        );
        
        if (!confirmDelete) return false;
        
        // Atualiza as transações para manter o nome da pessoa
        const person = state.people.find(p => p.id === id);
        if (person) {
          const batch = db.batch();
          
          transactionsWithPerson.forEach(t => {
            batch.update(db.collection('transactions').doc(t.id), { personName: person.name });
            const idx = state.transactions.findIndex(tx => tx.id === t.id);
            if (idx !== -1) {
              state.transactions[idx].personName = person.name;
            }
          });
          
          await batch.commit();
        }
      }
      
      // Exclui a pessoa
      await db.collection('people').doc(id).delete();
      state.people = state.people.filter(p => p.id !== id);
      
      updateAllSelectsAndLists();
      showToast('Pessoa excluída com sucesso!', 'success');
      return true;
    } catch (error) {
      console.error('Erro ao excluir pessoa:', error);
      showToast('Erro ao excluir pessoa. Tente novamente.', 'error');
      return false;
    }
  };

  // Função para atualizar todos os elementos da UI
  const fullUIRefresh = async () => {
    updateKPIs();
    updateCharts();
    updateTransactionsList();
    generateInsights();
    renderCommitments();
    renderInvestmentCards();
    updateCardsList();
  };

  // Inicialização do aplicativo
  const initApp = async () => {
    initTheme();
    updateYearOptions();
    createCharts();
    
    // Configurar o mês e ano atuais como padrão
    const currentDate = new Date();
    state.year = currentDate.getFullYear();
    state.month = currentDate.getMonth();
    
    $('#yearSelect').value = state.year;
    $('#monthSelect').value = state.month;
    
    // Event listeners para mudança de mês/ano
    $('#yearSelect').addEventListener('change', e => {
      state.year = parseInt(e.target.value, 10);
      updateMonthYearTitle();
      fullUIRefresh();
    });
    
    $('#monthSelect').addEventListener('change', e => {
      state.month = parseInt(e.target.value, 10);
      updateMonthYearTitle();
      fullUIRefresh();
    });
    
    // Event listeners para os botões principais
    $('#newIncomeBtn').addEventListener('click', openNewIncomeModal);
    $('#newExpenseBtn').addEventListener('click', openNewExpenseModal);
    $('#cardsBtn').addEventListener('click', () => openModal('cardsListModal'));
    $('#categoriesBtn').addEventListener('click', () => openModal('categoriesModal'));
    $('#investmentsBtn').addEventListener('click', () => openModal('investmentsModal'));
    $('#commitmentsHeader').addEventListener('click', toggleCommitments);
    
    // Cancelar modais
    $$('.modal-close, [id$=CancelBtn], [id^=close]').forEach(el => {
      el.addEventListener('click', function() {
        const modalId = this.closest('.modal-backdrop').id;
        closeModal(modalId);
      });
    });
    
    // Fechar modal ao clicar no backdrop
    $$('.modal-backdrop').forEach(modal => {
      modal.addEventListener('click', function(e) {
        if (e.target === this) closeModal(this.id);
      });
    });
    
    // Event Listeners para o modal de receita
    $('#incomePaymentMethod').addEventListener('change', function() {
      handleStatusField('income');
    });
    
    $('#incomeIsRecurrent').addEventListener('change', function() {
      $('#incomeRecurrenceGroup').style.display = this.checked ? 'block' : 'none';
      handleStatusField('income');
    });
    
    $('#saveIncomeBtn').addEventListener('click', async function() {
      const name = $('#incomeName').value.trim();
      const amount = parseFloat($('#incomeAmount').value.trim() || '0');
      const category = $('#incomeCategory').value;
      const date = getDateInputValue('incomeDate');
      const paymentMethod = $('#incomePaymentMethod').value;
      const isRecurrent = $('#incomeIsRecurrent').checked;
      const installments = parseInt($('#incomeInstallments').value || '1', 10);
      const status = $('input[name="incomeStatus"]:checked')?.value || 'pending';
      const notes = $('#incomeNotes').value.trim();
      
      if (!name) return showToast('Informe o nome da receita', 'warning');
      if (amount <= 0) return showToast('Informe um valor válido', 'warning');
      if (!category) return showToast('Selecione uma categoria', 'warning');
      if (!date) return showToast('Informe a data da receita', 'warning');
      if (!paymentMethod) return showToast('Selecione a forma de recebimento', 'warning');
      
      const income = {
        type: 'income',
        name,
        amount,
        category,
        categoryName: state.categories.income.find(c => c.id === category)?.name,
        date: localDateToISOString(date),
        paymentMethod,
        paymentMethodName: state.paymentMethods.find(m => m.id === paymentMethod)?.name,
        isRecurrent,
        installments: isRecurrent ? installments : 1,
        status,
        notes,
        createdAt: localDateToISOString(new Date())
      };
      
      const success = await addTransaction(income);
      if (success) closeModal('incomeModal');
    });
    
    // Event Listeners para o modal de despesa
    $('#expensePaymentMethod').addEventListener('change', function() {
      const isCredit = this.value === 'credito';
      $('#creditCardGroup').style.display = isCredit ? 'block' : 'none';
      handleStatusField('expense');
    });
    
    $('#expenseIsRecurrent').addEventListener('change', function() {
      $('#expenseRecurrenceGroup').style.display = this.checked ? 'block' : 'none';
      handleStatusField('expense');
    });
    
    $$('input[name="expenseStatus"]').forEach(radio => {
      radio.addEventListener('change', function() {
        const isScheduled = this.value === 'scheduled';
        $('#scheduledDateGroup').style.display = isScheduled ? 'block' : 'none';
        
        if (isScheduled && !$('#expenseScheduledDate').value) {
          setDateInputValue('expenseScheduledDate', new Date());
        }
      });
    });
    
    $('#saveExpenseBtn').addEventListener('click', async function() {
      const name = $('#expenseName').value.trim();
      const amount = parseFloat($('#expenseAmount').value.trim() || '0');
      const paymentMethod = $('#expensePaymentMethod').value;
      const creditCardId = paymentMethod === 'credito' ? $('#expenseCreditCard').value : null;
      const category = $('#expenseCategory').value;
      const person = $('#expensePerson').value;
      const isFixed = $('input[name="expenseType"]:checked')?.value || 'variable';
      const date = getDateInputValue('expenseDate');
      const dueDate = getDateInputValue('expenseDueDate');
      const isRecurrent = $('#expenseIsRecurrent').checked;
      const installments = parseInt($('#expenseInstallments').value || '1', 10);
      const status = $('input[name="expenseStatus"]:checked')?.value || 'pending';
      const scheduledDate = status === 'scheduled' ? getDateInputValue('expenseScheduledDate') : null;
      const notes = $('#expenseNotes').value.trim();
      
      if (!name) return showToast('Informe o nome da despesa', 'warning');
      if (amount <= 0) return showToast('Informe um valor válido', 'warning');
      if (!paymentMethod) return showToast('Selecione a forma de pagamento', 'warning');
      if (paymentMethod === 'credito' && !creditCardId) return showToast('Selecione o cartão de crédito', 'warning');
      if (!category) return showToast('Selecione uma categoria', 'warning');
      if (!isFixed) return showToast('Selecione o tipo de despesa (fixa ou variável)', 'warning');
      if (!date) return showToast('Informe a data da despesa', 'warning');
      if (paymentMethod !== 'credito' && !dueDate) return showToast('Informe a data de vencimento', 'warning');
      if (status === 'scheduled' && !scheduledDate) return showToast('Informe a data de agendamento', 'warning');
      
      // Verificar se o limite do cartão é suficiente para esta compra
      if (paymentMethod === 'credito' && creditCardId) {
        const card = state.cards.find(c => c.id === creditCardId);
        if (card && amount > card.availableLimit) {
          const confirmLimit = confirm(`Esta despesa ultrapassa o limite disponível do cartão (${formatCurrency(card.availableLimit)}). Deseja continuar assim mesmo?`);
          if (!confirmLimit) return;
        }
      }
      
      const expense = {
        type: 'expense',
        name,
        amount,
        paymentMethod,
        paymentMethodName: state.paymentMethods.find(m => m.id === paymentMethod)?.name,
        creditCardId,
        creditCardName: creditCardId ? state.cards.find(c => c.id === creditCardId)?.name : null,
        category,
        categoryName: state.categories.expense.find(c => c.id === category)?.name,
        person,
        personName: person ? state.people.find(p => p.id === person)?.name : null,
        isFixed,
        date: localDateToISOString(date),
        dueDate: dueDate ? localDateToISOString(dueDate) : null,
        isRecurrent,
        installments: isRecurrent ? installments : 1,
        status,
        scheduledDate: scheduledDate ? localDateToISOString(scheduledDate) : null,
        notes,
        createdAt: localDateToISOString(new Date())
      };
      
      const success = await addTransaction(expense);
      if (success) closeModal('expenseModal');
    });
    
    // Event Listeners para o modal de edição
    $('#saveEditBtn').addEventListener('click', async function() {
      const id = $('#editTransactionId').value;
      const type = $('#editTransactionType').value;
      
      const updates = {
        name: $('#editName').value.trim(),
        amount: parseFloat($('#editAmount').value.trim() || '0'),
        category: $('#editCategory').value,
        categoryName: state.categories[type]?.find(c => c.id === $('#editCategory').value)?.name,
        date: localDateToISOString(getDateInputValue('editDate')),
        paymentMethod: $('#editPaymentMethod').value,
        paymentMethodName: state.paymentMethods.find(m => m.id === $('#editPaymentMethod').value)?.name,
        notes: $('#editNotes').value.trim()
      };
      
      // Campos específicos para despesas
      if (type === 'expense') {
        updates.person = $('#editPerson').value;
        updates.personName = updates.person ? state.people.find(p => p.id === updates.person)?.name : null;
        updates.isFixed = $('input[name="editExpenseType"]:checked')?.value || 'variable';
        updates.dueDate = localDateToISOString(getDateInputValue('editDueDate'));
      }
      
      // Para cartão de crédito
      if (updates.paymentMethod === 'credito') {
        updates.creditCardId = $('#editCreditCard').value;
        updates.creditCardName = updates.creditCardId ? state.cards.find(c => c.id === updates.creditCardId)?.name : null;
      } else {
        updates.creditCardId = null;
        updates.creditCardName = null;
      }
      
      // Para recorrência
      updates.isRecurrent = $('#editIsRecurrent').checked;
      if (updates.isRecurrent) {
        updates.installments = parseInt($('#editInstallments').value || '1', 10);
      }
      
      // Status
      const statusRadio = $('input[name="editStatus"]:checked');
      if (statusRadio) updates.status = statusRadio.value;
      
      // Data de agendamento
      if (updates.status === 'scheduled') {
        updates.scheduledDate = localDateToISOString(getDateInputValue('editScheduledDate'));
      } else {
        updates.scheduledDate = null;
      }
      
      // Verificar se usuário quer atualizar futuras parcelas
      if (state.currentTransaction.isRecurrent || state.currentTransaction.recurrenceMasterId) {
        const isEdit = confirm('Esta é uma transação recorrente. Deseja aplicar estas alterações às parcelas futuras também?');
        
        if (isEdit) {
          const updateAll = state.currentTransaction.recurrenceMasterId ? 
                          confirm('Atualizar TODAS as parcelas, inclusive as anteriores (exceto esta)?') :
                          false;
          
          updates.updateFuture = !updateAll;
          updates.updateAllFuture = updateAll;
        }
      }
      
      const success = await updateTransaction(id, updates);
      if (success) closeModal('editModal');
    });
    
    // Event Listeners para o modal de confirmação de exclusão
    $('#confirmDeleteBtn').addEventListener('click', async function() {
      const id = this.dataset.id;
      const deleteOption = $('input[name="deleteOption"]:checked')?.value || 'single';
      
      const success = await deleteTransaction(id, deleteOption);
      if (success) closeModal('deleteConfirmModal');
    });
    
    // Event Listeners para o modal de cartão
    $('#saveCardBtn').addEventListener('click', async function() {
      const name = $('#cardName').value.trim();
      const limit = parseFloat($('#cardLimit').value.trim() || '0');
      const closingDay = parseInt($('#cardClosingDay').value.trim() || '0', 10);
      const dueDay = parseInt($('#cardDueDay').value.trim() || '0', 10);
      
      if (!name) return showToast('Informe o nome do cartão', 'warning');
      if (limit <= 0) return showToast('Informe um limite válido', 'warning');
      if (closingDay < 1 || closingDay > 31) return showToast('Informe um dia de fechamento válido (1-31)', 'warning');
      if (dueDay < 1 || dueDay > 31) return showToast('Informe um dia de vencimento válido (1-31)', 'warning');
      
      const cardData = { name, limit, closingDay, dueDay };
      
      const action = this.dataset.action || 'add';
      let success = false;
      
      if (action === 'add') {
        success = await addCard(cardData);
      } else if (action === 'update') {
        const cardId = this.dataset.id;
        success = await updateCard(cardId, cardData);
      }
      
      if (success) {
        closeModal('newCardModal');
        openModal('cardsListModal');
      }
    });
    
    // Event Listeners para o modal de fatura do cartão
    $('#payInvoiceBtn').addEventListener('click', function() {
      if (!state.currentCard) return;
      $('#invoiceConfirmAmount').textContent = $('#currentInvoiceValueDisplay').textContent;
      openModal('payInvoiceConfirmModal');
    });
    
    $('#confirmPayInvoiceBtn').addEventListener('click', async function() {
      if (!state.currentCard) return;
      await payCardInvoice(state.currentCard.id);
    });
    
    $('#backToCardsBtn').addEventListener('click', function() {
      closeModal('cardInvoiceModal');
      openModal('cardsListModal');
    });
    
    // Event Listeners para o novo cartão
    $('#newCardBtn').addEventListener('click', function() {
      $('#cardForm').reset();
      $('#newCardModalTitle').textContent = 'Novo Cartão';
      $('#saveCardBtn').textContent = 'Salvar Cartão';
      $('#saveCardBtn').dataset.action = 'add';
      $('#saveCardBtn').removeAttribute('data-id');
      
      closeModal('cardsListModal');
      openModal('newCardModal');
    });
    
    // Event Listeners para categorias
    $('#categoryTabs').addEventListener('click', function(e) {
      if (e.target.classList.contains('nav-link')) {
        e.preventDefault();
        
        // Remove active da antiga tab e do conteúdo
        $$('.nav-link.active').forEach(el => el.classList.remove('active'));
        $$('.tab-pane.active').forEach(el => {
          el.classList.remove('active');
          el.classList.remove('show');
        });
        
        // Adiciona active na nova tab e no conteúdo
        e.target.classList.add('active');
        const tabId = e.target.getAttribute('href').substring(1);
        const tabPane = $(`#${tabId}`);
        
        if (tabPane) {
          tabPane.classList.add('active');
          setTimeout(() => tabPane.classList.add('show'), 10);
        }
      }
    });
    
    // Event listeners para as categorias de receita
    $('#addIncomeCategoryBtn').addEventListener('click', async function() {
      const name = $('#newIncomeCategoryInput').value.trim();
      const icon = $('#newIncomeCategoryIconInput').value.trim() || '💰';
      
      if (!name) return showToast('Informe o nome da categoria', 'warning');
      
      await addCategory({ name, icon }, 'income');
      $('#newIncomeCategoryInput').value = '';
      $('#newIncomeCategoryIconInput').value = '';
      $('#newIncomeCategoryIconPreview').textContent = '💰';
    });
    
    // Event listeners para as categorias de despesa
    $('#addExpenseCategoryBtn').addEventListener('click', async function() {
      const name = $('#newExpenseCategoryInput').value.trim();
      const icon = $('#newExpenseCategoryIconInput').value.trim() || '🛍️';
      
      if (!name) return showToast('Informe o nome da categoria', 'warning');
      
      await addCategory({ name, icon }, 'expense');
      $('#newExpenseCategoryInput').value = '';
      $('#newExpenseCategoryIconInput').value = '';
      $('#newExpenseCategoryIconPreview').textContent = '🛍️';
    });
    
    // Event listeners para os métodos de pagamento
    $('#addPaymentMethodBtn').addEventListener('click', async function() {
      const name = $('#newPaymentMethodInput').value.trim();
      const icon = $('#newPaymentMethodIconInput').value.trim() || '💳';
      
      if (!name) return showToast('Informe o nome do método de pagamento', 'warning');
      
      await addPaymentMethod({ name, icon });
      $('#newPaymentMethodInput').value = '';
      $('#newPaymentMethodIconInput').value = '';
      $('#newPaymentMethodIconPreview').textContent = '💳';
    });
    
    // Event listeners para as pessoas
    $('#addPersonBtn').addEventListener('click', async function() {
      const name = $('#newPersonInput').value.trim();
      const icon = $('#newPersonIconInput').value.trim() || '👤';
      
      if (!name) return showToast('Informe o nome da pessoa', 'warning');
      
      await addPerson({ name, icon });
      $('#newPersonInput').value = '';
      $('#newPersonIconInput').value = '';
      $('#newPersonIconPreview').textContent = '👤';
    });
    
    // Event listeners para as categorias de investimento
    $('#addInvestmentCategoryBtn').addEventListener('click', async function() {
      const name = $('#newInvestmentCategoryInput').value.trim();
      const icon = $('#newInvestmentCategoryIconInput').value.trim() || '📈';
      
      if (!name) return showToast('Informe o nome da categoria', 'warning');
      
      await addCategory({ name, icon }, 'investment');
      $('#newInvestmentCategoryInput').value = '';
      $('#newInvestmentCategoryIconInput').value = '';
      $('#newInvestmentCategoryIconPreview').textContent = '📈';
    });
    
    // Event listeners para o modal de edição de categoria/item
    $('#saveEditCategoryBtn').addEventListener('click', async function() {
      const id = $('#editCategoryId').value;
      const type = $('#editCategoryType').value;
      
      if (!id || !type) return;
      
      const name = $('#editCategoryName').value.trim();
      const icon = $('#editCategoryIconInput').value.trim() || '🔄';
      
      if (!name) return showToast('Informe o nome', 'warning');
      
      const updates = { name, icon };
      
      if (type === 'income' || type === 'expense' || type === 'investment') {
        await updateCategory(id, updates, type);
      } else if (type === 'paymentMethod') {
        await updatePaymentMethod(id, updates);
      } else if (type === 'person') {
        await updatePerson(id, updates);
      }
      
      closeModal('editCategoryModal');
    });
    
    // Event listeners para os ícones de categoria/item
    ['newIncomeCategoryIconInput', 'newExpenseCategoryIconInput', 'newPaymentMethodIconInput', 'newPersonIconInput', 'newInvestmentCategoryIconInput', 'editCategoryIconInput'].forEach(inputId => {
      const input = $(`#${inputId}`);
      const preview = $(`#${inputId.replace('Input', 'Preview')}`);
      
      if (input && preview) {
        input.addEventListener('input', function() {
          preview.textContent = this.value || preview.textContent;
        });
      }
    });
    
    // Event listeners para investimentos
    $('#newInvestmentBtn').addEventListener('click', openNewInvestmentModal);
    
    $('#saveInvestmentBtn').addEventListener('click', async function() {
      const name = $('#investmentName').value.trim();
      const amount = parseFloat($('#investmentAmount').value || '0');
      const goal = parseFloat($('#investmentGoal').value || '0');
      const category = $('#investmentCategorySelect').value;
      const targetDate = getDateInputValue('investmentTargetDate');
      const notes = $('#investmentNotes').value.trim();
      
      if (!name) return showToast('Informe o nome do investimento', 'warning');
      
      const data = {
        name,
        amount,
        goal,
        category,
        targetDate: targetDate ? localDateToISOString(targetDate) : null,
        notes
      };
      
      const action = this.dataset.action || 'add';
      
      if (action === 'add') {
        const investment = await addInvestment(data);
        if (investment) {
          closeModal('newInvestmentModal');
          openModal('investmentsModal');
        }
      } else if (action === 'update') {
        const id = this.dataset.id;
        const success = await updateInvestment(id, data);
        if (success) {
          closeModal('newInvestmentModal');
          openInvestmentDetail(id);
        }
      }
    });
    
    $('#editInvestmentBtn').addEventListener('click', function() {
      if (state.currentInvestment) {
        openEditInvestmentModal(state.currentInvestment.id);
      }
    });
    
    $('#deleteInvestmentBtn').addEventListener('click', async function() {
      if (state.currentInvestment && confirm(`Excluir o investimento "${state.currentInvestment.name}" e todos os seus aportes?`)) {
        await deleteInvestment(state.currentInvestment.id);
        closeModal('investmentDetailModal');
        openModal('investmentsModal');
      }
    });
    
    $('#backToInvestmentsBtn').addEventListener('click', function() {
      closeModal('investmentDetailModal');
      openModal('investmentsModal');
    });
    
    $('#addInvestmentContributionBtn').addEventListener('click', openNewContributionModal);
    
    $('#saveContributionBtn').addEventListener('click', async function() {
      const investmentId = $('#contributionInvestmentId').value;
      const amount = parseFloat($('#contributionAmount').value || '0');
      const date = getDateInputValue('contributionDate');
      const description = $('#contributionDescription').value.trim();
      
      if (!investmentId) return;
      if (amount <= 0) return showToast('Informe um valor válido', 'warning');
      if (!date) return showToast('Informe a data do aporte', 'warning');
      
      const data = {
        investmentId,
        amount,
        date: localDateToISOString(date),
        description
      };
      
      const action = this.dataset.action || 'add';
      
      if (action === 'add') {
        const contribution = await addContribution(data);
        if (contribution) closeModal('newContributionModal');
      } else if (action === 'update') {
        const id = this.dataset.id;
        const success = await updateContribution(id, data);
        if (success) closeModal('newContributionModal');
      }
    });
    
    // Carregar dados iniciais do banco de dados
    try {
      await loadCategoriesAndPaymentMethods();
      await loadCards();
      await loadTransactions();
      await loadInvestments();
      createTransactionFilters();
      updateMonthYearTitle();
    } catch (error) {
      console.error('Erro ao inicializar aplicativo:', error);
      showToast('Erro ao carregar dados iniciais.', 'error');
    }
  };

  // Inicializar o aplicativo quando o DOM estiver pronto
  document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
