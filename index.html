<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Gestão Financeira da Família - Controle financeiro simplificado">
  <title>Gestão Financeira da Família</title>
  
  <!-- Fonte Inter via Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Scripts CDN: Chart.js 4 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <!-- Scripts CDN: Firebase v9 compat -->
  <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-auth-compat.js"></script>
  
  <style>
    /* Design-tokens em :root */
    :root {
      /* Cores base - Proposta Clean & Elegante */
      --color-background: #F4F6F8; /* Cinza muito claro, quase off-white */
      --color-surface: #FFFFFF;    /* Branco puro para cards */
      --color-surface-variant: #E9ECEF; /* Cinza um pouco mais escuro que o fundo */
      --color-on-surface: #343A40;    /* Cinza bem escuro, quase preto, para texto principal */
      --color-on-surface-variant: #6C757D; /* Cinza médio para texto secundário */
      --color-outline: #DEE2E6;       /* Cinza claro para bordas e divisórias */
      
      /* Cores semânticas - Primária mais elegante */
      --color-primary: #0D47A1; /* Azul escuro e sóbrio (ex: Material Design Blue 900) */
      --color-on-primary: #FFFFFF;
      --color-success: #28a745; /* Verde Bootstrap - Mantido vibrante */
      --color-on-success: #ffffff;
      --color-warning: #ffc107; /* Amarelo Bootstrap - Mantido vibrante */
      --color-on-warning: #212529;
      --color-error: #dc3545; /* Vermelho Bootstrap - Mantido vibrante */
      --color-on-error: #ffffff;
      --color-info: #17a2b8; /* Azul info Bootstrap - Mantido vibrante */
      --color-on-info: #ffffff;
      
      /* Cores para receitas e despesas */
      --color-income: var(--color-success);
      --color-expense: var(--color-error);
      
      /* Cores de cartões */
      --color-card-invoice: #ffc107; 
      
      /* Tipografia */
      --font-family: 'Inter', sans-serif;
      --font-size-xs: 0.75rem;
      --font-size-sm: 0.875rem;
      --font-size-md: 1rem;
      --font-size-lg: 1.125rem;
      --font-size-xl: 1.25rem;
      --font-weight-regular: 400;
      --font-weight-medium: 500;
      --font-weight-semibold: 600;
      --font-weight-bold: 700;
      
      /* Espaçamento */
      --spacing-xs: 0.25rem;
      --spacing-sm: 0.5rem;
      --spacing-md: 1rem;
      --spacing-lg: 1.5rem;
      --spacing-xl: 2rem;
      
      /* Bordas e raios */
      --radius-sm: 0.2rem;
      --radius-md: 0.25rem; 
      --radius-lg: 0.3rem;
      --radius-full: 50px; 
      
      /* Transições */
      --transition-fast: 0.15s ease-in-out;
      --transition-normal: 0.25s ease-in-out;
    }
    
    /* Tema escuro */
    [data-theme="dark"] {
      --color-background: #1A1A1A; 
      --color-surface: #2C2C2C;    
      --color-surface-variant: #3E3E3E; 
      --color-on-surface: #E0E0E0;    
      --color-on-surface-variant: #B0B0B0; 
      --color-outline: #4A4A4A;       
      /* A cor primária pode precisar de ajuste para o tema escuro se a padrão não contrastar bem */
      /* --color-primary: #1E88E5; */ /* Ex: Azul um pouco mais claro para dark mode */
      color: var(--color-on-surface);
    }
    
    /* Reset básico */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html, body {
      height: 100%;
      font-family: var(--font-family);
      background-color: var(--color-background);
      color: var(--color-on-surface);
      font-size: var(--font-size-md);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      transition: background-color var(--transition-normal), color var(--transition-normal);
    }
    
    img, picture, video, canvas, svg {
      display: block;
      max-width: 100%;
    }
    
    input, button, textarea, select {
      font: inherit;
      color: inherit;
      border: 1px solid var(--color-outline);
      background-color: var(--color-background); /* Alterado para background para melhor contraste no dark mode */
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-md);
    }
    input:focus, select:focus, textarea:focus {
        outline: 2px solid var(--color-primary);
        outline-offset: 2px;
        border-color: var(--color-primary);
    }
    input[type="date"] {
        padding-right: var(--spacing-sm); 
    }
    input[disabled] {
        background-color: var(--color-surface-variant);
        cursor: not-allowed;
        opacity: 0.7;
    }

    button {
      cursor: pointer;
      border: 1px solid transparent;
      transition: background-color var(--transition-fast), border-color var(--transition-fast);
    }
    
    a {
      color: var(--color-primary);
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    
    table {
      border-collapse: collapse;
      width: 100%;
    }

    /* Layout principal */
    .container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding: var(--spacing-md);
    }
  
    /* Header */
    .header {
      display: flex;
      flex-wrap: wrap; 
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-md) 0;
      margin-bottom: var(--spacing-lg);
      border-bottom: 1px solid var(--color-outline);
      position: sticky;
      top: 0;
      background-color: var(--color-background);
      z-index: 100;
    }
    
    .header-filters, .header-actions {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-sm);
      align-items: center;
    }
    
    .app-title {
      font-size: 1.8rem;
      font-weight: var(--font-weight-semibold);
      margin-bottom: var(--spacing-md);
    }
    
    .hero {
      padding: var(--spacing-lg) 0;
      margin-bottom: var(--spacing-md);
    }
    
    .hero-title {
      font-size: 2rem;
      font-weight: var(--font-weight-semibold);
      margin-bottom: var(--spacing-sm);
    }
    
    .hero-subtitle {
      font-size: var(--font-size-lg);
      color: var(--color-on-surface-variant);
      margin-bottom: var(--spacing-md);
      max-width: 600px;
    }
    
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }
    .kpi-card {
      background-color: var(--color-surface);
      padding: var(--spacing-md);
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-outline);
    }
    .kpi-title {
      font-size: var(--font-size-sm);
      color: var(--color-on-surface-variant);
      margin-bottom: var(--spacing-xs);
      font-weight: var(--font-weight-medium);
    }
    .kpi-value {
      font-size: 1.8rem;
      font-weight: var(--font-weight-semibold);
      margin-bottom: var(--spacing-xs);
    }
    .kpi-subtitle {
      font-size: var(--font-size-xs);
      color: var(--color-on-surface-variant);
      display: flex;
      align-items: center;
      gap: var(--spacing-xs);
    }
    .kpi-income { border-left: 4px solid var(--color-income); }
    .kpi-expense { border-left: 4px solid var(--color-expense); }
    .kpi-balance { border-left: 4px solid var(--color-primary); }
    .kpi-card-invoice { border-left: 4px solid var(--color-card-invoice); }
    
    .insights-banner-container {
      margin-bottom: var(--spacing-lg);
    }
    .insight-banner {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-sm);
      border: 1px solid var(--color-outline);
    }
    .insight-icon { font-size: 1.5rem; }
    .insight-content { flex: 1; }
    .insight-title { font-weight: var(--font-weight-medium); margin-bottom: var(--spacing-xs); }
    .insight-danger { background-color: rgba(220, 53, 69, 0.1); border-left: 4px solid var(--color-error); }
    .insight-warning { background-color: rgba(255, 193, 7, 0.1); border-left: 4px solid var(--color-warning); }
    .insight-info { background-color: rgba(23, 162, 184, 0.1); border-left: 4px solid var(--color-info); }
    .insight-success { background-color: rgba(40, 167, 69, 0.1); border-left: 4px solid var(--color-success); }
    
    .charts-container { margin-bottom: var(--spacing-lg); }
    .charts-title { font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin-bottom: var(--spacing-md); }
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-md);
    }
    .chart-container {
      height: 380px; 
      border-radius: var(--radius-lg);
      background-color: var(--color-surface);
      padding: var(--spacing-md);
      border: 1px solid var(--color-outline);
      display: flex; /* Para centralizar o canvas se necessário */
      flex-direction: column; /* Para o título ficar acima */
      justify-content: center; /* Centraliza verticalmente o conteúdo */
      align-items: center; /* Centraliza horizontalmente o conteúdo */
    }
    .chart-container canvas {
        max-width: 100%;
        max-height: calc(100% - 2em); /* Subtrai altura aproximada do título */
    }
    .chart-container h3 { 
        font-weight: var(--font-weight-semibold); 
        font-size: var(--font-size-lg); 
        margin-bottom: var(--spacing-md); 
        text-align: center; 
        width: 100%; /* Garante que o título ocupe a largura */
    }
    
    .commitments {
      margin-bottom: var(--spacing-lg);
      background-color: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: var(--spacing-md);
      border: 1px solid var(--color-outline);
    }
    .commitments-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--spacing-md);
      cursor: pointer;
      padding: var(--spacing-sm);
      border-radius: var(--radius-md);
    }
    .commitments-header:hover { background-color: var(--color-surface-variant); }
    .commitments-header h3 { font-weight: var(--font-weight-semibold); font-size: var(--font-size-lg); }
    .commitments-content { overflow: hidden; transition: max-height var(--transition-normal); max-height: 0; }
    .commitment-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-sm);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-xs);
      background-color: var(--color-surface-variant);
    }
    .commitment-progress { width: 100%; height: 8px; background-color: var(--color-outline); border-radius: var(--radius-full); overflow: hidden; }
    .commitment-progress-bar { height: 100%; border-radius: var(--radius-full); transition: width var(--transition-normal); }
    
    .transactions-container { margin-bottom: var(--spacing-lg); }
    .card-transacoes {
      background-color: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: var(--spacing-md);
      border: 1px solid var(--color-outline);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-md);
    }
    .card-title { font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); margin: 0; }
    .filters { display: flex; gap: var(--spacing-sm); flex-wrap: wrap; }
    
    .transactions-table-container {
      overflow-x: auto; 
      border: 1px solid var(--color-outline);
      border-radius: var(--radius-lg);
      background-color: var(--color-surface);
    }
    .transactions-table { width: 100%; }
    .transactions-table th, .transactions-table td {
      padding: var(--spacing-sm);
      text-align: left; /* Padrão para td */
      border-bottom: 1px solid var(--color-outline);
      white-space: nowrap; 
    }
    .transactions-table th {
      font-weight: var(--font-weight-medium);
      color: var(--color-on-surface-variant);
      background-color: var(--color-surface-variant);
      cursor: pointer;
      text-align: center; /* AJUSTE: Centralizar cabeçalhos */
    }
    .transactions-table th.sortable:hover { background-color: var(--color-outline); }
    .transactions-table tr:hover { background-color: var(--color-surface-variant); }
    .transactions-table td .transaction-name-cell { 
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        white-space: normal; 
        word-break: break-word;
    }
    .transaction-icon {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      width: 2rem;
      height: 2rem;
      border-radius: var(--radius-full);
      background-color: var(--color-surface-variant);
      font-size: 1rem; 
      flex-shrink: 0; 
    }
    .actions-cell { display: flex; gap: var(--spacing-xs); justify-content: flex-end; }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-xs);
      padding: var(--spacing-sm) var(--spacing-md);
      border-radius: var(--radius-md); 
      font-weight: var(--font-weight-medium);
      white-space: nowrap;
      min-height: 36px;
      border: 1px solid transparent; 
    }
    .btn:hover { opacity: 0.85; }
    .header-actions .btn {
      border-radius: var(--radius-md); 
    }
    .header-actions .btn.btn-icon { 
      border-radius: var(--radius-full); 
    }

    .btn-primary { background-color: var(--color-primary); color: var(--color-on-primary); border-color: var(--color-primary); }
    .btn-success { background-color: var(--color-success); color: var(--color-on-success); border-color: var(--color-success); }
    .btn-danger { background-color: var(--color-error); color: var(--color-on-error); border-color: var(--color-error); }
    .btn-outline {
      border: 1px solid var(--color-outline);
      background-color: transparent;
      color: var(--color-primary);
    }
    .btn-outline:hover { background-color: var(--color-surface-variant); border-color: var(--color-primary); }
    .btn-icon { width: 36px; height: 36px; padding: 0; border-radius: var(--radius-full); }
    
    .select-wrapper { position: relative; display: inline-block; }
    .select {
      appearance: none;
      -webkit-appearance: none;
      padding-right: var(--spacing-xl); 
      cursor: pointer;
      background-color: var(--color-background); 
      width: 100%; 
      min-width: 150px; 
      border-radius: var(--radius-md); 
    }
    .select-icon {
      position: absolute;
      right: var(--spacing-sm);
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      color: var(--color-on-surface-variant);
    }
    
    .card {
      background-color: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: var(--spacing-md);
      border: 1px solid var(--color-outline);
    }
    
    .badge {
      display: inline-block;
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--radius-full);
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-medium);
      line-height: 1;
    }
    .badge-success { background-color: rgba(40, 167, 69, 0.15); color: var(--color-success); }
    .badge-warning { background-color: rgba(255, 193, 7, 0.15); color: var(--color-warning); }
    .badge-danger { background-color: rgba(220, 53, 69, 0.15); color: var(--color-error); }
    .badge-info { background-color: rgba(23, 162, 184, 0.15); color: var(--color-info); }
    
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none; 
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: opacity var(--transition-normal);
    }
    .modal-backdrop.active { display: flex; opacity: 1; }
    .modal {
      width: 90%;
      max-width: 500px;
      background-color: var(--color-background);
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-outline);
      display: flex;
      flex-direction: column;
      max-height: 90vh; 
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-md);
      border-bottom: 1px solid var(--color-outline);
    }
    .modal-title { font-size: var(--font-size-xl); font-weight: var(--font-weight-semibold); }
    .modal-close {
      font-size: var(--font-size-xl);
      color: var(--color-on-surface-variant);
      cursor: pointer;
      background: none; border: none; padding: 0;
      width: 32px; height: 32px;
      display: flex; align-items: center; justify-content: center;
      border-radius: var(--radius-full);
    }
    .modal-close:hover { background-color: var(--color-surface-variant); }
    .modal-body { padding: var(--spacing-md); overflow-y: auto; }
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: var(--spacing-sm);
      padding: var(--spacing-md);
      border-top: 1px solid var(--color-outline);
      background-color: var(--color-surface); 
      border-bottom-left-radius: var(--radius-lg);
      border-bottom-right-radius: var(--radius-lg);
    }
    
    .toast-container {
      position: fixed;
      top: var(--spacing-md);
      right: var(--spacing-md);
      z-index: 2000;
      width: auto;
      max-width: 350px;
    }
    .toast {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      background-color: var(--color-surface);
      border-radius: var(--radius-md);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-sm);
      border: 1px solid var(--color-outline);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1); /* Adicionado shadow para destaque */
      opacity: 0;
      transform: translateX(100%);
      transition: opacity var(--transition-normal), transform var(--transition-normal);
    }
    .toast.show { opacity: 1; transform: translateX(0); }
    .toast-icon { font-size: 1.5rem; }
    .toast-content { flex: 1; }
    .toast-close { font-size: var(--font-size-lg); color: var(--color-on-surface-variant); cursor: pointer; background: none; border: none; padding: 0; }
    .toast-success { border-left: 4px solid var(--color-success); }
    .toast-error { border-left: 4px solid var(--color-error); }
    .toast-warning { border-left: 4px solid var(--color-warning); }
    .toast-info { border-left: 4px solid var(--color-info); }
    
    .form-group { margin-bottom: var(--spacing-md); }
    .form-label {
      display: block;
      font-size: var(--font-size-sm);
      color: var(--color-on-surface-variant);
      margin-bottom: var(--spacing-xs);
      font-weight: var(--font-weight-medium);
    }
    .form-control { width: 100%; } 
    
    .radio-group, .checkbox-group {
      display: flex;
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-md);
      flex-wrap: wrap;
    }
    .radio-wrapper, .checkbox-wrapper { display: flex; align-items: center; gap: var(--spacing-xs); }
    .radio, .checkbox { width: auto; height: auto; margin-right: var(--spacing-xs); accent-color: var(--color-primary); }
    .radio-label, .checkbox-label { 
      cursor: pointer;
      font-weight: normal;
      color: var(--color-on-surface);
    }
    
    .theme-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px; 
      height: 36px; 
      border-radius: var(--radius-full); 
      cursor: pointer;
      background-color: transparent; 
      border: none; 
      padding: var(--spacing-xs); 
    }
    .theme-toggle:hover { 
      background-color: var(--color-surface-variant); 
    }
    .theme-toggle .icon-sun, .theme-toggle .icon-moon { 
      width: 24px; 
      height: 24px; 
      color: var(--color-on-surface-variant); 
    }
    [data-theme="light"] .theme-toggle .icon-moon { display: none; }
    [data-theme="dark"] .theme-toggle .icon-sun { display: none; }
    
    .investment-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
    }
    .investment-card { 
      display: flex;
      flex-direction: column;
    }
    .investment-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--spacing-sm); }
    .investment-card-title { font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); margin: 0; }
    .investment-card-body { flex: 1; margin-bottom: var(--spacing-sm); }
    .investment-card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: auto; }
    .investment-progress { margin-top: var(--spacing-sm); }
    .investment-progress-bar { height: 8px; background-color: var(--color-surface-variant); border-radius: var(--radius-full); overflow: hidden; margin-bottom: var(--spacing-xs); }
    .investment-progress-fill { height: 100%; background-color: var(--color-primary); border-radius: var(--radius-full); }
    .investment-progress-text { display: flex; justify-content: space-between; font-size: var(--font-size-sm); color: var(--color-on-surface-variant); }
    .investment-detail-header {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-md);
    }
    .investment-detail-stat { background-color: var(--color-surface-variant); border-radius: var(--radius-md); padding: var(--spacing-sm); }
    .investment-detail-title { font-size: var(--font-size-sm); color: var(--color-on-surface-variant); margin-bottom: var(--spacing-xs); }
    .investment-detail-value { font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); }
    .investment-history-table th, .investment-history-table td { padding: var(--spacing-sm); border-bottom: 1px solid var(--color-outline); }
    .investment-history-table th { background-color: var(--color-surface-variant); }

    .categories-container { padding: var(--spacing-md); }
    .nav-tabs {
      display: flex;
      list-style: none;
      padding: 0;
      margin: 0 0 var(--spacing-md) 0;
      border-bottom: 1px solid var(--color-outline);
      flex-wrap: wrap; 
    }
    .nav-item { margin-right: var(--spacing-sm); margin-bottom: var(--spacing-xs); }
    .nav-link {
      display: inline-block;
      padding: var(--spacing-sm) var(--spacing-md);
      border: 1px solid transparent;
      border-bottom: 2px solid transparent;
      font-weight: var(--font-weight-medium);
      color: var(--color-on-surface-variant);
      border-radius: var(--radius-md) var(--radius-md) 0 0;
    }
    .nav-link:hover { color: var(--color-primary); background-color: var(--color-surface-variant); }
    .nav-link.active {
      color: var(--color-primary);
      border-color: var(--color-outline);
      border-bottom-color: var(--color-primary);
      background-color: var(--color-surface);
    }
    .tab-content { padding: var(--spacing-md) 0; }
    .tab-pane { display: none; }
    .tab-pane.active.show { display: block; animation: fadeIn var(--transition-normal); }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    .category-list { margin-bottom: var(--spacing-md); }
    .category-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--spacing-sm);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-xs);
      border: 1px solid var(--color-outline);
    }
    .category-item:hover { background-color: var(--color-surface-variant); }
    .category-item-content { display: flex; align-items: center; gap: var(--spacing-sm); }
    .category-item-icon {
      width: 28px; height: 28px;
      display: flex; align-items: center; justify-content: center;
      border-radius: var(--radius-full);
      background-color: var(--color-surface);
      font-size: 1rem;
    }
    .category-item-actions { display: flex; gap: var(--spacing-xs); }
    
    .add-category-form {
      display: flex;
      align-items: flex-end; 
      gap: var(--spacing-sm);
      flex-wrap: wrap; 
    }
    .add-category-form .form-control { flex-grow: 1; } 
    .add-category-form .btn { flex-shrink: 0; } 

    .custom-icon-input { display: flex; align-items: center; gap: var(--spacing-xs); }
    .custom-icon-preview {
      width: 36px; height: 36px;
      display: flex; align-items: center; justify-content: center;
      background-color: var(--color-surface-variant);
      border-radius: var(--radius-full);
      border: 1px solid var(--color-outline);
      font-size: 1.2rem;
    }
    
    @media (max-width: 768px) {
      .header { flex-direction: column; align-items: stretch; }
      .header-filters { width: 100%; justify-content: space-around; margin-bottom: var(--spacing-sm); }
      .header-actions { width: 100%; justify-content: space-around; }
      .hero-title { font-size: 1.8rem; }
      .charts-grid { grid-template-columns: 1fr; } 
      .add-category-form { flex-direction: column; align-items: stretch; }
      .add-category-form .form-control, .add-category-form .btn { width: 100%; }
    }
    
    @media (max-width: 576px) {
      .kpi-grid { grid-template-columns: 1fr; }
      .header-filters { flex-direction: column; align-items: stretch; }
      .header-filters .select-wrapper { width: 100%; }
      .header-actions { 
        flex-direction: row; 
        flex-wrap: wrap; 
        justify-content: center; 
      }
      .header-actions .btn, .header-actions .theme-toggle { 
        flex-grow: 1; 
        min-width: calc(50% - var(--spacing-sm)); 
      }
      .modal { width: 95%; }
      .filters .select-wrapper { width: 100%; } 
    }

  </style>
</head>
<body>
  <!-- SVG Sprite de ícones (HeroIcons) -->
  <svg style="display: none;">
    <!-- Ícones de navegação -->
    <symbol id="icon-home" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
    </symbol>
    <symbol id="icon-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
    </symbol>
    <symbol id="icon-calendar" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
    </symbol>
    <symbol id="icon-chart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
    </symbol>
    <symbol id="icon-credit-card" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
    </symbol>
    
    <!-- Ícones de ações -->
    <symbol id="icon-edit" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
    </symbol>
    <symbol id="icon-trash" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
    </symbol>
    <symbol id="icon-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
    </symbol>
    <symbol id="icon-x" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
    </symbol>
    <symbol id="icon-chevron-down" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
    </symbol>
    <symbol id="icon-chevron-up" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" />
    </symbol>
    <symbol id="icon-arrow-left" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
    </symbol>
    
    <!-- Ícones tema claro/escuro -->
    <symbol id="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
    </symbol>
    <symbol id="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
    </symbol>
    
    <!-- Ícones para categorias -->
    <symbol id="icon-shopping" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
    </symbol>
    <symbol id="icon-food" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
    </symbol>
    <symbol id="icon-home-category" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
    </symbol>
    <symbol id="icon-bill" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
    </symbol>
    <symbol id="icon-default" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </symbol>
    <symbol id="icon-money" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </symbol>
    
    <!-- Ícones para alertas -->
    <symbol id="icon-alert" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
    </symbol>
    <symbol id="icon-info" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </symbol>
    <symbol id="icon-settings" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
      <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
    </symbol>
    
    <!-- Ícones para ordenação -->
    <symbol id="icon-sort-asc" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" />
    </symbol>
    <symbol id="icon-sort-desc" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
    </symbol>
  </svg>

  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="header-filters">
        <div class="select-date-container" style="display: flex; gap: var(--spacing-sm);">
          <div class="select-wrapper">
            <select id="yearSelect" class="select">
              <!-- Options will be populated by JS -->
            </select>
            <svg class="select-icon" width="16" height="16">
              <use href="#icon-chevron-down"></use>
            </svg>
          </div>
          
          <div class="select-wrapper">
            <select id="monthSelect" class="select">
              <option value="0">Janeiro</option>
              <option value="1">Fevereiro</option>
              <option value="2">Março</option>
              <option value="3">Abril</option>
              <option value="4">Maio</option>
              <option value="5">Junho</option>
              <option value="6">Julho</option>
              <option value="7">Agosto</option>
              <option value="8">Setembro</option>
              <option value="9">Outubro</option>
              <option value="10">Novembro</option>
              <option value="11">Dezembro</option>
            </select>
            <svg class="select-icon" width="16" height="16">
              <use href="#icon-chevron-down"></use>
            </svg>
          </div>
        </div>
      </div>
      
      <div class="header-actions">
        <button id="newIncomeBtn" class="btn btn-success">
          Nova Receita
        </button>
        
        <button id="newExpenseBtn" class="btn btn-danger">
          Nova Despesa
        </button>
        
        <button id="cardsBtn" class="btn btn-outline">
          <svg width="16" height="16" style="margin-right: var(--spacing-xs);">
            <use href="#icon-credit-card"></use>
          </svg>
          Cartões
        </button>
        
        <button id="categoriesBtn" class="btn btn-outline">
          <svg width="16" height="16" style="margin-right: var(--spacing-xs);">
            <use href="#icon-settings"></use>
          </svg>
          Categorias
        </button>
        
        <button id="investmentsBtn" class="btn btn-outline">
          <svg width="16" height="16" style="margin-right: var(--spacing-xs);">
            <use href="#icon-chart"></use>
          </svg>
          Investimentos
        </button>

        <div id="themeToggle" class="theme-toggle" role="button" aria-label="Alternar tema">
          <svg class="icon-sun" width="20" height="20"> 
            <use href="#icon-sun"></use>
          </svg>
          <svg class="icon-moon" width="20" height="20">
            <use href="#icon-moon"></use>
          </svg>
        </div>
      </div>
    </header>
    
    <section class="hero">
      <h1 class="hero-title">Wagner. Bárbara. Joaquim.</h1>
      <p class="hero-subtitle">Porque o futuro que sonhamos começa com o que fazemos hoje.</p>
    </section>
    
    <div class="kpi-grid">
      <div class="kpi-card kpi-balance">
        <div class="kpi-title">Saldo Real (Caixa)</div>
        <div class="kpi-value" id="balanceValue">R$ 0,00</div>
        <div class="kpi-subtitle">
          <svg width="16" height="16">
            <use href="#icon-info"></use>
          </svg>
          <span>Saldo comprometido: R$ 0,00</span>
        </div>
      </div>
      
      <div class="kpi-card kpi-income">
        <div class="kpi-title">Receitas</div>
        <div class="kpi-value" id="incomeValue">R$ 0,00</div>
        <div class="kpi-subtitle">
          <span id="incomeReceivedValue">R$ 0,00 recebidos</span> /
          <span id="incomePendingValue">R$ 0,00 pendentes</span>
        </div>
      </div>
      
      <div class="kpi-card kpi-expense">
        <div class="kpi-title">Despesas</div>
        <div class="kpi-value" id="expenseValue">R$ 0,00</div>
        <div class="kpi-subtitle">
          <span id="expensePaidValue">R$ 0,00 pagos</span> /
          <span id="expensePendingValue">R$ 0,00 pendentes</span>
        </div>
      </div>
      
      <div class="kpi-card kpi-card-invoice">
        <div class="kpi-title">Fatura do Mês</div>
        <div class="kpi-value" id="invoiceValue">R$ 0,00</div>
        <div class="kpi-subtitle">
          <svg width="16" height="16">
            <use href="#icon-credit-card"></use>
          </svg>
          <span>Vencimento: <span id="invoiceDueDate">--/--/----</span></span>
        </div>
      </div>
    </div>
    
    <div class="insights-banner-container" id="insightsBannerContainer">
      <!-- Insights serão inseridos aqui dinamicamente -->
    </div>
    
    <section class="charts-container">
      <h2 class="charts-title">Resumo Financeiro</h2>
      <div class="charts-grid">
        <div class="chart-container">
          <h3>Despesas por Categoria</h3>
          <canvas id="categoryExpensesChart"></canvas> <!-- Alterado de catPie para categoryExpensesChart (Será Bar Chart Vertical) -->
        </div>
        <div class="chart-container">
          <h3>Uso do Limite (Cartões)</h3>
          <canvas id="cardUsageDonutChart"></canvas> <!-- Alterado de cardArea para cardUsageDonutChart (Será Doughnut Chart) -->
        </div>
      </div>
      <div class="charts-grid">
        <div class="chart-container">
          <h3>Despesas Fixas vs Variáveis</h3>
          <canvas id="fixedVsVariableChart"></canvas> <!-- Será Pie Chart -->
        </div>
        <div class="chart-container">
          <h3>Despesas por Pessoa</h3>
          <canvas id="personAnalysisChart"></canvas> <!-- Será Bar Chart Horizontal -->
        </div>
      </div>
    </section>
    
    <div class="chart-container" style="margin-bottom: var(--spacing-lg); height: 400px;"> 
      <h3>Receitas x Despesas (12 meses)</h3>
      <canvas id="annualBars"></canvas>
    </div>
    
    <div class="commitments">
      <div class="commitments-header active" id="commitmentsHeader">
        <h3>Compromissos Longos</h3>
        <svg width="20" height="20" id="commitmentToggleIcon">
            <use href="#icon-chevron-up"></use>
        </svg>
      </div>
      <div class="commitments-content" id="commitmentsContent" style="max-height: 500px;"> 
        <!-- Compromissos serão inseridos aqui dinamicamente -->
      </div>
    </div>
    
    <section class="transactions-container">
      <div class="card-transacoes">
        <div class="card-header">
          <h3 class="card-title">Transações</h3>
          <div class="filters transaction-filters" id="transaction-filters">
            <!-- Filtros serão inseridos aqui dinamicamente -->
          </div>
        </div>
        
        <div class="transactions-table-container">
          <table class="transactions-table" id="transactionsTable">
            <thead>
              <tr>
                <th class="sortable" data-sort="name">Nome</th>
                <th class="sortable" data-sort="person">Pessoa</th>
                <th class="sortable" data-sort="date">Data</th>
                <th class="sortable" data-sort="dueDate">Vencimento</th>
                <th class="sortable" data-sort="amount">Valor</th>
                <th class="sortable" data-sort="status">Status</th>
                <th class="sortable" data-sort="paymentMethod">Pagamento</th>
                <th>Pago?</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="transactionsTableBody">
              <!-- Transações serão inseridas aqui dinamicamente -->
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <!-- Modais -->
  <!-- Modal de Nova Receita -->
  <div class="modal-backdrop" id="incomeModal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Nova Receita</h2>
        <button class="modal-close" id="closeIncomeModal" aria-label="Fechar">
          <svg width="24" height="24">
            <use href="#icon-x"></use>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="incomeForm">
          <div class="form-group">
            <label class="form-label" for="incomeName">Nome</label>
            <input type="text" class="form-control" id="incomeName" placeholder="Nome da receita">
          </div>
          <div class="form-group">
            <label class="form-label" for="incomeAmount">Valor</label>
            <input type="number" class="form-control" id="incomeAmount" placeholder="0,00" min="0" step="0.01">
          </div>
          <div class="form-group">
            <label class="form-label" for="incomeCategory">Categoria</label>
            <div class="select-wrapper">
              <select class="select" id="incomeCategory"></select>
              <svg class="select-icon" width="16" height="16"><use href="#icon-chevron-down"></use></svg>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" for="incomeDate">Data de Lançamento</label>
            <input type="date" class="form-control" id="incomeDate">
          </div>
          <div class="form-group">
            <label class="form-label" for="incomePaymentMethod">Forma de Recebimento</label>
            <div class="select-wrapper">
              <select class="select" id="incomePaymentMethod"></select>
              <svg class="select-icon" width="16" height="16"><use href="#icon-chevron-down"></use></svg>
            </div>
          </div>
          <div class="form-group checkbox-wrapper">
            <input type="checkbox" class="checkbox" id="incomeIsRecurrent">
            <label class="checkbox-label" for="incomeIsRecurrent">Receita Recorrente</label>
          </div>
          <div class="form-group" id="incomeRecurrenceGroup" style="display: none;">
            <label class="form-label" for="incomeInstallments">Quantidade de Parcelas</label>
            <input type="number" class="form-control" id="incomeInstallments" min="2" value="2">
          </div>
          <div class="form-group" id="incomeStatusGroup">
            <label class="form-label">Status</label>
            <div class="radio-group">
              <div class="radio-wrapper">
                <input type="radio" class="radio" id="incomeStatusReceived" name="incomeStatus" value="received" checked>
                <label class="radio-label" for="incomeStatusReceived">Recebido</label>
              </div>
              <div class="radio-wrapper">
                <input type="radio" class="radio" id="incomeStatusPending" name="incomeStatus" value="pending">
                <label class="radio-label" for="incomeStatusPending">A Receber</label>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label" for="incomeNotes">Observação (opcional)</label>
            <textarea class="form-control" id="incomeNotes" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" id="cancelIncomeBtn">Cancelar</button>
        <button class="btn btn-success" id="saveIncomeBtn">Salvar Receita</button>
      </div>
    </div>
  </div>

 <!-- Modal de Nova Despesa -->
 <div class="modal-backdrop" id="expenseModal">
   <div class="modal">
     <div class="modal-header">
       <h2 class="modal-title">Nova Despesa</h2>
       <button class="modal-close" id="closeExpenseModal" aria-label="Fechar">
         <svg width="24" height="24"><use href="#icon-x"></use></svg>
       </button>
     </div>
     <div class="modal-body">
       <form id="expenseForm">
         <div class="form-group">
           <label class="form-label" for="expenseName">Nome</label>
           <input type="text" class="form-control" id="expenseName" placeholder="Nome da despesa">
         </div>
         <div class="form-group">
           <label class="form-label" for="expenseAmount">Valor</label>
           <input type="number" class="form-control" id="expenseAmount" placeholder="0,00" min="0" step="0.01">
         </div>
         <div class="form-group">
           <label class="form-label" for="expensePaymentMethod">Forma de Pagamento</label>
           <div class="select-wrapper">
             <select class="select" id="expensePaymentMethod"></select>
             <svg class="select-icon" width="16" height="16"><use href="#icon-chevron-down"></use></svg>
           </div>
         </div>
         <div class="form-group" id="creditCardGroup" style="display: none;">
           <label class="form-label" for="expenseCreditCard">Cartão de Crédito</label>
           <div class="select-wrapper">
             <select class="select" id="expenseCreditCard"></select>
             <svg class="select-icon" width="16" height="16"><use href="#icon-chevron-down"></use></svg>
           </div>
         </div>
         <div class="form-group">
           <label class="form-label" for="expenseCategory">Categoria</label>
           <div class="select-wrapper">
             <select class="select" id="expenseCategory"></select>
             <svg class="select-icon" width="16" height="16"><use href="#icon-chevron-down"></use></svg>
           </div>
         </div>
         <div class="form-group">
           <label class="form-label" for="expensePerson">Pessoa</label>
           <div class="select-wrapper">
             <select class="select" id="expensePerson"></select>
             <svg class="select-icon" width="16" height="16"><use href="#icon-chevron-down"></use></svg>
           </div>
         </div>
         <div class="form-group">
           <label class="form-label">Tipo de Despesa</label>
           <div class="radio-group">
             <div class="radio-wrapper">
               <input type="radio" class="radio" id="expenseTypeFixed" name="expenseType" value="fixed" required>
               <label class="radio-label" for="expenseTypeFixed">Fixa</label>
             </div>
             <div class="radio-wrapper">
               <input type="radio" class="radio" id="expenseTypeVariable" name="expenseType" value="variable" required>
               <label class="radio-label" for="expenseTypeVariable">Variável</label>
             </div>
           </div>
         </div>
         <div class="form-group">
           <label class="form-label" for="expenseDate">Data de Lançamento</label>
           <input type="date" class="form-control" id="expenseDate">
         </div>
         <div class="form-group" id="expenseDueDateGroup">
           <label class="form-label" for="expenseDueDate">Data de Vencimento</label>
           <input type="date" class="form-control" id="expenseDueDate">
         </div>
         <div class="form-group checkbox-wrapper">
           <input type="checkbox" class="checkbox" id="expenseIsRecurrent">
           <label class="checkbox-label" for="expenseIsRecurrent">Despesa Recorrente</label>
         </div>
         <div class="form-group" id="expenseRecurrenceGroup" style="display: none;">
           <label class="form-label" for="expenseInstallments">Quantidade de Parcelas</label>
           <input type="number" class="form-control" id="expenseInstallments" min="2" value="2">
         </div>
         <div class="form-group" id="expenseStatusGroup">
           <label class="form-label">Status</label>
           <div class="radio-group">
             <div class="radio-wrapper">
               <input type="radio" class="radio" id="expenseStatusPaid" name="expenseStatus" value="paid">
               <label class="radio-label" for="expenseStatusPaid">Pago</label>
             </div>
             <div class="radio-wrapper">
               <input type="radio" class="radio" id="expenseStatusPending" name="expenseStatus" value="pending" checked>
               <label class="radio-label" for="expenseStatusPending">Pendente</label>
             </div>
             <div class="radio-wrapper">
               <input type="radio" class="radio" id="expenseStatusScheduled" name="expenseStatus" value="scheduled">
               <label class="radio-label" for="expenseStatusScheduled">Agendado</label>
             </div>
           </div>
         </div>
         <div class="form-group" id="scheduledDateGroup" style="display: none;">
           <label class="form-label" for="expenseScheduledDate">Data de Agendamento</label>
           <input type="date" class="form-control" id="expenseScheduledDate">
         </div>
         <div class="form-group">
           <label class="form-label" for="expenseNotes">Observação (opcional)</label>
           <textarea class="form-control" id="expenseNotes" rows="3"></textarea>
         </div>
       </form>
     </div>
     <div class="modal-footer">
       <button class="btn btn-outline" id="cancelExpenseBtn">Cancelar</button>
       <button class="btn btn-danger" id="saveExpenseBtn">Salvar Despesa</button>
     </div>
   </div>
 </div>

 <!-- Modal de Edição de Transação -->
 <div class="modal-backdrop" id="editModal">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title" id="editModalTitle">Editar Transação</h2>
      <button class="modal-close" id="closeEditModal" aria-label="Fechar">
        <svg width="24" height="24"><use href="#icon-x"></use></svg>
      </button>
    </div>
    <div class="modal-body">
      <form id="editForm">
        <input type="hidden" id="editTransactionId">
        <input type="hidden" id="editTransactionType">
        <div class="form-group">
          <label class="form-label" for="editName">Nome</label>
          <input type="text" class="form-control" id="editName">
        </div>
        <div class="form-group">
          <label class="form-label" for="editAmount">Valor</label>
          <input type="number" class="form-control" id="editAmount" min="0" step="0.01">
        </div>
        <div class="form-group">
          <label class="form-label" for="editCategory">Categoria</label>
          <div class="select-wrapper">
            <select class="select" id="editCategory" data-type=""></select>
            <svg class="select-icon" width="16" height="16"><use href="#icon-chevron-down"></use></svg>
          </div>
        </div>
        <div class="form-group" id="editPersonGroup">
          <label class="form-label" for="editPerson">Pessoa</label>
          <div class="select-wrapper">
            <select class="select" id="editPerson"></select>
            <svg class="select-icon" width="16" height="16"><use href="#icon-chevron-down"></use></svg>
          </div>
        </div>
        <div class="form-group" id="editExpenseTypeGroup" style="display: none;">
          <label class="form-label">Tipo de Despesa</label>
          <div class="radio-group">
            <div class="radio-wrapper">
              <input type="radio" class="radio" id="editExpenseTypeFixed" name="editExpenseType" value="fixed">
              <label class="radio-label" for="editExpenseTypeFixed">Fixa</label>
            </div>
            <div class="radio-wrapper">
              <input type="radio" class="radio" id="editExpenseTypeVariable" name="editExpenseType" value="variable">
              <label class="radio-label" for="editExpenseTypeVariable">Variável</label>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label" for="editDate">Data de Lançamento</label>
          <input type="date" class="form-control" id="editDate">
        </div>
        <div class="form-group" id="editDueDateGroup">
          <label class="form-label" for="editDueDate">Data de Vencimento</label>
          <input type="date" class="form-control" id="editDueDate">
        </div>
        <div class="form-group">
          <label class="form-label" for="editPaymentMethod">Forma de Pagamento</label>
          <div class="select-wrapper">
            <select class="select" id="editPaymentMethod"></select>
            <svg class="select-icon" width="16" height="16"><use href="#icon-chevron-down"></use></svg>
          </div>
        </div>
        <div class="form-group" id="editCreditCardGroup" style="display: none;">
          <label class="form-label" for="editCreditCard">Cartão de Crédito</label>
          <div class="select-wrapper">
            <select class="select" id="editCreditCard"></select>
            <svg class="select-icon" width="16" height="16"><use href="#icon-chevron-down"></use></svg>
          </div>
        </div>
        <div class="form-group checkbox-wrapper">
          <input type="checkbox" class="checkbox" id="editIsRecurrent">
          <label class="checkbox-label" for="editIsRecurrent">Transação Recorrente</label>
        </div>
        <div class="form-group" id="editRecurrenceGroup" style="display: none;">
          <label class="form-label" for="editInstallments">Quantidade de Parcelas</label>
          <input type="number" class="form-control" id="editInstallments" min="2" value="2">
        </div>
        <div class="form-group" id="editStatusOuterGroup"> 
          <label class="form-label">Status</label>
          <div class="radio-group" id="editStatusGroup">
            <!-- Opções de status serão inseridas dinamicamente -->
          </div>
        </div>
        <div class="form-group" id="editScheduledDateGroup" style="display: none;">
          <label class="form-label" for="editScheduledDate">Data de Agendamento</label>
          <input type="date" class="form-control" id="editScheduledDate">
        </div>
        <div class="form-group">
          <label class="form-label" for="editNotes">Observação (opcional)</label>
          <textarea class="form-control" id="editNotes" rows="3"></textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="cancelEditBtn">Cancelar</button>
      <button class="btn btn-primary" id="saveEditBtn">Salvar Alterações</button>
    </div>
  </div>
 </div>

 <!-- Modal de Cartões -->
 <div class="modal-backdrop" id="cardsListModal">
  <div class="modal" style="max-width: 600px;">
    <div class="modal-header">
      <h2 class="modal-title">Cartões</h2>
      <button class="modal-close" id="closeCardsListModal" aria-label="Fechar">
        <svg width="24" height="24"><use href="#icon-x"></use></svg>
      </button>
    </div>
    <div class="modal-body">
      <div id="cardsList">
        <!-- Cards serão inseridos aqui dinamicamente -->
      </div>
      <button class="btn btn-primary" id="newCardBtn" style="margin-top: var(--spacing-md);">
        <svg width="16" height="16" style="margin-right: var(--spacing-xs);"><use href="#icon-plus"></use></svg>
        Novo Cartão
      </button>
    </div>
  </div>
 </div>

 <!-- Modal de Novo Cartão -->
 <div class="modal-backdrop" id="newCardModal">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title">Novo Cartão</h2>
      <button class="modal-close" id="closeNewCardModal" aria-label="Fechar">
        <svg width="24" height="24"><use href="#icon-x"></use></svg>
      </button>
    </div>
    <div class="modal-body">
      <form id="cardForm">
        <div class="form-group">
          <label class="form-label" for="cardName">Nome do Cartão</label>
          <input type="text" class="form-control" id="cardName" placeholder="Ex: Nubank">
        </div>
        <div class="form-group">
          <label class="form-label" for="cardLimit">Limite Total</label>
          <input type="number" class="form-control" id="cardLimit" placeholder="0,00" min="0" step="0.01">
        </div>
        <div class="form-group">
          <label class="form-label" for="cardClosingDay">Dia de Fechamento</label>
          <input type="number" class="form-control" id="cardClosingDay" placeholder="1-31" min="1" max="31">
        </div>
        <div class="form-group">
          <label class="form-label" for="cardDueDay">Dia de Vencimento</label>
          <input type="number" class="form-control" id="cardDueDay" placeholder="1-31" min="1" max="31">
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="cancelCardBtn">Cancelar</button>
      <button class="btn btn-primary" id="saveCardBtn">Salvar Cartão</button>
    </div>
  </div>
 </div>

 <!-- Modal de Fatura do Cartão -->
 <div class="modal-backdrop" id="cardInvoiceModal">
  <div class="modal" style="max-width: 700px;">
    <div class="modal-header">
      <h2 class="modal-title" id="cardInvoiceTitle">Fatura do Cartão</h2>
      <button class="modal-close" id="closeCardInvoiceModal" aria-label="Fechar">
        <svg width="24" height="24"><use href="#icon-x"></use></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="card" style="margin-bottom: var(--spacing-md);">
        <div id="cardInvoiceDetails">
          <!-- Detalhes da fatura serão inseridos aqui dinamicamente -->
        </div>
      </div>
      <h3>Despesas desta Fatura</h3>
      <div class="transactions-table-container">
        <table class="transactions-table" id="cardInvoiceTable">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Data</th>
              <th>Valor</th>
              <th>Pago?</th>
            </tr>
          </thead>
          <tbody id="cardInvoiceTableBody">
            <!-- Despesas da fatura serão inseridas aqui dinamicamente -->
          </tbody>
        </table>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="backToCardsBtn">Voltar</button>
      <button class="btn btn-primary" id="payInvoiceBtn">Pagar Fatura</button>
    </div>
  </div>
 </div>

 <!-- Modal de Confirmação de Exclusão -->
 <div class="modal-backdrop" id="deleteConfirmModal">
  <div class="modal" style="max-width: 400px;">
    <div class="modal-header">
      <h2 class="modal-title">
        <svg width="24" height="24" style="vertical-align: middle; margin-right: 8px;"><use href="#icon-alert"></use></svg>
        Confirmar Exclusão
      </h2>
      <button class="modal-close" id="closeDeleteConfirmModal" aria-label="Fechar">
        <svg width="24" height="24"><use href="#icon-x"></use></svg>
      </button>
    </div>
    <div class="modal-body">
      <p>Você deseja realmente excluir esta transação? Esta ação é irreversível.</p>
      <div id="recurrenceDeleteOptions" style="display: none; margin-top: var(--spacing-md);">
        <p><strong>Esta é uma transação recorrente. O que deseja fazer?</strong></p>
        <div class="radio-group" style="flex-direction: column; gap: var(--spacing-sm);">
          <div class="radio-wrapper">
            <input type="radio" class="radio" id="deleteSingle" name="deleteOption" value="single" checked>
            <label class="radio-label" for="deleteSingle">Excluir apenas esta parcela</label>
          </div>
          <div class="radio-wrapper">
            <input type="radio" class="radio" id="deleteAllFuture" name="deleteOption" value="future">
            <label class="radio-label" for="deleteAllFuture">Excluir esta e todas as parcelas futuras</label>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="cancelDeleteBtn">Cancelar</button>
      <button class="btn btn-danger" id="confirmDeleteBtn">Excluir</button>
    </div>
  </div>
 </div>

 <!-- Modal de Confirmação de Pagamento de Fatura -->
 <div class="modal-backdrop" id="payInvoiceConfirmModal">
  <div class="modal" style="max-width: 400px;">
    <div class="modal-header">
      <h2 class="modal-title">
        <svg width="24" height="24" style="vertical-align: middle; margin-right: 8px;"><use href="#icon-credit-card"></use></svg>
        Pagar Fatura do Cartão
      </h2>
      <button class="modal-close" id="closePayInvoiceConfirmModal" aria-label="Fechar">
        <svg width="24" height="24"><use href="#icon-x"></use></svg>
      </button>
    </div>
    <div class="modal-body">
      <p>Confirmar pagamento de todas as despesas desta fatura?</p>
      <p style="margin-top: var(--spacing-xs);">Total: <strong id="invoiceConfirmAmount">R$ 0,00</strong></p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="cancelPayInvoiceBtn">Cancelar</button>
      <button class="btn btn-primary" id="confirmPayInvoiceBtn">Pagar</button>
    </div>
  </div>
 </div>

 <!-- Modal de Categorias -->
 <div class="modal-backdrop" id="categoriesModal">
  <div class="modal" style="max-width: 600px;">
    <div class="modal-header">
      <h2 class="modal-title">Gerenciar Categorias</h2>
      <button class="modal-close" id="closeCategoriesModal" aria-label="Fechar">
        <svg width="24" height="24"><use href="#icon-x"></use></svg>
      </button>
    </div>
    <div class="modal-body categories-container">
      <ul class="nav-tabs" id="categoryTabs" role="tablist">
        <li class="nav-item"><a class="nav-link active" id="income-cat-tab" data-toggle="tab" href="#income-cat" role="tab">Receitas</a></li>
        <li class="nav-item"><a class="nav-link" id="expense-cat-tab" data-toggle="tab" href="#expense-cat" role="tab">Despesas</a></li>
        <li class="nav-item"><a class="nav-link" id="payment-methods-tab" data-toggle="tab" href="#payment-methods" role="tab">Pagamentos</a></li>
        <li class="nav-item"><a class="nav-link" id="people-tab" data-toggle="tab" href="#people" role="tab">Pessoas</a></li>
        <li class="nav-item"><a class="nav-link" id="investment-cat-tab" data-toggle="tab" href="#investment-cat" role="tab">Investimentos</a></li>
      </ul>
      <div class="tab-content" id="categoryTabContent">
        <div class="tab-pane fade show active" id="income-cat" role="tabpanel">
          <div class="category-list" id="incomeCategoriesList"></div>
          <form class="add-category-form">
            <div class="custom-icon-input"><div class="custom-icon-preview" id="newIncomeCategoryIconPreview">💰</div><input type="text" class="form-control" id="newIncomeCategoryIconInput" placeholder="Ícone"></div>
            <input type="text" class="form-control" id="newIncomeCategoryInput" placeholder="Nova categoria de receita">
            <button type="button" class="btn btn-primary" id="addIncomeCategoryBtn">Adicionar</button>
          </form>
        </div>
        <div class="tab-pane fade" id="expense-cat" role="tabpanel">
          <div class="category-list" id="expenseCategoriesList"></div>
          <form class="add-category-form">
            <div class="custom-icon-input"><div class="custom-icon-preview" id="newExpenseCategoryIconPreview">🛍️</div><input type="text" class="form-control" id="newExpenseCategoryIconInput" placeholder="Ícone"></div>
            <input type="text" class="form-control" id="newExpenseCategoryInput" placeholder="Nova categoria de despesa">
            <button type="button" class="btn btn-primary" id="addExpenseCategoryBtn">Adicionar</button>
          </form>
        </div>
        <div class="tab-pane fade" id="payment-methods" role="tabpanel">
          <div class="category-list" id="paymentMethodsList"></div>
          <form class="add-category-form">
            <div class="custom-icon-input"><div class="custom-icon-preview" id="newPaymentMethodIconPreview">💳</div><input type="text" class="form-control" id="newPaymentMethodIconInput" placeholder="Ícone"></div>
            <input type="text" class="form-control" id="newPaymentMethodInput" placeholder="Nova forma de pagamento">
            <button type="button" class="btn btn-primary" id="addPaymentMethodBtn">Adicionar</button>
          </form>
        </div>
        <div class="tab-pane fade" id="people" role="tabpanel">
          <div class="category-list" id="peopleList"></div>
          <form class="add-category-form">
            <div class="custom-icon-input"><div class="custom-icon-preview" id="newPersonIconPreview">👤</div><input type="text" class="form-control" id="newPersonIconInput" placeholder="Ícone"></div>
            <input type="text" class="form-control" id="newPersonInput" placeholder="Nome da pessoa">
            <button type="button" class="btn btn-primary" id="addPersonBtn">Adicionar</button>
          </form>
        </div>
        <div class="tab-pane fade" id="investment-cat" role="tabpanel">
          <div class="category-list" id="investmentCategoriesList"></div>
          <form class="add-category-form">
            <div class="custom-icon-input"><div class="custom-icon-preview" id="newInvestmentCategoryIconPreview">📈</div><input type="text" class="form-control" id="newInvestmentCategoryIconInput" placeholder="Ícone"></div>
            <input type="text" class="form-control" id="newInvestmentCategoryInput" placeholder="Nova categoria de investimento">
            <button type="button" class="btn btn-primary" id="addInvestmentCategoryBtn">Adicionar</button>
          </form>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="closeCategoriesBtn">Fechar</button>
    </div>
  </div>
 </div>

 <!-- Modal de Edição de Categoria/Item -->
 <div class="modal-backdrop" id="editCategoryModal">
  <div class="modal" style="max-width: 400px;">
    <div class="modal-header">
      <h2 class="modal-title" id="editCategoryTitle">Editar Item</h2>
      <button class="modal-close" id="closeEditCategoryModal" aria-label="Fechar">
        <svg width="24" height="24"><use href="#icon-x"></use></svg>
      </button>
    </div>
    <div class="modal-body">
      <form id="editCategoryForm">
        <input type="hidden" id="editCategoryId">
        <input type="hidden" id="editCategoryType">
        <div class="form-group">
          <label class="form-label">Ícone</label>
          <div class="custom-icon-input">
            <div class="custom-icon-preview" id="editCategoryIconPreview">ℹ️</div>
            <input type="text" class="form-control" id="editCategoryIconInput" placeholder="Emoji ou ícone">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label" for="editCategoryName">Nome</label>
          <input type="text" class="form-control" id="editCategoryName" placeholder="Nome">
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="cancelEditCategoryBtn">Cancelar</button>
      <button class="btn btn-primary" id="saveEditCategoryBtn">Salvar</button>
    </div>
  </div>
 </div>

 <!-- Modal Principal de Investimentos -->
 <div class="modal-backdrop" id="investmentsModal">
  <div class="modal" style="max-width: 900px;">
    <div class="modal-header">
      <h2 class="modal-title">Investimentos</h2>
      <button class="modal-close" id="closeInvestmentsModal" aria-label="Fechar">
        <svg width="24" height="24"><use href="#icon-x"></use></svg>
      </button>
    </div>
    <div class="modal-body">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
        <h3>Seus Investimentos</h3>
        <button class="btn btn-primary" id="newInvestmentBtn">
          <svg width="16" height="16" style="margin-right: var(--spacing-xs);"><use href="#icon-plus"></use></svg>
          Novo Investimento
        </button>
      </div>
      <div class="investment-grid" id="investmentsGrid">
        <!-- Cards de investimentos -->
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="closeInvestmentsBtn">Fechar</button>
    </div>
  </div>
 </div>

 <!-- Modal para Detalhe do Investimento -->
 <div class="modal-backdrop" id="investmentDetailModal">
  <div class="modal" style="max-width: 800px;">
    <div class="modal-header">
      <h2 class="modal-title" id="investmentDetailTitle" style="display: flex; align-items: center; gap: var(--spacing-sm);">
        <button class="btn btn-icon btn-outline" id="backToInvestmentsBtn" aria-label="Voltar">
          <svg width="16" height="16"><use href="#icon-arrow-left"></use></svg>
        </button>
        <span id="investmentDetailName">Nome do Investimento</span>
      </h2>
      <button class="modal-close" id="closeInvestmentDetailModal" aria-label="Fechar">
        <svg width="24" height="24"><use href="#icon-x"></use></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="investment-detail">
        <div class="investment-detail-header">
          <div class="investment-detail-stat"><div class="investment-detail-title">Guardado</div><div class="investment-detail-value" id="investmentDetailSaved">R$ 0,00</div></div>
          <div class="investment-detail-stat"><div class="investment-detail-title">Meta</div><div class="investment-detail-value" id="investmentDetailGoal">R$ 0,00</div></div>
          <div class="investment-detail-stat"><div class="investment-detail-title">Progresso</div><div class="investment-detail-value" id="investmentDetailProgress">0%</div></div>
        </div>
        <div style="margin-bottom: var(--spacing-md);">
          <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: var(--spacing-sm);">
            <div><div class="investment-detail-title">Categoria</div><div id="investmentDetailCategory">Viagem</div></div>
            <div><div class="investment-detail-title">Criado em</div><div id="investmentDetailCreatedAt">01/01/2025</div></div>
            <div><div class="investment-detail-title">Objetivo</div><div id="investmentDetailTarget">Julho de 2026</div></div>
          </div>
          <div style="margin-top: var(--spacing-sm);"><div class="investment-detail-title">Observação</div><div id="investmentDetailNotes">-</div></div>
        </div>
      </div>
      <div class="investment-history">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm);">
          <h3 class="investment-history-title">Histórico de Aportes</h3>
          <button class="btn btn-primary" id="addInvestmentContributionBtn">
            <svg width="16" height="16" style="margin-right: var(--spacing-xs);"><use href="#icon-plus"></use></svg>
            Adicionar Aporte
          </button>
        </div>
        <div class="transactions-table-container">
            <table class="investment-history-table">
            <thead><tr><th>Data</th><th>Valor</th><th>Descrição</th><th>Ações</th></tr></thead>
            <tbody id="investmentHistoryTableBody"></tbody>
            </table>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger" id="deleteInvestmentBtn">Excluir Investimento</button>
      <button class="btn btn-primary" id="editInvestmentBtn">Editar Investimento</button>
    </div>
  </div>
 </div>

 <!-- Modal de Novo Investimento -->
 <div class="modal-backdrop" id="newInvestmentModal">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title" id="newInvestmentModalTitle">Novo Investimento</h2>
      <button class="modal-close" id="closeNewInvestmentModal" aria-label="Fechar">
        <svg width="24" height="24"><use href="#icon-x"></use></svg>
      </button>
    </div>
    <div class="modal-body">
      <form id="investmentForm">
        <div class="form-group"><label class="form-label" for="investmentName">Nome do objetivo</label><input type="text" class="form-control" id="investmentName" placeholder="Ex: Viagem em Família"></div>
        <div class="form-group"><label class="form-label" for="investmentAmount">Valor inicial</label><input type="number" class="form-control" id="investmentAmount" placeholder="0,00" min="0" step="0.01"></div>
        <div class="form-group"><label class="form-label" for="investmentGoal">Meta final (opcional)</label><input type="number" class="form-control" id="investmentGoal" placeholder="0,00" min="0" step="0.01"></div>
        <div class="form-group">
          <label class="form-label" for="investmentCategory">Tipo/Categoria</label>
          <div class="select-wrapper">
            <select class="select" id="investmentCategorySelect"></select> 
            <svg class="select-icon" width="16" height="16"><use href="#icon-chevron-down"></use></svg>
          </div>
        </div>
        <div class="form-group"><label class="form-label" for="investmentTargetDate">Data-alvo (opcional)</label><input type="date" class="form-control" id="investmentTargetDate"></div>
        <div class="form-group"><label class="form-label" for="investmentNotes">Observações (opcional)</label><textarea class="form-control" id="investmentNotes" rows="3"></textarea></div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="cancelInvestmentBtn">Cancelar</button>
      <button class="btn btn-primary" id="saveInvestmentBtn">Salvar Investimento</button>
    </div>
  </div>
 </div>

 <!-- Modal para Adicionar Aporte -->
 <div class="modal-backdrop" id="newContributionModal">
  <div class="modal" style="max-width: 400px;">
    <div class="modal-header">
      <h2 class="modal-title" id="newContributionModalTitle">Adicionar Novo Valor</h2>
      <button class="modal-close" id="closeNewContributionModal" aria-label="Fechar">
        <svg width="24" height="24"><use href="#icon-x"></use></svg>
      </button>
    </div>
    <div class="modal-body">
      <form id="contributionForm">
        <input type="hidden" id="contributionInvestmentId">
        <div class="form-group"><label class="form-label" for="contributionAmount">Valor</label><input type="number" class="form-control" id="contributionAmount" placeholder="0,00" min="0" step="0.01" required></div>
        <div class="form-group"><label class="form-label" for="contributionDate">Data</label><input type="date" class="form-control" id="contributionDate" required></div>
        <div class="form-group"><label class="form-label" for="contributionDescription">Descrição</label><input type="text" class="form-control" id="contributionDescription" placeholder="Ex: Depósito mensal"></div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="cancelContributionBtn">Cancelar</button>
      <button class="btn btn-primary" id="saveContributionBtn">Adicionar</button>
    </div>
  </div>
 </div>

 <!-- Modal para detalhes de contas vencidas/a vencer -->
 <div class="modal-backdrop" id="dueTransactionsModal">
  <div class="modal" style="max-width: 700px;">
    <div class="modal-header">
      <h2 class="modal-title" id="dueTransactionsModalTitle">
        <svg width="24" height="24" style="vertical-align: middle; margin-right: 8px;" id="dueTransactionsModalIcon"><use href="#icon-alert"></use></svg>
        <span id="dueTransactionsModalTitleText">Contas</span>
      </h2>
      <button class="modal-close" id="closeDueTransactionsModal" aria-label="Fechar">
        <svg width="24" height="24"><use href="#icon-x"></use></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="transactions-table-container">
        <table class="transactions-table" id="dueTransactionsTable">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Categoria</th>
              <th>Vencimento</th>
              <th>Valor</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="dueTransactionsTableBody"></tbody>
        </table>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" id="closeDueTransactionsBtn">Fechar</button>
      <button class="btn btn-primary" id="payAllDueBtn" style="display:none;">Pagar Todas</button>
    </div>
  </div>
 </div>

 <div class="toast-container" id="toastContainer"></div>

 <script>
  
  const $ = selector => document.querySelector(selector);
  const $$ = selector => Array.from(document.querySelectorAll(selector));

  const state = {
    year: new Date().getFullYear(),
    month: new Date().getMonth(),
    transactions: [],
    cards: [],
    filteredTransactions: [],
    insights: [],
    sortColumn: 'dueDate', 
    sortDirection: 'asc', 
    filters: {
      category: '',
      status: '',
      paymentMethod: '',
      person: '',
      transactionType: '' 
    },
    categories: {
      income: [
        { id: 'salario', name: 'Salário', icon: '💰', type: 'income' },
        { id: 'investimentos_income', name: 'Rend. Investimentos', icon: '📈', type: 'income' },
        { id: 'freelance', name: 'Freelance', icon: '💻', type: 'income' },
        { id: 'presente', name: 'Presente', icon: '🎁', type: 'income' },
        { id: 'outros_income', name: 'Outros', icon: 'ℹ️', type: 'income' }
      ],
      expense: [
        { id: 'alimentacao', name: 'Alimentação', icon: '🍔', type: 'expense' },
        { id: 'moradia', name: 'Moradia', icon: '🏠', type: 'expense' },
        { id: 'transporte', name: 'Transporte', icon: '🚗', type: 'expense' },
        { id: 'saude', name: 'Saúde', icon: '⚕️', type: 'expense' },
        { id: 'educacao', name: 'Educação', icon: '📚', type: 'expense' },
        { id: 'lazer', name: 'Lazer', icon: '🎮', type: 'expense' },
        { id: 'compras', name: 'Compras', icon: '🛍️', type: 'expense' },
        { id: 'contas', name: 'Contas e serviços', icon: '📝', type: 'expense' },
        { id: 'impostos', name: 'Impostos', icon: '💸', type: 'expense' },
        { id: 'outros_expense', name: 'Outros', icon: 'ℹ️', type: 'expense' }
      ],
      investment: [
        { id: 'viagem', name: 'Viagem', icon: '✈️', type: 'investment' },
        { id: 'emergencia', name: 'Emergência', icon: '🚨', type: 'investment' },
        { id: 'filho', name: 'Filho', icon: '👶', type: 'investment' },
        { id: 'tesouro', name: 'Tesouro Direto', icon: '🏛️', type: 'investment' },
        { id: 'acoes', name: 'Ações', icon: '📊', type: 'investment' },
        { id: 'outro_investment', name: 'Outro', icon: '💰', type: 'investment' }
      ]
    },
    paymentMethods: [
      { id: 'dinheiro', name: 'Dinheiro', icon: '💵' },
      { id: 'pix', name: 'Pix', icon: '⚡' },
      { id: 'debito', name: 'Débito', icon: '💳' },
      { id: 'debito_conta', name: 'Débito em Conta', icon: '🏦' },
      { id: 'transferencia', name: 'Transferência Bancária', icon: '🔄' },
      { id: 'boleto', name: 'Boleto', icon: '📄' },
      { id: 'credito', name: 'Cartão de Crédito', icon: '💳' }
    ],
    people: [
      { id: 'familia', name: 'Família', icon: '👨‍👩‍👧‍👦' },
      { id: 'wagner', name: 'Wagner', icon: '👨‍💻' },
      { id: 'barbara', name: 'Bárbara', icon: '👩‍🎨' },
      { id: 'joaquim', name: 'Joaquim', icon: '👶' }
    ],
    investments: [],
    investmentContributions: [],
    currentTransaction: null,
    currentCard: null,
    currentCategory: null,
    currentInvestment: null,
    currentContribution: null,
    themePreference: 'light'
  };

  const formatCurrency = value => {
    return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
  };

  const parseLocalDateString = (dateInput) => {
    if (dateInput instanceof Date && !isNaN(dateInput)) return new Date(Date.UTC(dateInput.getFullYear(), dateInput.getMonth(), dateInput.getDate()));
    if (typeof dateInput === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateInput)) {
      const [year, month, day] = dateInput.split('-').map(Number);
      return new Date(Date.UTC(year, month - 1, day)); 
    }
    return null;
  };
  
  const formatDate = (date, options = {}) => {
    const dateObj = parseLocalDateString(date);
    if (!dateObj) return '--/--/----';
    return dateObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', timeZone: 'UTC', ...options });
  };

  const localDateToISOString = (date) => {
    if (!date) return null;
    const d = date instanceof Date ? date : parseLocalDateString(date);
    if (!d) return null;
    const year = d.getUTCFullYear();
    const month = String(d.getUTCMonth() + 1).padStart(2, '0');
    const day = String(d.getUTCDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  };

  const updateChartColors = () => {
    const isDarkTheme = document.documentElement.getAttribute('data-theme') === 'dark';
    const textColor = getComputedStyle(document.documentElement).getPropertyValue('--color-on-surface-variant').trim();
    const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--color-outline').trim();
    const surfaceColor = getComputedStyle(document.documentElement).getPropertyValue('--color-surface').trim();
    
    const chartColorsVibrant = [
        '#42A5F5', '#FF7043', '#66BB6A', '#FFEE58', '#AB47BC', 
        '#26A69A', '#EF5350', '#78909C', '#FFA726', '#29B6F6', 
        '#9CCC65', '#FFCA28'
    ];
    const incomeColor = getComputedStyle(document.documentElement).getPropertyValue('--color-income').trim();
    const expenseColor = getComputedStyle(document.documentElement).getPropertyValue('--color-expense').trim();
    const cardAvailableColor = getComputedStyle(document.documentElement).getPropertyValue('--color-surface-variant').trim();


    Chart.defaults.color = textColor;
    Chart.defaults.borderColor = gridColor;
    Chart.defaults.plugins.tooltip.backgroundColor = isDarkTheme ? 'rgba(40,40,40,0.9)' : 'rgba(250,250,250,0.9)';
    Chart.defaults.plugins.tooltip.titleColor = getComputedStyle(document.documentElement).getPropertyValue('--color-on-surface').trim();
    Chart.defaults.plugins.tooltip.bodyColor = getComputedStyle(document.documentElement).getPropertyValue('--color-on-surface').trim();
    Chart.defaults.plugins.tooltip.borderColor = gridColor;
    Chart.defaults.plugins.tooltip.borderWidth = 1;
    Chart.defaults.plugins.tooltip.padding = 10;
    Chart.defaults.plugins.tooltip.cornerRadius = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--radius-md')) || 4;
    Chart.defaults.layout.padding = { top: 10, bottom: 40, left: 10, right: 10 }; // Aumentado bottom para legendas

    const charts = [categoryExpensesChart, cardUsageDonutChart, annualBarsChart, fixedVsVariableChart, personAnalysisChart];
    charts.forEach(chart => {
      if (chart) {
        chart.options.plugins.legend.labels.color = textColor;
        if (chart.options.scales && chart.options.scales.x) {
          chart.options.scales.x.ticks.color = textColor;
          chart.options.scales.x.grid.color = gridColor;
          chart.options.scales.x.grid.borderColor = gridColor;
        }
        if (chart.options.scales && chart.options.scales.y) {
          chart.options.scales.y.ticks.color = textColor;
          chart.options.scales.y.grid.color = gridColor;
          chart.options.scales.y.grid.borderColor = gridColor;
        }

        if (chart.data.datasets[0]) {
            if (chart.config.type === 'doughnut' || chart.config.type === 'pie') {
                if (chart === cardUsageDonutChart && chart.data.datasets[0].data.length === 2) { 
                    chart.data.datasets[0].backgroundColor = [expenseColor, cardAvailableColor]; // Usado (vermelho), Disponível (cinza claro)
                } else if (chart === fixedVsVariableChart) {
                    chart.data.datasets[0].backgroundColor = [chartColorsVibrant[5], chartColorsVibrant[6]]; 
                } else { 
                    chart.data.datasets[0].backgroundColor = chartColorsVibrant;
                }
                chart.data.datasets[0].borderColor = surfaceColor;
                chart.data.datasets[0].borderWidth = 2;
            } else if (chart.config.type === 'bar') {
                if (chart === annualBarsChart) { 
                    if (chart.data.datasets[0]) chart.data.datasets[0].backgroundColor = incomeColor;
                    if (chart.data.datasets[1]) chart.data.datasets[1].backgroundColor = expenseColor;
                } else { // Gráficos de barras (Categoria - vertical, Pessoa - horizontal)
                    chart.data.datasets[0].backgroundColor = chartColorsVibrant; 
                    chart.data.datasets[0].borderColor = chartColorsVibrant.map(c => c + 'B3'); 
                    chart.data.datasets[0].borderWidth = 1;
                }
            }
        }
        chart.update();
      }
    });
  };

  const toggleTheme = () => {
    const newTheme = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', newTheme);
    state.themePreference = newTheme;
    localStorage.setItem('themePreference', newTheme);
    updateChartColors();
  };

  const initTheme = () => {
    const savedTheme = localStorage.getItem('themePreference') || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    document.documentElement.setAttribute('data-theme', savedTheme);
    state.themePreference = savedTheme;
    $('#themeToggle').addEventListener('click', toggleTheme);
  };

  const firebaseConfig = {
    apiKey: "AIzaSyDvL_nYWhv_8rPouejiWbDZtDCKHYOQyEY",
    authDomain: "calculadora-da-familia.firebaseapp.com",
    projectId: "calculadora-da-familia",
    storageBucket: "calculadora-da-familia.appspot.com",
    messagingSenderId: "69721783786",
    appId: "1:69721783786:web:c4703b5c182e3681e8c693",
    measurementId: "G-YM5TR661S6"
  };

  let db;
  try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    db.enablePersistence({experimentalForceOwningTab: true}).catch(err => console.warn('Firebase persistence error:', err.code));
    console.log('Firebase inicializado.');
  } catch (error) {
    console.error('Erro Firebase:', error);
    showToast('Erro de conexão com o Firebase.', 'error');
    db = { collection: () => ({ get: () => Promise.resolve({ docs: [], empty: true }), doc: () => ({ get: () => Promise.resolve({ exists: false, data: () => ({}) }), set: () => Promise.resolve(), update: () => Promise.resolve(), delete: () => Promise.resolve() }), add: () => Promise.resolve({ id: 'temp-id' }) }) };
  }

  const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

  const showToast = (message, type = 'success') => {
    const container = $('#toastContainer');
    if (!container) return;
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    let iconName = type === 'success' ? 'icon-check' : type === 'error' ? 'icon-x' : type === 'warning' ? 'icon-alert' : 'icon-info';
    toast.innerHTML = `<div class="toast-icon"><svg width="24" height="24"><use href="#${iconName}"></use></svg></div><div class="toast-content">${message}</div><button class="toast-close" aria-label="Fechar"><svg width="16" height="16"><use href="#icon-x"></use></svg></button>`;
    container.appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 10);
    toast.querySelector('.toast-close').addEventListener('click', () => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    });
    setTimeout(() => {
      if (toast.parentNode) {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }
    }, 5000);
  };

  const openModal = modalId => {
    const modal = $(`#${modalId}`);
    if (modal) {
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }
  };
  const closeModal = modalId => {
    const modal = $(`#${modalId}`);
    if (modal) {
      modal.classList.remove('active');
      if (!$$('.modal-backdrop.active').length) { 
        document.body.style.overflow = '';
      }
    }
  };
  const closeAllModals = () => {
    $$('.modal-backdrop.active').forEach(modal => closeModal(modal.id));
  };

  const setDateInputValue = (inputId, date) => {
    const input = $(`#${inputId}`);
    if (input) input.value = localDateToISOString(date);
  };
  const getDateInputValue = inputId => {
    const input = $(`#${inputId}`);
    return input && input.value ? parseLocalDateString(input.value) : null;
  };

  const updateYearOptions = () => {
    const yearSelect = $('#yearSelect');
    if (yearSelect) {
      yearSelect.innerHTML = '';
      const currentYear = new Date().getFullYear();
      for (let year = currentYear - 2; year <= currentYear + 5; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        option.selected = year === state.year;
        yearSelect.appendChild(option);
      }
    }
  };

  /**
   * Calcula a data de vencimento real de uma compra no cartão de crédito.
   * @param {Date|string} dataCompraInput - A data em que a compra foi realizada.
   * @param {object} cartao - O objeto do cartão com closingDay e dueDay.
   * @returns {Date|null} A data de vencimento da fatura ou null.
   */
  const calcularVencimentoReal = (dataCompraInput, cartao) => {
    if (!dataCompraInput || !cartao || !cartao.closingDay || !cartao.dueDay) return null;
    
    const compraDate = parseLocalDateString(dataCompraInput);
    if (!compraDate) return null;

    const compraDay = compraDate.getUTCDate();
    let mesFechamentoFatura = compraDate.getUTCMonth(); // 0-11
    let anoFechamentoFatura = compraDate.getUTCFullYear();

    // Se a compra foi feita APÓS o dia de fechamento do ciclo atual,
    // ela entra na fatura que fecha no próximo mês.
    if (compraDay > cartao.closingDay) {
        mesFechamentoFatura++;
        if (mesFechamentoFatura > 11) {
            mesFechamentoFatura = 0;
            anoFechamentoFatura++;
        }
    }

    // Agora, mesFechamentoFatura e anoFechamentoFatura são o mês/ano em que a fatura (contendo esta compra) FECHA.
    // Precisamos calcular quando essa fatura VENCE.
    let mesVencimentoFinal = mesFechamentoFatura;
    let anoVencimentoFinal = anoFechamentoFatura;

    // Se o dia de vencimento é MENOR que o dia de fechamento (ex: vence dia 5, fecha dia 20),
    // a fatura vence no mês SEGUINTE ao mês de fechamento.
    if (cartao.dueDay < cartao.closingDay) {
        mesVencimentoFinal++;
        if (mesVencimentoFinal > 11) {
            mesVencimentoFinal = 0;
            anoVencimentoFinal++;
        }
    }
    // Se o dia de vencimento é MAIOR OU IGUAL ao dia de fechamento (ex: fecha dia 10, vence dia 20),
    // a fatura vence no MESMO mês do fechamento. (Nenhuma alteração em mesVencimentoFinal aqui)

    return new Date(Date.UTC(anoVencimentoFinal, mesVencimentoFinal, cartao.dueDay));
  };
  
  const calcularMelhorDiaCompras = (cartao) => {
    if (!cartao || !cartao.closingDay) return null;
    let melhorDia = cartao.closingDay + 1;
    // Esta simplificação é geralmente aceita, mas para ser exato, precisaria do número de dias do mês.
    // Para fins práticos, se closingDay for 31, melhor dia é 1. Se for 30 em mês de 30 dias, melhor dia é 1.
    // A lógica atual de > 31 ? 1 : melhorDia é uma aproximação.
    // Uma forma mais robusta seria criar uma data com o closingDay, adicionar 1 dia.
    const dataFechamentoNoMesAtual = new Date(Date.UTC(state.year, state.month, cartao.closingDay));
    const dataMelhorDia = new Date(dataFechamentoNoMesAtual);
    dataMelhorDia.setUTCDate(dataFechamentoNoMesAtual.getUTCDate() + 1);
    return dataMelhorDia.getUTCDate();
  };

  const handleStatusField = (formPrefix) => {
    const paymentMethodEl = $(`#${formPrefix}PaymentMethod`);
    const isRecurrentEl = $(`#${formPrefix}IsRecurrent`);
    const statusGroupEl = $(`#${formPrefix}StatusGroup`);
    const statusPendingRadio = $(`#${formPrefix}StatusPending`); 

    if (!paymentMethodEl || !statusGroupEl || !statusPendingRadio) return;
    
    const isCreditCard = paymentMethodEl.value === 'credito';
    const isRecurrent = isRecurrentEl ? isRecurrentEl.checked : false;

    if (isCreditCard || (isRecurrent && formPrefix.includes('expense'))) { 
        statusGroupEl.style.display = 'none';
        statusPendingRadio.checked = true;
    } else if (isRecurrent && formPrefix.includes('income')) { 
        statusGroupEl.style.display = 'none';
        statusPendingRadio.checked = true; 
    } else {
        statusGroupEl.style.display = 'block'; 
    }
  };

  async function updateCardLimits(cardId, transactionAmount, operation, oldTransactionAmount = 0) {
    const card = state.cards.find(c => c.id === cardId);
    if (!card) return;

    let amountChange = 0;
    if (operation === 'add') {
        amountChange = transactionAmount;
    } else if (operation === 'subtract') {
        amountChange = -transactionAmount;
    } else if (operation === 'update') {
        amountChange = transactionAmount - oldTransactionAmount;
    }

    // currentInvoice representa o valor total de compras feitas no cartão que ainda não foram pagas
    // e que impactam o limite. Não é necessariamente a fatura do mês atual.
    // Esta lógica de currentInvoice e availableLimit é para o limite global do cartão.
    card.currentInvoice = (card.currentInvoice || 0) + amountChange;
    card.currentInvoice = Math.max(0, card.currentInvoice); 
    card.availableLimit = card.limit - card.currentInvoice;

    try {
        await db.collection('cards').doc(card.id).update({
            currentInvoice: card.currentInvoice, // Este campo no DB reflete o saldo devedor total do cartão
            availableLimit: card.availableLimit
        });
    } catch (error) {
        console.error("Error updating card limits in DB:", error);
        showToast('Erro ao atualizar limite do cartão.', 'error');
    }
    updateCreditCardSelects();
  }


  const loadCategoriesAndPaymentMethods = async () => {
    try {
      const collectionsToLoad = [
        { name: 'categories', stateKey: 'categories', defaultKey: true, typeField: 'type' },
        { name: 'paymentMethods', stateKey: 'paymentMethods', defaultKey: false },
        { name: 'people', stateKey: 'people', defaultKey: false }
      ];

      for (const coll of collectionsToLoad) {
        const snapshot = await db.collection(coll.name).get();
        if (!snapshot.empty) {
          if (coll.defaultKey) { 
            state[coll.stateKey].income = [];
            state[coll.stateKey].expense = [];
            state[coll.stateKey].investment = [];
            snapshot.docs.forEach(doc => {
              const item = { id: doc.id, ...doc.data() };
              if (item[coll.typeField] === 'income') state[coll.stateKey].income.push(item);
              else if (item[coll.typeField] === 'expense') state[coll.stateKey].expense.push(item);
              else if (item[coll.typeField] === 'investment') state[coll.stateKey].investment.push(item);
            });
          } else {
            state[coll.stateKey] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          }
        } else if (state[coll.stateKey]) { 
          const batch = db.batch();
          if (coll.defaultKey) {
            Object.values(state[coll.stateKey]).flat().forEach(item => {
              const docRef = db.collection(coll.name).doc(item.id);
              batch.set(docRef, item); 
            });
          } else {
            state[coll.stateKey].forEach(item => {
              const docRef = db.collection(coll.name).doc(item.id);
              batch.set(docRef, item);
            });
          }
          await batch.commit();
        }
      }
      updateAllSelectsAndLists();
    } catch (error) {
      console.error('Erro ao carregar dados iniciais:', error);
      showToast('Erro ao carregar dados. Tente novamente.', 'error');
    }
  };
  
  const updateAllSelectsAndLists = () => {
    updateCategorySelects();
    updatePaymentMethodSelects();
    updatePeopleSelects();
    updateInvestmentCategorySelects(); 
    renderCategoriesList(); 
    renderPaymentMethodsList();
    renderInvestmentCategoriesList();
    updatePeopleList();
  };

  const updateCategorySelects = () => {
    const populateSelect = (selectEl, categories) => {
      if (selectEl) {
        const currentValue = selectEl.value;
        selectEl.innerHTML = '<option value="">Selecione...</option>';
        categories.forEach(category => {
          const option = document.createElement('option');
          option.value = category.id;
          option.textContent = `${category.icon || ''} ${category.name}`; 
          selectEl.appendChild(option);
        });
        if (categories.find(c => c.id === currentValue)) {
            selectEl.value = currentValue;
        }
      }
    };
    populateSelect($('#incomeCategory'), state.categories.income);
    populateSelect($('#expenseCategory'), state.categories.expense);
    
    const editCategorySelect = $('#editCategory');
    if (editCategorySelect && state.currentTransaction) {
        const categories = state.currentTransaction.type === 'income' ? state.categories.income : state.categories.expense;
        populateSelect(editCategorySelect, categories);
        editCategorySelect.value = state.currentTransaction.category;
    }
  };

  const updatePaymentMethodSelects = () => {
    const selects = [$('#incomePaymentMethod'), $('#expensePaymentMethod'), $('#editPaymentMethod')];
    selects.forEach(selectEl => {
      if (selectEl) {
        const currentValue = selectEl.value;
        selectEl.innerHTML = '<option value="">Selecione...</option>';
        state.paymentMethods.forEach(method => {
          const option = document.createElement('option');
          option.value = method.id;
          option.textContent = `${method.icon || ''} ${method.name}`;
          selectEl.appendChild(option);
        });
         if (state.paymentMethods.find(m => m.id === currentValue)) {
            selectEl.value = currentValue;
        }
      }
    });
  };

  const updatePeopleSelects = () => {
    const selects = [$('#expensePerson'), $('#editPerson')];
    selects.forEach(selectEl => {
      if (selectEl) {
        const currentValue = selectEl.value;
        selectEl.innerHTML = '<option value="">Ninguém</option>'; 
        state.people.forEach(person => {
          const option = document.createElement('option');
          option.value = person.id;
          option.textContent = `${person.icon || ''} ${person.name}`;
          selectEl.appendChild(option);
        });
        if (state.people.find(p => p.id === currentValue)) {
            selectEl.value = currentValue;
        }
      }
    });
  };

  const updateInvestmentCategorySelects = () => {
    const selectEl = $('#investmentCategorySelect'); 
    if (selectEl) {
        const currentValue = selectEl.value;
        selectEl.innerHTML = '<option value="">Selecione...</option>';
        state.categories.investment.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = `${category.icon || ''} ${category.name}`;
            selectEl.appendChild(option);
        });
        if (state.categories.investment.find(c => c.id === currentValue)) {
            selectEl.value = currentValue;
        }
    }
  };


  const loadCards = async () => {
    try {
      const snapshot = await db.collection('cards').get();
      state.cards = snapshot.docs.map(doc => {
          const card = { id: doc.id, ...doc.data() };
          // currentInvoice no DB é o saldo devedor total do cartão.
          // availableLimit é calculado com base nisso.
          card.currentInvoice = card.currentInvoice || 0; 
          card.availableLimit = card.limit - card.currentInvoice;
          return card;
      });
      updateCardsList();
      updateCreditCardSelects();
    } catch (error) {
      console.error('Erro ao carregar cartões:', error);
      showToast('Erro ao carregar cartões.', 'error');
    }
  };

  const addCard = async (cardData) => {
    try {
      const card = {
        ...cardData,
        currentInvoice: 0, // Saldo devedor inicial é 0
        availableLimit: cardData.limit, 
        createdAt: localDateToISOString(new Date())
      };
      const docRef = await db.collection('cards').add(card);
      card.id = docRef.id;
      state.cards.push(card);
      await fullUIRefresh(); 
      showToast('Cartão adicionado!', 'success');
    } catch (error) {
      console.error('Erro ao adicionar cartão:', error);
      showToast('Erro ao adicionar cartão.', 'error');
    }
  };

  const updateCard = async (cardId, updates) => {
    try {
      if (updates.limit !== undefined) {
        const card = state.cards.find(c => c.id === cardId);
        if (card) {
            // currentInvoice (saldo devedor) não muda só porque o limite mudou.
            updates.availableLimit = updates.limit - (card.currentInvoice || 0);
        }
      }
      await db.collection('cards').doc(cardId).update(updates);
      const index = state.cards.findIndex(c => c.id === cardId);
      if (index !== -1) state.cards[index] = { ...state.cards[index], ...updates };
      await fullUIRefresh(); 
      showToast('Cartão atualizado!', 'success');
    } catch (error) {
      console.error('Erro ao atualizar cartão:', error);
      showToast('Erro ao atualizar cartão.', 'error');
    }
  };

  const deleteCard = async (cardId) => {
    try {
      if (!confirm('Tem certeza que deseja excluir este cartão? Transações associadas não serão alteradas, mas perderão o vínculo com este cartão.')) return;

      await db.collection('cards').doc(cardId).delete();
      state.cards = state.cards.filter(c => c.id !== cardId);
      // Desvincular transações
      const batch = db.batch();
      let changed = false;
      state.transactions.forEach(t => {
        if (t.creditCardId === cardId) {
            batch.update(db.collection('transactions').doc(t.id), { creditCardId: null, creditCardName: null });
            t.creditCardId = null; t.creditCardName = null;
            changed = true;
        }
      });
      if (changed) await batch.commit();

      await fullUIRefresh(); 
      showToast('Cartão excluído!', 'success');
    } catch (error) {
      console.error('Erro ao excluir cartão:', error);
      showToast('Erro ao excluir cartão.', 'error');
    }
  };

  const payCardInvoice = async (cardId) => {
    try {
      const card = state.cards.find(c => c.id === cardId);
      if (!card) return;

      const faturaVencimentoRef = new Date(Date.UTC(state.year, state.month, card.dueDay));
      const { previousClosing, currentClosingDate } = getInvoicePeriod(card, faturaVencimentoRef);

      const batch = db.batch();
      let totalFaturaPagaEsteMes = 0;

      state.transactions.forEach(t => {
        if (t.type === 'expense' && t.paymentMethod === 'credito' && t.creditCardId === cardId) {
          const dataCompra = parseLocalDateString(t.date);
          // A transação pertence a esta fatura se a data da COMPRA estiver no período correto.
          if (dataCompra >= previousClosing && dataCompra < currentClosingDate && t.status !== 'paid') {
            const docRef = db.collection('transactions').doc(t.id);
            batch.update(docRef, { status: 'paid' });
            t.status = 'paid'; 
            totalFaturaPagaEsteMes += parseFloat(t.amount);
          }
        }
      });
      
      // Atualizar o saldo devedor do cartão (currentInvoice no DB)
      // Esta é uma simplificação. O ideal seria recalcular o currentInvoice total do cartão
      // somando todas as despesas de cartão não pagas.
      // Por ora, vamos apenas subtrair o que foi pago desta fatura.
      if (totalFaturaPagaEsteMes > 0) {
        card.currentInvoice = Math.max(0, (card.currentInvoice || 0) - totalFaturaPagaEsteMes);
        card.availableLimit = card.limit - card.currentInvoice;
        batch.update(db.collection('cards').doc(card.id), {
            currentInvoice: card.currentInvoice,
            availableLimit: card.availableLimit
        });
      }
      
      await batch.commit();
      await fullUIRefresh(); 
      closeModal('payInvoiceConfirmModal');
      showToast('Fatura paga com sucesso!', 'success');
    } catch (error) {
      console.error('Erro ao pagar fatura:', error);
      showToast('Erro ao pagar fatura.', 'error');
    }
  };

  const updateCreditCardSelects = () => {
    const selects = [$('#expenseCreditCard'), $('#editCreditCard')];
    selects.forEach(selectEl => {
      if (selectEl) {
        const currentValue = selectEl.value;
        selectEl.innerHTML = '';
        if (state.cards.length === 0) {
          selectEl.innerHTML = '<option value="" disabled selected>Nenhum cartão</option>';
        } else {
          selectEl.innerHTML = '<option value="">Selecione o cartão...</option>';
          state.cards.forEach(card => {
            const option = document.createElement('option');
            option.value = card.id;
            option.textContent = `${card.name} (Disp: ${formatCurrency(card.availableLimit)})`;
            selectEl.appendChild(option);
          });
        }
        if (state.cards.find(c => c.id === currentValue)) {
            selectEl.value = currentValue;
        }
      }
    });
  };
  
  const loadInvestments = async () => {
    try {
      const [invSnapshot, contribSnapshot] = await Promise.all([
        db.collection('investments').get(),
        db.collection('investmentContributions').get()
      ]);
      state.investments = invSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      state.investmentContributions = contribSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderInvestmentCards();
    } catch (error) {
      console.error('Erro ao carregar investimentos:', error);
      showToast('Erro ao carregar investimentos.', 'error');
    }
  };

  const renderInvestmentCards = () => {
    const grid = $('#investmentsGrid');
    if (!grid) return;
    grid.innerHTML = '';
    if (state.investments.length === 0) {
      grid.innerHTML = '<p style="text-align: center; padding: var(--spacing-md);">Nenhum investimento.</p>';
      return;
    }
    state.investments.forEach(inv => {
      const contributions = state.investmentContributions.filter(c => c.investmentId === inv.id);
      const totalContributed = contributions.reduce((sum, c) => sum + parseFloat(c.amount), 0) + parseFloat(inv.amount || 0);
      const category = state.categories.investment.find(c => c.id === inv.category);
      const hasGoal = inv.goal && parseFloat(inv.goal) > 0;
      const progress = hasGoal ? Math.min(100, (totalContributed / parseFloat(inv.goal)) * 100) : 0;

      const cardEl = document.createElement('div');
      cardEl.className = 'investment-card card'; 
      cardEl.dataset.id = inv.id;
      cardEl.innerHTML = `
        <div class="investment-card-header">
          <h3 class="investment-card-title">${inv.name}</h3>
          <span class="badge" style="font-size: var(--font-size-xs);">${category ? `${category.icon} ${category.name}` : 'N/A'}</span>
        </div>
        <div class="investment-card-body">
          <div>Guardado: <strong>${formatCurrency(totalContributed)}</strong></div>
          ${hasGoal ? `<div>Meta: <strong>${formatCurrency(inv.goal)}</strong></div>` : ''}
          ${hasGoal ? `
            <div class="investment-progress">
              <div class="investment-progress-bar"><div class="investment-progress-fill" style="width: ${progress.toFixed(0)}%;"></div></div>
              <div class="investment-progress-text"><span>${progress.toFixed(0)}%</span> ${inv.targetDate ? `<span>Até: ${formatDate(inv.targetDate)}</span>` : ''}</div>
            </div>` : ''}
        </div>
        <div class="investment-card-footer">
          <small>Criado em: ${formatDate(inv.createdAt)}</small>
          <div>
            <button class="btn btn-icon btn-outline edit-investment-btn" aria-label="Editar"><svg width="16" height="16"><use href="#icon-edit"></use></svg></button>
            <button class="btn btn-icon btn-outline delete-investment-btn" aria-label="Excluir"><svg width="16" height="16"><use href="#icon-trash"></use></svg></button>
          </div>
        </div>`;
      cardEl.addEventListener('click', (e) => {
        if (!e.target.closest('.edit-investment-btn') && !e.target.closest('.delete-investment-btn')) {
          openInvestmentDetail(inv.id);
        }
      });
      grid.appendChild(cardEl);
    });
    $$('#investmentsGrid .edit-investment-btn').forEach(btn => btn.addEventListener('click', (e) => {
        e.stopPropagation(); openEditInvestmentModal(e.currentTarget.closest('.investment-card').dataset.id);
    }));
    $$('#investmentsGrid .delete-investment-btn').forEach(btn => btn.addEventListener('click', (e) => {
        e.stopPropagation(); if (confirm('Excluir este investimento e todos os aportes?')) deleteInvestment(e.currentTarget.closest('.investment-card').dataset.id);
    }));
  };
  
  const openInvestmentDetail = (investmentId) => {
    const investment = state.investments.find(i => i.id === investmentId);
    if (!investment) return;
    state.currentInvestment = investment;
    const contributions = state.investmentContributions.filter(c => c.investmentId === investment.id);
    const totalContributed = contributions.reduce((sum, c) => sum + parseFloat(c.amount), 0) + parseFloat(investment.amount || 0);
    const category = state.categories.investment.find(c => c.id === investment.category);
    const hasGoal = investment.goal && parseFloat(investment.goal) > 0;
    const progress = hasGoal ? Math.min(100, (totalContributed / parseFloat(investment.goal)) * 100) : 0;

    $('#investmentDetailName').textContent = investment.name;
    $('#investmentDetailSaved').textContent = formatCurrency(totalContributed);
    $('#investmentDetailGoal').textContent = hasGoal ? formatCurrency(investment.goal) : 'N/A';
    $('#investmentDetailProgress').textContent = hasGoal ? `${progress.toFixed(0)}%` : 'N/A';
    $('#investmentDetailCategory').textContent = category ? `${category.icon} ${category.name}` : 'N/A';
    $('#investmentDetailCreatedAt').textContent = formatDate(investment.createdAt);
    $('#investmentDetailTarget').textContent = investment.targetDate ? formatDate(investment.targetDate) : 'N/A';
    $('#investmentDetailNotes').textContent = investment.notes || '-';
    renderInvestmentContributions(investmentId);
    closeModal('investmentsModal');
    openModal('investmentDetailModal');
  };

  const renderInvestmentContributions = (investmentId) => {
    const tableBody = $('#investmentHistoryTableBody');
    if (!tableBody) return;
    tableBody.innerHTML = '';
    const investment = state.investments.find(i => i.id === investmentId);
    let allContributions = [];
    if (investment && parseFloat(investment.amount) > 0) {
        allContributions.push({ id: 'initial', date: investment.createdAt, amount: investment.amount, description: 'Depósito inicial', isInitial: true });
    }
    allContributions = allContributions.concat(state.investmentContributions.filter(c => c.investmentId === investmentId));
    allContributions.sort((a, b) => parseLocalDateString(b.date) - parseLocalDateString(a.date));

    if (allContributions.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhum aporte.</td></tr>';
      return;
    }
    allContributions.forEach(c => {
      const row = tableBody.insertRow();
      row.innerHTML = `
        <td>${formatDate(c.date)}</td>
        <td>${formatCurrency(c.amount)}</td>
        <td>${c.description || '-'}</td>
        <td class="actions-cell">
          ${c.isInitial ? '-' : `
            <button class="btn btn-icon btn-outline edit-contribution-btn" data-id="${c.id}" aria-label="Editar"><svg width="16" height="16"><use href="#icon-edit"></use></svg></button>
            <button class="btn btn-icon btn-outline delete-contribution-btn" data-id="${c.id}" aria-label="Excluir"><svg width="16" height="16"><use href="#icon-trash"></use></svg></button>
          `}
        </td>`;
    });
    $$('#investmentHistoryTableBody .edit-contribution-btn').forEach(btn => btn.addEventListener('click', (e) => openEditContributionModal(e.currentTarget.dataset.id)));
    $$('#investmentHistoryTableBody .delete-contribution-btn').forEach(btn => btn.addEventListener('click', (e) => { if (confirm('Excluir este aporte?')) deleteContribution(e.currentTarget.dataset.id); }));
  };

  const addInvestment = async (data) => {
    try {
      const investment = { ...data, createdAt: localDateToISOString(new Date()) };
      const docRef = await db.collection('investments').add(investment);
      investment.id = docRef.id;
      state.investments.push(investment);
      await fullUIRefresh(); 
      showToast('Investimento adicionado!', 'success');
      return investment;
    } catch (e) { console.error(e); showToast('Erro ao adicionar investimento.', 'error'); return null; }
  };
  const updateInvestment = async (id, data) => {
    try {
      await db.collection('investments').doc(id).update(data);
      const index = state.investments.findIndex(i => i.id === id);
      if (index !== -1) state.investments[index] = { ...state.investments[index], ...data };
      await fullUIRefresh(); 
      showToast('Investimento atualizado!', 'success'); return true;
    } catch (e) { console.error(e); showToast('Erro ao atualizar investimento.', 'error'); return false; }
  };
  const deleteInvestment = async (id) => {
    try {
      const batch = db.batch();
      batch.delete(db.collection('investments').doc(id));
      state.investmentContributions.filter(c => c.investmentId === id).forEach(c => batch.delete(db.collection('investmentContributions').doc(c.id)));
      await batch.commit();
      state.investments = state.investments.filter(i => i.id !== id);
      state.investmentContributions = state.investmentContributions.filter(c => c.investmentId !== id);
      await fullUIRefresh(); 
      if ($('#investmentDetailModal').classList.contains('active') && state.currentInvestment?.id === id) {
        closeModal('investmentDetailModal');
        openModal('investmentsModal');
      }
      showToast('Investimento excluído!', 'success');
    } catch (e) { console.error(e); showToast('Erro ao excluir investimento.', 'error'); }
  };
  const addContribution = async (data) => {
    try {
      const contribution = { ...data, createdAt: localDateToISOString(new Date()) };
      const docRef = await db.collection('investmentContributions').add(contribution);
      contribution.id = docRef.id;
      state.investmentContributions.push(contribution);
      await fullUIRefresh(); 
      if ($('#investmentDetailModal').classList.contains('active') && state.currentInvestment?.id === data.investmentId) {
        renderInvestmentContributions(data.investmentId); 
        openInvestmentDetail(data.investmentId); 
      }
      showToast('Aporte adicionado!', 'success'); return contribution;
    } catch (e) { console.error(e); showToast('Erro ao adicionar aporte.', 'error'); return null; }
  };
  const updateContribution = async (id, data) => {
    try {
      await db.collection('investmentContributions').doc(id).update(data);
      const index = state.investmentContributions.findIndex(c => c.id === id);
      if (index !== -1) state.investmentContributions[index] = { ...state.investmentContributions[index], ...data };
      await fullUIRefresh(); 
      if ($('#investmentDetailModal').classList.contains('active') && state.currentInvestment?.id === data.investmentId) {
        renderInvestmentContributions(data.investmentId);
        openInvestmentDetail(data.investmentId);
      }
      showToast('Aporte atualizado!', 'success'); return true;
    } catch (e) { console.error(e); showToast('Erro ao atualizar aporte.', 'error'); return false; }
  };
  const deleteContribution = async (id) => {
    try {
      const contribToDelete = state.investmentContributions.find(c => c.id === id);
      if (!contribToDelete) return;
      await db.collection('investmentContributions').doc(id).delete();
      state.investmentContributions = state.investmentContributions.filter(c => c.id !== id);
      await fullUIRefresh(); 
      if ($('#investmentDetailModal').classList.contains('active') && state.currentInvestment?.id === contribToDelete.investmentId) {
        renderInvestmentContributions(contribToDelete.investmentId);
        openInvestmentDetail(contribToDelete.investmentId);
      }
      showToast('Aporte excluído!', 'success');
    } catch (e) { console.error(e); showToast('Erro ao excluir aporte.', 'error'); }
  };

  const openNewInvestmentModal = () => {
    $('#investmentForm').reset();
    setDateInputValue('investmentTargetDate', new Date());
    $('#newInvestmentModalTitle').textContent = 'Novo Investimento';
    $('#saveInvestmentBtn').textContent = 'Salvar Investimento';
    $('#saveInvestmentBtn').dataset.action = 'add';
    $('#saveInvestmentBtn').removeAttribute('data-id');
    updateInvestmentCategorySelects(); 
    closeModal('investmentsModal'); 
    openModal('newInvestmentModal');
  };
  const openEditInvestmentModal = (id) => {
    const inv = state.investments.find(i => i.id === id);
    if (!inv) return;
    state.currentInvestment = inv;
    $('#investmentName').value = inv.name;
    $('#investmentAmount').value = inv.amount || 0;
    $('#investmentGoal').value = inv.goal || '';
    updateInvestmentCategorySelects(); 
    $('#investmentCategorySelect').value = inv.category || '';
    if (inv.targetDate) setDateInputValue('investmentTargetDate', inv.targetDate); else $('#investmentTargetDate').value = '';
    $('#investmentNotes').value = inv.notes || '';
    $('#newInvestmentModalTitle').textContent = 'Editar Investimento';
    $('#saveInvestmentBtn').textContent = 'Atualizar Investimento';
    $('#saveInvestmentBtn').dataset.action = 'update';
    $('#saveInvestmentBtn').dataset.id = id;
    closeModal('investmentDetailModal'); 
    openModal('newInvestmentModal');
  };
  const openNewContributionModal = () => {
    $('#contributionForm').reset();
    setDateInputValue('contributionDate', new Date());
    $('#contributionInvestmentId').value = state.currentInvestment?.id || '';
    $('#newContributionModalTitle').textContent = 'Adicionar Novo Valor';
    $('#saveContributionBtn').textContent = 'Adicionar';
    $('#saveContributionBtn').dataset.action = 'add';
    $('#saveContributionBtn').removeAttribute('data-id');
    openModal('newContributionModal');
  };
  const openEditContributionModal = (id) => {
    const contrib = state.investmentContributions.find(c => c.id === id);
    if (!contrib) return;
    state.currentContribution = contrib;
    $('#contributionInvestmentId').value = contrib.investmentId;
    $('#contributionAmount').value = contrib.amount;
    setDateInputValue('contributionDate', contrib.date);
    $('#contributionDescription').value = contrib.description || '';
    $('#newContributionModalTitle').textContent = 'Editar Aporte';
    $('#saveContributionBtn').textContent = 'Atualizar';
    $('#saveContributionBtn').dataset.action = 'update';
    $('#saveContributionBtn').dataset.id = id;
    openModal('newContributionModal');
  };

  const loadTransactions = async () => {
    try {
      const snapshot = await db.collection('transactions').get();
      state.transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      await fullUIRefresh(); 
    } catch (error) {
      console.error('Erro ao carregar transações:', error);
      showToast('Erro ao carregar transações.', 'error');
    }
  };

  /**
   * Calcula o período de compras para uma fatura de cartão.
   * @param {object} card - O objeto do cartão.
   * @param {Date} invoiceDueDateRef - A data em que a fatura VENCE.
   * @returns {{previousClosing: Date, currentClosingDate: Date}}
   */
  const getInvoicePeriod = (card, invoiceDueDateRef) => {
    const refDate = parseLocalDateString(invoiceDueDateRef);
    if (!refDate || !card) return { previousClosing: null, currentClosingDate: null };

    let closingDay = card.closingDay;
    let dueDay = card.dueDay;

    let currentClosingYear = refDate.getUTCFullYear();
    let currentClosingMonth = refDate.getUTCMonth(); // Mês de vencimento da fatura

    // Se o vencimento é no mesmo mês ou após o fechamento (ex: fecha 10, vence 20; ou fecha 25, vence 05 do mês seguinte)
    // O fechamento que compõe esta fatura ocorreu no mês ANTERIOR ao mês de vencimento.
    if (dueDay >= closingDay) {
        currentClosingMonth--;
        if (currentClosingMonth < 0) {
            currentClosingMonth = 11;
            currentClosingYear--;
        }
    }
    // Se o vencimento é antes do fechamento (no contexto do mesmo número de mês, ex: fecha 03, vence 10)
    // O fechamento que compõe esta fatura ocorreu no MESMO mês de vencimento.
    // (Nenhuma alteração em currentClosingMonth/Year aqui)

    const currentClosingDate = new Date(Date.UTC(currentClosingYear, currentClosingMonth, closingDay));
    
    let previousClosingMonth = currentClosingMonth - 1;
    let previousClosingYear = currentClosingYear;
    if (previousClosingMonth < 0) {
        previousClosingMonth = 11;
        previousClosingYear--;
    }
    const previousClosing = new Date(Date.UTC(previousClosingYear, previousClosingMonth, closingDay));
    
    return { previousClosing, currentClosingDate }; // currentClosingDate é o FIM do período de compras (exclusive)
  };


  const filterTransactionsByMonth = () => {
    state.filteredTransactions = state.transactions.filter(transaction => {
        const transactionLaunchDate = parseLocalDateString(transaction.date); 
        if (!transactionLaunchDate) return false;

        let effectiveDateForFilter = transactionLaunchDate;

        if (transaction.type === 'expense') { 
            if (transaction.paymentMethod === 'credito' && transaction.creditCardId) {
                const card = state.cards.find(c => c.id === transaction.creditCardId);
                if (card) {
                    const realDueDate = calcularVencimentoReal(transactionLaunchDate, card);
                    if (realDueDate) effectiveDateForFilter = realDueDate;
                }
            } else if (transaction.dueDate) { 
                const explicitDueDate = parseLocalDateString(transaction.dueDate);
                if (explicitDueDate) effectiveDateForFilter = explicitDueDate;
            }
        }
        
        return effectiveDateForFilter.getUTCMonth() === state.month && 
               effectiveDateForFilter.getUTCFullYear() === state.year;
    });
  };


  const updateMonthYearTitle = () => {
    // O título agora é implícito pelos selects de ano/mês
  };

  const updateKPIs = () => {
    const currentMonthTransactions = state.filteredTransactions; 

    const totalIncome = currentMonthTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + parseFloat(t.amount), 0);
    const totalExpense = currentMonthTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + parseFloat(t.amount), 0);
    const incomeReceived = currentMonthTransactions.filter(t => t.type === 'income' && t.status === 'received').reduce((sum, t) => sum + parseFloat(t.amount), 0);
    const incomePending = totalIncome - incomeReceived;
    const expensePaid = currentMonthTransactions.filter(t => t.type === 'expense' && t.status === 'paid').reduce((sum, t) => sum + parseFloat(t.amount), 0);
    const expensePending = totalExpense - expensePaid;
    
    const saldoReal = incomeReceived - expensePaid; 
    const saldoComprometido = totalIncome - totalExpense; 

    $('#incomeValue').textContent = formatCurrency(totalIncome);
    $('#expenseValue').textContent = formatCurrency(totalExpense);
    $('#balanceValue').textContent = formatCurrency(saldoReal);
    $('.kpi-balance .kpi-subtitle span').textContent = `Saldo comprometido: ${formatCurrency(saldoComprometido)}`;
    $('#incomeReceivedValue').textContent = `${formatCurrency(incomeReceived)} recebidos`;
    $('#incomePendingValue').textContent = `${formatCurrency(incomePending)} pendentes`;
    $('#expensePaidValue').textContent = `${formatCurrency(expensePaid)} pagos`;
    $('#expensePendingValue').textContent = `${formatCurrency(expensePending)} pendentes`;

    // KPI "Fatura do Mês"
    let monthlyInvoiceTotal = 0;
    let nextOverallDueDate = null; 
    
    state.cards.forEach(card => {
        const faturaVencimentoNoMesSelecionado = new Date(Date.UTC(state.year, state.month, card.dueDay));
        const { previousClosing, currentClosingDate } = getInvoicePeriod(card, faturaVencimentoNoMesSelecionado);

        if (previousClosing && currentClosingDate) {
            const invoiceTransactionsForThisCardAndMonth = state.transactions.filter(t => {
                const tLaunchDate = parseLocalDateString(t.date);
                return t.type === 'expense' &&
                       t.paymentMethod === 'credito' &&
                       t.creditCardId === card.id &&
                       tLaunchDate >= previousClosing &&
                       tLaunchDate < currentClosingDate;
            });
            
            monthlyInvoiceTotal += invoiceTransactionsForThisCardAndMonth.reduce((sum, t) => sum + parseFloat(t.amount), 0);
            
            if (!nextOverallDueDate || faturaVencimentoNoMesSelecionado < nextOverallDueDate) {
                nextOverallDueDate = faturaVencimentoNoMesSelecionado;
            }
        }
    });
    
    $('#invoiceValue').textContent = formatCurrency(monthlyInvoiceTotal);
    $('#invoiceDueDate').textContent = nextOverallDueDate ? formatDate(nextOverallDueDate) : '--/--/----';
  };

  const updateCardsList = () => {
    const listEl = $('#cardsList');
    if (!listEl) return;
    listEl.innerHTML = '';
    if (state.cards.length === 0) {
      listEl.innerHTML = '<p style="text-align: center;">Nenhum cartão cadastrado.</p>';
      return;
    }
    state.cards.forEach(card => {
        const cardEl = document.createElement('div');
        cardEl.className = 'card'; 
        cardEl.style.marginBottom = 'var(--spacing-md)';
        
        // Data de vencimento da fatura DESTE cartão NO MÊS/ANO SELECIONADO
        const faturaVencimentoNoMesSelecionado = new Date(Date.UTC(state.year, state.month, card.dueDay));
        const { previousClosing, currentClosingDate } = getInvoicePeriod(card, faturaVencimentoNoMesSelecionado);

        let currentInvoiceAmountForMonth = 0;
        if (previousClosing && currentClosingDate) {
            const currentInvoiceTransactions = state.transactions.filter(t => {
                const tLaunchDate = parseLocalDateString(t.date);
                return t.type === 'expense' &&
                       t.paymentMethod === 'credito' &&
                       t.creditCardId === card.id &&
                       tLaunchDate >= previousClosing &&
                       tLaunchDate < currentClosingDate;
            });
            currentInvoiceAmountForMonth = currentInvoiceTransactions.reduce((sum, t) => sum + parseFloat(t.amount), 0);
        }

        const limitPercentage = card.limit > 0 ? ((card.limit - card.availableLimit) / card.limit) * 100 : 0;
        const melhorDia = calcularMelhorDiaCompras(card);
        const nomeMesFatura = new Date(state.year, state.month).toLocaleDateString('pt-BR', {month: 'long'});


        cardEl.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-sm);">
                <h3>${card.name}</h3>
                <div>
                    <button class="btn btn-icon btn-outline edit-card-btn" data-id="${card.id}" aria-label="Editar"><svg width="16" height="16"><use href="#icon-edit"></use></svg></button>
                    <button class="btn btn-icon btn-outline delete-card-btn" data-id="${card.id}" aria-label="Excluir"><svg width="16" height="16"><use href="#icon-trash"></use></svg></button>
                </div>
            </div>
            <div>Limite: ${formatCurrency(card.limit)} | Disponível: ${formatCurrency(card.availableLimit)}</div>
            <div class="commitment-progress" style="margin: var(--spacing-xs) 0;">
                <div class="commitment-progress-bar" style="width: ${limitPercentage.toFixed(0)}%; background-color: ${limitPercentage > 80 ? 'var(--color-error)' : 'var(--color-primary)'};"></div>
            </div>
            <div><small>Sua Fatura fecha: dia ${card.closingDay} | Vencimento: dia ${card.dueDay}</small></div>
            <div><small>Fatura de ${nomeMesFatura}: ${formatCurrency(currentInvoiceAmountForMonth)}</small></div>
            ${melhorDia ? `<div><small style="color: var(--color-info);">Melhor dia p/ compra: dia ${melhorDia}</small></div>` : ''}
            <button class="btn btn-primary view-invoice-btn" data-id="${card.id}" style="margin-top: var(--spacing-sm);">Ver Fatura de ${new Date(state.year, state.month).toLocaleDateString('pt-BR', {month: 'short'})}</button>
        `;
        listEl.appendChild(cardEl);
    });
    $$('#cardsList .edit-card-btn').forEach(btn => btn.addEventListener('click', e => {
        const cardToEdit = state.cards.find(c => c.id === e.currentTarget.dataset.id);
        if(cardToEdit) openEditCardModal(cardToEdit);
    }));
    $$('#cardsList .delete-card-btn').forEach(btn => btn.addEventListener('click', e => deleteCard(e.currentTarget.dataset.id)));
    $$('#cardsList .view-invoice-btn').forEach(btn => btn.addEventListener('click', e => openCardInvoice(e.currentTarget.dataset.id)));
  };

  const openCardInvoice = (cardId) => {
    const card = state.cards.find(c => c.id === cardId);
    if (!card) return;
    state.currentCard = card;

    const faturaVencimentoNoMesSelecionado = new Date(Date.UTC(state.year, state.month, card.dueDay));
    const { previousClosing, currentClosingDate } = getInvoicePeriod(card, faturaVencimentoNoMesSelecionado);
    
    $('#cardInvoiceTitle').textContent = `Fatura ${card.name} - Venc. ${formatDate(faturaVencimentoNoMesSelecionado)}`;
    
    const endOfPurchasePeriod = new Date(currentClosingDate.getTime());
    endOfPurchasePeriod.setUTCDate(currentClosingDate.getUTCDate() -1);

    let currentInvoiceSum = 0;
    let invoiceTransactions = [];

    if (previousClosing && currentClosingDate) {
        invoiceTransactions = state.transactions.filter(t => {
            const tLaunchDate = parseLocalDateString(t.date);
            return t.type === 'expense' && 
                   t.paymentMethod === 'credito' && 
                   t.creditCardId === cardId &&
                   tLaunchDate >= previousClosing && 
                   tLaunchDate < currentClosingDate;
        }).sort((a,b) => parseLocalDateString(a.date) - parseLocalDateString(b.date));
        currentInvoiceSum = invoiceTransactions.reduce((sum, t) => sum + parseFloat(t.amount), 0);
    }
    
    $('#cardInvoiceDetails').innerHTML = `
        <p><strong>Período de Compras:</strong> ${formatDate(previousClosing)} - ${formatDate(endOfPurchasePeriod)}</p>
        <p><strong>Vencimento desta Fatura:</strong> ${formatDate(faturaVencimentoNoMesSelecionado)}</p>
        <p><strong>Limite Total:</strong> ${formatCurrency(card.limit)} | <strong>Disponível:</strong> ${formatCurrency(card.availableLimit)}</p>
        <p><strong>Valor desta Fatura:</strong> <span id="currentInvoiceValueDisplay">${formatCurrency(currentInvoiceSum)}</span></p>
    `;

    const tableBody = $('#cardInvoiceTableBody');
    tableBody.innerHTML = '';

    if (invoiceTransactions.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhuma despesa nesta fatura.</td></tr>';
    } else {
      invoiceTransactions.forEach(t => {
        const row = tableBody.insertRow();
        row.innerHTML = `
          <td>${t.name} ${t.isRecurrent && t.installments > 1 ? `(${t.installmentNumber}/${t.installments})` : ''}</td>
          <td>${formatDate(t.date)}</td>
          <td>${formatCurrency(t.amount)}</td>
          <td>
            <div class="checkbox-wrapper">
              <input type="checkbox" class="checkbox invoice-paid-checkbox" id="invoice-paid-${t.id}" 
                     data-id="${t.id}" ${t.status === 'paid' ? 'checked' : ''}>
              <label class="checkbox-label" for="invoice-paid-${t.id}"></label>
            </div>
          </td>`;
      });
      $$('.invoice-paid-checkbox').forEach(cb => cb.addEventListener('change', async (e) => {
          await updateTransactionStatus(e.target.dataset.id, e.target.checked ? 'paid' : 'pending');
          openCardInvoice(cardId); 
      }));
    }
    $('#invoiceConfirmAmount').textContent = formatCurrency(currentInvoiceSum); 

    closeModal('cardsListModal');
    openModal('cardInvoiceModal');
  };

  let categoryExpensesChart, cardUsageDonutChart, annualBarsChart, fixedVsVariableChart, personAnalysisChart;
  const createCharts = () => {
    const commonOptions = (isHorizontalBar = false) => ({ // Removido titleText, pois o título está no H3
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: isHorizontalBar ? 'y' : 'x',
        plugins: {
            title: { display: false }, 
            legend: { 
                display: true, 
                position: 'bottom', 
                labels: { padding: 15, usePointStyle: true, pointStyle: 'circle', boxWidth: 10, font: {size: 11} } 
            },
            tooltip: { 
                callbacks: { 
                    label: ctx => `${ctx.label}: ${formatCurrency(ctx.parsed.x || ctx.parsed.y || ctx.parsed)}` 
                } 
            }
        },
        scales: isHorizontalBar ? {
            x: { beginAtZero:true, ticks:{callback:v=>formatCurrency(v)}, grid: { drawOnChartArea: false } },
            y: { grid: { drawOnChartArea: true } } 
        } : {
            y: { beginAtZero:true, ticks:{callback:v=>formatCurrency(v)}, grid: { drawOnChartArea: true } },
            x: { grid: { drawOnChartArea: false } }
        },
        layout: { padding: { top: 5, bottom: 35, left: 5, right: 5 } } // Aumentado bottom para legenda
    });
    const pieDoughnutOptions = (isDoughnut = true) => ({ 
        ...commonOptions(false), 
        cutout: isDoughnut ? '60%' : '0%',
        plugins: { 
            title: { display: false },
            legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true, pointStyle: 'circle', boxWidth: 10, font: {size: 11} } },
            tooltip: { callbacks: { label: ctx => `${ctx.label}: ${formatCurrency(ctx.parsed)} (${(ctx.parsed / ctx.chart.getDatasetMeta(0).total * 100).toFixed(1)}%)` } }
        },
        layout: { padding: { top: 5, bottom: 35, left: 5, right: 5 } } // Aumentado bottom para legenda
    });

    if ($('#categoryExpensesChart')) categoryExpensesChart = new Chart($('#categoryExpensesChart').getContext('2d'), { type: 'bar', data: { labels:[], datasets:[{ data:[], label: 'Valor' }] }, options: commonOptions(false) }); // Bar vertical
    
    if ($('#cardUsageDonutChart')) {
        cardUsageDonutChart = new Chart($('#cardUsageDonutChart').getContext('2d'), { 
            type: 'doughnut', 
            data: { labels:['Utilizado', 'Disponível'], datasets:[{ data:[0,0] }] }, 
            options: pieDoughnutOptions(true)
        });
    }

    if ($('#fixedVsVariableChart')) fixedVsVariableChart = new Chart($('#fixedVsVariableChart').getContext('2d'), { type: 'pie', data: { labels:['Fixas', 'Variáveis'], datasets:[{ data:[] }] }, options: pieDoughnutOptions(false) });
    if ($('#personAnalysisChart')) personAnalysisChart = new Chart($('#personAnalysisChart').getContext('2d'), { type: 'bar', data: { labels:[], datasets:[{ data:[], label: 'Valor' }] }, options: commonOptions(true) }); // Bar horizontal
    if ($('#annualBars')) annualBarsChart = new Chart($('#annualBars').getContext('2d'), { type: 'bar', data: { labels:[], datasets:[{label:'Receitas', data:[]}, {label:'Despesas', data:[]}] }, options: {...commonOptions(false), plugins: { ...commonOptions(false).plugins, legend: {display: true} } }});
    
    updateChartColors(); 
  };

  const updateCharts = () => {
    if (!categoryExpensesChart) createCharts(); 
    const currentMonthTransactions = state.filteredTransactions;

    const expenseCategories = currentMonthTransactions.filter(t => t.type === 'expense').reduce((acc, t) => {
      const catName = state.categories.expense.find(c => c.id === t.category)?.name || t.categoryName || 'Outros';
      acc[catName] = (acc[catName] || 0) + parseFloat(t.amount);
      return acc;
    }, {});
    categoryExpensesChart.data.labels = Object.keys(expenseCategories);
    categoryExpensesChart.data.datasets[0].data = Object.values(expenseCategories);
    categoryExpensesChart.options.plugins.legend.display = Object.keys(expenseCategories).length > 0; 
    categoryExpensesChart.update();

    const totalLimitAllCards = state.cards.reduce((sum, c) => sum + parseFloat(c.limit || 0), 0);
    // availableLimit já é calculado em loadCards e updateCard
    const totalAvailableAllCards = state.cards.reduce((sum, c) => sum + parseFloat(c.availableLimit || 0), 0);
    const totalUsedAllCards = totalLimitAllCards - totalAvailableAllCards;

    if (cardUsageDonutChart) { 
        if (totalLimitAllCards > 0) {
            cardUsageDonutChart.data.labels = ['Utilizado', 'Disponível'];
            cardUsageDonutChart.data.datasets[0].data = [totalUsedAllCards, totalAvailableAllCards];
        } else {
            cardUsageDonutChart.data.labels = ['Nenhum Limite'];
            cardUsageDonutChart.data.datasets[0].data = [1]; 
        }
        cardUsageDonutChart.options.plugins.legend.display = totalLimitAllCards > 0;
        cardUsageDonutChart.update();
    }

    const fixed = currentMonthTransactions.filter(t=>t.type==='expense' && t.isFixed==='fixed').reduce((s,t)=>s+parseFloat(t.amount),0);
    const variable = currentMonthTransactions.filter(t=>t.type==='expense' && t.isFixed==='variable').reduce((s,t)=>s+parseFloat(t.amount),0);
    fixedVsVariableChart.data.datasets[0].data = [fixed, variable];
    fixedVsVariableChart.options.plugins.legend.display = (fixed > 0 || variable > 0);
    fixedVsVariableChart.update();

    const personExpenses = currentMonthTransactions.filter(t => t.type === 'expense' && t.person).reduce((acc, t) => { 
      const personName = state.people.find(p => p.id === t.person)?.name || 'Não atribuído';
      acc[personName] = (acc[personName] || 0) + parseFloat(t.amount);
      return acc;
    }, {});
    personAnalysisChart.data.labels = Object.keys(personExpenses);
    personAnalysisChart.data.datasets[0].data = Object.values(personExpenses);
    personAnalysisChart.options.plugins.legend.display = Object.keys(personExpenses).length > 0;
    personAnalysisChart.update();
    
    const annualData = Array(12).fill(null).map(() => ({ income: 0, expense: 0 }));
    const todayForAnnual = new Date(Date.UTC(state.year, state.month, 1)); 
    state.transactions.forEach(t => {
        const tLaunchDate = parseLocalDateString(t.date);
        if (!tLaunchDate) return;

        let effectiveDateForAnnualChart = tLaunchDate; 

        if (t.type === 'expense') {
            if (t.paymentMethod === 'credito' && t.creditCardId) {
                const card = state.cards.find(c => c.id === t.creditCardId);
                if (card) {
                    const realDueDate = calcularVencimentoReal(tLaunchDate, card);
                    if (realDueDate) effectiveDateForAnnualChart = realDueDate;
                }
            } else if (t.dueDate) {
                const explicitDueDate = parseLocalDateString(t.dueDate);
                if (explicitDueDate) effectiveDateForAnnualChart = explicitDueDate;
            }
        }
        
        const monthDiff = (todayForAnnual.getUTCFullYear() - effectiveDateForAnnualChart.getUTCFullYear()) * 12 + (todayForAnnual.getUTCMonth() - effectiveDateForAnnualChart.getUTCMonth());
        
        if (monthDiff >= 0 && monthDiff < 12) { 
            const indexInAnnualArray = 11 - monthDiff; 
            if (t.type === 'income') annualData[indexInAnnualArray].income += parseFloat(t.amount);
            else if (t.type === 'expense') annualData[indexInAnnualArray].expense += parseFloat(t.amount);
        }
    });

    annualBarsChart.data.labels = Array(12).fill(null).map((_, i) => {
        const d = new Date(todayForAnnual);
        d.setUTCMonth(todayForAnnual.getUTCMonth() - (11 - i)); 
        return d.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit', timeZone: 'UTC' });
    });
    annualBarsChart.data.datasets[0].data = annualData.map(d => d.income);
    annualBarsChart.data.datasets[1].data = annualData.map(d => d.expense);
    annualBarsChart.update();
    updateChartColors(); 
  };

  const toggleCommitments = () => {
    const content = $('#commitmentsContent');
    const icon = $('#commitmentToggleIcon use');
    if (!content || !icon) return;
    if (content.style.maxHeight && content.style.maxHeight !== '0px') {
      content.style.maxHeight = '0px';
      icon.setAttribute('href', '#icon-chevron-down');
    } else {
      content.style.maxHeight = content.scrollHeight + 'px';
      icon.setAttribute('href', '#icon-chevron-up');
    }
  };

  const generateInsights = () => {
    const container = $('#insightsBannerContainer');
    if (!container) return;
    container.innerHTML = '';
    state.insights = [];
    const today = new Date(); today.setUTCHours(0,0,0,0); 

    const overdue = state.transactions.filter(t => {
        if (t.type !== 'expense' || t.status === 'paid') return false;
        
        let effectiveDueDate = null;
        if (t.paymentMethod === 'credito' && t.creditCardId) {
            const card = state.cards.find(c => c.id === t.creditCardId);
            const launchDate = parseLocalDateString(t.date);
            if (card && launchDate) effectiveDueDate = calcularVencimentoReal(launchDate, card);
        } else if (t.dueDate) {
            effectiveDueDate = parseLocalDateString(t.dueDate);
        }
        
        if (!effectiveDueDate) return false;
        
        return effectiveDueDate < today;
    });

    if (overdue.length > 0) {
      state.insights.push({ id: 'overdue', level: 'danger', icon: 'icon-alert', message: `Você tem ${overdue.length} conta(s) vencida(s).`, actionText: 'Ver Detalhes', action: () => openDueTransactionsModal(overdue, 'Contas Vencidas', 'danger') });
    }

    const upcomingDateLimit = new Date(today); upcomingDateLimit.setUTCDate(today.getUTCDate() + 5);
    const upcoming = state.transactions.filter(t => {
        if (t.type !== 'expense' || t.status === 'paid') return false;
        
        let effectiveDueDate = null;
        if (t.paymentMethod === 'credito' && t.creditCardId) {
            const card = state.cards.find(c => c.id === t.creditCardId);
            const launchDate = parseLocalDateString(t.date);
            if (card && launchDate) effectiveDueDate = calcularVencimentoReal(launchDate, card);
        } else if (t.dueDate) {
            effectiveDueDate = parseLocalDateString(t.dueDate);
        }
        if (!effectiveDueDate) return false;

        return effectiveDueDate >= today && effectiveDueDate <= upcomingDateLimit;
    });
    if (upcoming.length > 0) {
      state.insights.push({ id: 'upcoming', level: 'warning', icon: 'icon-calendar', message: `Você tem ${upcoming.length} conta(s) a vencer nos próximos 5 dias.`, actionText: 'Ver Detalhes', action: () => openDueTransactionsModal(upcoming, 'Contas a Vencer', 'warning') }); 
    }
    
    state.cards.filter(c => c.availableLimit < (c.limit * 0.2)).forEach(c => {
        state.insights.push({ id: `low-limit-${c.id}`, level: 'warning', icon: 'icon-credit-card', message: `Limite baixo no cartão ${c.name}.`, actionText: 'Ver Cartão', action: () => { closeModal('insightsBannerContainer'); openModal('cardsListModal'); openCardInvoice(c.id); } });
    });

    state.insights.forEach(insight => {
      const el = document.createElement('div');
      el.className = `insight-banner insight-${insight.level}`;
      el.innerHTML = `<div class="insight-icon"><svg width="24" height="24"><use href="#${insight.icon}"></use></svg></div><div class="insight-content"><div class="insight-title">${insight.message}</div></div><button class="btn btn-outline insight-action" data-id="${insight.id}">${insight.actionText}</button>`;
      container.appendChild(el);
    });
    $$('.insight-action').forEach(btn => btn.addEventListener('click', e => {
      const insight = state.insights.find(i => i.id === e.currentTarget.dataset.id);
      if (insight && insight.action) insight.action();
    }));
  };
  
  const openDueTransactionsModal = (transactions, title, type) => {
    $('#dueTransactionsModalTitleText').textContent = title;
    const iconEl = $('#dueTransactionsModalIcon use');
    iconEl.setAttribute('href', type === 'danger' ? '#icon-alert' : '#icon-calendar');
    
    const tableBody = $('#dueTransactionsTableBody');
    tableBody.innerHTML = '';
    if (transactions.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Nenhuma conta encontrada.</td></tr>`;
    } else {
      transactions.sort((a,b) => {
        let dueDateA_effective = null;
        if (a.paymentMethod === 'credito' && a.creditCardId) {
            const cardA = state.cards.find(c=>c.id===a.creditCardId);
            if(cardA) dueDateA_effective = calcularVencimentoReal(parseLocalDateString(a.date), cardA);
        } else if (a.dueDate) {
            dueDateA_effective = parseLocalDateString(a.dueDate);
        }

        let dueDateB_effective = null;
        if (b.paymentMethod === 'credito' && b.creditCardId) {
            const cardB = state.cards.find(c=>c.id===b.creditCardId);
            if(cardB) dueDateB_effective = calcularVencimentoReal(parseLocalDateString(b.date), cardB);
        } else if (b.dueDate) {
            dueDateB_effective = parseLocalDateString(b.dueDate);
        }
        
        if (!dueDateA_effective && !dueDateB_effective) return 0;
        if (!dueDateA_effective) return 1;
        if (!dueDateB_effective) return -1;
        return dueDateA_effective - dueDateB_effective;

      }).forEach(t => {
        const cat = state.categories.expense.find(c => c.id === t.category);
        let effectiveDueDateForDisplay = null;
        if (t.paymentMethod === 'credito' && t.creditCardId) {
            const card = state.cards.find(c=>c.id===t.creditCardId);
            const launchDate = parseLocalDateString(t.date);
            if(card && launchDate) effectiveDueDateForDisplay = calcularVencimentoReal(launchDate, card);
        } else if (t.dueDate) {
            effectiveDueDateForDisplay = parseLocalDateString(t.dueDate);
        }

        const row = tableBody.insertRow();
        row.innerHTML = `
          <td>${t.name}</td>
          <td>${cat ? `${cat.icon} ${cat.name}` : (t.categoryName || t.category)}</td>
          <td>${effectiveDueDateForDisplay ? formatDate(effectiveDueDateForDisplay) : formatDate(t.date)}</td>
          <td>${formatCurrency(t.amount)}</td>
          <td class="actions-cell">
            <button class="btn btn-success btn-sm mark-paid-due-btn" data-id="${t.id}">Pagar</button>
            <button class="btn btn-outline btn-sm edit-due-btn" data-id="${t.id}">Editar</button>
          </td>`;
      });
      $$('.mark-paid-due-btn').forEach(btn => btn.addEventListener('click', async e => {
          await updateTransactionStatus(e.target.dataset.id, 'paid');
          const remaining = transactions.filter(tr => tr.id !== e.target.dataset.id && tr.status !== 'paid'); // Atualiza a lista de restantes
          if (remaining.length > 0) openDueTransactionsModal(remaining, title, type);
          else closeModal('dueTransactionsModal');
          generateInsights(); 
      }));
      $$('.edit-due-btn').forEach(btn => btn.addEventListener('click', e => {
          const transaction = state.transactions.find(t => t.id === e.target.dataset.id);
          if (transaction) {
              closeModal('dueTransactionsModal');
              openEditModal(transaction);
          }
      }));
    }
    $('#payAllDueBtn').style.display = type === 'danger' && transactions.length > 0 ? 'inline-flex' : 'none';
    openModal('dueTransactionsModal');
  };


  const renderCommitments = () => {
    const content = $('#commitmentsContent');
    if (!content) return;
    content.innerHTML = '';
    const recurrent = state.transactions.filter(t => t.isRecurrent && t.installments && t.installmentNumber && t.installments > t.installmentNumber);
    if (recurrent.length === 0) {
      content.innerHTML = '<p style="text-align: center;">Nenhum compromisso longo.</p>';
      return;
    }
    const grouped = recurrent.reduce((acc, t) => {
        const key = t.recurrenceId || t.id; 
        if (!acc[key] || acc[key].installmentNumber > t.installmentNumber) { 
            acc[key] = t;
        }
        return acc;
    }, {});

    Object.values(grouped).sort((a,b) => (a.installmentNumber/a.installments) - (b.installmentNumber/b.installments)).forEach(c => {
      const progress = (c.installmentNumber / c.installments) * 100;
      const cat = c.type === 'income' ? state.categories.income.find(cat=>cat.id===c.category) : state.categories.expense.find(cat=>cat.id===c.category);
      const item = document.createElement('div');
      item.className = 'commitment-item';
      item.innerHTML = `
        <div class="transaction-icon" style="background-color: ${c.type==='income'?'var(--color-income)':'var(--color-expense)'}20; color: ${c.type==='income'?'var(--color-income)':'var(--color-expense)'};">
          ${cat?.icon || (c.type === 'income' ? '💰' : '📦')}
        </div>
        <div style="flex: 1;">
          <div style="display: flex; justify-content: space-between;"><span>${c.name}</span> <span>${formatCurrency(c.amount)}</span></div>
          <div style="display: flex; justify-content: space-between; font-size: var(--font-size-xs); color: var(--color-on-surface-variant);">
            <span>${cat?.name || c.categoryName || c.category}</span>
            <span>${c.installmentNumber}/${c.installments}</span>
          </div>
          <div class="commitment-progress"><div class="commitment-progress-bar" style="width:${progress}%; background-color:${c.type==='income'?'var(--color-income)':'var(--color-expense)'};"></div></div>
        </div>`;
      content.appendChild(item);
    });
    if (content.style.maxHeight && content.style.maxHeight !== '0px') {
        content.style.maxHeight = content.scrollHeight + 'px';
    }
  };

  const createTransactionFilters = () => {
    const container = $('#transaction-filters');
    if (!container) return;
    container.innerHTML = ''; 

    const typeSelect = document.createElement('div');
    typeSelect.className = 'select-wrapper';
    typeSelect.innerHTML = `
      <select id="filter-transaction-type" class="select">
        <option value="">Todos os Tipos</option>
        <option value="income">Receitas</option>
        <option value="expense">Despesas</option>
      </select>
      <svg class="select-icon" width="16" height="16"><use href="#icon-chevron-down"></use></svg>`;
    container.appendChild(typeSelect);
    $('#filter-transaction-type').addEventListener('change', e => { state.filters.transactionType = e.target.value; updateTransactionsTable(); });
    
    const commonFilters = [
        { id: 'filter-category', label: 'Todas as categorias', options: [...state.categories.income, ...state.categories.expense].map(c => ({value: c.id, text: `${c.icon||''} ${c.name}`})) },
        { id: 'filter-status', label: 'Todos os status', options: [{value:'paid',text:'Pago'},{value:'pending',text:'Pendente'},{value:'scheduled',text:'Agendado'},{value:'received',text:'Recebido'}] },
        { id: 'filter-payment-method', label: 'Todos os pagamentos', options: state.paymentMethods.map(p => ({value: p.id, text: `${p.icon||''} ${p.name}`})) },
        { id: 'filter-person', label: 'Todas as pessoas', options: state.people.map(p => ({value: p.id, text: `${p.icon||''} ${p.name}`})) },
    ];
    commonFilters.forEach(f => {
        const selWrap = document.createElement('div');
        selWrap.className = 'select-wrapper';
        let optionsHTML = `<option value="">${f.label}</option>`;
        f.options.forEach(opt => optionsHTML += `<option value="${opt.value}">${opt.text}</option>`);
        selWrap.innerHTML = `<select id="${f.id}" class="select">${optionsHTML}</select><svg class="select-icon" width="16" height="16"><use href="#icon-chevron-down"></use></svg>`;
        container.appendChild(selWrap);
        $(`#${f.id}`).addEventListener('change', e => { state.filters[f.id.split('-')[1]] = e.target.value; updateTransactionsTable(); });
    });
  };

  const setupSortableColumns = () => {
    $$('#transactionsTable th.sortable').forEach(header => {
      header.addEventListener('click', () => {
        const column = header.dataset.sort;
        if (state.sortColumn === column) {
          state.sortDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          state.sortColumn = column;
          if (column === 'date' || column === 'dueDate') {
            state.sortDirection = 'asc'; 
          } else if (column === 'amount') {
            state.sortDirection = 'desc'; 
          } else {
            state.sortDirection = 'asc'; 
          }
        }
        $$('#transactionsTable th.sortable').forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));
        header.classList.add(`sorted-${state.sortDirection}`);
        updateTransactionsTable();
      });
    });
  };

  const getEffectiveDueDateForSort = (transaction) => {
    let effectiveDate = parseLocalDateString(transaction.date); 

    if (transaction.type === 'expense') {
        if (transaction.paymentMethod === 'credito' && transaction.creditCardId) {
            const card = state.cards.find(c => c.id === transaction.creditCardId);
            if (card) {
                const realCardDueDate = calcularVencimentoReal(parseLocalDateString(transaction.date), card);
                if (realCardDueDate) effectiveDate = realCardDueDate;
            }
        } else if (transaction.dueDate) {
            const explicitDueDate = parseLocalDateString(transaction.dueDate);
            if (explicitDueDate) effectiveDate = explicitDueDate;
        }
    }
    return effectiveDate;
  };


  const updateTransactionsTable = () => {
    const tableBody = $('#transactionsTableBody');
    if (!tableBody) return;
    if (!$('#filter-transaction-type')) createTransactionFilters(); 
    if (!$('#transactionsTable th.sortable').classList.contains('has-listener')) { 
        setupSortableColumns();
        $$('#transactionsTable th.sortable').forEach(h => h.classList.add('has-listener'));
    }

    let transactionsToDisplay = [...state.filteredTransactions]; 
    if (state.filters.transactionType) transactionsToDisplay = transactionsToDisplay.filter(t => t.type === state.filters.transactionType);
    if (state.filters.category) transactionsToDisplay = transactionsToDisplay.filter(t => t.category === state.filters.category);
    if (state.filters.status) transactionsToDisplay = transactionsToDisplay.filter(t => t.status === state.filters.status);
    if (state.filters.paymentMethod) transactionsToDisplay = transactionsToDisplay.filter(t => t.paymentMethod === state.filters.paymentMethod);
    if (state.filters.person) transactionsToDisplay = transactionsToDisplay.filter(t => t.person === state.filters.person);

    transactionsToDisplay.sort((a, b) => {
      let valA, valB;
      
      switch(state.sortColumn) {
        case 'name': valA = a.name.toLowerCase(); valB = b.name.toLowerCase(); break;
        case 'person': 
            valA = (state.people.find(p=>p.id===a.person)?.name || '').toLowerCase(); 
            valB = (state.people.find(p=>p.id===b.person)?.name || '').toLowerCase(); 
            break;
        case 'date': 
            valA = parseLocalDateString(a.date); 
            valB = parseLocalDateString(b.date); 
            break; 
        case 'dueDate': 
            valA = getEffectiveDueDateForSort(a);
            valB = getEffectiveDueDateForSort(b);
            if (valA === null && valB !== null) return state.sortDirection === 'asc' ? 1 : -1; 
            if (valA !== null && valB === null) return state.sortDirection === 'asc' ? -1 : 1; 
            if (valA === null && valB === null) return 0;
            break;
        case 'amount': valA = parseFloat(a.amount); valB = parseFloat(b.amount); break;
        case 'status': valA = a.status; valB = b.status; break;
        case 'paymentMethod': 
            valA = (state.paymentMethods.find(p=>p.id===a.paymentMethod)?.name || '').toLowerCase(); 
            valB = (state.paymentMethods.find(p=>p.id===b.paymentMethod)?.name || '').toLowerCase(); 
            break;
        default: 
            valA = getEffectiveDueDateForSort(a); 
            valB = getEffectiveDueDateForSort(b);
      }
      const comparison = valA < valB ? -1 : (valA > valB ? 1 : 0);
      return state.sortDirection === 'desc' ? -comparison : comparison;
    });

    tableBody.innerHTML = '';
    if (transactionsToDisplay.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="9" style="text-align:center; padding: var(--spacing-lg);">Nenhuma transação para este mês/filtros.</td></tr>`;
      return;
    }
    transactionsToDisplay.forEach(t => {
      const row = tableBody.insertRow();
      const cat = t.type === 'income' ? state.categories.income.find(c=>c.id===t.category) : state.categories.expense.find(c=>c.id===t.category);
      const person = state.people.find(p=>p.id===t.person);
      const payment = state.paymentMethods.find(p=>p.id===t.paymentMethod);
      
      let statusText = t.status;
      let statusClass = 'badge-info';
      if (t.type === 'income') {
          if (t.status === 'received') { statusText = 'Recebido'; statusClass = 'badge-success'; }
          else { statusText = 'A Receber'; statusClass = 'badge-warning'; }
      } else { 
          if (t.status === 'paid') { statusText = 'Pago'; statusClass = 'badge-success'; }
          else if (t.status === 'scheduled') { statusText = 'Agendado'; statusClass = 'badge-info'; }
          else { statusText = 'Pendente'; statusClass = 'badge-warning'; }
      }
      
      const effectiveDueDateForDisplay = getEffectiveDueDateForSort(t);
      
      row.innerHTML = `
        <td class="transaction-name-cell">
            <div class="transaction-icon" style="background-color: ${t.type==='income'?'var(--color-income)':'var(--color-expense)'}20; color: ${t.type==='income'?'var(--color-income)':'var(--color-expense)'};">
              ${cat?.icon || (t.type === 'income' ? '💰' : '📦')}
            </div>
            ${t.name} ${t.isRecurrent && t.installments > 1 ? `(${t.installmentNumber}/${t.installments})` : ''}
        </td>
        <td>${person ? `${person.icon||''} ${person.name}` : '-'}</td>
        <td>${formatDate(t.date)}</td> <!-- Data de lançamento -->
        <td>${effectiveDueDateForDisplay ? formatDate(effectiveDueDateForDisplay) : '-'}</td> <!-- Vencimento efetivo -->
        <td>${formatCurrency(t.amount)}</td>
        <td><span class="badge ${statusClass}">${statusText}</span></td>
        <td>${payment ? `${payment.icon||''} ${payment.name}` : (t.paymentMethodName || t.paymentMethod || '-')}</td>
        <td>
          <div class="checkbox-wrapper">
            <input type="checkbox" class="checkbox transaction-paid-checkbox" id="paid-${t.id}" 
                   data-id="${t.id}" data-type="${t.type}" 
                   ${t.status === (t.type === 'income' ? 'received' : 'paid') ? 'checked' : ''}>
            <label class="checkbox-label" for="paid-${t.id}"></label>
          </div>
        </td>
        <td class="actions-cell">
          <button class="btn btn-icon btn-outline edit-transaction-btn" data-id="${t.id}" aria-label="Editar"><svg width="16" height="16"><use href="#icon-edit"></use></svg></button>
          <button class="btn btn-icon btn-outline delete-transaction-btn" data-id="${t.id}" aria-label="Excluir"><svg width="16" height="16"><use href="#icon-trash"></use></svg></button>
        </td>`;
    });
    $$('.transaction-paid-checkbox').forEach(cb => cb.addEventListener('change', e => updateTransactionStatus(e.target.dataset.id, e.target.checked ? (e.target.dataset.type === 'income' ? 'received' : 'paid') : 'pending')));
    $$('.edit-transaction-btn').forEach(btn => btn.addEventListener('click', e => openEditModal(state.transactions.find(t => t.id === e.currentTarget.dataset.id))));
    $$('.delete-transaction-btn').forEach(btn => btn.addEventListener('click', e => openDeleteConfirmModal(state.transactions.find(t => t.id === e.currentTarget.dataset.id))));
  };

  const updateTransactionStatus = async (id, status) => {
    try {
      const transaction = state.transactions.find(t => t.id === id);
      if (!transaction) return;
      
      const oldStatus = transaction.status;
      transaction.status = status; 
      
      await db.collection('transactions').doc(id).update({ status });

      // Se for uma despesa de cartão que está sendo marcada como paga/não paga,
      // precisamos ajustar o currentInvoice (saldo devedor) do cartão.
      if (transaction.type === 'expense' && transaction.paymentMethod === 'credito' && transaction.creditCardId) {
        const card = state.cards.find(c => c.id === transaction.creditCardId);
        if (card) {
            let amountChange = 0;
            if (status === 'paid' && oldStatus !== 'paid') { // Marcou como pago
                amountChange = -parseFloat(transaction.amount);
            } else if (status !== 'paid' && oldStatus === 'paid') { // Desmarcou como pago
                amountChange = parseFloat(transaction.amount);
            }

            if (amountChange !== 0) {
                card.currentInvoice = Math.max(0, (card.currentInvoice || 0) + amountChange);
                card.availableLimit = card.limit - card.currentInvoice;
                await db.collection('cards').doc(card.id).update({
                    currentInvoice: card.currentInvoice,
                    availableLimit: card.availableLimit
                });
            }
        }
      }
      await fullUIRefresh(); 
      showToast('Status da transação atualizado!', 'success');
    } catch (error) {
      console.error('Erro ao atualizar status:', error);
      showToast('Erro ao atualizar status.', 'error');
    }
  };

  const addTransaction = async (transactionData) => {
    try {
      const transaction = { ...transactionData, createdAt: localDateToISOString(new Date()) };
      const catList = transaction.type === 'income' ? state.categories.income : state.categories.expense;
      const category = catList.find(c => c.id === transaction.category);
      if (category) { transaction.categoryName = category.name; transaction.categoryIcon = category.icon; }
      
      const payment = state.paymentMethods.find(p => p.id === transaction.paymentMethod);
      if (payment) { transaction.paymentMethodName = payment.name; transaction.paymentMethodIcon = payment.icon; }

      if (transaction.person) {
          const personObj = state.people.find(p => p.id === transaction.person);
          if (personObj) { transaction.personName = personObj.name; transaction.personIcon = personObj.icon; }
      }

      // Se for uma despesa de cartão NÃO recorrente, impacta o limite.
      // Se for recorrente, o addRecurrentTransactions cuidará do impacto total.
      if (transaction.type === 'expense' && transaction.paymentMethod === 'credito' && transaction.creditCardId && !transaction.isRecurrent) {
        await updateCardLimits(transaction.creditCardId, parseFloat(transaction.amount), 'add');
        const card = state.cards.find(c => c.id === transaction.creditCardId);
        if (card) transaction.creditCardName = card.name;
      }

      const docRef = await db.collection('transactions').add(transaction);
      transaction.id = docRef.id;
      state.transactions.push(transaction);
      await fullUIRefresh(); 
      showToast(`${transaction.type === 'income' ? 'Receita' : 'Despesa'} adicionada!`, 'success');
      return transaction;
    } catch (e) { console.error(e); showToast('Erro ao adicionar transação.', 'error'); return null; }
  };

  const addRecurrentTransactions = async (baseTransaction, installments) => {
    try {
      const recurrenceId = generateId();
      const batch = db.batch();
      const transactionsToAdd = [];
      // Para compras parceladas no cartão, o valor da parcela é o que entra na fatura.
      // O impacto no limite é pelo valor total.
      const installmentAmount = parseFloat(baseTransaction.amount) / installments; 
      const totalPurchaseAmount = parseFloat(baseTransaction.amount);


      for (let i = 0; i < installments; i++) {
        const currentInstallmentLaunchDate = parseLocalDateString(baseTransaction.date);
        currentInstallmentLaunchDate.setUTCMonth(currentInstallmentLaunchDate.getUTCMonth() + i);
        
        let currentEffectiveDueDate = null;
        if (baseTransaction.paymentMethod === 'credito' && baseTransaction.creditCardId) {
            const card = state.cards.find(c => c.id === baseTransaction.creditCardId);
            if (card) {
                // O vencimento de cada parcela é calculado com base na data de LANÇAMENTO da parcela.
                currentEffectiveDueDate = calcularVencimentoReal(currentInstallmentLaunchDate, card);
            }
        } else if (baseTransaction.dueDate) { 
            currentEffectiveDueDate = parseLocalDateString(baseTransaction.dueDate);
            currentEffectiveDueDate.setUTCMonth(currentEffectiveDueDate.getUTCMonth() + i);
        }


        const installment = { 
          ...baseTransaction, 
          amount: installmentAmount, 
          date: localDateToISOString(currentInstallmentLaunchDate), 
          dueDate: currentEffectiveDueDate ? localDateToISOString(currentEffectiveDueDate) : null, 
          recurrenceId, 
          installmentNumber: i + 1, 
          installments,
          isRecurrent: true 
        };
        delete installment.id; 

        const docRef = db.collection('transactions').doc(); 
        batch.set(docRef, installment);
        installment.id = docRef.id; 
        transactionsToAdd.push(installment);
      }
      
      // Para cartão, o limite é impactado pelo valor TOTAL da compra.
      if (baseTransaction.type === 'expense' && baseTransaction.paymentMethod === 'credito' && baseTransaction.creditCardId) {
          await updateCardLimits(baseTransaction.creditCardId, totalPurchaseAmount, 'add'); 
      }

      await batch.commit();
      state.transactions.push(...transactionsToAdd);
      await fullUIRefresh(); 
      showToast('Transação parcelada adicionada!', 'success');
      return transactionsToAdd;
    } catch (e) { console.error(e); showToast('Erro ao adicionar parcelas.', 'error'); return null; }
  };

  const updateTransaction = async (id, updates) => {
    try {
      const transaction = state.transactions.find(t => t.id === id);
      if (!transaction) return;

      const oldAmount = parseFloat(transaction.amount);
      const oldPaymentMethod = transaction.paymentMethod;
      const oldCardId = transaction.creditCardId;
      const oldIsRecurrent = transaction.isRecurrent;
      const oldInstallments = transaction.installments;
      const oldRecurrenceId = transaction.recurrenceId;


      if (updates.category) {
        const catList = updates.type === 'income' ? state.categories.income : state.categories.expense;
        const cat = catList.find(c => c.id === updates.category);
        if (cat) { updates.categoryName = cat.name; updates.categoryIcon = cat.icon; }
      }
      if (updates.paymentMethod) {
        const pay = state.paymentMethods.find(p => p.id === updates.paymentMethod);
        if (pay) { updates.paymentMethodName = pay.name; updates.paymentMethodIcon = pay.icon; }
      }
      if (updates.person) {
        const pers = state.people.find(p => p.id === updates.person);
        if (pers) { updates.personName = pers.name; updates.personIcon = pers.icon; }
      }
      if (updates.creditCardId) {
        const cardUpd = state.cards.find(c => c.id === updates.creditCardId);
        if (cardUpd) updates.creditCardName = cardUpd.name;
      }


      const newAmount = updates.amount !== undefined ? parseFloat(updates.amount) : oldAmount;
      const newPaymentMethod = updates.paymentMethod || oldPaymentMethod;
      const newCardId = updates.creditCardId || oldCardId;

      // Lógica de atualização de limite de cartão
      // Se a transação é recorrente, o impacto no limite é mais complexo e geralmente feito no total da compra original.
      // Esta simplificação assume que a edição de uma parcela não re-impacta o limite total se a compra original já o fez.
      if (!oldIsRecurrent) { // Apenas para transações não recorrentes ou a primeira de uma série (que não é editada assim)
        if (oldPaymentMethod === 'credito' && newPaymentMethod === 'credito') { 
          if (oldCardId === newCardId) { 
            if (newAmount !== oldAmount) {
              await updateCardLimits(oldCardId, newAmount, 'update', oldAmount);
            }
          } else { 
            if (oldCardId) await updateCardLimits(oldCardId, oldAmount, 'subtract');
            if (newCardId) await updateCardLimits(newCardId, newAmount, 'add');
          }
        }
        else if (oldPaymentMethod !== 'credito' && newPaymentMethod === 'credito') { 
          if (newCardId) await updateCardLimits(newCardId, newAmount, 'add');
        }
        else if (oldPaymentMethod === 'credito' && newPaymentMethod !== 'credito') { 
          if (oldCardId) await updateCardLimits(oldCardId, oldAmount, 'subtract');
          updates.creditCardId = null; updates.creditCardName = null; 
        }
      }
      
      if (updates.date && updates.date instanceof Date) updates.date = localDateToISOString(updates.date);
      if (updates.dueDate && updates.dueDate instanceof Date) updates.dueDate = localDateToISOString(updates.dueDate);
      if (updates.scheduledDate && updates.scheduledDate instanceof Date) updates.scheduledDate = localDateToISOString(updates.scheduledDate);


      await db.collection('transactions').doc(id).update(updates);
      Object.assign(transaction, updates); 
      await fullUIRefresh(); 
      showToast('Transação atualizada!', 'success');
      return transaction;
    } catch (e) { console.error(e); showToast('Erro ao atualizar transação.', 'error'); return null; }
  };

  const deleteTransaction = async (id, options = {}) => {
    try {
      const transaction = state.transactions.find(t => t.id === id);
      if (!transaction) return;

      const isRecurrentSeries = transaction.isRecurrent && transaction.recurrenceId;
      
      if (isRecurrentSeries && options.deleteOption === 'future') {
        const futureParcels = state.transactions.filter(t => t.recurrenceId === transaction.recurrenceId && t.installmentNumber >= transaction.installmentNumber);
        const batch = db.batch();
        
        // Se a transação original (valor total) foi no cartão, e estamos excluindo *todas* as parcelas futuras
        // o valor total da compra original deve ser removido do saldo devedor do cartão.
        if (transaction.type === 'expense' && transaction.paymentMethod === 'credito' && transaction.creditCardId) {
            const firstParcelInSeries = state.transactions.find(t_series => 
                t_series.recurrenceId === transaction.recurrenceId && t_series.installmentNumber === 1
            );
            if (firstParcelInSeries) { 
                const totalPurchaseAmount = parseFloat(firstParcelInSeries.amount) * firstParcelInSeries.installments;
                await updateCardLimits(transaction.creditCardId, totalPurchaseAmount, 'subtract');
            }
        }

        futureParcels.forEach(parcel => {
          batch.delete(db.collection('transactions').doc(parcel.id));
        });
        await batch.commit();
        state.transactions = state.transactions.filter(t => !(t.recurrenceId === transaction.recurrenceId && t.installmentNumber >= transaction.installmentNumber));
      } else { // Exclusão única ou não recorrente
        if (transaction.type === 'expense' && transaction.paymentMethod === 'credito' && transaction.creditCardId) {
            if (transaction.isRecurrent && transaction.recurrenceId) {
                // Se excluir uma ÚNICA parcela de uma compra recorrente no cartão,
                // O impacto no limite do cartão já foi feito pelo valor total da compra.
                // O currentInvoice (saldo devedor) do cartão será ajustado pela remoção desta parcela.
                await updateCardLimits(transaction.creditCardId, parseFloat(transaction.amount), 'subtract');
            } else { // Compra única no cartão
                 await updateCardLimits(transaction.creditCardId, parseFloat(transaction.amount), 'subtract');
            }
        }
        await db.collection('transactions').doc(id).delete();
        state.transactions = state.transactions.filter(t => t.id !== id);
      }
      await fullUIRefresh(); 
      showToast('Transação excluída!', 'success');
      return true;
    } catch (e) { console.error(e); showToast('Erro ao excluir transação.', 'error'); return false; }
  };

  const openEditModal = (transaction) => {
    if (!transaction) return;
    state.currentTransaction = transaction;
    $('#editTransactionId').value = transaction.id;
    $('#editTransactionType').value = transaction.type;
    $('#editName').value = transaction.name;
    $('#editAmount').value = transaction.amount;

    const categorySelect = $('#editCategory');
    categorySelect.dataset.type = transaction.type; 
    updateCategorySelects(); 
    categorySelect.value = transaction.category;

    $('#editPerson').value = transaction.person || '';
    
    const expenseTypeGroup = $('#editExpenseTypeGroup');
    if (transaction.type === 'expense') {
        expenseTypeGroup.style.display = 'block';
        if (transaction.isFixed === 'fixed') $('#editExpenseTypeFixed').checked = true;
        else $('#editExpenseTypeVariable').checked = true;
    } else {
        expenseTypeGroup.style.display = 'none';
    }

    setDateInputValue('editDate', transaction.date); 
    
    const dueDateGroup = $('#editDueDateGroup');
    const dueDateInput = $('#editDueDate');

    let effectiveDueDateForEdit = transaction.dueDate ? parseLocalDateString(transaction.dueDate) : null; 
    if (transaction.type === 'expense' && transaction.paymentMethod === 'credito' && transaction.creditCardId) {
        const card = state.cards.find(c => c.id === transaction.creditCardId);
        const launchDate = parseLocalDateString(transaction.date);
        if (card && launchDate) {
            const realCardDueDate = calcularVencimentoReal(launchDate, card);
            if (realCardDueDate) effectiveDueDateForEdit = realCardDueDate;
        }
    }
    
    if (effectiveDueDateForEdit) {
        dueDateGroup.style.display = 'block';
        setDateInputValue('editDueDate', effectiveDueDateForEdit);
    } else { 
        dueDateGroup.style.display = 'block'; // Mostrar mesmo se não houver, para o usuário preencher
        setDateInputValue('editDueDate', transaction.date); // Default para data de lançamento se não houver outra
    }
    // Desabilitar dueDateInput se for cartão, pois é calculado.
    dueDateInput.disabled = (transaction.type === 'expense' && transaction.paymentMethod === 'credito');


    $('#editPaymentMethod').value = transaction.paymentMethod;
    handleEditCreditCardVisibility(); 
    if (transaction.paymentMethod === 'credito') {
        $('#editCreditCard').value = transaction.creditCardId || '';
        handleEditDueDateForCard(); 
    }
    
    $('#editIsRecurrent').checked = transaction.isRecurrent || false;
    // Se for uma parcela (tem recurrenceId), não permitir alterar o número de parcelas ou o status de recorrente.
    const isParcelOfSeries = !!transaction.recurrenceId;
    $('#editIsRecurrent').disabled = isParcelOfSeries;
    $('#editInstallments').disabled = !transaction.isRecurrent || isParcelOfSeries; 
    
    handleEditRecurrenceGroupVisibility();
    if (transaction.isRecurrent) {
      $('#editInstallments').value = transaction.installments || 2;
    }

    const statusGroup = $('#editStatusGroup');
    statusGroup.innerHTML = ''; 
    if (transaction.type === 'income') {
      statusGroup.innerHTML = `
        <div class="radio-wrapper"><input type="radio" class="radio" id="editStatusReceived" name="editStatus" value="received"><label class="radio-label" for="editStatusReceived">Recebido</label></div>
        <div class="radio-wrapper"><input type="radio" class="radio" id="editStatusPendingIncome" name="editStatus" value="pending"><label class="radio-label" for="editStatusPendingIncome">A Receber</label></div>`;
      if (transaction.status === 'received') $('#editStatusReceived').checked = true; else $('#editStatusPendingIncome').checked = true;
    } else { 
      statusGroup.innerHTML = `
        <div class="radio-wrapper"><input type="radio" class="radio" id="editStatusPaid" name="editStatus" value="paid"><label class="radio-label" for="editStatusPaid">Pago</label></div>
        <div class="radio-wrapper"><input type="radio" class="radio" id="editStatusPendingExpense" name="editStatus" value="pending"><label class="radio-label" for="editStatusPendingExpense">Pendente</label></div>
        <div class="radio-wrapper"><input type="radio" class="radio" id="editStatusScheduled" name="editStatus" value="scheduled"><label class="radio-label" for="editStatusScheduled">Agendado</label></div>`;
      if (transaction.status === 'paid') $('#editStatusPaid').checked = true;
      else if (transaction.status === 'scheduled') $('#editStatusScheduled').checked = true;
      else $('#editStatusPendingExpense').checked = true;
    }
    handleEditStatusFieldVisibility(); 
    handleEditScheduledDateVisibility();

    if (transaction.status === 'scheduled' && transaction.scheduledDate) {
      setDateInputValue('editScheduledDate', transaction.scheduledDate);
    }

    $('#editNotes').value = transaction.notes || '';
    $('#editModalTitle').textContent = transaction.type === 'income' ? 'Editar Receita' : 'Editar Despesa';
    openModal('editModal');
  };

  const openDeleteConfirmModal = (transaction) => {
    if (!transaction) return;
    state.currentTransaction = transaction;
    const reccOptions = $('#recurrenceDeleteOptions');
    // Uma transação é parte de uma série se tem recurrenceId E não é a última parcela (ou se installments > 1)
    const isPartOfRecurrentSeries = transaction.isRecurrent && transaction.recurrenceId && transaction.installments > 1;
    reccOptions.style.display = isPartOfRecurrentSeries ? 'block' : 'none';
    if (isPartOfRecurrentSeries) $('#deleteSingle').checked = true;
    openModal('deleteConfirmModal');
  };

  const openEditCardModal = (card) => {
    if (!card) return;
    state.currentCard = card;
    $('#cardName').value = card.name;
    $('#cardLimit').value = card.limit;
    $('#cardClosingDay').value = card.closingDay;
    $('#cardDueDay').value = card.dueDay;
    $('.modal-title', $('#newCardModal')).textContent = 'Editar Cartão';
    $('#saveCardBtn').textContent = 'Salvar Alterações';
    $('#saveCardBtn').dataset.id = card.id;
    closeModal('cardsListModal');
    openModal('newCardModal');
  };

  const renderGenericList = (containerId, items, type, editFn, deleteFn, nameField = 'name', iconField = 'icon') => {
    const listEl = $(`#${containerId}`);
    if (!listEl) return;
    listEl.innerHTML = '';
    items.forEach(item => {
      const itemEl = document.createElement('div');
      itemEl.className = 'category-item';
      itemEl.dataset.id = item.id;
      itemEl.dataset.type = type;
      itemEl.innerHTML = `
        <div class="category-item-content">
          <div class="category-item-icon">${item[iconField] || '●'}</div>
          <div>${item[nameField]}</div>
        </div>
        <div class="category-item-actions">
          <button class="btn btn-icon btn-outline edit-item-btn" aria-label="Editar"><svg width="16" height="16"><use href="#icon-edit"></use></svg></button>
          <button class="btn btn-icon btn-outline delete-item-btn" aria-label="Excluir"><svg width="16" height="16"><use href="#icon-trash"></use></svg></button>
        </div>`;
      listEl.appendChild(itemEl);
      itemEl.querySelector('.edit-item-btn').addEventListener('click', () => editFn(item, type));
      itemEl.querySelector('.delete-item-btn').addEventListener('click', () => deleteFn(item.id, type));
    });
  };
  const renderCategoriesList = () => renderGenericList('incomeCategoriesList', state.categories.income, 'income', openEditCategoryModal, deleteCategory);
  const renderExpenseCategoriesList = () => renderGenericList('expenseCategoriesList', state.categories.expense, 'expense', openEditCategoryModal, deleteCategory); 
  const renderInvestmentCategoriesList = () => renderGenericList('investmentCategoriesList', state.categories.investment, 'investment', openEditCategoryModal, deleteCategory);
  const renderPaymentMethodsList = () => renderGenericList('paymentMethodsList', state.paymentMethods, 'paymentMethod', openEditCategoryModal, deletePaymentMethod);
  const updatePeopleList = () => renderGenericList('peopleList', state.people, 'person', openEditCategoryModal, deletePerson);

  const openEditCategoryModal = (item, type) => {
    state.currentCategory = item; 
    $('#editCategoryId').value = item.id;
    $('#editCategoryType').value = type; 
    $('#editCategoryName').value = item.name;
    $('#editCategoryIconInput').value = item.icon || '';
    $('#editCategoryIconPreview').innerHTML = item.icon || '●';
    const titles = {'income':'Editar Categoria de Receita', 'expense':'Editar Categoria de Despesa', 'investment':'Editar Categoria de Investimento', 'paymentMethod':'Editar Forma de Pagamento', 'person':'Editar Pessoa'};
    $('#editCategoryTitle').textContent = titles[type] || 'Editar Item';
    openModal('editCategoryModal');
  };

  const addCategory = async (name, icon, type) => {
    if (!name.trim()) { showToast('Nome não pode ser vazio.', 'error'); return null; }
    const id = `${name.toLowerCase().replace(/[^a-z0-9]/g, '_')}_${generateId().substring(0,6)}`;
    const category = { id, name, icon, type }; 
    try {
      await db.collection('categories').doc(id).set(category);
      if (type === 'income') state.categories.income.push(category);
      else if (type === 'expense') state.categories.expense.push(category);
      else if (type === 'investment') state.categories.investment.push(category);
      await fullUIRefresh(); 
      showToast('Categoria adicionada!', 'success'); return category;
    } catch (e) { console.error(e); showToast('Erro ao adicionar categoria.', 'error'); return null; }
  };
  const addPaymentMethod = async (name, icon) => {
    if (!name.trim()) { showToast('Nome não pode ser vazio.', 'error'); return null; }
    const id = `${name.toLowerCase().replace(/[^a-z0-9]/g, '_')}_${generateId().substring(0,6)}`;
    const method = { id, name, icon };
    try {
      await db.collection('paymentMethods').doc(id).set(method);
      state.paymentMethods.push(method);
      await fullUIRefresh(); 
      showToast('Forma de pagamento adicionada!', 'success'); return method;
    } catch (e) { console.error(e); showToast('Erro ao adicionar forma de pagamento.', 'error'); return null; }
  };
  const addPerson = async (name, icon) => {
    if (!name.trim()) { showToast('Nome não pode ser vazio.', 'error'); return null; }
    const id = `${name.toLowerCase().replace(/[^a-z0-9]/g, '_')}_${generateId().substring(0,6)}`;
    const person = { id, name, icon };
    try {
      await db.collection('people').doc(id).set(person);
      state.people.push(person);
      await fullUIRefresh(); 
      showToast('Pessoa adicionada!', 'success'); return person;
    } catch (e) { console.error(e); showToast('Erro ao adicionar pessoa.', 'error'); return null; }
  };

  const updateCategory = async (id, updates, type) => {
    try {
      await db.collection('categories').doc(id).update(updates);
      let listToUpdate;
      if (type === 'income') listToUpdate = state.categories.income;
      else if (type === 'expense') listToUpdate = state.categories.expense;
      else if (type === 'investment') listToUpdate = state.categories.investment;
      
      const index = listToUpdate.findIndex(c => c.id === id);
      if (index !== -1) listToUpdate[index] = { ...listToUpdate[index], ...updates };
      
      const batch = db.batch();
      let transactionsUpdated = false;
      state.transactions.forEach(t => {
        if (t.category === id) {
          batch.update(db.collection('transactions').doc(t.id), { categoryName: updates.name, categoryIcon: updates.icon });
          t.categoryName = updates.name; t.categoryIcon = updates.icon; 
          transactionsUpdated = true;
        }
      });
      if (transactionsUpdated) await batch.commit();
      
      await fullUIRefresh(); 
      showToast('Categoria atualizada!', 'success'); return true;
    } catch (e) { console.error(e); showToast('Erro ao atualizar categoria.', 'error'); return false; }
  };
  const updatePaymentMethod = async (id, updates) => {
    try {
      await db.collection('paymentMethods').doc(id).update(updates);
      const index = state.paymentMethods.findIndex(m => m.id === id);
      if (index !== -1) state.paymentMethods[index] = { ...state.paymentMethods[index], ...updates };
      
      const batch = db.batch();
      let transactionsUpdated = false;
      state.transactions.forEach(t => {
        if (t.paymentMethod === id) {
          batch.update(db.collection('transactions').doc(t.id), { paymentMethodName: updates.name, paymentMethodIcon: updates.icon });
          t.paymentMethodName = updates.name; t.paymentMethodIcon = updates.icon;
          transactionsUpdated = true;
        }
      });
      if (transactionsUpdated) await batch.commit();

      await fullUIRefresh(); 
      showToast('Forma de pagamento atualizada!', 'success'); return true;
    } catch (e) { console.error(e); showToast('Erro ao atualizar forma de pagamento.', 'error'); return false; }
  };
  const updatePerson = async (id, updates) => {
    try {
      await db.collection('people').doc(id).update(updates);
      const index = state.people.findIndex(p => p.id === id);
      if (index !== -1) state.people[index] = { ...state.people[index], ...updates };

      const batch = db.batch();
      let transactionsUpdated = false;
      state.transactions.forEach(t => {
        if (t.person === id) {
          batch.update(db.collection('transactions').doc(t.id), { personName: updates.name, personIcon: updates.icon });
          t.personName = updates.name; t.personIcon = updates.icon;
          transactionsUpdated = true;
        }
      });
      if (transactionsUpdated) await batch.commit();

      await fullUIRefresh(); 
      showToast('Pessoa atualizada!', 'success'); return true;
    } catch (e) { console.error(e); showToast('Erro ao atualizar pessoa.', 'error'); return false; }
  };

  const deleteCategory = async (id, type) => {
    if (!confirm(`Excluir esta categoria? Transações associadas perderão esta categoria.`)) return false;
    try {
      await db.collection('categories').doc(id).delete();
      if (type === 'income') state.categories.income = state.categories.income.filter(c => c.id !== id);
      else if (type === 'expense') state.categories.expense = state.categories.expense.filter(c => c.id !== id);
      else if (type === 'investment') state.categories.investment = state.categories.investment.filter(c => c.id !== id);
      state.transactions.forEach(t => { if (t.category === id) { t.category = null; t.categoryName = 'Sem Categoria'; t.categoryIcon = '❓'; }});
      await fullUIRefresh(); 
      showToast('Categoria excluída!', 'success'); return true;
    } catch (e) { console.error(e); showToast('Erro ao excluir categoria.', 'error'); return false; }
  };
  const deletePaymentMethod = async (id) => {
    if (!confirm(`Excluir esta forma de pagamento? Transações associadas perderão esta forma de pagamento.`)) return false;
    try {
      await db.collection('paymentMethods').doc(id).delete();
      state.paymentMethods = state.paymentMethods.filter(m => m.id !== id);
      state.transactions.forEach(t => { if (t.paymentMethod === id) { t.paymentMethod = null; t.paymentMethodName = 'N/A'; t.paymentMethodIcon = '❓'; }});
      await fullUIRefresh(); 
      showToast('Forma de pagamento excluída!', 'success'); return true;
    } catch (e) { console.error(e); showToast('Erro ao excluir forma de pagamento.', 'error'); return false; }
  };
  const deletePerson = async (id) => {
    if (!confirm(`Excluir esta pessoa? Transações associadas perderão esta pessoa.`)) return false;
    try {
      await db.collection('people').doc(id).delete();
      state.people = state.people.filter(p => p.id !== id);
      state.transactions.forEach(t => { if (t.person === id) { t.person = null; t.personName = 'N/A'; t.personIcon = '❓'; }});
      await fullUIRefresh(); 
      showToast('Pessoa excluída!', 'success'); return true;
    } catch (e) { console.error(e); showToast('Erro ao excluir pessoa.', 'error'); return false; }
  };

  async function fullUIRefresh() {
    filterTransactionsByMonth(); 
    updateTransactionsTable(); 
    updateKPIs();             
    updateCharts();           
    updateCardsList();             
    updateCreditCardSelects();     
    renderCommitments();           
    generateInsights();            
    renderCategoriesList();        
    renderExpenseCategoriesList(); 
    renderInvestmentCategoriesList(); 
    renderPaymentMethodsList();    
    updatePeopleList();            
    updateCategorySelects();
    updatePaymentMethodSelects();
    updatePeopleSelects();
    updateInvestmentCategorySelects();
  }

  function handleDueDateForCard(formPrefix) {
    const paymentMethodEl = $(`#${formPrefix}PaymentMethod`);
    const creditCardEl = $(`#${formPrefix}CreditCard`);
    const dateEl = $(`#${formPrefix}Date`); 
    const dueDateEl = $(`#${formPrefix}DueDate`); 
    const dueDateGroupEl = $(`#${formPrefix}DueDateGroup`);

    if (!paymentMethodEl || !dueDateEl || !dueDateGroupEl) return;

    if (paymentMethodEl.value === 'credito') {
        dueDateGroupEl.style.display = 'block'; 
        dueDateEl.disabled = true; 
        if (creditCardEl && creditCardEl.value && dateEl && dateEl.value) {
            const card = state.cards.find(c => c.id === creditCardEl.value);
            const launchDate = getDateInputValue(`${formPrefix}Date`);
            if (card && launchDate) {
                const realDueDate = calcularVencimentoReal(launchDate, card);
                if (realDueDate) setDateInputValue(`${formPrefix}DueDate`, realDueDate);
            } else {
                 setDateInputValue(`${formPrefix}DueDate`, null); // Limpa se não puder calcular
            }
        } else {
            setDateInputValue(`${formPrefix}DueDate`, null); // Limpa se não tiver cartão ou data
        }
    } else { 
        dueDateEl.disabled = false;
        dueDateGroupEl.style.display = 'block';
        if (!dueDateEl.value && formPrefix !== 'edit') { // Apenas para novos, não sobrescrever edição
            if (dateEl && dateEl.value) {
                setDateInputValue(`${formPrefix}DueDate`, getDateInputValue(`${formPrefix}Date`));
            }
        }
    }
  }
  
  function handleStatusFieldVisibility(formPrefix) {
    const paymentMethodEl = $(`#${formPrefix}PaymentMethod`);
    const isRecurrentEl = $(`#${formPrefix}IsRecurrent`);
    const statusGroupEl = $(`#${formPrefix}StatusGroup`) || $(`#${formPrefix}StatusOuterGroup`); 
    const statusPendingRadioExpense = $(`#${formPrefix}StatusPending`) || $(`#${formPrefix}StatusPendingExpense`);
    const statusPendingRadioIncome = $(`#${formPrefix}StatusPending`) || $(`#${formPrefix}StatusPendingIncome`);


    if (!paymentMethodEl || !statusGroupEl ) return;
    
    const isCreditCard = paymentMethodEl.value === 'credito';
    const isRecurrent = isRecurrentEl ? isRecurrentEl.checked : false;
    const isExpenseForm = formPrefix.toLowerCase().includes('expense') || (state.currentTransaction && state.currentTransaction.type === 'expense');


    if (isCreditCard || isRecurrent) {
        statusGroupEl.style.display = 'none';
        if (isExpenseForm && statusPendingRadioExpense) statusPendingRadioExpense.checked = true;
        else if (!isExpenseForm && statusPendingRadioIncome) statusPendingRadioIncome.checked = true; 
    } else {
        statusGroupEl.style.display = 'block'; 
    }
  }

  function handleCreditCardGroupVisibility(formPrefix) {
    const paymentMethodEl = $(`#${formPrefix}PaymentMethod`);
    const creditCardGroupEl = $(`#${formPrefix}CreditCardGroup`) || $(`#creditCardGroup`); 
    if (paymentMethodEl && creditCardGroupEl) {
        creditCardGroupEl.style.display = paymentMethodEl.value === 'credito' ? 'block' : 'none';
    }
  }
  function handleRecurrenceGroupVisibility(formPrefix) {
    const isRecurrentEl = $(`#${formPrefix}IsRecurrent`);
    const recurrenceGroupEl = $(`#${formPrefix}RecurrenceGroup`);
    const installmentsInput = $(`#${formPrefix}Installments`); 
    if (isRecurrentEl && recurrenceGroupEl) {
        recurrenceGroupEl.style.display = isRecurrentEl.checked ? 'block' : 'none';
        if(installmentsInput) installmentsInput.disabled = !isRecurrentEl.checked;

    }
  }
  function handleScheduledDateVisibility(formPrefix) {
    const statusRadioScheduled = $(`#${formPrefix}StatusScheduled`);
    const scheduledDateGroupEl = $(`#${formPrefix}ScheduledDateGroup`);
    if (scheduledDateGroupEl) { 
        scheduledDateGroupEl.style.display = (statusRadioScheduled && statusRadioScheduled.checked) ? 'block' : 'none';
        if (statusRadioScheduled && statusRadioScheduled.checked && !$(`#${formPrefix}ScheduledDate`).value) {
            setDateInputValue(`${formPrefix}ScheduledDate`, new Date());
        }
    }
  }
  const handleEditCreditCardVisibility = () => handleCreditCardGroupVisibility('edit');
  const handleEditRecurrenceGroupVisibility = () => handleRecurrenceGroupVisibility('edit');
  const handleEditScheduledDateVisibility = () => handleScheduledDateVisibility('edit');
  const handleEditDueDateForCard = () => handleDueDateForCard('edit');
  const handleEditStatusFieldVisibility = () => handleStatusFieldVisibility('edit');


  const initEventListeners = () => {
    $('#yearSelect').addEventListener('change', async e => { state.year = parseInt(e.target.value); await fullUIRefresh(); });
    $('#monthSelect').addEventListener('change', async e => { state.month = parseInt(e.target.value); await fullUIRefresh(); });

    $('#newIncomeBtn').addEventListener('click', () => {
      $('#incomeForm').reset();
      setDateInputValue('incomeDate', new Date());
      handleStatusFieldVisibility('income'); 
      handleRecurrenceGroupVisibility('income');
      openModal('incomeModal');
    });
    $('#newExpenseBtn').addEventListener('click', () => {
      $('#expenseForm').reset();
      const today = new Date();
      setDateInputValue('expenseDate', today); 
      setDateInputValue('expenseDueDate', today); 
      $('#expenseTypeVariable').checked = true; 
      $('#expenseStatusPending').checked = true; 
      handleCreditCardGroupVisibility('expense'); 
      handleDueDateForCard('expense'); 
      handleStatusFieldVisibility('expense'); 
      handleRecurrenceGroupVisibility('expense');
      handleScheduledDateVisibility('expense');
      openModal('expenseModal');
    });

    $('#cardsBtn').addEventListener('click', () => { updateCardsList(); openModal('cardsListModal'); });
    $('#categoriesBtn').addEventListener('click', () => {
        renderCategoriesList();
        renderExpenseCategoriesList(); 
        renderPaymentMethodsList();
        renderInvestmentCategoriesList();
        updatePeopleList();
        const firstTabLink = $('#income-cat-tab');
        const firstTabPane = $('#income-cat');
        if (firstTabLink && firstTabPane) {
            $$('.nav-link').forEach(link => link.classList.remove('active'));
            $$('.tab-pane').forEach(pane => pane.classList.remove('active', 'show'));
            firstTabLink.classList.add('active');
            firstTabPane.classList.add('active', 'show');
        }
        openModal('categoriesModal');
    });
    $('#investmentsBtn').addEventListener('click', () => { loadInvestments(); openModal('investmentsModal'); });

    $$('.modal-close, .btn-outline[id^="cancel"], #closeCategoriesBtn, #closeInvestmentsBtn, #closeInvestmentDetailModal, #closeNewInvestmentModal, #closeNewContributionModal, #closeDueTransactionsBtn, #backToCardsBtn, #closePayInvoiceConfirmModal, #closeDeleteConfirmModal').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const modal = e.currentTarget.closest('.modal-backdrop');
        if (modal) {
          if (e.currentTarget.id === 'backToCardsBtn') {
              closeModal('cardInvoiceModal');
              openModal('cardsListModal');
          } else {
              closeModal(modal.id);
          }
        }
      });
    });

    $$('.modal-backdrop').forEach(backdrop => {
      backdrop.addEventListener('click', e => {
        if (e.target === backdrop) {
          closeModal(backdrop.id);
        }
      });
    });


    $('#saveIncomeBtn').addEventListener('click', async () => {
      const name = $('#incomeName').value.trim();
      const amount = parseFloat($('#incomeAmount').value);
      if (!name || !amount || amount <= 0) { showToast('Nome e valor válido são obrigatórios.', 'error'); return; }

      const formData = {
        type: 'income', name, amount,
        category: $('#incomeCategory').value,
        date: localDateToISOString(getDateInputValue('incomeDate')), 
        paymentMethod: $('#incomePaymentMethod').value,
        status: $('input[name="incomeStatus"]:checked') ? $('input[name="incomeStatus"]:checked').value : 'pending', 
        notes: $('#incomeNotes').value.trim(),
        isRecurrent: $('#incomeIsRecurrent').checked,
        dueDate: localDateToISOString(getDateInputValue('incomeDate')) 
      };

      if (formData.isRecurrent) {
          formData.status = 'pending'; 
      }

      if (formData.isRecurrent) {
        const installments = parseInt($('#incomeInstallments').value);
        if (installments >= 2) await addRecurrentTransactions(formData, installments);
        else await addTransaction(formData); 
      } else {
        await addTransaction(formData);
      }
      closeModal('incomeModal');
    });

    $('#saveExpenseBtn').addEventListener('click', async () => {
      const name = $('#expenseName').value.trim();
      const amount = parseFloat($('#expenseAmount').value);
      const paymentMethod = $('#expensePaymentMethod').value;
      const creditCardId = $('#expenseCreditCard').value;
      const isFixedChecked = $('input[name="expenseType"]:checked');

      if (!name || !amount || amount <= 0) { showToast('Nome e valor válido são obrigatórios.', 'error'); return; }
      if (!isFixedChecked) { showToast('Selecione se a despesa é Fixa ou Variável.', 'error'); return; }
      if (paymentMethod === 'credito' && !creditCardId) { showToast('Selecione um cartão de crédito.', 'error'); return; }

      let formData = {
        type: 'expense', name, amount, paymentMethod,
        category: $('#expenseCategory').value,
        person: $('#expensePerson').value || null, 
        isFixed: isFixedChecked.value,
        date: localDateToISOString(getDateInputValue('expenseDate')), 
        dueDate: null, 
        status: $('input[name="expenseStatus"]:checked') ? $('input[name="expenseStatus"]:checked').value : 'pending', 
        notes: $('#expenseNotes').value.trim(),
        isRecurrent: $('#expenseIsRecurrent').checked,
        creditCardId: paymentMethod === 'credito' ? creditCardId : null,
        scheduledDate: null
      };

      if (paymentMethod === 'credito' && creditCardId && formData.date) {
          const card = state.cards.find(c => c.id === creditCardId);
          const launchDate = parseLocalDateString(formData.date);
          if (card && launchDate) {
              const realDueDate = calcularVencimentoReal(launchDate, card);
              if (realDueDate) formData.dueDate = localDateToISOString(realDueDate);
          }
      } else if (getDateInputValue('expenseDueDate')) { 
          formData.dueDate = localDateToISOString(getDateInputValue('expenseDueDate'));
      } else { 
          formData.dueDate = formData.date;
      }


      if (paymentMethod === 'credito' || formData.isRecurrent) {
          formData.status = 'pending';
      } else if (formData.status === 'scheduled') {
          formData.scheduledDate = localDateToISOString(getDateInputValue('expenseScheduledDate'));
          if (!formData.scheduledDate) { showToast('Informe a data de agendamento.', 'error'); return; }
      }


      if (formData.isRecurrent) {
        const installments = parseInt($('#expenseInstallments').value);
        if (installments >= 2) await addRecurrentTransactions(formData, installments);
        else await addTransaction(formData);
      } else {
        await addTransaction(formData);
      }
      closeModal('expenseModal');
    });

    $('#saveEditBtn').addEventListener('click', async () => {
      const id = $('#editTransactionId').value;
      const type = $('#editTransactionType').value;
      const name = $('#editName').value.trim();
      const amount = parseFloat($('#editAmount').value);
      const paymentMethod = $('#editPaymentMethod').value;
      const creditCardId = $('#editCreditCard').value;
      const isFixedChecked = $('input[name="editExpenseType"]:checked');

      if (!name || !amount || amount <= 0) { showToast('Nome e valor válido são obrigatórios.', 'error'); return; }
      if (type === 'expense' && !isFixedChecked) { showToast('Selecione se a despesa é Fixa ou Variável.', 'error'); return; }
      if (paymentMethod === 'credito' && !creditCardId) { showToast('Selecione um cartão de crédito.', 'error'); return; }

      const updates = {
        name, amount, paymentMethod,
        category: $('#editCategory').value,
        person: $('#editPerson').value || null,
        date: localDateToISOString(getDateInputValue('editDate')), 
        notes: $('#editNotes').value.trim(),
        isRecurrent: $('#editIsRecurrent').checked, 
        creditCardId: paymentMethod === 'credito' ? creditCardId : null,
        dueDate: null 
      };

      if (paymentMethod === 'credito' && creditCardId && updates.date) {
          const card = state.cards.find(c => c.id === creditCardId);
          const launchDate = parseLocalDateString(updates.date);
          if (card && launchDate) {
              const realDueDate = calcularVencimentoReal(launchDate, card);
              if (realDueDate) updates.dueDate = localDateToISOString(realDueDate);
          }
      } else if (getDateInputValue('editDueDate')) { 
          updates.dueDate = localDateToISOString(getDateInputValue('editDueDate'));
      } else { 
          updates.dueDate = updates.date;
      }


      if (type === 'expense') {
        updates.isFixed = isFixedChecked.value;
        updates.status = $('input[name="editStatus"]:checked') ? $('input[name="editStatus"]:checked').value : 'pending';
        if (updates.status === 'scheduled') {
            updates.scheduledDate = localDateToISOString(getDateInputValue('editScheduledDate'));
            if (!updates.scheduledDate) { showToast('Informe a data de agendamento.', 'error'); return; }
        } else {
            updates.scheduledDate = null;
        }
      } else { 
        updates.status = $('input[name="editStatus"]:checked') ? $('input[name="editStatus"]:checked').value : 'pending';
      }

      const currentTransaction = state.transactions.find(t => t.id === id);
      if ((paymentMethod === 'credito' || updates.isRecurrent) &&
          currentTransaction?.status !== 'paid' && currentTransaction?.status !== 'received' &&
          updates.status !== 'paid' && updates.status !== 'received') { 
          updates.status = 'pending';
      }

      await updateTransaction(id, updates);
      closeModal('editModal');
    }); 

    $('#confirmDeleteBtn').addEventListener('click', async () => {
      const id = state.currentTransaction?.id;
      if (!id) return;
      const deleteOption = $('#deleteAllFuture').checked ? 'future' : 'single';
      await deleteTransaction(id, { deleteOption });
      closeModal('deleteConfirmModal');
    });

    $('#saveCardBtn').addEventListener('click', async () => {
      const name = $('#cardName').value.trim();
      const limit = parseFloat($('#cardLimit').value);
      const closingDay = parseInt($('#cardClosingDay').value);
      const dueDay = parseInt($('#cardDueDay').value);
      const cardId = $('#saveCardBtn').dataset.id;

      if (!name || !limit || limit <= 0 || !closingDay || closingDay < 1 || closingDay > 31 || !dueDay || dueDay < 1 || dueDay > 31) {
        showToast('Preencha todos os campos do cartão corretamente.', 'error'); return;
      }
      const cardData = { name, limit, closingDay, dueDay };
      if (cardId) await updateCard(cardId, cardData);
      else await addCard(cardData);
      closeModal('newCardModal');
    });

    $('#confirmPayInvoiceBtn').addEventListener('click', async () => {
      if (state.currentCard) await payCardInvoice(state.currentCard.id);
    });

    $('#payInvoiceBtn').addEventListener('click', () => {
      if (state.currentCard) {
        openModal('payInvoiceConfirmModal');
      }
    });

    $('#addIncomeCategoryBtn').addEventListener('click', async () => {
      const name = $('#newIncomeCategoryInput').value.trim();
      const icon = $('#newIncomeCategoryIconInput').value.trim();
      if (await addCategory(name, icon, 'income')) {
        $('#newIncomeCategoryInput').value = ''; $('#newIncomeCategoryIconInput').value = ''; $('#newIncomeCategoryIconPreview').innerHTML = '💰';
      }
    });
    $('#addExpenseCategoryBtn').addEventListener('click', async () => {
      const name = $('#newExpenseCategoryInput').value.trim();
      const icon = $('#newExpenseCategoryIconInput').value.trim();
      if (await addCategory(name, icon, 'expense')) {
        $('#newExpenseCategoryInput').value = ''; $('#newExpenseCategoryIconInput').value = ''; $('#newExpenseCategoryIconPreview').innerHTML = '🛍️';
      }
    });
    $('#addInvestmentCategoryBtn').addEventListener('click', async () => {
      const name = $('#newInvestmentCategoryInput').value.trim();
      const icon = $('#newInvestmentCategoryIconInput').value.trim();
      if (await addCategory(name, icon, 'investment')) {
        $('#newInvestmentCategoryInput').value = ''; $('#newInvestmentCategoryIconInput').value = ''; $('#newInvestmentCategoryIconPreview').innerHTML = '📈';
      }
    });
    $('#addPaymentMethodBtn').addEventListener('click', async () => {
      const name = $('#newPaymentMethodInput').value.trim();
      const icon = $('#newPaymentMethodIconInput').value.trim();
      if (await addPaymentMethod(name, icon)) {
        $('#newPaymentMethodInput').value = ''; $('#newPaymentMethodIconInput').value = ''; $('#newPaymentMethodIconPreview').innerHTML = '💳';
      }
    });
    $('#addPersonBtn').addEventListener('click', async () => {
      const name = $('#newPersonInput').value.trim();
      const icon = $('#newPersonIconInput').value.trim();
      if (await addPerson(name, icon)) {
        $('#newPersonInput').value = ''; $('#newPersonIconInput').value = ''; $('#newPersonIconPreview').innerHTML = '👤';
      }
    });

    $('#saveEditCategoryBtn').addEventListener('click', async () => {
      const id = $('#editCategoryId').value;
      const type = $('#editCategoryType').value;
      const name = $('#editCategoryName').value.trim();
      const icon = $('#editCategoryIconInput').value.trim();
      if (!name) { showToast('Nome não pode ser vazio.', 'error'); return; }
      const updates = { name, icon };
      let success = false;
      if (type === 'income' || type === 'expense' || type === 'investment') success = await updateCategory(id, updates, type);
      else if (type === 'paymentMethod') success = await updatePaymentMethod(id, updates);
      else if (type === 'person') success = await updatePerson(id, updates);
      if (success) closeModal('editCategoryModal');
    });

    $('#expensePaymentMethod').addEventListener('change', () => {
        handleCreditCardGroupVisibility('expense');
        handleDueDateForCard('expense');
        handleStatusFieldVisibility('expense');
    });
    $('#expenseCreditCard').addEventListener('change', () => handleDueDateForCard('expense'));
    $('#expenseDate').addEventListener('change', () => handleDueDateForCard('expense')); 
    $('#expenseDueDate').addEventListener('change', () => { /* Apenas para o usuário mudar manualmente se não for cartão */ });
    $('#expenseIsRecurrent').addEventListener('change', () => {
        handleRecurrenceGroupVisibility('expense');
        handleStatusFieldVisibility('expense');
    });
    $$('input[name="expenseStatus"]').forEach(r => r.addEventListener('change', () => handleScheduledDateVisibility('expense')));

    $('#incomeIsRecurrent').addEventListener('change', () => {
        handleRecurrenceGroupVisibility('income');
        handleStatusFieldVisibility('income');
    });

    $('#editPaymentMethod').addEventListener('change', () => {
        handleEditCreditCardVisibility();
        handleEditDueDateForCard();
        handleEditStatusFieldVisibility();
    });
    $('#editCreditCard').addEventListener('change', () => handleEditDueDateForCard());
    $('#editDate').addEventListener('change', () => handleEditDueDateForCard()); 
    $('#editDueDate').addEventListener('change', () => { /* Apenas para o usuário mudar manualmente se não for cartão */ });
    $('#editIsRecurrent').addEventListener('change', () => {
        handleEditRecurrenceGroupVisibility();
        handleEditStatusFieldVisibility();
        $('#editInstallments').disabled = !$('#editIsRecurrent').checked || !!state.currentTransaction?.recurrenceId; // Desabilita se for parcela de série
    });
    $('#editModal').addEventListener('change', e => {
        if (e.target.matches('input[name="editStatus"]')) {
            handleEditScheduledDateVisibility();
        }
    });


    const setupIconPreview = (inputId, previewId, defaultIcon) => {
      const input = $(`#${inputId}`); const preview = $(`#${previewId}`);
      if (input && preview) input.addEventListener('input', e => preview.innerHTML = e.target.value.trim() || defaultIcon);
    };
    setupIconPreview('newIncomeCategoryIconInput', 'newIncomeCategoryIconPreview', '💰');
    setupIconPreview('newExpenseCategoryIconInput', 'newExpenseCategoryIconPreview', '🛍️');
    setupIconPreview('newInvestmentCategoryIconInput', 'newInvestmentCategoryIconPreview', '📈');
    setupIconPreview('newPaymentMethodIconInput', 'newPaymentMethodIconPreview', '💳');
    setupIconPreview('newPersonIconInput', 'newPersonIconPreview', '👤');
    setupIconPreview('editCategoryIconInput', 'editCategoryIconPreview', '●');

    $('#newCardBtn').addEventListener('click', () => {
      $('#cardForm').reset();
      $('.modal-title', $('#newCardModal')).textContent = 'Novo Cartão';
      $('#saveCardBtn').textContent = 'Salvar Cartão';
      $('#saveCardBtn').removeAttribute('data-id');
      closeModal('cardsListModal');
      openModal('newCardModal');
    });

    $('#newInvestmentBtn').addEventListener('click', openNewInvestmentModal);

    $('#saveInvestmentBtn').addEventListener('click', async () => {
      const name = $('#investmentName').value.trim();
      const amount = parseFloat($('#investmentAmount').value);
      const goal = parseFloat($('#investmentGoal').value) || null;
      const category = $('#investmentCategorySelect').value;
      const targetDate = getDateInputValue('investmentTargetDate');
      const notes = $('#investmentNotes').value.trim();
      const action = $('#saveInvestmentBtn').dataset.action;
      const id = $('#saveInvestmentBtn').dataset.id;

      if (!name || amount === undefined || amount < 0) { showToast('Nome e valor inicial válido são obrigatórios.', 'error'); return; }
      if (!category) { showToast('Selecione uma categoria.', 'error'); return; }

      const formData = { name, amount, goal, category, targetDate: targetDate ? localDateToISOString(targetDate) : null, notes };

      let success = false;
      if (action === 'update' && id) success = await updateInvestment(id, formData);
      else success = await addInvestment(formData);

      if (success) {
          closeModal('newInvestmentModal');
          if (action === 'add' && success && typeof success === 'object' && success.id) {
              openInvestmentDetail(success.id);
          } else if (action === 'update' && state.currentInvestment?.id === id) {
              openInvestmentDetail(id);
          }
      }
    });

    $('#addInvestmentContributionBtn').addEventListener('click', openNewContributionModal);

    $('#saveContributionBtn').addEventListener('click', async () => {
      const amount = parseFloat($('#contributionAmount').value);
      const date = getDateInputValue('contributionDate');
      const description = $('#contributionDescription').value.trim();
      const investmentId = $('#contributionInvestmentId').value;
      const action = $('#saveContributionBtn').dataset.action;
      const id = $('#saveContributionBtn').dataset.id;

      if (!amount || amount <= 0 || !date || !investmentId) { showToast('Valor, data e ID do investimento são obrigatórios.', 'error'); return; }

      const formData = { investmentId, amount, date: localDateToISOString(date), description };

      let success = false;
      if (action === 'update' && id) success = await updateContribution(id, formData);
      else success = await addContribution(formData);

      if (success) closeModal('newContributionModal');
    });

    $('#editInvestmentBtn').addEventListener('click', () => {
      if (state.currentInvestment) openEditInvestmentModal(state.currentInvestment.id);
    });

    $('#deleteInvestmentBtn').addEventListener('click', () => {
      if (state.currentInvestment && confirm('Excluir este investimento e todos os aportes?')) {
        deleteInvestment(state.currentInvestment.id);
      }
    });

    $('#backToInvestmentsBtn').addEventListener('click', () => {
      closeModal('investmentDetailModal');
      openModal('investmentsModal');
    });

    $('#commitmentsHeader').addEventListener('click', toggleCommitments);

    initTabs();

  }; 

  const initTabs = () => {
    $$('[data-toggle="tab"]').forEach(tab => {
      tab.addEventListener('click', e => {
        e.preventDefault();
        const targetId = e.currentTarget.getAttribute('href');
        const targetPane = $(targetId);
        if (!targetPane) return;

        const tabGroup = e.currentTarget.closest('.nav-tabs');
        const contentGroup = targetPane.closest('.tab-content');
        if (!tabGroup || !contentGroup) return;

        tabGroup.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        contentGroup.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active', 'show'));

        e.currentTarget.classList.add('active');
        targetPane.classList.add('active');
        void targetPane.offsetWidth; 
        targetPane.classList.add('show');
      });
    });
  };

  const initApp = async () => {
    try {
      initTheme();
      initTabs();

      const today = new Date();
      state.year = today.getFullYear();
      state.month = today.getMonth();
      updateYearOptions();
      $('#yearSelect').value = state.year;
      $('#monthSelect').value = state.month;

      await loadCategoriesAndPaymentMethods();
      await loadCards();
      await loadInvestments();
      await loadTransactions(); 

      initEventListeners(); 

      showToast('Bem-vindo(a)!', 'success');
    } catch (error) {
      console.error('Erro ao inicializar:', error);
      showToast('Erro ao inicializar. Tente recarregar.', 'error');
    }
  };

  document.addEventListener('DOMContentLoaded', initApp);

 </script>
</body>
</html>
