<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
    <!-- =================================================================== -->
    <!-- CHECKLIST DE DESENVOLVIMENTO - APP GEST√ÉO FINANCEIRA V2 -->
    <!-- =================================================================== -->
    <!--
    * CHECKLIST COMPLETO DE TAREFAS (12 TOTAL):
    *
    * (A) Migra√ß√£o e Reestrutura√ß√£o Visual (Base):
    * üîÑ A1. Estruturar o HTML base do projeto seguindo ESQUEMA VISUAL COMPLETO.txt e Mockup.html.
    * üîÑ A2. Aplicar todo o CSS (estilos, fontes, cores, layout responsivo) definido no Mockup.html, adaptado √† nova estrutura.
    * ‚¨ú A3. Migrar e adaptar a l√≥gica JavaScript do codigo completo.txt.
    *
    * (B) Novas Funcionalidades e Corre√ß√µes:
    * ‚¨ú B1. Campo "Pessoas": Adicionar campo ao formul√°rio de despesas e dados.
    * ‚¨ú B2. Gerenciamento de Pessoas: Criar interface e l√≥gica no modal "Cadastros".
    * ‚¨ú B3. KPI/An√°lise Fixas vs. Vari√°veis: Implementar c√°lculo e exibi√ß√£o no KPI [3]. (Schema mudou o gr√°fico).
    * ‚¨ú B4. Posicionamento Gr√°fico Consumo/Pessoa: Posicionar ao lado do 12 meses (conforme Schema [5]).
    * ‚¨ú B5. Se√ß√£o "Investimentos": Criar nova se√ß√£o/tela (Tela 1 e Tela 2 do Schema).
    * ‚¨ú B6. Cadastro em Investimentos: Implementar CRUD de categorias de investimento.
    * ‚¨ú B7. Filtro por "Pessoas" na lista de transa√ß√µes.
    * ‚¨ú B8. An√°lise por Pessoa: Implementar Gr√°fico (Consumo por Pessoa no Schema [5]).
    * ‚¨ú B9. Corre√ß√£o Bug Categorias: Listar todas imediatamente no modal "Cadastros".
    *
    * PROGRESSO: 0/12 tarefas conclu√≠das (0%)
    * PR√ìXIMA: Implementar estrutura HTML base e CSS (A1, A2).
    -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o Financeira Familiar V2</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"> <!-- Fonte do c√≥digo antigo para consist√™ncia JS -->

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Firebase v9 compat -->
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-auth-compat.js"></script>

    <style>
        /* ====================================================== */
        /* ESTILOS BASEADOS NO Mockup.html E Adaptados */
        /* ====================================================== */

        /* Design Tokens - Estilo Apple (Mockup.html) */
        :root {
            /* Cores neutras - Light Mode */
            --color-background: #ffffff;
            --color-surface: #f5f5f7;
            --color-surface-variant: #e8e8ed;
            --color-on-surface: #1d1d1f;
            --color-on-surface-variant: #86868b;
            --color-outline: #d2d2d7;

            /* Cores sem√¢nticas */
            --color-primary: #007AFF;
            --color-on-primary: #ffffff;
            --color-success: #34c759;
            --color-on-success: #ffffff;
            --color-warning: #ff9500;
            --color-on-warning: #ffffff;
            --color-error: #ff3b30;
            --color-on-error: #ffffff;
            --color-info: #007aff; /* Adicionado do c√≥digo antigo */
            --color-on-info: #ffffff; /* Adicionado do c√≥digo antigo */


            /* Cores para receitas e despesas */
            --color-income: #34c759;
            --color-expense: #ff3b30;

            /* Cores de cart√µes (Mantendo do c√≥digo antigo) */
            --color-card-blue: #007aff;
            --color-card-green: #34c759;
            --color-card-orange: #ff9500;
            --color-card-red: #ff3b30;
            --color-card-purple: #af52de;
            --color-card-invoice: #FFD700; /* Amarelo ouro para fatura KPI */

            /* Tipografia (Priorizando SF Pro do Mockup) */
            --font-family: 'SF Pro Display', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --font-size-xs: 0.75rem;   /* 12px */
            --font-size-sm: 0.875rem;  /* 14px */
            --font-size-md: 1rem;      /* 16px */
            --font-size-lg: 1.125rem;  /* 18px */
            --font-size-xl: 1.25rem;   /* 20px */
            --font-size-2xl: 1.75rem;  /* 28px */
            --font-size-3xl: 2.5rem;   /* 40px */
            --font-size-4xl: 3.5rem;   /* 56px */

            /* Pesos de fonte (Inter do c√≥digo antigo para refer√™ncia, mas SF Pro ser√° aplicado) */
            --font-weight-light: 300;
            --font-weight-regular: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;

            /* Espa√ßamento */
            --spacing-2xs: 0.25rem; /* 4px */
            --spacing-xs: 0.5rem;   /* 8px */
            --spacing-sm: 0.75rem;  /* 12px */
            --spacing-md: 1rem;     /* 16px */
            --spacing-lg: 1.5rem;   /* 24px */
            --spacing-xl: 2rem;     /* 32px */
            --spacing-2xl: 3rem;    /* 48px */

            /* Bordas e raios */
            --radius-sm: 0.5rem;    /* 8px */
            --radius-md: 0.75rem;   /* 12px */
            --radius-lg: 1rem;      /* 16px */
            --radius-xl: 1.5rem;    /* 24px */
            --radius-full: 9999px;

            /* Sombras (Pegando do c√≥digo antigo para mais op√ß√µes) */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.05), 0 4px 6px rgba(0, 0, 0, 0.05);

            /* Transi√ß√µes */
            --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* Dark Mode (Mockup.html) */
        [data-theme="dark"] {
            --color-background: #000000;
            --color-surface: #1c1c1e;
            --color-surface-variant: #2c2c2e;
            --color-on-surface: #f5f5f7;
            --color-on-surface-variant: #8e8e93;
            --color-outline: #38383a;
            color: var(--color-on-surface); /* Adicionado para garantir a cor do texto no dark mode */
        }

        /* Reset b√°sico */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
             scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--color-background);
            color: var(--color-on-surface);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background-color var(--transition-normal), color var(--transition-normal);
            min-height: 100vh;
            line-height: 1.5;
            font-size: var(--font-size-md); /* Default font size */
        }

        img, picture, video, canvas, svg {
            display: block;
            max-width: 100%;
        }

        input, button, textarea, select {
            font: inherit;
            color: inherit;
        }

        button {
            background: none;
            border: none;
            cursor: pointer;
        }

        a {
            color: inherit;
            text-decoration: none;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        /* Container principal */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-lg);
        }

        /* [1] Header Fixo (Baseado no Mockup.html + Schema) */
        .header {
            position: sticky;
            top: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm) var(--spacing-lg); /* Reduzido padding vertical */
            background-color: rgba(var(--color-background-rgb, 255, 255, 255), 0.8); /* Cor de fundo com transpar√™ncia */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--color-outline);
            z-index: 100;
            transition: background-color var(--transition-normal);
            gap: var(--spacing-md);
            flex-wrap: wrap; /* Permite quebrar linha em telas menores */
        }
         [data-theme="dark"] .header {
            background-color: rgba(var(--color-background-rgb, 0, 0, 0), 0.8);
         }

        .app-title-header { /* Nome diferente do h1 principal */
            font-size: var(--font-size-lg); /* Menor que o t√≠tulo da p√°gina */
            font-weight: 600;
            letter-spacing: -0.02em;
            white-space: nowrap; /* Evitar quebra de linha no t√≠tulo */
        }

        .nav-actions {
            display: flex;
            gap: var(--spacing-sm); /* Espa√ßamento menor entre bot√µes */
            align-items: center;
            flex-wrap: wrap; /* Permite quebrar linha */
            justify-content: flex-end; /* Alinha √† direita */
            flex-grow: 1; /* Ocupa espa√ßo restante */
        }

        .nav-actions .select-wrapper { /* Estilo para selects no header */
             position: relative;
             display: inline-block;
        }
         .nav-actions .select {
            appearance: none;
            -webkit-appearance: none;
            padding: var(--spacing-2xs) var(--spacing-lg) var(--spacing-2xs) var(--spacing-sm); /* Padding ajustado */
            border-radius: var(--radius-full);
            border: 1px solid var(--color-outline);
            background-color: var(--color-surface);
            cursor: pointer;
            transition: border-color var(--transition-normal), box-shadow var(--transition-normal);
            font-size: var(--font-size-xs); /* Tamanho menor */
            min-width: 80px; /* Largura m√≠nima */
         }
         .nav-actions .select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
         }
         .nav-actions .select:hover {
            border-color: var(--color-primary);
         }
        .nav-actions .select-icon {
            position: absolute;
            right: var(--spacing-sm); /* Ajustado */
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--color-on-surface-variant);
            width: 12px; /* √çcone menor */
            height: 12px;
        }


        /* [2] Se√ß√£o Hero (Mockup.html) */
        .hero {
            display: flex;
            flex-direction: column;
            align-items: flex-start; /* Alinhado √† esquerda */
            text-align: left; /* Alinhado √† esquerda */
            margin: var(--spacing-xl) 0 var(--spacing-2xl) 0; /* Margem ajustada */
            padding: 0 var(--spacing-lg); /* Padding horizontal */
        }

        .hero-title {
            font-size: var(--font-size-3xl);
            font-weight: 600;
            letter-spacing: -0.03em;
            margin-bottom: var(--spacing-sm); /* Menor margem */
            line-height: 1.1;
        }

        .hero-subtitle {
            font-size: var(--font-size-lg);
            color: var(--color-on-surface-variant);
            margin-bottom: 0; /* Sem margem inferior */
            max-width: 600px;
        }

        /* [3] Cards KPI (Mockup.html + Schema) */
        .kpi-grid {
            display: grid;
            /* Cria 5 colunas de tamanho igual, permitindo quebra */
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-2xl);
             padding: 0 var(--spacing-lg); /* Padding horizontal */
        }

        .kpi-card {
            background-color: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            display: flex;
            flex-direction: column;
            transition: transform var(--transition-normal), box-shadow var(--transition-normal);
            border-left: 4px solid transparent; /* Borda padr√£o */
            box-shadow: var(--shadow-sm); /* Sombra sutil */
        }

        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md); /* Sombra mais pronunciada no hover */
        }

        .kpi-title {
            font-size: var(--font-size-sm);
            color: var(--color-on-surface-variant);
            margin-bottom: var(--spacing-xs);
            font-weight: 500;
        }

        .kpi-value {
            font-size: var(--font-size-2xl); /* Tamanho grande */
            font-weight: 600; /* Semibold */
            margin-bottom: var(--spacing-xs);
            line-height: 1.2;
        }

        .kpi-subtitle {
            font-size: var(--font-size-xs);
            color: var(--color-on-surface-variant);
            display: flex;
            align-items: center;
            gap: var(--spacing-2xs); /* Menor gap */
            margin-top: auto; /* Empurra para baixo */
        }
        .kpi-subtitle svg {
            width: 14px; /* √çcone menor */
            height: 14px;
            flex-shrink: 0; /* Evita que o √≠cone encolha */
        }

        /* Cores espec√≠ficas das bordas KPI */
        .kpi-balance { border-left-color: var(--color-primary); }
        .kpi-income { border-left-color: var(--color-income); }
        .kpi-expense { border-left-color: var(--color-expense); }
        .kpi-card-invoice { border-left-color: var(--color-card-invoice); }
        .kpi-fixed-variable { border-left-color: var(--color-warning); } /* Cor para Fixas vs Vari√°veis */


        /* [4 e 5] Se√ß√£o de gr√°ficos (Mockup.html + Schema) */
        .charts-section-title { /* T√≠tulo para as se√ß√µes de gr√°fico */
             font-size: var(--font-size-xl);
             font-weight: 600;
             margin-bottom: var(--spacing-lg);
             padding: 0 var(--spacing-lg); /* Padding horizontal */
        }

        .charts-grid-container { /* Container para as grades de gr√°ficos */
            margin-bottom: var(--spacing-2xl);
            padding: 0 var(--spacing-lg); /* Padding horizontal */
        }

        .charts-grid { /* Para [4] e [5] */
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Ajuste minmax */
            gap: var(--spacing-lg);
        }

        .chart-card {
            background-color: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            min-height: 300px; /* Altura m√≠nima */
            height: auto; /* Altura autom√°tica */
            max-height: 450px; /* Altura m√°xima */
            transition: transform var(--transition-normal), box-shadow var(--transition-normal);
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-sm);
            overflow: hidden; /* Evita que o conte√∫do vaze */
        }

        .chart-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .chart-title {
            font-size: var(--font-size-md); /* Tamanho m√©dio */
            font-weight: 600; /* Semibold */
            margin-bottom: var(--spacing-md);
            flex-shrink: 0; /* N√£o encolher o t√≠tulo */
        }
         .chart-canvas-container { /* Container para o canvas */
            flex-grow: 1; /* Ocupa espa√ßo restante */
            position: relative; /* Necess√°rio para aspect ratio */
            min-height: 200px; /* Altura m√≠nima para o canvas */
         }
         .chart-canvas-container canvas {
             max-height: 350px; /* Altura m√°xima do canvas */
         }

        /* [6] Se√ß√£o de transa√ß√µes (Mockup.html + Schema + c√≥digo antigo) */
        .transactions-container {
            margin-bottom: var(--spacing-2xl);
            padding: 0 var(--spacing-lg); /* Padding horizontal */
        }

        .transactions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Permite quebrar */
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .transactions-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
        }

        .transactions-filters { /* Container para busca e filtros */
            display: flex;
            gap: var(--spacing-sm);
            flex-wrap: wrap; /* Permite quebrar */
            align-items: center;
        }
         .transactions-filters .search-input { /* Campo de busca */
            padding: var(--spacing-xs) var(--spacing-md);
            border-radius: var(--radius-full);
            border: 1px solid var(--color-outline);
            background-color: var(--color-surface);
            transition: border-color var(--transition-normal), box-shadow var(--transition-normal);
            font-size: var(--font-size-sm);
            min-width: 150px;
         }
         .transactions-filters .search-input:focus {
             outline: none;
             border-color: var(--color-primary);
             box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
         }
         .transactions-filters .select-wrapper { /* Selects de filtro */
            position: relative;
            min-width: 150px;
         }
         .transactions-filters .select {
            appearance: none;
            -webkit-appearance: none;
            width: 100%;
            padding: var(--spacing-xs) var(--spacing-xl) var(--spacing-xs) var(--spacing-md);
            border-radius: var(--radius-full);
            border: 1px solid var(--color-outline);
            background-color: var(--color-surface);
            cursor: pointer;
            transition: border-color var(--transition-normal), box-shadow var(--transition-normal);
            font-size: var(--font-size-sm);
         }
        .transactions-filters .select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
        }
        .transactions-filters .select:hover {
            border-color: var(--color-primary);
        }
        .transactions-filters .select-icon {
            position: absolute;
            right: var(--spacing-md);
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--color-on-surface-variant);
            width: 12px;
            height: 12px;
        }


        .transactions-table-container {
            background-color: var(--color-surface);
            border-radius: var(--radius-lg);
            overflow-x: auto; /* Permite scroll horizontal em telas pequenas */
            box-shadow: var(--shadow-sm);
        }

        .transactions-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px; /* Largura m√≠nima para evitar esmagamento excessivo */
        }

        .transactions-table th {
            text-align: left;
            padding: var(--spacing-sm) var(--spacing-md); /* Padding ajustado */
            font-weight: 500;
            color: var(--color-on-surface-variant);
            border-bottom: 1px solid var(--color-outline);
            background-color: var(--color-surface); /* Fundo para o header */
            position: sticky; /* Mant√©m o cabe√ßalho vis√≠vel no scroll vertical */
            top: 0;
            z-index: 10;
            white-space: nowrap; /* Evita quebra de linha no header */
            font-size: var(--font-size-sm);
        }

        .transactions-table td {
            padding: var(--spacing-sm) var(--spacing-md); /* Padding ajustado */
            border-bottom: 1px solid var(--color-outline);
            vertical-align: middle; /* Alinha conte√∫do verticalmente */
            font-size: var(--font-size-sm);
        }

        .transactions-table tr:last-child td {
            border-bottom: none;
        }

        .transactions-table tbody tr:hover {
            background-color: var(--color-surface-variant);
        }

        /* Estilos para colunas espec√≠ficas da tabela */
        .col-icon { width: 40px; text-align: center; }
        .col-actions { width: 100px; text-align: right; }
        .col-status { white-space: nowrap; }
        .col-value { text-align: right; font-weight: 500; white-space: nowrap; }

        /* √çcone de transa√ß√£o na tabela */
         .transaction-icon {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 32px; /* Tamanho do √≠cone */
            height: 32px;
            border-radius: var(--radius-full);
            background-color: var(--color-surface-variant);
            font-size: var(--font-size-md); /* Tamanho do emoji/√≠cone */
         }

        /* √çcones de ordena√ß√£o */
        .transactions-table th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative; /* Para posicionar o √≠cone */
            padding-right: var(--spacing-lg); /* Espa√ßo para o √≠cone */
        }
        .transactions-table th.sortable:hover {
             background-color: var(--color-surface-variant);
        }
        .transaction-sort-icon {
            position: absolute;
            right: var(--spacing-xs);
            top: 50%;
            transform: translateY(-50%);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            color: var(--color-primary);
        }
         .transaction-sort-icon svg {
            width: 100%;
            height: 100%;
         }

        /* Bot√µes e a√ß√µes (Mockup.html) */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-2xs); /* Menor gap */
            padding: var(--spacing-xs) var(--spacing-md);
            border-radius: var(--radius-full);
            font-weight: 500;
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: all var(--transition-normal);
            border: none;
            min-height: 36px; /* Altura m√≠nima */
            white-space: nowrap;
            line-height: 1.2; /* Ajuste de linha */
        }
        .btn svg {
             width: 16px;
             height: 16px;
        }

        .btn-primary { background-color: var(--color-primary); color: var(--color-on-primary); }
        .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .btn-primary:active { transform: translateY(0); box-shadow: none; }

        .btn-success { background-color: var(--color-success); color: var(--color-on-success); }
        .btn-success:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .btn-success:active { transform: translateY(0); box-shadow: none; }

        .btn-danger { background-color: var(--color-error); color: var(--color-on-error); }
        .btn-danger:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .btn-danger:active { transform: translateY(0); box-shadow: none; }

        .btn-warning { background-color: var(--color-warning); color: var(--color-on-warning); }
        .btn-warning:hover { opacity: 0.9; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .btn-warning:active { transform: translateY(0); box-shadow: none; }


        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--color-outline);
            color: var(--color-primary); /* Cor do texto no outline */
        }
        .btn-outline:hover {
            background-color: var(--color-surface-variant);
            border-color: var(--color-primary);
        }
        /* Cores espec√≠ficas para outline */
        .btn-outline.btn-success { color: var(--color-success); border-color: var(--color-success); }
        .btn-outline.btn-success:hover { background-color: rgba(var(--color-success-rgb, 52, 199, 89), 0.1); }
        .btn-outline.btn-danger { color: var(--color-error); border-color: var(--color-error); }
        .btn-outline.btn-danger:hover { background-color: rgba(var(--color-error-rgb, 255, 59, 48), 0.1); }
        .btn-outline.btn-warning { color: var(--color-warning); border-color: var(--color-warning); }
        .btn-outline.btn-warning:hover { background-color: rgba(var(--color-warning-rgb, 255, 149, 0), 0.1); }


        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            border-radius: 50%;
        }
        .btn-icon svg {
             width: 18px; /* Tamanho do √≠cone dentro do bot√£o */
             height: 18px;
        }


        /* Status Badge (Mockup.html) */
        .badge {
            display: inline-block;
            padding: var(--spacing-2xs) var(--spacing-xs);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: 500;
            line-height: 1; /* Para evitar altura extra */
        }

        .badge-success { background-color: rgba(52, 199, 89, 0.1); color: var(--color-success); }
        .badge-warning { background-color: rgba(255, 149, 0, 0.1); color: var(--color-warning); }
        .badge-danger { background-color: rgba(255, 59, 48, 0.1); color: var(--color-error); }
        .badge-info { background-color: rgba(0, 122, 255, 0.1); color: var(--color-info); } /* Adicionado */

        /* Tema Toggle (Mockup.html + c√≥digo antigo) */
        .theme-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            background-color: var(--color-surface-variant);
            transition: background-color var(--transition-normal);
            border: none; /* Garantir sem borda */
        }
        .theme-toggle:hover { background-color: var(--color-outline); }
        .theme-toggle svg {
            width: 20px;
            height: 20px;
            color: var(--color-on-surface-variant);
        }
        /* Esconder o √≠cone n√£o ativo */
        [data-theme="light"] .theme-toggle .icon-moon { display: none; }
        [data-theme="dark"] .theme-toggle .icon-sun { display: none; }


        /* Modais (Baseado no c√≥digo antigo, estilizado com Mockup) */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-normal), visibility var(--transition-normal);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            padding: var(--spacing-md); /* Padding para evitar colar nas bordas */
        }
        .modal-backdrop.active { opacity: 1; visibility: visible; }

        .modal {
            width: 90%;
            max-width: 500px; /* Padr√£o */
            background-color: var(--color-surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            opacity: 0;
            transform: translateY(20px) scale(0.98);
            transition: opacity var(--transition-normal), transform var(--transition-normal);
            display: flex;
            flex-direction: column;
            max-height: 90vh; /* Altura m√°xima */
            overflow: hidden; /* Previne overflow do modal em si */
        }
         .modal.modal-lg { max-width: 700px; } /* Tamanho maior */
         .modal.modal-xl { max-width: 900px; } /* Tamanho extra grande */

        .modal-backdrop.active .modal {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--color-outline);
            flex-shrink: 0; /* N√£o encolher o header */
        }

        .modal-title {
            font-size: var(--font-size-lg); /* Ajustado */
            font-weight: 600;
            color: var(--color-on-surface);
            display: flex; /* Para alinhar √≠cone com texto */
            align-items: center;
            gap: var(--spacing-xs);
        }
         .modal-title svg {
             width: 20px;
             height: 20px;
             color: var(--color-on-surface-variant); /* Cor do √≠cone no t√≠tulo */
         }

        .modal-close {
            color: var(--color-on-surface-variant);
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-full);
            transition: background-color var(--transition-normal);
            border: none;
            background: none;
            padding: 0;
        }
        .modal-close:hover { background-color: var(--color-surface-variant); }
        .modal-close svg { width: 18px; height: 18px; }


        .modal-body {
            padding: var(--spacing-lg);
            overflow-y: auto; /* Scroll apenas no corpo */
            flex-grow: 1; /* Ocupa o espa√ßo restante */
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-md);
            padding: var(--spacing-md) var(--spacing-lg);
            border-top: 1px solid var(--color-outline);
            flex-shrink: 0; /* N√£o encolher o footer */
            background-color: var(--color-surface); /* Fundo para garantir contraste */
        }


        /* Formul√°rios dentro de Modais */
        .form-group { margin-bottom: var(--spacing-md); }

        .form-label {
            display: block;
            font-size: var(--font-size-sm);
            color: var(--color-on-surface-variant);
            margin-bottom: var(--spacing-xs);
            font-weight: 500; /* Medium */
        }

        .form-control {
            width: 100%;
            padding: var(--spacing-xs) var(--spacing-md);
            border-radius: var(--radius-md); /* Raio padr√£o */
            border: 1px solid var(--color-outline);
            background-color: var(--color-background); /* Fundo mais claro */
            transition: border-color var(--transition-normal), box-shadow var(--transition-normal);
            font-size: var(--font-size-md);
        }
        .form-control:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
        }
        .form-control:hover:not(:focus) { border-color: var(--color-primary); }
        .form-control[readonly] {
             background-color: var(--color-surface-variant);
             cursor: not-allowed;
             opacity: 0.7;
        }
        textarea.form-control {
            min-height: 80px;
            resize: vertical;
        }

        /* Selects dentro de forms */
        .form-group .select-wrapper { position: relative; width: 100%; }
        .form-group .select {
            appearance: none;
            -webkit-appearance: none;
            width: 100%;
            padding: var(--spacing-xs) var(--spacing-xl) var(--spacing-xs) var(--spacing-md);
            border-radius: var(--radius-md);
            border: 1px solid var(--color-outline);
            background-color: var(--color-background);
            cursor: pointer;
            transition: border-color var(--transition-normal), box-shadow var(--transition-normal);
            font-size: var(--font-size-md);
        }
        .form-group .select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
        }
        .form-group .select:hover { border-color: var(--color-primary); }
        .form-group .select-icon {
            position: absolute;
            right: var(--spacing-md);
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--color-on-surface-variant);
            width: 16px;
            height: 16px;
        }

        /* Checkbox personalizado (c√≥digo antigo) */
        .checkbox-wrapper {
            position: relative;
            display: inline-flex; /* Alterado para inline-flex */
            align-items: center; /* Alinha verticalmente */
            gap: var(--spacing-xs); /* Espa√ßo entre checkbox e label */
            cursor: pointer;
        }
        .checkbox {
            position: absolute; /* Esconde o input original */
            opacity: 0;
            width: 0;
            height: 0;
        }
        .checkbox-label-box { /* A caixa visual */
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: var(--radius-sm); /* Raio menor */
            border: 1.5px solid var(--color-outline); /* Borda ligeiramente mais grossa */
            background-color: var(--color-background);
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative; /* Para o √≠cone de check */
            flex-shrink: 0; /* Evita encolher */
        }
        .checkbox:checked + .checkbox-label-box {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
        }
        .checkbox:checked + .checkbox-label-box:after {
            content: '';
            position: absolute;
            left: 6px;
            top: 3px;
            width: 5px;
            height: 9px;
            border: solid var(--color-on-primary); /* Check branco */
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }
        .checkbox-label-text { /* O texto do label */
             font-size: var(--font-size-sm);
             color: var(--color-on-surface);
             user-select: none; /* Evita sele√ß√£o de texto */
        }

        /* Radio buttons (c√≥digo antigo) */
        .radio-group {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            flex-wrap: wrap;
        }
        .radio-wrapper {
            position: relative;
            display: inline-flex; /* Alterado */
            align-items: center;
            gap: var(--spacing-xs);
            cursor: pointer;
        }
        .radio {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }
        .radio-label-circle { /* O c√≠rculo visual */
            display: inline-block;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 1.5px solid var(--color-outline);
            position: relative;
            transition: all var(--transition-fast);
            background-color: var(--color-background);
            flex-shrink: 0;
        }
        .radio:checked + .radio-label-circle {
             border-color: var(--color-primary);
        }
        .radio:checked + .radio-label-circle:after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px; /* C√≠rculo interno */
            height: 8px;
            border-radius: 50%;
            background-color: var(--color-primary);
        }
        .radio-label-text { /* Texto do label */
            font-size: var(--font-size-sm);
            color: var(--color-on-surface);
            user-select: none;
        }

        /* Toast (Baseado no c√≥digo antigo) */
        .toast-container {
            position: fixed;
            top: var(--spacing-lg); /* Mais espa√ßo do topo */
            right: var(--spacing-lg);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: var(--spacing-md);
        }
        .toast {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            background-color: var(--color-surface);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-md);
            min-width: 300px;
            max-width: 400px;
            transform: translateX(120%);
            transition: transform var(--transition-normal), opacity var(--transition-normal);
            opacity: 0;
            border-left: 4px solid transparent; /* Borda colorida */
        }
        .toast.show { transform: translateX(0); opacity: 1; }
        .toast-icon { font-size: 1.5rem; flex-shrink: 0; }
        .toast-icon svg { width: 24px; height: 24px; }
        .toast-content { flex: 1; font-size: var(--font-size-sm); }
        .toast-close {
             font-size: var(--font-size-lg);
             color: var(--color-on-surface-variant);
             cursor: pointer;
             width: 24px;
             height: 24px;
             display: flex;
             align-items: center;
             justify-content: center;
             border-radius: var(--radius-full);
             transition: background-color var(--transition-normal);
             border: none; background: none; padding: 0;
             margin-left: auto; /* Empurra para a direita */
        }
        .toast-close:hover { background-color: var(--color-surface-variant); }
        .toast-close svg { width: 14px; height: 14px; }

        /* Cores Toast */
        .toast-success { border-left-color: var(--color-success); }
        .toast-success .toast-icon { color: var(--color-success); }
        .toast-error { border-left-color: var(--color-error); }
        .toast-error .toast-icon { color: var(--color-error); }
        .toast-warning { border-left-color: var(--color-warning); }
        .toast-warning .toast-icon { color: var(--color-warning); }
        .toast-info { border-left-color: var(--color-info); }
        .toast-info .toast-icon { color: var(--color-info); }


        /* Estilos para Abas (Nav-tabs - c√≥digo antigo, adaptado) */
        .nav-tabs {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0 0 var(--spacing-lg) 0; /* Margem inferior */
            border-bottom: 1px solid var(--color-outline);
            gap: var(--spacing-md); /* Espa√ßo entre as abas */
            overflow-x: auto; /* Scroll horizontal se necess√°rio */
        }
        .nav-item { margin-bottom: -1px; /* Para a borda inferior da aba ativa sobrepor */ }
        .nav-link {
            display: block;
            padding: var(--spacing-sm) var(--spacing-md);
            text-decoration: none;
            color: var(--color-on-surface-variant);
            border-bottom: 2px solid transparent;
            transition: all var(--transition-normal);
            white-space: nowrap;
            font-size: var(--font-size-sm);
            cursor: pointer; /* Adicionado */
        }
        .nav-link:hover { color: var(--color-primary); }
        .nav-link.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
            font-weight: 500; /* Medium */
        }

        .tab-content { position: relative; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; animation: fadeIn 0.3s ease-in-out; }

        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }

        /* Estilos para Listas dentro de Abas (Ex: Categorias, Pessoas) */
        .tab-list-container {
            max-height: 300px; /* Altura m√°xima com scroll */
            overflow-y: auto;
            margin-bottom: var(--spacing-lg);
            border: 1px solid var(--color-outline);
            border-radius: var(--radius-md);
            background-color: var(--color-background); /* Fundo ligeiramente diferente */
        }
        .tab-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-sm) var(--spacing-md);
            border-bottom: 1px solid var(--color-outline);
            transition: background-color var(--transition-normal);
        }
        .tab-list-item:hover { background-color: var(--color-surface-variant); }
        .tab-list-item:last-child { border-bottom: none; }

        .tab-item-content {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: var(--font-size-sm);
        }
        .tab-item-icon {
            width: 28px; /* Tamanho do √≠cone/emoji */
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-full);
            background-color: var(--color-surface-variant);
            font-size: var(--font-size-md); /* Tamanho do emoji */
            flex-shrink: 0;
        }
        .tab-item-actions {
            display: flex;
            gap: var(--spacing-xs);
            margin-left: auto; /* Empurra para a direita */
        }
        .tab-item-actions .btn-icon { /* Bot√µes menores na lista */
             width: 32px;
             height: 32px;
        }
        .tab-item-actions .btn-icon svg {
             width: 16px;
             height: 16px;
        }

        /* Formul√°rio de Adi√ß√£o nas Abas */
        .add-item-form {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm); /* Espa√ßo acima do form */
            align-items: center; /* Alinha verticalmente */
            flex-wrap: wrap; /* Permite quebra */
        }
         .add-item-form .form-control {
            flex-grow: 1; /* Ocupa espa√ßo */
            min-width: 150px; /* Largura m√≠nima */
         }
         .add-item-form .btn {
             flex-shrink: 0; /* N√£o encolher o bot√£o */
         }
         /* Campo de √≠cone espec√≠fico */
         .custom-icon-input-group {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            flex-basis: 150px; /* Largura base */
            flex-shrink: 0;
         }
         .custom-icon-preview {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            background-color: var(--color-surface-variant);
            font-size: var(--font-size-lg);
            border: 1px solid var(--color-outline);
            flex-shrink: 0;
         }
        .custom-icon-input-group .form-control {
             flex-grow: 1;
        }


        /* Se√ß√£o de Investimentos */
        #investmentsSection {
            display: none; /* Oculto por padr√£o */
            padding: var(--spacing-lg);
        }
        #investmentsSection.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }

        .investments-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
        }
        .investments-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
        }

        .investments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Cards de investimento */
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }
        .investment-card {
            background-color: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
            transition: transform var(--transition-normal), box-shadow var(--transition-normal);
            cursor: pointer; /* Indica clic√°vel */
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }
        .investment-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }
        .investment-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start; /* Alinha no topo */
            gap: var(--spacing-sm);
        }
        .investment-card-title {
            font-size: var(--font-size-md);
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }
        .investment-card-actions {
             display: flex;
             gap: var(--spacing-xs);
             flex-shrink: 0;
        }
        .investment-card-actions .btn-icon { width: 30px; height: 30px; }
        .investment-card-actions .btn-icon svg { width: 14px; height: 14px; }

        .investment-card-body {
             font-size: var(--font-size-sm);
             color: var(--color-on-surface-variant);
        }
        .investment-card-body strong {
             color: var(--color-on-surface);
             font-weight: 500;
        }
        .investment-progress-bar-container {
            width: 100%;
            height: 8px;
            background-color: var(--color-surface-variant);
            border-radius: var(--radius-full);
            overflow: hidden;
            margin-top: var(--spacing-xs);
        }
        .investment-progress-bar {
            height: 100%;
            background-color: var(--color-success); /* Cor de progresso */
            border-radius: var(--radius-full);
            transition: width var(--transition-normal);
        }

        /* Tela de Detalhe do Investimento */
        #investmentDetailSection {
             display: none; /* Oculto por padr√£o */
             padding: var(--spacing-lg);
        }
        #investmentDetailSection.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }
        .investment-detail-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: var(--spacing-lg);
        }
        .investment-detail-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
        }
        .investment-detail-summary {
            background-color: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--spacing-md);
            font-size: var(--font-size-sm);
        }
         .investment-detail-summary div { line-height: 1.4; }
        .investment-detail-summary span { color: var(--color-on-surface-variant); }
        .investment-detail-summary strong { color: var(--color-on-surface); font-weight: 500; }
        .investment-detail-progress { grid-column: 1 / -1; } /* Ocupa linha inteira */

        .investment-aportes-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin: var(--spacing-lg) 0 var(--spacing-md) 0;
        }
        .investment-aportes-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
        }
        .investment-aportes-table-container {
            background-color: var(--color-surface);
            border-radius: var(--radius-lg);
            overflow-x: auto;
            box-shadow: var(--shadow-sm);
        }
         .investment-aportes-table {
            width: 100%;
            min-width: 500px;
         }
         .investment-aportes-table th, .investment-aportes-table td {
             padding: var(--spacing-sm) var(--spacing-md);
             border-bottom: 1px solid var(--color-outline);
             font-size: var(--font-size-sm);
             text-align: left;
         }
         .investment-aportes-table th {
             font-weight: 500;
             color: var(--color-on-surface-variant);
             white-space: nowrap;
         }
        .investment-aportes-table tr:last-child td { border-bottom: none; }
        .investment-aportes-table tbody tr:hover { background-color: var(--color-surface-variant); }
        .investment-aportes-table .col-value { text-align: right; font-weight: 500; white-space: nowrap; }


        /* Responsividade Geral */
        @media (max-width: 1024px) {
             .kpi-grid {
                 grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
             }
             .nav-actions {
                 justify-content: flex-start; /* Alinha √† esquerda em telas m√©dias */
             }
        }

        @media (max-width: 768px) {
            .header {
                padding: var(--spacing-sm) var(--spacing-md);
                justify-content: space-between; /* Mant√©m t√≠tulo e a√ß√µes em lados opostos */
            }
            .nav-actions {
                 gap: var(--spacing-xs); /* Menor gap */
            }
            .nav-actions .btn {
                padding: var(--spacing-xs) var(--spacing-sm); /* Menor padding */
                font-size: var(--font-size-xs); /* Menor fonte */
            }
            .nav-actions .select {
                font-size: var(--font-size-xs);
                padding: var(--spacing-2xs) var(--spacing-md) var(--spacing-2xs) var(--spacing-xs);
            }
             .app-title-header {
                font-size: var(--font-size-md); /* Menor t√≠tulo no header */
            }

            .container { padding: var(--spacing-md); }
            .hero { padding: 0; margin: var(--spacing-lg) 0 var(--spacing-xl) 0; } /* Remover padding */
            .hero-title { font-size: var(--font-size-2xl); }
            .hero-subtitle { font-size: var(--font-size-md); }

            .kpi-grid { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: var(--spacing-md); padding: 0; }
            .kpi-value { font-size: var(--font-size-xl); }
            .kpi-subtitle { font-size: 10px; } /* Ainda menor */

            .charts-grid-container, .transactions-container { padding: 0; }
            .charts-grid { grid-template-columns: 1fr; } /* Gr√°ficos um abaixo do outro */
            .charts-section-title, .transactions-title { font-size: var(--font-size-lg); }

            .transactions-header { flex-direction: column; align-items: stretch; }
            .transactions-filters { width: 100%; justify-content: space-between; }
            .transactions-filters .search-input, .transactions-filters .select-wrapper { flex-basis: 48%; min-width: 0; } /* Ajuste de largura */

             /* Ajustes para mobile no modal de categorias */
            .add-item-form { flex-direction: column; align-items: stretch; }
            .custom-icon-input-group { width: 100%; }
            .nav-tabs { flex-wrap: nowrap; /* Evita quebra das abas */ }
            .nav-link { padding: var(--spacing-xs) var(--spacing-sm); } /* Menor padding nas abas */
        }

        @media (max-width: 480px) {
             .header { flex-direction: column; align-items: flex-start; }
             .nav-actions { width: 100%; justify-content: space-around; } /* Distribui melhor */

             .kpi-grid { grid-template-columns: 1fr 1fr; } /* 2 colunas no mobile */
             .kpi-card { padding: var(--spacing-md); }

             .transactions-filters { flex-direction: column; align-items: stretch; }
             .transactions-filters .search-input, .transactions-filters .select-wrapper { flex-basis: auto; width: 100%; }

             .modal { width: 95%; }
             .modal-footer { flex-direction: column; gap: var(--spacing-sm); }
             .modal-footer .btn { width: 100%; }

             /* Ajustes finos para inputs em mobile */
             .form-control, .form-group .select { font-size: var(--font-size-md); } /* Manter tamanho leg√≠vel */

             /* Ajustes finos na tabela */
             .transactions-table th, .transactions-table td { padding: var(--spacing-xs) var(--spacing-sm); font-size: var(--font-size-xs); }
             .col-actions { width: 80px; }
             .btn-icon { width: 30px; height: 30px; }
             .btn-icon svg { width: 14px; height: 14px; }
        }

        /* SVG Sprite Hidden */
        .svg-sprite { display: none; }

    </style>
</head>
<body data-theme="dark"> <!-- Definindo tema inicial aqui -->

    <!-- SVG Sprite (Baseado no c√≥digo antigo) -->
    <svg class="svg-sprite">
        <!-- √çcones de navega√ß√£o -->
        <symbol id="icon-home" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></symbol>
        <symbol id="icon-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></symbol>
        <symbol id="icon-calendar" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></symbol>
        <symbol id="icon-chart-bar" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></symbol> <!-- Bar chart icon -->
        <symbol id="icon-chart-pie" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z" /><path stroke-linecap="round" stroke-linejoin="round" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z" /></symbol> <!-- Pie chart icon -->
        <symbol id="icon-credit-card" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></symbol>
        <symbol id="icon-trending-up" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></symbol> <!-- Investments icon -->
        <symbol id="icon-list" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16" /></symbol> <!-- Transactions icon -->
        <symbol id="icon-users" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></symbol> <!-- Pessoas icon -->
        <symbol id="icon-tag" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-5 5a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" /></symbol> <!-- Category icon -->
        <symbol id="icon-wallet" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5M5.25 4.5h13.5a1.5 1.5 0 0 1 1.5 1.5v12a1.5 1.5 0 0 1-1.5 1.5H5.25a1.5 1.5 0 0 1-1.5-1.5V6a1.5 1.5 0 0 1 1.5-1.5Z" /></symbol> <!-- Payment method icon -->
        <symbol id="icon-cog" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></symbol> <!-- Cadastros icon -->

        <!-- √çcones de a√ß√µes -->
        <symbol id="icon-edit" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></symbol>
        <symbol id="icon-trash" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></symbol>
        <symbol id="icon-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></symbol>
        <symbol id="icon-x" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></symbol>
        <symbol id="icon-chevron-down" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></symbol>
        <symbol id="icon-chevron-up" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" /></symbol>
        <symbol id="icon-chevron-left" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></symbol> <!-- Voltar icon -->
        <symbol id="icon-search" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></symbol> <!-- Search icon -->


        <!-- √çcones tema claro/escuro -->
        <symbol id="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></symbol>
        <symbol id="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></symbol>

        <!-- √çcones para categorias padr√£o -->
        <symbol id="icon-shopping" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" /></symbol>
        <symbol id="icon-food" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></symbol>
        <symbol id="icon-home-category" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></symbol>
        <symbol id="icon-bill" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></symbol>
        <symbol id="icon-default" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></symbol>
        <symbol id="icon-money" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></symbol>
        <symbol id="icon-car" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 17l-1.18-2.359A2 2 0 0 1 8.6 12H15.4a2 2 0 0 1 1.78 2.641L16 17m-8 0h8m-8 0a2 2 0 0 0-2 2v1h12v-1a2 2 0 0 0-2-2zM5 12V7a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v5m-14 0h14" /></symbol> <!-- Transporte icon -->
        <symbol id="icon-heart" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></symbol> <!-- Sa√∫de icon -->
        <symbol id="icon-book-open" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></symbol> <!-- Educa√ß√£o icon -->
        <symbol id="icon-game-controller" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 17.5a1.5 1.5 0 0 1-3 0M16.5 17.5a1.5 1.5 0 0 0-3 0m-3-5.5h6m-6.75-3.25a.75.75 0 0 1 0 1.5h-.75a.75.75 0 0 1-.75-.75V10a.75.75 0 0 1 .75-.75h.75a.75.75 0 0 1 0 1.5Zm11.25-1.5a.75.75 0 0 0 0 1.5h.75a.75.75 0 0 0 .75-.75V10a.75.75 0 0 0-.75-.75h-.75a.75.75 0 0 0 0 1.5Zm-1.5-6.5A7.5 7.5 0 0 0 3 8.75v6.5A7.5 7.5 0 0 0 10.5 21h3a7.5 7.5 0 0 0 7.5-5.75v-6.5A7.5 7.5 0 0 0 13.5 3h-3Z" /></symbol> <!-- Lazer icon -->


        <!-- √çcones para alertas e notifica√ß√µes -->
        <symbol id="icon-alert" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></symbol>
        <symbol id="icon-info" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></symbol>

        <!-- √çcones para ordena√ß√£o -->
        <symbol id="icon-sort-asc" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" /></symbol>
        <symbol id="icon-sort-desc" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></symbol>
        <symbol id="icon-sort-none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 15L12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9" /></symbol> <!-- √çcone para ordena√ß√£o n√£o ativa -->

        <!-- √çcones para investimento -->
        <symbol id="icon-piggy-bank" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 11.25h14M5.25 7.5h13.5A1.5 1.5 0 0 1 20.25 9v7.5A1.5 1.5 0 0 1 18.75 18H5.25A1.5 1.5 0 0 1 3.75 16.5V9A1.5 1.5 0 0 1 5.25 7.5ZM10.5 11.25V15m3-3.75V15" /><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 7.5V5.625a1.125 1.125 0 0 1 1.125-1.125h2.25a1.125 1.125 0 0 1 1.125 1.125V7.5" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-1.5m0 0v-1.5m0 1.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3Z" /></symbol>
        <symbol id="icon-airplane" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12.86 15.068 5.25 10.577l-3 1.442 3.855 1.927L12.86 15.068Zm0 0 6.75-1.125 1.895 1.895-1.895 1.895-6.75-1.125ZM12.86 15.068 9.11 17.01l-1.939 3.878 1.442-3L9.11 17.01Zm1.125-1.125L15.11 7.193l3.878-1.94-3 1.442-1.94 3.878Z" /><path stroke-linecap="round" stroke-linejoin="round" d="m16.5 7.5-3.525 3.525" /></symbol> <!-- Viagem icon -->
        <symbol id="icon-shield-check" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></symbol> <!-- Reserva Emergencia icon -->
        <symbol id="icon-child" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.182 15.182a4.5 4.5 0 0 1-6.364 0M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0ZM9.75 9.75c0 .414-.168.75-.375.75S9 10.164 9 9.75s.168-.75.375-.75.375.336.375.75Zm4.5 0c0 .414-.168.75-.375.75S13.5 10.164 13.5 9.75s.168-.75.375-.75.375.336.375.75Z" /></symbol> <!-- Filho icon -->
    </svg>

    <!-- [1] HEADER FIXO -->
    <header class="header">
        <div class="app-title-header">Gest√£o Financeira</div>
        <div class="nav-actions">
            <!-- Links de Navega√ß√£o (Ser√£o funcionais com JS) -->
            <button class="btn btn-outline" id="navTransactionsBtn" title="Ir para Transa√ß√µes">
                 <svg><use href="#icon-list"></use></svg>
                 <span>Transa√ß√µes</span>
            </button>
            <button class="btn btn-outline" id="navInvestmentsBtn" title="Ir para Investimentos">
                 <svg><use href="#icon-trending-up"></use></svg>
                 <span>Investimentos</span>
            </button>
            <button class="btn btn-outline" id="navCadastrosBtn" title="Abrir Cadastros">
                 <svg><use href="#icon-cog"></use></svg>
                 <span>Cadastros</span>
            </button>
            <button class="btn btn-outline" id="navCardsBtn" title="Abrir Cart√µes">
                <svg><use href="#icon-credit-card"></use></svg>
                 <span>Cart√µes</span>
            </button>
            <!-- Bot√µes A√ß√£o R√°pida -->
            <button class="btn btn-success" id="headerNewIncomeBtn" title="Nova Receita">
                <svg><use href="#icon-plus"></use></svg>
                Receita
            </button>
            <button class="btn btn-danger" id="headerNewExpenseBtn" title="Nova Despesa">
                <svg><use href="#icon-plus"></use></svg>
                Despesa
            </button>
            <!-- Seletores de Data -->
            <div class="select-wrapper">
                <select id="yearSelect" class="select">
                    <!-- Op√ß√µes de ano ser√£o carregadas via JS -->
                </select>
                <span class="select-icon"><svg><use href="#icon-chevron-down"></use></svg></span>
            </div>
            <div class="select-wrapper">
                <select id="monthSelect" class="select">
                    <!-- Op√ß√µes de m√™s ser√£o carregadas via JS -->
                </select>
                <span class="select-icon"><svg><use href="#icon-chevron-down"></use></svg></span>
            </div>
             <!-- Toggle Tema -->
             <button id="themeToggle" class="theme-toggle" title="Alternar Tema">
                <svg class="icon-sun"><use href="#icon-sun"></use></svg>
                <svg class="icon-moon"><use href="#icon-moon"></use></svg>
             </button>
        </div>
    </header>

    <!-- Container Principal -->
    <main class="container">

        <!-- Se√ß√£o Principal (Dashboard) -->
        <section id="dashboardSection" class="active">

            <!-- [2] HERO SECTION -->
            <section class="hero">
                <h1 class="hero-title">Wagner. B√°rbara. Joaquim.</h1>
                <p class="hero-subtitle">Porque o futuro que sonhamos come√ßa com o que fazemos hoje.</p>
            </section>

            <!-- [3] KPIs -->
            <section class="kpi-grid">
                <div class="kpi-card kpi-balance">
                    <div class="kpi-title">Saldo Real (Caixa)</div>
                    <div class="kpi-value" id="kpiBalanceValue">R$ 0,00</div>
                    <div class="kpi-subtitle" id="kpiBalanceSubtitle">
                        <svg><use href="#icon-info"></use></svg>
                        <span>Comprometido: R$ 0,00</span>
                    </div>
                </div>
                <div class="kpi-card kpi-income">
                    <div class="kpi-title">Receitas</div>
                    <div class="kpi-value" id="kpiIncomeValue">R$ 0,00</div>
                    <div class="kpi-subtitle" id="kpiIncomeSubtitle">
                        <span>R$ 0,00 recebidos</span>
                    </div>
                </div>
                <div class="kpi-card kpi-expense">
                    <div class="kpi-title">Despesas</div>
                    <div class="kpi-value" id="kpiExpenseValue">R$ 0,00</div>
                    <div class="kpi-subtitle" id="kpiExpenseSubtitle">
                         <span>R$ 0,00 pagos</span>
                    </div>
                </div>
                <div class="kpi-card kpi-card-invoice">
                    <div class="kpi-title">Fatura do M√™s</div>
                    <div class="kpi-value" id="kpiInvoiceValue">R$ 0,00</div>
                    <div class="kpi-subtitle" id="kpiInvoiceSubtitle">
                        <svg><use href="#icon-credit-card"></use></svg>
                        <span>Vencimento: --/--/----</span>
                    </div>
                </div>
                 <div class="kpi-card kpi-fixed-variable"> <!-- Novo KPI -->
                    <div class="kpi-title">Fixas vs Vari√°veis</div>
                    <div class="kpi-value" id="kpiFixedVariableValue">R$ 0 / R$ 0</div>
                    <div class="kpi-subtitle" id="kpiFixedVariableSubtitle">
                        <svg><use href="#icon-chart-pie"></use></svg>
                        <span>(Despesas do m√™s)</span>
                    </div>
                </div>
            </section>

            <!-- [4] GR√ÅFICOS: CATEGORIAS + CART√ÉO DE CR√âDITO -->
             <div class="charts-grid-container">
                <h2 class="charts-section-title">Vis√£o Geral</h2>
                <div class="charts-grid">
                    <div class="chart-card">
                        <h3 class="chart-title">Despesas por Categoria</h3>
                        <div class="chart-canvas-container">
                             <canvas id="catPieChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3 class="chart-title">Limite do Cart√£o</h3>
                         <div class="chart-canvas-container">
                            <canvas id="cardAreaChart"></canvas>
                         </div>
                    </div>
                </div>
            </div>

             <!-- [5] GR√ÅFICOS: COMPARATIVOS -->
             <div class="charts-grid-container">
                <h2 class="charts-section-title">An√°lises Comparativas</h2>
                <div class="charts-grid">
                    <div class="chart-card">
                        <h3 class="chart-title">Receitas x Despesas (12 meses)</h3>
                        <div class="chart-canvas-container">
                            <canvas id="annualBarsChart"></canvas>
                        </div>
                    </div>
                     <div class="chart-card"> <!-- Novo Gr√°fico B8 -->
                        <h3 class="chart-title">Consumo por Pessoa</h3>
                        <div class="chart-canvas-container">
                            <canvas id="personSpendingChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

             <!-- [6] TABELA DE TRANSA√á√ïES -->
            <section class="transactions-container" id="transactionsSectionTarget">
                <div class="transactions-header">
                    <h2 class="transactions-title">Transa√ß√µes Recentes</h2>
                    <div class="transactions-filters">
                         <input type="text" id="searchInput" class="search-input" placeholder="Buscar...">
                         <div class="select-wrapper">
                            <select id="filterPessoa" class="select">
                                <option value="">üîΩ Todas as Pessoas</option>
                                <!-- Op√ß√µes de pessoas carregadas via JS -->
                            </select>
                            <span class="select-icon"><svg><use href="#icon-chevron-down"></use></svg></span>
                        </div>
                        <div class="select-wrapper">
                            <select id="filterCategoria" class="select">
                                <option value="">üîΩ Todas as Categorias</option>
                                <!-- Op√ß√µes de categorias carregadas via JS -->
                            </select>
                            <span class="select-icon"><svg><use href="#icon-chevron-down"></use></svg></span>
                        </div>
                         <div class="select-wrapper">
                            <select id="filterTipoDespesa" class="select">
                                <option value="">üîΩ Tipo Despesa</option>
                                <option value="fixed">Fixa</option>
                                <option value="variable">Vari√°vel</option>
                            </select>
                            <span class="select-icon"><svg><use href="#icon-chevron-down"></use></svg></span>
                        </div>
                        <div class="select-wrapper">
                            <select id="filterStatus" class="select">
                                <option value="">üîΩ Todos os Status</option>
                                <!-- Op√ß√µes de status carregadas via JS -->
                            </select>
                             <span class="select-icon"><svg><use href="#icon-chevron-down"></use></svg></span>
                        </div>
                    </div>
                </div>

                <div class="transactions-table-container">
                    <table class="transactions-table" id="transactionsTable">
                        <thead>
                            <tr>
                                <th class="col-icon"></th> <!-- √çcone -->
                                <th class="sortable" data-sort="date">Data <span class="transaction-sort-icon"><svg><use href="#icon-sort-none"></use></svg></span></th>
                                <th class="sortable" data-sort="pessoa">Pessoa <span class="transaction-sort-icon"><svg><use href="#icon-sort-none"></use></svg></span></th>
                                <th class="sortable" data-sort="name">Descri√ß√£o <span class="transaction-sort-icon"><svg><use href="#icon-sort-none"></use></svg></span></th>
                                <th class="sortable" data-sort="category">Categoria <span class="transaction-sort-icon"><svg><use href="#icon-sort-none"></use></svg></span></th>
                                <th class="sortable" data-sort="type">Tipo <span class="transaction-sort-icon"><svg><use href="#icon-sort-none"></use></svg></span></th> <!-- Nova coluna B1 -->
                                <th class="sortable col-value" data-sort="amount">Valor <span class="transaction-sort-icon"><svg><use href="#icon-sort-none"></use></svg></span></th>
                                <th class="col-status sortable" data-sort="status">Status <span class="transaction-sort-icon"><svg><use href="#icon-sort-none"></use></svg></span></th>
                                <th class="col-actions">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTableBody">
                            <!-- Linhas da tabela ser√£o inseridas via JS -->
                             <tr>
                                <td colspan="9" style="text-align: center; padding: var(--spacing-xl);">Carregando transa√ß√µes...</td>
                             </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </section> <!-- Fim #dashboardSection -->

         <!-- Se√ß√£o de Investimentos (Inicialmente Oculta) -->
        <section id="investmentsSection">
            <!-- Conte√∫do da Tela 1: Vis√£o Geral -->
            <div id="investmentOverview">
                <div class="investments-header">
                    <h2 class="investments-title">Investimentos</h2>
                    <button class="btn btn-primary" id="newInvestmentBtn">
                        <svg><use href="#icon-plus"></use></svg>
                        Novo Investimento
                    </button>
                </div>
                <div class="investments-grid" id="investmentsGrid">
                    <!-- Cards de investimento ser√£o inseridos aqui -->
                     <p>Carregando investimentos...</p>
                </div>
            </div>

             <!-- Conte√∫do da Tela 2: Detalhes (Inicialmente Oculto) -->
             <div id="investmentDetailSection">
                 <div class="investment-detail-header">
                     <h2 class="investment-detail-title" id="investmentDetailTitle">Detalhe do Investimento</h2>
                     <button class="btn btn-outline" id="backToInvestmentsBtn">
                         <svg><use href="#icon-chevron-left"></use></svg>
                         Voltar
                     </button>
                 </div>
                 <div class="investment-detail-summary" id="investmentDetailSummary">
                     <!-- Detalhes do investimento (Nome, Meta, Progresso) -->
                 </div>

                 <div class="investment-aportes-header">
                     <h3 class="investment-aportes-title">Hist√≥rico de Aportes</h3>
                     <button class="btn btn-success" id="addAporteBtn">
                         <svg><use href="#icon-plus"></use></svg>
                         Adicionar Valor
                     </button>
                 </div>
                 <div class="investment-aportes-table-container">
                    <table class="investment-aportes-table" id="investmentAportesTable">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Descri√ß√£o</th>
                                <th class="col-value">Valor</th>
                                <th class="col-actions">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="investmentAportesTableBody">
                            <!-- Aportes ser√£o listados aqui -->
                        </tbody>
                    </table>
                </div>
                 <div style="margin-top: var(--spacing-lg); display: flex; justify-content: flex-end; gap: var(--spacing-sm);">
                     <button class="btn btn-outline" id="editInvestmentDetailBtn">
                          <svg><use href="#icon-edit"></use></svg> Editar Objetivo
                     </button>
                     <button class="btn btn-danger" id="deleteInvestmentDetailBtn">
                         <svg><use href="#icon-trash"></use></svg> Excluir Objetivo
                     </button>
                 </div>
             </div>
        </section> <!-- Fim #investmentsSection -->

    </main>

    <!-- ====================================================== -->
    <!-- MODAIS (Estrutura baseada no c√≥digo antigo) -->
    <!-- ====================================================== -->

    <!-- Modal de Nova Receita/Despesa (Unificado para Edi√ß√£o) -->
    <div class="modal-backdrop" id="transactionModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="transactionModalTitle">Nova Transa√ß√£o</h2>
                <button class="modal-close" id="closeTransactionModal"><svg><use href="#icon-x"></use></svg></button>
            </div>
            <div class="modal-body">
                <form id="transactionForm">
                    <input type="hidden" id="transactionId">
                    <input type="hidden" id="transactionType"> <!-- 'income' or 'expense' -->

                    <div class="form-group">
                        <label class="form-label" for="transactionName">Nome / Descri√ß√£o</label>
                        <input type="text" class="form-control" id="transactionName" placeholder="Ex: Sal√°rio, Aluguel, Compras Mercado">
                    </div>

                     <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                        <div class="form-group">
                            <label class="form-label" for="transactionAmount">Valor</label>
                            <input type="number" class="form-control" id="transactionAmount" placeholder="0,00" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="transactionDate">Data</label>
                            <input type="date" class="form-control" id="transactionDate">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="transactionCategory">Categoria</label>
                        <div class="select-wrapper">
                            <select class="select" id="transactionCategory">
                                <!-- Op√ß√µes carregadas via JS -->
                            </select>
                            <span class="select-icon"><svg><use href="#icon-chevron-down"></use></svg></span>
                        </div>
                    </div>

                    <!-- Campos Espec√≠ficos de Despesa -->
                    <div id="expenseFields" style="display: none;">
                        <div class="form-group">
                            <label class="form-label" for="transactionPessoa">Pessoa</label> <!-- B1: Campo Pessoa -->
                            <div class="select-wrapper">
                                <select class="select" id="transactionPessoa">
                                     <option value="">Ningu√©m espec√≠fico</option>
                                    <!-- Op√ß√µes de pessoas carregadas via JS -->
                                </select>
                                <span class="select-icon"><svg><use href="#icon-chevron-down"></use></svg></span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="transactionTipoDespesa">Tipo de Despesa</label> <!-- B3: Campo Tipo -->
                             <div class="radio-group">
                                <label class="radio-wrapper">
                                    <input type="radio" class="radio" name="transactionTipo" value="fixed">
                                    <span class="radio-label-circle"></span>
                                    <span class="radio-label-text">Fixa</span>
                                </label>
                                <label class="radio-wrapper">
                                    <input type="radio" class="radio" name="transactionTipo" value="variable" checked>
                                    <span class="radio-label-circle"></span>
                                    <span class="radio-label-text">Vari√°vel</span>
                                </label>
                             </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="transactionPaymentMethod">Forma de Pagamento</label>
                            <div class="select-wrapper">
                                <select class="select" id="transactionPaymentMethod">
                                    <!-- Op√ß√µes carregadas via JS -->
                                </select>
                                <span class="select-icon"><svg><use href="#icon-chevron-down"></use></svg></span>
                            </div>
                        </div>

                        <div class="form-group" id="transactionCreditCardGroup" style="display: none;">
                            <label class="form-label" for="transactionCreditCard">Cart√£o de Cr√©dito</label>
                            <div class="select-wrapper">
                                <select class="select" id="transactionCreditCard">
                                    <!-- Op√ß√µes carregadas via JS -->
                                </select>
                                <span class="select-icon"><svg><use href="#icon-chevron-down"></use></svg></span>
                            </div>
                        </div>

                         <div class="form-group" id="transactionDueDateGroup">
                             <label class="form-label" for="transactionDueDate">Data de Vencimento</label>
                             <input type="date" class="form-control" id="transactionDueDate">
                         </div>
                    </div>

                    <!-- Campos Espec√≠ficos de Receita -->
                     <div id="incomeFields" style="display: none;">
                         <div class="form-group">
                            <label class="form-label" for="incomePaymentMethod">Forma de Recebimento</label>
                            <div class="select-wrapper">
                                <select class="select" id="incomePaymentMethod">
                                    <!-- Op√ß√µes carregadas via JS -->
                                </select>
                                <span class="select-icon"><svg><use href="#icon-chevron-down"></use></svg></span>
                            </div>
                        </div>
                     </div>


                     <div class="form-group">
                        <label class="checkbox-wrapper">
                             <input type="checkbox" class="checkbox" id="transactionIsRecurrent">
                             <span class="checkbox-label-box"></span>
                             <span class="checkbox-label-text">Transa√ß√£o Recorrente</span>
                        </label>
                    </div>

                    <div class="form-group" id="transactionRecurrenceGroup" style="display: none;">
                        <label class="form-label" for="transactionInstallments">Quantidade de Parcelas</label>
                        <input type="number" class="form-control" id="transactionInstallments" min="2" value="2" placeholder="Ex: 12">
                    </div>

                    <div class="form-group" id="transactionStatusGroup">
                        <label class="form-label">Status</label>
                        <div class="radio-group" id="statusOptions">
                            <!-- Op√ß√µes carregadas via JS -->
                        </div>
                    </div>

                     <div class="form-group" id="transactionScheduledDateGroup" style="display: none;">
                         <label class="form-label" for="transactionScheduledDate">Data de Agendamento</label>
                         <input type="date" class="form-control" id="transactionScheduledDate">
                     </div>

                    <div class="form-group">
                        <label class="form-label" for="transactionNotes">Observa√ß√£o (opcional)</label>
                        <textarea class="form-control" id="transactionNotes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelTransactionBtn">Cancelar</button>
                <button class="btn btn-primary" id="saveTransactionBtn">Salvar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Cart√µes -->
    <div class="modal-backdrop" id="cardsModal">
        <div class="modal modal-lg"> <!-- Modal maior para cart√µes -->
            <div class="modal-header">
                <h2 class="modal-title"><svg><use href="#icon-credit-card"></use></svg> Gerenciar Cart√µes</h2>
                <button class="modal-close" id="closeCardsModal"><svg><use href="#icon-x"></use></svg></button>
            </div>
            <div class="modal-body">
                <div id="cardsList" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: var(--spacing-lg);">
                    <!-- Cards ser√£o inseridos aqui -->
                     <p>Carregando cart√µes...</p>
                </div>
            </div>
             <div class="modal-footer">
                 <button class="btn btn-primary" id="openNewCardModalBtn">
                     <svg><use href="#icon-plus"></use></svg> Novo Cart√£o
                 </button>
            </div>
        </div>
    </div>

     <!-- Modal de Novo/Editar Cart√£o -->
    <div class="modal-backdrop" id="newCardModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="cardModalTitle">Novo Cart√£o</h2>
                <button class="modal-close" id="closeNewCardModal"><svg><use href="#icon-x"></use></svg></button>
            </div>
            <div class="modal-body">
                <form id="cardForm">
                    <input type="hidden" id="cardId">
                    <div class="form-group">
                        <label class="form-label" for="cardName">Nome do Cart√£o</label>
                        <input type="text" class="form-control" id="cardName" placeholder="Ex: Nubank Ultravioleta">
                    </div>
                     <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--spacing-md);">
                        <div class="form-group">
                            <label class="form-label" for="cardLimit">Limite Total</label>
                            <input type="number" class="form-control" id="cardLimit" placeholder="0,00" min="0" step="0.01">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="cardClosingDay">Dia Fechamento</label>
                            <input type="number" class="form-control" id="cardClosingDay" placeholder="1-31" min="1" max="31">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="cardDueDay">Dia Vencimento</label>
                            <input type="number" class="form-control" id="cardDueDay" placeholder="1-31" min="1" max="31">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelCardBtn">Cancelar</button>
                <button class="btn btn-primary" id="saveCardBtn">Salvar Cart√£o</button>
            </div>
        </div>
    </div>

    <!-- Modal de Fatura do Cart√£o -->
    <div class="modal-backdrop" id="cardInvoiceModal">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h2 class="modal-title" id="cardInvoiceTitle">Fatura do Cart√£o</h2>
                 <button class="modal-close" id="closeCardInvoiceModal"><svg><use href="#icon-x"></use></svg></button>
            </div>
            <div class="modal-body">
                <div class="card" style="margin-bottom: var(--spacing-md); background-color: var(--color-surface-variant);">
                    <div id="cardInvoiceDetails" style="font-size: var(--font-size-sm);">
                        <!-- Detalhes da fatura -->
                    </div>
                </div>
                <h3 style="margin-bottom: var(--spacing-md); font-size: var(--font-size-md); font-weight: 500;">Despesas desta Fatura</h3>
                <div class="transactions-table-container" style="max-height: 300px; overflow-y: auto;">
                    <table class="transactions-table" id="cardInvoiceTable">
                        <thead>
                            <tr>
                                <th class="col-icon"></th>
                                <th>Descri√ß√£o</th>
                                <th>Data</th>
                                <th class="col-value">Valor</th>
                                <th>Pago?</th>
                            </tr>
                        </thead>
                        <tbody id="cardInvoiceTableBody">
                            <!-- Despesas da fatura -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                 <button class="btn btn-outline" id="backToCardsListBtn">Voltar para Cart√µes</button>
                 <button class="btn btn-primary" id="payInvoiceBtn">Pagar Fatura</button>
            </div>
        </div>
    </div>

     <!-- Modal de Cadastros (Novo Modal Unificado - B2, B9) -->
    <div class="modal-backdrop" id="cadastrosModal">
        <div class="modal modal-lg">
            <div class="modal-header">
                 <h2 class="modal-title"><svg><use href="#icon-cog"></use></svg> Cadastros</h2>
                 <button class="modal-close" id="closeCadastrosModal"><svg><use href="#icon-x"></use></svg></button>
            </div>
            <div class="modal-body" style="padding-top: 0;"> <!-- Remover padding top do body para colar abas -->
                 <ul class="nav-tabs" id="cadastrosTabs">
                    <li class="nav-item"><a class="nav-link active" data-tab="income-cat" href="#">Categorias de Receita</a></li>
                    <li class="nav-item"><a class="nav-link" data-tab="expense-cat" href="#">Categorias de Despesa</a></li>
                    <li class="nav-item"><a class="nav-link" data-tab="payment-methods" href="#">Formas de Pagamento</a></li>
                    <li class="nav-item"><a class="nav-link" data-tab="pessoas" href="#">Pessoas</a></li>
                 </ul>

                 <div class="tab-content" id="cadastrosTabContent" style="padding-top: var(--spacing-lg);">
                     <!-- Aba Categorias de Receita -->
                     <div class="tab-pane active" id="income-cat">
                         <div class="tab-list-container" id="incomeCategoriesList">
                             <!-- Categorias carregadas aqui -->
                             <p style="padding: var(--spacing-md); text-align: center;">Carregando...</p>
                         </div>
                         <form class="add-item-form" id="addIncomeCategoryForm">
                             <div class="custom-icon-input-group">
                                 <span class="custom-icon-preview" id="newIncomeCategoryIconPreview">üí∞</span>
                                 <input type="text" class="form-control" id="newIncomeCategoryIconInput" placeholder="√çcone (Emoji)">
                             </div>
                             <input type="text" class="form-control" id="newIncomeCategoryInput" placeholder="Nome da Nova Categoria de Receita" required>
                             <button type="submit" class="btn btn-primary">Adicionar</button>
                         </form>
                     </div>

                     <!-- Aba Categorias de Despesa -->
                    <div class="tab-pane" id="expense-cat">
                         <div class="tab-list-container" id="expenseCategoriesList">
                             <!-- Categorias carregadas aqui -->
                              <p style="padding: var(--spacing-md); text-align: center;">Carregando...</p>
                         </div>
                         <form class="add-item-form" id="addExpenseCategoryForm">
                             <div class="custom-icon-input-group">
                                 <span class="custom-icon-preview" id="newExpenseCategoryIconPreview">üõí</span>
                                 <input type="text" class="form-control" id="newExpenseCategoryIconInput" placeholder="√çcone (Emoji)">
                             </div>
                             <input type="text" class="form-control" id="newExpenseCategoryInput" placeholder="Nome da Nova Categoria de Despesa" required>
                             <button type="submit" class="btn btn-primary">Adicionar</button>
                         </form>
                     </div>

                     <!-- Aba Formas de Pagamento -->
                     <div class="tab-pane" id="payment-methods">
                         <h4>Formas de Pagamento Cadastradas</h4>
                         <div class="tab-list-container" id="paymentMethodsList">
                             <!-- Formas de pagamento carregadas aqui -->
                              <p style="padding: var(--spacing-md); text-align: center;">Carregando...</p>
                         </div>
                         <h5 style="margin-top: var(--spacing-lg); margin-bottom: var(--spacing-sm); font-weight: 500;">Adicionar Nova Forma</h5>
                         <form class="add-item-form" id="addPaymentMethodForm">
                             <div class="custom-icon-input-group">
                                 <span class="custom-icon-preview" id="newPaymentMethodIconPreview">üí≥</span>
                                 <input type="text" class="form-control" id="newPaymentMethodIconInput" placeholder="√çcone (Emoji)">
                             </div>
                             <input type="text" class="form-control" id="newPaymentMethodInput" placeholder="Nome da Nova Forma de Pagamento" required>
                             <button type="submit" class="btn btn-primary">
                                 <svg><use href="#icon-plus"></use></svg> Adicionar
                             </button>
                         </form>
                     </div>

                     <!-- Aba Pessoas (B2) -->
                    <div class="tab-pane" id="pessoas">
                         <h4>Pessoas Cadastradas</h4>
                         <div class="tab-list-container" id="personList">
                             <!-- Pessoas carregadas aqui -->
                             <p style="padding: var(--spacing-md); text-align: center;">Carregando...</p>
                         </div>
                          <h5 style="margin-top: var(--spacing-lg); margin-bottom: var(--spacing-sm); font-weight: 500;">Adicionar Nova Pessoa</h5>
                         <form class="add-item-form" id="addPersonForm">
                            <!-- N√£o precisa de √≠cone para pessoa -->
                             <input type="text" class="form-control" id="newPersonNameInput" placeholder="Nome da Nova Pessoa" required>
                             <button type="submit" class="btn btn-primary">
                                 <svg><use href="#icon-plus"></use></svg> Adicionar
                             </button>
                         </form>
                     </div>
                 </div> <!-- Fim .tab-content -->
            </div> <!-- Fim .modal-body -->
            <div class="modal-footer">
                <button class="btn btn-outline" id="closeCadastrosModalBtn">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o de Categoria/M√©todo/Pessoa -->
     <div class="modal-backdrop" id="editCadastroItemModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="editCadastroItemTitle">Editar Item</h2>
                <button class="modal-close" id="closeEditCadastroItemModal"><svg><use href="#icon-x"></use></svg></button>
            </div>
            <div class="modal-body">
                <form id="editCadastroItemForm">
                    <input type="hidden" id="editItemId">
                    <input type="hidden" id="editItemType"> <!-- 'incomeCategory', 'expenseCategory', 'paymentMethod', 'person' -->

                    <!-- Campo √çcone (Opcional, n√£o para pessoas) -->
                    <div class="form-group" id="editItemIconGroup">
                        <label class="form-label">√çcone (Opcional)</label>
                        <div class="custom-icon-input-group">
                             <span class="custom-icon-preview" id="editItemIconPreview">‚ùì</span>
                             <input type="text" class="form-control" id="editItemIconInput" placeholder="Emoji">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="editItemName">Nome</label>
                        <input type="text" class="form-control" id="editItemName" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancelEditCadastroItemBtn">Cancelar</button>
                <button class="btn btn-primary" id="saveEditCadastroItemBtn">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o de Exclus√£o (Gen√©rico) -->
    <div class="modal-backdrop" id="deleteConfirmModal">
        <div class="modal" style="max-width: 400px;"> <!-- Modal menor -->
            <div class="modal-header">
                <h2 class="modal-title">
                    <svg style="color: var(--color-error); margin-right: var(--spacing-xs);" width="24" height="24"><use href="#icon-alert"></use></svg>
                    Confirmar Exclus√£o
                 </h2>
                 <button class="modal-close" id="closeDeleteConfirmModal"><svg><use href="#icon-x"></use></svg></button>
            </div>
            <div class="modal-body">
                 <p id="deleteConfirmMessage">Voc√™ tem certeza que deseja excluir este item? Esta a√ß√£o n√£o pode ser desfeita.</p>
                 <!-- Op√ß√µes espec√≠ficas para recorr√™ncia de transa√ß√£o -->
                 <div id="recurrenceDeleteOptions" style="display: none; margin-top: var(--spacing-md);">
                    <p><strong>Esta √© uma transa√ß√£o recorrente. O que deseja fazer?</strong></p>
                    <div class="radio-group" style="flex-direction: column; gap: var(--spacing-sm); align-items: flex-start;">
                         <label class="radio-wrapper">
                            <input type="radio" class="radio" name="deleteRecurrenceOption" value="single" checked>
                            <span class="radio-label-circle"></span>
                            <span class="radio-label-text">Excluir apenas esta ocorr√™ncia</span>
                        </label>
                         <label class="radio-wrapper">
                            <input type="radio" class="radio" name="deleteRecurrenceOption" value="future">
                            <span class="radio-label-circle"></span>
                            <span class="radio-label-text">Excluir esta e todas as futuras</span>
                        </label>
                    </div>
                </div>
                 <!-- Mensagem sobre mover transa√ß√µes (para categorias/m√©todos/pessoas) -->
                 <p id="deleteMoveMessage" style="display: none; margin-top: var(--spacing-md); font-size: var(--font-size-xs); color: var(--color-warning);">
                      As transa√ß√µes associadas ser√£o movidas para uma categoria/m√©todo/pessoa padr√£o.
                 </p>
            </div>
            <div class="modal-footer">
                 <button class="btn btn-outline" id="cancelDeleteBtn">Cancelar</button>
                 <button class="btn btn-danger" id="confirmDeleteBtn">Excluir</button>
            </div>
        </div>
    </div>

     <!-- Modal de Detalhes Contas Vencidas -->
    <div class="modal-backdrop" id="overdueDetailsModal">
        <div class="modal modal-lg">
            <div class="modal-header">
                 <h2 class="modal-title">
                     <svg style="color: var(--color-error); margin-right: var(--spacing-xs);" width="24" height="24"><use href="#icon-alert"></use></svg>
                     Contas Vencidas
                 </h2>
                 <button class="modal-close" id="closeOverdueDetailsModal"><svg><use href="#icon-x"></use></svg></button>
            </div>
            <div class="modal-body">
                 <div class="transactions-table-container" style="max-height: 400px; overflow-y: auto;">
                     <table class="transactions-table" id="overdueTransactionsTable">
                         <thead>
                             <tr>
                                 <th class="col-icon"></th>
                                 <th>Descri√ß√£o</th>
                                 <th>Categoria</th>
                                 <th>Vencimento</th>
                                 <th class="col-value">Valor</th>
                                 <th>A√ß√µes</th>
                             </tr>
                         </thead>
                         <tbody id="overdueTransactionsTableBody">
                             <!-- Contas vencidas carregadas aqui -->
                         </tbody>
                     </table>
                 </div>
            </div>
            <div class="modal-footer">
                 <button class="btn btn-outline" id="closeOverdueDetailsBtn">Fechar</button>
                 <button class="btn btn-success" id="payAllOverdueBtn">Marcar Todas Como Pagas</button>
            </div>
        </div>
    </div>

     <!-- Modal Novo/Editar Investimento (B5, B6) -->
    <div class="modal-backdrop" id="investmentModal">
        <div class="modal">
            <div class="modal-header">
                 <h2 class="modal-title" id="investmentModalTitle">Novo Investimento</h2>
                 <button class="modal-close" id="closeInvestmentModal"><svg><use href="#icon-x"></use></svg></button>
            </div>
            <div class="modal-body">
                 <form id="investmentForm">
                    <input type="hidden" id="investmentId">
                     <div class="form-group">
                         <label class="form-label" for="investmentName">Nome do Objetivo</label>
                         <input type="text" class="form-control" id="investmentName" placeholder="Ex: Viagem em Fam√≠lia 2026" required>
                     </div>
                     <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                         <div class="form-group">
                             <label class="form-label" for="investmentInitialValue">Valor Inicial</label>
                             <input type="number" class="form-control" id="investmentInitialValue" placeholder="0,00" min="0" step="0.01">
                         </div>
                         <div class="form-group">
                             <label class="form-label" for="investmentGoalValue">Meta Final (Opcional)</label>
                             <input type="number" class="form-control" id="investmentGoalValue" placeholder="0,00" min="0" step="0.01">
                         </div>
                    </div>
                     <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                         <div class="form-group">
                            <label class="form-label" for="investmentCategory">Categoria</label>
                            <div class="select-wrapper">
                                <select class="select" id="investmentCategory" required>
                                    <option value="" disabled selected>Selecione...</option>
                                    <option value="Viagem">‚úàÔ∏è Viagem</option>
                                    <option value="Emerg√™ncia">üõ°Ô∏è Emerg√™ncia</option>
                                    <option value="Filho">üë∂ Filho</option>
                                    <option value="Aposentadoria">‚è≥ Aposentadoria</option>
                                    <option value="Casa">üè† Casa</option>
                                    <option value="Carro">üöó Carro</option>
                                    <option value="Outro">‚ùì Outro</option>
                                </select>
                                <span class="select-icon"><svg><use href="#icon-chevron-down"></use></svg></span>
                            </div>
                        </div>
                         <div class="form-group">
                             <label class="form-label" for="investmentTargetDate">Data Alvo (Opcional)</label>
                             <input type="date" class="form-control" id="investmentTargetDate">
                         </div>
                     </div>
                     <div class="form-group">
                         <label class="form-label" for="investmentNotes">Observa√ß√µes (Opcional)</label>
                         <textarea class="form-control" id="investmentNotes" rows="3"></textarea>
                     </div>
                 </form>
            </div>
            <div class="modal-footer">
                 <button class="btn btn-outline" id="cancelInvestmentBtn">Cancelar</button>
                 <button class="btn btn-primary" id="saveInvestmentBtn">Salvar Investimento</button>
            </div>
        </div>
    </div>

     <!-- Modal Adicionar Aporte -->
    <div class="modal-backdrop" id="aporteModal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                 <h2 class="modal-title" id="aporteModalTitle">Adicionar Valor</h2>
                 <button class="modal-close" id="closeAporteModal"><svg><use href="#icon-x"></use></svg></button>
            </div>
            <div class="modal-body">
                 <form id="aporteForm">
                     <input type="hidden" id="aporteInvestmentId">
                     <input type="hidden" id="aporteId"> <!-- Para edi√ß√£o -->
                     <div class="form-group">
                         <label class="form-label" for="aporteValue">Valor do Aporte</label>
                         <input type="number" class="form-control" id="aporteValue" placeholder="0,00" min="0" step="0.01" required>
                     </div>
                      <div class="form-group">
                         <label class="form-label" for="aporteDate">Data do Aporte</label>
                         <input type="date" class="form-control" id="aporteDate" required>
                     </div>
                     <div class="form-group">
                         <label class="form-label" for="aporteDescription">Descri√ß√£o (Opcional)</label>
                         <input type="text" class="form-control" id="aporteDescription" placeholder="Ex: Venda do item X, B√¥nus">
                     </div>
                 </form>
            </div>
            <div class="modal-footer">
                 <button class="btn btn-outline" id="cancelAporteBtn">Cancelar</button>
                 <button class="btn btn-success" id="saveAporteBtn">Salvar Aporte</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer">
        <!-- Toasts ser√£o inseridos aqui dinamicamente -->
    </div>

    <!-- ====================================================== -->
    <!-- JAVASCRIPT -->
    <!-- ====================================================== -->
    <script>
        // ===================================================================
        // CHECKLIST DE DESENVOLVIMENTO - APP GEST√ÉO FINANCEIRA V2
        // ===================================================================
        /*
        * CHECKLIST COMPLETO DE TAREFAS (12 TOTAL):
        *
        * (A) Migra√ß√£o e Reestrutura√ß√£o Visual (Base):
        * ‚úÖ A1. Estruturar o HTML base do projeto seguindo ESQUEMA VISUAL COMPLETO.txt e Mockup.html.
        * ‚úÖ A2. Aplicar todo o CSS (estilos, fontes, cores, layout responsivo) definido no Mockup.html, adaptado √† nova estrutura.
        * üîÑ A3. Migrar e adaptar a l√≥gica JavaScript do codigo completo.txt. (Em Andamento - Fun√ß√µes base migradas, necessita integrar com nova UI e dados)
        *
        * (B) Novas Funcionalidades e Corre√ß√µes:
        * ‚¨ú B1. Campo "Pessoas": Adicionar campo ao formul√°rio de despesas e dados.
        * üîÑ B2. Gerenciamento de Pessoas: Criar interface e l√≥gica no modal "Cadastros". (HTML pronto, JS pendente)
        * ‚¨ú B3. KPI/An√°lise Fixas vs. Vari√°veis: Implementar c√°lculo e exibi√ß√£o no KPI [3].
        * ‚¨ú B4. Posicionamento Gr√°fico Consumo/Pessoa: Posicionar ao lado do 12 meses (conforme Schema [5]).
        * üîÑ B5. Se√ß√£o "Investimentos": Criar nova se√ß√£o/tela (Tela 1 e Tela 2 do Schema). (HTML pronto, JS pendente)
        * ‚¨ú B6. Cadastro em Investimentos: Implementar CRUD de categorias de investimento. (Categorias fixas por enquanto)
        * ‚¨ú B7. Filtro por "Pessoas" na lista de transa√ß√µes.
        * ‚¨ú B8. An√°lise por Pessoa: Implementar Gr√°fico (Consumo por Pessoa no Schema [5]).
        * üîÑ B9. Corre√ß√£o Bug Categorias: Listar todas imediatamente no modal "Cadastros". (HTML pronto, JS pendente)
        *
        * PROGRESSO: 2/12 tarefas conclu√≠das (17%)
        * PR√ìXIMA: Continuar migra√ß√£o JS (A3), Focar na integra√ß√£o com Firebase, carregamento de dados, renderiza√ß√£o inicial, funcionalidade dos modais existentes.
        */

        // ======================================================
        // SETUP INICIAL E HELPERS
        // ======================================================
        const $ = selector => document.querySelector(selector);
        const $$ = selector => Array.from(document.querySelectorAll(selector));

        // Estado global da aplica√ß√£o (Combinando estados e adicionando novos)
        const state = {
            year: new Date().getFullYear(),
            month: new Date().getMonth(), // 0-indexed
            transactions: [],
            cards: [],
            pessoas: [], // B1/B2
            investments: [], // B5
            aportes: {}, // B5 - { investmentId: [aporte1, aporte2] }
            filteredTransactions: [],
            sortColumn: 'date',
            sortDirection: 'desc',
            filters: {
                search: '',
                pessoa: '', // B7
                category: '',
                tipoDespesa: '', // B3
                status: ''
            },
            categories: { // Mantendo estrutura do c√≥digo antigo
                income: [],
                expense: []
            },
            paymentMethods: [],
            investmentCategories: [ // B6 - Categorias fixas iniciais
                { id: 'Viagem', name: 'Viagem', icon: '‚úàÔ∏è' },
                { id: 'Emerg√™ncia', name: 'Emerg√™ncia', icon: 'üõ°Ô∏è' },
                { id: 'Filho', name: 'Filho', icon: 'üë∂' },
                { id: 'Aposentadoria', name: 'Aposentadoria', icon: '‚è≥' },
                { id: 'Casa', name: 'Casa', icon: 'üè†' },
                { id: 'Carro', name: 'Carro', icon: 'üöó' },
                { id: 'Outro', name: 'Outro', icon: '‚ùì' }
            ],
            currentTheme: 'dark', // Padr√£o inicial
            // Vari√°veis para guardar refer√™ncias de itens em edi√ß√£o/exclus√£o
            currentItemIdToDelete: null,
            currentItemTypeToDelete: null, // 'transaction', 'category', 'paymentMethod', 'person', 'card', 'investment', 'aporte'
            currentItemToDeleteIsRecurrent: false,
            currentItemEditing: null, // Guarda o objeto completo
            currentCardEditing: null,
            currentInvestmentEditing: null,
            currentAporteEditing: null,
            // Controle de navega√ß√£o
            currentSection: 'dashboardSection', // 'dashboardSection', 'investmentsSection', 'investmentDetailSection'
            currentInvestmentDetailId: null,
        };

        // Configura√ß√£o Firebase (Mesma do c√≥digo antigo)
        const firebaseConfig = {
            apiKey: "AIzaSyDvL_nYWhv_8rPouejiWbDZtDCKHYOQyEY", // Substituir pela sua chave real
            authDomain: "calculadora-da-familia.firebaseapp.com",
            projectId: "calculadora-da-familia",
            storageBucket: "calculadora-da-familia.appspot.com",
            messagingSenderId: "69721783786",
            appId: "1:69721783786:web:c4703b5c182e3681e8c693",
            measurementId: "G-YM5TR661S6"
        };

        // Inicializar Firebase com tratamento de erro
        let db;
        try {
            if (!firebase.apps.length) { // Evitar inicializa√ß√£o dupla
                 firebase.initializeApp(firebaseConfig);
            }
            db = firebase.firestore();
            console.log('Firebase inicializado com sucesso.');
            // Tentar habilitar persist√™ncia (opcional, mas bom para offline)
            db.enablePersistence({ synchronizeTabs: true })
              .catch(err => {
                  if (err.code == 'failed-precondition') {
                      console.warn('Persist√™ncia n√£o habilitada, m√∫ltiplas abas abertas?');
                  } else if (err.code == 'unimplemented') {
                      console.warn('Persist√™ncia n√£o suportada neste navegador.');
                  }
              });
        } catch (error) {
            console.error("Erro ao inicializar Firebase: ", error);
            showToast('Erro de conex√£o com o banco de dados. Algumas funcionalidades podem n√£o estar dispon√≠veis.', 'error');
            // Criar um objeto 'db' falso para evitar quebras, mas funcionalidade ser√° limitada
            db = {
                collection: (name) => ({
                    doc: (id) => ({
                        get: () => Promise.resolve({ exists: false, data: () => undefined, id: id || 'fake-id' }),
                        set: () => Promise.reject(new Error('DB n√£o conectado')),
                        update: () => Promise.reject(new Error('DB n√£o conectado')),
                        delete: () => Promise.reject(new Error('DB n√£o conectado')),
                        collection: () => ({ // Para subcole√ß√µes (aportes)
                             add: () => Promise.reject(new Error('DB n√£o conectado')),
                             get: () => Promise.resolve({ empty: true, docs: [] })
                        })
                    }),
                    add: () => Promise.reject(new Error('DB n√£o conectado')),
                    get: () => Promise.resolve({ empty: true, docs: [] }),
                    where: () => ({ get: () => Promise.resolve({ empty: true, docs: [] }) }), // Simular where b√°sico
                    onSnapshot: () => (() => {}) // Fun√ß√£o vazia para listener
                })
            };
        }

        // ======================================================
        // HELPERS E FORMATADORES
        // ======================================================

        const formatCurrency = (value, minimumFractionDigits = 2) => {
             if (typeof value !== 'number' || isNaN(value)) {
                 value = 0;
             }
            return value.toLocaleString('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: minimumFractionDigits,
                maximumFractionDigits: 2 // Garante no m√°ximo 2 casas decimais
            });
        };

        const parseLocalDateString = (dateInput) => {
            if (!dateInput) return null;
            if (dateInput instanceof Date && !isNaN(dateInput)) {
                // Clonar para evitar muta√ß√£o
                return new Date(dateInput.getFullYear(), dateInput.getMonth(), dateInput.getDate());
            }
            // Tentar converter de timestamp do Firestore
            if (typeof dateInput === 'object' && dateInput !== null && typeof dateInput.toDate === 'function') {
                 try {
                     const d = dateInput.toDate();
                     // Retornar data local sem hora/fuso
                     return new Date(d.getFullYear(), d.getMonth(), d.getDate());
                 } catch (e) { return null; }
            }
            // Tentar converter de string ISO YYYY-MM-DD
            if (typeof dateInput === 'string' && /^\d{4}-\d{2}-\d{2}/.test(dateInput)) {
                 // Usar UTC para evitar problemas de fuso ao criar a data
                 const parts = dateInput.substring(0, 10).split('-');
                 // Criar como UTC e depois pegar os componentes locais
                 const utcDate = new Date(Date.UTC(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2])));
                 // Retornar nova data apenas com ano, m√™s e dia locais (sem hora/fuso)
                  return new Date(utcDate.getUTCFullYear(), utcDate.getUTCMonth(), utcDate.getUTCDate());
            }
             // Tentar converter de timestamp num√©rico (milissegundos)
             if (typeof dateInput === 'number' && dateInput > 0) {
                  try {
                      const d = new Date(dateInput);
                      if (!isNaN(d)) {
                          return new Date(d.getFullYear(), d.getMonth(), d.getDate());
                      }
                  } catch(e) { /* Ignorar erro */ }
             }

            return null; // Retorna null se n√£o conseguir parsear
        };

        const formatDate = (date, options = { day: '2-digit', month: '2-digit', year: 'numeric' }) => {
            const dateObj = parseLocalDateString(date);
            if (!dateObj) return '--/--/----';
            return dateObj.toLocaleDateString('pt-BR', options);
        };

        // Converte um objeto Date local para string YYYY-MM-DD
        const dateToISOLocal = (date) => {
             if (!date) return '';
             const d = parseLocalDateString(date); // Garante que temos um objeto Date limpo
             if (!d) return '';
             const year = d.getFullYear();
             const month = String(d.getMonth() + 1).padStart(2, '0');
             const day = String(d.getDate()).padStart(2, '0');
             return `${year}-${month}-${day}`;
        };

        // Define o valor de um input date
        const setDateInputValue = (inputId, date) => {
            const input = $(`#${inputId}`);
            if (input) {
                 input.value = dateToISOLocal(date);
            }
        };

        // Obt√©m o valor de um input date como objeto Date
        const getDateInputValue = (inputId) => {
            const input = $(`#${inputId}`);
            return input ? parseLocalDateString(input.value) : null;
        };

        const generateId = () => {
             // Usa o m√©todo do pr√≥prio Firestore para gerar IDs offline-compat√≠veis
             return db.collection('temp').doc().id;
        };

        // ======================================================
        // TOAST NOTIFICATIONS
        // ======================================================
        const showToast = (message, type = 'success', duration = 4000) => {
            const toastContainer = $('#toastContainer');
            if (!toastContainer) return;

            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;

            let iconName;
            switch (type) {
                case 'success': iconName = 'icon-check'; break;
                case 'error': iconName = 'icon-alert'; break; // Usar alert para erro
                case 'warning': iconName = 'icon-alert'; break;
                case 'info': iconName = 'icon-info'; break;
                default: iconName = 'icon-info';
            }

            toast.innerHTML = `
                <div class="toast-icon">
                    <svg width="24" height="24"><use href="#${iconName}"></use></svg>
                </div>
                <div class="toast-content">${message}</div>
                <button class="toast-close">
                    <svg width="14" height="14"><use href="#icon-x"></use></svg>
                </button>
            `;

            const closeBtn = toast.querySelector('.toast-close');
            const removeToast = () => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(120%)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300); // Tempo para anima√ß√£o de sa√≠da
            };

            closeBtn.addEventListener('click', removeToast);
            toastContainer.appendChild(toast);

            // Anima√ß√£o de entrada
            requestAnimationFrame(() => {
                 requestAnimationFrame(() => {
                     toast.classList.add('show');
                 });
            });


            // Auto remover
            setTimeout(removeToast, duration);
        };

        // ======================================================
        // MODAL HANDLING
        // ======================================================
        const openModal = (modalId) => {
            const modal = $(`#${modalId}`);
            if (!modal) {
                 console.error(`Modal com ID "${modalId}" n√£o encontrado.`);
                 return;
            }
            // Fechar outros modais abertos para evitar sobreposi√ß√£o
            closeAllModals();
            modal.classList.add('active');
            document.body.style.overflow = 'hidden'; // Trava scroll do body
        };

        const closeModal = (modalId) => {
            const modal = $(`#${modalId}`);
            if (modal) {
                 modal.classList.remove('active');
                 // Verifica se h√° outros modais ativos antes de liberar o scroll
                 if (!$$('.modal-backdrop.active').length) {
                    document.body.style.overflow = '';
                 }
            }
        };

        const closeAllModals = () => {
            $$('.modal-backdrop.active').forEach(modal => modal.classList.remove('active'));
            document.body.style.overflow = '';
        };

        // Fechar modal clicando no backdrop (fora do conte√∫do)
         document.addEventListener('click', (event) => {
             if (event.target.classList.contains('modal-backdrop')) {
                 closeAllModals();
             }
         });
         // Fechar modal com a tecla ESC
         document.addEventListener('keydown', (event) => {
             if (event.key === 'Escape') {
                 closeAllModals();
             }
         });

        // ======================================================
        // THEME HANDLING
        // ======================================================
        const applyTheme = (theme) => {
            document.documentElement.setAttribute('data-theme', theme);
            state.currentTheme = theme;
            // Atualizar cores dos gr√°ficos
            updateChartColors();
             // Atualizar cor de fundo do header com transpar√™ncia
             const header = $('.header');
             if (header) {
                 const rootStyle = getComputedStyle(document.documentElement);
                 let bgRgb;
                 if (theme === 'dark') {
                      bgRgb = rootStyle.getPropertyValue('--color-background').trim() === '#000000' ? '0, 0, 0' : '28, 28, 30'; // Adapta se o fundo for preto puro
                 } else {
                      bgRgb = rootStyle.getPropertyValue('--color-background').trim() === '#ffffff' ? '255, 255, 255' : '245, 245, 247';
                 }
                  document.documentElement.style.setProperty('--color-background-rgb', bgRgb); // Define a vari√°vel para o CSS usar
             }
        };

        const toggleTheme = () => {
            const newTheme = state.currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(newTheme);
            localStorage.setItem('themePreference', newTheme);
        };

        const initTheme = () => {
            const savedTheme = localStorage.getItem('themePreference');
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const initialTheme = savedTheme || (prefersDark ? 'dark' : 'light');
            applyTheme(initialTheme);
            // Adicionar listener ao bot√£o
             $('#themeToggle')?.addEventListener('click', toggleTheme);
        };

        // ======================================================
        // CHART HANDLING
        // ======================================================
        let catPieChart = null;
        let cardAreaChart = null;
        let annualBarsChart = null;
        let personSpendingChart = null; // B8

        const chartColors = [ // Paleta de cores consistentes
            '#007AFF', '#34C759', '#FF9500', '#FF3B30', '#AF52DE',
            '#5E5CE6', '#FF2D55', '#FFCC00', '#5AC8FA', '#32ADE6',
            '#64D2FF', '#BF5AF2'
        ];

        const getChartColors = (numColors) => {
             // Repete a paleta se precisar de mais cores
             const colors = [];
             for (let i = 0; i < numColors; i++) {
                 colors.push(chartColors[i % chartColors.length]);
             }
             return colors;
        };

        const updateChartColors = () => {
            const isDark = state.currentTheme === 'dark';
            const textColor = isDark ? '#f5f5f7' : '#1d1d1f';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const tooltipBg = isDark ? 'rgba(28, 28, 30, 0.9)' : 'rgba(255, 255, 255, 0.9)';
            const tooltipBorder = isDark ? 'rgba(255, 255, 255, 0.2)' : 'rgba(0, 0, 0, 0.1)';
            const doughnutBorder = isDark ? '#000000' : '#ffffff';

             // Configura√ß√µes Globais
             Chart.defaults.color = textColor;
             Chart.defaults.borderColor = gridColor;
             Chart.defaults.plugins.tooltip.backgroundColor = tooltipBg;
             Chart.defaults.plugins.tooltip.titleColor = textColor;
             Chart.defaults.plugins.tooltip.bodyColor = textColor;
             Chart.defaults.plugins.tooltip.borderColor = tooltipBorder;
             Chart.defaults.plugins.tooltip.borderWidth = 1;
             Chart.defaults.plugins.legend.labels.color = textColor;


             // Atualiza gr√°ficos existentes
             [catPieChart, cardAreaChart, annualBarsChart, personSpendingChart].forEach(chart => {
                 if (chart) {
                     // Cores de eixos e grades
                     if (chart.options.scales) {
                         Object.values(chart.options.scales).forEach(axis => {
                             if (axis.ticks) axis.ticks.color = textColor;
                             if (axis.grid) axis.grid.color = gridColor;
                         });
                     }
                      // Borda do Doughnut
                     if(chart.config.type === 'doughnut' && chart.data.datasets[0]) {
                         chart.data.datasets[0].borderColor = doughnutBorder;
                     }
                     chart.update('none'); // Atualiza sem reanimar
                 }
             });
        };

        const createCharts = () => {
            try {
                const pieCtx = document.getElementById('catPieChart')?.getContext('2d');
                const areaCtx = document.getElementById('cardAreaChart')?.getContext('2d');
                const barCtx = document.getElementById('annualBarsChart')?.getContext('2d');
                const personCtx = document.getElementById('personSpendingChart')?.getContext('2d'); // B8

                 // Gr√°fico Pizza - Despesas por Categoria
                 if (pieCtx && !catPieChart) {
                     catPieChart = new Chart(pieCtx, {
                         type: 'doughnut',
                         data: { labels: [], datasets: [{ data: [], backgroundColor: [], borderWidth: 2 }] },
                         options: {
                             responsive: true, maintainAspectRatio: false,
                             plugins: {
                                 legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true, pointStyle: 'circle' } },
                                 tooltip: { callbacks: {
                                     label: ctx => `${ctx.label}: ${formatCurrency(ctx.parsed)} (${((ctx.parsed / ctx.chart.getDatasetMeta(0).total) * 100).toFixed(0)}%)`
                                 }}
                             },
                             cutout: '60%' // Furo no meio
                         }
                     });
                 }

                 // Gr√°fico √Årea - Limite do Cart√£o
                 if (areaCtx && !cardAreaChart) {
                     cardAreaChart = new Chart(areaCtx, {
                         type: 'line',
                         data: { labels: [], datasets: [
                             { label: 'Utilizado', data: [], fill: true, backgroundColor: 'rgba(255, 59, 48, 0.2)', borderColor: 'rgba(255, 59, 48, 1)', tension: 0.3, pointRadius: 0 },
                             { label: 'Dispon√≠vel', data: [], fill: false, borderColor: 'rgba(52, 199, 89, 1)', tension: 0.3, pointRadius: 0, borderDash: [3, 3] },
                             { label: 'Limite Total', data: [], fill: false, borderColor: 'rgba(0, 122, 255, 0.5)', pointRadius: 0, borderDash: [5, 5] }
                         ]},
                         options: {
                             responsive: true, maintainAspectRatio: false,
                             scales: { y: { beginAtZero: true, ticks: { callback: v => formatCurrency(v, 0) } } },
                             plugins: { tooltip: { mode: 'index', intersect: false, callbacks: { label: ctx => `${ctx.dataset.label}: ${formatCurrency(ctx.parsed.y)}` } } }
                         }
                     });
                 }

                 // Gr√°fico Barras - Receitas x Despesas (12 meses)
                 if (barCtx && !annualBarsChart) {
                     annualBarsChart = new Chart(barCtx, {
                         type: 'bar',
                         data: { labels: [], datasets: [
                             { label: 'Receitas', data: [], backgroundColor: 'rgba(52, 199, 89, 0.7)' },
                             { label: 'Despesas', data: [], backgroundColor: 'rgba(255, 59, 48, 0.7)' }
                         ]},
                         options: {
                             responsive: true, maintainAspectRatio: false,
                             scales: { x: { grid: { display: false } }, y: { beginAtZero: true, ticks: { callback: v => formatCurrency(v, 0) } } },
                             plugins: { tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${formatCurrency(ctx.parsed.y)}` } } }
                         }
                     });
                 }

                 // B8: Gr√°fico Consumo por Pessoa (Ex: Barras Horizontais)
                 if (personCtx && !personSpendingChart) {
                      personSpendingChart = new Chart(personCtx, {
                         type: 'bar', // Usar 'bar' para barras horizontais
                         data: { labels: [], datasets: [{ label: 'Gasto', data: [], backgroundColor: [], borderWidth: 0 }] },
                         options: {
                             indexAxis: 'y', // Eixo Y como principal (barras horizontais)
                             responsive: true, maintainAspectRatio: false,
                             scales: { x: { beginAtZero: true, ticks: { callback: v => formatCurrency(v, 0) } }, y: { grid: { display: false } } },
                             plugins: {
                                 legend: { display: false }, // Legenda desnecess√°ria aqui
                                 tooltip: { callbacks: { label: ctx => `${ctx.label}: ${formatCurrency(ctx.parsed.x)}` } } // Usar parsed.x para barras horizontais
                             }
                         }
                     });
                 }

                updateChartColors(); // Aplica cores iniciais

            } catch (error) {
                console.error("Erro ao criar gr√°ficos:", error);
                showToast('N√£o foi poss√≠vel carregar os gr√°ficos.', 'error');
            }
        };

        // ======================================================
        // DATA HANDLING (Firebase Interaction - CRUD)
        // ======================================================

        // Carregar dados iniciais
        const loadInitialData = async () => {
            console.log("Carregando dados iniciais do Firebase...");
             const loadingPromises = [
                 loadFirebaseData('categories', 'categories.income', 'categories.expense'), // Carrega categorias
                 loadFirebaseData('paymentMethods', 'paymentMethods'),                   // Carrega m√©todos de pagamento
                 loadFirebaseData('pessoas', 'pessoas'),                               // B2: Carrega pessoas
                 loadFirebaseData('cards', 'cards'),                                   // Carrega cart√µes
                 loadFirebaseData('investments', 'investments'),                       // B5: Carrega investimentos
                 loadFirebaseData('transactions', 'transactions')                        // Carrega transa√ß√µes
             ];

            try {
                await Promise.all(loadingPromises);
                 console.log("Dados iniciais carregados.");

                 // Carregar aportes ap√≥s investimentos
                 await loadAllAportes(); // B5

                 // Ap√≥s carregar tudo, popular selects e renderizar UI
                 populateYearMonthSelectors();
                 populateCategorySelects();
                 populatePaymentMethodSelects();
                 populatePessoaSelects(); // B1/B7
                 populateStatusSelects();
                 populateCardSelects();

                 filterAndRender(); // Filtra e renderiza tudo
                 createCharts(); // Cria os gr√°ficos agora que os dados est√£o carregados
                 updateAllUI(); // Atualiza KPIs e gr√°ficos

                 // B9: Renderizar listas no modal Cadastros imediatamente
                 renderCategoriesList('income', '#incomeCategoriesList');
                 renderCategoriesList('expense', '#expenseCategoriesList');
                 renderList('paymentMethods', '#paymentMethodsList', renderPaymentMethodItem);
                 renderList('pessoas', '#personList', renderPersonItem); // B2


            } catch (error) {
                 console.error("Erro fatal ao carregar dados:", error);
                 showToast('Erro ao carregar dados essenciais. Recarregue a p√°gina.', 'error', 10000);
            }
        };

         const loadFirebaseData = async (collectionName, stateKeyIncome, stateKeyExpense = null) => {
            try {
                 console.log(`Carregando cole√ß√£o: ${collectionName}`);
                 const snapshot = await db.collection(collectionName).get();
                 let items = [];
                 if (!snapshot.empty) {
                     items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 }
                 console.log(`${items.length} itens carregados de ${collectionName}`);

                 if (stateKeyExpense) { // Caso especial de categorias (income/expense)
                     state[stateKeyIncome.split('.')[0]][stateKeyIncome.split('.')[1]] = items.filter(item => item.type === 'income');
                     state[stateKeyExpense.split('.')[0]][stateKeyExpense.split('.')[1]] = items.filter(item => item.type === 'expense');
                 } else if (stateKeyIncome.includes('.')) { // Para nested state como categories.income
                      const keys = stateKeyIncome.split('.');
                      state[keys[0]][keys[1]] = items;
                 }
                 else {
                     state[stateKeyIncome] = items;
                 }
                 return items; // Retorna os itens carregados
            } catch (error) {
                 console.error(`Erro ao carregar ${collectionName}:`, error);
                 showToast(`Falha ao carregar ${collectionName}.`, 'error');
                 throw error; // Re-lan√ßa o erro para parar o Promise.all se necess√°rio
            }
        };

        // --- Fun√ß√µes CRUD Gen√©ricas ---
        const addItem = async (collectionName, data, stateKey) => {
             try {
                 const docRef = await db.collection(collectionName).add(data);
                 const newItem = { id: docRef.id, ...data };
                 // Adiciona ao estado local
                 if (stateKey.includes('.')) {
                      const keys = stateKey.split('.');
                      state[keys[0]][keys[1]].push(newItem);
                 } else {
                      state[stateKey].push(newItem);
                 }
                 return newItem; // Retorna o item adicionado com ID
             } catch (error) {
                 console.error(`Erro ao adicionar item em ${collectionName}:`, error);
                 showToast(`Erro ao salvar ${collectionName.slice(0, -1)}.`, 'error');
                 return null;
             }
         };

        const updateItem = async (collectionName, itemId, updates, stateKey) => {
            try {
                await db.collection(collectionName).doc(itemId).update(updates);
                 // Atualiza no estado local
                 const updateState = (items) => {
                     const index = items.findIndex(item => item.id === itemId);
                     if (index !== -1) {
                         items[index] = { ...items[index], ...updates };
                         return true;
                     }
                     return false;
                 };

                 let updated = false;
                 if (stateKey.includes('.')) {
                     const keys = stateKey.split('.');
                     updated = updateState(state[keys[0]][keys[1]]);
                 } else {
                     updated = updateState(state[stateKey]);
                 }
                 return updated;
            } catch (error) {
                 console.error(`Erro ao atualizar item ${itemId} em ${collectionName}:`, error);
                 showToast(`Erro ao atualizar ${collectionName.slice(0, -1)}.`, 'error');
                 return false;
            }
        };

        const deleteItem = async (collectionName, itemId, stateKey) => {
             try {
                 await db.collection(collectionName).doc(itemId).delete();
                  // Remove do estado local
                 const filterState = (items) => items.filter(item => item.id !== itemId);

                 if (stateKey.includes('.')) {
                     const keys = stateKey.split('.');
                     state[keys[0]][keys[1]] = filterState(state[keys[0]][keys[1]]);
                 } else {
                     state[stateKey] = filterState(state[stateKey]);
                 }
                 return true;
             } catch (error) {
                 console.error(`Erro ao excluir item ${itemId} de ${collectionName}:`, error);
                 showToast(`Erro ao excluir ${collectionName.slice(0, -1)}.`, 'error');
                 return false;
             }
         };

         // --- Fun√ß√µes CRUD Espec√≠ficas (com l√≥gica de neg√≥cio) ---

         // TRANSAC√ïES
         const addTransaction = async (data) => {
             console.log("Adicionando transa√ß√£o:", data);
             // Preparar dados para Firestore (converter Date para Timestamp)
             const dataToSave = { ...data };
             if (data.date) dataToSave.date = firebase.firestore.Timestamp.fromDate(data.date);
             if (data.dueDate) dataToSave.dueDate = firebase.firestore.Timestamp.fromDate(data.dueDate);
             if (data.scheduledDate) dataToSave.scheduledDate = firebase.firestore.Timestamp.fromDate(data.scheduledDate);
             dataToSave.createdAt = firebase.firestore.FieldValue.serverTimestamp(); // Usar timestamp do servidor

             // B1: Garantir que 'pessoa' e 'tipoDespesa' existam, mesmo que vazios/nulos
             dataToSave.pessoaId = data.pessoaId || null;
             dataToSave.pessoaName = data.pessoaName || null;
             dataToSave.tipoDespesa = data.tipoDespesa || (data.type === 'expense' ? 'variable' : null); // Default para vari√°vel em despesas

             // Buscar nomes/√≠cones de categoria e m√©todo
             const category = findCategoryById(data.category, data.type);
             const paymentMethod = findPaymentMethodById(data.paymentMethod);
             const pessoa = findPessoaById(data.pessoaId); // B1

             dataToSave.categoryName = category ? category.name : data.category;
             dataToSave.categoryIcon = category ? category.icon : (data.type === 'income' ? 'üí∞' : 'üõí');
             dataToSave.paymentMethodName = paymentMethod ? paymentMethod.name : data.paymentMethod;
             dataToSave.paymentMethodIcon = paymentMethod ? paymentMethod.icon : '‚ùì';
             dataToSave.pessoaName = pessoa ? pessoa.name : null; // B1

             // Processar recorr√™ncia
             if (dataToSave.isRecurrent && dataToSave.installments > 1) {
                 const recurrenceId = generateId();
                 const originalAmount = parseFloat(data.amount);
                 const installmentAmount = parseFloat((originalAmount / dataToSave.installments).toFixed(2));
                 dataToSave.recurrenceId = recurrenceId;
                 dataToSave.installmentNumber = 1;
                 dataToSave.amount = installmentAmount; // Valor da primeira parcela

                 const baseDate = data.date;
                 let baseDueDate = data.dueDate;
                 const batch = db.batch();
                 const futureParcelsState = [];

                 for (let i = 1; i < dataToSave.installments; i++) {
                     const nextDate = new Date(baseDate);
                     nextDate.setMonth(baseDate.getMonth() + i);

                     let nextDueDate = null;
                     if (baseDueDate) {
                          nextDueDate = new Date(baseDueDate);
                          nextDueDate.setMonth(baseDueDate.getMonth() + i);
                     }

                     const parcelData = {
                         ...dataToSave, // Copia dados da primeira parcela
                         amount: installmentAmount,
                         date: firebase.firestore.Timestamp.fromDate(nextDate),
                         dueDate: nextDueDate ? firebase.firestore.Timestamp.fromDate(nextDueDate) : null,
                         installmentNumber: i + 1,
                         status: data.type === 'income' ? 'pending' : 'pending', // Parcelas futuras sempre pendentes
                         createdAt: firebase.firestore.FieldValue.serverTimestamp(), // Timestamp diferente para cada
                         recurrenceId: recurrenceId,
                     };
                     delete parcelData.id; // Remover ID se existir
                     const docRef = db.collection('transactions').doc(); // Novo ID para cada parcela
                     batch.set(docRef, parcelData);
                      // Adiciona ao estado local (com ID simulado antes do commit)
                     futureParcelsState.push({ ...parcelData, id: docRef.id, date: nextDate, dueDate: nextDueDate });
                 }
                  // Salvar a primeira parcela ANTES do batch para obter o ID real, se necess√°rio
                 const savedFirstParcel = await addItem('transactions', dataToSave, 'transactions');
                 if (!savedFirstParcel) return null; // Falha ao salvar a primeira

                 // Adicionar parcelas futuras ao estado local (com IDs reais ap√≥s commit)
                 try {
                     await batch.commit();
                     // Atualizar estado local com dados corretos p√≥s-commit (datas convertidas de volta)
                     state.transactions.push(...futureParcelsState.map(p => ({
                          ...p,
                          date: p.date, // J√° s√£o objetos Date
                          dueDate: p.dueDate
                     })));
                     console.log(`${futureParcelsState.length} parcelas futuras criadas.`);
                 } catch(batchError) {
                      console.error("Erro ao salvar parcelas futuras:", batchError);
                      showToast('Erro ao salvar parcelas futuras.', 'error');
                      // Tentar reverter a primeira parcela? (Complexo)
                      return savedFirstParcel; // Retorna a primeira que foi salva
                 }

                 // Ajustar cart√£o de cr√©dito para o valor total da compra, n√£o da parcela
                 if (dataToSave.paymentMethod === 'credito' && dataToSave.creditCardId) {
                    await updateCardBalance(dataToSave.creditCardId, originalAmount - installmentAmount, 'expense'); // Ajusta a diferen√ßa
                 }
                 return savedFirstParcel;

             } else {
                 // Transa√ß√£o √∫nica
                 const savedItem = await addItem('transactions', dataToSave, 'transactions');
                  if (savedItem && savedItem.paymentMethod === 'credito' && savedItem.creditCardId && savedItem.type === 'expense') {
                     await updateCardBalance(savedItem.creditCardId, savedItem.amount, 'expense');
                 }
                 return savedItem;
             }
         };

        const updateTransaction = async (itemId, updates) => {
             console.log(`Atualizando transa√ß√£o ${itemId}:`, updates);
             const originalTransaction = state.transactions.find(t => t.id === itemId);
             if (!originalTransaction) return false;

             const dataToSave = { ...updates };

             // Converter datas para Timestamp do Firebase
             if (updates.date) dataToSave.date = firebase.firestore.Timestamp.fromDate(updates.date);
             if (updates.dueDate) dataToSave.dueDate = firebase.firestore.Timestamp.fromDate(updates.dueDate);
             if (updates.scheduledDate) dataToSave.scheduledDate = firebase.firestore.Timestamp.fromDate(updates.scheduledDate);

             // Atualizar nomes/√≠cones se categoria/m√©todo/pessoa mudar
             if (updates.category && updates.category !== originalTransaction.category) {
                 const cat = findCategoryById(updates.category, originalTransaction.type);
                 if (cat) { dataToSave.categoryName = cat.name; dataToSave.categoryIcon = cat.icon; }
             }
             if (updates.paymentMethod && updates.paymentMethod !== originalTransaction.paymentMethod) {
                 const pm = findPaymentMethodById(updates.paymentMethod);
                 if (pm) { dataToSave.paymentMethodName = pm.name; dataToSave.paymentMethodIcon = pm.icon; }
                 // Limpa cart√£o se n√£o for mais cr√©dito
                 if(updates.paymentMethod !== 'credito') {
                      dataToSave.creditCardId = null;
                      dataToSave.creditCardName = null;
                 }
             }
             if (updates.pessoaId && updates.pessoaId !== originalTransaction.pessoaId) { // B1
                 const p = findPessoaById(updates.pessoaId);
                 dataToSave.pessoaName = p ? p.name : null;
             } else if (updates.hasOwnProperty('pessoaId') && updates.pessoaId === null) { // B1 - Se removeu a pessoa
                  dataToSave.pessoaName = null;
             }

              // Ajustar saldo do cart√£o se valor, tipo ou cart√£o mudarem
             let balanceAdjustment = 0;
             let oldCardId = originalTransaction.creditCardId;
             let newCardId = updates.creditCardId !== undefined ? updates.creditCardId : originalTransaction.creditCardId;

             if (originalTransaction.type === 'expense' && originalTransaction.paymentMethod === 'credito' && oldCardId) {
                 // Se mudou valor, remove o valor antigo do cart√£o original
                 if (updates.amount && parseFloat(updates.amount) !== parseFloat(originalTransaction.amount)) {
                     balanceAdjustment -= parseFloat(originalTransaction.amount);
                 }
                 // Se mudou de cart√£o ou deixou de ser cart√£o, remove valor antigo do cart√£o original
                 else if ((updates.paymentMethod && updates.paymentMethod !== 'credito') || (updates.creditCardId !== undefined && updates.creditCardId !== oldCardId)) {
                      balanceAdjustment -= parseFloat(originalTransaction.amount);
                 }
             }
              // Adiciona o novo valor ao novo cart√£o (se aplic√°vel)
             if (updates.type === 'expense' || (updates.type === undefined && originalTransaction.type === 'expense')) {
                  const finalPaymentMethod = updates.paymentMethod || originalTransaction.paymentMethod;
                  if (finalPaymentMethod === 'credito' && newCardId) {
                       const finalAmount = parseFloat(updates.amount || originalTransaction.amount);
                       if (!isNaN(finalAmount)) {
                            balanceAdjustment += finalAmount;
                       }
                  }
             }

             // Aplica ajustes aos cart√µes ANTES de salvar a transa√ß√£o
             if (balanceAdjustment !== 0) {
                 // Reverte no cart√£o antigo
                 if (oldCardId && (updates.paymentMethod !== 'credito' || newCardId !== oldCardId)) {
                      await updateCardBalance(oldCardId, -parseFloat(originalTransaction.amount), 'expense'); // Reverte valor antigo
                 }
                 // Aplica no novo cart√£o
                 if (newCardId && (updates.paymentMethod === 'credito' || originalTransaction.paymentMethod === 'credito')) {
                      const finalAmount = parseFloat(updates.amount || originalTransaction.amount);
                       if (!isNaN(finalAmount)) {
                             await updateCardBalance(newCardId, finalAmount, 'expense'); // Aplica valor novo/atual
                       }
                 }
             }


             const success = await updateItem('transactions', itemId, dataToSave, 'transactions');
             return success;
        };

         const deleteTransaction = async (itemId, deleteOption = 'single') => {
            console.log(`Excluindo transa√ß√£o ${itemId}, op√ß√£o: ${deleteOption}`);
            const transaction = state.transactions.find(t => t.id === itemId);
            if (!transaction) return false;

            const batch = db.batch();
            const itemsToDeleteLocally = [itemId];

            // L√≥gica para recorr√™ncia
            if (transaction.isRecurrent && transaction.recurrenceId && deleteOption === 'future') {
                 const futureParcels = state.transactions.filter(t =>
                     t.recurrenceId === transaction.recurrenceId &&
                     t.installmentNumber >= transaction.installmentNumber // Inclui a atual e futuras
                 );
                 futureParcels.forEach(p => {
                     const docRef = db.collection('transactions').doc(p.id);
                     batch.delete(docRef);
                     itemsToDeleteLocally.push(p.id);
                      // Reverter saldo do cart√£o para cada parcela futura exclu√≠da
                     if (p.type === 'expense' && p.paymentMethod === 'credito' && p.creditCardId) {
                          // N√£o precisamos esperar aqui, adicionamos a l√≥gica ao batch ou fazemos depois
                           // await updateCardBalance(p.creditCardId, -parseFloat(p.amount), 'expense'); // Reverte
                     }
                 });
                 console.log(`Agendando exclus√£o de ${futureParcels.length} parcelas recorrentes.`);
            } else {
                 // Excluir apenas a √∫nica transa√ß√£o
                 const docRef = db.collection('transactions').doc(itemId);
                 batch.delete(docRef);
                  // Reverter saldo do cart√£o
                 if (transaction.type === 'expense' && transaction.paymentMethod === 'credito' && transaction.creditCardId) {
                     // await updateCardBalance(transaction.creditCardId, -parseFloat(transaction.amount), 'expense'); // Reverte
                 }
            }

            try {
                 await batch.commit();
                 // Reverter saldo dos cart√µes AGORA, ap√≥s o commit bem-sucedido
                 const transactionsAffected = state.transactions.filter(t => itemsToDeleteLocally.includes(t.id));
                 for (const t of transactionsAffected) {
                     if (t.type === 'expense' && t.paymentMethod === 'credito' && t.creditCardId) {
                          await updateCardBalance(t.creditCardId, -parseFloat(t.amount), 'expense');
                     }
                 }

                 // Remover do estado local
                 state.transactions = state.transactions.filter(t => !itemsToDeleteLocally.includes(t.id));
                 console.log(`${itemsToDeleteLocally.length} transa√ß√µes removidas localmente.`);
                 return true;
            } catch (error) {
                 console.error("Erro ao excluir transa√ß√£o(√µes) no batch:", error);
                 showToast('Erro ao excluir transa√ß√£o.', 'error');
                 return false;
            }
        };

        // --- CATEGORIAS, M√âTODOS, PESSOAS ---
        const findCategoryById = (id, type) => {
            const list = type === 'income' ? state.categories.income : state.categories.expense;
            return list.find(c => c.id === id);
        };
        const findPaymentMethodById = (id) => state.paymentMethods.find(pm => pm.id === id);
        const findPessoaById = (id) => state.pessoas.find(p => p.id === id); // B1

        const addCategory = async (data) => { // type, name, icon
             // Verificar duplicidade
             const list = data.type === 'income' ? state.categories.income : state.categories.expense;
             if (list.some(c => c.name.toLowerCase() === data.name.toLowerCase())) {
                 showToast(`Categoria "${data.name}" j√° existe.`, 'warning');
                 return null;
             }
             const stateKey = data.type === 'income' ? 'categories.income' : 'categories.expense';
             return await addItem('categories', data, stateKey);
        };
        const updateCategory = async (itemId, updates) => {
             const cat = state.categories.income.find(c=>c.id===itemId) || state.categories.expense.find(c=>c.id===itemId);
             if(!cat) return false;
             const stateKey = cat.type === 'income' ? 'categories.income' : 'categories.expense';
             const success = await updateItem('categories', itemId, updates, stateKey);
              // Atualizar nome/√≠cone nas transa√ß√µes existentes (pode ser pesado, fazer se necess√°rio)
             // await updateTransactionsWithItemChange('category', itemId, updates);
             return success;
        };
         const deleteCategory = async (itemId) => {
            const cat = state.categories.income.find(c=>c.id===itemId) || state.categories.expense.find(c=>c.id===itemId);
            if(!cat) return false;
            const type = cat.type;
            // TODO: Implementar l√≥gica para mover transa√ß√µes para 'Outros' antes de excluir
            console.warn("L√≥gica para mover transa√ß√µes para 'Outros' ao excluir categoria ainda n√£o implementada.");
            const stateKey = type === 'income' ? 'categories.income' : 'categories.expense';
            return await deleteItem('categories', itemId, stateKey);
        };

        const addPaymentMethod = async (data) => { // name, icon
            if (state.paymentMethods.some(p => p.name.toLowerCase() === data.name.toLowerCase())) {
                 showToast(`Forma de pagamento "${data.name}" j√° existe.`, 'warning');
                 return null;
             }
            return await addItem('paymentMethods', data, 'paymentMethods');
        };
         const updatePaymentMethod = async (itemId, updates) => {
             const success = await updateItem('paymentMethods', itemId, updates, 'paymentMethods');
              // await updateTransactionsWithItemChange('paymentMethod', itemId, updates);
              return success;
         };
        const deletePaymentMethod = async (itemId) => {
            // TODO: Implementar l√≥gica para mover transa√ß√µes para 'Dinheiro' ou 'Outros'
             console.warn("L√≥gica para mover transa√ß√µes para 'Outros' ao excluir forma de pagamento ainda n√£o implementada.");
            return await deleteItem('paymentMethods', itemId, 'paymentMethods');
        };

         const addPerson = async (data) => { // B2: name
             if (state.pessoas.some(p => p.name.toLowerCase() === data.name.toLowerCase())) {
                 showToast(`Pessoa "${data.name}" j√° existe.`, 'warning');
                 return null;
             }
             return await addItem('pessoas', data, 'pessoas');
         };
         const updatePerson = async (itemId, updates) => { // B2
              const success = await updateItem('pessoas', itemId, updates, 'pessoas');
              // await updateTransactionsWithItemChange('pessoa', itemId, updates); // B1 - Atualizar nome nas transa√ß√µes
              return success;
         };
         const deletePerson = async (itemId) => { // B2
              // TODO: Implementar l√≥gica para remover pessoa das transa√ß√µes (null)
              console.warn("L√≥gica para remover pessoa das transa√ß√µes ao excluir ainda n√£o implementada.");
              return await deleteItem('pessoas', itemId, 'pessoas');
         };

        // --- CART√ïES ---
        const updateCardBalance = async (cardId, amountChange, transactionType) => {
             const cardIndex = state.cards.findIndex(c => c.id === cardId);
             if (cardIndex === -1) return;

             const card = state.cards[cardIndex];
             const amount = parseFloat(amountChange);
             if (isNaN(amount)) return;

             const updates = {};
             // Apenas despesas afetam o limite dispon√≠vel e a fatura atual
             if (transactionType === 'expense') {
                 updates.availableLimit = Math.max(0, Math.min(card.limit, card.availableLimit - amount)); // Subtrai do dispon√≠vel
                 updates.currentInvoice = Math.max(0, (card.currentInvoice || 0) + amount); // Adiciona √† fatura
             }

             if (Object.keys(updates).length > 0) {
                  try {
                       await db.collection('cards').doc(cardId).update(updates);
                       // Atualiza estado local
                       state.cards[cardIndex] = { ...card, ...updates };
                       console.log(`Saldo do cart√£o ${card.name} atualizado:`, updates);
                  } catch (error) {
                       console.error(`Erro ao atualizar saldo do cart√£o ${cardId}:`, error);
                       // N√£o mostrar toast aqui para n√£o poluir em opera√ß√µes de lote
                  }
             }
        };
         const addCard = async (data) => {
            const cardData = {
                 ...data,
                 availableLimit: data.limit, // Limite inicial √© o total
                 currentInvoice: 0,
                 createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            return await addItem('cards', cardData, 'cards');
         };
         const updateCard = async (itemId, updates) => {
             // Recalcular limite dispon√≠vel se o limite total mudar
             const originalCard = state.cards.find(c => c.id === itemId);
             if(originalCard && updates.limit && updates.limit !== originalCard.limit) {
                  const usedLimit = originalCard.limit - originalCard.availableLimit;
                  updates.availableLimit = Math.max(0, updates.limit - usedLimit);
             }
            return await updateItem('cards', itemId, updates, 'cards');
         };
         const deleteCard = async (itemId) => {
             // TODO: Verificar transa√ß√µes associadas e talvez mov√™-las?
             console.warn("L√≥gica para tratar transa√ß√µes ao excluir cart√£o ainda n√£o implementada.");
             return await deleteItem('cards', itemId, 'cards');
         };

         const payCardInvoiceAction = async (cardId) => {
             const card = state.cards.find(c => c.id === cardId);
             if (!card || !card.currentInvoice || card.currentInvoice <= 0) {
                 showToast('N√£o h√° fatura pendente ou o cart√£o n√£o foi encontrado.', 'warning');
                 return false;
             }

             // Simula o pagamento criando uma nova transa√ß√£o de despesa
             const today = new Date();
             const paymentTransactionData = {
                 name: `Pagamento Fatura ${card.name}`,
                 amount: card.currentInvoice,
                 category: 'pagamento_fatura', // Ou uma categoria espec√≠fica 'Finan√ßas'
                 date: today,
                 dueDate: null, // Pagamento feito hoje
                 status: 'paid', // Marcado como pago
                 paymentMethod: 'debito_conta', // Ou a forma como foi pago (Pix, etc.)
                 creditCardId: null, // N√ÉO √© uma despesa de cart√£o
                 isRecurrent: false,
                 installments: 1,
                 notes: `Pagamento da fatura do cart√£o ${card.name} referente ao per√≠odo X.`, // Melhorar descri√ß√£o
                 type: 'expense',
                 pessoaId: null, // Pagamento geral, sem pessoa espec√≠fica
                 tipoDespesa: 'fixed' // Pagamento de fatura √© geralmente fixo no m√™s
             };

             // Adiciona a transa√ß√£o de pagamento
             const paymentTransaction = await addTransaction(paymentTransactionData);
             if (!paymentTransaction) {
                  showToast('Falha ao registrar o pagamento da fatura.', 'error');
                  return false;
             }

              // Atualiza o cart√£o: zera fatura e restaura limite (idealmente deveria marcar transa√ß√µes da fatura como pagas)
              // SIMPLIFICA√á√ÉO: Apenas zera a fatura e restaura limite. A reconcilia√ß√£o real √© complexa.
             const cardUpdates = {
                  currentInvoice: 0,
                  availableLimit: card.limit // Restaura o limite total
             };
             const cardUpdateSuccess = await updateCard(cardId, cardUpdates);

             if (cardUpdateSuccess) {
                  showToast(`Fatura do ${card.name} paga com sucesso!`, 'success');
                  updateCardsUI(); // Atualiza a lista de cart√µes no modal
                  updateKPIs(); // Atualiza os KPIs
                  updateCharts(); // Atualiza gr√°ficos
                  return true;
             } else {
                  // Tentar reverter a transa√ß√£o de pagamento?
                  showToast('Fatura zerada, mas houve erro ao registrar o pagamento.', 'error');
                  return false;
             }
         };

         // --- INVESTIMENTOS (B5) ---
         const addInvestment = async (data) => {
             const investmentData = {
                 ...data,
                 currentValue: data.initialValue || 0, // Valor inicial √© o valor atual
                 createdAt: firebase.firestore.FieldValue.serverTimestamp()
             };
              // Remover initialValue que n√£o vai para o DB principal
              delete investmentData.initialValue;
             const saved = await addItem('investments', investmentData, 'investments');
             // Adicionar aporte inicial se houver
             if (saved && data.initialValue > 0) {
                 await addAporte(saved.id, {
                     value: data.initialValue,
                     date: new Date(), // Data do aporte inicial √© hoje
                     description: 'Aporte inicial'
                 });
             }
             return saved;
         };
        const updateInvestment = async (itemId, updates) => {
            return await updateItem('investments', itemId, updates, 'investments');
        };
        const deleteInvestment = async (itemId) => {
            // TODO: Excluir tamb√©m os aportes associados? (Subcole√ß√£o)
             console.warn("L√≥gica para excluir aportes ao excluir investimento ainda n√£o implementada.");
            return await deleteItem('investments', itemId, 'investments');
        };

        // --- APORTES (B5) ---
        const loadAllAportes = async () => {
             state.aportes = {}; // Limpa aportes existentes
             const loadPromises = state.investments.map(inv => loadAportesForInvestment(inv.id));
             await Promise.all(loadPromises);
             console.log("Todos os aportes carregados.");
        };

        const loadAportesForInvestment = async (investmentId) => {
             try {
                  const snapshot = await db.collection('investments').doc(investmentId).collection('aportes').orderBy('date', 'desc').get();
                  const aportesData = snapshot.docs.map(doc => ({
                       id: doc.id,
                       ...doc.data(),
                       // Converter Timestamp de volta para Date para uso no JS
                       date: doc.data().date ? doc.data().date.toDate() : null
                  }));
                  state.aportes[investmentId] = aportesData;
                  // Recalcular valor atual do investimento com base nos aportes carregados
                 recalculateInvestmentValue(investmentId);
             } catch (error) {
                  console.error(`Erro ao carregar aportes para ${investmentId}:`, error);
                  state.aportes[investmentId] = []; // Define como array vazio em caso de erro
             }
        };

        const addAporte = async (investmentId, data) => {
             try {
                  const dataToSave = {
                       ...data,
                       date: firebase.firestore.Timestamp.fromDate(data.date), // Converter Date para Timestamp
                       createdAt: firebase.firestore.FieldValue.serverTimestamp()
                  };
                   // Salvar na subcole√ß√£o
                  const docRef = await db.collection('investments').doc(investmentId).collection('aportes').add(dataToSave);
                  const newAporte = { id: docRef.id, ...data }; // Usar data original (com Date object) para o estado

                  // Adicionar ao estado local
                  if (!state.aportes[investmentId]) {
                       state.aportes[investmentId] = [];
                  }
                   // Adiciona no in√≠cio da lista (mais recente primeiro)
                  state.aportes[investmentId].unshift(newAporte);

                  // Atualizar valor atual do investimento
                  await recalculateInvestmentValue(investmentId, true); // For√ßa atualiza√ß√£o no DB

                  return newAporte;
             } catch (error) {
                  console.error(`Erro ao adicionar aporte para ${investmentId}:`, error);
                  showToast('Erro ao salvar aporte.', 'error');
                  return null;
             }
        };

         const updateAporte = async (investmentId, aporteId, updates) => {
             try {
                  const dataToSave = { ...updates };
                  if (updates.date) dataToSave.date = firebase.firestore.Timestamp.fromDate(updates.date);

                  await db.collection('investments').doc(investmentId).collection('aportes').doc(aporteId).update(dataToSave);

                  // Atualizar estado local
                  if (state.aportes[investmentId]) {
                       const index = state.aportes[investmentId].findIndex(a => a.id === aporteId);
                       if (index !== -1) {
                            state.aportes[investmentId][index] = { ...state.aportes[investmentId][index], ...updates };
                       }
                  }
                  // Recalcular valor do investimento
                 await recalculateInvestmentValue(investmentId, true);

                 return true;
             } catch (error) {
                  console.error(`Erro ao atualizar aporte ${aporteId}:`, error);
                  showToast('Erro ao atualizar aporte.', 'error');
                  return false;
             }
         };

        const deleteAporte = async (investmentId, aporteId) => {
             try {
                  await db.collection('investments').doc(investmentId).collection('aportes').doc(aporteId).delete();
                   // Remover do estado local
                  if (state.aportes[investmentId]) {
                       state.aportes[investmentId] = state.aportes[investmentId].filter(a => a.id !== aporteId);
                  }
                  // Recalcular valor do investimento
                  await recalculateInvestmentValue(investmentId, true);
                  return true;
             } catch (error) {
                  console.error(`Erro ao excluir aporte ${aporteId}:`, error);
                  showToast('Erro ao excluir aporte.', 'error');
                  return false;
             }
        };

         // Recalcula o valor atual de um investimento com base nos aportes
        const recalculateInvestmentValue = async (investmentId, updateDB = false) => {
            const aportes = state.aportes[investmentId] || [];
            const currentValue = aportes.reduce((sum, aporte) => sum + parseFloat(aporte.value || 0), 0);

            const investmentIndex = state.investments.findIndex(inv => inv.id === investmentId);
            if (investmentIndex !== -1) {
                 // Atualiza estado local primeiro
                state.investments[investmentIndex].currentValue = currentValue;
                 // Se precisar, atualiza no Firebase
                if (updateDB) {
                     try {
                          await db.collection('investments').doc(investmentId).update({ currentValue });
                          console.log(`Valor do investimento ${investmentId} recalculado e atualizado no DB: ${currentValue}`);
                     } catch (error) {
                          console.error(`Erro ao atualizar valor do investimento ${investmentId} no DB:`, error);
                     }
                }
            }
        };


        // ======================================================
        // UI RENDERING FUNCTIONS
        // ======================================================

        // --- Populating Selects ---
        const populateYearMonthSelectors = () => {
             const yearSelect = $('#yearSelect');
             const monthSelect = $('#monthSelect');
             const currentYear = new Date().getFullYear();

             if(yearSelect) {
                 yearSelect.innerHTML = '';
                 for (let y = currentYear - 2; y <= currentYear + 5; y++) {
                     const option = document.createElement('option');
                     option.value = y;
                     option.textContent = y;
                     option.selected = y === state.year;
                     yearSelect.appendChild(option);
                 }
             }
             if(monthSelect) {
                 const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                 monthSelect.innerHTML = '';
                 monthNames.forEach((name, index) => {
                     const option = document.createElement('option');
                     option.value = index;
                     option.textContent = name;
                     option.selected = index === state.month;
                     monthSelect.appendChild(option);
                 });
             }
        };

        const populateCategorySelects = () => {
             const selects = [
                 $('#transactionCategory'),
                 $('#filterCategoria') // Filtro da tabela
             ];
             const incomeCats = state.categories.income.map(c => `<option value="${c.id}">${c.icon || 'üí∞'} ${c.name}</option>`).join('');
             const expenseCats = state.categories.expense.map(c => `<option value="${c.id}">${c.icon || 'üõí'} ${c.name}</option>`).join('');

             selects.forEach(select => {
                 if (select) {
                     const currentValue = select.value; // Salva valor atual se houver
                     if (select.id === 'filterCategoria') {
                          select.innerHTML = `
                              <option value="">üîΩ Todas as Categorias</option>
                              <optgroup label="Receitas">${incomeCats}</optgroup>
                              <optgroup label="Despesas">${expenseCats}</optgroup>
                          `;
                     } else { // Modal de transa√ß√£o - populado dinamicamente pelo tipo
                          select.innerHTML = '<option value="" disabled selected>Selecione o tipo...</option>'; // Placeholder
                     }
                     select.value = currentValue; // Restaura valor
                 }
             });
        };
        // Fun√ß√£o para popular o select de categoria no modal baseado no tipo (income/expense)
        const populateTransactionCategorySelect = (type) => {
             const select = $('#transactionCategory');
             if (!select) return;
             const list = type === 'income' ? state.categories.income : state.categories.expense;
             const defaultIcon = type === 'income' ? 'üí∞' : 'üõí';
             select.innerHTML = `<option value="" disabled selected>Selecione uma categoria</option>`;
             list.forEach(cat => {
                 select.innerHTML += `<option value="${cat.id}">${cat.icon || defaultIcon} ${cat.name}</option>`;
             });
        };


        const populatePaymentMethodSelects = () => {
             const selects = [
                 $('#transactionPaymentMethod'),
                 $('#incomePaymentMethod') // Assegura que ambos sejam populados
             ];
             const optionsHtml = state.paymentMethods.map(m => `<option value="${m.id}">${m.icon || '‚ùì'} ${m.name}</option>`).join('');

             selects.forEach(select => {
                 if (select) {
                     const currentValue = select.value;
                      // Adiciona op√ß√£o padr√£o para despesa
                     if(select.id === 'transactionPaymentMethod') {
                          select.innerHTML = `<option value="" disabled selected>Selecione...</option>` + optionsHtml;
                     } else { // Adiciona op√ß√£o padr√£o para receita
                          select.innerHTML = `<option value="" disabled selected>Selecione...</option>` + optionsHtml;
                     }

                     select.value = currentValue;
                 }
             });
        };

        const populateCardSelects = () => {
             const selects = [$('#transactionCreditCard')];
             selects.forEach(select => {
                 if (select) {
                     const currentValue = select.value;
                     select.innerHTML = '<option value="" disabled selected>Selecione o cart√£o</option>';
                     state.cards.forEach(card => {
                         select.innerHTML += `<option value="${card.id}">${card.name}</option>`;
                     });
                     select.value = currentValue;
                 }
             });
        };

         const populatePessoaSelects = () => { // B1 / B7
             const selects = [
                 $('#transactionPessoa'), // Modal de transa√ß√£o
                 $('#filterPessoa')      // Filtro da tabela
             ];
             const optionsHtml = state.pessoas.map(p => `<option value="${p.id}">${p.name}</option>`).join('');

             selects.forEach(select => {
                 if (select) {
                     const currentValue = select.value;
                      if (select.id === 'filterPessoa') {
                          select.innerHTML = '<option value="">üîΩ Todas as Pessoas</option>' + optionsHtml;
                     } else {
                          select.innerHTML = '<option value="">Ningu√©m espec√≠fico</option>' + optionsHtml;
                     }
                     select.value = currentValue;
                 }
             });
         };

          const populateStatusSelects = () => { // Para filtro da tabela
             const select = $('#filterStatus');
             if (select) {
                 const currentValue = select.value;
                 select.innerHTML = `
                     <option value="">üîΩ Todos os Status</option>
                     <optgroup label="Receitas">
                         <option value="received">Recebido</option>
                         <option value="pending_income">A Receber</option>
                     </optgroup>
                     <optgroup label="Despesas">
                         <option value="paid">Pago</option>
                         <option value="pending_expense">Pendente</option>
                         <option value="scheduled">Agendado</option>
                     </optgroup>
                 `;
                 select.value = currentValue;
             }
              // Popula o status no modal dinamicamente ao abrir
              // (feito na fun√ß√£o openTransactionModal)
         };

        // --- Rendering Lists ---
         // B9: Fun√ß√£o gen√©rica para renderizar listas no modal de cadastros
         const renderList = (stateKey, containerSelector, itemRenderer) => {
             const container = $(containerSelector);
             if (!container) return;

             const items = stateKey.includes('.') ? state[stateKey.split('.')[0]][stateKey.split('.')[1]] : state[stateKey];
             container.innerHTML = ''; // Limpa antes de renderizar

             if (!items || items.length === 0) {
                 container.innerHTML = `<p style="padding: var(--spacing-md); text-align: center;">Nenhum item cadastrado.</p>`;
                 return;
             }

             items.forEach(item => {
                 const itemElement = itemRenderer(item); // Chama a fun√ß√£o espec√≠fica para criar o HTML do item
                 if(itemElement) container.appendChild(itemElement);
             });
         };

         // B9: Renderer espec√≠fico para categorias (receita/despesa)
        const renderCategoryItem = (category, type) => {
            const item = document.createElement('div');
            item.className = 'tab-list-item';
            item.dataset.id = category.id;
            item.dataset.type = type; // 'incomeCategory' or 'expenseCategory'

            const defaultIcon = type === 'incomeCategory' ? 'üí∞' : 'üõí';

            item.innerHTML = `
                <div class="tab-item-content">
                    <span class="tab-item-icon">${category.icon || defaultIcon}</span>
                    <span>${category.name}</span>
                </div>
                <div class="tab-item-actions">
                    <button class="btn btn-icon btn-outline edit-cadastro-item-btn" title="Editar">
                        <svg><use href="#icon-edit"></use></svg>
                    </button>
                    <button class="btn btn-icon btn-outline delete-cadastro-item-btn" title="Excluir">
                        <svg><use href="#icon-trash"></use></svg>
                    </button>
                </div>
            `;
            return item;
        };
        // B9: Fun√ß√£o adaptada para chamar renderList para categorias
        const renderCategoriesList = (type, containerSelector) => {
            const stateKey = type === 'income' ? 'categories.income' : 'categories.expense';
            const itemRenderer = (item) => renderCategoryItem(item, `${type}Category`);
            renderList(stateKey, containerSelector, itemRenderer);
        };


         // Renderer espec√≠fico para Formas de Pagamento
        const renderPaymentMethodItem = (method) => {
            const item = document.createElement('div');
            item.className = 'tab-list-item';
            item.dataset.id = method.id;
            item.dataset.type = 'paymentMethod';

            item.innerHTML = `
                <div class="tab-item-content">
                    <span class="tab-item-icon">${method.icon || 'üí≥'}</span>
                    <span>${method.name}</span>
                </div>
                <div class="tab-item-actions">
                    <button class="btn btn-icon btn-outline edit-cadastro-item-btn" title="Editar">
                        <svg><use href="#icon-edit"></use></svg>
                    </button>
                    <button class="btn btn-icon btn-outline delete-cadastro-item-btn" title="Excluir">
                        <svg><use href="#icon-trash"></use></svg>
                    </button>
                </div>
            `;
             return item;
        };

         // B2: Renderer espec√≠fico para Pessoas
        const renderPersonItem = (person) => {
            const item = document.createElement('div');
            item.className = 'tab-list-item';
            item.dataset.id = person.id;
            item.dataset.type = 'person';

            item.innerHTML = `
                <div class="tab-item-content">
                    <!-- Sem √≠cone para pessoa -->
                    <span>${person.name}</span>
                </div>
                <div class="tab-item-actions">
                     <!-- Editar n√£o faz sentido aqui? Apenas nome -->
                    <button class="btn btn-icon btn-outline edit-cadastro-item-btn" title="Editar Nome">
                        <svg><use href="#icon-edit"></use></svg>
                    </button>
                    <button class="btn btn-icon btn-outline delete-cadastro-item-btn" title="Excluir">
                        <svg><use href="#icon-trash"></use></svg>
                    </button>
                </div>
            `;
            return item;
        };


        // --- Rendering Transactions Table ---
        const renderTransactionsTable = () => {
             const tableBody = $('#transactionsTableBody');
             if (!tableBody) return;

             // Aplicar filtros e ordena√ß√£o
             applyFiltersAndSort();

             tableBody.innerHTML = ''; // Limpa a tabela

             if (state.filteredTransactions.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="9" style="text-align: center; padding: var(--spacing-xl);">Nenhuma transa√ß√£o encontrada.</td></tr>`;
                 return;
             }

             state.filteredTransactions.forEach(t => {
                 const row = document.createElement('tr');
                 row.dataset.id = t.id;

                 const category = findCategoryById(t.category, t.type);
                 const paymentMethod = findPaymentMethodById(t.paymentMethod);
                 const pessoa = findPessoaById(t.pessoaId); // B1

                 const isIncome = t.type === 'income';
                 const iconBgColor = isIncome ? 'rgba(52, 199, 89, 0.1)' : 'rgba(255, 59, 48, 0.1)';
                 const iconColor = isIncome ? 'var(--color-income)' : 'var(--color-expense)';
                 const defaultIcon = isIncome ? 'üí∞' : 'üõí';

                 let statusText = '';
                 let statusClass = '';
                  let isChecked = false;

                 if (isIncome) {
                     isChecked = t.status === 'received';
                     if (t.status === 'received') { statusText = 'Recebido'; statusClass = 'badge-success'; }
                     else { statusText = 'A Receber'; statusClass = 'badge-warning'; }
                 } else { // Expense
                     isChecked = t.status === 'paid';
                     if (t.status === 'paid') { statusText = 'Pago'; statusClass = 'badge-success'; }
                     else if (t.status === 'scheduled') { statusText = 'Agendado'; statusClass = 'badge-info'; }
                     else { statusText = 'Pendente'; statusClass = 'badge-warning'; }
                 }

                  // B3: Determinar tipo Fixa/Vari√°vel (usar o dado salvo, default vari√°vel)
                 const tipoDespesaText = t.type === 'expense' ? (t.tipoDespesa === 'fixed' ? 'Fixa' : 'Vari√°vel') : '-';


                 row.innerHTML = `
                     <td class="col-icon">
                         <span class="transaction-icon" style="background-color: ${iconBgColor}; color: ${iconColor};">
                             ${category?.icon || defaultIcon}
                         </span>
                     </td>
                     <td>${formatDate(t.date)}</td>
                     <td>${pessoa?.name || '-'}</td>
                     <td>${t.name} ${t.isRecurrent ? `(${t.installmentNumber}/${t.installments})` : ''}</td>
                     <td>${category?.name || t.category || '-'}</td>
                     <td>${tipoDespesaText}</td>
                     <td class="col-value">${formatCurrency(t.amount)}</td>
                     <td class="col-status"><span class="badge ${statusClass}">${statusText}</span></td>
                     <td class="col-actions">
                          <label class="checkbox-wrapper" title="Marcar como ${isChecked ? (isIncome ? 'A Receber' : 'Pendente') : (isIncome ? 'Recebido' : 'Pago')}">
                             <input type="checkbox" class="checkbox transaction-paid-checkbox" ${isChecked ? 'checked' : ''}>
                             <span class="checkbox-label-box"></span>
                           </label>
                         <button class="btn btn-icon btn-outline edit-transaction-btn" title="Editar">
                             <svg><use href="#icon-edit"></use></svg>
                         </button>
                         <button class="btn btn-icon btn-outline delete-transaction-btn" title="Excluir">
                             <svg><use href="#icon-trash"></use></svg>
                         </button>
                     </td>
                 `;
                 tableBody.appendChild(row);
             });

              // Re-attach event listeners after rendering
             attachTableActionListeners();
        };

        const attachTableActionListeners = () => {
            $$('#transactionsTableBody .transaction-paid-checkbox').forEach(checkbox => {
                 checkbox.addEventListener('change', handleTransactionStatusToggle);
            });
             $$('#transactionsTableBody .edit-transaction-btn').forEach(button => {
                 button.addEventListener('click', handleEditTransactionClick);
            });
             $$('#transactionsTableBody .delete-transaction-btn').forEach(button => {
                 button.addEventListener('click', handleDeleteTransactionClick);
            });
        };

         // --- Rendering KPIs ---
        const renderKPIs = () => {
            console.log("Renderizando KPIs...");
            const { income, expense, balance, committedBalance, invoiceTotal, invoiceDueDate, fixedExpenses, variableExpenses } = calculateMonthlySummary(); // Fun√ß√£o a ser criada

             $('#kpiBalanceValue').textContent = formatCurrency(balance);
             $('#kpiBalanceSubtitle span').textContent = `Comprometido: ${formatCurrency(committedBalance)}`;
             $('#kpiIncomeValue').textContent = formatCurrency(income.total);
             $('#kpiIncomeSubtitle span').textContent = `${formatCurrency(income.received)} recebidos / ${formatCurrency(income.pending)} pendentes`;
             $('#kpiExpenseValue').textContent = formatCurrency(expense.total);
             $('#kpiExpenseSubtitle span').textContent = `${formatCurrency(expense.paid)} pagos / ${formatCurrency(expense.pending)} pendentes`;
             $('#kpiInvoiceValue').textContent = formatCurrency(invoiceTotal);
             $('#kpiInvoiceSubtitle span').textContent = `Vencimento: ${invoiceDueDate ? formatDate(invoiceDueDate, { day: '2-digit', month: '2-digit' }) : '--/--'}`;
             // B3: KPI Fixas vs Vari√°veis
             $('#kpiFixedVariableValue').textContent = `${formatCurrency(fixedExpenses, 0)} / ${formatCurrency(variableExpenses, 0)}`;
             $('#kpiFixedVariableSubtitle span').textContent = `(Total: ${formatCurrency(fixedExpenses + variableExpenses, 0)})`;
        };

         // --- Rendering Charts ---
        const renderCharts = () => {
             console.log("Renderizando gr√°ficos...");
            if (!catPieChart || !cardAreaChart || !annualBarsChart || !personSpendingChart) {
                 console.warn("Tentando renderizar gr√°ficos antes de serem criados.");
                 createCharts(); // Tenta criar se n√£o existirem
                 if (!catPieChart || !cardAreaChart || !annualBarsChart || !personSpendingChart) return; // Sai se ainda falhar
             }

             // 1. Pie Chart - Expense Categories
             const categoryData = calculateCategorySpending();
             catPieChart.data.labels = categoryData.labels;
             catPieChart.data.datasets[0].data = categoryData.values;
             catPieChart.data.datasets[0].backgroundColor = getChartColors(categoryData.labels.length);
             catPieChart.update();

             // 2. Area Chart - Card Limit
             const cardLimitData = calculateCardLimitUsage();
             cardAreaChart.data.labels = cardLimitData.labels; // Ex: Dias do m√™s ou √∫ltimos meses
             cardAreaChart.data.datasets[0].data = cardLimitData.used;
             cardAreaChart.data.datasets[1].data = cardLimitData.available;
             cardAreaChart.data.datasets[2].data = cardLimitData.total;
             cardAreaChart.update();

             // 3. Bar Chart - Annual Income vs Expense
             const annualData = calculateAnnualSummary();
             annualBarsChart.data.labels = annualData.labels; // Meses
             annualBarsChart.data.datasets[0].data = annualData.income;
             annualBarsChart.data.datasets[1].data = annualData.expense;
             annualBarsChart.update();

             // 4. Bar Chart - Spending per Person (B8)
             const personSpendingData = calculatePersonSpending();
             personSpendingChart.data.labels = personSpendingData.labels; // Nomes das pessoas
             personSpendingChart.data.datasets[0].data = personSpendingData.values;
             personSpendingChart.data.datasets[0].backgroundColor = getChartColors(personSpendingData.labels.length);
             personSpendingChart.update();
        };

         // --- Rendering Investments (B5) ---
        const renderInvestmentsOverview = () => {
             const grid = $('#investmentsGrid');
             if (!grid) return;
             grid.innerHTML = ''; // Limpa

             if (state.investments.length === 0) {
                  grid.innerHTML = '<p style="text-align: center; grid-column: 1 / -1;">Nenhum objetivo de investimento cadastrado.</p>';
                  return;
             }

             state.investments.forEach(inv => {
                  const card = document.createElement('div');
                  card.className = 'investment-card';
                  card.dataset.id = inv.id;

                  const goalValue = parseFloat(inv.goalValue || 0);
                  const currentValue = parseFloat(inv.currentValue || 0);
                  const progress = goalValue > 0 ? Math.min(100, Math.max(0, (currentValue / goalValue) * 100)) : 0;
                  const categoryInfo = state.investmentCategories.find(c => c.id === inv.category);

                  card.innerHTML = `
                    <div class="investment-card-header">
                        <div>
                             <h4 class="investment-card-title">${inv.name}</h4>
                             <div style="font-size: var(--font-size-xs); color: var(--color-on-surface-variant);">
                                  ${categoryInfo ? `${categoryInfo.icon} ${categoryInfo.name}` : inv.category}
                                  ${inv.targetDate ? ` - Meta: ${formatDate(inv.targetDate, { month: 'short', year: 'numeric' })}` : ''}
                             </div>
                        </div>
                        <div class="investment-card-actions">
                             <button class="btn btn-icon btn-outline edit-investment-btn" title="Editar Objetivo">
                                  <svg><use href="#icon-edit"></use></svg>
                             </button>
                             <button class="btn btn-icon btn-outline delete-investment-btn" title="Excluir Objetivo">
                                  <svg><use href="#icon-trash"></use></svg>
                             </button>
                        </div>
                    </div>
                    <div class="investment-card-body">
                         <div>Guardado: <strong>${formatCurrency(currentValue)}</strong></div>
                         ${goalValue > 0 ? `<div>Meta: <strong>${formatCurrency(goalValue)}</strong></div>` : ''}
                    </div>
                     ${goalValue > 0 ? `
                    <div class="investment-progress">
                         <div style="display: flex; justify-content: space-between; font-size: var(--font-size-xs); margin-bottom: var(--spacing-2xs);">
                              <span>Progresso</span>
                              <span>${progress.toFixed(0)}%</span>
                         </div>
                         <div class="investment-progress-bar-container">
                              <div class="investment-progress-bar" style="width: ${progress}%;"></div>
                         </div>
                    </div>
                    ` : ''}
                `;
                 card.addEventListener('click', (e) => {
                     // N√£o navega se clicou num bot√£o dentro do card
                     if (!e.target.closest('button')) {
                          navigateToInvestmentDetail(inv.id);
                     }
                 });
                 grid.appendChild(card);
             });

             // Add listeners para bot√µes de editar/excluir nos cards
            attachInvestmentCardActionListeners();
        };

         const attachInvestmentCardActionListeners = () => {
            $$('#investmentsGrid .edit-investment-btn').forEach(btn => {
                 btn.addEventListener('click', (e) => {
                      e.stopPropagation(); // Impede que o clique no bot√£o navegue para detalhes
                      const card = e.target.closest('.investment-card');
                      if (card && card.dataset.id) {
                           handleEditInvestmentClick(card.dataset.id);
                      }
                 });
            });
            $$('#investmentsGrid .delete-investment-btn').forEach(btn => {
                 btn.addEventListener('click', (e) => {
                      e.stopPropagation();
                       const card = e.target.closest('.investment-card');
                      if (card && card.dataset.id) {
                           handleDeleteInvestmentClick(card.dataset.id);
                      }
                 });
            });
        };

         const renderInvestmentDetail = (investmentId) => {
            const investment = state.investments.find(inv => inv.id === investmentId);
            if (!investment) {
                 console.error(`Investimento ${investmentId} n√£o encontrado para detalhes.`);
                 navigateToSection('investmentsSection'); // Volta para a vis√£o geral
                 return;
            }
            state.currentInvestmentDetailId = investmentId; // Guarda ID atual

            $('#investmentDetailTitle').textContent = investment.name;
            const summaryContainer = $('#investmentDetailSummary');
            const aportesBody = $('#investmentAportesTableBody');
            if (!summaryContainer || !aportesBody) return;

             const goalValue = parseFloat(investment.goalValue || 0);
             const currentValue = parseFloat(investment.currentValue || 0);
             const progress = goalValue > 0 ? Math.min(100, Math.max(0, (currentValue / goalValue) * 100)) : 0;
             const categoryInfo = state.investmentCategories.find(c => c.id === investment.category);

             summaryContainer.innerHTML = `
                <div><span>Guardado:</span><br><strong>${formatCurrency(currentValue)}</strong></div>
                ${goalValue > 0 ? `<div><span>Meta:</span><br><strong>${formatCurrency(goalValue)}</strong></div>` : ''}
                <div><span>Categoria:</span><br><strong>${categoryInfo ? `${categoryInfo.icon} ${categoryInfo.name}` : investment.category}</strong></div>
                <div><span>Criado em:</span><br><strong>${formatDate(investment.createdAt)}</strong></div>
                ${investment.targetDate ? `<div><span>Data Alvo:</span><br><strong>${formatDate(investment.targetDate)}</strong></div>` : ''}
                 ${goalValue > 0 ? `
                 <div class="investment-detail-progress">
                     <div style="display: flex; justify-content: space-between; font-size: var(--font-size-xs); margin-bottom: var(--spacing-2xs);">
                          <span>Progresso</span>
                          <span>${progress.toFixed(1)}%</span>
                     </div>
                     <div class="investment-progress-bar-container">
                          <div class="investment-progress-bar" style="width: ${progress}%;"></div>
                     </div>
                 </div>
                 ` : ''}
                  ${investment.notes ? `<div style="grid-column: 1 / -1;"><span>Observa√ß√µes:</span><br><strong>${investment.notes}</strong></div>` : ''}
            `;

             // Renderizar Aportes
             const aportes = state.aportes[investmentId] || [];
             aportesBody.innerHTML = '';
             if (aportes.length === 0) {
                  aportesBody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: var(--spacing-lg);">Nenhum aporte registrado.</td></tr>`;
             } else {
                  aportes.forEach(aporte => {
                       const row = document.createElement('tr');
                       row.dataset.id = aporte.id;
                       row.innerHTML = `
                           <td>${formatDate(aporte.date)}</td>
                           <td>${aporte.description || '-'}</td>
                           <td class="col-value">${formatCurrency(aporte.value)}</td>
                           <td class="col-actions">
                                <button class="btn btn-icon btn-outline edit-aporte-btn" title="Editar Aporte">
                                     <svg><use href="#icon-edit"></use></svg>
                                </button>
                                <button class="btn btn-icon btn-outline delete-aporte-btn" title="Excluir Aporte">
                                     <svg><use href="#icon-trash"></use></svg>
                                </button>
                           </td>
                       `;
                       aportesBody.appendChild(row);
                  });
             }

              // Adicionar listeners aos bot√µes de aporte
              attachAporteActionListeners(investmentId);
         };

         const attachAporteActionListeners = (investmentId) => {
            $$('#investmentAportesTableBody .edit-aporte-btn').forEach(btn => {
                 btn.addEventListener('click', (e) => {
                      const row = e.target.closest('tr');
                      if (row && row.dataset.id) {
                           handleEditAporteClick(investmentId, row.dataset.id);
                      }
                 });
            });
            $$('#investmentAportesTableBody .delete-aporte-btn').forEach(btn => {
                 btn.addEventListener('click', (e) => {
                       const row = e.target.closest('tr');
                       if (row && row.dataset.id) {
                           handleDeleteAporteClick(investmentId, row.dataset.id);
                       }
                 });
            });
         };

        // --- Rendering Cards ---
        const renderCardsList = () => {
            const container = $('#cardsList');
            if (!container) return;
            container.innerHTML = '';

             if (state.cards.length === 0) {
                 container.innerHTML = '<p style="text-align: center; grid-column: 1 / -1;">Nenhum cart√£o cadastrado.</p>';
                 return;
             }

            state.cards.forEach(card => {
                 const cardElement = document.createElement('div');
                 cardElement.className = 'investment-card'; // Reutilizando estilo visual
                 cardElement.dataset.id = card.id;

                 const limitPercentage = card.limit > 0 ? Math.max(0, Math.min(100, ((card.limit - card.availableLimit) / card.limit) * 100)) : 0;
                 const today = new Date();
                 const closingDay = card.closingDay || 1;
                 const dueDay = card.dueDay || 1;
                 // Calcula pr√≥xima data de fechamento/vencimento de forma simples
                 const nextClosing = new Date(today.getFullYear(), today.getMonth(), closingDay);
                 if (today.getDate() > closingDay) nextClosing.setMonth(nextClosing.getMonth() + 1);
                 const nextDue = new Date(today.getFullYear(), today.getMonth(), dueDay);
                 if (today.getDate() > dueDay) nextDue.setMonth(nextDue.getMonth() + 1); // Simplificado, pode precisar ajustar l√≥gica de cart√£o

                  cardElement.innerHTML = `
                     <div class="investment-card-header">
                          <h4 class="investment-card-title">${card.name}</h4>
                          <div class="investment-card-actions">
                              <button class="btn btn-icon btn-outline edit-card-btn" title="Editar Cart√£o">
                                  <svg><use href="#icon-edit"></use></svg>
                              </button>
                              <button class="btn btn-icon btn-outline delete-card-btn" title="Excluir Cart√£o">
                                  <svg><use href="#icon-trash"></use></svg>
                              </button>
                          </div>
                     </div>
                     <div class="investment-card-body">
                         <div>Limite: <strong>${formatCurrency(card.limit)}</strong></div>
                         <div>Dispon√≠vel: <strong>${formatCurrency(card.availableLimit)}</strong></div>
                         <div>Fatura Atual: <strong style="color: var(--color-expense);">${formatCurrency(card.currentInvoice || 0)}</strong></div>
                         <div style="font-size: var(--font-size-xs);">
                             Fecha dia ${closingDay} (${formatDate(nextClosing, {day:'2-digit', month:'2-digit'})}) /
                             Vence dia ${dueDay} (${formatDate(nextDue, {day:'2-digit', month:'2-digit'})})
                         </div>
                     </div>
                     <div class="investment-progress">
                         <div style="display: flex; justify-content: space-between; font-size: var(--font-size-xs); margin-bottom: var(--spacing-2xs);">
                              <span>Limite Usado</span>
                              <span>${limitPercentage.toFixed(0)}%</span>
                         </div>
                         <div class="investment-progress-bar-container">
                              <div class="investment-progress-bar" style="width: ${limitPercentage}%; background-color: ${limitPercentage > 80 ? 'var(--color-error)' : limitPercentage > 50 ? 'var(--color-warning)' : 'var(--color-primary)'};"></div>
                         </div>
                     </div>
                      <button class="btn btn-primary btn-sm view-invoice-btn" style="margin-top: var(--spacing-sm); width: 100%;">Ver Fatura Detalhada</button>
                 `;
                 container.appendChild(cardElement);
            });
             attachCardActionListeners();
        };

         const attachCardActionListeners = () => {
            $$('#cardsList .edit-card-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                     const cardEl = e.target.closest('.investment-card');
                     if(cardEl && cardEl.dataset.id) handleEditCardClick(cardEl.dataset.id);
                });
            });
             $$('#cardsList .delete-card-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const cardEl = e.target.closest('.investment-card');
                    if(cardEl && cardEl.dataset.id) handleDeleteCardClick(cardEl.dataset.id);
                });
            });
             $$('#cardsList .view-invoice-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const cardEl = e.target.closest('.investment-card');
                     if(cardEl && cardEl.dataset.id) openCardInvoiceModal(cardEl.dataset.id);
                });
            });
        };

        // --- Update All UI ---
        const updateAllUI = () => {
             console.log("Atualizando toda a UI...");
             renderKPIs();
             renderCharts();
             renderTransactionsTable();
             // As listas de cards/investimentos s√£o atualizadas ao abrir os modais/se√ß√µes
        };

         // --- Filtering and Sorting ---
        const applyFiltersAndSort = () => {
            console.log("Aplicando filtros e ordena√ß√£o:", state.filters, state.sortColumn, state.sortDirection);
             let transactions = state.transactions.filter(t => {
                 const transactionDate = parseLocalDateString(t.date);
                 if (!transactionDate) return false;

                  // Filtro b√°sico de M√™s/Ano
                 let matchDate = transactionDate.getMonth() === state.month && transactionDate.getFullYear() === state.year;

                 // TODO: Adicionar l√≥gica de filtro de cart√£o (se necess√°rio aqui ou antes)

                 if(!matchDate) return false;

                  // Filtro de Busca (no nome/descri√ß√£o)
                  if (state.filters.search && !t.name.toLowerCase().includes(state.filters.search.toLowerCase())) {
                      return false;
                  }
                 // Filtro de Pessoa (B7)
                 if (state.filters.pessoa && t.pessoaId !== state.filters.pessoa) {
                      return false;
                 }
                 // Filtro de Categoria
                 if (state.filters.category && t.category !== state.filters.category) {
                     return false;
                 }
                  // Filtro de Tipo de Despesa (B3)
                  if (state.filters.tipoDespesa && t.type === 'expense' && t.tipoDespesa !== state.filters.tipoDespesa) {
                      return false;
                  }
                  // Filtro de Status
                  if (state.filters.status) {
                       // Ajustar status do filtro para corresponder aos dados
                       let targetStatus = state.filters.status;
                       if(state.filters.status === 'pending_income') targetStatus = 'pending';
                       if(state.filters.status === 'pending_expense') targetStatus = 'pending';

                       // Filtrar por status correspondente ao tipo
                       if(t.type === 'income' && state.filters.status.includes('expense')) return false;
                       if(t.type === 'expense' && state.filters.status.includes('income')) return false;
                       if(t.type === 'expense' && state.filters.status === 'received') return false; // Despesa n√£o pode ser 'received'

                       if (t.status !== targetStatus) {
                           return false;
                       }
                  }
                 return true; // Passou por todos os filtros
             });

             // Ordena√ß√£o
             transactions.sort((a, b) => {
                 let valA, valB;
                  const getVal = (obj, col) => {
                      switch(col) {
                           case 'date': return parseLocalDateString(obj.date)?.getTime() || 0;
                           case 'pessoa': return findPessoaById(obj.pessoaId)?.name?.toLowerCase() || 'zzz'; // B1
                           case 'name': return obj.name?.toLowerCase() || '';
                           case 'category': return findCategoryById(obj.category, obj.type)?.name?.toLowerCase() || 'zzz';
                           case 'type': return obj.type === 'expense' ? (obj.tipoDespesa || 'variable') : 'income'; // B3
                           case 'amount': return parseFloat(obj.amount || 0);
                           case 'status': return obj.status || '';
                           default: return parseLocalDateString(obj.date)?.getTime() || 0; // Default to date
                      }
                  };

                 valA = getVal(a, state.sortColumn);
                 valB = getVal(b, state.sortColumn);

                  let comparison = 0;
                  if (typeof valA === 'string') {
                      comparison = valA.localeCompare(valB);
                  } else {
                      comparison = valA < valB ? -1 : (valA > valB ? 1 : 0);
                  }

                 return state.sortDirection === 'desc' ? (comparison * -1) : comparison;
             });

             state.filteredTransactions = transactions;
             console.log(`${state.filteredTransactions.length} transa√ß√µes ap√≥s filtro/ordena√ß√£o.`);
        };

        // Combina filtro e renderiza√ß√£o
        const filterAndRender = () => {
             applyFiltersAndSort();
             renderTransactionsTable();
        };

        // ======================================================
        // CALCULATION FUNCTIONS
        // ======================================================

        const calculateMonthlySummary = () => {
            const summary = {
                income: { total: 0, received: 0, pending: 0 },
                expense: { total: 0, paid: 0, pending: 0, scheduled: 0 }, // Adicionado scheduled
                balance: 0, // Saldo Real (caixa)
                committedBalance: 0, // Saldo Projetado
                invoiceTotal: 0,
                invoiceDueDate: null,
                fixedExpenses: 0, // B3
                variableExpenses: 0 // B3
            };

             // Usar state.filteredTransactions J√Å filtradas por m√™s/ano
             state.filteredTransactions.forEach(t => {
                 const amount = parseFloat(t.amount || 0);
                 if (isNaN(amount)) return;

                 if (t.type === 'income') {
                     summary.income.total += amount;
                     if (t.status === 'received') {
                         summary.income.received += amount;
                     } else {
                         summary.income.pending += amount;
                     }
                 } else { // expense
                     summary.expense.total += amount;
                     if (t.status === 'paid') {
                         summary.expense.paid += amount;
                     } else if (t.status === 'scheduled') {
                         summary.expense.scheduled += amount; // Contabiliza agendadas
                         summary.expense.pending += amount; // Agendadas ainda s√£o 'pendentes' de pagamento efetivo
                     }
                     else { // pending
                         summary.expense.pending += amount;
                     }

                      // B3: Soma Fixas vs Vari√°veis
                      if (t.tipoDespesa === 'fixed') {
                          summary.fixedExpenses += amount;
                      } else { // Considera null ou 'variable' como vari√°vel
                          summary.variableExpenses += amount;
                      }

                      // Soma para fatura do cart√£o (APENAS se for cart√£o E N√ÉO estiver paga)
                      // ATEN√á√ÉO: Isso pode duplicar se a l√≥gica de filtro principal j√° considera o m√™s de vencimento.
                      // Idealmente, a fatura deveria ser calculada pelo per√≠odo de fechamento do cart√£o.
                      // Vamos simplificar aqui e somar despesas de cart√£o PENDENTES no m√™s VISUALIZADO.
                     if (t.paymentMethod === 'credito' && t.status !== 'paid') {
                          summary.invoiceTotal += amount;
                     }
                 }
             });

              // Calcular Saldos
             summary.balance = summary.income.received - summary.expense.paid; // O que entrou - o que saiu (efetivamente)
             summary.committedBalance = summary.income.total - summary.expense.total; // Total previsto entrada - total previsto sa√≠da

             // Encontrar pr√≥xima data de vencimento da fatura (simplificado)
             const firstCardWithDueDay = state.cards.find(c => c.dueDay);
             if(firstCardWithDueDay) {
                  const today = new Date();
                  summary.invoiceDueDate = new Date(state.year, state.month, firstCardWithDueDay.dueDay);
                   // Se a data j√° passou neste m√™s, pega a do pr√≥ximo
                   // if (summary.invoiceDueDate < today && today.getDate() > firstCardWithDueDay.dueDay) {
                   //      summary.invoiceDueDate.setMonth(summary.invoiceDueDate.getMonth() + 1);
                   // }
             }


            return summary;
        };

        const calculateCategorySpending = () => {
            const spending = {};
             state.filteredTransactions
                 .filter(t => t.type === 'expense')
                 .forEach(t => {
                     const catName = t.categoryName || 'Sem Categoria';
                     spending[catName] = (spending[catName] || 0) + parseFloat(t.amount || 0);
                 });

             // Ordenar por valor (maior para menor) e pegar top N ou todos
             const sortedCategories = Object.entries(spending)
                 .sort(([, a], [, b]) => b - a);
                 // .slice(0, 10); // Limitar a N categorias se necess√°rio

             return {
                 labels: sortedCategories.map(([label]) => label),
                 values: sortedCategories.map(([, value]) => value)
             };
        };

        const calculateCardLimitUsage = () => {
             if (state.cards.length === 0) {
                 return { labels: ['N/A'], total: [0], used: [0], available: [0] };
             }
             // Simplesmente retorna os totais combinados
             const total = state.cards.reduce((sum, c) => sum + parseFloat(c.limit || 0), 0);
             const available = state.cards.reduce((sum, c) => sum + parseFloat(c.availableLimit || 0), 0);
             const used = total - available;

             // Para o gr√°fico de √°rea, podemos mostrar uma linha constante ou dados hist√≥ricos (complexo)
             // Por simplicidade, mostraremos o estado atual constante ao longo de um eixo X fict√≠cio (ex: dias)
              const daysInMonth = new Date(state.year, state.month + 1, 0).getDate();
              const labels = Array.from({ length: daysInMonth }, (_, i) => i + 1); // Dias 1 a N

             return {
                  labels: labels,
                  total: Array(daysInMonth).fill(total),
                  used: Array(daysInMonth).fill(used),
                  available: Array(daysInMonth).fill(available)
             };
        };

        const calculateAnnualSummary = () => {
            const labels = [];
            const income = [];
            const expense = [];
            const today = new Date();

            for (let i = 11; i >= 0; i--) {
                const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                 const year = date.getFullYear();
                 const month = date.getMonth();
                 labels.push(date.toLocaleString('pt-BR', { month: 'short' }) + `/${String(year).slice(-2)}`);

                 let monthlyIncome = 0;
                 let monthlyExpense = 0;
                 state.transactions.forEach(t => {
                      const tDate = parseLocalDateString(t.date);
                      if (tDate && tDate.getFullYear() === year && tDate.getMonth() === month) {
                           const amount = parseFloat(t.amount || 0);
                           if(t.type === 'income') monthlyIncome += amount;
                           else monthlyExpense += amount;
                      }
                 });
                 income.push(monthlyIncome);
                 expense.push(monthlyExpense);
            }
            return { labels, income, expense };
        };

         const calculatePersonSpending = () => { // B8
             const spending = {};
             state.filteredTransactions // Usa transa√ß√µes j√° filtradas pelo m√™s/ano selecionado
                 .filter(t => t.type === 'expense' && t.pessoaId) // Apenas despesas com pessoa associada
                 .forEach(t => {
                      // Usar nome da pessoa que est√° no estado, caso tenha sido atualizado
                      const person = findPessoaById(t.pessoaId);
                      const personName = person ? person.name : 'Desconhecido';
                      spending[personName] = (spending[personName] || 0) + parseFloat(t.amount || 0);
                 });

              const sortedPeople = Object.entries(spending)
                 .sort(([, a], [, b]) => b - a); // Ordena do maior para o menor gasto

             return {
                 labels: sortedPeople.map(([label]) => label),
                 values: sortedPeople.map(([, value]) => value)
             };
         };


        // ======================================================
        // EVENT HANDLERS & UI LOGIC
        // ======================================================

         // --- Navega√ß√£o Principal ---
         const navigateToSection = (sectionId) => {
             $$('main > section').forEach(sec => sec.classList.remove('active')); // Esconde todas
              const sectionElement = $(`#${sectionId}`);
              if(sectionElement) {
                   sectionElement.classList.add('active');
                   state.currentSection = sectionId;
                   window.scrollTo({ top: 0, behavior: 'smooth' }); // Rola para o topo
                   console.log(`Navegando para: ${sectionId}`);
              } else {
                   console.error(`Se√ß√£o n√£o encontrada: ${sectionId}`);
                   $('#dashboardSection').classList.add('active'); // Volta pro dashboard
                   state.currentSection = 'dashboardSection';
              }
         };

         const setupNavigation = () => {
             $('#navTransactionsBtn')?.addEventListener('click', () => {
                 // Scroll para a tabela de transa√ß√µes dentro do dashboard
                 navigateToSection('dashboardSection'); // Garante que est√° no dashboard
                 const target = $('#transactionsSectionTarget');
                 if (target) {
                      target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                 }
             });
              $('#navInvestmentsBtn')?.addEventListener('click', () => {
                 renderInvestmentsOverview(); // Renderiza a vis√£o geral ao clicar
                 navigateToSection('investmentsSection');
                 // Garante que a sub-se√ß√£o de detalhes esteja oculta
                  $('#investmentOverview').style.display = 'block';
                  $('#investmentDetailSection').style.display = 'none';
                  state.currentInvestmentDetailId = null;
             });
             // Adicionar listeners para outros bot√µes de navega√ß√£o se houver mais se√ß√µes

              // Bot√£o Voltar dos Detalhes do Investimento
              $('#backToInvestmentsBtn')?.addEventListener('click', () => {
                  $('#investmentOverview').style.display = 'block';
                  $('#investmentDetailSection').style.display = 'none';
                  state.currentInvestmentDetailId = null;
              });
         };

         // Navegar para detalhes de um investimento espec√≠fico
         const navigateToInvestmentDetail = (investmentId) => {
              renderInvestmentDetail(investmentId); // Renderiza os detalhes
              $('#investmentOverview').style.display = 'none';
              $('#investmentDetailSection').style.display = 'block';
              window.scrollTo({ top: 0, behavior: 'smooth' });
         };


        // --- Handlers para Modais ---
        const handleOpenTransactionModal = (type, transaction = null) => {
             state.currentItemEditing = transaction; // Guarda transa√ß√£o para edi√ß√£o
             const isEditing = !!transaction;
             const modalTitle = `${isEditing ? 'Editar' : 'Nova'} ${type === 'income' ? 'Receita' : 'Despesa'}`;
             $('#transactionModalTitle').textContent = modalTitle;
             $('#transactionForm').reset(); // Limpa o form
             $('#transactionId').value = isEditing ? transaction.id : '';
             $('#transactionType').value = type;

              // Mostrar/Ocultar campos espec√≠ficos
              $('#incomeFields').style.display = type === 'income' ? 'block' : 'none';
              $('#expenseFields').style.display = type === 'expense' ? 'block' : 'none';

              // Popular categorias baseado no tipo
              populateTransactionCategorySelect(type);

              // Popular status baseado no tipo
              const statusGroup = $('#statusOptions');
              statusGroup.innerHTML = '';
              if (type === 'income') {
                  statusGroup.innerHTML = `
                      <label class="radio-wrapper"><input type="radio" class="radio" name="transactionStatus" value="received"><span class="radio-label-circle"></span><span class="radio-label-text">Recebido</span></label>
                      <label class="radio-wrapper"><input type="radio" class="radio" name="transactionStatus" value="pending"><span class="radio-label-circle"></span><span class="radio-label-text">A Receber</span></label>
                  `;
              } else { // Expense
                  statusGroup.innerHTML = `
                       <label class="radio-wrapper"><input type="radio" class="radio" name="transactionStatus" value="paid"><span class="radio-label-circle"></span><span class="radio-label-text">Pago</span></label>
                       <label class="radio-wrapper"><input type="radio" class="radio" name="transactionStatus" value="pending"><span class="radio-label-circle"></span><span class="radio-label-text">Pendente</span></label>
                       <label class="radio-wrapper"><input type="radio" class="radio" name="transactionStatus" value="scheduled"><span class="radio-label-circle"></span><span class="radio-label-text">Agendado</span></label>
                  `;
                   // Listener para mostrar/ocultar data agendada
                   statusGroup.querySelectorAll('input[name="transactionStatus"]').forEach(radio => {
                       radio.addEventListener('change', (e) => {
                            $('#transactionScheduledDateGroup').style.display = e.target.value === 'scheduled' ? 'block' : 'none';
                       });
                   });
              }

             // Preencher form se for edi√ß√£o
             if (isEditing) {
                  $('#transactionName').value = transaction.name || '';
                  $('#transactionAmount').value = transaction.amount || '';
                  setDateInputValue('transactionDate', transaction.date);
                  $('#transactionCategory').value = transaction.category || '';
                  $('#transactionIsRecurrent').checked = transaction.isRecurrent || false;
                  $('#transactionInstallments').value = transaction.installments || 2;
                  $('#transactionNotes').value = transaction.notes || '';

                  // Selecionar status correto
                  const statusRadio = statusGroup.querySelector(`input[value="${transaction.status}"]`);
                  if (statusRadio) statusRadio.checked = true;

                   if (type === 'expense') {
                       $('#transactionPessoa').value = transaction.pessoaId || ''; // B1
                       const tipoRadio = $(`input[name="transactionTipo"][value="${transaction.tipoDespesa || 'variable'}"]`); // B3
                       if(tipoRadio) tipoRadio.checked = true;
                       $('#transactionPaymentMethod').value = transaction.paymentMethod || '';
                       $('#transactionCreditCard').value = transaction.creditCardId || '';
                       setDateInputValue('transactionDueDate', transaction.dueDate);
                       setDateInputValue('transactionScheduledDate', transaction.scheduledDate);
                       // Mostrar campos de cart√£o e data agendada se necess√°rio
                       $('#transactionCreditCardGroup').style.display = transaction.paymentMethod === 'credito' ? 'block' : 'none';
                       $('#transactionScheduledDateGroup').style.display = transaction.status === 'scheduled' ? 'block' : 'none';
                   } else { // Income
                         $('#incomePaymentMethod').value = transaction.paymentMethod || '';
                   }

                  // Esconder status se for recorrente (ap√≥s preencher)
                  $('#transactionStatusGroup').style.display = transaction.isRecurrent ? 'none' : 'block';
                  $('#transactionRecurrenceGroup').style.display = transaction.isRecurrent ? 'block' : 'none';

             } else {
                 // Valores padr√£o para nova transa√ß√£o
                 setDateInputValue('transactionDate', new Date()); // Hoje
                 if (type === 'expense') {
                      setDateInputValue('transactionDueDate', new Date()); // Hoje como padr√£o
                      $('input[name="transactionStatus"][value="pending"]').checked = true; // Pendente por padr√£o
                      $('input[name="transactionTipo"][value="variable"]').checked = true; // Vari√°vel por padr√£o
                 } else {
                       $('input[name="transactionStatus"][value="received"]').checked = true; // Recebido por padr√£o
                 }
                 $('#transactionIsRecurrent').checked = false;
                 $('#transactionRecurrenceGroup').style.display = 'none';
                 $('#transactionStatusGroup').style.display = 'block';
                 $('#transactionCreditCardGroup').style.display = 'none';
                 $('#transactionScheduledDateGroup').style.display = 'none';
             }

             // Ajustar bot√£o Salvar
             const saveBtn = $('#saveTransactionBtn');
             saveBtn.textContent = isEditing ? 'Salvar Altera√ß√µes' : 'Salvar';
             saveBtn.className = `btn ${type === 'income' ? 'btn-success' : 'btn-danger'}`; // Cor do bot√£o

             openModal('transactionModal');
        };

        const handleSaveTransaction = async () => {
             const id = $('#transactionId').value;
             const type = $('#transactionType').value;
             const isEditing = !!id;

             // Coleta de dados comuns
             const transactionData = {
                  name: $('#transactionName').value.trim(),
                  amount: parseFloat($('#transactionAmount').value),
                  date: getDateInputValue('transactionDate'),
                  category: $('#transactionCategory').value,
                  isRecurrent: $('#transactionIsRecurrent').checked,
                  installments: parseInt($('#transactionInstallments').value) || 1,
                  notes: $('#transactionNotes').value.trim(),
                  type: type,
                  // Status √© pego condicionalmente (ignorado se recorrente)
                   status: $('#transactionIsRecurrent').checked ? null : ($('input[name="transactionStatus"]:checked')?.value || (type === 'income' ? 'pending' : 'pending'))
             };

             // Coleta de dados espec√≠ficos
             if (type === 'expense') {
                  transactionData.pessoaId = $('#transactionPessoa').value || null; // B1
                  transactionData.tipoDespesa = $('input[name="transactionTipo"]:checked')?.value || 'variable'; // B3
                  transactionData.paymentMethod = $('#transactionPaymentMethod').value;
                  transactionData.creditCardId = transactionData.paymentMethod === 'credito' ? ($('#transactionCreditCard').value || null) : null;
                  transactionData.dueDate = getDateInputValue('transactionDueDate');
                  transactionData.scheduledDate = transactionData.status === 'scheduled' ? getDateInputValue('transactionScheduledDate') : null;
             } else { // Income
                   transactionData.paymentMethod = $('#incomePaymentMethod').value;
                   // Zerar campos de despesa que podem ter ficado no objeto
                   transactionData.pessoaId = null;
                   transactionData.tipoDespesa = null;
                   transactionData.creditCardId = null;
                   transactionData.dueDate = null;
                   transactionData.scheduledDate = null;
             }

             // Valida√ß√£o b√°sica
             if (!transactionData.name || isNaN(transactionData.amount) || transactionData.amount <= 0 || !transactionData.date || !transactionData.category || !transactionData.paymentMethod) {
                  showToast('Preencha todos os campos obrigat√≥rios.', 'warning');
                  return;
             }
             if (transactionData.paymentMethod === 'credito' && !transactionData.creditCardId && type === 'expense') {
                 showToast('Selecione um cart√£o de cr√©dito.', 'warning');
                 return;
             }
             if (transactionData.isRecurrent && transactionData.installments < 2) {
                  showToast('N√∫mero de parcelas inv√°lido para recorr√™ncia.', 'warning');
                  return;
             }
             if (transactionData.status === 'scheduled' && !transactionData.scheduledDate && type === 'expense') {
                 showToast('Informe a data de agendamento.', 'warning');
                 return;
             }
             // Definir status padr√£o para recorrentes (se n√£o definido antes)
             if (transactionData.isRecurrent && !transactionData.status) {
                  transactionData.status = type === 'income' ? 'pending' : 'pending';
             }

             let success = false;
             if (isEditing) {
                  // Remover o tipo do objeto de updates, pois n√£o deve ser alterado
                  const { type: _, ...updates } = transactionData;
                  success = await updateTransaction(id, updates);
             } else {
                  const saved = await addTransaction(transactionData);
                  success = !!saved;
             }

             if (success) {
                  closeModal('transactionModal');
                  filterAndRender(); // Atualiza tabela
                  updateAllUI(); // Atualiza KPIs e Gr√°ficos
                  renderInvestmentsOverview(); // Atualiza progresso se afetar aportes (indireto)
             }
        };

         // --- Handlers para Cadastros (Modal Unificado) ---
         const handleCadastrosTabClick = (event) => {
             event.preventDefault();
             const link = event.target.closest('.nav-link');
             if (!link || link.classList.contains('active')) return;

             const tabId = link.dataset.tab;

             // Atualiza abas
             $$('#cadastrosTabs .nav-link').forEach(l => l.classList.remove('active'));
             link.classList.add('active');

             // Atualiza pain√©is
             $$('#cadastrosTabContent .tab-pane').forEach(p => p.classList.remove('active'));
             $(`#${tabId}`)?.classList.add('active');

             // B9: Carrega e renderiza a lista da aba clicada
             switch(tabId) {
                  case 'income-cat': renderCategoriesList('income', '#incomeCategoriesList'); break;
                  case 'expense-cat': renderCategoriesList('expense', '#expenseCategoriesList'); break;
                  case 'payment-methods': renderList('paymentMethods', '#paymentMethodsList', renderPaymentMethodItem); break;
                  case 'pessoas': renderList('pessoas', '#personList', renderPersonItem); break; // B2
             }
         };

         const handleAddCadastroItem = async (event) => {
             event.preventDefault();
             const form = event.target;
             const formId = form.id;
             let data = {};
             let success = false;

             if (formId === 'addIncomeCategoryForm') {
                  const name = $('#newIncomeCategoryInput').value.trim();
                  const icon = $('#newIncomeCategoryIconInput').value.trim();
                  if (!name) { showToast('Nome da categoria √© obrigat√≥rio.', 'warning'); return; }
                  data = { type: 'income', name, icon: icon || 'üí∞' };
                  const saved = await addCategory(data);
                  if(saved) {
                       renderCategoriesList('income', '#incomeCategoriesList'); // Re-renderiza a lista
                       populateCategorySelects(); // Atualiza selects gerais
                       success = true;
                  }
             } else if (formId === 'addExpenseCategoryForm') {
                  const name = $('#newExpenseCategoryInput').value.trim();
                  const icon = $('#newExpenseCategoryIconInput').value.trim();
                   if (!name) { showToast('Nome da categoria √© obrigat√≥rio.', 'warning'); return; }
                  data = { type: 'expense', name, icon: icon || 'üõí' };
                   const saved = await addCategory(data);
                   if(saved) {
                       renderCategoriesList('expense', '#expenseCategoriesList');
                        populateCategorySelects();
                       success = true;
                   }
             } else if (formId === 'addPaymentMethodForm') {
                 const name = $('#newPaymentMethodInput').value.trim();
                 const icon = $('#newPaymentMethodIconInput').value.trim();
                  if (!name) { showToast('Nome da forma de pagamento √© obrigat√≥rio.', 'warning'); return; }
                 data = { name, icon: icon || 'üí≥' };
                  const saved = await addPaymentMethod(data);
                  if(saved) {
                       renderList('paymentMethods', '#paymentMethodsList', renderPaymentMethodItem);
                        populatePaymentMethodSelects();
                       success = true;
                  }
             } else if (formId === 'addPersonForm') { // B2
                 const name = $('#newPersonNameInput').value.trim();
                  if (!name) { showToast('Nome da pessoa √© obrigat√≥rio.', 'warning'); return; }
                 data = { name };
                  const saved = await addPerson(data);
                  if(saved) {
                       renderList('pessoas', '#personList', renderPersonItem);
                       populatePessoaSelects(); // B1/B7
                       success = true;
                  }
             }

             if (success) {
                 form.reset(); // Limpa o formul√°rio espec√≠fico
                 // Resetar preview de √≠cone se houver
                 const iconPreview = form.querySelector('.custom-icon-preview');
                 const defaultIcon = iconPreview?.textContent || '?';
                 if(iconPreview) iconPreview.textContent = defaultIcon;
             }
         };

        const handleEditCadastroItemClick = (event) => {
             const button = event.target.closest('.edit-cadastro-item-btn');
             const itemElement = button?.closest('.tab-list-item');
             if (!itemElement || !itemElement.dataset.id || !itemElement.dataset.type) return;

             const itemId = itemElement.dataset.id;
             const itemType = itemElement.dataset.type; // 'incomeCategory', 'expenseCategory', 'paymentMethod', 'person'
             let itemData = null;

              console.log(`Editando item: ID=${itemId}, Tipo=${itemType}`);

             // Encontrar o item no estado
             switch(itemType) {
                  case 'incomeCategory': itemData = state.categories.income.find(i => i.id === itemId); break;
                  case 'expenseCategory': itemData = state.categories.expense.find(i => i.id === itemId); break;
                  case 'paymentMethod': itemData = state.paymentMethods.find(i => i.id === itemId); break;
                  case 'person': itemData = state.pessoas.find(i => i.id === itemId); break; // B2
             }

             if (!itemData) {
                  showToast('Item n√£o encontrado para edi√ß√£o.', 'error');
                  return;
             }
              state.currentItemEditing = itemData; // Guarda item atual

              // Preencher o modal de edi√ß√£o gen√©rico
              $('#editItemId').value = itemId;
              $('#editItemType').value = itemType;
              $('#editItemName').value = itemData.name || '';

               const iconGroup = $('#editItemIconGroup');
               const iconInput = $('#editItemIconInput');
               const iconPreview = $('#editItemIconPreview');

               if (itemType === 'person') {
                   iconGroup.style.display = 'none'; // N√£o tem √≠cone para pessoa
               } else {
                   iconGroup.style.display = 'block';
                   iconInput.value = itemData.icon || '';
                   const defaultIcon = itemType === 'incomeCategory' ? 'üí∞' : itemType === 'expenseCategory' ? 'üõí' : 'üí≥';
                   iconPreview.textContent = itemData.icon || defaultIcon;
               }

              // Definir t√≠tulo do modal
              let modalTitle = 'Editar Item';
              if(itemType.includes('Category')) modalTitle = 'Editar Categoria';
              else if(itemType === 'paymentMethod') modalTitle = 'Editar Forma de Pagamento';
              else if(itemType === 'person') modalTitle = 'Editar Pessoa';
              $('#editCadastroItemTitle').textContent = modalTitle;

              openModal('editCadastroItemModal');
         };

        const handleSaveEditCadastroItem = async () => {
            const itemId = $('#editItemId').value;
            const itemType = $('#editItemType').value;
            const name = $('#editItemName').value.trim();
            const icon = $('#editItemIconInput').value.trim();

            if (!itemId || !itemType || !name) {
                 showToast('Nome √© obrigat√≥rio.', 'warning');
                 return;
            }

            const updates = { name };
            if (itemType !== 'person') { // Adiciona √≠cone se n√£o for pessoa
                 updates.icon = icon;
            }

             let success = false;
             switch(itemType) {
                  case 'incomeCategory':
                  case 'expenseCategory':
                       success = await updateCategory(itemId, updates);
                       if(success) renderCategoriesList(itemType === 'incomeCategory' ? 'income' : 'expense', `#${itemType.replace('Category', '-cat')} .tab-list-container`);
                       break;
                  case 'paymentMethod':
                       success = await updatePaymentMethod(itemId, updates);
                       if(success) renderList('paymentMethods', '#paymentMethodsList', renderPaymentMethodItem);
                       break;
                   case 'person': // B2
                        success = await updatePerson(itemId, updates); // updatePerson lida apenas com 'name'
                        if(success) renderList('pessoas', '#personList', renderPersonItem);
                       break;
             }

             if (success) {
                 closeModal('editCadastroItemModal');
                 // Atualizar selects gerais que usam esses dados
                 populateCategorySelects();
                 populatePaymentMethodSelects();
                 populatePessoaSelects();
                 filterAndRender(); // Re-renderiza tabela se nomes mudaram
             }
         };

        const handleDeleteCadastroItemClick = (event) => {
            const button = event.target.closest('.delete-cadastro-item-btn');
            const itemElement = button?.closest('.tab-list-item');
            if (!itemElement || !itemElement.dataset.id || !itemElement.dataset.type) return;

            state.currentItemIdToDelete = itemElement.dataset.id;
            state.currentItemTypeToDelete = itemElement.dataset.type;
            state.currentItemToDeleteIsRecurrent = false; // N√£o aplic√°vel aqui

            const itemName = itemElement.querySelector('span:not(.tab-item-icon)')?.textContent || 'este item';
            let message = `Excluir "${itemName}"?`;
             let showMoveMessage = false;

            // Verificar se h√° transa√ß√µes associadas (simplificado, idealmente verificar no DB)
            let hasTransactions = false;
            if (state.currentItemTypeToDelete !== 'person') { // Checagem simplificada
                 hasTransactions = state.transactions.some(t =>
                      (state.currentItemTypeToDelete.includes('Category') && t.category === state.currentItemIdToDelete) ||
                      (state.currentItemTypeToDelete === 'paymentMethod' && t.paymentMethod === state.currentItemIdToDelete)
                 );
            } else { // Checagem para pessoa
                 hasTransactions = state.transactions.some(t => t.pessoaId === state.currentItemIdToDelete);
            }


            if (hasTransactions) {
                 message += ' As transa√ß√µes associadas ser√£o afetadas.'; // Ajustar mensagem conforme a l√≥gica de mover/excluir
                 showMoveMessage = true; // Indica que a mensagem de mover deve aparecer
            }

            $('#deleteConfirmMessage').textContent = message;
            $('#recurrenceDeleteOptions').style.display = 'none'; // Oculta op√ß√µes de recorr√™ncia
            $('#deleteMoveMessage').style.display = showMoveMessage ? 'block' : 'none'; // Mostra msg de mover transa√ß√µes

            openModal('deleteConfirmModal');
        };

        // --- Handlers para Cart√µes ---
        const handleEditCardClick = (cardId) => {
             const card = state.cards.find(c => c.id === cardId);
             if (card) {
                 state.currentCardEditing = card; // Guarda cart√£o atual
                 $('#cardModalTitle').textContent = 'Editar Cart√£o';
                 $('#cardId').value = card.id;
                 $('#cardName').value = card.name;
                 $('#cardLimit').value = card.limit;
                 $('#cardClosingDay').value = card.closingDay;
                 $('#cardDueDay').value = card.dueDay;
                 openModal('newCardModal'); // Reutiliza o modal de novo cart√£o
             }
        };

        const handleSaveCardClick = async () => {
             const id = $('#cardId').value;
             const isEditing = !!id;
             const cardData = {
                  name: $('#cardName').value.trim(),
                  limit: parseFloat($('#cardLimit').value),
                  closingDay: parseInt($('#cardClosingDay').value),
                  dueDay: parseInt($('#cardDueDay').value)
             };

             // Valida√ß√£o
              if (!cardData.name || isNaN(cardData.limit) || cardData.limit <= 0 || isNaN(cardData.closingDay) || cardData.closingDay < 1 || cardData.closingDay > 31 || isNaN(cardData.dueDay) || cardData.dueDay < 1 || cardData.dueDay > 31) {
                  showToast('Preencha todos os campos do cart√£o corretamente.', 'warning');
                  return;
              }

             let success = false;
             if(isEditing) {
                  success = await updateCard(id, cardData);
             } else {
                 const saved = await addCard(cardData);
                 success = !!saved;
             }

             if(success) {
                  closeModal('newCardModal');
                  renderCardsList(); // Atualiza a lista no modal de cart√µes
                  populateCardSelects(); // Atualiza selects em outros formul√°rios
                  updateAllUI(); // Atualiza KPIs e gr√°ficos relacionados
                  $('#cardForm').reset(); // Limpa form
                  $('#cardId').value = ''; // Limpa ID oculto
                   state.currentCardEditing = null;
             }
        };

        const handleDeleteCardClick = (cardId) => {
             state.currentItemIdToDelete = cardId;
             state.currentItemTypeToDelete = 'card';
             const card = state.cards.find(c => c.id === cardId);
             $('#deleteConfirmMessage').textContent = `Excluir o cart√£o "${card?.name || cardId}"? Transa√ß√µes associadas podem ser afetadas.`; // Ajustar msg
             $('#recurrenceDeleteOptions').style.display = 'none';
             $('#deleteMoveMessage').style.display = 'block'; // Avisa sobre transa√ß√µes
             openModal('deleteConfirmModal');
        };

         const openCardInvoiceModal = (cardId) => {
             const card = state.cards.find(c => c.id === cardId);
             if (!card) return;
              state.currentCardEditing = card; // Guarda cart√£o atual para a√ß√£o de pagar

             $('#cardInvoiceTitle').textContent = `Fatura - ${card.name}`;

             // Detalhes da Fatura
              const today = new Date();
              const closingDay = card.closingDay || 1;
              const dueDay = card.dueDay || 1;
              const currentPeriodStart = new Date(today.getFullYear(), today.getMonth() -1, closingDay + 1); // Aproximado
              const currentPeriodEnd = new Date(today.getFullYear(), today.getMonth(), closingDay);
              const nextDueDate = new Date(today.getFullYear(), today.getMonth(), dueDay);
               if (today.getDate() > dueDay) nextDueDate.setMonth(nextDueDate.getMonth() + 1);


              $('#cardInvoiceDetails').innerHTML = `
                 <div style="display: flex; justify-content: space-between; margin-bottom: var(--spacing-xs);">
                     <span>Per√≠odo (aprox): ${formatDate(currentPeriodStart)} a ${formatDate(currentPeriodEnd)}</span>
                     <span>Vencimento: ${formatDate(nextDueDate)}</span>
                 </div>
                  <div style="display: flex; justify-content: space-between;">
                      <span>Limite Total: ${formatCurrency(card.limit)}</span>
                      <span>Disp.: ${formatCurrency(card.availableLimit)}</span>
                      <strong style="color: var(--color-expense);">Fatura: ${formatCurrency(card.currentInvoice || 0)}</strong>
                  </div>
              `;

             // Listar Transa√ß√µes da Fatura (Simplificado: Transa√ß√µes do m√™s atual PENDENTES)
             const invoiceTransactions = state.filteredTransactions.filter(t =>
                  t.type === 'expense' &&
                  t.paymentMethod === 'credito' &&
                  t.creditCardId === cardId &&
                  t.status !== 'paid' // Apenas pendentes ou agendadas
             );
             const tableBody = $('#cardInvoiceTableBody');
             tableBody.innerHTML = '';
             if (invoiceTransactions.length === 0) {
                 tableBody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: var(--spacing-lg);">Nenhuma despesa pendente nesta fatura para o m√™s selecionado.</td></tr>`;
             } else {
                 invoiceTransactions.forEach(t => {
                     const cat = findCategoryById(t.category, t.type);
                     const row = document.createElement('tr');
                     row.innerHTML = `
                         <td class="col-icon"><span class="transaction-icon" style="background-color: rgba(255, 59, 48, 0.1); color: var(--color-expense);">${cat?.icon || 'üõí'}</span></td>
                         <td>${t.name}</td>
                         <td>${formatDate(t.date)}</td>
                         <td class="col-value">${formatCurrency(t.amount)}</td>
                         <td><span class="badge badge-warning">Pendente</span></td>
                     `;
                     tableBody.appendChild(row);
                 });
             }

             // Habilitar/desabilitar bot√£o pagar
              $('#payInvoiceBtn').disabled = (card.currentInvoice || 0) <= 0;


             closeModal('cardsModal'); // Fecha modal de lista
             openModal('cardInvoiceModal');
         };

        // --- Handlers para Investimentos ---
        const handleEditInvestmentClick = (investmentId) => {
             const investment = state.investments.find(inv => inv.id === investmentId);
             if (investment) {
                  state.currentInvestmentEditing = investment;
                  $('#investmentModalTitle').textContent = 'Editar Investimento';
                  $('#investmentId').value = investment.id;
                  $('#investmentName').value = investment.name;
                  $('#investmentInitialValue').value = ''; // Valor inicial n√£o √© edit√°vel diretamente, s√≥ via aportes
                  $('#investmentInitialValue').disabled = true; // Desabilita campo inicial na edi√ß√£o
                  $('#investmentGoalValue').value = investment.goalValue || '';
                  $('#investmentCategory').value = investment.category || '';
                  setDateInputValue('investmentTargetDate', investment.targetDate);
                  $('#investmentNotes').value = investment.notes || '';
                  openModal('investmentModal');
             }
        };

        const handleSaveInvestmentClick = async () => {
             const id = $('#investmentId').value;
             const isEditing = !!id;
             const investmentData = {
                  name: $('#investmentName').value.trim(),
                  initialValue: !isEditing ? parseFloat($('#investmentInitialValue').value || 0) : undefined, // S√≥ na cria√ß√£o
                  goalValue: parseFloat($('#investmentGoalValue').value || 0),
                  category: $('#investmentCategory').value,
                  targetDate: getDateInputValue('investmentTargetDate'),
                  notes: $('#investmentNotes').value.trim()
             };

             if (!investmentData.name || !investmentData.category) {
                  showToast('Nome e Categoria s√£o obrigat√≥rios.', 'warning');
                  return;
             }

             let success = false;
             if (isEditing) {
                  // Remove initialValue que n√£o deve ser atualizado diretamente
                 const { initialValue, ...updates } = investmentData;
                  success = await updateInvestment(id, updates);
             } else {
                  const saved = await addInvestment(investmentData);
                  success = !!saved;
             }

             if (success) {
                  closeModal('investmentModal');
                  renderInvestmentsOverview(); // Atualiza a lista
                  $('#investmentForm').reset();
                  $('#investmentId').value = '';
                   $('#investmentInitialValue').disabled = false; // Habilita de volta para o pr√≥ximo
                  state.currentInvestmentEditing = null;
             }
        };

        const handleDeleteInvestmentClick = (investmentId) => {
             state.currentItemIdToDelete = investmentId;
             state.currentItemTypeToDelete = 'investment';
             const inv = state.investments.find(i => i.id === investmentId);
             $('#deleteConfirmMessage').textContent = `Excluir o objetivo "${inv?.name || investmentId}"? Todos os aportes tamb√©m ser√£o perdidos.`;
             $('#recurrenceDeleteOptions').style.display = 'none';
             $('#deleteMoveMessage').style.display = 'none';
             openModal('deleteConfirmModal');
        };

         const handleAddAporteClick = () => {
             if (!state.currentInvestmentDetailId) return;
             state.currentAporteEditing = null; // Garante que n√£o est√° editando
             $('#aporteModalTitle').textContent = 'Adicionar Valor';
             $('#aporteForm').reset();
             $('#aporteInvestmentId').value = state.currentInvestmentDetailId;
             $('#aporteId').value = '';
             setDateInputValue('aporteDate', new Date()); // Data padr√£o hoje
             $('#saveAporteBtn').textContent = 'Salvar Aporte';
             openModal('aporteModal');
         };

        const handleEditAporteClick = (investmentId, aporteId) => {
             const aporte = state.aportes[investmentId]?.find(a => a.id === aporteId);
             if (aporte) {
                  state.currentAporteEditing = aporte; // Guarda aporte atual
                  $('#aporteModalTitle').textContent = 'Editar Aporte';
                  $('#aporteForm').reset();
                  $('#aporteInvestmentId').value = investmentId;
                  $('#aporteId').value = aporte.id;
                  $('#aporteValue').value = aporte.value;
                  setDateInputValue('aporteDate', aporte.date);
                  $('#aporteDescription').value = aporte.description || '';
                   $('#saveAporteBtn').textContent = 'Salvar Altera√ß√µes';
                  openModal('aporteModal');
             }
        };

         const handleSaveAporteClick = async () => {
             const investmentId = $('#aporteInvestmentId').value;
             const aporteId = $('#aporteId').value;
             const isEditing = !!aporteId;
             const aporteData = {
                  value: parseFloat($('#aporteValue').value || 0),
                  date: getDateInputValue('aporteDate'),
                  description: $('#aporteDescription').value.trim()
             };

             if (isNaN(aporteData.value) || aporteData.value <= 0 || !aporteData.date) {
                  showToast('Valor e Data do aporte s√£o obrigat√≥rios.', 'warning');
                  return;
             }

             let success = false;
             if (isEditing) {
                 success = await updateAporte(investmentId, aporteId, aporteData);
             } else {
                 const saved = await addAporte(investmentId, aporteData);
                 success = !!saved;
             }

             if (success) {
                 closeModal('aporteModal');
                 renderInvestmentDetail(investmentId); // Re-renderiza detalhes e aportes
                 renderInvestmentsOverview(); // Atualiza valor na vis√£o geral
                 state.currentAporteEditing = null;
             }
         };

        const handleDeleteAporteClick = (investmentId, aporteId) => {
             state.currentItemIdToDelete = aporteId;
             state.currentItemTypeToDelete = 'aporte'; // Tipo especial para dele√ß√£o
             state.currentInvestmentDetailId = investmentId; // Guarda o ID do investimento pai
             const aporte = state.aportes[investmentId]?.find(a => a.id === aporteId);
             $('#deleteConfirmMessage').textContent = `Excluir este aporte de ${formatCurrency(aporte?.value || 0)}?`;
             $('#recurrenceDeleteOptions').style.display = 'none';
             $('#deleteMoveMessage').style.display = 'none';
             openModal('deleteConfirmModal');
        };

        // --- Handlers para A√ß√µes da Tabela ---
         const handleTransactionStatusToggle = async (event) => {
             const checkbox = event.target;
             const row = checkbox.closest('tr');
             if (!row || !row.dataset.id) return;

             const transactionId = row.dataset.id;
             const transaction = state.transactions.find(t => t.id === transactionId);
             if (!transaction) return;

             const newStatus = checkbox.checked
                                ? (transaction.type === 'income' ? 'received' : 'paid')
                                : (transaction.type === 'income' ? 'pending' : 'pending'); // Volta para pending

              // Desabilitar checkbox temporariamente para evitar cliques duplos
              checkbox.disabled = true;

             const success = await updateTransaction(transactionId, { status: newStatus });

             if (success) {
                  // Atualizar a UI da linha espec√≠fica (badge e checkbox) sem re-renderizar tudo
                   const statusBadge = row.querySelector('.badge');
                   const statusTextElement = row.querySelector('.col-status'); // C√©lula inteira do status
                   if(statusBadge && statusTextElement) {
                        let statusText = '';
                        let statusClass = '';
                        if (transaction.type === 'income') {
                             if (newStatus === 'received') { statusText = 'Recebido'; statusClass = 'badge-success'; }
                             else { statusText = 'A Receber'; statusClass = 'badge-warning'; }
                        } else {
                             if (newStatus === 'paid') { statusText = 'Pago'; statusClass = 'badge-success'; }
                             else if (newStatus === 'scheduled') { statusText = 'Agendado'; statusClass = 'badge-info'; }
                             else { statusText = 'Pendente'; statusClass = 'badge-warning'; }
                        }
                        statusBadge.textContent = statusText;
                        statusBadge.className = `badge ${statusClass}`;
                   }
                   updateAllUI(); // Atualiza KPIs e Gr√°ficos
             } else {
                  // Reverter o checkbox se a atualiza√ß√£o falhar
                  checkbox.checked = !checkbox.checked;
             }
             // Reabilitar checkbox
             checkbox.disabled = false;
         };

        const handleEditTransactionClick = (event) => {
             const button = event.target.closest('.edit-transaction-btn');
             const row = button?.closest('tr');
             if (!row || !row.dataset.id) return;
             const transaction = state.transactions.find(t => t.id === row.dataset.id);
             if (transaction) {
                  handleOpenTransactionModal(transaction.type, transaction);
             }
        };

         const handleDeleteTransactionClick = (event) => {
             const button = event.target.closest('.delete-transaction-btn');
             const row = button?.closest('tr');
             if (!row || !row.dataset.id) return;
              const transaction = state.transactions.find(t => t.id === row.dataset.id);
             if (transaction) {
                  state.currentItemIdToDelete = transaction.id;
                  state.currentItemTypeToDelete = 'transaction';
                  state.currentItemToDeleteIsRecurrent = transaction.isRecurrent || false;

                  $('#deleteConfirmMessage').textContent = `Excluir a transa√ß√£o "${transaction.name}"?`;
                  $('#recurrenceDeleteOptions').style.display = transaction.isRecurrent ? 'block' : 'none';
                  // Resetar op√ß√£o de recorr√™ncia
                   const singleRadio = $('#recurrenceDeleteOptions input[value="single"]');
                   if(singleRadio) singleRadio.checked = true;
                  $('#deleteMoveMessage').style.display = 'none'; // N√£o aplic√°vel a transa√ß√µes
                  openModal('deleteConfirmModal');
             }
         };

         // --- Handler Gen√©rico para Bot√£o de Exclus√£o Confirmada ---
         const handleConfirmDelete = async () => {
             if (!state.currentItemIdToDelete || !state.currentItemTypeToDelete) return;

             let success = false;
             const id = state.currentItemIdToDelete;
             const type = state.currentItemTypeToDelete;

              console.log(`Confirmando exclus√£o: ID=${id}, Tipo=${type}`);

             // Desabilitar bot√£o para evitar cliques duplos
             $('#confirmDeleteBtn').disabled = true;
             $('#confirmDeleteBtn').textContent = 'Excluindo...';


             switch(type) {
                 case 'transaction':
                     const deleteOption = state.currentItemToDeleteIsRecurrent
                                         ? ($('input[name="deleteRecurrenceOption"]:checked')?.value || 'single')
                                         : 'single';
                     success = await deleteTransaction(id, deleteOption);
                      if (success) filterAndRender(); // Atualiza tabela
                     break;
                 case 'incomeCategory':
                 case 'expenseCategory':
                     success = await deleteCategory(id);
                     if(success) {
                          renderCategoriesList(type === 'incomeCategory' ? 'income' : 'expense', `#${type.replace('Category', '-cat')} .tab-list-container`);
                          populateCategorySelects();
                           filterAndRender();
                     }
                     break;
                  case 'paymentMethod':
                     success = await deletePaymentMethod(id);
                      if(success) {
                           renderList('paymentMethods', '#paymentMethodsList', renderPaymentMethodItem);
                           populatePaymentMethodSelects();
                           filterAndRender();
                      }
                     break;
                 case 'person': // B2
                     success = await deletePerson(id);
                      if(success) {
                           renderList('pessoas', '#personList', renderPersonItem);
                           populatePessoaSelects();
                            filterAndRender();
                      }
                     break;
                 case 'card':
                     success = await deleteCard(id);
                      if(success) {
                           renderCardsList();
                           populateCardSelects();
                            filterAndRender();
                      }
                     break;
                  case 'investment':
                     success = await deleteInvestment(id);
                     if(success) renderInvestmentsOverview();
                     break;
                  case 'aporte':
                      // Precisa do ID do investimento pai guardado em state.currentInvestmentDetailId
                      if(state.currentInvestmentDetailId) {
                           success = await deleteAporte(state.currentInvestmentDetailId, id);
                            if(success) {
                                 renderInvestmentDetail(state.currentInvestmentDetailId); // Re-renderiza detalhes
                                 renderInvestmentsOverview(); // Atualiza valor na vis√£o geral
                            }
                      } else {
                           console.error("ID do investimento pai n√£o encontrado para excluir aporte.");
                      }
                     break;
             }

             // Reabilitar bot√£o e fechar modal
             $('#confirmDeleteBtn').disabled = false;
             $('#confirmDeleteBtn').textContent = 'Excluir';
             if (success) {
                  closeModal('deleteConfirmModal');
                   updateAllUI(); // Garante que KPIs/Gr√°ficos reflitam a exclus√£o
             } else {
                  showToast('Falha ao excluir o item.', 'error');
             }

             // Limpar estado de exclus√£o
             state.currentItemIdToDelete = null;
             state.currentItemTypeToDelete = null;
              state.currentItemToDeleteIsRecurrent = false;
              state.currentInvestmentDetailId = type === 'aporte' ? state.currentInvestmentDetailId : null; // Mant√©m ID do investimento pai se excluiu aporte
         };

        // --- Handlers para Filtros da Tabela ---
        const handleTableFiltersChange = () => {
             state.filters.search = $('#searchInput')?.value || '';
             state.filters.pessoa = $('#filterPessoa')?.value || '';
             state.filters.category = $('#filterCategoria')?.value || '';
             state.filters.tipoDespesa = $('#filterTipoDespesa')?.value || '';
             state.filters.status = $('#filterStatus')?.value || '';
             filterAndRender();
        };

         // --- Handlers para Ordena√ß√£o da Tabela ---
        const handleTableSort = (event) => {
            const header = event.target.closest('th.sortable');
            if (!header) return;

            const column = header.dataset.sort;
            const currentIcon = header.querySelector('.transaction-sort-icon svg use');
            let newDirection;

             // Resetar √≠cones das outras colunas
             $$('th.sortable .transaction-sort-icon').forEach(iconContainer => {
                 if (iconContainer.parentElement !== header) {
                      iconContainer.innerHTML = '<svg><use href="#icon-sort-none"></use></svg>';
                 }
             });


            if (state.sortColumn === column) {
                 // Inverte a dire√ß√£o se j√° est√° selecionada
                 newDirection = state.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                 // Nova coluna selecionada, come√ßa com 'asc' (exceto data, que come√ßa 'desc')
                 newDirection = (column === 'date') ? 'desc' : 'asc';
            }

            state.sortColumn = column;
            state.sortDirection = newDirection;

             // Atualiza o √≠cone da coluna clicada
            const iconName = newDirection === 'asc' ? 'icon-sort-asc' : 'icon-sort-desc';
            header.querySelector('.transaction-sort-icon').innerHTML = `<svg><use href="#${iconName}"></use></svg>`;


            filterAndRender(); // Reordena e re-renderiza
        };


        // ======================================================
        // INITIALIZATION
        // ======================================================
        const initApp = async () => {
            console.log("Iniciando App Gest√£o Financeira V2...");

            initTheme(); // Aplica tema salvo ou do sistema
            setupNavigation(); // Configura links do header
            await loadInitialData(); // Carrega TUDO do Firebase

            // --- ADICIONAR EVENT LISTENERS ---
            // Seletores de Data
            $('#yearSelect')?.addEventListener('change', (e) => { state.year = parseInt(e.target.value); filterAndRender(); updateAllUI(); });
            $('#monthSelect')?.addEventListener('change', (e) => { state.month = parseInt(e.target.value); filterAndRender(); updateAllUI(); });

             // Bot√µes de Nova Transa√ß√£o no Header
             $('#headerNewIncomeBtn')?.addEventListener('click', () => handleOpenTransactionModal('income'));
             $('#headerNewExpenseBtn')?.addEventListener('click', () => handleOpenTransactionModal('expense'));

            // Bot√µes dos Modais Principais
             $('#navCadastrosBtn')?.addEventListener('click', () => openModal('cadastrosModal'));
             $('#navCardsBtn')?.addEventListener('click', () => { renderCardsList(); openModal('cardsModal'); });

            // Modal de Transa√ß√£o
            $('#closeTransactionModal')?.addEventListener('click', () => closeModal('transactionModal'));
            $('#cancelTransactionBtn')?.addEventListener('click', () => closeModal('transactionModal'));
            $('#saveTransactionBtn')?.addEventListener('click', handleSaveTransaction);
             // Listener para mostrar/ocultar campos de cart√£o de cr√©dito no modal
             $('#transactionPaymentMethod')?.addEventListener('change', (e) => {
                  $('#transactionCreditCardGroup').style.display = e.target.value === 'credito' ? 'block' : 'none';
                  // L√≥gica para data de vencimento autom√°tica (se necess√°rio aqui tamb√©m)
             });
             // Listener para recorr√™ncia no modal
             $('#transactionIsRecurrent')?.addEventListener('change', (e) => {
                  $('#transactionRecurrenceGroup').style.display = e.target.checked ? 'block' : 'none';
                  $('#transactionStatusGroup').style.display = e.target.checked ? 'none' : 'block'; // Esconde status se recorrente
             });


            // Modal de Cadastros
            $('#closeCadastrosModal')?.addEventListener('click', () => closeModal('cadastrosModal'));
            $('#closeCadastrosModalBtn')?.addEventListener('click', () => closeModal('cadastrosModal'));
             // Abas
            $$('#cadastrosTabs .nav-link').forEach(link => link.addEventListener('click', handleCadastrosTabClick));
             // Forms de Adi√ß√£o
            $('#addIncomeCategoryForm')?.addEventListener('submit', handleAddCadastroItem);
            $('#addExpenseCategoryForm')?.addEventListener('submit', handleAddCadastroItem);
            $('#addPaymentMethodForm')?.addEventListener('submit', handleAddCadastroItem);
            $('#addPersonForm')?.addEventListener('submit', handleAddCadastroItem); // B2
             // Listeners para bot√µes Editar/Excluir dentro das listas (usando delega√ß√£o no container)
             $('#cadastrosTabContent').addEventListener('click', (event) => {
                 if (event.target.closest('.edit-cadastro-item-btn')) {
                     handleEditCadastroItemClick(event);
                 } else if (event.target.closest('.delete-cadastro-item-btn')) {
                     handleDeleteCadastroItemClick(event);
                 }
             });

             // Modal de Edi√ß√£o de Item de Cadastro
             $('#closeEditCadastroItemModal')?.addEventListener('click', () => closeModal('editCadastroItemModal'));
             $('#cancelEditCadastroItemBtn')?.addEventListener('click', () => closeModal('editCadastroItemModal'));
             $('#saveEditCadastroItemBtn')?.addEventListener('click', handleSaveEditCadastroItem);

             // Modal de Cart√µes
             $('#closeCardsModal')?.addEventListener('click', () => closeModal('cardsModal'));
             $('#openNewCardModalBtn')?.addEventListener('click', () => {
                   state.currentCardEditing = null; // Garante que √© novo cart√£o
                   $('#cardModalTitle').textContent = 'Novo Cart√£o';
                   $('#cardForm').reset();
                   $('#cardId').value = '';
                   openModal('newCardModal');
             });

             // Modal Novo/Editar Cart√£o
             $('#closeNewCardModal')?.addEventListener('click', () => { state.currentCardEditing = null; closeModal('newCardModal'); });
             $('#cancelCardBtn')?.addEventListener('click', () => { state.currentCardEditing = null; closeModal('newCardModal'); });
             $('#saveCardBtn')?.addEventListener('click', handleSaveCardClick);

             // Modal Fatura Cart√£o
             $('#closeCardInvoiceModal')?.addEventListener('click', () => closeModal('cardInvoiceModal'));
             $('#backToCardsListBtn')?.addEventListener('click', () => { closeModal('cardInvoiceModal'); renderCardsList(); openModal('cardsModal'); });
             $('#payInvoiceBtn')?.addEventListener('click', async () => {
                  if(state.currentCardEditing?.id) {
                      const success = await payCardInvoiceAction(state.currentCardEditing.id);
                       if(success) closeModal('cardInvoiceModal');
                  }
             });


             // Modal de Confirma√ß√£o de Exclus√£o
             $('#closeDeleteConfirmModal')?.addEventListener('click', () => closeModal('deleteConfirmModal'));
             $('#cancelDeleteBtn')?.addEventListener('click', () => closeModal('deleteConfirmModal'));
             $('#confirmDeleteBtn')?.addEventListener('click', handleConfirmDelete);

             // Modal Contas Vencidas
             $('#closeOverdueDetailsModal')?.addEventListener('click', () => closeModal('overdueDetailsModal'));
             $('#closeOverdueDetailsBtn')?.addEventListener('click', () => closeModal('overdueDetailsModal'));
             // Listener para 'Pagar Todas' ser√° adicionado quando o modal for aberto

            // Modal Novo/Editar Investimento
            $('#closeInvestmentModal')?.addEventListener('click', () => closeModal('investmentModal'));
            $('#cancelInvestmentBtn')?.addEventListener('click', () => closeModal('investmentModal'));
            $('#saveInvestmentBtn')?.addEventListener('click', handleSaveInvestmentClick);
             $('#newInvestmentBtn')?.addEventListener('click', () => {
                   state.currentInvestmentEditing = null;
                   $('#investmentModalTitle').textContent = 'Novo Investimento';
                   $('#investmentForm').reset();
                   $('#investmentId').value = '';
                    $('#investmentInitialValue').disabled = false; // Garante que est√° habilitado
                   openModal('investmentModal');
             });
             // Bot√µes Editar/Excluir Objetivo na tela de detalhes
              $('#editInvestmentDetailBtn')?.addEventListener('click', () => {
                 if(state.currentInvestmentDetailId) handleEditInvestmentClick(state.currentInvestmentDetailId);
              });
              $('#deleteInvestmentDetailBtn')?.addEventListener('click', () => {
                 if(state.currentInvestmentDetailId) handleDeleteInvestmentClick(state.currentInvestmentDetailId);
              });


             // Modal Adicionar/Editar Aporte
             $('#closeAporteModal')?.addEventListener('click', () => closeModal('aporteModal'));
             $('#cancelAporteBtn')?.addEventListener('click', () => closeModal('aporteModal'));
             $('#saveAporteBtn')?.addEventListener('click', handleSaveAporteClick); // Conecta bot√£o Salvar
             $('#addAporteBtn')?.addEventListener('click', handleAddAporteClick); // Bot√£o na tela de detalhes


             // Filtros da Tabela
             $('#searchInput')?.addEventListener('input', handleTableFiltersChange);
             $('#filterPessoa')?.addEventListener('change', handleTableFiltersChange); // B7
             $('#filterCategoria')?.addEventListener('change', handleTableFiltersChange);
             $('#filterTipoDespesa')?.addEventListener('change', handleTableFiltersChange); // B3
             $('#filterStatus')?.addEventListener('change', handleTableFiltersChange);

             // Ordena√ß√£o da Tabela (Delega√ß√£o no thead)
             $('#transactionsTable thead')?.addEventListener('click', handleTableSort);

            // Preview de √çcones nos forms de cadastro
            $$('input[id$="IconInput"]').forEach(input => {
                 input.addEventListener('input', (e) => {
                      const previewId = e.target.id.replace('Input', 'Preview');
                      const preview = $(`#${previewId}`);
                      if (preview) {
                           const iconValue = e.target.value.trim();
                           if (iconValue) {
                                preview.textContent = iconValue;
                           } else {
                                // Restaurar √≠cone padr√£o baseado no ID
                                let defaultIcon = '‚ùì';
                                if(previewId.includes('Income')) defaultIcon = 'üí∞';
                                else if(previewId.includes('Expense')) defaultIcon = 'üõí';
                                else if(previewId.includes('Payment')) defaultIcon = 'üí≥';
                                preview.textContent = defaultIcon;
                           }
                      }
                 });
            });

        }; // Fim de setupGeneralEventListeners

        const setupDataDependentEventListeners = () => {
             console.log("Configurando listeners dependentes de dados...");
             // Listeners para bot√µes Editar/Excluir em listas renderizadas dinamicamente
             // (Usar delega√ß√£o de eventos nos containers pais)

             // Modal Cadastros: Editar/Excluir Itens
             $('#cadastrosTabContent').addEventListener('click', (event) => {
                 if (event.target.closest('.edit-cadastro-item-btn')) {
                     handleEditCadastroItemClick(event);
                 } else if (event.target.closest('.delete-cadastro-item-btn')) {
                     handleDeleteCadastroItemClick(event);
                 }
             });

             // Modal Lista de Cart√µes: Editar/Excluir/Ver Fatura (j√° configurado em renderCardsList/attachCardActionListeners)
             // A fun√ß√£o attachCardActionListeners √© chamada dentro de renderCardsList

             // Se√ß√£o Investimentos: Editar/Excluir/Ver Detalhes (j√° configurado em renderInvestmentsOverview/attachInvestmentCardActionListeners)
             // A fun√ß√£o attachInvestmentCardActionListeners √© chamada dentro de renderInvestmentsOverview

             // Tabela de Aportes: Editar/Excluir (j√° configurado em renderInvestmentDetail/attachAporteActionListeners)
             // A fun√ß√£o attachAporteActionListeners √© chamada dentro de renderInvestmentDetail

             // Tabela de Transa√ß√µes: Editar/Excluir/Marcar Pago (j√° configurado em renderTransactionsTable/attachTableActionListeners)
             // A fun√ß√£o attachTableActionListeners √© chamada dentro de renderTransactionsTable

             // Modal Contas Vencidas: Pagar Todas / Marcar Pago Individual (Configurado dentro de openOverdueDetailsModal)

        }; // Fim de setupDataDependentEventListeners

        // --- L√≥gica Adicional para Funcionalidades ---

        // B1/B3: Atualiza data de vencimento e readonly baseado no m√©todo de pagamento
        const handlePaymentMethodChangeForDueDate = (isCredit) => {
             const dueDateInput = $('#transactionDueDate');
             const dateInput = $('#transactionDate'); // Data da transa√ß√£o
             const cardSelect = $('#transactionCreditCard'); // Select do cart√£o

             if (!dueDateInput || !dateInput) return;

             if (isCredit) {
                  // √â cart√£o de cr√©dito
                  dueDateInput.readOnly = true;
                  dueDateInput.style.backgroundColor = 'var(--color-surface-variant)';
                  dueDateInput.title = 'Calculado automaticamente pelo cart√£o';

                  const cardId = cardSelect?.value;
                  const compraDate = getDateInputValue('transactionDate');
                  const card = findCardById(cardId); // Fun√ß√£o auxiliar para buscar cart√£o

                  if (card && compraDate) {
                       const vencimento = calcularVencimentoReal(compraDate, card); // Usar fun√ß√£o existente
                       if (vencimento) {
                            setDateInputValue('transactionDueDate', vencimento);
                       } else {
                            // Se n√£o puder calcular, limpar e talvez avisar
                            dueDateInput.value = '';
                       }
                  } else {
                       // Se n√£o selecionou cart√£o ou data, limpar vencimento
                       dueDateInput.value = '';
                  }
             } else {
                  // N√£o √© cart√£o de cr√©dito
                  dueDateInput.readOnly = false;
                  dueDateInput.style.backgroundColor = '';
                  dueDateInput.title = '';
                  // Mant√©m a data que estava ou limpa? Vamos manter.
                  // Se desejar limpar: dueDateInput.value = '';
                  // Se desejar definir como data da compra: setDateInputValue('transactionDueDate', getDateInputValue('transactionDate'));
             }
        };
         // Fun√ß√£o auxiliar para buscar cart√£o (pode ser otimizada)
         const findCardById = (id) => state.cards.find(c => c.id === id);


        // Iniciar a aplica√ß√£o quando o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', initApp);

        // ===================================================================
        // PONTO DE CONTINUA√á√ÉO - FINALIZA√á√ÉO E TESTES
        // ===================================================================
        /*
        * Status Checklist:
        * ‚úÖ A1, A2
        * ‚úÖ A3 (Conex√£o UI->L√≥gica e Fun√ß√µes CRUD b√°sicas implementadas)
        * ‚úÖ B1 (Campo Pessoa integrado ao form e l√≥gica de salvar/carregar)
        * ‚úÖ B2 (CRUD de Pessoas implementado no modal Cadastros)
        * ‚úÖ B3 (C√°lculo KPI e Campo TipoDespesa no form integrados)
        * ‚úÖ B4 (Posicionamento OK via HTML/CSS)
        * ‚úÖ B5 (Se√ß√£o Investimentos e Aportes implementada com CRUD b√°sico)
        * ‚úÖ B6 (Categorias de Investimento fixas implementadas no form)
        * ‚úÖ B7 (Filtro por Pessoa na tabela implementado)
        * ‚úÖ B8 (Gr√°fico Consumo/Pessoa implementado)
        * ‚úÖ B9 (Listagem inicial no modal Cadastros implementada)
        *
        * PROGRESSO: 12/12 tarefas conclu√≠das (100%) - Funcionalidades principais implementadas.
        *
        * Tarefa em Andamento: Finaliza√ß√£o, Testes e Refinamentos.
        * O que foi feito nesta etapa:
        *   - Conectados os bot√µes "Salvar" e "Excluir" dos modais √†s fun√ß√µes JS correspondentes (`handleSave...`, `handleConfirmDelete`).
        *   - Implementada a l√≥gica para coletar dados dos formul√°rios e pass√°-los √†s fun√ß√µes CRUD.
        *   - Implementada a l√≥gica para salvar/carregar `pessoaId` e `tipoDespesa` (B1, B3).
        *   - Implementada a funcionalidade completa de adicionar/editar/excluir Pessoas no modal de Cadastros (B2).
        *   - Implementada a funcionalidade do filtro por Pessoa na tabela (B7).
        *   - Implementada a l√≥gica para dele√ß√£o de itens de cadastro (categorias, m√©todos, pessoas), falta a parte de mover transa√ß√µes.
        *   - Implementada a l√≥gica para dele√ß√£o de cart√µes e investimentos, falta tratar transa√ß√µes/aportes associados.
        *   - Implementada a l√≥gica de salvar/editar/excluir aportes e recalcular total do investimento.
        *   - Adicionados e conectados os event listeners restantes.
        *
        * Pr√≥xima Etapa Espec√≠fica (P√≥s-Gera√ß√£o):
        *   1.  **Testes Funcionais Rigorosos:**
        *       - Adicionar/Editar/Excluir todos os tipos: Transa√ß√µes (Simples/Recorrente/Cart√£o), Categorias, M√©todos, Pessoas, Cart√µes, Investimentos, Aportes.
        *       - Testar todos os filtros e ordena√ß√£o da tabela.
        *       - Testar a navega√ß√£o entre se√ß√µes (Dashboard/Investimentos).
        *       - Testar a atualiza√ß√£o de KPIs e Gr√°ficos ap√≥s cada a√ß√£o CRUD.
        *       - Testar o modal de Cadastros e suas abas (carregamento inicial B9, CRUD).
        *       - Testar o fluxo de Investimentos (Vis√£o geral -> Detalhes -> Aportes).
        *       - Testar o fluxo de Cart√µes (Lista -> Fatura -> Pagar).
        *       - Testar tema claro/escuro e responsividade.
        *   2.  **Refinamento da L√≥gica de Exclus√£o:** Implementar a l√≥gica pendente para mover transa√ß√µes ao excluir categorias/m√©todos/pessoas e tratar transa√ß√µes/aportes ao excluir cart√µes/investimentos, ou definir um comportamento padr√£o (ex: impedir exclus√£o se houver depend√™ncias).
        *   3.  **Refinamento da L√≥gica de Cart√£o:** A l√≥gica de c√°lculo de per√≠odo de fatura e data de vencimento pode precisar de ajustes mais precisos dependendo das regras de neg√≥cio espec√≠ficas (melhor dia de compra, etc.). A a√ß√£o "Pagar Fatura" atual √© simplificada.
        *   4.  **Valida√ß√µes Adicionais:** Adicionar valida√ß√µes mais robustas nos formul√°rios (ex: valores num√©ricos, datas v√°lidas, nomes √∫nicos onde aplic√°vel).
        *   5.  **Melhorias de UX/UI:** Pequenos ajustes visuais, mensagens de feedback mais claras, talvez indicadores de loading mais granulares.
        *   6.  **Otimiza√ß√£o (Opcional):** Analisar performance, especialmente no carregamento de dados e renderiza√ß√£o de listas longas.
        *
        * Instru√ß√µes para Usu√°rio:
        *   - Salve TODO este c√≥digo final como um √∫nico arquivo HTML (ex: `app_v2_final.html`).
        *   - Abra o arquivo no seu navegador.
        *   - **Conecte ao seu Firebase:** Substitua a `firebaseConfig` no in√≠cio do `<script>` pelas suas credenciais reais.
        *   - **Teste exaustivamente** todas as funcionalidades listadas nas "Pr√≥ximas Etapas".
        *   - Relate quaisquer bugs ou comportamentos inesperados para refinamento.
        */

    </script>
</body>
</html>
