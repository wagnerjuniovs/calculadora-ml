<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO_ESTRUTURA_BASE ========================== -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Radar de Retenção</title>

  <!-- Google Fonts - Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Tailwind CSS (via CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#007aff',
            bgLight: '#f9f9f9',
            bgDark: '#1c1c1e',
            cardLight: '#ffffff',
            cardDark: '#2c2c2e',
            textLight: '#1c1c1e',
            textDark: '#f9f9f9',
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif']
          },
          boxShadow: {
            soft: '0 10px 30px rgba(0,0,0,0.1)'
          },
          borderRadius: {
            xl: '1.5rem',
            full: '9999px'
          }
        }
      }
    }
  </script>

  <!-- Estilo customizado para Dark Mode -->
  <style>
    [data-theme="dark"] body { background-color: #1c1c1e; color: #f9f9f9; }
    [data-theme="light"] body { background-color: #f9f9f9; color: #1c1c1e; }
  </style>
</head>
<body class="font-sans">
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO_ESTRUTURA_BASE ============================ -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO 2 - ESTILOS POR TEMA =============== -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<style>
  [data-theme="dark"] {
    --bg-main: #1f1f1f;
    --text-main: #f1f1f1;
    --card-bg: #2a2a2a;
    --card-shadow: rgba(0, 0, 0, 0.4);
    --primary: #3b82f6;
  }

  [data-theme="light"] {
    --bg-main: #f9fafb;
    --text-main: #111827;
    --card-bg: #ffffff;
    --card-shadow: rgba(0, 0, 0, 0.1);
    --primary: #3b82f6;
  }

  body {
    background-color: var(--bg-main);
    color: var(--text-main);
    transition: background-color 0.3s, color 0.3s;
  }

  .card {
    background-color: var(--card-bg);
    box-shadow: 0 4px 6px var(--card-shadow);
    border-radius: 1rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    transition: background-color 0.3s, box-shadow 0.3s;
  }

  .text-primary {
    color: var(--primary);
  }
</style>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO 2 - ESTILOS POR TEMA ==================== -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO_CABEÇALHO_E_CONTROLE_TEMA ============ -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<header class="flex justify-between items-center px-6 py-4">
  <h1 class="text-2xl font-bold text-primary">Radar de Retenção</h1>
  <button id="theme-toggle" class="border border-primary text-primary px-4 py-1 rounded-full transition hover:bg-primary hover:text-white">
    Modo Claro
  </button>
</header>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO_CABEÇALHO_E_CONTROLE_TEMA =============== -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO_FILTROS_INTERATIVOS ================== -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<section class="px-6 py-4 space-y-4 md:space-y-0 md:flex md:items-center md:gap-4 bg-white dark:bg-cardDark rounded-xl shadow-soft mb-4">
  <div class="flex-1">
    <label for="filter-status" class="block text-sm font-medium mb-1">Status</label>
    <select id="filter-status" class="w-full px-4 py-2 rounded-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-cardDark text-sm text-gray-700 dark:text-white">
      <option value="">Todos</option>
    </select>
  </div>
  <div class="flex-1">
    <label for="filter-uf" class="block text-sm font-medium mb-1">UF</label>
    <select id="filter-uf" class="w-full px-4 py-2 rounded-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-cardDark text-sm text-gray-700 dark:text-white">
      <option value="">Todas</option>
    </select>
  </div>
  <div class="flex-1">
    <label for="filter-from" class="block text-sm font-medium mb-1">De</label>
    <input type="date" id="filter-from" class="w-full px-4 py-2 rounded-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-cardDark text-sm text-gray-700 dark:text-white">
  </div>
  <div class="flex-1">
    <label for="filter-to" class="block text-sm font-medium mb-1">Até</label>
    <input type="date" id="filter-to" class="w-full px-4 py-2 rounded-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-cardDark text-sm text-gray-700 dark:text-white">
  </div>
</section>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO_FILTROS_INTERATIVOS ===================== -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO_INDICADORES_KPIS ===================== -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<section class="grid grid-cols-2 md:grid-cols-4 gap-4 px-6 mb-6">
  <div class="bg-white dark:bg-cardDark rounded-xl shadow-soft p-4 text-center">
    <h2 class="text-sm text-gray-500 dark:text-gray-300 mb-1 font-medium">Inativos</h2>
    <p id="count-inativos" class="text-2xl font-bold text-primary">0</p>
  </div>
  <div class="bg-white dark:bg-cardDark rounded-xl shadow-soft p-4 text-center">
    <h2 class="text-sm text-gray-500 dark:text-gray-300 mb-1 font-medium">Ex-Clientes</h2>
    <p id="count-exclientes" class="text-2xl font-bold text-primary">0</p>
  </div>
  <div class="bg-white dark:bg-cardDark rounded-xl shadow-soft p-4 text-center">
    <h2 class="text-sm text-gray-500 dark:text-gray-300 mb-1 font-medium">Reativações</h2>
    <p id="count-reativacoes" class="text-2xl font-bold text-primary">0</p>
  </div>
  <div class="bg-white dark:bg-cardDark rounded-xl shadow-soft p-4 text-center">
    <h2 class="text-sm text-gray-500 dark:text-gray-300 mb-1 font-medium">Taxa de Retenção</h2>
    <p id="count-retencao" class="text-2xl font-bold text-primary">0%</p>
  </div>
</section>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO_INDICADORES_KPIS ======================== -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO_GRÁFICO_LINHA_INATIVOS_REATIVADOS ==== -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<section class="px-6 mb-6">
  <div class="bg-white dark:bg-cardDark rounded-xl shadow-soft p-4">
    <div class="flex justify-between items-center mb-3">
      <h2 class="text-lg font-semibold text-gray-700 dark:text-white">Novos Inativos vs Reativados</h2>
    </div>
    <div class="relative h-72">
      <canvas id="lineChart" class="w-full h-full"></canvas>
    </div>
  </div>
</section>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO_GRÁFICO_LINHA_INATIVOS_REATIVADOS ====== -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO_GRÁFICO_BARRAS_STATUS_TIPO ========== -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<section class="px-6 mb-6">
  <div class="bg-white dark:bg-cardDark rounded-xl shadow-soft p-4">
    <div class="flex justify-between items-center mb-3">
      <h2 class="text-lg font-semibold text-gray-700 dark:text-white">Movimento por Status</h2>
    </div>
    <div class="relative h-72">
      <canvas id="barChart" class="w-full h-full"></canvas>
    </div>
  </div>
</section>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO_GRÁFICO_BARRAS_STATUS_TIPO ============= -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO_GRÁFICO_PIZZA_MOTIVOS_EVASAO ========= -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<section class="px-6 mb-6">
  <div class="bg-white dark:bg-cardDark rounded-xl shadow-soft p-4">
    <div class="flex justify-between items-center mb-3">
      <h2 class="text-lg font-semibold text-gray-700 dark:text-white">Motivos de Evasão</h2>
    </div>
    <div class="relative h-72">
      <canvas id="pieChart" class="w-full h-full"></canvas>
    </div>
  </div>
</section>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO_GRÁFICO_PIZZA_MOTIVOS_EVASAO ============ -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO_GRÁFICO_ROSCA_STATUS_ATUAL ========== -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<section class="px-6 mb-6">
  <div class="bg-white dark:bg-cardDark rounded-xl shadow-soft p-4">
    <div class="flex justify-between items-center mb-3">
      <h2 class="text-lg font-semibold text-gray-700 dark:text-white">Status Atual</h2>
    </div>
    <div class="relative h-72">
      <canvas id="doughnutChart" class="w-full h-full"></canvas>
    </div>
  </div>
</section>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO_GRÁFICO_ROSCA_STATUS_ATUAL ============= -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO_MODAL_DETALHES_CLIENTES ============= -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<div id="detail-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
  <div class="bg-white dark:bg-cardDark rounded-xl shadow-soft p-6 w-full max-w-md max-h-[80vh] overflow-y-auto relative">
    <button class="absolute top-3 right-4 text-2xl text-primary font-bold hover:text-red-500" onclick="document.getElementById('detail-modal').style.display = 'none'">×</button>
    <h2 id="modal-title" class="text-xl font-semibold mb-4 text-primary"></h2>
    <ul id="modal-list" class="list-disc pl-5 space-y-1 text-sm text-gray-700 dark:text-gray-100"></ul>
  </div>
</div>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO_MODAL_DETALHES_CLIENTES ================ -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO_LOADER_CARREGAMENTO_INICIAL ========= -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<div id="loader" class="fixed inset-0 bg-white dark:bg-bgDark flex items-center justify-center z-50">
  <div class="flex flex-col items-center space-y-4">
    <div class="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin"></div>
    <p class="text-sm text-primary font-medium">Carregando dados...</p>
  </div>
</div>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO_LOADER_CARREGAMENTO_INICIAL ============ -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO_TABELA_DETALHADA_CLIENTES =========== -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<section class="px-6 mb-10">
  <div class="bg-white dark:bg-cardDark rounded-xl shadow-soft p-4 overflow-auto">
    <h2 class="text-lg font-semibold mb-4 text-gray-700 dark:text-white">Análise Detalhada de Clientes</h2>
    <table id="tabela-clientes" class="min-w-full text-sm text-left border-separate border-spacing-y-2">
      <thead class="text-xs uppercase text-gray-500 dark:text-gray-300">
        <tr>
          <th class="px-2 py-1">Cliente</th>
          <th class="px-2 py-1">UF</th>
          <th class="px-2 py-1">Status Principal</th>
          <th class="px-2 py-1">Status Atual</th>
          <th class="px-2 py-1">Motivo</th>
          <th class="px-2 py-1">Último Contato</th>
          <th class="px-2 py-1">Previsão de Recompra</th>
        </tr>
      </thead>
      <tbody id="corpo-tabela-clientes" class="text-gray-800 dark:text-gray-100">
        <!-- Os dados serão inseridos via JS -->
      </tbody>
    </table>
  </div>
</section>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO_TABELA_DETALHADA_CLIENTES ============== -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO_INDICADOR_REATIVACAO_ACUMULADA ====== -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<section class="px-6 mb-6">
  <div class="bg-white dark:bg-cardDark rounded-xl shadow-soft p-6 text-center">
    <h2 class="text-base font-medium text-gray-500 dark:text-gray-300 mb-2">Taxa de Reativação Acumulada</h2>
    <p id="indicador-reativacao" class="text-4xl font-bold text-primary">0%</p>
  </div>
</section>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO_INDICADOR_REATIVACAO_ACUMULADA ========= -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO_ALERTA_30DIAS_SEM_CONTATO =========== -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<section class="px-6 mb-6">
  <div class="bg-white dark:bg-cardDark rounded-xl shadow-soft p-6">
    <h2 class="text-base font-semibold text-red-500 mb-3">Clientes com mais de 30 dias sem contato</h2>
    <ul id="lista-alerta-30dias" class="list-disc pl-5 text-sm text-gray-800 dark:text-gray-100 space-y-1">
      <!-- Lista preenchida via JavaScript -->
    </ul>
  </div>
</section>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO_ALERTA_30DIAS_SEM_CONTATO ============== -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO_CONTATOS_DO_DIA ====================== -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<section class="px-6 mb-6">
  <div class="bg-white dark:bg-cardDark rounded-xl shadow-soft p-6">
    <h2 class="text-base font-semibold text-green-600 mb-3">Contatos do Dia (Hoje)</h2>
    <ul id="lista-contatos-dia" class="list-disc pl-5 text-sm text-gray-800 dark:text-gray-100 space-y-1">
      <!-- Itens serão inseridos dinamicamente via JavaScript -->
    </ul>
  </div>
</section>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO_CONTATOS_DO_DIA ========================= -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO_RADAR_RESPONSIVIDADE_STATUS ========= -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<section class="px-6 mb-6">
  <div class="bg-white dark:bg-cardDark rounded-xl shadow-soft p-6">
    <h2 class="text-base font-semibold text-blue-600 mb-4">Tempo Médio Sem Contato por Status Atual</h2>
    <div class="overflow-x-auto">
      <table class="min-w-full text-sm text-left border-separate border-spacing-y-2">
        <thead class="text-xs uppercase text-gray-500 dark:text-gray-300">
          <tr>
            <th class="px-2 py-1">Status Atual</th>
            <th class="px-2 py-1">Dias Médios sem Contato</th>
          </tr>
        </thead>
        <tbody id="tabela-responsividade-status" class="text-gray-800 dark:text-gray-100">
          <!-- Dados preenchidos dinamicamente via JavaScript -->
        </tbody>
      </table>
    </div>
  </div>
</section>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO_RADAR_RESPONSIVIDADE_STATUS ============ -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO_PREVISOES_VENCIDAS ================== -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<section class="px-6 mb-6">
  <div class="bg-white dark:bg-cardDark rounded-xl shadow-soft p-6 border-l-4 border-red-500">
    <h2 class="text-base font-semibold text-red-600 mb-3">Previsões de Recompra Vencidas</h2>
    <ul id="lista-previsoes-vencidas" class="list-disc pl-5 text-sm text-gray-800 dark:text-gray-100 space-y-1">
      <!-- Preenchido via JavaScript com clientes cuja previsão passou e ainda estão inativos -->
    </ul>
  </div>
</section>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO_PREVISOES_VENCIDAS ====================== -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO_PRIORIDADES_NEGOCIACAO ============== -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<section class="px-6 mb-6">
  <div class="bg-white dark:bg-cardDark rounded-xl shadow-soft p-6 border-l-4 border-yellow-400">
    <h2 class="text-base font-semibold text-yellow-600 mb-3">Negociações com Previsão Próxima</h2>
    <ul id="lista-negociacoes-prioritarias" class="list-disc pl-5 text-sm text-gray-800 dark:text-gray-100 space-y-1">
      <!-- Será preenchido via JavaScript com clientes "Em negociação" + previsão nos próximos 7 dias -->
    </ul>
  </div>
</section>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO_PRIORIDADES_NEGOCIACAO ================= -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO_EVOLUCAO_BASE_INATIVA =============== -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<section class="px-6 pb-10">
  <div class="bg-white dark:bg-cardDark rounded-xl shadow-soft p-6">
    <h2 class="text-base font-semibold text-purple-600 mb-4">Evolução da Base Inativa</h2>
    <canvas id="chartEvolucaoInativos" class="w-full h-72"></canvas>
  </div>
</section>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO_EVOLUCAO_BASE_INATIVA ================== -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO JS 1 - TEMA E DADOS INICIAIS ========= -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<script>
  // Ativa modo escuro por padrão
  document.documentElement.dataset.theme = 'dark';

  // Torna a cor primária acessível globalmente
  window.primaryColor = getComputedStyle(document.documentElement)
    .getPropertyValue('--primary')
    .trim();

  document.addEventListener('DOMContentLoaded', async () => {
    const toggleBtn = document.getElementById('theme-toggle');
    const html = document.documentElement;

    const atualizarTextoBotao = () => {
      toggleBtn.textContent = html.dataset.theme === 'light' ? 'Modo Escuro' : 'Modo Claro';
    };

    atualizarTextoBotao(); // Aplica o texto inicial no botão

    toggleBtn.addEventListener('click', () => {
      html.dataset.theme = html.dataset.theme === 'light' ? 'dark' : 'light';
      atualizarTextoBotao();
    });

    const apiBase = 'https://api.sheetbest.com/sheets/3df5ae52-82a9-4306-aa8b-a9169a254cb2';
    const tabs = [
      'Abril_2025', 'Maio_2025', 'Junho_2025',
      'Julho_2025', 'Agosto_2025', 'Setembro_2025',
      'Outubro_2025', 'Novembro_2025', 'Dezembro_2025'
    ];

    window.allData = []; // global para outros blocos
    window.nameMaps = { lineNew:{}, lineRe:{}, bar:{}, pie:{}, doughnut:{} };

    function parseDate(s) {
      if (!s) return NaN;
      const [d, m, y] = s.split('/');
      return new Date(+y, +m - 1, +d);
    }

    window.fetchAllSheets = async function () {
      let combined = [];
      for (const tab of tabs) {
        const res = await fetch(`${apiBase}?sheet=${tab}`);
        const arr = await res.json();
        if (arr.length > 0) {
          combined.push(...arr.map(r => ({ ...r, sheet: tab })));
        }
      }
      return combined;
    }

    // Coleta e organiza os dados iniciais
    const raw = await window.fetchAllSheets();
    window.allData = raw.map(r => ({
      Cliente: (r.Cliente || '').trim(),
      UF: (r.UF || '').trim(),
      Status: (r['Status Principal'] || '').trim(),
      Ativo: (r['Status Atual'] || '').trim(),
      Motivo: (r['Motivo do Status'] || '').trim(),
      Data: parseDate(r['Último Contato']),
      ProxContato: parseDate(r['Próximo Contato']),
      Recompra: parseDate(r['Previsão de Recompra']),
      sheet: r.sheet
    }));

    console.log('[DASHBOARD] Dados carregados:', window.allData.length);

    populateFilters();
    updateDashboard();

    const closeBtn = document.querySelector('.close');
    if (closeBtn) {
      closeBtn.onclick = () => {
        document.getElementById('detail-modal').style.display = 'none';
      };
    }
  });
</script>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO JS 1 - TEMA E DADOS INICIAIS ============ -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO_CONTROLE_TEMA ======================== -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<script>
  // Tema escuro por padrão ao carregar
  document.documentElement.dataset.theme = 'dark';

  document.addEventListener('DOMContentLoaded', () => {
    const toggleBtn = document.getElementById('theme-toggle');
    const html = document.documentElement;

    // Atualiza texto do botão com base no tema atual
    function atualizarTextoBotao() {
      toggleBtn.textContent = html.dataset.theme === 'light' ? 'Modo Escuro' : 'Modo Claro';
    }

    atualizarTextoBotao(); // Ao iniciar

    toggleBtn.addEventListener('click', () => {
      html.dataset.theme = html.dataset.theme === 'light' ? 'dark' : 'light';
      atualizarTextoBotao();
    });
  });
</script>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO_CONTROLE_TEMA =========================== -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO_FILTROS_INTERATIVOS ================== -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<script>
  function populateFilters() {
    const filtroStatus = document.getElementById('filter-status');
    const filtroUF     = document.getElementById('filter-uf');

    // Garante que os filtros fiquem limpos antes de popular
    filtroStatus.innerHTML = '<option value="">Status</option>';
    filtroUF.innerHTML = '<option value="">UF</option>';

    const statusSet = new Set();
    const ufSet = new Set();

    allData.forEach(item => {
      if (item.Status) statusSet.add(item.Status);
      if (item.UF)     ufSet.add(item.UF);
    });

    [...statusSet].sort().forEach(status => {
      filtroStatus.appendChild(new Option(status, status));
    });

    [...ufSet].sort().forEach(uf => {
      filtroUF.appendChild(new Option(uf, uf));
    });

    // Adiciona eventos para atualizar o dashboard ao usar os filtros
    ['change', 'input'].forEach(evt => {
      filtroStatus.addEventListener(evt, updateDashboard);
      filtroUF.addEventListener(evt, updateDashboard);
      document.getElementById('filter-from').addEventListener(evt, updateDashboard);
      document.getElementById('filter-to').addEventListener(evt, updateDashboard);
    });
  }
</script>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO_FILTROS_INTERATIVOS ===================== -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO_KPIS_INDICADORES ===================== -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<script>
  function updateDashboard() {
    const fsV = document.getElementById('filter-status').value;
    const fuV = document.getElementById('filter-uf').value;
    const from = new Date(document.getElementById('filter-from').value);
    const to   = new Date(document.getElementById('filter-to').value);

    const filtrado = allData.filter(x =>
      (!fsV || x.Status === fsV) &&
      (!fuV || x.UF === fuV) &&
      (isNaN(from) || x.Data >= from) &&
      (isNaN(to)   || x.Data <= to)
    );

    console.log('[DASHBOARD] Registros filtrados:', filtrado.length);

    const totalInativos    = filtrado.filter(x => x.Status === 'Inativo').length;
    const totalExClientes  = filtrado.filter(x => x.Status === 'Ex-cliente').length;
    const totalReativados  = filtrado.filter(x => x.Ativo === 'Reativado').length;
    const baseChurn        = filtrado.filter(x => ['Inativo', 'Ex-cliente'].includes(x.Status)).length || 1;
    const taxaRetencao     = Math.round((totalReativados / baseChurn) * 100);

    document.getElementById('count-inativos').textContent     = totalInativos;
    document.getElementById('count-exclientes').textContent   = totalExClientes;
    document.getElementById('count-reativacoes').textContent  = totalReativados;
    document.getElementById('count-retencao').textContent     = `${taxaRetencao}%`;

    // Atualiza gráficos e componentes reativos
    renderLine(filtrado);
    renderBar(filtrado);
    renderPie(filtrado);
    renderDoughnut(filtrado);
  }
</script>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO_KPIS_INDICADORES ======================== -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO_FUNÇÕES_GRÁFICOS ==================== -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<script>
  function parseMonth(m) {
    return {
      Janeiro: 1, Fevereiro: 2, Março: 3, Abril: 4, Maio: 5, Junho: 6,
      Julho: 7, Agosto: 8, Setembro: 9, Outubro: 10, Novembro: 11, Dezembro: 12
    }[m] || 1;
  }

  function renderLine(data) {
    const canvas = document.getElementById('lineChart');
    if (!canvas) return console.warn('❌ lineChart não encontrado.');
    const ctx = canvas.getContext('2d');
    if (!ctx) return console.warn('❌ Contexto 2D ausente em lineChart.');

    const cn = {}, cr = {};
    nameMaps.lineNew = {};
    nameMaps.lineRe = {};

    data.forEach(x => {
      if (!(x.Data instanceof Date) || isNaN(x.Data)) return;
      const lbl = `${x.sheet.split('_')[0]}/${x.Data.getFullYear()}`;
      if (x.Status === 'Inativo') {
        cn[lbl] = (cn[lbl] || 0) + 1;
        (nameMaps.lineNew[lbl] ||= []).push(x.Cliente);
      }
      if (x.Ativo === 'Reativado') {
        cr[lbl] = (cr[lbl] || 0) + 1;
        (nameMaps.lineRe[lbl] ||= []).push(x.Cliente);
      }
    });

    const labels = Object.keys({ ...cn, ...cr }).sort((a, b) => {
      const [ma, ya] = a.split('/'), [mb, yb] = b.split('/');
      return new Date(+ya, parseMonth(ma) - 1) - new Date(+yb, parseMonth(mb) - 1);
    });

    const newV = labels.map(l => cn[l] || 0);
    const reV = labels.map(l => cr[l] || 0);

    if (window.chartLine?.destroy) window.chartLine.destroy();
    window.chartLine = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          { label: 'Inativos', data: newV, borderColor: '#4caf50', fill: false },
          { label: 'Reativados', data: reV, borderColor: primaryColor, fill: false }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom' }, tooltip: { enabled: true } }
      }
    });

    canvas.onclick = e => {
      const pts = window.chartLine.getElementsAtEventForMode(e, 'nearest', { intersect: true }, false);
      if (!pts.length) return;
      const { index, datasetIndex } = pts[0];
      const label = labels[index];
      const lista = datasetIndex === 0 ? nameMaps.lineNew[label] : nameMaps.lineRe[label];
      showModal(`${datasetIndex === 0 ? 'Inativos' : 'Reativados'} (${label})`, lista);
    };
  }

  function renderBar(data) {
    const canvas = document.getElementById('barChart');
    if (!canvas) return console.warn('❌ barChart não encontrado.');
    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    const tipos = ['Inativo', 'Ex-cliente', 'Reativado'];
    const contagem = { Inativo: 0, 'Ex-cliente': 0, Reativado: 0 };
    nameMaps.bar = {};

    data.forEach(x => {
      tipos.forEach(tipo => {
        const cond = tipo === 'Reativado' ? x.Ativo === tipo : x.Status === tipo;
        if (cond) {
          contagem[tipo]++;
          (nameMaps.bar[tipo] ||= []).push(x.Cliente);
        }
      });
    });

    const labels = Object.keys(contagem);
    const valores = labels.map(l => contagem[l]);
    const cores = ['#4caf50', '#007aff', '#ff9800'];

    if (window.chartBar?.destroy) window.chartBar.destroy();
    window.chartBar = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ data: valores, backgroundColor: cores }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false }, tooltip: { enabled: true } }
      }
    });

    canvas.onclick = e => {
      const pts = window.chartBar.getElementsAtEventForMode(e, 'nearest', { intersect: true }, false);
      if (!pts.length) return;
      const i = pts[0].index;
      showModal(labels[i], nameMaps.bar[labels[i]]);
    };
  }

  function renderPie(data) {
    const canvas = document.getElementById('pieChart');
    if (!canvas) return console.warn('❌ pieChart não encontrado.');
    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    const motivos = {};
    const mapas = {};
    data.forEach(x => {
      if (!x.Motivo) return;
      motivos[x.Motivo] = (motivos[x.Motivo] || 0) + 1;
      (mapas[x.Motivo] ||= []).push(x.Cliente);
    });

    const labels = Object.keys(motivos);
    const valores = labels.map(m => motivos[m]);
    nameMaps.pie = mapas;

    if (window.chartPie?.destroy) window.chartPie.destroy();
    window.chartPie = new Chart(ctx, {
      type: 'pie',
      data: { labels, datasets: [{ data: valores }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'right' }, tooltip: { enabled: true } }
      }
    });

    canvas.onclick = e => {
      const pts = window.chartPie.getElementsAtEventForMode(e, 'nearest', { intersect: true }, false);
      if (!pts.length) return;
      const i = pts[0].index;
      showModal(labels[i], mapas[labels[i]]);
    };
  }

  function renderDoughnut(data) {
    const canvas = document.getElementById('doughnutChart');
    if (!canvas) return console.warn('❌ doughnutChart não encontrado.');
    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    const status = {};
    const mapas = {};
    data.forEach(x => {
      if (!x.Ativo) return;
      status[x.Ativo] = (status[x.Ativo] || 0) + 1;
      (mapas[x.Ativo] ||= []).push(x.Cliente);
    });

    const labels = Object.keys(status);
    const valores = labels.map(k => status[k]);
    const cores = ['#2196f3', '#4caf50', '#ffeb3b', '#ff5722'];
    nameMaps.doughnut = mapas;

    if (window.chartDough?.destroy) window.chartDough.destroy();
    window.chartDough = new Chart(ctx, {
      type: 'doughnut',
      data: { labels, datasets: [{ data: valores, backgroundColor: cores }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'right' }, tooltip: { enabled: true } }
      }
    });

    canvas.onclick = e => {
      const pts = window.chartDough.getElementsAtEventForMode(e, 'nearest', { intersect: true }, false);
      if (!pts.length) return;
      const i = pts[0].index;
      showModal(labels[i], mapas[labels[i]]);
    };
  }
</script>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO_FUNÇÕES_GRÁFICOS ======================= -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO_JS_6_MODAL_DETALHES ================== -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<script>
  function showModal(titulo, lista) {
    const modal = document.getElementById('detail-modal');
    const tituloElem = document.getElementById('modal-title');
    const ul = document.getElementById('modal-list');

    tituloElem.textContent = titulo;
    ul.innerHTML = '';

    lista.forEach(nome => {
      const li = document.createElement('li');
      li.textContent = nome;
      ul.appendChild(li);
    });

    modal.style.display = 'flex';
  }
</script>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO_JS_6_MODAL_DETALHES ===================== -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO_JS_7_FECHAR_MODAL ==================== -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const btnFechar = document.querySelector('.modal .close');
    const modal = document.getElementById('detail-modal');

    if (btnFechar && modal) {
      btnFechar.addEventListener('click', () => {
        modal.style.display = 'none';
      });
    }
  });
</script>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO_JS_7_FECHAR_MODAL ======================= -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO_JS_8_CONTROLE_DE_TEMA =============== -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const btnTema = document.getElementById('theme-toggle');
    const html = document.documentElement;

    // Ativa o modo escuro por padrão
    html.dataset.theme = 'dark';

    const atualizarTexto = () => {
      btnTema.textContent = html.dataset.theme === 'light' ? 'Modo Escuro' : 'Modo Claro';
    };

    atualizarTexto();

    btnTema.addEventListener('click', () => {
      html.dataset.theme = html.dataset.theme === 'light' ? 'dark' : 'light';
      atualizarTexto();
    });
  });
</script>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO_JS_8_CONTROLE_DE_TEMA ================== -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO_JS_9_LOADER_VISUAL =================== -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const loader = document.getElementById('loader');

    if (loader) {
      // Exibe o loader antes de buscar os dados
      loader.style.display = 'flex';

      // Aguarda até os dados serem carregados
      fetchAllSheets().then(raw => {
        allData = raw.map(r => ({
          Cliente: (r.Cliente || '').trim(),
          UF: (r.UF || '').trim(),
          Status: (r['Status Principal'] || '').trim(),
          Ativo: (r['Status Atual'] || '').trim(),
          Motivo: (r['Motivo do Status'] || '').trim(),
          Data: parseDate(r['Último Contato']),
          Recompra: (r['Previsão de Recompra'] || '').trim(),
          sheet: r.sheet
        }));

        console.log('✅ Dados carregados:', allData.length);
        populateFilters();
        updateDashboard();
        loader.style.display = 'none'; // esconde o loader ao finalizar
      });
    }
  });
</script>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO_JS_9_LOADER_VISUAL ====================== -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO_JS_10_INIT_SEGURO ==================== -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<script>
  document.addEventListener('DOMContentLoaded', async () => {
    const loader = document.getElementById('loader');

    if (!loader) {
      // Caso o loader não esteja presente, carrega diretamente
      const raw = await fetchAllSheets();
      allData = raw.map(r => ({
        Cliente: (r.Cliente || '').trim(),
        UF: (r.UF || '').trim(),
        Status: (r['Status Principal'] || '').trim(),
        Ativo: (r['Status Atual'] || '').trim(),
        Motivo: (r['Motivo do Status'] || '').trim(),
        Data: parseDate(r['Último Contato']),
        Recompra: (r['Previsão de Recompra'] || '').trim(),
        sheet: r.sheet
      }));

      console.log('✅ Dados carregados (modo direto):', allData.length);
      populateFilters();
      updateDashboard();
    }
  });
</script>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO_JS_10_INIT_SEGURO ======================= -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO_JS_11_EXTRA (RESERVADO) ============== -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<script>
  // Este bloco está reservado para funcionalidades futuras ou testes adicionais

  // Exemplo de ação extra:
  // console.log('🧪 BLOCO_JS_11_EXTRA ativo');

  // Você pode criar interações aqui no futuro
</script>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO_JS_11_EXTRA (RESERVADO) ================= -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO_JS_12_CHARTJS_GLOBAL_CONFIG ========== -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<script>
  Chart.defaults.font.family = 'Inter, sans-serif';
  Chart.defaults.font.size = 14;
  Chart.defaults.color = '#555';

  Chart.defaults.plugins.tooltip.backgroundColor = '#1f2937'; // cinza escuro
  Chart.defaults.plugins.tooltip.titleFont = { weight: '600' };
  Chart.defaults.plugins.tooltip.cornerRadius = 8;
  Chart.defaults.plugins.tooltip.padding = 10;

  Chart.defaults.plugins.legend.labels.boxWidth = 12;
  Chart.defaults.plugins.legend.labels.boxHeight = 12;
  Chart.defaults.plugins.legend.labels.padding = 20;

  Chart.defaults.elements.line.tension = 0.35; // suaviza as linhas
  Chart.defaults.elements.point.radius = 4;
  Chart.defaults.elements.point.hoverRadius = 6;
</script>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO_JS_12_CHARTJS_GLOBAL_CONFIG ============ -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO_JS_13_FUNCOES_UTILITARIAS ============ -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<script>
  // Converte datas do formato DD/MM/AAAA para objeto Date
  function parseDate(s) {
    if (!s) return NaN;
    const [d, m, y] = s.split('/');
    return new Date(+y, +m - 1, +d);
  }

  // Converte datas do formato AAAA-MM-DD para objeto Date
  function parseISO(s) {
    if (!s) return NaN;
    const [y, m, d] = s.split('-');
    return new Date(+y, +m - 1, +d);
  }

  // Converte string tipo "01/04/2025" em "Abril/2025"
  function labelMesAno(dataStr) {
    const [dia, mes, ano] = dataStr.split('/');
    const meses = ['Janeiro','Fevereiro','Março','Abril','Maio','Junho','Julho','Agosto','Setembro','Outubro','Novembro','Dezembro'];
    return `${meses[parseInt(mes) - 1]}/${ano}`;
  }

  // Converte objeto Date em string formatada (DD/MM/AAAA)
  function formatarData(date) {
    const d = date.getDate().toString().padStart(2, '0');
    const m = (date.getMonth() + 1).toString().padStart(2, '0');
    const y = date.getFullYear();
    return `${d}/${m}/${y}`;
  }

  // Calcula diferença de dias entre uma data e hoje
  function diasDesde(data) {
    const hoje = new Date();
    const diff = hoje - data;
    return Math.floor(diff / (1000 * 60 * 60 * 24));
  }
</script>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO_JS_13_FUNCOES_UTILITARIAS ============== -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO JS 14 - PREENCHIMENTO TABELA ======= -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<script>
function preencherTabelaDetalhada(data) {
  const corpo = document.getElementById('corpo-tabela-clientes');
  corpo.innerHTML = ''; // limpa tabela

  data.forEach(x => {
    const linha = document.createElement('tr');
    linha.innerHTML = `
      <td class="px-2 py-1">${x.Cliente}</td>
      <td class="px-2 py-1">${x.UF}</td>
      <td class="px-2 py-1">${x.Status}</td>
      <td class="px-2 py-1">${x.Ativo}</td>
      <td class="px-2 py-1">${x.Motivo}</td>
      <td class="px-2 py-1">${x.Data instanceof Date && !isNaN(x.Data) ? x.Data.toLocaleDateString() : '-'}</td>
      <td class="px-2 py-1">${x.Recompra instanceof Date && !isNaN(x.Recompra) ? x.Recompra.toLocaleDateString() : '-'}</td>
    `;
    corpo.appendChild(linha);
  });
}

// Encaixa na chamada do updateDashboard()
function updateDashboard() {
  const fsV = document.getElementById('filter-status').value;
  const fuV = document.getElementById('filter-uf').value;
  const from = new Date(document.getElementById('filter-from').value);
  const to   = new Date(document.getElementById('filter-to').value);
  const filt = allData.filter(x =>
    (!fsV || x.Status === fsV) &&
    (!fuV || x.UF === fuV) &&
    (isNaN(from) || x.Data >= from) &&
    (isNaN(to)   || x.Data <= to)
  );
  console.log('[DASHBOARD] Registros filtrados:', filt.length);

  document.getElementById('count-inativos').textContent    = filt.filter(x => x.Status === 'Inativo').length;
  document.getElementById('count-exclientes').textContent  = filt.filter(x => x.Status === 'Ex-cliente').length;
  document.getElementById('count-reativacoes').textContent = filt.filter(x => x.Ativo === 'Reativado').length;
  const churn = filt.filter(x => ['Inativo','Ex-cliente'].includes(x.Status)).length || 1;
  document.getElementById('count-retencao').textContent    = Math.round(filt.filter(x => x.Ativo === 'Reativado').length / churn * 100) + '%';

  renderLine(filt);
  renderBar(filt);
  renderPie(filt);
  renderDoughnut(filt);
  preencherTabelaDetalhada(filt); // aqui pintamos a tabela ;)
}
</script>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO JS 14 - PREENCHIMENTO TABELA ============ -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO JS 15 - TAXA DE REATIVAÇÃO ACUMULADA ========= -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<script>
function pintarTaxaReativacao(dados) {
  const totalInativos = dados.filter(x => x.Status === 'Inativo' || x.Status === 'Ex-cliente').length;
  const totalReativados = dados.filter(x => x.Ativo === 'Reativado').length;
  const taxa = totalInativos > 0 ? Math.round((totalReativados / totalInativos) * 100) : 0;

  const alvo = document.getElementById('taxa-reativacao');
  if (alvo) alvo.textContent = taxa + '%';
}
</script>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO JS 15 - TAXA DE REATIVAÇÃO ACUMULADA ============ -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO JS 16 - CLIENTES SEM CONTATO +30 DIAS ===== -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO ===== -->
<!-- ========================================================== -->
<script>
  function pintarSemContato30Dias() {
    const hoje = new Date();
    const container = document.getElementById('painel-sem-contato');
    if (!container) return;

    const lista = window.allData.filter(x => {
      return x.Data instanceof Date && !isNaN(x.Data) && (hoje - x.Data) / (1000 * 60 * 60 * 24) > 30;
    });

    if (lista.length === 0) {
      container.innerHTML += '<p class="text-gray-400 text-sm">Nenhum cliente com mais de 30 dias sem contato.</p>';
      return;
    }

    const ul = document.createElement('ul');
    ul.className = 'list-disc pl-6 text-sm text-white space-y-1';

    lista.slice(0, 10).forEach(x => {
      const li = document.createElement('li');
      li.textContent = `${x.Cliente} - ${x.UF} - ${x.Status} - Último contato: ${x.Data.toLocaleDateString()}`;
      ul.appendChild(li);
    });

    container.appendChild(ul);
  }

  document.addEventListener('DOMContentLoaded', () => {
    if (window.allData?.length) pintarSemContato30Dias();
  });
</script>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO JS 16 - CLIENTES SEM CONTATO +30 DIAS ====== -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO JS 17 - CONTATOS DO DIA (HOJE) ========= -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<script>
  function preencherContatosDoDia(data) {
    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);

    const contatosHoje = data.filter(x => x.ProxContato instanceof Date && !isNaN(x.ProxContato) && x.ProxContato.getTime() === hoje.getTime());

    const container = document.getElementById('bloco-contatos-hoje');
    container.innerHTML = '';

    if (contatosHoje.length === 0) {
      container.innerHTML = '<p class="text-sm text-gray-400">Nenhum contato agendado para hoje.</p>';
      return;
    }

    const ul = document.createElement('ul');
    ul.className = 'list-disc list-inside text-sm';

    contatosHoje.forEach(cliente => {
      const li = document.createElement('li');
      li.textContent = cliente.Cliente + (cliente.UF ? ` (${cliente.UF})` : '');
      ul.appendChild(li);
    });

    container.appendChild(ul);
  }

  // Chamar a função após updateDashboard (garantido via JS 13)
  window.pintoresDashboard.push(preencherContatosDoDia);
</script>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO JS 17 - CONTATOS DO DIA (HOJE) ========== -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO JS 18 - TEMPO MÉDIO SEM CONTATO ======= -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<script>
  function renderDiasMediosSemContato() {
    const container = document.getElementById("tempo-medio-contato");
    if (!container || !window.allData) return;

    const agrupado = {};

    // Agrupa clientes por status atual e soma os dias desde o último contato
    window.allData.forEach((item) => {
      const status = item.Ativo || "Sem status";
      if (!item.Data || isNaN(item.Data)) return;

      const dias = Math.floor((Date.now() - item.Data.getTime()) / (1000 * 60 * 60 * 24));
      if (!agrupado[status]) agrupado[status] = { soma: 0, qtd: 0 };

      agrupado[status].soma += dias;
      agrupado[status].qtd += 1;
    });

    // Limpa conteúdo anterior
    container.innerHTML = "";

    // Cria linhas da tabela
    Object.entries(agrupado).forEach(([status, { soma, qtd }]) => {
      const media = Math.round(soma / qtd);

      const row = document.createElement("div");
      row.className = "flex justify-between px-4 py-2 text-sm";

      row.innerHTML = `
        <span class="text-gray-300">${status}</span>
        <span class="text-gray-100 font-semibold">${media} dias</span>
      `;

      container.appendChild(row);
    });
  }

  // Executa quando o DOM estiver pronto e os dados carregados
  document.addEventListener("DOMContentLoaded", () => {
    if (window.allData?.length) renderDiasMediosSemContato();
    else {
      // Garante que execute quando os dados forem carregados
      const intervalo = setInterval(() => {
        if (window.allData?.length) {
          clearInterval(intervalo);
          renderDiasMediosSemContato();
        }
      }, 300);
    }
  });
</script>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO JS 18 - TEMPO MÉDIO SEM CONTATO =========== -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO JS 19 - PREVISÕES VENCIDAS ========== -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<script>
  function atualizarPrevisoesVencidas() {
    const hoje = new Date();
    const lista = window.allData.filter(x =>
      x.Recompra instanceof Date && !isNaN(x.Recompra) &&
      x.Recompra < hoje &&
      x.Ativo !== 'Reativado'
    ).map(x => x.Cliente);

    const painel = document.getElementById('previsoes-vencidas');
    if (!painel) return;

    if (lista.length > 0) {
      painel.innerHTML = `
        <h2 class="text-red-500 text-lg font-semibold mb-2">Previsões de Recompra Vencidas</h2>
        <ul class="list-disc pl-5 text-gray-100">
          ${lista.map(c => `<li>${c}</li>`).join('')}
        </ul>
      `;
    } else {
      painel.innerHTML = `
        <h2 class="text-red-500 text-lg font-semibold mb-2">Previsões de Recompra Vencidas</h2>
        <p class="text-gray-400">Nenhum cliente com previsão vencida e status pendente.</p>
      `;
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(atualizarPrevisoesVencidas, 1000);
  });
</script>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO JS 19 - PREVISÕES VENCIDAS ============== -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO JS 20 - NEGOCIAÇÕES COM PREVISÃO PRÓXIMA ===== -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO -->
<!-- ========================================================== -->
<script>
  function atualizarNegociacoesComPrevisao() {
    const agora = new Date();
    const emSeteDias = new Date();
    emSeteDias.setDate(agora.getDate() + 7);

    const lista = allData.filter(x => {
      return x.Ativo === 'Em negociação' &&
             x.Recompra instanceof Date &&
             !isNaN(x.Recompra) &&
             x.Recompra >= agora && x.Recompra <= emSeteDias;
    });

    const painel = document.getElementById('negociacoes-previsao-proxima');
    painel.innerHTML = lista.length > 0
      ? '<ul class="list-disc pl-4">' + lista.map(x => `<li>${x.Cliente} - ${x.Recompra.toLocaleDateString()}</li>`).join('') + '</ul>'
      : '<p class="text-sm text-gray-400">Nenhum cliente com previsão próxima.</p>';
  }

  document.addEventListener('DOMContentLoaded', () => {
    atualizarNegociacoesComPrevisao();
  });
</script>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO JS 20 - NEGOCIAÇÕES COM PREVISÃO PRÓXIMA ====== -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->

<!-- ========================================================== -->
<!-- ===== INÍCIO: BLOCO JS 21 - FILTRO POR DATA (VERSÃO FINAL) ===== -->
<!-- ===== EXCLUA A PARTIR DAQUI SE PRECISAR TROCAR ESSE BLOCO ===== -->
<!-- ========================================================== -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const deInput = document.getElementById('filtro-de');
    const ateInput = document.getElementById('filtro-ate');

    function parseInputDate(value) {
      if (!value) return null;
      const parsed = new Date(value);
      if (!isNaN(parsed)) return parsed;

      // Tenta converter formatos tipo "12 de mai. de 2025" ou "12/05/2025"
      const match = value.match(/(\d{1,2})\D+(\d{1,2}|[a-zç]+)\D+(\d{4})/i);
      if (!match) return null;

      const day = parseInt(match[1]);
      let month = isNaN(match[2]) ?
        ['janeiro','fevereiro','março','abril','maio','junho','julho','agosto','setembro','outubro','novembro','dezembro']
          .findIndex(m => m.startsWith(match[2].toLowerCase().slice(0,3))) + 1
        : parseInt(match[2]);

      const year = parseInt(match[3]);
      if (!day || !month || !year) return null;
      return new Date(year, month - 1, day);
    }

    function marcarErroInput(input, erro = true) {
      if (erro) {
        input.classList.add('border-red-500');
        input.title = 'Data inválida';
      } else {
        input.classList.remove('border-red-500');
        input.title = '';
      }
    }

    function aplicarFiltroSeValido() {
      const de = parseInputDate(deInput.value);
      const ate = parseInputDate(ateInput.value);

      const deValido = de instanceof Date && !isNaN(de);
      const ateValido = ate instanceof Date && !isNaN(ate);

      marcarErroInput(deInput, !deValido && deInput.value);
      marcarErroInput(ateInput, !ateValido && ateInput.value);

      if ((deInput.value && !deValido) || (ateInput.value && !ateValido)) return;

      window.filtros = window.filtros || {};
      window.filtros.de = deValido ? de : null;
      window.filtros.ate = ateValido ? ate : null;

      aplicarTodosFiltros();
    }

    // Escutadores para validação ao sair do campo e ao digitar (real-time)
    deInput.addEventListener('change', aplicarFiltroSeValido);
    ateInput.addEventListener('change', aplicarFiltroSeValido);
    deInput.addEventListener('input', aplicarFiltroSeValido);
    ateInput.addEventListener('input', aplicarFiltroSeValido);
  });
</script>
<!-- ========================================================== -->
<!-- ===== FIM: BLOCO JS 21 - FILTRO POR DATA (VERSÃO FINAL) ===== -->
<!-- ===== NÃO EDITE NADA ABAIXO DESSE PONTO NESSE BLOCO ===== -->
<!-- ========================================================== -->
