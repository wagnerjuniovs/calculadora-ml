<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Reativação de Clientes</title>
  <!-- ===== INÍCIO: BLOCO 06 - Estilos Gerais & Apple Palette ===== -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      --radius: 1rem;
      --shadow: 0 8px 24px rgba(0,0,0,0.1);
      --transition: background-color 0.3s ease, color 0.3s ease;
      --bg: #F2F2F7;
      --card-bg: #FFFFFF;
      --text: #1C1C1E;
      --primary: #0A84FF;
      --success: #30D158;
      --warning: #FF9F0A;
      --danger: #FF375F;
      --border: rgba(0,0,0,0.1);
    }
    [data-theme="dark"] {
      --bg: #1C1C1E;
      --card-bg: #2C2C2E;
      --text: #F2F2F7;
      --primary: #0A84FF;
      --success: #30D158;
      --warning: #FF9F0A;
      --danger: #FF375F;
      --border: rgba(255,255,255,0.2);
    }
    *, *::before, *::after { box-sizing: border-box; }
    html, body { margin:0; padding:0; font-family: var(--font-sans); background: var(--bg); color: var(--text); transition: var(--transition); }
    .container { max-width: 1200px; margin: auto; padding: 2rem; }
    .header { display:flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    h1 { font-size: 2rem; margin:0; }
    .filters { display:flex; gap:1rem; }
    select { padding:0.5rem 1rem; border-radius: var(--radius); border:1px solid var(--border); background:var(--card-bg); color:var(--text); }
    .theme-toggle { background:none; border:none; cursor:pointer; }
    .kpis { display:grid; grid-template-columns: repeat(auto-fit,minmax(150px,1fr)); gap:1rem; margin-bottom:2rem; }
    .card { background: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); padding:1.5rem; transition: var(--transition); }
    .charts { display:grid; grid-template-columns: 1fr 1fr; gap:2rem; }
    .full { grid-column: 1 / -1; }
    @media(max-width:768px){ .charts{grid-template-columns:1fr;} }
  </style>
  <!-- ===== FIM: BLOCO 06 - Estilos Gerais & Apple Palette ===== -->
</head>
<body>
  <div class="container">
    <!-- ===== INÍCIO: BLOCO 01 - Header & Filtros ===== -->
    <div class="header">
      <h1>Dashboard de Reativação de Clientes</h1>
      <div style="display:flex;align-items:center;gap:1rem;">
        <div class="filters">
          <select id="filter-uf"><option value="Todos">Todas UFs</option></select>
          <select id="filter-categoria"><option value="Todas">Todas Categorias</option></select>
          <select id="filter-statusPrincipal"><option value="Todos">Status Principal</option></select>
          <select id="filter-statusAtual"><option value="Todos">Status Atual</option></select>
        </div>
        <button class="theme-toggle" id="theme-toggle" aria-label="Alternar Tema"></button>
      </div>
    </div>
    <!-- ===== FIM: BLOCO 01 - Header & Filtros ===== -->

    <!-- ===== INÍCIO: BLOCO 02 - KPIs ===== -->
    <div class="kpis">
      <div class="card" id="kpi-total">Total de Clientes: 0</div>
      <div class="card" id="kpi-reativados">Reativados: 0%</div>
      <div class="card" id="kpi-inativos">Inativos: 0%</div>
      <div class="card" id="kpi-ex">Ex‑clientes: 0%</div>
      <div class="card" id="kpi-contatosSemana">Contatos Semana: 0</div>
      <div class="card" id="kpi-contatosMes">Contatos Mês: 0</div>
      <div class="card" id="kpi-contatosAtrasados">Contatos Atrasados: 0</div>
      <div class="card" id="kpi-mediaDias">Média Dias: 0</div>
      <div class="card" id="kpi-taxaReativacao">Taxa Reativação: 0%</div>
    </div>
    <!-- ===== FIM: BLOCO 02 - KPIs ===== -->

    <!-- ===== INÍCIO: BLOCO 03 - Gráficos ===== -->
    <div class="charts">
      <div class="card"><canvas id="chart-status"></canvas></div>
      <div class="card"><canvas id="chart-evolucao"></canvas></div>
      <div class="card"><canvas id="chart-motivos"></canvas></div>
      <div class="card"><canvas id="chart-uf"></canvas></div>
      <div class="card full"><canvas id="chart-previsao"></canvas></div>
    </div>
    <!-- ===== FIM: BLOCO 03 - Gráficos ===== -->
  </div>

  <script>
    // ===== INÍCIO: BLOCO 04 - Configuração =====
    console.log('INÍCIO: BLOCO 04 - Configuração');
    const API_URL = 'https://api.sheetbest.com/sheets/78734191-4124-48c9-b69f-f2460ec9a294';
    const root = document.documentElement;
    console.log('FIM: BLOCO 04 - Configuração');
    // ===== FIM: BLOCO 04 - Configuração =====

    // ===== INÍCIO: BLOCO 05 - Parsing de Datas =====
    console.log('INÍCIO: BLOCO 05 - Parsing de Datas');
    function parseBRDate(str) {
      if (!str) return null;
      const [d, m, y] = str.split('/').map(Number);
      const date = new Date(y, m-1, d);
      return isNaN(date) ? null : date;
    }
    console.log('FIM: BLOCO 05 - Parsing de Datas');
    // ===== FIM: BLOCO 05 - Parsing de Datas =====

    // ===== INÍCIO: BLOCO 06 - Fetch & Processamento =====
    console.log('INÍCIO: BLOCO 06 - Fetch & Processamento');
    let rawData = [];
    async function fetchData() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        rawData = data.map(item => ({
          cliente: item.cliente,
          uf: item.uf,
          categoria: item.categoria,
          statusPrincipal: item.statusPrincipal,
          motivoStatus: item.motivoStatus,
          ultimoPedido: parseBRDate(item.ultimoPedido),
          ultimoContato: parseBRDate(item.ultimoContato),
          statusAtual: item.statusAtual,
          proximoContato: parseBRDate(item.proximoContato),
          previsaoRecompra: parseBRDate(item.previsaoRecompra),
          mesReferencia: item.mesReferencia,
          ultPedDias: Number(item.ultimoPedidoEmDias)
        }));
        initFilters();
        updateAll();
      } catch (e) { console.error('Erro:', e); }
    }
    fetchData();
    console.log('FIM: BLOCO 06 - Fetch & Processamento');
    // ===== FIM: BLOCO 06 - Fetch & Processamento =====

    // ===== INÍCIO: BLOCO 07 - Classificação =====
    console.log('INÍCIO: BLOCO 07 - Classificação');
    function classify(dias) {
      if (dias <= 120) return 'Reativados';
      if (dias <= 180) return 'Inativos';
      return 'Ex‑clientes';
    }
    console.log('FIM: BLOCO 07 - Classificação');
    // ===== FIM: BLOCO 07 - Classificação =====

    // ===== INÍCIO: BLOCO 08 - Filtros =====
    console.log('INÍCIO: BLOCO 08 - Filtros');
    function initFilters() {
      const fns = ['uf','categoria','statusPrincipal','statusAtual'];
      fns.forEach(fn => {
        const sel = document.getElementById(`filter-${fn}`);
        [...new Set(rawData.map(d=>d[fn]))].sort().forEach(v => sel.add(new Option(v,v)));
        sel.addEventListener('change', updateAll);
      });
    }
    console.log('FIM: BLOCO 08 - Filtros');
    // ===== FIM: BLOCO 08 - Filtros =====

    // ===== INÍCIO: BLOCO 09 - Preparar Dados =====
    console.log('INÍCIO: BLOCO 09 - Preparar Dados');
    function prepareData() {
      const uf = document.getElementById('filter-uf').value;
      const cat = document.getElementById('filter-categoria').value;
      const sp = document.getElementById('filter-statusPrincipal').value;
      const sa = document.getElementById('filter-statusAtual').value;
      return rawData
        .filter(d => (uf==='Todos'||d.uf===uf) && (cat==='Todas'||d.categoria===cat)
                 && (sp==='Todos'||d.statusPrincipal===sp) && (sa==='Todos'||d.statusAtual===sa))
        .map(d => ({ ...d, group: classify(d.ultPedDias) }));
    }
    console.log('FIM: BLOCO 09 - Preparar Dados');
    // ===== FIM: BLOCO 09 - Preparar Dados =====

    // ===== INÍCIO: BLOCO 10 - KPIs =====
    console.log('INÍCIO: BLOCO 10 - KPIs');
    function updateKPIs(data) {
      const total = data.length;
      const counts = {Reativados:0,Inativos:0,'Ex‑clientes':0};
      data.forEach(d=>counts[d.group]++);
      const semana = [], mes=[], atrasado=[];
      const hoje = new Date();
      const day = hoje.getDay();
      const diff = (day+6)%7; // seg=1->diff=0
      const startWeek = new Date(hoje); startWeek.setDate(hoje.getDate()-diff);
      const endWeek = new Date(startWeek); endWeek.setDate(startWeek.getDate()+4);
      data.forEach(d=>{
        const pc = d.proximoContato;
        if(pc){
          if(pc>=startWeek && pc<=endWeek) semana.push(d);
          else if(pc.getMonth()===hoje.getMonth() && pc>hoje) mes.push(d);
          else if(pc<hoje) atrasado.push(d);
        }
      });
      const avg = arr=> arr.reduce((s,d)=>s+d.ultPedDias,0)/arr.length||0;
      document.getElementById('kpi-total').innerText=`Total: ${total}`;
      ['Reativados','Inativos','Ex‑clientes'].forEach(g=>{
        document.getElementById(`kpi-${g.toLowerCase().replace(' ','')}`)
          .innerText=`${g}: ${((counts[g]/total)*100).toFixed(1)}%`;
      });
      document.getElementById('kpi-contatosSemana').innerText=`Semana: ${semana.length}`;
      document.getElementById('kpi-contatosMes').innerText=`Mês: ${mes.length}`;
      document.getElementById('kpi-contatosAtrasados').innerText=`Atrasados: ${atrasado.length}`;
      document.getElementById('kpi-mediaDias').innerText=`Média Dias: ${avg(data).toFixed(0)}`;
      document.getElementById('kpi-taxaReativacao').innerText=
        `Taxa Reativação: ${(counts.Reativados/(counts.Inativos+counts['Ex‑clientes'])*100||0).toFixed(1)}%`;
    }
    console.log('FIM: BLOCO 10 - KPIs');
    // ===== FIM: BLOCO 10 - KPIs =====

    // ===== INÍCIO: BLOCO 11 - Gráficos =====
    console.log('INÍCIO: BLOCO 11 - Gráficos');
    let charts = {};
    function updateCharts(data) {
      // 1: Barra por Status
      const counts = {Reativados:0,Inativos:0,'Ex‑clientes':0}; data.forEach(d=>counts[d.group]++);
      const labels = Object.keys(counts), vals = labels.map(l=>counts[l]);
      const colors = [getComputedStyle(root).getPropertyValue('--success'),
                      getComputedStyle(root).getPropertyValue('--warning'),
                      getComputedStyle(root).getPropertyValue('--danger')];
      if(charts.status) charts.status.destroy();
      charts.status = new Chart(document.getElementById('chart-status'),{ type:'bar', data:{labels, datasets:[{data:vals, backgroundColor:colors}]} });

      // 2: Evolução Inativos vs Ex
      const evoMap={}; data.forEach(d=>{
        evoMap[d.mesReferencia]??={Inativos:0,'Ex‑clientes':0};
        if(d.group==='Inativos') evoMap[d.mesReferencia].Inativos++;
        if(d.group==='Ex‑clientes') evoMap[d.mesReferencia]['Ex‑clientes']++;
      });
      const months=Object.keys(evoMap).sort((a,b)=>new Date(a.split('/').reverse().join('-'))-new Date(b.split('/').reverse().join('-')));
      const ds1={label:'Inativos',data:months.map(m=>evoMap[m].Inativos), borderColor:getComputedStyle(root).getPropertyValue('--warning'), fill:false};
      const ds2={label:'Ex‑clientes',data:months.map(m=>evoMap[m]['Ex‑clientes']), borderColor:getComputedStyle(root).getPropertyValue('--danger'), fill:false};
      if(charts.evolucao) charts.evolucao.destroy();
      charts.evolucao=new Chart(document.getElementById('chart-evolucao'),{type:'line',data:{labels:months,datasets:[ds1,ds2]}});

      // 3: Pizza Motivos
      const motMap={}; data.filter(d=>d.ultPedDias>120).forEach(d=>motMap[d.motivoStatus]=(motMap[d.motivoStatus]||0)+1);
      const mLabels=Object.keys(motMap), mVals=mLabels.map(l=>motMap[l]);
      if(charts.motivos) charts.motivos.destroy();
      charts.motivos=new Chart(document.getElementById('chart-motivos'),{type:'pie',data:{labels:mLabels,datasets:[{data:mVals}]}});

      // 4: Barras Empilhadas UF
      const ufMap={}; data.forEach(d=>{
        ufMap[d.uf]??={Reativados:0,Inativos:0,'Ex‑clientes':0}; ufMap[d.uf][d.group]++;
      });
      const ufs=Object.keys(ufMap), dsUF=['Reativados','Inativos','Ex‑clientes'].map((g,i)=>({label:g,data:ufs.map(u=>ufMap[u][g]), backgroundColor:colors[i]}));
      if(charts.uf) charts.uf.destroy();
      charts.uf=new Chart(document.getElementById('chart-uf'),{type:'bar',data:{labels:ufs,datasets:dsUF},options:{scales:{x:{stacked:true},y:{stacked:true}}}});

      // 5: Previsão Recompra
      const preMap={}; data.filter(d=>d.ultPedDias>120 && d.previsaoRecompra>new Date()).forEach(d=>{
        const key=`${d.previsaoRecompra.getMonth()+1}/${d.previsaoRecompra.getFullYear()}`;
        preMap[key]=(preMap[key]||0)+1;
      });
      const pMonths=Object.keys(preMap).sort((a,b)=>new Date(a.split('/').reverse().join('-'))-new Date(b.split('/').reverse().join('-')));
      const pVals=pMonths.map(m=>preMap[m]);
      if(charts.previsao) charts.previsao.destroy();
      charts.previsao=new Chart(document.getElementById('chart-previsao'),{type:'bar',data:{labels:pMonths,datasets:[{label:'Previsão',data:pVals,backgroundColor:getComputedStyle(root).getPropertyValue('--primary')}]} });
    }
    console.log('FIM: BLOCO 11 - Gráficos');
    // ===== FIM: BLOCO 11 - Gráficos =====

    // ===== INÍCIO: BLOCO 12 - Update All =====
    console.log('INÍCIO: BLOCO 12 - Update All');
    function updateAll() {
      const data = prepareData();
      updateKPIs(data);
      updateCharts(data);
    }
    console.log('FIM: BLOCO 12 - Update All');
    // ===== FIM: BLOCO 12 - Update All =====
  </script>
</body>
</html>
