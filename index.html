<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Radar de Retenção</title>

  <!-- Google Fonts - Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Tailwind CSS (via CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#007aff',
            bgLight: '#f9f9f9',
            bgDark: '#1c1c1e',
            cardLight: '#ffffff',
            cardDark: '#2c2c2e',
            textLight: '#1c1c1e',
            textDark: '#f9f9f9',
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif']
          },
          boxShadow: {
            soft: '0 10px 30px rgba(0,0,0,0.1)'
          },
          borderRadius: {
            xl: '1.5rem',
            full: '9999px'
          }
        }
      }
    }
  </script>

  <style>
    /* Tema escuro/claro - Variáveis de cores */
    :root {
      --bg-main: #f9fafb;
      --text-main: #111827;
      --card-bg: #ffffff;
      --card-shadow: rgba(0, 0, 0, 0.1);
      --primary: #007aff;
      --primary-hover: #0056b3;
      --danger: #dc2626;
      --success: #10b981;
      --warning: #f59e0b;
      --info: #3b82f6;
      --border: #e5e7eb;
    }

    [data-theme="dark"] {
      --bg-main: #1f1f1f;
      --text-main: #f1f1f1;
      --card-bg: #2a2a2a;
      --card-shadow: rgba(0, 0, 0, 0.4);
      --primary: #3b82f6;
      --primary-hover: #2563eb;
      --danger: #ef4444;
      --success: #34d399;
      --warning: #fbbf24;
      --info: #60a5fa;
      --border: #374151;
    }

    /* Estilos globais */
    body {
      background-color: var(--bg-main);
      color: var(--text-main);
      transition: background-color 0.3s, color 0.3s;
      font-family: 'Inter', sans-serif;
    }

    .card {
      background-color: var(--card-bg);
      box-shadow: 0 4px 6px var(--card-shadow);
      border-radius: 1rem;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      transition: background-color 0.3s, box-shadow 0.3s;
    }

    .text-primary {
      color: var(--primary);
    }

    /* Controles e inputs */
    select, input, button {
      background-color: var(--card-bg);
      border: 1px solid var(--border);
      color: var(--text-main);
      border-radius: 0.5rem;
      padding: 0.5rem 1rem;
      transition: all 0.2s;
    }

    select:focus, input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }

    button {
      background-color: var(--primary);
      color: white;
      font-weight: 500;
    }

    button:hover {
      background-color: var(--primary-hover);
    }

    /* Tabelas */
    table {
      width: 100%;
      border-spacing: 0;
    }

    th {
      text-align: left;
      font-weight: 600;
      padding: 0.75rem 1rem;
      color: var(--text-main);
      opacity: 0.7;
    }

    td {
      padding: 0.75rem 1rem;
      border-top: 1px solid var(--border);
    }

    /* Animação de loading */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .animate-spin {
      animation: spin 1s linear infinite;
    }
    
    /* Classe para erros */
    .border-error {
      border-color: var(--danger) !important;
    }

    /* Tooltip personalizado */
    .tooltip {
      position: relative;
      display: inline-block;
    }

    .tooltip .tooltip-text {
      visibility: hidden;
      background-color: rgba(0, 0, 0, 0.8);
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px 10px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 0.75rem;
    }

    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>
<body class="font-sans min-h-screen">
  <header class="flex justify-between items-center px-6 py-4 bg-opacity-90 backdrop-blur-sm sticky top-0 z-10" style="background-color: var(--card-bg);">
    <h1 class="text-2xl font-bold" style="color: var(--primary);">Radar de Retenção</h1>
    <div class="flex items-center gap-4">
      <span id="data-update" class="text-sm opacity-70"></span>
      <button id="theme-toggle" class="px-4 py-2 rounded-full text-sm transition-colors">
        Alternar Tema
      </button>
    </div>
  </header>

  <div id="loader" class="fixed inset-0 flex items-center justify-center z-50" style="background-color: var(--bg-main);">
    <div class="flex flex-col items-center space-y-4">
      <div class="w-12 h-12 border-4 rounded-full animate-spin" style="border-color: var(--primary); border-top-color: transparent;"></div>
      <p class="font-medium" style="color: var(--primary);">Carregando dados...</p>
    </div>
  </div>

  <main class="container mx-auto px-4 py-6">
    <!-- Filtros -->
    <section class="card mb-6">
      <div class="mb-4">
        <h2 class="text-lg font-semibold mb-3">Filtros</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div>
            <label for="filter-status" class="block text-sm font-medium mb-1">Status Principal</label>
            <select id="filter-status" class="w-full">
              <option value="">Todos</option>
            </select>
          </div>
          <div>
            <label for="filter-uf" class="block text-sm font-medium mb-1">UF</label>
            <select id="filter-uf" class="w-full">
              <option value="">Todas</option>
            </select>
          </div>
          <div>
            <label for="filter-from" class="block text-sm font-medium mb-1">De</label>
            <input type="date" id="filter-from" class="w-full">
          </div>
          <div>
            <label for="filter-to" class="block text-sm font-medium mb-1">Até</label>
            <input type="date" id="filter-to" class="w-full">
          </div>
        </div>
      </div>
      <div class="flex justify-end">
        <button id="btn-limpar-filtros" class="px-4 py-2 rounded text-sm mr-2" style="background-color: transparent; border: 1px solid var(--border); color: var(--text-main);">
          Limpar Filtros
        </button>
        <button id="btn-aplicar-filtros" class="px-4 py-2 rounded text-sm" style="background-color: var(--primary);">
          Aplicar Filtros
        </button>
      </div>
    </section>

    <!-- KPIs -->
    <section class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <div class="card !p-4 !m-0 text-center">
        <h2 class="text-sm opacity-70 mb-1">Inativos</h2>
        <p id="count-inativos" class="text-2xl font-bold" style="color: var(--primary);">0</p>
      </div>
      <div class="card !p-4 !m-0 text-center">
        <h2 class="text-sm opacity-70 mb-1">Ex-Clientes</h2>
        <p id="count-exclientes" class="text-2xl font-bold" style="color: var(--primary);">0</p>
      </div>
      <div class="card !p-4 !m-0 text-center">
        <h2 class="text-sm opacity-70 mb-1">Reativações</h2>
        <p id="count-reativacoes" class="text-2xl font-bold" style="color: var(--primary);">0</p>
      </div>
      <div class="card !p-4 !m-0 text-center">
        <h2 class="text-sm opacity-70 mb-1">Taxa de Retenção</h2>
        <p id="count-retencao" class="text-2xl font-bold" style="color: var(--primary);">0%</p>
      </div>
    </section>

    <!-- Gráficos principais -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
  <!-- Gráfico Inativos vs Reativados -->
  <section class="card">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-lg font-semibold">Inativos vs Reativados</h2>
      <div id="inativos-reativados-info" class="text-xs opacity-70">
        <span class="inline-block w-3 h-3 rounded-full mr-1" style="background-color: #ff9800;"></span> Ex‑clientes
        <span class="inline-block w-3 h-3 rounded-full mx-3" style="background-color: #4caf50;"></span> Inativos
        <span class="inline-block w-3 h-3 rounded-full ml-3" style="background-color: var(--primary);"></span> Reativados
      </div>
    </div>
    <div class="h-72 relative">
      <canvas id="chart-inativos-reativados"></canvas>
    </div>
  </section>

  <!-- Gráfico Status Atual -->
  <section class="card">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-lg font-semibold">Status Atual</h2>
    </div>
    <div class="h-72 relative">
      <canvas id="chart-status"></canvas>
    </div>
  </section>
</div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <!-- Gráfico Motivos de Evasão -->
      <section class="card">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold">Motivos de Evasão</h2>
        </div>
        <div class="h-72 relative">
          <canvas id="chart-motivos"></canvas>
        </div>
      </section>

      <!-- Taxa de Reativação por Mês -->
      <section class="card">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold">Taxa de Reativação por Mês</h2>
        </div>
        <div class="h-72 relative">
          <canvas id="chart-taxa-reativacao"></canvas>
        </div>
      </section>
    </div>

    <!-- Alertas -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <!-- Clientes sem contato há mais de 30 dias -->
      <section class="card border-l-4" style="border-left-color: var(--danger);">
        <h2 class="text-lg font-semibold mb-3" style="color: var(--danger);">Clientes sem contato há mais de 30 dias</h2>
        <div id="alerta-sem-contato" class="max-h-60 overflow-y-auto">
          <p class="text-sm opacity-70">Carregando...</p>
        </div>
      </section>

      <!-- Previsões de recompra vencidas -->
      <section class="card border-l-4" style="border-left-color: var(--warning);">
        <h2 class="text-lg font-semibold mb-3" style="color: var(--warning);">Previsões de recompra vencidas</h2>
        <div id="alerta-previsoes-vencidas" class="max-h-60 overflow-y-auto">
          <p class="text-sm opacity-70">Carregando...</p>
        </div>
      </section>
    </div>

    <!-- Tabela de clientes -->
    <section class="card">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold">Análise Detalhada de Clientes</h2>
        <div class="flex items-center">
          <input type="text" id="pesquisa-cliente" placeholder="Pesquisar cliente..." class="text-sm px-3 py-1 mr-2">
          <select id="filtro-tabela-status" class="text-sm px-3 py-1">
            <option value="">Todos os status</option>
          </select>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table id="tabela-clientes" class="min-w-full">
          <thead>
            <tr>
              <th>Cliente</th>
              <th>UF</th>
              <th>Status Principal</th>
              <th>Status Atual</th>
              <th>Motivo</th>
              <th>Último Contato</th>
              <th>Previsão de Recompra</th>
            </tr>
          </thead>
          <tbody id="corpo-tabela-clientes">
            <tr>
              <td colspan="7" class="text-center py-4">Carregando dados...</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="flex justify-between items-center mt-4">
        <div class="text-sm">
          <span id="total-registros">0</span> registros encontrados
        </div>
        <div class="flex items-center">
          <button id="btn-anterior" class="px-3 py-1 rounded mr-2" disabled style="background-color: var(--primary); opacity: 0.5;">Anterior</button>
          <span id="paginacao" class="text-sm mx-2">Página 1 de 1</span>
          <button id="btn-proximo" class="px-3 py-1 rounded" disabled style="background-color: var(--primary); opacity: 0.5;">Próximo</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal para detalhes do cliente -->
  <div id="modal-detalhes" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="max-w-md w-full mx-4 rounded-xl overflow-hidden" style="background-color: var(--card-bg);">
      <div class="flex justify-between items-center p-4 border-b" style="border-color: var(--border);">
        <h3 class="text-lg font-semibold">Detalhes do Cliente</h3>
        <button id="btn-fechar-modal" class="text-2xl font-bold hover:opacity-70">&times;</button>
      </div>
      <div class="p-4" id="modal-conteudo">
        <p class="text-sm opacity-70">Carregando...</p>
      </div>
    </div>
  </div>

  <script>
    // ==========================================
    // BLOCO - CONFIGURAÇÕES INICIAIS
    // ==========================================
    
    // API e configurações
    const API_BASE = 'https://api.sheetbest.com/sheets/78734191-4124-48c9-b69f-f2460ec9a294';
    
    // Armazenamento global de dados
    window.dadosClientes = [];
    window.dadosFiltrados = [];
    window.abas = [];
    window.filtros = {
      status: '',
      uf: '',
      dataInicio: null,
      dataFim: null
    };
    
    // Configuração de paginação da tabela
    window.paginacao = {
      paginaAtual: 1,
      itensPorPagina: 10,
      totalPaginas: 1
    };
    
    // Mapas para armazenar dados dos gráficos
    window.mapasGraficos = {
      inativosVsReativados: {},
      status: {},
      motivos: {}
    };
    
    // Tema atual
    window.temaAtual = localStorage.getItem('tema') || 'dark';
    document.documentElement.dataset.theme = window.temaAtual;

    // Mapeamento correto de colunas da API para uso no código
    window.MAP_COLUNAS = {
      cliente: 'cliente',
      uf: 'uf',
      categoria: 'categoria',
      statusPrincipal: 'statusPrincipal',
      motivoStatus: 'motivoStatus',
      ultimoPedido: 'ultimoPedido',
      ultimoContato: 'ultimoContato',
      statusAtual: 'statusAtual',
      observacao: 'observacao',
      proximoContato: 'proximoContato',
      previsaoRecompra: 'previsaoRecompra',
      mesReferencia: 'mesReferencia',
      responsavel: 'responsavel',
      ultimoPedidoEmDias: 'ultimoPedidoEmDias'
    };

    // Definições para classificação de clientes por dias
    window.LIMITES_CLIENTE = {
      reativado: { min: 0, max: 120 },
      inativo: { min: 121, max: 180 },
      exCliente: { min: 181, max: 5000 }
    };
    
    // ==========================================
    // BLOCO - FUNÇÕES DE UTILIDADE
    // ==========================================
    
    // Converter string de data DD/MM/AAAA para objeto Date
    function converterStringParaData(dataString) {
      if (!dataString) return null;
      
      // Verifica se já é um objeto Date
      if (dataString instanceof Date) return dataString;
      
      // Tenta converter de DD/MM/AAAA
      if (typeof dataString === 'string' && dataString.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
        const [dia, mes, ano] = dataString.split('/').map(Number);
        return new Date(ano, mes - 1, dia);
      }
      
      // Tenta converter de YYYY-MM-DD (formato do input date)
      if (typeof dataString === 'string' && dataString.match(/^\d{4}-\d{2}-\d{2}$/)) {
        return new Date(dataString + 'T00:00:00');
      }
      
      // Para outros formatos, tenta conversão direta
      const data = new Date(dataString);
      return isNaN(data) ? null : data;
    }
    
    // Formatar data para exibição (DD/MM/AAAA)
    function formatarData(data) {
      if (!data || !(data instanceof Date) || isNaN(data)) return '-';
      
      const dia = data.getDate().toString().padStart(2, '0');
      const mes = (data.getMonth() + 1).toString().padStart(2, '0');
      const ano = data.getFullYear();
      return `${dia}/${mes}/${ano}`;
    }
    
    // Formatar data para o formato ISO (YYYY-MM-DD)
    function formatarDataISO(data) {
      if (!data || !(data instanceof Date) || isNaN(data)) return '';
      
      const ano = data.getFullYear();
      const mes = (data.getMonth() + 1).toString().padStart(2, '0');
      const dia = data.getDate().toString().padStart(2, '0');
      return `${ano}-${mes}-${dia}`;
    }
    
    // Calcular dias desde uma data até hoje
    function diasDesde(data) {
      if (!data || !(data instanceof Date) || isNaN(data)) return null;
      
      const hoje = new Date();
      hoje.setHours(0, 0, 0, 0);
      const diff = hoje - data;
      return Math.floor(diff / (1000 * 60 * 60 * 24));
    }
    
    // Extrair mês/ano de uma data para agrupamento
    function extrairMesAno(data) {
      if (!data || !(data instanceof Date) || isNaN(data)) return null;
      
      const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
                     'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
      return `${meses[data.getMonth()]}/${data.getFullYear()}`;
    }
    
    // Mostrar mensagem de erro
    function mostrarErro(mensagem, duracao = 5000) {
      const alerta = document.createElement('div');
      alerta.className = 'fixed bottom-4 right-4 p-4 rounded-lg z-50 text-white text-sm';
      alerta.style.backgroundColor = 'var(--danger)';
      alerta.textContent = mensagem;
      
      document.body.appendChild(alerta);
      
      setTimeout(() => {
        alerta.style.opacity = '0';
        alerta.style.transition = 'opacity 0.5s';
        
        setTimeout(() => {
          document.body.removeChild(alerta);
        }, 500);
      }, duracao);
    }
    
    // Alternar visibilidade do loader
    function toggleLoader(mostrar = true) {
      const loader = document.getElementById('loader');
      if (loader) {
        loader.style.display = mostrar ? 'flex' : 'none';
      }
    }

    // Obter categoria do cliente com base nos dias desde o último pedido
    function categorizarClientePorDias(dias) {
      if (dias === null || dias === undefined) return null;
      
      // Garantir que o valor seja numérico
      dias = parseInt(dias, 10);
      if (isNaN(dias)) return null;
      
      const limites = window.LIMITES_CLIENTE;
      if (dias >= limites.reativado.min && dias <= limites.reativado.max) {
        return 'Reativado';
      } else if (dias >= limites.inativo.min && dias <= limites.inativo.max) {
        return 'Inativo';
      } else if (dias >= limites.exCliente.min && dias <= limites.exCliente.max) {
        return 'Ex-cliente';
      }
      return null;
    }
    
    // ==========================================
    // BLOCO - FUNÇÕES DE CARREGAMENTO DE DADOS
    // ==========================================
    
    // Obter a lista de abas da planilha
    async function obterListaAbas() {
      try {
        const response = await fetch(`${API_BASE}?info=true`);
        const info = await response.json();

        // Se a API retornar direto um array de registros, força uma "aba vazia"
        if (Array.isArray(info)) {
          return [''];
        }
        // Caso padrão, quando existe info.sheets
        if (info && info.sheets) {
          return info.sheets;
        }
        return [];
      } catch (erro) {
        console.error('Erro ao obter lista de abas:', erro);
        mostrarErro('Não foi possível obter a lista de abas da planilha');
        return [];
      }
    }

    // Carregar dados de uma aba específica
    async function carregarDadosAba(nomeAba) {
      try {
        // Se nomeAba for vazio, busca pelo endpoint principal; caso contrário, filtra pela aba
        const url = nomeAba
          ? `${API_BASE}?sheet=${nomeAba}`
          : API_BASE;

        const response = await fetch(url);
        const dados = await response.json();

        if (Array.isArray(dados) && dados.length > 0) {
          console.log(`✅ Carregados ${dados.length} registros da aba "${nomeAba || 'principal'}"`);
          
          return dados.map(registro => {
            // Dias desde o último pedido (garantindo que seja número)
            const diasUltimoPedido = registro[window.MAP_COLUNAS.ultimoPedidoEmDias];
            let diasComoNumero = null;
            
            if (diasUltimoPedido !== null && diasUltimoPedido !== undefined) {
              diasComoNumero = parseInt(diasUltimoPedido, 10);
              if (isNaN(diasComoNumero)) {
                diasComoNumero = null;
              }
            }
            
            // Determinar a categoria do cliente com base nos dias desde o último pedido
            const categoriaCliente = categorizarClientePorDias(diasComoNumero);
            
            return {
              // Dados principais
              Cliente: registro[window.MAP_COLUNAS.cliente] || '',
              UF: registro[window.MAP_COLUNAS.uf] || '',
              Categoria: registro[window.MAP_COLUNAS.categoria] || '',
              // Status principal agora baseado na contagem de dias (não no campo da API)
              Status: categoriaCliente || registro[window.MAP_COLUNAS.statusPrincipal] || '',
              // Campos originais
              StatusOriginal: registro[window.MAP_COLUNAS.statusPrincipal] || '',
              Motivo: registro[window.MAP_COLUNAS.motivoStatus] || '',
              // Status atual do registro
              Ativo: registro[window.MAP_COLUNAS.statusAtual] || '',
              // Datas convertidas
              Data: converterStringParaData(registro[window.MAP_COLUNAS.ultimoContato]),
              ProxContato: converterStringParaData(registro[window.MAP_COLUNAS.proximoContato]),
              Recompra: converterStringParaData(registro[window.MAP_COLUNAS.previsaoRecompra]),
              UltimoPedido: converterStringParaData(registro[window.MAP_COLUNAS.ultimoPedido]),
              // Metadados
              Aba: nomeAba || registro[window.MAP_COLUNAS.mesReferencia] || '',
              DiasDesdeUltimoPedido: diasComoNumero,
              Observacao: registro[window.MAP_COLUNAS.observacao] || ''
            };
          });
        }
        return [];
      } catch (erro) {
        console.error(`Erro ao carregar dados da aba ${nomeAba}:`, erro);
        mostrarErro(`Não foi possível carregar os dados da aba ${nomeAba}`);
        return [];
      }
    }

    // Carregar todos os dados de todas as abas com conteúdo
    async function carregarTodosDados() {
      toggleLoader(true);
      try {
        const listaAbas = await obterListaAbas();
        window.abas = listaAbas;

        let dadosCombinados = [];
        
        // Se não houver abas, tentar carregar direto da API
        if (listaAbas.length === 0) {
          const dadosDiretos = await fetch(API_BASE)
            .then(resp => resp.json())
            .catch(err => {
              console.error('Erro ao carregar dados diretos:', err);
              return [];
            });
            
          if (Array.isArray(dadosDiretos) && dadosDiretos.length > 0) {
            console.log(`✅ Carregados ${dadosDiretos.length} registros diretamente da API`);
            dadosCombinados = dadosDiretos.map(registro => {
              // Dias desde o último pedido (garantindo que seja número)
              const diasUltimoPedido = registro[window.MAP_COLUNAS.ultimoPedidoEmDias];
              let diasComoNumero = null;
              
              if (diasUltimoPedido !== null && diasUltimoPedido !== undefined) {
                diasComoNumero = parseInt(diasUltimoPedido, 10);
                if (isNaN(diasComoNumero)) {
                  diasComoNumero = null;
                }
              }
              
              // Determinar a categoria do cliente com base nos dias desde o último pedido
              const categoriaCliente = categorizarClientePorDias(diasComoNumero);
              
              return {
                // Dados principais
                Cliente: registro[window.MAP_COLUNAS.cliente] || '',
                UF: registro[window.MAP_COLUNAS.uf] || '',
                Categoria: registro[window.MAP_COLUNAS.categoria] || '',
                // Status baseado na contagem de dias
                Status: categoriaCliente || registro[window.MAP_COLUNAS.statusPrincipal] || '',
                // Campos originais
                StatusOriginal: registro[window.MAP_COLUNAS.statusPrincipal] || '',
                Motivo: registro[window.MAP_COLUNAS.motivoStatus] || '',
                // Status atual do registro
                Ativo: registro[window.MAP_COLUNAS.statusAtual] || '',
                // Datas convertidas
                Data: converterStringParaData(registro[window.MAP_COLUNAS.ultimoContato]),
                ProxContato: converterStringParaData(registro[window.MAP_COLUNAS.proximoContato]),
                Recompra: converterStringParaData(registro[window.MAP_COLUNAS.previsaoRecompra]),
                UltimoPedido: converterStringParaData(registro[window.MAP_COLUNAS.ultimoPedido]),
                // Metadados
                Aba: registro[window.MAP_COLUNAS.mesReferencia] || '',
                DiasDesdeUltimoPedido: diasComoNumero,
                Observacao: registro[window.MAP_COLUNAS.observacao] || ''
              };
            });
          }
        } else {
          // Carregar dados de cada aba encontrada
          for (const aba of listaAbas) {
            const dadosAba = await carregarDadosAba(aba);
            if (dadosAba.length > 0) {
              dadosCombinados = [...dadosCombinados, ...dadosAba];
            }
          }
        }

        // Atualiza data de última atualização
        const dataAtualizacao = document.getElementById('data-update');
        if (dataAtualizacao) {
          const agora = new Date();
          dataAtualizacao.textContent = `Atualizado em: ${formatarData(agora)} às ${agora.getHours().toString().padStart(2, '0')}:${agora.getMinutes().toString().padStart(2, '0')}`;
        }

        return dadosCombinados;
      } catch (erro) {
        console.error('Erro ao carregar todos os dados:', erro);
        mostrarErro('Ocorreu um erro ao carregar os dados da planilha');
        return [];
      } finally {
        toggleLoader(false);
      }
    }
