<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Controle Financeiro Familiar</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/pt-br.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
  <style>
    /* ===== Variáveis e Temas Apple ===== */
    :root {
      --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", "Inter", Roboto, Helvetica, Arial, sans-serif;
      --radius-sm: 0.75rem;
      --radius: 1.125rem;
      --radius-lg: 1.5rem;
      --shadow: 0 2px 14px rgba(0,0,0,0.06), 0 8px 24px rgba(0,0,0,0.04);
      --shadow-hover: 0 4px 18px rgba(0,0,0,0.08), 0 10px 28px rgba(0,0,0,0.06);
      --shadow-dropdown: 0 4px 20px rgba(0,0,0,0.1);
      --transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      
      /* Cores iOS/macOS Light */
      --bg: #F5F5F7;
      --card-bg: #FFFFFF;
      --input-bg: rgba(142, 142, 147, 0.12);
      --text: #1D1D1F;
      --text-secondary: #86868B;
      --primary: #0066CC;
      --primary-light: #147CE5;
      --success: #34C759;
      --warning: #FF9F0A;
      --danger: #FF3B30;
      --info: #5AC8FA;
      --purple: #AF52DE;
      --teal: #64D2FF;
      --border: rgba(0,0,0,0.08);
      --chart-grid: rgba(0,0,0,0.04);
      --menu-bg: rgba(255, 255, 255, 0.9);
      --receipt-bg: #FBFBFD;
    }
    
    [data-theme="dark"] {
      /* Cores iOS/macOS Dark */
      --bg: #1D1D1F;
      --card-bg: #2C2C2E;
      --input-bg: rgba(142, 142, 147, 0.18);
      --text: #F5F5F7;
      --text-secondary: #98989D;
      --primary: #0A84FF;
      --primary-light: #5AC8FA;
      --success: #30D158;
      --warning: #FF9F0A;
      --danger: #FF453A;
      --info: #64D2FF;
      --purple: #BF5AF2;
      --teal: #6AC4DC;
      --border: rgba(255,255,255,0.12);
      --chart-grid: rgba(255,255,255,0.06);
      --menu-bg: rgba(44, 44, 46, 0.9);
      --receipt-bg: #323234;
    }
    
    /* ===== Reset e Configurações Base ===== */
    *, *::before, *::after { 
      box-sizing: border-box; 
      margin: 0;
      padding: 0;
    }
    
    html, body { 
      font-family: var(--font-sans); 
      background: var(--bg); 
      color: var(--text); 
      transition: var(--transition);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      font-size: 16px;
      line-height: 1.5;
      width: 100%;
      overflow-x: hidden;
    }
    
    /* ===== Layout e Componentes ===== */
    .container { 
      max-width: 1280px; 
      margin: 0 auto; 
      padding: 2rem; 
    }
    
    .header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 2rem; 
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .header-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    h1 { 
      font-size: 1.75rem; 
      font-weight: 700;
      margin: 0;
      letter-spacing: -0.025em;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .filters { 
      display: flex; 
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    
    /* Select estilo Apple */
    select { 
      appearance: none;
      -webkit-appearance: none;
      padding: 0.625rem 2rem 0.625rem 1rem;
      border-radius: var(--radius-sm); 
      border: none;
      background: var(--input-bg) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='6' fill='none'%3E%3Cpath fill='%2386868b' d='M6 6 0 0h12L6 6Z'/%3E%3C/svg%3E") no-repeat;
      background-position: right 0.75rem center;
      color: var(--text);
      font-family: var(--font-sans);
      font-size: 0.9375rem;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
    }
    
    select:hover {
      background-color: rgba(142, 142, 147, 0.18);
    }
    
    select option {
      background-color: var(--card-bg);
      color: var(--text);
    }
    
    /* Botões */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.625rem 1.25rem;
      border-radius: var(--radius-sm);
      font-weight: 500;
      font-size: 0.9375rem;
      cursor: pointer;
      transition: var(--transition);
      border: none;
      color: #fff;
      background-color: var(--primary);
    }
    
    .btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }
    
    .btn-primary {
      background-color: var(--primary);
    }
    
    .btn-success {
      background-color: var(--success);
    }
    
    .btn-warning {
      background-color: var(--warning);
    }
    
    .btn-danger {
      background-color: var(--danger);
    }
    
    .btn-icon {
      width: 2.5rem;
      height: 2.5rem;
      padding: 0;
      border-radius: 50%;
      background: var(--input-bg);
      color: var(--text);
    }
    
    .btn-icon:hover {
      background-color: rgba(142, 142, 147, 0.2);
    }
    
    .btn-icon svg {
      width: 1.25rem;
      height: 1.25rem;
    }
    
    /* Botão toggle theme */
    .theme-toggle {
      background: var(--input-bg);
      border: none;
      border-radius: 50%;
      width: 2.5rem;
      height: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text);
      transition: var(--transition);
    }
    
    .theme-toggle:hover {
      background-color: rgba(142, 142, 147, 0.2);
    }
    
    .theme-toggle svg {
      width: 1.25rem;
      height: 1.25rem;
      fill: none;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    
    /* Cards de KPIs */
    .kpis { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
      gap: 1rem; 
      margin-bottom: 2rem; 
    }
    
    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 1.5rem;
      transition: var(--transition);
      overflow: hidden;
      position: relative;
    }
    
    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }
    
    .kpi-card {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .kpi-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .kpi-title {
      font-size: 0.9375rem;
      font-weight: 500;
      color: var(--text-secondary);
    }
    
    .kpi-value {
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: -0.01em;
    }
    
    .kpi-footer {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }
    
    .kpi-trend {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    .kpi-trend.up {
      color: var(--success);
    }
    
    .kpi-trend.down {
      color: var(--danger);
    }
    
    .kpi-trend svg {
      width: 0.875rem;
      height: 0.875rem;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    
    .kpi-meta {
      color: var(--text-secondary);
      font-size: 0.75rem;
      margin-top: 0.5rem;
    }
    
    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 1.5rem;
      overflow-x: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    
    .tabs::-webkit-scrollbar {
      display: none;
    }
    
    .tab {
      padding: 0.75rem 1.25rem;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      white-space: nowrap;
      border-bottom: 2px solid transparent;
      transition: var(--transition);
    }
    
    .tab:hover {
      color: var(--text);
    }
    
    .tab.active {
      color: var(--primary);
      border-color: var(--primary);
    }
    
    /* Gráficos */
    .charts-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); 
      gap: 1.5rem; 
      margin-bottom: 2rem;
    }
    
    .chart-container {
      position: relative;
      margin-top: 0.5rem;
      height: 260px;
    }
    
    .chart-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 1rem;
      letter-spacing: -0.01em;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .chart-title-actions {
      display: flex;
      gap: 0.75rem;
    }
    
    .chart-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-top: 0.5rem;
      font-size: 0.875rem;
    }
    
    .chart-legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .chart-legend-color {
      width: 0.75rem;
      height: 0.75rem;
      border-radius: 50%;
    }
    
    .full-width { 
      grid-column: 1 / -1; 
    }
    
    .full-width .chart-container {
      height: 300px;
    }
    
    /* Tabelas */
    .table-container {
      overflow-x: auto;
      margin-bottom: 2rem;
      border-radius: var(--radius);
      background: var(--card-bg);
      box-shadow: var(--shadow);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9375rem;
    }
    
    thead {
      background-color: var(--input-bg);
    }
    
    th {
      padding: 1rem;
      font-weight: 600;
      text-align: left;
      color: var(--text-secondary);
    }
    
    td {
      padding: 1rem;
      border-top: 1px solid var(--border);
    }
    
    tr:hover td {
      background-color: var(--input-bg);
    }
    
    .table-actions {
      display: flex;
      gap: 0.5rem;
      opacity: 0.5;
      transition: var(--transition);
    }
    
    tr:hover .table-actions {
      opacity: 1;
    }
    
    .table-action-btn {
      width: 1.75rem;
      height: 1.75rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--input-bg);
      border: none;
      cursor: pointer;
      color: var(--text);
      transition: var(--transition);
    }
    
    .table-action-btn:hover {
      background-color: rgba(142, 142, 147, 0.3);
    }
    
    .table-action-btn svg {
      width: 1rem;
      height: 1rem;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    
    /* Status e Tags */
    .status {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .status.status-paid {
      background-color: rgba(52, 199, 89, 0.1);
      color: var(--success);
    }
    
    .status.status-pending {
      background-color: rgba(255, 159, 10, 0.1);
      color: var(--warning);
    }
    
    .status.status-overdue {
      background-color: rgba(255, 59, 48, 0.1);
      color: var(--danger);
    }
    
    .status.status-scheduled {
      background-color: rgba(90, 200, 250, 0.1);
      color: var(--info);
    }
    
    .tag {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.75rem;
      font-weight: 500;
      background-color: var(--input-bg);
      color: var(--text-secondary);
    }
    
    /* Formulário Nova Transação */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-secondary);
    }
    
    .form-control {
      width: 100%;
      padding: 0.75rem 1rem;
      font-size: 0.9375rem;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background-color: var(--input-bg);
      color: var(--text);
      transition: var(--transition);
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(10, 132, 255, 0.1);
    }
    
    /* Loading Estado */
    .loading-indicator {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .loading-indicator.active {
      opacity: 1;
      pointer-events: all;
    }
    
    .spinner {
      width: 2.5rem;
      height: 2.5rem;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Modais */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .modal.active {
      opacity: 1;
      pointer-events: all;
    }
    
    .modal-content {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow-hover);
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }
    
    .modal.active .modal-content {
      transform: translateY(0);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--border);
    }
    
    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 0;
      letter-spacing: -0.01em;
    }
    
    .modal-close {
      background: var(--input-bg);
      border: none;
      width: 2rem;
      height: 2rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text);
      transition: var(--transition);
    }
    
    .modal-close:hover {
      background-color: rgba(142, 142, 147, 0.3);
    }
    
    .modal-body {
      padding: 1.5rem;
    }
    
    .modal-footer {
      padding: 1.25rem 1.5rem;
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      border-top: 1px solid var(--border);
    }
    
    /* Alertas */
    .alert {
      padding: 1rem 1.25rem;
      margin-bottom: 1.5rem;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
    }
    
    .alert-info {
      background-color: rgba(10, 132, 255, 0.1);
      color: var(--primary);
    }
    
    .alert-success {
      background-color: rgba(52, 199, 89, 0.1);
      color: var(--success);
    }
    
    .alert-warning {
      background-color: rgba(255, 159, 10, 0.1);
      color: var(--warning);
    }
    
    .alert-danger {
      background-color: rgba(255, 59, 48, 0.1);
      color: var(--danger);
    }
    
    .alert-icon {
      flex-shrink: 0;
      width: 1.25rem;
      height: 1.25rem;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    
    .alert-content {
      flex: 1;
    }
    
    .alert-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    
    /* Menu Contexto */
    .context-menu {
      position: absolute;
      min-width: 200px;
      background: var(--menu-bg);
      backdrop-filter: blur(8px);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-dropdown);
      z-index: 100;
      opacity: 0;
      transform: translateY(10px);
      pointer-events: none;
      transition: all 0.2s ease;
    }
    
    .context-menu.active {
      opacity: 1;
      transform: translateY(0);
      pointer-events: all;
    }
    
    .context-menu-item {
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .context-menu-item:hover {
      background-color: var(--input-bg);
    }
    
    .context-menu-item svg {
      width: 1rem;
      height: 1rem;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    
    .context-menu-divider {
      height: 1px;
      background-color: var(--border);
      margin: 0.25rem 0;
    }
    
    /* Fluxo de Caixa */
    .cash-flow-card {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .cash-flow-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .cash-flow-title {
      font-size: 1.125rem;
      font-weight: 600;
    }
    
    .cash-flow-balance {
      font-size: 1.5rem;
      font-weight: 700;
    }
    
    .cash-flow-items {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .flow-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 1rem;
      background-color: var(--input-bg);
      border-radius: var(--radius-sm);
      transition: var(--transition);
    }
    
    .flow-item:hover {
      background-color: rgba(142, 142, 147, 0.2);
    }
    
    .flow-item-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .flow-item-icon {
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
    }
    
    .flow-item-icon.income {
      background-color: var(--success);
    }
    
    .flow-item-icon.expense {
      background-color: var(--danger);
    }
    
    .flow-item-info {
      display: flex;
      flex-direction: column;
    }
    
    .flow-item-title {
      font-weight: 500;
    }
    
    .flow-item-meta {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }
    
    .flow-item-amount {
      font-weight: 600;
    }
    
    .flow-item-amount.income {
      color: var(--success);
    }
    
    .flow-item-amount.expense {
      color: var(--danger);
    }
    
    /* Recibo / Modal de Detalhes */
    .receipt {
      background-color: var(--receipt-bg);
      border-radius: var(--radius);
      padding: 2rem;
      max-width: 400px;
      margin: 0 auto;
    }
    
    .receipt-header {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .receipt-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    
    .receipt-date {
      color: var(--text-secondary);
      font-size: 0.875rem;
    }
    
    .receipt-body {
      margin-bottom: 2rem;
    }
    
    .receipt-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.75rem;
    }
    
    .receipt-item-label {
      color: var(--text-secondary);
    }
    
    .receipt-item-value {
      font-weight: 500;
    }
    
    .receipt-divider {
      height: 1px;
      background: var(--border);
      margin: 1rem 0;
    }
    
    .receipt-total {
      display: flex;
      justify-content: space-between;
      font-weight: 700;
      font-size: 1.125rem;
      margin-top: 1rem;
    }
    
    .receipt-footer {
      text-align: center;
      color: var(--text-secondary);
      font-size: 0.875rem;
      margin-top: 2rem;
    }
    
    /* Menus e Navegação */
    .nav {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .nav-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: var(--transition);
    }
    
    .nav-item:hover, 
    .nav-item.active {
      background-color: var(--input-bg);
    }
    
    .nav-item.active {
      color: var(--primary);
    }
    
    .nav-item svg {
      width: 1.25rem;
      height: 1.25rem;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }
    
    /* Progress & Metas */
    .progress-container {
      width: 100%;
      height: 0.5rem;
      background-color: var(--input-bg);
      border-radius: 1rem;
      overflow: hidden;
      margin-top: 0.5rem;
    }
    
    .progress-bar {
      height: 100%;
      border-radius: 1rem;
      transition: width 0.5s ease;
    }
    
    .progress-bar.success {
      background-color: var(--success);
    }
    
    .progress-bar.warning {
      background-color: var(--warning);
    }
     
    .progress-bar.danger {
      background-color: var(--danger);
    }
    
    /* Responsividade */
    @media (max-width: 1024px) {
      .container {
        padding: 1.5rem;
      }
      
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .header-right {
        width: 100%;
        justify-content: space-between;
      }
      
      .charts-grid {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 768px) {
      .kpis {
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 576px) {
      .container {
        padding: 1rem;
      }
      
      .kpis {
        grid-template-columns: 1fr;
      }
      
      .flow-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }
      
      .flow-item-left {
        width: 100%;
        justify-content: space-between;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header e Filtros -->
    <div class="header">
      <div class="header-title">
        <h1>Controle Financeiro Familiar</h1>
      </div>
      <div class="header-right">
        <div class="filters">
          <select id="filter-month">
            <option value="current">Mês Atual</option>
            <option value="last">Mês Anterior</option>
            <option value="all">Todo o Período</option>
          </select>
          <select id="filter-category">
            <option value="all">Todas Categorias</option>
          </select>
          <select id="filter-type">
            <option value="all">Todos Tipos</option>
            <option value="income">Receitas</option>
            <option value="expense">Despesas</option>
          </select>
        </div>
        <button class="btn btn-primary" id="btn-new-transaction">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Nova Transação
        </button>
        <button class="theme-toggle" id="theme-toggle" aria-label="Alternar Tema">
          <svg id="theme-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 0 1-4.4 2.26 5.403 5.403 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z" />
          </svg>
        </button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="kpis">
      <div class="card kpi-card">
        <div class="kpi-header">
          <div class="kpi-title">Saldo Atual</div>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
        </div>
        <div class="kpi-value" id="kpi-balance">R$ 0,00</div>
        <div class="kpi-footer">
          <div class="kpi-trend">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
              <polyline points="17 6 23 6 23 12"></polyline>
            </svg>
            <span id="balance-trend">0%</span>
          </div>
          <span>vs. mês anterior</span>
        </div>
      </div>
      
      <div class="card kpi-card">
        <div class="kpi-header">
          <div class="kpi-title">Receitas</div>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--success)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="19" x2="12" y2="5"></line>
            <polyline points="5 12 12 5 19 12"></polyline>
          </svg>
        </div>
        <div class="kpi-value" style="color: var(--success);" id="kpi-income">R$ 0,00</div>
        <div class="kpi-footer">
          <div class="kpi-trend">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
              <polyline points="17 6 23 6 23 12"></polyline>
            </svg>
            <span id="income-trend">0%</span>
          </div>
          <span>vs. mês anterior</span>
        </div>
      </div>
      
      <div class="card kpi-card">
        <div class="kpi-header">
          <div class="kpi-title">Despesas</div>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--danger)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <polyline points="19 12 12 19 5 12"></polyline>
          </svg>
        </div>
        <div class="kpi-value" style="color: var(--danger);" id="kpi-expenses">R$ 0,00</div>
        <div class="kpi-footer">
          <div class="kpi-trend">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline>
              <polyline points="17 18 23 18 23 12"></polyline>
            </svg>
            <span id="expenses-trend">0%</span>
          </div>
          <span>vs. mês anterior</span>
        </div>
      </div>
      
      <div class="card kpi-card">
        <div class="kpi-header">
          <div class="kpi-title">Economia do Mês</div>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="8 12 12 16 16 12"></polyline>
            <line x1="12" y1="8" x2="12" y2="16"></line>
          </svg>
        </div>
        <div class="kpi-value" id="kpi-savings">R$ 0,00</div>
        <div class="kpi-meta">
          <div>Meta: R$ <span id="savings-goal">1.000,00</span></div>
          <div class="progress-container">
            <div class="progress-bar success" id="savings-progress" style="width: 0%"></div>
          </div>
        </div>
      </div>
      
      <div class="card kpi-card">
        <div class="kpi-header">
          <div class="kpi-title">Projeção de Gastos</div>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
        </div>
        <div class="kpi-value" id="kpi-projection">R$ 0,00</div>
        <div class="kpi-footer">
          <div class="kpi-trend" id="projection-status">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            <span>No orçamento</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs de Navegação -->
    <div class="tabs">
      <div class="tab active" data-tab="overview">Visão Geral</div>
      <div class="tab" data-tab="transactions">Transações</div>
      <div class="tab" data-tab="budget">Orçamento</div>
      <div class="tab" data-tab="goals">Metas</div>
      <div class="tab" data-tab="reports">Relatórios</div>
    </div>

    <!-- Conteúdo das Tabs -->
    <div class="tab-content" id="tab-overview">
      <!-- Gráficos de Visão Geral -->
      <div class="charts-grid">
        <div class="card">
          <div class="chart-title">
            <span>Receitas vs Despesas</span>
            <div class="chart-title-actions">
              <select id="income-expense-chart-period">
                <option value="6">Últimos 6 meses</option>
                <option value="12" selected>Últimos 12 meses</option>
                <option value="24">Últimos 24 meses</option>
              </select>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="income-expense-chart"></canvas>
          </div>
        </div>
        
        <div class="card">
          <div class="chart-title">
            <span>Despesas por Categoria</span>
            <div class="chart-title-actions">
              <select id="category-chart-period">
                <option value="current" selected>Mês Atual</option>
                <option value="last">Mês Anterior</option>
                <option value="average">Média Anual</option>
              </select>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="category-chart"></canvas>
          </div>
        </div>
        
        <div class="card full-width">
          <div class="chart-title">
            <span>Fluxo de Caixa Mensal</span>
            <div class="chart-title-actions">
              <select id="cashflow-chart-year">
                <option value="2025" selected>2025</option>
                <option value="2024">2024</option>
              </select>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="cashflow-chart"></canvas>
          </div>
        </div>
        
        <div class="card">
          <div class="chart-title">
            <span>Gastos Fixos vs Variáveis</span>
          </div>
          <div class="chart-container">
            <canvas id="fixed-variable-chart"></canvas>
          </div>
        </div>
        
        <div class="card">
          <div class="chart-title">
            <span>Tendência de Gastos</span>
            <div class="chart-title-actions">
              <select id="trend-chart-category">
                <option value="all" selected>Todas Categorias</option>
              </select>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="trend-chart"></canvas>
          </div>
        </div>
      </div>
      
      <!-- Atividade Recente -->
      <div class="card">
        <div class="chart-title">Transações Recentes</div>
        <div class="cash-flow-items" id="recent-transactions">
          <!-- Transações recentes serão inseridas via JavaScript -->
        </div>
      </div>
    </div>
    
    <div class="tab-content" id="tab-transactions" style="display: none;">
      <!-- Filtros e Pesquisa -->
      <div style="display: flex; justify-content: space-between; margin-bottom: 1.5rem; gap: 1rem; flex-wrap: wrap;">
        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
          <select id="transactions-filter-date">
            <option value="all">Todas Datas</option>
            <option value="current" selected>Mês Atual</option>
            <option value="last">Mês Anterior</option>
            <option value="year">Este Ano</option>
          </select>
          
          <select id="transactions-filter-type">
            <option value="all" selected>Todos Tipos</option>
            <option value="income">Receitas</option>
            <option value="expense">Despesas</option>
          </select>
          
          <select id="transactions-filter-category">
            <option value="all" selected>Todas Categorias</option>
          </select>
          
          <select id="transactions-filter-status">
            <option value="all" selected>Todos Status</option>
            <option value="paid">Pago</option>
            <option value="pending">Pendente</option>
            <option value="scheduled">Agendado</option>
          </select>
        </div>
        
        <div style="position: relative; min-width: 250px;">
          <input type="text" class="form-control" id="transactions-search" placeholder="Pesquisar transações...">
        </div>
      </div>
      
      <!-- Tabela de Transações -->
      <div class="table-container">
        <table id="transactions-table">
          <thead>
            <tr>
              <th>Data</th>
              <th>Descrição</th>
              <th>Categoria</th>
              <th>Valor</th>
              <th>Status</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="transactions-table-body">
            <!-- Transações serão inseridas via JavaScript -->
          </tbody>
        </table>
      </div>
      
      <!-- Paginação -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
        <div>
          <span id="transactions-showing">Mostrando 0 de 0 transações</span>
        </div>
        <div style="display: flex; gap: 0.5rem;">
          <button class="btn btn-icon" id="transactions-prev">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
          </button>
          <button class="btn btn-icon" id="transactions-next">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </button>
        </div>
      </div>
    </div>
    
    <div class="tab-content" id="tab-budget" style="display: none;">
      <!-- Gráficos de Orçamento -->
      <div class="charts-grid">
        <div class="card">
          <div class="chart-title">Orçamento vs Real (Mês Atual)</div>
          <div class="chart-container">
            <canvas id="budget-chart"></canvas>
          </div>
        </div>
        
        <div class="card">
          <div class="chart-title">Progresso do Orçamento</div>
          <div id="budget-progress-container">
            <!-- Progresso de orçamento será inserido via JavaScript -->
          </div>
        </div>
      </div>
      
      <!-- Tabela de Orçamento -->
      <div class="card">
        <div class="chart-title">
          <span>Planejamento de Orçamento</span>
          <button class="btn btn-primary" id="btn-edit-budget">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
            Editar Orçamento
          </button>
        </div>
        <div class="table-container">
          <table id="budget-table">
            <thead>
              <tr>
                <th>Categoria</th>
                <th>Orçamento</th>
                <th>Gasto Atual</th>
                <th>Restante</th>
                <th>Progresso</th>
              </tr>
            </thead>
            <tbody id="budget-table-body">
              <!-- Orçamento será inserido via JavaScript -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
    
    <div class="tab-content" id="tab-goals" style="display: none;">
      <!-- Metas Financeiras -->
      <div class="charts-grid">
        <div class="card" style="grid-column: span 2;">
          <div class="chart-title">
            <span>Progresso das Metas</span>
            <button class="btn btn-primary" id="btn-add-goal">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              Nova Meta
            </button>
          </div>
          <div id="goals-container">
            <!-- Metas serão inseridas via JavaScript -->
          </div>
        </div>
        
        <div class="card">
          <div class="chart-title">Projeção de Economia</div>
          <div class="chart-container">
            <canvas id="savings-projection-chart"></canvas>
          </div>
        </div>
      </div>
    </div>
    
    <div class="tab-content" id="tab-reports" style="display: none;">
      <!-- Relatórios -->
      <div class="charts-grid">
        <div class="card">
          <div class="chart-title">
            <span>Relatório Mensal</span>
            <div class="chart-title-actions">
              <select id="report-month">
                <!-- Meses serão inseridos via JavaScript -->
              </select>
              <select id="report-year">
                <!-- Anos serão inseridos via JavaScript -->
              </select>
              <button class="btn btn-primary" id="btn-export-report">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="7 10 12 15 17 10"></polyline>
                  <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Exportar
              </button>
            </div>
          </div>
          <div id="monthly-report-container">
            <!-- Relatório mensal será inserido via JavaScript -->
          </div>
        </div>
        
        <div class="card">
          <div class="chart-title">
            <span>Análise de Gastos</span>
            <div class="chart-title-actions">
              <select id="analysis-type">
                <option value="category">Por Categoria</option>
                <option value="monthly">Mensal</option>
                <option value="yearly">Anual</option>
              </select>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="analysis-chart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Nova Transação -->
  <div class="modal" id="transaction-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="transaction-modal-title">Nova Transação</h3>
        <button class="modal-close" id="transaction-modal-close">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="transaction-form">
          <input type="hidden" id="transaction-id">
          
          <div class="form-grid">
            <div class="form-group">
              <label for="transaction-type">Tipo</label>
              <select class="form-control" id="transaction-type" required>
                <option value="income">Receita</option>
                <option value="expense">Despesa</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="transaction-date">Data</label>
              <input type="date" class="form-control" id="transaction-date" required>
            </div>
          </div>
          
          <div class="form-group">
            <label for="transaction-description">Descrição</label>
            <input type="text" class="form-control" id="transaction-description" placeholder="Ex: Salário, Mercado, Conta de Luz..." required>
          </div>
          
          <div class="form-grid">
            <div class="form-group">
              <label for="transaction-amount">Valor (R$)</label>
              <input type="number" step="0.01" min="0.01" class="form-control" id="transaction-amount" placeholder="0,00" required>
            </div>
            
            <div class="form-group">
              <label for="transaction-category">Categoria</label>
              <select class="form-control" id="transaction-category" required>
                <!-- Categorias serão inseridas via JavaScript -->
              </select>
            </div>
          </div>
          
          <div class="form-grid">
            <div class="form-group">
              <label for="transaction-status">Status</label>
              <select class="form-control" id="transaction-status" required>
                <option value="paid">Pago</option>
                <option value="pending">Pendente</option>
                <option value="scheduled">Agendado</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="transaction-payment-method">Forma de Pagamento</label>
              <select class="form-control" id="transaction-payment-method">
                <option value="">Selecione...</option>
                <option value="cash">Dinheiro</option>
                <option value="credit_card">Cartão de Crédito</option>
                <option value="debit_card">Cartão de Débito</option>
                <option value="bank_transfer">Transferência Bancária</option>
                <option value="pix">PIX</option>
                <option value="other">Outro</option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label for="transaction-notes">Observações</label>
            <textarea class="form-control" id="transaction-notes" rows="3" placeholder="Detalhes adicionais..."></textarea>
          </div>
          
          <div id="recurring-transaction-container">
            <div style="display: flex; align-items: center; gap: 1rem; margin-top: 1rem;">
              <input type="checkbox" id="transaction-recurring" style="width: auto;">
              <label for="transaction-recurring" style="margin-bottom: 0;">Transação Recorrente</label>
            </div>
            
            <div id="recurring-options" style="margin-top: 1rem; display: none;">
              <div class="form-grid">
                <div class="form-group">
                  <label for="transaction-frequency">Frequência</label>
                  <select class="form-control" id="transaction-frequency">
                    <option value="weekly">Semanal</option>
                    <option value="biweekly">Quinzenal</option>
                    <option value="monthly" selected>Mensal</option>
                    <option value="quarterly">Trimestral</option>
                    <option value="semiannual">Semestral</option>
                    <option value="annual">Anual</option>
                  </select>
                </div>
                
                <div class="form-group">
                  <label for="transaction-end-date">Data de Término (opcional)</label>
                  <input type="date" class="form-control" id="transaction-end-date">
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn" id="transaction-modal-cancel">Cancelar</button>
        <button class="btn btn-primary" id="transaction-modal-save">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Modal de Edição de Orçamento -->
  <div class="modal" id="budget-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Editar Orçamento</h3>
        <button class="modal-close" id="budget-modal-close">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="budget-form">
          <div class="form-group">
            <label for="budget-month">Mês de Referência</label>
            <select class="form-control" id="budget-month" required>
              <!-- Meses serão inseridos via JavaScript -->
            </select>
          </div>
          
          <div id="budget-categories-container">
            <!-- Categorias de orçamento serão inseridas via JavaScript -->
          </div>
          
          <div style="display: flex; justify-content: flex-end; margin-top: 1rem;">
            <button type="button" class="btn btn-primary" id="btn-add-budget-category">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              Adicionar Categoria
            </button>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn" id="budget-modal-cancel">Cancelar</button>
        <button class="btn btn-primary" id="budget-modal-save">Salvar</button>
      </div>
    </div>
  </div>

<!-- Modal de Nova Meta -->
  <div class="modal" id="goal-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="goal-modal-title">Nova Meta</h3>
        <button class="modal-close" id="goal-modal-close">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="goal-form">
          <input type="hidden" id="goal-id">
          
          <div class="form-group">
            <label for="goal-name">Nome da Meta</label>
            <input type="text" class="form-control" id="goal-name" placeholder="Ex: Férias, Novo Carro, Reforma..." required>
          </div>
          
          <div class="form-grid">
            <div class="form-group">
              <label for="goal-target">Valor Alvo (R$)</label>
              <input type="number" step="0.01" min="0.01" class="form-control" id="goal-target" placeholder="0,00" required>
            </div>
            
            <div class="form-group">
              <label for="goal-current">Valor Atual (R$)</label>
              <input type="number" step="0.01" min="0" class="form-control" id="goal-current" placeholder="0,00" required>
            </div>
          </div>
          
          <div class="form-grid">
            <div class="form-group">
              <label for="goal-date">Data Alvo</label>
              <input type="date" class="form-control" id="goal-date" required>
            </div>
            
            <div class="form-group">
              <label for="goal-category">Categoria</label>
              <select class="form-control" id="goal-category" required>
                <option value="savings">Economia</option>
                <option value="investment">Investimento</option>
                <option value="debt">Pagamento de Dívida</option>
                <option value="purchase">Compra</option>
                <option value="travel">Viagem</option>
                <option value="education">Educação</option>
                <option value="other">Outro</option>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label for="goal-notes">Observações</label>
            <textarea class="form-control" id="goal-notes" rows="3" placeholder="Detalhes adicionais..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn" id="goal-modal-cancel">Cancelar</button>
        <button class="btn btn-primary" id="goal-modal-save">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Modal de Detalhes da Transação -->
  <div class="modal" id="transaction-details-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Detalhes da Transação</h3>
        <button class="modal-close" id="transaction-details-modal-close">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="receipt" id="transaction-receipt">
          <!-- Detalhes da transação serão inseridos via JavaScript -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" id="transaction-details-delete">Excluir</button>
        <button class="btn btn-primary" id="transaction-details-edit">Editar</button>
      </div>
    </div>
  </div>

  <!-- Modal de Confirmação -->
  <div class="modal" id="confirm-modal">
    <div class="modal-content" style="max-width: 400px;">
      <div class="modal-header">
        <h3 class="modal-title" id="confirm-modal-title">Confirmação</h3>
        <button class="modal-close" id="confirm-modal-close">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <p id="confirm-modal-message">Tem certeza que deseja realizar esta ação?</p>
      </div>
      <div class="modal-footer">
        <button class="btn" id="confirm-modal-cancel">Cancelar</button>
        <button class="btn btn-danger" id="confirm-modal-confirm">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- Loading Indicator -->
  <div class="loading-indicator" id="loading">
    <div class="spinner"></div>
  </div>

  <script>
    // ===== Configurações e Variáveis Globais =====
    const root = document.documentElement;
    const themeToggle = document.getElementById('theme-toggle');
    const themeIcon = document.getElementById('theme-icon');
    const loading = document.getElementById('loading');
    
    // Tabs
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    
    // Modais
    const transactionModal = document.getElementById('transaction-modal');
    const transactionForm = document.getElementById('transaction-form');
    const budgetModal = document.getElementById('budget-modal');
    const goalModal = document.getElementById('goal-modal');
    const transactionDetailsModal = document.getElementById('transaction-details-modal');
    const confirmModal = document.getElementById('confirm-modal');
    
    // Botões
    const btnNewTransaction = document.getElementById('btn-new-transaction');
    const btnEditBudget = document.getElementById('btn-edit-budget');
    const btnAddGoal = document.getElementById('btn-add-goal');
    
    // Estados da Aplicação
    let transactions = [];
    let categories = [];
    let budgets = [];
    let goals = [];
    let currentTab = 'overview';
    
    // Configurações
    const TRANSACTION_TYPES = {
      income: {
        name: 'Receita',
        icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>',
        color: 'var(--success)'
      },
      expense: {
        name: 'Despesa',
        icon: '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></svg>',
        color: 'var(--danger)'
      }
    };
    
    const EXPENSE_CATEGORIES = [
      { id: 'housing', name: 'Moradia', color: '#FF9F0A', icon: '🏠' },
      { id: 'food', name: 'Alimentação', color: '#30D158', icon: '🍔' },
      { id: 'transportation', name: 'Transporte', color: '#0A84FF', icon: '🚗' },
      { id: 'health', name: 'Saúde', color: '#FF453A', icon: '🏥' },
      { id: 'leisure', name: 'Lazer', color: '#BF5AF2', icon: '🎮' },
      { id: 'education', name: 'Educação', color: '#5E5CE6', icon: '📚' },
      { id: 'shopping', name: 'Compras', color: '#FF375F', icon: '🛍️' },
      { id: 'bills', name: 'Contas', color: '#64D2FF', icon: '📝' },
      { id: 'unexpected', name: 'Inesperadas', color: '#FF2D55', icon: '⚠️' },
      { id: 'other_expenses', name: 'Outras Despesas', color: '#86868B', icon: '📋' }
    ];
    
    const INCOME_CATEGORIES = [
      { id: 'salary', name: 'Salário', color: '#30D158', icon: '💰' },
      { id: 'bonus', name: 'Bônus', color: '#5E5CE6', icon: '🎁' },
      { id: 'investments', name: 'Investimentos', color: '#0A84FF', icon: '📈' },
      { id: 'other_income', name: 'Outras Receitas', color: '#FF9F0A', icon: '💸' }
    ];
    
    const PAYMENT_METHODS = {
      'cash': 'Dinheiro',
      'credit_card': 'Cartão de Crédito',
      'debit_card': 'Cartão de Débito',
      'bank_transfer': 'Transferência Bancária',
      'pix': 'PIX',
      'other': 'Outro'
    };
    
    const TRANSACTION_STATUS = {
      'paid': { name: 'Pago', class: 'status-paid' },
      'pending': { name: 'Pendente', class: 'status-pending' },
      'scheduled': { name: 'Agendado', class: 'status-scheduled' },
      'overdue': { name: 'Atrasado', class: 'status-overdue' }
    };
    
    // ===== Utilitários e Helpers =====
    
    // Formatar moeda
    function formatCurrency(value) {
      return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      }).format(value);
    }
    
    // Formatar data
    function formatDate(date) {
      if (!date) return '';
      return new Intl.DateTimeFormat('pt-BR').format(new Date(date));
    }
    
    // Formatar Datas para o atributo value do input
    function formatDateForInput(date) {
      if (!date) return '';
      const d = new Date(date);
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
    }
    
    // Mostrar indicador de carregamento
    function showLoading() {
      loading.classList.add('active');
    }
    
    // Esconder indicador de carregamento
    function hideLoading() {
      loading.classList.remove('active');
    }
    
    // Mostrar alerta
    function showAlert(message, type = 'info', duration = 3000) {
      // Criar elemento de alerta
      const alertElement = document.createElement('div');
      alertElement.className = `alert alert-${type}`;
      alertElement.innerHTML = `
        <svg class="alert-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          ${type === 'info' ? '<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line>' : ''}
          ${type === 'success' ? '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline>' : ''}
          ${type === 'warning' ? '<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line>' : ''}
          ${type === 'danger' ? '<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line>' : ''}
        </svg>
        <div class="alert-content">${message}</div>
      `;
      
      // Adicionar ao DOM
      document.body.appendChild(alertElement);
      
      // Posicionar
      alertElement.style.position = 'fixed';
      alertElement.style.bottom = '20px';
      alertElement.style.right = '20px';
      alertElement.style.zIndex = '9999';
      alertElement.style.transition = 'transform 0.3s ease, opacity 0.3s ease';
      alertElement.style.transform = 'translateY(100px)';
      alertElement.style.opacity = '0';
      alertElement.style.maxWidth = '400px';
      
      // Mostrar com efeito
      setTimeout(() => {
        alertElement.style.transform = 'translateY(0)';
        alertElement.style.opacity = '1';
      }, 10);
      
      // Remover após a duração
      setTimeout(() => {
        alertElement.style.transform = 'translateY(100px)';
        alertElement.style.opacity = '0';
        
        setTimeout(() => {
          document.body.removeChild(alertElement);
        }, 300);
      }, duration);
    }
    
    // Atualizar ícone do toggle de tema
    function updateThemeIcon(theme) {
      if (theme === 'dark') {
        themeIcon.innerHTML = '<path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42M16.95 7.05a6 6 0 1 1-8.49 8.49 6 6 0 0 1 8.49-8.49z" />';
      } else {
        themeIcon.innerHTML = '<path d="M12 3a9 9 0 1 0 9 9c0-.46-.04-.92-.1-1.36a5.389 5.389 0 0 1-4.4 2.26 5.403 5.403 0 0 1-3.14-9.8c-.44-.06-.9-.1-1.36-.1z" />';
      }
    }
    
    // Setup do tema baseado em preferências do sistema
    function setupTheme() {
      const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
      const currentTheme = localStorage.getItem('theme');
      
      if (currentTheme === 'dark' || (!currentTheme && prefersDarkScheme.matches)) {
        root.setAttribute('data-theme', 'dark');
        updateThemeIcon('dark');
      } else {
        root.setAttribute('data-theme', 'light');
        updateThemeIcon('light');
      }
    }
    
    // Toggle de tema claro/escuro
    themeToggle.addEventListener('click', () => {
      const currentTheme = root.getAttribute('data-theme') || 'light';
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      
      root.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeIcon(newTheme);
      
      // Atualizar gráficos para o novo tema
      updateCharts();
    });
    
    // ===== Gerenciamento de Dados =====
    
    // Salvar dados no localStorage
    function saveData() {
      localStorage.setItem('finance_transactions', JSON.stringify(transactions));
      localStorage.setItem('finance_categories', JSON.stringify(categories));
      localStorage.setItem('finance_budgets', JSON.stringify(budgets));
      localStorage.setItem('finance_goals', JSON.stringify(goals));
    }
    
    // Carregar dados do localStorage
    function loadData() {
      try {
        const savedTransactions = localStorage.getItem('finance_transactions');
        const savedCategories = localStorage.getItem('finance_categories');
        const savedBudgets = localStorage.getItem('finance_budgets');
        const savedGoals = localStorage.getItem('finance_goals');
        
        if (savedTransactions) {
          transactions = JSON.parse(savedTransactions);
        } else {
          // Dados de exemplo se não houver dados salvos
          transactions = generateSampleTransactions();
        }
        
        if (savedCategories) {
          categories = JSON.parse(savedCategories);
        } else {
          // Categorias padrão
          categories = [...EXPENSE_CATEGORIES, ...INCOME_CATEGORIES];
        }
        
        if (savedBudgets) {
          budgets = JSON.parse(savedBudgets);
        } else {
          // Orçamentos de exemplo
          budgets = generateSampleBudgets();
        }
        
        if (savedGoals) {
          goals = JSON.parse(savedGoals);
        } else {
          // Metas de exemplo
          goals = generateSampleGoals();
        }
        
        console.log('Dados carregados com sucesso!');
      } catch (error) {
        console.error('Erro ao carregar dados:', error);
        showAlert('Erro ao carregar dados. Os dados padrão serão usados.', 'danger');
        
        // Resetar para dados padrão em caso de erro
        transactions = generateSampleTransactions();
        categories = [...EXPENSE_CATEGORIES, ...INCOME_CATEGORIES];
        budgets = generateSampleBudgets();
        goals = generateSampleGoals();
      }
    }
    
    // Gerar transações de exemplo
    function generateSampleTransactions() {
      const today = new Date();
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();
      
      // Lista para armazenar as transações
      const sampleTransactions = [];
      
      // Adicionar salário dos últimos 6 meses
      for (let i = 0; i < 6; i++) {
        const date = new Date(currentYear, currentMonth - i, 10);
        sampleTransactions.push({
          id: uuid.v4(),
          type: 'income',
          description: 'Salário',
          amount: 5000,
          date: date.toISOString().split('T')[0],
          category: 'salary',
          status: 'paid',
          paymentMethod: 'bank_transfer',
          notes: 'Salário mensal',
          recurring: true,
          frequency: 'monthly'
        });
      }
      
      // Adicionar despesas fixas dos últimos 3 meses
      const fixedExpenses = [
        { description: 'Aluguel', amount: 1200, day: 5, category: 'housing' },
        { description: 'Internet', amount: 100, day: 10, category: 'bills' },
        { description: 'Energia Elétrica', amount: 150, day: 15, category: 'bills' },
        { description: 'Água', amount: 80, day: 20, category: 'bills' },
        { description: 'Plano de Celular', amount: 60, day: 7, category: 'bills' }
      ];
      
      for (let i = 0; i < 3; i++) {
        for (const expense of fixedExpenses) {
          const date = new Date(currentYear, currentMonth - i, expense.day);
          sampleTransactions.push({
            id: uuid.v4(),
            type: 'expense',
            description: expense.description,
            amount: expense.amount,
            date: date.toISOString().split('T')[0],
            category: expense.category,
            status: 'paid',
            paymentMethod: 'bank_transfer',
            notes: 'Despesa mensal fixa',
            recurring: true,
            frequency: 'monthly'
          });
        }
      }
      
      // Adicionar despesas variáveis do mês atual
      const variableExpenses = [
        { description: 'Supermercado', amount: 500, day: 3, category: 'food' },
        { description: 'Restaurante', amount: 120, day: 8, category: 'food' },
        { description: 'Combustível', amount: 200, day: 12, category: 'transportation' },
        { description: 'Farmácia', amount: 80, day: 18, category: 'health' },
        { description: 'Cinema', amount: 60, day: 22, category: 'leisure' },
        { description: 'Roupas', amount: 150, day: 27, category: 'shopping' }
      ];
      
      for (const expense of variableExpenses) {
        const date = new Date(currentYear, currentMonth, expense.day);
        sampleTransactions.push({
          id: uuid.v4(),
          type: 'expense',
          description: expense.description,
          amount: expense.amount,
          date: date.toISOString().split('T')[0],
          category: expense.category,
          status: 'paid',
          paymentMethod: 'credit_card',
          notes: 'Despesa variável'
        });
      }
      
      // Adicionar algumas despesas pendentes/agendadas
      const futureExpenses = [
        { description: 'Parcela do IPTU', amount: 200, day: today.getDate() + 5, category: 'bills' },
        { description: 'Presente de Aniversário', amount: 150, day: today.getDate() + 8, category: 'shopping' }
      ];
      
      for (const expense of futureExpenses) {
        const date = new Date(currentYear, currentMonth, expense.day);
        sampleTransactions.push({
          id: uuid.v4(),
          type: 'expense',
          description: expense.description,
          amount: expense.amount,
          date: date.toISOString().split('T')[0],
          category: expense.category,
          status: 'scheduled',
          paymentMethod: 'credit_card',
          notes: 'Despesa agendada'
        });
      }
      
      // Adicionar uma receita extra
      sampleTransactions.push({
        id: uuid.v4(),
        type: 'income',
        description: 'Freelance',
        amount: 800,
        date: new Date(currentYear, currentMonth, 15).toISOString().split('T')[0],
        category: 'other_income',
        status: 'paid',
        paymentMethod: 'pix',
        notes: 'Trabalho extra'
      });
      
      // Adicionar transação recorrente não mensal
      sampleTransactions.push({
        id: uuid.v4(),
        type: 'expense',
        description: 'Assinatura Anual',
        amount: 300,
        date: new Date(currentYear, currentMonth - 1, 20).toISOString().split('T')[0],
        category: 'leisure',
        status: 'paid',
        paymentMethod: 'credit_card',
        notes: 'Assinatura de serviço',
        recurring: true,
        frequency: 'annual'
      });
      
      return sampleTransactions;
    }

// Gerar orçamentos de exemplo
    function generateSampleBudgets() {
      const today = new Date();
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();
      const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
      
      return [
        {
          id: uuid.v4(),
          month: monthKey,
          categories: [
            { id: 'housing', amount: 1300 },
            { id: 'food', amount: 800 },
            { id: 'transportation', amount: 400 },
            { id: 'health', amount: 200 },
            { id: 'leisure', amount: 300 },
            { id: 'education', amount: 150 },
            { id: 'shopping', amount: 300 },
            { id: 'bills', amount: 500 },
            { id: 'unexpected', amount: 200 },
            { id: 'other_expenses', amount: 100 }
          ]
        }
      ];
    }
    
    // Gerar metas de exemplo
    function generateSampleGoals() {
      const today = new Date();
      const currentYear = today.getFullYear();
      
      return [
        {
          id: uuid.v4(),
          name: 'Férias',
          targetAmount: 5000,
          currentAmount: 2000,
          targetDate: new Date(currentYear, 11, 15).toISOString().split('T')[0],
          category: 'travel',
          notes: 'Viagem de fim de ano'
        },
        {
          id: uuid.v4(),
          name: 'Fundo de Emergência',
          targetAmount: 10000,
          currentAmount: 3500,
          targetDate: new Date(currentYear + 1, 5, 30).toISOString().split('T')[0],
          category: 'savings',
          notes: '6 meses de despesas'
        }
      ];
    }
    
    // Filtrar transações
    function filterTransactions(filters = {}) {
      let filtered = [...transactions];
      
      // Filtrar por tipo
      if (filters.type && filters.type !== 'all') {
        filtered = filtered.filter(t => t.type === filters.type);
      }
      
      // Filtrar por categoria
      if (filters.category && filters.category !== 'all') {
        filtered = filtered.filter(t => t.category === filters.category);
      }
      
      // Filtrar por status
      if (filters.status && filters.status !== 'all') {
        filtered = filtered.filter(t => t.status === filters.status);
      }
      
      // Filtrar por data
      if (filters.date) {
        const today = new Date();
        const currentMonth = today.getMonth();
        const currentYear = today.getFullYear();
        
        switch (filters.date) {
          case 'current': // Mês atual
            filtered = filtered.filter(t => {
              const date = new Date(t.date);
              return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            });
            break;
          case 'last': // Mês anterior
            filtered = filtered.filter(t => {
              const date = new Date(t.date);
              const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
              const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
              return date.getMonth() === lastMonth && date.getFullYear() === lastMonthYear;
            });
            break;
          case 'year': // Ano atual
            filtered = filtered.filter(t => {
              const date = new Date(t.date);
              return date.getFullYear() === currentYear;
            });
            break;
          case 'custom': // Período personalizado
            if (filters.startDate && filters.endDate) {
              filtered = filtered.filter(t => {
                const date = new Date(t.date);
                const start = new Date(filters.startDate);
                const end = new Date(filters.endDate);
                return date >= start && date <= end;
              });
            }
            break;
        }
      }
      
      // Pesquisar por texto
      if (filters.search) {
        const search = filters.search.toLowerCase();
        filtered = filtered.filter(t => {
          return t.description.toLowerCase().includes(search) || 
                 (t.notes && t.notes.toLowerCase().includes(search));
        });
      }
      
      // Ordenar por data (mais recente primeiro)
      filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      return filtered;
    }
    
    // Obter o total de receitas, despesas e saldo para um período
    function getFinanceSummary(transactions, period = 'all') {
      let filtered = [...transactions];
      
      // Filtrar por período
      if (period !== 'all') {
        const today = new Date();
        const currentMonth = today.getMonth();
        const currentYear = today.getFullYear();
        
        switch (period) {
          case 'current': // Mês atual
            filtered = filtered.filter(t => {
              const date = new Date(t.date);
              return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            });
            break;
          case 'last': // Mês anterior
            filtered = filtered.filter(t => {
              const date = new Date(t.date);
              const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
              const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
              return date.getMonth() === lastMonth && date.getFullYear() === lastMonthYear;
            });
            break;
          // Adicionar outros períodos conforme necessário
        }
      }
      
      // Calcular totais
      const income = filtered
        .filter(t => t.type === 'income' && t.status !== 'scheduled')
        .reduce((sum, t) => sum + Number(t.amount), 0);
      
      const expenses = filtered
        .filter(t => t.type === 'expense' && t.status !== 'scheduled')
        .reduce((sum, t) => sum + Number(t.amount), 0);
      
      const balance = income - expenses;
      
      // Calcular valores pendentes
      const pendingIncome = filtered
        .filter(t => t.type === 'income' && t.status === 'scheduled')
        .reduce((sum, t) => sum + Number(t.amount), 0);
      
      const pendingExpenses = filtered
        .filter(t => t.type === 'expense' && t.status === 'scheduled')
        .reduce((sum, t) => sum + Number(t.amount), 0);
      
      // Retornar sumário financeiro
      return {
        income,
        expenses,
        balance,
        pendingIncome,
        pendingExpenses,
        projectedBalance: balance + pendingIncome - pendingExpenses
      };
    }
    
    // Obter categorias de despesa por mês
    function getExpensesByCategory(transactions, period = 'current') {
      let filtered = [...transactions];
      
      // Filtrar por período e tipo
      filtered = filterTransactions({
        date: period,
        type: 'expense',
        status: 'all'
      });
      
      // Agrupar por categoria
      const expensesByCategory = {};
      
      // Inicializar categorias
      categories
        .filter(c => EXPENSE_CATEGORIES.some(ec => ec.id === c.id))
        .forEach(c => {
          expensesByCategory[c.id] = 0;
        });
      
      // Somar valores por categoria
      filtered.forEach(t => {
        if (expensesByCategory[t.category] !== undefined) {
          expensesByCategory[t.category] += Number(t.amount);
        }
      });
      
      return expensesByCategory;
    }
    
    // Obter dados para o gráfico de receitas vs despesas por mês
    function getIncomeVsExpensesByMonth(transactions, months = 12) {
      const today = new Date();
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();
      
      const labels = [];
      const incomeData = [];
      const expenseData = [];
      
      // Gerar dados para os meses específicos
      for (let i = months - 1; i >= 0; i--) {
        const targetMonth = currentMonth - i;
        const targetYear = currentYear + Math.floor(targetMonth / 12);
        const normalizedMonth = ((targetMonth % 12) + 12) % 12; // Garante que o mês seja entre 0-11
        
        // Formatar rótulo do mês
        const monthDate = new Date(targetYear, normalizedMonth, 1);
        const monthLabel = monthDate.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' });
        labels.push(monthLabel);
        
        // Filtrar transações para este mês
        const monthTransactions = transactions.filter(t => {
          const date = new Date(t.date);
          return date.getMonth() === normalizedMonth && date.getFullYear() === targetYear;
        });
        
        // Calcular receitas e despesas
        const income = monthTransactions
          .filter(t => t.type === 'income')
          .reduce((sum, t) => sum + Number(t.amount), 0);
        
        const expense = monthTransactions
          .filter(t => t.type === 'expense')
          .reduce((sum, t) => sum + Number(t.amount), 0);
        
        incomeData.push(income);
        expenseData.push(expense);
      }
      
      return {
        labels,
        incomeData,
        expenseData
      };
    }
    
    // Obter dados para o gráfico de fluxo de caixa
    function getCashFlowData(transactions, year = new Date().getFullYear()) {
      const labels = [];
      const balanceData = [];
      
      // Gerar dados para cada mês do ano
      for (let month = 0; month < 12; month++) {
        // Formatar rótulo do mês
        const monthDate = new Date(year, month, 1);
        const monthLabel = monthDate.toLocaleDateString('pt-BR', { month: 'short' });
        labels.push(monthLabel);
        
        // Filtrar transações para este mês
        const monthTransactions = transactions.filter(t => {
          const date = new Date(t.date);
          return date.getMonth() === month && date.getFullYear() === year;
        });
        
        // Calcular fluxo de caixa
        const income = monthTransactions
          .filter(t => t.type === 'income')
          .reduce((sum, t) => sum + Number(t.amount), 0);
        
        const expense = monthTransactions
          .filter(t => t.type === 'expense')
          .reduce((sum, t) => sum + Number(t.amount), 0);
        
        const balance = income - expense;
        balanceData.push(balance);
      }
      
      return {
        labels,
        balanceData
      };
    }
    
    // Obter o orçamento atual
    function getCurrentBudget() {
      const today = new Date();
      const currentMonth = today.getMonth() + 1; // 1-12
      const currentYear = today.getFullYear();
      const monthKey = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
      
      let budget = budgets.find(b => b.month === monthKey);
      
      // Se não encontrar, criar um novo com base no mês anterior
      if (!budget) {
        const lastMonth = currentMonth === 1 ? 12 : currentMonth - 1;
        const lastMonthYear = currentMonth === 1 ? currentYear - 1 : currentYear;
        const lastMonthKey = `${lastMonthYear}-${String(lastMonth).padStart(2, '0')}`;
        
        const lastBudget = budgets.find(b => b.month === lastMonthKey);
        
        // Se encontrar orçamento do mês anterior, clonar
        if (lastBudget) {
          budget = {
            id: uuid.v4(),
            month: monthKey,
            categories: JSON.parse(JSON.stringify(lastBudget.categories))
          };
          
          budgets.push(budget);
          saveData();
        } else {
          // Criar um novo orçamento do zero
          budget = {
            id: uuid.v4(),
            month: monthKey,
            categories: EXPENSE_CATEGORIES.map(c => ({
              id: c.id,
              amount: 0
            }))
          };
          
          budgets.push(budget);
          saveData();
        }
      }
      
      return budget;
    }
    
    // Obter despesas atuais por categoria
    function getCurrentExpensesByCategory() {
      const today = new Date();
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();
      
      // Filtrar transações do mês atual
      const monthTransactions = transactions.filter(t => {
        const date = new Date(t.date);
        return date.getMonth() === currentMonth && 
               date.getFullYear() === currentYear && 
               t.type === 'expense';
      });
      
      // Agrupar por categoria
      const expensesByCategory = {};
      
      // Inicializar todas as categorias
      EXPENSE_CATEGORIES.forEach(c => {
        expensesByCategory[c.id] = 0;
      });
      
      // Somar despesas por categoria
      monthTransactions.forEach(t => {
        if (expensesByCategory[t.category] !== undefined) {
          expensesByCategory[t.category] += Number(t.amount);
        }
      });
      
      return expensesByCategory;
    }
    
    // Calcular progresso de uma meta
    function calculateGoalProgress(goal) {
      const currentAmount = Number(goal.currentAmount);
      const targetAmount = Number(goal.targetAmount);
      
      // Calcular porcentagem de progresso
      const progress = (currentAmount / targetAmount) * 100;
      
      // Calcular dias restantes
      const today = new Date();
      const targetDate = new Date(goal.targetDate);
      const daysRemaining = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
      
      // Calcular valor restante
      const remainingAmount = targetAmount - currentAmount;
      
      // Calcular economia diária necessária
      const dailySavingsNeeded = daysRemaining > 0 ? remainingAmount / daysRemaining : 0;
      
      // Calcular economia mensal necessária
      const monthlySavingsNeeded = daysRemaining > 0 ? remainingAmount / (daysRemaining / 30) : 0;
      
      return {
        progress: Math.min(progress, 100),
        daysRemaining: Math.max(daysRemaining, 0),
        remainingAmount,
        dailySavingsNeeded,
        monthlySavingsNeeded
      };
    }
    
    // ===== Inicialização de Componentes =====
    
    // Inicializar filtros
    function initFilters() {
      // Preencher categorias nos filtros
      const filterCategory = document.getElementById('filter-category');
      const transactionCategory = document.getElementById('transaction-category');
      const trendChartCategory = document.getElementById('trend-chart-category');
      const transactionsFilterCategory = document.getElementById('transactions-filter-category');
      
      // Limpar opções existentes (exceto a primeira)
      [filterCategory, trendChartCategory, transactionsFilterCategory].forEach(select => {
        while (select.options.length > 1) {
          select.remove(1);
        }
      });
      
      // Remover todas as opções do select de categorias na transação
      while (transactionCategory.options.length > 0) {
        transactionCategory.remove(0);
      }
      
      // Adicionar categorias
      categories.forEach(category => {
        [filterCategory, trendChartCategory, transactionsFilterCategory].forEach(select => {
          const option = document.createElement('option');
          option.value = category.id;
          option.textContent = category.name;
          select.appendChild(option);
        });
      });
      
      // Inicializar o evento de mudança de tipo de transação
      const transactionType = document.getElementById('transaction-type');
      transactionType.addEventListener('change', updateCategorySelect);
      
      // Inicialização inicial das categorias
      updateCategorySelect();
      
      // Inicializar eventos para os filtros
      document.getElementById('filter-month').addEventListener('change', updateDashboard);
      document.getElementById('filter-category').addEventListener('change', updateDashboard);
      document.getElementById('filter-type').addEventListener('change', updateDashboard);
      
      // Inicializar filtros de transações
      document.getElementById('transactions-filter-date').addEventListener('change', updateTransactionsTable);
      document.getElementById('transactions-filter-type').addEventListener('change', updateTransactionsTable);
      document.getElementById('transactions-filter-category').addEventListener('change', updateTransactionsTable);
      document.getElementById('transactions-filter-status').addEventListener('change', updateTransactionsTable);
      document.getElementById('transactions-search').addEventListener('input', updateTransactionsTable);
      
      // Inicializar filtros de gráficos
      document.getElementById('income-expense-chart-period').addEventListener('change', updateIncomeExpenseChart);
      document.getElementById('category-chart-period').addEventListener('change', updateCategoryChart);
      document.getElementById('cashflow-chart-year').addEventListener('change', updateCashFlowChart);
      document.getElementById('trend-chart-category').addEventListener('change', updateTrendChart);
    }
    
    // Atualizar select de categorias com base no tipo de transação
    function updateCategorySelect() {
      const transactionType = document.getElementById('transaction-type');
      const transactionCategory = document.getElementById('transaction-category');
      const type = transactionType.value;
      
      // Limpar opções existentes
      while (transactionCategory.options.length > 0) {
        transactionCategory.remove(0);
      }
      
      // Adicionar categorias com base no tipo
      let categoriesToAdd = [];
      
      if (type === 'income') {
        categoriesToAdd = categories.filter(c => INCOME_CATEGORIES.some(ic => ic.id === c.id));
      } else {
        categoriesToAdd = categories.filter(c => EXPENSE_CATEGORIES.some(ec => ec.id === c.id));
      }
      
      categoriesToAdd.forEach(category => {
        const option = document.createElement('option');
        option.value = category.id;
        option.textContent = category.name;
        transactionCategory.appendChild(option);
      });
    }
    
    // Inicializar modais
    function initModals() {
      // Modal de Nova Transação
      btnNewTransaction.addEventListener('click', () => openTransactionModal());
      document.getElementById('transaction-modal-close').addEventListener('click', () => closeModal(transactionModal));
      document.getElementById('transaction-modal-cancel').addEventListener('click', () => closeModal(transactionModal));
      document.getElementById('transaction-modal-save').addEventListener('click', saveTransaction);
      
      // Checkbox de transação recorrente
      document.getElementById('transaction-recurring').addEventListener('change', function() {
        document.getElementById('recurring-options').style.display = this.checked ? 'block' : 'none';
      });
      
      // Modal de Edição de Orçamento
      btnEditBudget.addEventListener('click', openBudgetModal);
      document.getElementById('budget-modal-close').addEventListener('click', () => closeModal(budgetModal));
      document.getElementById('budget-modal-cancel').addEventListener('click', () => closeModal(budgetModal));
      document.getElementById('budget-modal-save').addEventListener('click', saveBudget);
      
      // Modal de Nova Meta
      btnAddGoal.addEventListener('click', () => openGoalModal());
      document.getElementById('goal-modal-close').addEventListener('click', () => closeModal(goalModal));
      document.getElementById('goal-modal-cancel').addEventListener('click', () => closeModal(goalModal));
      document.getElementById('goal-modal-save').addEventListener('click', saveGoal);
      
      // Modal de Detalhes da Transação
      document.getElementById('transaction-details-modal-close').addEventListener('click', () => closeModal(transactionDetailsModal));
      document.getElementById('transaction-details-edit').addEventListener('click', editTransactionFromDetails);
      document.getElementById('transaction-details-delete').addEventListener('click', confirmDeleteTransaction);
      
      // Modal de Confirmação
      document.getElementById('confirm-modal-close').addEventListener('click', () => closeModal(confirmModal));
      document.getElementById('confirm-modal-cancel').addEventListener('click', () => closeModal(confirmModal));
    }
    
    // Abrir modal
    function openModal(modal) {
      modal.classList.add('active');
    }
    
    // Fechar modal
    function closeModal(modal) {
      modal.classList.remove('active');
    }
    
    // Abrir modal de transação
    function openTransactionModal(transaction = null) {
      const modalTitle = document.getElementById('transaction-modal-title');
      const form = document.getElementById('transaction-form');
      
      // Resetar formulário
      form.reset();
      
      // Definir data atual no campo de data
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('transaction-date').value = today;
      
      // Atualizar título e dados do formulário
      if (transaction) {
        modalTitle.textContent = 'Editar Transação';
        
        // Preencher formulário com dados da transação
        document.getElementById('transaction-id').value = transaction.id;
        document.getElementById('transaction-type').value = transaction.type;
        document.getElementById('transaction-date').value = transaction.date;
        document.getElementById('transaction-description').value = transaction.description;
        document.getElementById('transaction-amount').value = transaction.amount;
        document.getElementById('transaction-status').value = transaction.status;
        
        // Atualizar select de categorias e selecionar a categoria correta
        updateCategorySelect();
        document.getElementById('transaction-category').value = transaction.category;
        
        // Preencher forma de pagamento se existir
        if (transaction.paymentMethod) {
          document.getElementById('transaction-payment-method').value = transaction.paymentMethod;
        }
        
        // Preencher observações se existirem
        if (transaction.notes) {
          document.getElementById('transaction-notes').value = transaction.notes;
        }
        
        // Configurar opções recorrentes se aplicável
        if (transaction.recurring) {
          document.getElementById('transaction-recurring').checked = true;
          document.getElementById('recurring-options').style.display = 'block';
          document.getElementById('transaction-frequency').value = transaction.frequency;
          
          if (transaction.endDate) {
            document.getElementById('transaction-end-date').value = transaction.endDate;
          }
        } else {
          document.getElementById('transaction-recurring').checked = false;
          document.getElementById('recurring-options').style.display = 'none';
        }
      } else {
        modalTitle.textContent = 'Nova Transação';
        document.getElementById('transaction-id').value = '';
        document.getElementById('transaction-recurring').checked = false;
        document.getElementById('recurring-options').style.display = 'none';
      }
      
      // Abrir modal
      openModal(transactionModal);
    }
    
    // Salvar transação
    function saveTransaction() {
      // Obter valores do formulário
      const id = document.getElementById('transaction-id').value || uuid.v4();
      const type = document.getElementById('transaction-type').value;
      const date = document.getElementById('transaction-date').value;
      const description = document.getElementById('transaction-description').value;
      const amount = parseFloat(document.getElementById('transaction-amount').value);
      const category = document.getElementById('transaction-category').value;
      const status = document.getElementById('transaction-status').value;
      const paymentMethod = document.getElementById('transaction-payment-method').value;
      const notes = document.getElementById('transaction-notes').value;
      const recurring = document.getElementById('transaction-recurring').checked;
      
      // Validar campos obrigatórios
      if (!date || !description || isNaN(amount) || amount <= 0 || !category) {
        showAlert('Por favor, preencha todos os campos obrigatórios.', 'warning');
        return;
      }
      
      // Criar objeto de transação
      const transaction = {
        id,
        type,
        date,
        description,
        amount,
        category,
        status,
        paymentMethod,
        notes
      };
      
      // Adicionar campos recorrentes se aplicável
      if (recurring) {
        transaction.recurring = true;
        transaction.frequency = document.getElementById('transaction-frequency').value;
        
        const endDate = document.getElementById('transaction-end-date').value;
        if (endDate) {
          transaction.endDate = endDate;
        }
      }
      
      // Verificar se é uma edição ou nova transação
      const existingIndex = transactions.findIndex(t => t.id === id);
      
      if (existingIndex >= 0) {
        // Atualizar transação existente
        transactions[existingIndex] = transaction;
        showAlert('Transação atualizada com sucesso!', 'success');
      } else {
        // Adicionar nova transação
        transactions.push(transaction);
        showAlert('Transação adicionada com sucesso!', 'success');
      }
      
      // Salvar dados
      saveData();
      
      // Fechar modal
      closeModal(transactionModal);
      
      // Atualizar dashboard
      updateDashboard();
    }

// Abrir modal de orçamento
    function openBudgetModal() {
      // Obter orçamento atual
      const budget = getCurrentBudget();
      
      // Preencher mês de referência
      const budgetMonth = document.getElementById('budget-month');
      budgetMonth.innerHTML = '';
      
      // Criar opções de mês (mês atual e próximos 2 meses)
      const today = new Date();
      for (let i = 0; i < 3; i++) {
        const month = new Date(today.getFullYear(), today.getMonth() + i, 1);
        const monthKey = `${month.getFullYear()}-${String(month.getMonth() + 1).padStart(2, '0')}`;
        const monthText = month.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
        
        const option = document.createElement('option');
        option.value = monthKey;
        option.textContent = monthText;
        budgetMonth.appendChild(option);
      }
      
      // Selecionar mês atual
      budgetMonth.value = budget.month;
      
      // Gerar campos para cada categoria
      const categoriesContainer = document.getElementById('budget-categories-container');
      categoriesContainer.innerHTML = '';
      
      // Obter apenas categorias de despesa
      const expenseCategories = categories.filter(c => EXPENSE_CATEGORIES.some(ec => ec.id === c.id));
      
      expenseCategories.forEach(category => {
        // Encontrar valor orçado para esta categoria
        const budgetCategory = budget.categories.find(bc => bc.id === category.id);
        const budgetAmount = budgetCategory ? budgetCategory.amount : 0;
        
        // Criar elemento de formulário para a categoria
        const categoryElement = document.createElement('div');
        categoryElement.className = 'form-group';
        categoryElement.innerHTML = `
          <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
            <div style="width: 1.5rem; height: 1.5rem; border-radius: 50%; background-color: ${category.color}; flex-shrink: 0;"></div>
            <label for="budget-category-${category.id}">${category.name}</label>
          </div>
          <input type="number" min="0" step="0.01" class="form-control" id="budget-category-${category.id}" 
                 name="budget-category-${category.id}" value="${budgetAmount}" 
                 data-category-id="${category.id}" placeholder="0,00">
        `;
        
        categoriesContainer.appendChild(categoryElement);
      });
      
      // Abrir modal
      openModal(budgetModal);
    }
    
    // Salvar orçamento
    function saveBudget() {
      // Obter mês de referência
      const month = document.getElementById('budget-month').value;
      
      // Obter valores de orçamento por categoria
      const categories = [];
      const inputs = document.querySelectorAll('#budget-categories-container input');
      
      inputs.forEach(input => {
        const categoryId = input.dataset.categoryId;
        const amount = parseFloat(input.value) || 0;
        
        categories.push({
          id: categoryId,
          amount
        });
      });
      
      // Criar objeto de orçamento
      const budget = {
        id: uuid.v4(),
        month,
        categories
      };
      
      // Verificar se já existe orçamento para este mês
      const existingIndex = budgets.findIndex(b => b.month === month);
      
      if (existingIndex >= 0) {
        // Atualizar orçamento existente
        budgets[existingIndex] = budget;
      } else {
        // Adicionar novo orçamento
        budgets.push(budget);
      }
      
      // Salvar dados
      saveData();
      
      // Fechar modal
      closeModal(budgetModal);
      
      // Atualizar tab de orçamento
      updateBudgetTab();
      
      showAlert('Orçamento salvo com sucesso!', 'success');
    }
    
    // Abrir modal de meta
    function openGoalModal(goal = null) {
      const modalTitle = document.getElementById('goal-modal-title');
      const form = document.getElementById('goal-form');
      
      // Resetar formulário
      form.reset();
      
      // Definir data futura padrão (fim do ano atual)
      const today = new Date();
      const endOfYear = new Date(today.getFullYear(), 11, 31);
      document.getElementById('goal-date').value = endOfYear.toISOString().split('T')[0];
      
      // Atualizar título e dados do formulário
      if (goal) {
        modalTitle.textContent = 'Editar Meta';
        
        // Preencher formulário com dados da meta
        document.getElementById('goal-id').value = goal.id;
        document.getElementById('goal-name').value = goal.name;
        document.getElementById('goal-target').value = goal.targetAmount;
        document.getElementById('goal-current').value = goal.currentAmount;
        document.getElementById('goal-date').value = goal.targetDate;
        document.getElementById('goal-category').value = goal.category;
        
        if (goal.notes) {
          document.getElementById('goal-notes').value = goal.notes;
        }
      } else {
        modalTitle.textContent = 'Nova Meta';
        document.getElementById('goal-id').value = '';
      }
      
      // Abrir modal
      openModal(goalModal);
    }
    
    // Salvar meta
    function saveGoal() {
      // Obter valores do formulário
      const id = document.getElementById('goal-id').value || uuid.v4();
      const name = document.getElementById('goal-name').value;
      const targetAmount = parseFloat(document.getElementById('goal-target').value);
      const currentAmount = parseFloat(document.getElementById('goal-current').value);
      const targetDate = document.getElementById('goal-date').value;
      const category = document.getElementById('goal-category').value;
      const notes = document.getElementById('goal-notes').value;
      
      // Validar campos obrigatórios
      if (!name || isNaN(targetAmount) || targetAmount <= 0 || isNaN(currentAmount) || !targetDate) {
        showAlert('Por favor, preencha todos os campos obrigatórios.', 'warning');
        return;
      }
      
      // Criar objeto de meta
      const goal = {
        id,
        name,
        targetAmount,
        currentAmount,
        targetDate,
        category,
        notes
      };
      
      // Verificar se é uma edição ou nova meta
      const existingIndex = goals.findIndex(g => g.id === id);
      
      if (existingIndex >= 0) {
        // Atualizar meta existente
        goals[existingIndex] = goal;
        showAlert('Meta atualizada com sucesso!', 'success');
      } else {
        // Adicionar nova meta
        goals.push(goal);
        showAlert('Meta adicionada com sucesso!', 'success');
      }
      
      // Salvar dados
      saveData();
      
      // Fechar modal
      closeModal(goalModal);
      
      // Atualizar aba de metas
      updateGoalsTab();
    }
    
    // Mostrar detalhes da transação
    function showTransactionDetails(transactionId) {
      // Encontrar transação
      const transaction = transactions.find(t => t.id === transactionId);
      
      if (!transaction) {
        showAlert('Transação não encontrada.', 'danger');
        return;
      }
      
      // Preencher recibo
      const receipt = document.getElementById('transaction-receipt');
      
      // Encontrar categoria
      const categoryData = categories.find(c => c.id === transaction.category) || { name: 'Categoria Desconhecida' };
      
      // Formatar data
      const date = new Date(transaction.date);
      const formattedDate = date.toLocaleDateString('pt-BR', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      // Construir HTML do recibo
      receipt.innerHTML = `
        <div class="receipt-header">
          <div class="receipt-title">${transaction.type === 'income' ? 'Receita' : 'Despesa'}</div>
          <div class="receipt-date">${formattedDate}</div>
        </div>
        
        <div class="receipt-body">
          <div class="receipt-item">
            <div class="receipt-item-label">Descrição:</div>
            <div class="receipt-item-value">${transaction.description}</div>
          </div>
          
          <div class="receipt-item">
            <div class="receipt-item-label">Categoria:</div>
            <div class="receipt-item-value">${categoryData.name}</div>
          </div>
          
          <div class="receipt-item">
            <div class="receipt-item-label">Data:</div>
            <div class="receipt-item-value">${formatDate(transaction.date)}</div>
          </div>
          
          <div class="receipt-item">
            <div class="receipt-item-label">Status:</div>
            <div class="receipt-item-value">${TRANSACTION_STATUS[transaction.status].name}</div>
          </div>
          
          ${transaction.paymentMethod ? `
          <div class="receipt-item">
            <div class="receipt-item-label">Forma de Pagamento:</div>
            <div class="receipt-item-value">${PAYMENT_METHODS[transaction.paymentMethod] || transaction.paymentMethod}</div>
          </div>
          ` : ''}
          
          ${transaction.recurring ? `
          <div class="receipt-item">
            <div class="receipt-item-label">Recorrência:</div>
            <div class="receipt-item-value">${transaction.frequency === 'monthly' ? 'Mensal' : 
                                            transaction.frequency === 'weekly' ? 'Semanal' : 
                                            transaction.frequency === 'biweekly' ? 'Quinzenal' :
                                            transaction.frequency === 'quarterly' ? 'Trimestral' :
                                            transaction.frequency === 'semiannual' ? 'Semestral' :
                                            transaction.frequency === 'annual' ? 'Anual' : transaction.frequency}</div>
          </div>
          ` : ''}
          
          ${transaction.notes ? `
          <div class="receipt-item">
            <div class="receipt-item-label">Observações:</div>
            <div class="receipt-item-value">${transaction.notes}</div>
          </div>
          ` : ''}
          
          <div class="receipt-divider"></div>
          
          <div class="receipt-total">
            <div>Total:</div>
            <div style="color: ${transaction.type === 'income' ? 'var(--success)' : 'var(--danger)'}">
              ${formatCurrency(transaction.amount)}
            </div>
          </div>
        </div>
        
        <div class="receipt-footer">
          <div>Transação #${transaction.id.substring(0, 8)}</div>
        </div>
      `;
      
      // Configurar botões de ação
      document.getElementById('transaction-details-edit').onclick = () => {
        closeModal(transactionDetailsModal);
        openTransactionModal(transaction);
      };
      
      document.getElementById('transaction-details-delete').onclick = () => {
        confirmDeleteTransaction(transaction.id);
      };
      
      // Abrir modal
      openModal(transactionDetailsModal);
    }
    
    // Editar transação a partir da modal de detalhes
    function editTransactionFromDetails() {
      // Esta função é configurada dinamicamente em showTransactionDetails
    }
    
    // Confirmar exclusão de transação
    function confirmDeleteTransaction(transactionId) {
      const transaction = transactions.find(t => t.id === transactionId);
      
      if (!transaction) {
        showAlert('Transação não encontrada.', 'danger');
        return;
      }
      
      // Configurar modal de confirmação
      document.getElementById('confirm-modal-title').textContent = 'Excluir Transação';
      document.getElementById('confirm-modal-message').textContent = `Tem certeza que deseja excluir a transação "${transaction.description}"?`;
      
      // Configurar botão de confirmação
      document.getElementById('confirm-modal-confirm').onclick = () => {
        deleteTransaction(transactionId);
        closeModal(confirmModal);
        
        // Fechar modal de detalhes se estiver aberta
        if (transactionDetailsModal.classList.contains('active')) {
          closeModal(transactionDetailsModal);
        }
      };
      
      // Abrir modal de confirmação
      openModal(confirmModal);
    }
    
    // Excluir transação
    function deleteTransaction(transactionId) {
      // Encontrar índice da transação
      const index = transactions.findIndex(t => t.id === transactionId);
      
      if (index >= 0) {
        // Remover transação
        transactions.splice(index, 1);
        
        // Salvar dados
        saveData();
        
        // Atualizar dashboard
        updateDashboard();
        
        showAlert('Transação excluída com sucesso!', 'success');
      } else {
        showAlert('Transação não encontrada.', 'danger');
      }
    }
    
    // ===== Inicialização de Gráficos =====
    
    // Configurações comuns para todos os gráficos
    function getChartCommonOptions() {
      const isDark = root.getAttribute('data-theme') === 'dark';
      const textColor = isDark ? '#F5F5F7' : '#1D1D1F';
      const gridColor = isDark ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.04)';
      
      return {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
            align: 'end',
            labels: {
              boxWidth: 12,
              usePointStyle: true,
              pointStyle: 'circle',
              color: textColor,
              font: {
                family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif',
                size: 12
              }
            }
          },
          tooltip: {
            backgroundColor: isDark ? 'rgba(44, 44, 46, 0.9)' : 'rgba(255, 255, 255, 0.9)',
            titleColor: textColor,
            bodyColor: textColor,
            borderColor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)',
            borderWidth: 1,
            cornerRadius: 8,
            padding: 12,
            boxPadding: 6,
            usePointStyle: true,
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) {
                  label += ': ';
                }
                if (context.parsed.y !== null) {
                  label += formatCurrency(context.parsed.y);
                }
                return label;
              }
            },
            titleFont: {
              family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif',
              size: 13,
              weight: 'bold'
            },
            bodyFont: {
              family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif',
              size: 12
            }
          }
        },
        scales: {
          x: {
            grid: {
              color: gridColor
            },
            ticks: {
              color: textColor,
              font: {
                family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif',
                size: 11
              }
            }
          },
          y: {
            grid: {
              color: gridColor
            },
            ticks: {
              color: textColor,
              font: {
                family: '-apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif',
                size: 11
              },
              callback: function(value) {
                return formatCurrency(value);
              }
            }
          }
        }
      };
    }
    
    let incomeExpenseChart;
    
    // Inicializar gráfico de receitas x despesas
    function initIncomeExpenseChart() {
      const ctx = document.getElementById('income-expense-chart').getContext('2d');
      const commonOptions = getChartCommonOptions();
      
      // Obter dados para o gráfico
      const { labels, incomeData, expenseData } = getIncomeVsExpensesByMonth(transactions);
      
      // Criar gráfico
      incomeExpenseChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Receitas',
              data: incomeData,
              backgroundColor: getComputedStyle(root).getPropertyValue('--success').trim(),
              borderColor: getComputedStyle(root).getPropertyValue('--success').trim(),
              borderWidth: 1,
              borderRadius: 6,
              maxBarThickness: 35
            },
            {
              label: 'Despesas',
              data: expenseData,
              backgroundColor: getComputedStyle(root).getPropertyValue('--danger').trim(),
              borderColor: getComputedStyle(root).getPropertyValue('--danger').trim(),
              borderWidth: 1,
              borderRadius: 6,
              maxBarThickness: 35
            }
          ]
        },
        options: {
          ...commonOptions,
          scales: {
            ...commonOptions.scales
          }
        }
      });
    }
    
    // Atualizar gráfico de receitas x despesas
    function updateIncomeExpenseChart() {
      if (!incomeExpenseChart) return;
      
      // Obter período selecionado
      const periodSelect = document.getElementById('income-expense-chart-period');
      const months = parseInt(periodSelect.value);
      
      // Obter dados atualizados
      const { labels, incomeData, expenseData } = getIncomeVsExpensesByMonth(transactions, months);
      
      // Atualizar dados do gráfico
      incomeExpenseChart.data.labels = labels;
      incomeExpenseChart.data.datasets[0].data = incomeData;
      incomeExpenseChart.data.datasets[1].data = expenseData;
      
      // Atualizar cores com base no tema
      incomeExpenseChart.data.datasets[0].backgroundColor = getComputedStyle(root).getPropertyValue('--success').trim();
      incomeExpenseChart.data.datasets[0].borderColor = getComputedStyle(root).getPropertyValue('--success').trim();
      incomeExpenseChart.data.datasets[1].backgroundColor = getComputedStyle(root).getPropertyValue('--danger').trim();
      incomeExpenseChart.data.datasets[1].borderColor = getComputedStyle(root).getPropertyValue('--danger').trim();
      
      // Atualizar opções comuns
      incomeExpenseChart.options = { ...getChartCommonOptions() };
      
      incomeExpenseChart.update();
    }
    
    let categoryChart;
    
    // Inicializar gráfico de despesas por categoria
    function initCategoryChart() {
      const ctx = document.getElementById('category-chart').getContext('2d');
      const commonOptions = getChartCommonOptions();
      
      // Obter dados para o gráfico
      const expensesByCategory = getExpensesByCategory(transactions);
      
      // Preparar dados para o gráfico
      const labels = [];
      const data = [];
      const backgroundColors = [];
      
      // Ordenar categorias por valor (maior para menor)
      const sortedCategories = Object.entries(expensesByCategory)
        .filter(([categoryId, amount]) => amount > 0)
        .sort((a, b) => b[1] - a[1]);
      
      // Adicionar dados ordenados
      sortedCategories.forEach(([categoryId, amount]) => {
        const category = categories.find(c => c.id === categoryId);
        if (category) {
          labels.push(category.name);
          data.push(amount);
          backgroundColors.push(category.color);
        }
      });
      
      // Criar gráfico
      categoryChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [
            {
              data: data,
              backgroundColor: backgroundColors,
              borderColor: getComputedStyle(root).getPropertyValue('--card-bg').trim(),
              borderWidth: 2,
              borderRadius: 4,
              hoverOffset: 6
            }
          ]
        },
        options: {
          ...commonOptions,
          cutout: '70%',
          plugins: {
            ...commonOptions.plugins,
            tooltip: {
              ...commonOptions.plugins.tooltip,
              callbacks: {
                label: function(context) {
                  const value = context.parsed;
                  const total = context.dataset.data.reduce((acc, curr) => acc + curr, 0);
                  const percentage = Math.round((value / total) * 100);
                  return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }
    
    // Atualizar gráfico de despesas por categoria
    function updateCategoryChart() {
      if (!categoryChart) return;
      
      // Obter período selecionado
      const periodSelect = document.getElementById('category-chart-period');
      const period = periodSelect.value;
      
      // Obter dados atualizados
      const expensesByCategory = getExpensesByCategory(transactions, period);
      
      // Preparar dados para o gráfico
      const labels = [];
      const data = [];
      const backgroundColors = [];
      
      // Ordenar categorias por valor (maior para menor)
      const sortedCategories = Object.entries(expensesByCategory)
        .filter(([categoryId, amount]) => amount > 0)
        .sort((a, b) => b[1] - a[1]);
      
      // Adicionar dados ordenados
      sortedCategories.forEach(([categoryId, amount]) => {
        const category = categories.find(c => c.id === categoryId);
        if (category) {
          labels.push(category.name);
          data.push(amount);
          backgroundColors.push(category.color);
        }
      });
      
      // Atualizar dados do gráfico
      categoryChart.data.labels = labels;
      categoryChart.data.datasets[0].data = data;
      categoryChart.data.datasets[0].backgroundColor = backgroundColors;
      
      // Atualizar cor da borda com base no tema
      categoryChart.data.datasets[0].borderColor = getComputedStyle(root).getPropertyValue('--card-bg').trim();
      
      // Atualizar opções comuns
      categoryChart.options = { 
        ...getChartCommonOptions(),
        cutout: '70%',
        plugins: {
          ...getChartCommonOptions().plugins,
          tooltip: {
            ...getChartCommonOptions().plugins.tooltip,
            callbacks: {
              label: function(context) {
                const value = context.parsed;
                const total = context.dataset.data.reduce((acc, curr) => acc + curr, 0);
                const percentage = Math.round((value / total) * 100);
                return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
              }
            }
          }
        }
      };
      
      categoryChart.update();
    }

// === Início do próximo bloco: gráfico de fluxo de caixa ===
let cashflowChart;
    
    // Inicializar gráfico de fluxo de caixa
    function initCashFlowChart() {
      const ctx = document.getElementById('cashflow-chart').getContext('2d');
      const commonOptions = getChartCommonOptions();
      
      // Obter ano atual
      const currentYear = new Date().getFullYear();
      
      // Obter dados para o gráfico
      const { labels, balanceData } = getCashFlowData(transactions, currentYear);
      
      // Determinar cores para cada barra (verde para positivo, vermelho para negativo)
      const barColors = balanceData.map(value => 
        value >= 0 ? getComputedStyle(root).getPropertyValue('--success').trim() : 
                   getComputedStyle(root).getPropertyValue('--danger').trim()
      );
      
      // Criar gráfico
      cashflowChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Balanço Mensal',
              data: balanceData,
              backgroundColor: barColors,
              borderColor: barColors,
              borderWidth: 1,
              borderRadius: 6,
              maxBarThickness: 35
            }
          ]
        },
        options: {
          ...commonOptions,
          scales: {
            ...commonOptions.scales
          }
        }
      });
    }
    
    // Atualizar gráfico de fluxo de caixa
    function updateCashFlowChart() {
      if (!cashflowChart) return;
      
      // Obter ano selecionado
      const yearSelect = document.getElementById('cashflow-chart-year');
      const year = parseInt(yearSelect.value);
      
      // Obter dados atualizados
      const { labels, balanceData } = getCashFlowData(transactions, year);
      
      // Determinar cores para cada barra (verde para positivo, vermelho para negativo)
      const barColors = balanceData.map(value => 
        value >= 0 ? getComputedStyle(root).getPropertyValue('--success').trim() : 
                   getComputedStyle(root).getPropertyValue('--danger').trim()
      );
      
      // Atualizar dados do gráfico
      cashflowChart.data.labels = labels;
      cashflowChart.data.datasets[0].data = balanceData;
      cashflowChart.data.datasets[0].backgroundColor = barColors;
      cashflowChart.data.datasets[0].borderColor = barColors;
      
      // Atualizar opções comuns
      cashflowChart.options = { ...getChartCommonOptions() };
      
      cashflowChart.update();
    }
    
    let fixedVariableChart;
    
    // Inicializar gráfico de gastos fixos vs variáveis
    function initFixedVariableChart() {
      const ctx = document.getElementById('fixed-variable-chart').getContext('2d');
      const commonOptions = getChartCommonOptions();
      
      // Filtrar transações de despesa do mês atual
      const today = new Date();
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();
      
      const monthExpenses = transactions.filter(t => {
        const date = new Date(t.date);
        return date.getMonth() === currentMonth && 
               date.getFullYear() === currentYear && 
               t.type === 'expense';
      });
      
      // Separar em fixas e variáveis (consideramos recorrentes como fixas)
      const fixedExpenses = monthExpenses
        .filter(t => t.recurring)
        .reduce((sum, t) => sum + Number(t.amount), 0);
      
      const variableExpenses = monthExpenses
        .filter(t => !t.recurring)
        .reduce((sum, t) => sum + Number(t.amount), 0);
      
      // Criar gráfico
      fixedVariableChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Despesas Fixas', 'Despesas Variáveis'],
          datasets: [
            {
              data: [fixedExpenses, variableExpenses],
              backgroundColor: [
                getComputedStyle(root).getPropertyValue('--primary').trim(),
                getComputedStyle(root).getPropertyValue('--purple').trim()
              ],
              borderColor: getComputedStyle(root).getPropertyValue('--card-bg').trim(),
              borderWidth: 2,
              borderRadius: 4,
              hoverOffset: 6
            }
          ]
        },
        options: {
          ...commonOptions,
          plugins: {
            ...commonOptions.plugins,
            tooltip: {
              ...commonOptions.plugins.tooltip,
              callbacks: {
                label: function(context) {
                  const value = context.parsed;
                  const total = context.dataset.data.reduce((acc, curr) => acc + curr, 0);
                  const percentage = Math.round((value / total) * 100);
                  return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }
    
    // Atualizar gráfico de gastos fixos vs variáveis
    function updateFixedVariableChart() {
      if (!fixedVariableChart) return;
      
      // Filtrar transações de despesa do mês atual
      const today = new Date();
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();
      
      const monthExpenses = transactions.filter(t => {
        const date = new Date(t.date);
        return date.getMonth() === currentMonth && 
               date.getFullYear() === currentYear && 
               t.type === 'expense';
      });
      
      // Separar em fixas e variáveis (consideramos recorrentes como fixas)
      const fixedExpenses = monthExpenses
        .filter(t => t.recurring)
        .reduce((sum, t) => sum + Number(t.amount), 0);
      
      const variableExpenses = monthExpenses
        .filter(t => !t.recurring)
        .reduce((sum, t) => sum + Number(t.amount), 0);
      
      // Atualizar dados do gráfico
      fixedVariableChart.data.datasets[0].data = [fixedExpenses, variableExpenses];
      
      // Atualizar cores com base no tema
      fixedVariableChart.data.datasets[0].backgroundColor = [
        getComputedStyle(root).getPropertyValue('--primary').trim(),
        getComputedStyle(root).getPropertyValue('--purple').trim()
      ];
      fixedVariableChart.data.datasets[0].borderColor = getComputedStyle(root).getPropertyValue('--card-bg').trim();
      
      // Atualizar opções comuns
      fixedVariableChart.options = { 
        ...getChartCommonOptions(),
        plugins: {
          ...getChartCommonOptions().plugins,
          tooltip: {
            ...getChartCommonOptions().plugins.tooltip,
            callbacks: {
              label: function(context) {
                const value = context.parsed;
                const total = context.dataset.data.reduce((acc, curr) => acc + curr, 0);
                const percentage = Math.round((value / total) * 100);
                return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
              }
            }
          }
        }
      };
      
      fixedVariableChart.update();
    }
    
    let trendChart;
    
    // Inicializar gráfico de tendência de gastos
    function initTrendChart() {
      const ctx = document.getElementById('trend-chart').getContext('2d');
      const commonOptions = getChartCommonOptions();
      
      // Obter dados para os últimos 6 meses
      const today = new Date();
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();
      
      const labels = [];
      const data = [];
      
      // Gerar dados para os últimos 6 meses
      for (let i = 5; i >= 0; i--) {
        const targetMonth = currentMonth - i;
        const targetYear = currentYear + Math.floor(targetMonth / 12);
        const normalizedMonth = ((targetMonth % 12) + 12) % 12; // Garante que o mês seja entre 0-11
        
        // Formatar rótulo do mês
        const monthDate = new Date(targetYear, normalizedMonth, 1);
        const monthLabel = monthDate.toLocaleDateString('pt-BR', { month: 'short' });
        labels.push(monthLabel);
        
        // Filtrar transações para este mês
        const monthExpenses = transactions.filter(t => {
          const date = new Date(t.date);
          return date.getMonth() === normalizedMonth && 
                 date.getFullYear() === targetYear && 
                 t.type === 'expense';
        });
        
        // Calcular total de despesas
        const totalExpenses = monthExpenses.reduce((sum, t) => sum + Number(t.amount), 0);
        data.push(totalExpenses);
      }
      
      // Criar gráfico
      trendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Despesas Totais',
              data: data,
              borderColor: getComputedStyle(root).getPropertyValue('--primary').trim(),
              backgroundColor: 'rgba(10, 132, 255, 0.1)',
              borderWidth: 2,
              tension: 0.3,
              fill: true
            }
          ]
        },
        options: {
          ...commonOptions,
          scales: {
            ...commonOptions.scales
          }
        }
      });
    }
    
    // Atualizar gráfico de tendência de gastos
    function updateTrendChart() {
      if (!trendChart) return;
      
      // Obter categoria selecionada
      const categorySelect = document.getElementById('trend-chart-category');
      const categoryId = categorySelect.value;
      
      // Obter dados para os últimos 6 meses
      const today = new Date();
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();
      
      const labels = [];
      const data = [];
      
      // Gerar dados para os últimos 6 meses
      for (let i = 5; i >= 0; i--) {
        const targetMonth = currentMonth - i;
        const targetYear = currentYear + Math.floor(targetMonth / 12);
        const normalizedMonth = ((targetMonth % 12) + 12) % 12; // Garante que o mês seja entre 0-11
        
        // Formatar rótulo do mês
        const monthDate = new Date(targetYear, normalizedMonth, 1);
        const monthLabel = monthDate.toLocaleDateString('pt-BR', { month: 'short' });
        labels.push(monthLabel);
        
        // Filtrar transações para este mês e categoria (se especificada)
        let monthExpenses = transactions.filter(t => {
          const date = new Date(t.date);
          return date.getMonth() === normalizedMonth && 
                 date.getFullYear() === targetYear && 
                 t.type === 'expense';
        });
        
        // Filtrar por categoria específica
        if (categoryId !== 'all') {
          monthExpenses = monthExpenses.filter(t => t.category === categoryId);
        }
        
        // Calcular total de despesas
        const totalExpenses = monthExpenses.reduce((sum, t) => sum + Number(t.amount), 0);
        data.push(totalExpenses);
      }
      
      // Encontrar categoria para atualizar o nome
      let label = 'Despesas Totais';
      if (categoryId !== 'all') {
        const category = categories.find(c => c.id === categoryId);
        if (category) {
          label = `Despesas: ${category.name}`;
        }
      }
      
      // Atualizar dados do gráfico
      trendChart.data.labels = labels;
      trendChart.data.datasets[0].data = data;
      trendChart.data.datasets[0].label = label;
      
      // Atualizar cores com base no tema
      trendChart.data.datasets[0].borderColor = getComputedStyle(root).getPropertyValue('--primary').trim();
      trendChart.data.datasets[0].backgroundColor = 'rgba(10, 132, 255, 0.1)';
      
      // Atualizar opções comuns
      trendChart.options = { ...getChartCommonOptions() };
      
      trendChart.update();
    }
    
    let budgetChart;
    
    // Inicializar gráfico de orçamento
    function initBudgetChart() {
      const ctx = document.getElementById('budget-chart').getContext('2d');
      const commonOptions = getChartCommonOptions();
      
      // Obter orçamento e despesas atuais
      const budget = getCurrentBudget();
      const expensesByCategory = getCurrentExpensesByCategory();
      
      // Preparar dados para o gráfico
      const labels = [];
      const budgetData = [];
      const expenseData = [];
      
      // Adicionar apenas categorias com orçamento definido
      budget.categories.forEach(budgetCategory => {
        if (budgetCategory.amount > 0) {
          const category = categories.find(c => c.id === budgetCategory.id);
          if (category) {
            labels.push(category.name);
            budgetData.push(budgetCategory.amount);
            expenseData.push(expensesByCategory[budgetCategory.id] || 0);
          }
        }
      });
      
      // Criar gráfico
      budgetChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Orçamento',
              data: budgetData,
              backgroundColor: getComputedStyle(root).getPropertyValue('--primary').trim(),
              borderColor: getComputedStyle(root).getPropertyValue('--primary').trim(),
              borderWidth: 1,
              borderRadius: 6,
              maxBarThickness: 35
            },
            {
              label: 'Gasto Atual',
              data: expenseData,
              backgroundColor: getComputedStyle(root).getPropertyValue('--warning').trim(),
              borderColor: getComputedStyle(root).getPropertyValue('--warning').trim(),
              borderWidth: 1,
              borderRadius: 6,
              maxBarThickness: 35
            }
          ]
        },
        options: {
          ...commonOptions,
          scales: {
            ...commonOptions.scales
          }
        }
      });
    }
    
    // Atualizar gráfico de orçamento
    function updateBudgetChart() {
      if (!budgetChart) return;
      
      // Obter orçamento e despesas atuais
      const budget = getCurrentBudget();
      const expensesByCategory = getCurrentExpensesByCategory();
      
      // Preparar dados para o gráfico
      const labels = [];
      const budgetData = [];
      const expenseData = [];
      
      // Adicionar apenas categorias com orçamento definido
      budget.categories.forEach(budgetCategory => {
        if (budgetCategory.amount > 0) {
          const category = categories.find(c => c.id === budgetCategory.id);
          if (category) {
            labels.push(category.name);
            budgetData.push(budgetCategory.amount);
            expenseData.push(expensesByCategory[budgetCategory.id] || 0);
          }
        }
      });
      
      // Atualizar dados do gráfico
      budgetChart.data.labels = labels;
      budgetChart.data.datasets[0].data = budgetData;
      budgetChart.data.datasets[1].data = expenseData;
      
      // Atualizar cores com base no tema
      budgetChart.data.datasets[0].backgroundColor = getComputedStyle(root).getPropertyValue('--primary').trim();
      budgetChart.data.datasets[0].borderColor = getComputedStyle(root).getPropertyValue('--primary').trim();
      budgetChart.data.datasets[1].backgroundColor = getComputedStyle(root).getPropertyValue('--warning').trim();
      budgetChart.data.datasets[1].borderColor = getComputedStyle(root).getPropertyValue('--warning').trim();
      
      // Atualizar opções comuns
      budgetChart.options = { ...getChartCommonOptions() };
      
      budgetChart.update();
    }
    
    let savingsProjectionChart;
    
    // Inicializar gráfico de projeção de economia
    function initSavingsProjectionChart() {
      const ctx = document.getElementById('savings-projection-chart').getContext('2d');
      const commonOptions = getChartCommonOptions();
      
      // Configurar dados de projeção
      const today = new Date();
      const labels = [];
      const projectedData = [];
      
      // Considerar economias como receitas - despesas dos últimos 3 meses
      const savings = [];
      
      for (let i = 2; i >= 0; i--) {
        const targetMonth = today.getMonth() - i;
        const targetYear = today.getFullYear() + Math.floor(targetMonth / 12);
        const normalizedMonth = ((targetMonth % 12) + 12) % 12;
        
        // Filtrar transações para este mês
        const monthTransactions = transactions.filter(t => {
          const date = new Date(t.date);
          return date.getMonth() === normalizedMonth && date.getFullYear() === targetYear;
        });
        
        // Calcular saldo do mês
        const income = monthTransactions
          .filter(t => t.type === 'income')
          .reduce((sum, t) => sum + Number(t.amount), 0);
        
        const expenses = monthTransactions
          .filter(t => t.type === 'expense')
          .reduce((sum, t) => sum + Number(t.amount), 0);
        
        const monthlySavings = income - expenses;
        savings.push(monthlySavings);
      }
      
      // Calcular média de economia mensal
      const avgMonthlySavings = savings.reduce((sum, value) => sum + value, 0) / savings.length;
      
      // Projetar para os próximos 12 meses
      let projectedSavings = 0;
      
      for (let i = 0; i < 12; i++) {
        const targetMonth = today.getMonth() + i;
        const targetYear = today.getFullYear() + Math.floor(targetMonth / 12);
        const normalizedMonth = targetMonth % 12;
        
        // Formatar rótulo do mês
        const monthDate = new Date(targetYear, normalizedMonth, 1);
        const monthLabel = monthDate.toLocaleDateString('pt-BR', { month: 'short', year: i % 3 === 0 ? 'numeric' : undefined });
        labels.push(monthLabel);
        
        // Acumular economia projetada
        projectedSavings += avgMonthlySavings;
        projectedData.push(projectedSavings);
      }
      
      // Criar gráfico
      savingsProjectionChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Economia Projetada',
              data: projectedData,
              borderColor: getComputedStyle(root).getPropertyValue('--success').trim(),
              backgroundColor: 'rgba(52, 199, 89, 0.1)',
              borderWidth: 2,
              tension: 0.3,
              fill: true
            }
          ]
        },
        options: {
          ...commonOptions,
          scales: {
            ...commonOptions.scales
          }
        }
      });
    }
    
    // Atualizar gráfico de projeção de economia
    function updateSavingsProjectionChart() {
      if (!savingsProjectionChart) return;
      
      // Configurar dados de projeção
      const today = new Date();
      const labels = [];
      const projectedData = [];
      
      // Considerar economias como receitas - despesas dos últimos 3 meses
      const savings = [];
      
      for (let i = 2; i >= 0; i--) {
        const targetMonth = today.getMonth() - i;
        const targetYear = today.getFullYear() + Math.floor(targetMonth / 12);
        const normalizedMonth = ((targetMonth % 12) + 12) % 12;
        
        // Filtrar transações para este mês
        const monthTransactions = transactions.filter(t => {
          const date = new Date(t.date);
          return date.getMonth() === normalizedMonth && date.getFullYear() === targetYear;
        });
        
        // Calcular saldo do mês
        const income = monthTransactions
          .filter(t => t.type === 'income')
          .reduce((sum, t) => sum + Number(t.amount), 0);
        
        const expenses = monthTransactions
          .filter(t => t.type === 'expense')
          .reduce((sum, t) => sum + Number(t.amount), 0);
        
        const monthlySavings = income - expenses;
        savings.push(monthlySavings);
      }
      
      // Calcular média de economia mensal
      const avgMonthlySavings = savings.reduce((sum, value) => sum + value, 0) / savings.length;
      
      // Projetar para os próximos 12 meses
      let projectedSavings = 0;
      
      for (let i = 0; i < 12; i++) {
        const targetMonth = today.getMonth() + i;
        const targetYear = today.getFullYear() + Math.floor(targetMonth / 12);
        const normalizedMonth = targetMonth % 12;
        
        // Formatar rótulo do mês
        const monthDate = new Date(targetYear, normalizedMonth, 1);
        const monthLabel = monthDate.toLocaleDateString('pt-BR', { month: 'short', year: i % 3 === 0 ? 'numeric' : undefined });
        labels.push(monthLabel);
        
        // Acumular economia projetada
        projectedSavings += avgMonthlySavings;
        projectedData.push(projectedSavings);
      }
      
      // Atualizar dados do gráfico
      savingsProjectionChart.data.labels = labels;
      savingsProjectionChart.data.datasets[0].data = projectedData;
      
      // Atualizar cores com base no tema
      savingsProjectionChart.data.datasets[0].borderColor = getComputedStyle(root).getPropertyValue('--success').trim();
      savingsProjectionChart.data.datasets[0].backgroundColor = 'rgba(52, 199, 89, 0.1)';
      
      // Atualizar opções comuns
      savingsProjectionChart.options = { ...getChartCommonOptions() };
      
      savingsProjectionChart.update();
    }
    
    let analysisChart;
    
    // Inicializar gráfico de análise
    function initAnalysisChart() {
      const ctx = document.getElementById('analysis-chart').getContext('2d');
      const commonOptions = getChartCommonOptions();
      
      // Configurar dados iniciais (por categoria)
      const expensesByCategory = getExpensesByCategory(transactions);
      
      // Preparar dados para o gráfico
      const labels = [];
      const data = [];
      const backgroundColors = [];
      
      // Ordenar categorias por valor (maior para menor)
      const sortedCategories = Object.entries(expensesByCategory)
        .filter(([categoryId, amount]) => amount > 0)
        .sort((a, b) => b[1] - a[1]);
      
      // Adicionar dados ordenados
      sortedCategories.forEach(([categoryId, amount]) => {
        const category = categories.find(c => c.id === categoryId);
        if (category) {
          labels.push(category.name);
          data.push(amount);
          backgroundColors.push(category.color);
        }
      });
      
      // Criar gráfico
      analysisChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Despesas por Categoria',
              data: data,
              backgroundColor: backgroundColors,
              borderColor: backgroundColors,
              borderWidth: 1,
              borderRadius: 6,
              maxBarThickness: 35
            }
          ]
        },
        options: {
          ...commonOptions,
          scales: {
            ...commonOptions.scales
          },
          indexAxis: 'y'
        }
      });
    }
    
    // Atualizar gráfico de análise
    function updateAnalysisChart() {
      if (!analysisChart) return;
      
      // Obter tipo de análise selecionado
      const analysisType = document.getElementById('analysis-type').value;
      
      // Configurar dados com base no tipo
      let chartType = 'bar';
      let indexAxis = 'y';
      let labels = [];
      let datasets = [];
      
      switch (analysisType) {
        case 'category':
          // Análise por categoria
          const expensesByCategory = getExpensesByCategory(transactions);
          
          // Preparar dados para o gráfico
          const categoryData = [];
          const backgroundColors = [];
          
          // Ordenar categorias por valor (maior para menor)
          const sortedCategories = Object.entries(expensesByCategory)
            .filter(([categoryId, amount]) => amount > 0)
            .sort((a, b) => b[1] - a[1]);
          
          // Adicionar dados ordenados
          sortedCategories.forEach(([categoryId, amount]) => {
            const category = categories.find(c => c.id === categoryId);
            if (category) {
              labels.push(category.name);
              categoryData.push(amount);
              backgroundColors.push(category.color);
            }
          });
          
          datasets = [
            {
              label: 'Despesas por Categoria',
              data: categoryData,
              backgroundColor: backgroundColors,
              borderColor: backgroundColors,
              borderWidth: 1,
              borderRadius: 6,
              maxBarThickness: 35
            }
          ];
          
          break;
          
        case 'monthly':
          // Análise mensal
          chartType = 'line';
          indexAxis = 'x';
          
          // Obter dados para os últimos 12 meses
          const today = new Date();
          const currentMonth = today.getMonth();
          const currentYear = today.getFullYear();
          
          const monthlyData = [];
          
          // Gerar dados para os últimos 12 meses
          for (let i = 11; i >= 0; i--) {
            const targetMonth = currentMonth - i;
            const targetYear = currentYear + Math.floor(targetMonth / 12);
            const normalizedMonth = ((targetMonth % 12) + 12) % 12; // Garante que o mês seja entre 0-11
            
            // Formatar rótulo do mês
            const monthDate = new Date(targetYear, normalizedMonth, 1);
            const monthLabel = monthDate.toLocaleDateString('pt-BR', { month: 'short', year: i % 3 === 0 ? 'numeric' : undefined });
            labels.push(monthLabel);
            
            // Filtrar transações para este mês
            const monthExpenses = transactions.filter(t => {
              const date = new Date(t.date);
              return date.getMonth() === normalizedMonth && 
                     date.getFullYear() === targetYear && 
                     t.type === 'expense';
            });
            
            // Calcular total de despesas
            const totalExpenses = monthExpenses.reduce((sum, t) => sum + Number(t.amount), 0);
            monthlyData.push(totalExpenses);
          }
          
          datasets = [
            {
              label: 'Despesas Mensais',
              data: monthlyData,
              borderColor: getComputedStyle(root).getPropertyValue('--primary').trim(),
              backgroundColor: 'rgba(10, 132, 255, 0.1)',
              borderWidth: 2,
              tension: 0.3,
              fill: true
            }
          ];
          
          break;
          
        case 'yearly':
          // Análise anual
          chartType = 'bar';
          indexAxis = 'x';
          
          // Obter ano atual
          const currentYearForYearly = new Date().getFullYear();
          
          // Considerar os últimos 3 anos
          for (let i = 2; i >= 0; i--) {
            const year = currentYearForYearly - i;
            labels.push(year.toString());
            
            // Filtrar transações para este ano
            const yearExpenses = transactions.filter(t => {
              const date = new Date(t.date);
              return date.getFullYear() === year && t.type === 'expense';
            });
            
            // Calcular total de despesas
            const totalExpenses = yearExpenses.reduce((sum, t) => sum + Number(t.amount), 0);
            
            datasets.push({
              label: 'Despesas Anuais',
              data: [totalExpenses],
              backgroundColor: getComputedStyle(root).getPropertyValue('--primary').trim(),
              borderColor: getComputedStyle(root).getPropertyValue('--primary').trim(),
              borderWidth: 1,
              borderRadius: 6,
              maxBarThickness: 50
            });
          }
          
          break;
      }
      
      // Atualizar tipo e configurações do gráfico
      analysisChart.config.type = chartType;
      analysisChart.options.indexAxis = indexAxis;
      
      // Atualizar dados do gráfico
      analysisChart.data.labels = labels;
      analysisChart.data.datasets = datasets;
      
      // Atualizar opções comuns
      analysisChart.options = { 
        ...getChartCommonOptions(),
        indexAxis: indexAxis
      };
      
      analysisChart.update();
    }
    
    // Inicializar todos os gráficos
    function initCharts() {
      initIncomeExpenseChart();
      initCategoryChart();
      initCashFlowChart();
      initFixedVariableChart();
      initTrendChart();
      initBudgetChart();
      initSavingsProjectionChart();
      initAnalysisChart();
    }
    
    // Atualizar todos os gráficos
    function updateCharts() {
      updateIncomeExpenseChart();
      updateCategoryChart();
      updateCashFlowChart();
      updateFixedVariableChart();
      updateTrendChart();
      updateBudgetChart();
      updateSavingsProjectionChart();
      updateAnalysisChart();
    }

// ===== Interface e Interação =====
    
    // Inicializar navegação por tabs
    function initTabs() {
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          // Remover classe active de todas as tabs
          tabs.forEach(t => t.classList.remove('active'));
          
          // Adicionar classe active à tab clicada
          tab.classList.add('active');
          
          // Obter id da tab
          const tabId = tab.dataset.tab;
          currentTab = tabId;
          
          // Esconder todos os conteúdos de tab
          tabContents.forEach(content => {
            content.style.display = 'none';
          });
          
          // Mostrar conteúdo da tab selecionada
          document.getElementById(`tab-${tabId}`).style.display = 'block';
          
          // Atualizar conteúdo específico da tab
          switch (tabId) {
            case 'transactions':
              updateTransactionsTable();
              break;
            case 'budget':
              updateBudgetTab();
              break;
            case 'goals':
              updateGoalsTab();
              break;
            case 'reports':
              updateReportsTab();
              break;
          }
        });
      });
    }
    
    // Atualizar KPIs do dashboard
    function updateKPIs() {
      // Obter período selecionado
      const periodSelect = document.getElementById('filter-month');
      const period = periodSelect.value;
      
      // Obter resumo financeiro
      const summary = getFinanceSummary(transactions, period);
      
      // Atualizar valores dos KPIs
      document.getElementById('kpi-balance').textContent = formatCurrency(summary.balance);
      document.getElementById('kpi-income').textContent = formatCurrency(summary.income);
      document.getElementById('kpi-expenses').textContent = formatCurrency(summary.expenses);
      
      // Calcular economia do mês (receitas - despesas)
      const savings = summary.balance;
      document.getElementById('kpi-savings').textContent = formatCurrency(savings);
      
      // Atualizar barra de progresso de economia
      const savingsGoalEl = document.getElementById('savings-goal');
      const savingsGoal = parseFloat(savingsGoalEl.textContent.replace(/\./g, '').replace(',', '.'));
      
      const savingsProgress = document.getElementById('savings-progress');
      const savingsPercentage = Math.min(100, Math.max(0, (savings / savingsGoal) * 100));
      savingsProgress.style.width = `${savingsPercentage}%`;
      
      // Ajustar cor da barra de progresso com base no percentual
      if (savingsPercentage >= 75) {
        savingsProgress.className = 'progress-bar success';
      } else if (savingsPercentage >= 40) {
        savingsProgress.className = 'progress-bar warning';
      } else {
        savingsProgress.className = 'progress-bar danger';
      }
      
      // Atualizar projeção de gastos (despesas atuais + pendentes)
      const projection = summary.expenses + summary.pendingExpenses;
      document.getElementById('kpi-projection').textContent = formatCurrency(projection);
      
      // Verificar se a projeção está dentro do orçamento
      const currentBudget = getCurrentBudget();
      const totalBudget = currentBudget.categories.reduce((sum, cat) => sum + Number(cat.amount), 0);
      
      const projectionStatus = document.getElementById('projection-status');
      
      if (projection <= totalBudget * 0.8) {
        projectionStatus.className = 'kpi-trend up';
        projectionStatus.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
          <span>No orçamento</span>
        `;
      } else if (projection <= totalBudget) {
        projectionStatus.className = 'kpi-trend';
        projectionStatus.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          <span>Próximo do limite</span>
        `;
      } else {
        projectionStatus.className = 'kpi-trend down';
        projectionStatus.innerHTML = `
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          <span>Acima do orçamento</span>
        `;
      }
      
      // Atualizar tendências
      // Obter dados do mês anterior para comparação
      const lastMonthSummary = getFinanceSummary(transactions, 'last');
      
      // Calcular variação percentual
      const balanceVariation = lastMonthSummary.balance !== 0 
        ? ((summary.balance - lastMonthSummary.balance) / Math.abs(lastMonthSummary.balance)) * 100 
        : 100;
      
      const incomeVariation = lastMonthSummary.income !== 0 
        ? ((summary.income - lastMonthSummary.income) / lastMonthSummary.income) * 100 
        : 100;
      
      const expensesVariation = lastMonthSummary.expenses !== 0 
        ? ((summary.expenses - lastMonthSummary.expenses) / lastMonthSummary.expenses) * 100 
        : 100;
      
      // Atualizar elementos HTML
      const balanceTrend = document.getElementById('balance-trend');
      const incomeTrend = document.getElementById('income-trend');
      const expensesTrend = document.getElementById('expenses-trend');
      
      // Formatar e definir classes com base na variação
      balanceTrend.textContent = formatNumber(balanceVariation) + '%';
      balanceTrend.parentElement.className = balanceVariation >= 0 ? 'kpi-trend up' : 'kpi-trend down';
      
      incomeTrend.textContent = formatNumber(incomeVariation) + '%';
      incomeTrend.parentElement.className = incomeVariation >= 0 ? 'kpi-trend up' : 'kpi-trend down';
      
      expensesTrend.textContent = formatNumber(expensesVariation) + '%';
      expensesTrend.parentElement.className = expensesVariation <= 0 ? 'kpi-trend up' : 'kpi-trend down';
    }
    
    // Formatar número com casas decimais específicas
    function formatNumber(num, digits = 1) {
      return Number(num).toFixed(digits);
    }
    
    // Atualizar transações recentes
    function updateRecentTransactions() {
      const recentTransactionsContainer = document.getElementById('recent-transactions');
      
      // Limpar conteúdo
      recentTransactionsContainer.innerHTML = '';
      
      // Obter transações recentes (últimas 5)
      const recentTransactions = [...transactions]
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 5);
      
      // Verificar se há transações
      if (recentTransactions.length === 0) {
        recentTransactionsContainer.innerHTML = `
          <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
            Nenhuma transação encontrada. Adicione sua primeira transação!
          </div>
        `;
        return;
      }
      
      // Adicionar cada transação ao container
      recentTransactions.forEach(transaction => {
        // Encontrar categoria
        const category = categories.find(c => c.id === transaction.category) || { name: 'Categoria', color: '#999' };
        
        // Criar elemento de transação
        const transactionElement = document.createElement('div');
        transactionElement.className = 'flow-item';
        transactionElement.innerHTML = `
          <div class="flow-item-left">
            <div class="flow-item-icon ${transaction.type}" style="background-color: ${category.color};">
              ${category.icon || (transaction.type === 'income' ? '↑' : '↓')}
            </div>
            <div class="flow-item-info">
              <div class="flow-item-title">${transaction.description}</div>
              <div class="flow-item-meta">${formatDate(transaction.date)} · ${category.name}</div>
            </div>
          </div>
          <div class="flow-item-amount ${transaction.type}">
            ${transaction.type === 'income' ? '+' : '-'} ${formatCurrency(transaction.amount)}
          </div>
        `;
        
        // Adicionar evento de clique para ver detalhes
        transactionElement.addEventListener('click', () => {
          showTransactionDetails(transaction.id);
        });
        
        recentTransactionsContainer.appendChild(transactionElement);
      });
    }
    
    // Variáveis para paginação
    let currentPage = 1;
    const itemsPerPage = 10;
    let filteredTransactionsList = [];
    
    // Atualizar tabela de transações
    function updateTransactionsTable() {
      // Obter elementos
      const tableBody = document.getElementById('transactions-table-body');
      const showingText = document.getElementById('transactions-showing');
      const prevButton = document.getElementById('transactions-prev');
      const nextButton = document.getElementById('transactions-next');
      
      // Obter filtros
      const dateFilter = document.getElementById('transactions-filter-date').value;
      const typeFilter = document.getElementById('transactions-filter-type').value;
      const categoryFilter = document.getElementById('transactions-filter-category').value;
      const statusFilter = document.getElementById('transactions-filter-status').value;
      const searchText = document.getElementById('transactions-search').value;
      
      // Aplicar filtros
      filteredTransactionsList = filterTransactions({
        date: dateFilter,
        type: typeFilter,
        category: categoryFilter,
        status: statusFilter,
        search: searchText
      });
      
      // Calcular número total de páginas
      const totalPages = Math.ceil(filteredTransactionsList.length / itemsPerPage);
      
      // Ajustar página atual se necessário
      if (currentPage > totalPages) {
        currentPage = totalPages > 0 ? totalPages : 1;
      }
      
      // Calcular índices para a página atual
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = Math.min(startIndex + itemsPerPage, filteredTransactionsList.length);
      
      // Obter transações para a página atual
      const pageTransactions = filteredTransactionsList.slice(startIndex, endIndex);
      
      // Atualizar texto de informação
      showingText.textContent = `Mostrando ${startIndex + 1}-${endIndex} de ${filteredTransactionsList.length} transações`;
      
      // Habilitar/desabilitar botões de navegação
      prevButton.disabled = currentPage <= 1;
      nextButton.disabled = currentPage >= totalPages;
      
      // Limpar tabela
      tableBody.innerHTML = '';
      
      // Verificar se há transações
      if (pageTransactions.length === 0) {
        const emptyRow = document.createElement('tr');
        emptyRow.innerHTML = `
          <td colspan="6" style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
            Nenhuma transação encontrada com os filtros atuais.
          </td>
        `;
        tableBody.appendChild(emptyRow);
        return;
      }
      
      // Adicionar transações à tabela
      pageTransactions.forEach(transaction => {
        const row = document.createElement('tr');
        
        // Encontrar categoria
        const category = categories.find(c => c.id === transaction.category) || { name: 'Categoria Desconhecida' };
        
        // Status da transação
        const status = TRANSACTION_STATUS[transaction.status] || { name: 'Desconhecido', class: '' };
        
        // Formatação de valor com cor
        const amountColor = transaction.type === 'income' ? 'var(--success)' : 'var(--danger)';
        const amountPrefix = transaction.type === 'income' ? '+' : '-';
        
        row.innerHTML = `
          <td>${formatDate(transaction.date)}</td>
          <td>${transaction.description}</td>
          <td>${category.name}</td>
          <td style="color: ${amountColor}; font-weight: 600;">${amountPrefix} ${formatCurrency(transaction.amount)}</td>
          <td><span class="status ${status.class}">${status.name}</span></td>
          <td>
            <div class="table-actions">
              <button class="table-action-btn btn-view" title="Ver Detalhes">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="16" x2="12" y2="12"></line>
                  <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
              </button>
              <button class="table-action-btn btn-edit" title="Editar">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
              </button>
              <button class="table-action-btn btn-delete" title="Excluir">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
              </button>
            </div>
          </td>
        `;
        
        // Adicionar eventos aos botões
        row.querySelector('.btn-view').addEventListener('click', () => {
          showTransactionDetails(transaction.id);
        });
        
        row.querySelector('.btn-edit').addEventListener('click', () => {
          openTransactionModal(transaction);
        });
        
        row.querySelector('.btn-delete').addEventListener('click', () => {
          confirmDeleteTransaction(transaction.id);
        });
        
        tableBody.appendChild(row);
      });
      
      // Configurar eventos de paginação
      prevButton.onclick = () => {
        if (currentPage > 1) {
          currentPage--;
          updateTransactionsTable();
        }
      };
      
      nextButton.onclick = () => {
        if (currentPage < totalPages) {
          currentPage++;
          updateTransactionsTable();
        }
      };
    }
    
    // Atualizar aba de orçamento
    function updateBudgetTab() {
      // Atualizar gráfico de orçamento
      updateBudgetChart();
      
      // Atualizar tabela de progresso do orçamento
      updateBudgetProgress();
    }
    
    // Atualizar progresso do orçamento
    function updateBudgetProgress() {
      const progressContainer = document.getElementById('budget-progress-container');
      const budgetTableBody = document.getElementById('budget-table-body');
      
      // Limpar containers
      progressContainer.innerHTML = '';
      budgetTableBody.innerHTML = '';
      
      // Obter orçamento atual
      const budget = getCurrentBudget();
      const expensesByCategory = getCurrentExpensesByCategory();
      
      // Verificar se há categorias com orçamento
      const hasBudget = budget.categories.some(bc => bc.amount > 0);
      
      if (!hasBudget) {
        progressContainer.innerHTML = `
          <div style="text-align: center; padding: 1rem; color: var(--text-secondary);">
            Nenhum orçamento definido. Clique em "Editar Orçamento" para configurar.
          </div>
        `;
        
        budgetTableBody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
              Nenhum orçamento definido.
            </td>
          </tr>
        `;
        return;
      }
      
      // Adicionar barra de progresso para cada categoria com orçamento
      budget.categories.forEach(budgetCategory => {
        if (budgetCategory.amount > 0) {
          const category = categories.find(c => c.id === budgetCategory.id);
          if (!category) return;
          
          const spent = expensesByCategory[budgetCategory.id] || 0;
          const budgetAmount = budgetCategory.amount;
          const remaining = budgetAmount - spent;
          const percentage = Math.min(100, Math.max(0, (spent / budgetAmount) * 100));
          
          // Determinar cor com base no percentual gasto
          let statusClass = 'success';
          if (percentage >= 90) {
            statusClass = 'danger';
          } else if (percentage >= 75) {
            statusClass = 'warning';
          }
          
          // Criar elemento de progresso
          const progressElement = document.createElement('div');
          progressElement.style.marginBottom = '1.25rem';
          progressElement.innerHTML = `
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div style="width: 1rem; height: 1rem; border-radius: 50%; background-color: ${category.color};"></div>
                <span>${category.name}</span>
              </div>
              <div>
                <span style="font-weight: 600;">${formatCurrency(spent)}</span> de 
                <span>${formatCurrency(budgetAmount)}</span>
                <span style="margin-left: 0.5rem; color: ${remaining >= 0 ? 'var(--success)' : 'var(--danger)'};">
                  (${remaining >= 0 ? `Restam ${formatCurrency(remaining)}` : `Excedido em ${formatCurrency(Math.abs(remaining))}`})
                </span>
              </div>
            </div>
            <div class="progress-container">
              <div class="progress-bar ${statusClass}" style="width: ${percentage}%"></div>
            </div>
          `;
          
          progressContainer.appendChild(progressElement);
          
          // Adicionar linha na tabela
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>
              <div style="display: flex; align-items: center; gap: 0.75rem;">
                <div style="width: 1rem; height: 1rem; border-radius: 50%; background-color: ${category.color};"></div>
                ${category.name}
              </div>
            </td>
            <td>${formatCurrency(budgetAmount)}</td>
            <td>${formatCurrency(spent)}</td>
            <td style="color: ${remaining >= 0 ? 'var(--success)' : 'var(--danger)'};">
              ${remaining >= 0 ? formatCurrency(remaining) : `- ${formatCurrency(Math.abs(remaining))}`}
            </td>
            <td>
              <div class="progress-container" style="margin: 0;">
                <div class="progress-bar ${statusClass}" style="width: ${percentage}%"></div>
              </div>
            </td>
          `;
          
          budgetTableBody.appendChild(row);
        }
      });
    }
    
    // Atualizar aba de metas
    function updateGoalsTab() {
      const goalsContainer = document.getElementById('goals-container');
      goalsContainer.innerHTML = '';
      
      // Verificar se há metas
      if (goals.length === 0) {
        goalsContainer.innerHTML = `
          <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
            Nenhuma meta encontrada. Adicione sua primeira meta!
          </div>
        `;
        return;
      }
      
      // Ordenar metas por data alvo (mais próximas primeiro)
      const sortedGoals = [...goals].sort((a, b) => new Date(a.targetDate) - new Date(b.targetDate));
      
      // Adicionar cada meta ao container
      sortedGoals.forEach(goal => {
        // Calcular progresso
        const progress = calculateGoalProgress(goal);
        
        // Determinar cor com base no progresso
        let statusClass = 'success';
        if (progress.progress < 30) {
          statusClass = 'danger';
        } else if (progress.progress < 60) {
          statusClass = 'warning';
        }
        
        // Criar elemento de meta
        const goalElement = document.createElement('div');
        goalElement.className = 'card';
        goalElement.style.marginBottom = '1rem';
        
        goalElement.innerHTML = `
          <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
            <div>
              <h3 style="margin: 0; font-size: 1.25rem;">${goal.name}</h3>
              <div style="color: var(--text-secondary); font-size: 0.875rem;">
                Data alvo: ${formatDate(goal.targetDate)} (${progress.daysRemaining} dias restantes)
              </div>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 1.25rem; font-weight: 600;">
                ${formatCurrency(goal.currentAmount)} / ${formatCurrency(goal.targetAmount)}
              </div>
              <div style="color: var(--text-secondary); font-size: 0.875rem;">
                Faltam: ${formatCurrency(progress.remainingAmount)}
              </div>
            </div>
          </div>
          
          <div class="progress-container">
            <div class="progress-bar ${statusClass}" style="width: ${progress.progress}%"></div>
          </div>
          
          <div style="display: flex; justify-content: space-between; margin-top: 0.75rem; color: var(--text-secondary); font-size: 0.875rem;">
            <div>${progress.progress.toFixed(1)}% concluído</div>
            <div>Economia necessária: ${formatCurrency(progress.monthlySavingsNeeded)}/mês</div>
          </div>
          
          <div style="display: flex; gap: 0.5rem; margin-top: 1rem; justify-content: flex-end;">
            <button class="btn btn-edit-goal" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
              </svg>
              Editar
            </button>
            <button class="btn btn-update-goal" style="padding: 0.375rem 0.75rem; font-size: 0.875rem;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 9l-7 7-7-7"></path>
              </svg>
              Atualizar Saldo
            </button>
          </div>
        `;
        
        // Adicionar eventos aos botões
        goalElement.querySelector('.btn-edit-goal').addEventListener('click', () => {
          openGoalModal(goal);
        });
        
        goalElement.querySelector('.btn-update-goal').addEventListener('click', () => {
          openUpdateGoalBalanceModal(goal);
        });
        
        goalsContainer.appendChild(goalElement);
      });
      
      // Atualizar gráfico de projeção de economia
      updateSavingsProjectionChart();
    }
    
    // Abrir modal para atualizar saldo da meta
    function openUpdateGoalBalanceModal(goal) {
      // Configurar modal de confirmação para atualização de saldo
      document.getElementById('confirm-modal-title').textContent = 'Atualizar Saldo da Meta';
      document.getElementById('confirm-modal-message').innerHTML = `
        <div>
          <p>Meta: <strong>${goal.name}</strong></p>
          <p>Saldo atual: ${formatCurrency(goal.currentAmount)}</p>
          <div class="form-group">
            <label for="new-goal-amount">Novo saldo:</label>
            <input type="number" id="new-goal-amount" class="form-control" value="${goal.currentAmount}" min="0" step="0.01">
          </div>
        </div>
      `;
      
      // Configurar botão de confirmação
      document.getElementById('confirm-modal-confirm').textContent = 'Atualizar';
      document.getElementById('confirm-modal-confirm').onclick = () => {
        const newAmount = parseFloat(document.getElementById('new-goal-amount').value);
        if (!isNaN(newAmount) && newAmount >= 0) {
          updateGoalBalance(goal.id, newAmount);
          closeModal(confirmModal);
        } else {
          showAlert('Por favor, insira um valor válido.', 'warning');
        }
      };
      
      // Abrir modal de confirmação
      openModal(confirmModal);
    }
    
    // Atualizar saldo da meta
    function updateGoalBalance(goalId, newAmount) {
      // Encontrar meta
      const goalIndex = goals.findIndex(g => g.id === goalId);
      
      if (goalIndex >= 0) {
        // Atualizar saldo
        goals[goalIndex].currentAmount = newAmount;
        
        // Salvar dados
        saveData();
        
        // Atualizar aba de metas
        updateGoalsTab();
        
        showAlert('Saldo da meta atualizado com sucesso!', 'success');
      } else {
        showAlert('Meta não encontrada.', 'danger');
      }
    }
    
    // Atualizar aba de relatórios
    function updateReportsTab() {
      // Preencher selects de mês e ano
      const reportMonth = document.getElementById('report-month');
      const reportYear = document.getElementById('report-year');
      
      // Limpar opções existentes
      reportMonth.innerHTML = '';
      reportYear.innerHTML = '';
      
      // Adicionar meses
      const months = [
        'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
      ];
      
      const currentMonth = new Date().getMonth();
      
      months.forEach((month, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = month;
        reportMonth.appendChild(option);
      });
      
      // Selecionar mês atual
      reportMonth.value = currentMonth;
      
      // Adicionar anos (ano atual e 2 anos anteriores)
      const currentYear = new Date().getFullYear();
      
      for (let i = 0; i < 3; i++) {
        const year = currentYear - i;
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        reportYear.appendChild(option);
      }
      
      // Selecionar ano atual
      reportYear.value = currentYear;
      
      // Gerar relatório para o mês/ano selecionado
      generateMonthlyReport();
      
      // Atualizar gráfico de análise
      updateAnalysisChart();
      
      // Adicionar eventos para atualização do relatório
      reportMonth.addEventListener('change', generateMonthlyReport);
      reportYear.addEventListener('change', generateMonthlyReport);
      
      // Botão de exportar relatório
      document.getElementById('btn-export-report').addEventListener('click', exportMonthlyReport);
    }

// Gerar relatório mensal
    function generateMonthlyReport() {
      const monthIndex = parseInt(document.getElementById('report-month').value);
      const year = parseInt(document.getElementById('report-year').value);
      const reportContainer = document.getElementById('monthly-report-container');
      
      // Filtrar transações para o mês/ano selecionado
      const monthTransactions = transactions.filter(t => {
        const date = new Date(t.date);
        return date.getMonth() === monthIndex && date.getFullYear() === year;
      });
      
      // Verificar se há transações
      if (monthTransactions.length === 0) {
        reportContainer.innerHTML = `
          <div style="text-align: center; padding: 2rem 0; color: var(--text-secondary);">
            Nenhuma transação encontrada para o período selecionado.
          </div>
        `;
        return;
      }
      
      // Calcular resumo financeiro
      const income = monthTransactions
        .filter(t => t.type === 'income')
        .reduce((sum, t) => sum + Number(t.amount), 0);
      
      const expenses = monthTransactions
        .filter(t => t.type === 'expense')
        .reduce((sum, t) => sum + Number(t.amount), 0);
      
      const balance = income - expenses;
      
      // Agrupar despesas por categoria
      const expensesByCategory = {};
      
      // Inicializar categorias
      categories
        .filter(c => EXPENSE_CATEGORIES.some(ec => ec.id === c.id))
        .forEach(c => {
          expensesByCategory[c.id] = 0;
        });
      
      // Somar despesas por categoria
      monthTransactions
        .filter(t => t.type === 'expense')
        .forEach(t => {
          if (expensesByCategory[t.category] !== undefined) {
            expensesByCategory[t.category] += Number(t.amount);
          }
        });
      
      // Ordenar categorias por valor (maior para menor)
      const sortedCategories = Object.entries(expensesByCategory)
        .filter(([categoryId, amount]) => amount > 0)
        .sort((a, b) => b[1] - a[1]);
      
      // Construir relatório
      reportContainer.innerHTML = `
        <div class="card" style="margin-bottom: 1.5rem; padding: 1.5rem;">
          <h3 style="margin-top: 0; margin-bottom: 1.5rem; font-size: 1.25rem;">Resumo Financeiro - ${months[monthIndex]} ${year}</h3>
          
          <div style="display: flex; justify-content: space-between; margin-bottom: 1.5rem;">
            <div style="flex: 1;">
              <div style="color: var(--text-secondary); margin-bottom: 0.5rem;">Receitas</div>
              <div style="font-size: 1.25rem; font-weight: 600; color: var(--success);">
                ${formatCurrency(income)}
              </div>
            </div>
            <div style="flex: 1;">
              <div style="color: var(--text-secondary); margin-bottom: 0.5rem;">Despesas</div>
              <div style="font-size: 1.25rem; font-weight: 600; color: var(--danger);">
                ${formatCurrency(expenses)}
              </div>
            </div>
            <div style="flex: 1;">
              <div style="color: var(--text-secondary); margin-bottom: 0.5rem;">Saldo</div>
              <div style="font-size: 1.25rem; font-weight: 600; color: ${balance >= 0 ? 'var(--success)' : 'var(--danger)'};">
                ${formatCurrency(balance)}
              </div>
            </div>
          </div>
          
          <h4 style="margin-top: 1.5rem; margin-bottom: 1rem; font-size: 1rem;">Despesas por Categoria</h4>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            ${sortedCategories.map(([categoryId, amount]) => {
              const category = categories.find(c => c.id === categoryId);
              if (!category) return '';
              
              const percentage = (amount / expenses) * 100;
              
              return `
                <div style="background-color: var(--input-bg); padding: 1rem; border-radius: var(--radius-sm);">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                      <span style="width: 0.75rem; height: 0.75rem; border-radius: 50%; background-color: ${category.color};"></span>
                      <span>${category.name}</span>
                    </div>
                    <div style="font-weight: 600;">${formatCurrency(amount)}</div>
                  </div>
                  <div style="color: var(--text-secondary); font-size: 0.875rem; text-align: right;">
                    ${percentage.toFixed(1)}% do total
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
        
        <div class="card">
          <div class="chart-title">Distribuição de Despesas</div>
          <div style="height: 250px;">
            <canvas id="report-pie-chart"></canvas>
          </div>
        </div>
      `;
      
      // Inicializar gráfico de pizza para o relatório
      const ctx = document.getElementById('report-pie-chart').getContext('2d');
      const commonOptions = getChartCommonOptions();
      
      // Preparar dados para o gráfico
      const labels = [];
      const data = [];
      const backgroundColors = [];
      
      // Adicionar dados ordenados
      sortedCategories.forEach(([categoryId, amount]) => {
        const category = categories.find(c => c.id === categoryId);
        if (category) {
          labels.push(category.name);
          data.push(amount);
          backgroundColors.push(category.color);
        }
      });
      
      // Criar gráfico
      const reportPieChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [
            {
              data: data,
              backgroundColor: backgroundColors,
              borderColor: getComputedStyle(root).getPropertyValue('--card-bg').trim(),
              borderWidth: 2,
              borderRadius: 4,
              hoverOffset: 6
            }
          ]
        },
        options: {
          ...commonOptions,
          plugins: {
            ...commonOptions.plugins,
            tooltip: {
              ...commonOptions.plugins.tooltip,
              callbacks: {
                label: function(context) {
                  const value = context.parsed;
                  const total = context.dataset.data.reduce((acc, curr) => acc + curr, 0);
                  const percentage = Math.round((value / total) * 100);
                  return `${context.label}: ${formatCurrency(value)} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    }
    
    // Exportar relatório mensal (simulação)
    function exportMonthlyReport() {
      const monthIndex = parseInt(document.getElementById('report-month').value);
      const year = parseInt(document.getElementById('report-year').value);
      
      const months = [
        'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
        'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
      ];
      
      showAlert(`Relatório de ${months[monthIndex]} ${year} exportado com sucesso!`, 'success');
    }
    
    // Atualizar dashboard
    function updateDashboard() {
      updateKPIs();
      updateCharts();
      updateRecentTransactions();
      
      // Verificar tab atual e atualizar conteúdo específico
      switch (currentTab) {
        case 'transactions':
          updateTransactionsTable();
          break;
        case 'budget':
          updateBudgetTab();
          break;
        case 'goals':
          updateGoalsTab();
          break;
        case 'reports':
          updateReportsTab();
          break;
      }
    }
    
    // ===== Inicialização da Aplicação =====
    
    // Inicializar aplicação
    function init() {
      showLoading();
      
      try {
        // Configurar tema
        setupTheme();
        
        // Carregar dados
        loadData();
        
        // Inicializar componentes
        initFilters();
        initModals();
        initTabs();
        initCharts();
        
        // Atualizar dashboard
        updateDashboard();
        
        console.log('Aplicação inicializada com sucesso!');
      } catch (error) {
        console.error('Erro ao inicializar a aplicação:', error);
        showAlert('Erro ao inicializar a aplicação. Verifique o console para mais detalhes.', 'danger');
      } finally {
        hideLoading();
      }
    }
    
    // Iniciar aplicação quando o DOM estiver carregado
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
